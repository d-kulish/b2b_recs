{% load static %}
<!--
    Deploy Wizard Modal Component

    A configurable modal for deploying models to Cloud Run with preset configurations.

    Usage:
        { % include 'includes/_deploy_wizard.html' % }

    Required CSS:
        <link rel="stylesheet" href="{ % static 'css/deploy_wizard.css' % }?v=1">
        <link rel="stylesheet" href="{ % static 'css/modals.css' % }?v=1">

    Required JavaScript:
        <script src="{ % static 'js/deploy_wizard.js' % }?v=1"></script>

    JavaScript API:
        - DeployWizard.configure({ onSuccess: ... }) - Configure callbacks
        - DeployWizard.open(runId) - Open wizard for a training run
        - DeployWizard.close() - Close the wizard
        - DeployWizard.selectPreset(presetName) - Select a deployment preset
        - DeployWizard.toggleAdvanced() - Toggle advanced options visibility
        - DeployWizard.deploy() - Submit deployment
-->

<!-- Deploy Wizard Modal -->
<div id="deployWizardModal" class="modal-overlay hidden" onclick="DeployWizard.handleOverlayClick(event)">
    <div class="modal-container deploy-wizard-modal" onclick="event.stopPropagation()">
        <!-- Header -->
        <div class="modal-header deploy-wizard-header">
            <div class="deploy-wizard-header-icon">
                <i class="fas fa-rocket"></i>
            </div>
            <div class="deploy-wizard-header-text">
                <h3 class="deploy-wizard-title">Deploy to Cloud Run</h3>
            </div>
            <button class="deploy-wizard-close" onclick="DeployWizard.close()" title="Close">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Body -->
        <div class="modal-body deploy-wizard-body">
            <!-- Model Info Card -->
            <div class="deploy-model-info-card" id="deployModelInfoCard">
                <div class="deploy-model-info-item">
                    <div class="deploy-model-info-label">Model</div>
                    <div class="deploy-model-info-value" id="deployModelName">-</div>
                </div>
                <div class="deploy-model-info-item">
                    <div class="deploy-model-info-label">Version</div>
                    <div class="deploy-model-info-value" id="deployModelVersion">-</div>
                </div>
            </div>

            <!-- Endpoint Selection Toggle -->
            <div class="deploy-endpoint-toggle expanded" id="deployEndpointToggle" onclick="DeployWizard.toggleEndpoint()">
                <span class="deploy-endpoint-toggle-text"><i class="fas fa-server mr-2 text-blue-500"></i>Endpoint Selection</span>
                <i class="fas fa-chevron-right deploy-endpoint-toggle-chevron"></i>
            </div>

            <!-- Endpoint Selection Panel -->
            <div class="deploy-endpoint-options visible" id="deployEndpointOptions">
                <!-- Create New Endpoint Option -->
                <div class="deploy-endpoint-option selected" data-mode="new" onclick="DeployWizard.selectEndpointMode('new')">
                    <div class="deploy-endpoint-option-header">
                        <div class="deploy-endpoint-option-radio"></div>
                        <div class="deploy-endpoint-option-title">Create New Endpoint</div>
                    </div>
                    <div class="deploy-endpoint-option-content">
                        <div class="deploy-endpoint-preview" id="deployEndpointPreview">
                            <i class="fas fa-tag"></i>
                            <span id="deployAutoServiceName">-</span>
                        </div>
                        <div class="deploy-custom-name-toggle" onclick="event.stopPropagation(); DeployWizard.toggleCustomName()">
                            <input type="checkbox" id="deployCustomNameCheck" onclick="event.stopPropagation()">
                            <label for="deployCustomNameCheck" onclick="event.stopPropagation()">Use custom name</label>
                        </div>
                        <div class="deploy-custom-name-container hidden" id="deployCustomNameContainer">
                            <input type="text" id="deployCustomNameInput" class="deploy-custom-name-input"
                                   placeholder="my-custom-service"
                                   oninput="DeployWizard.updateCustomName(this.value)"
                                   onclick="event.stopPropagation()">
                            <div class="deploy-custom-name-hint">Lowercase letters, numbers, and hyphens only</div>
                        </div>
                    </div>
                </div>

                <!-- Update Existing Endpoint Option -->
                <div class="deploy-endpoint-option" data-mode="existing" onclick="DeployWizard.selectEndpointMode('existing')">
                    <div class="deploy-endpoint-option-header">
                        <div class="deploy-endpoint-option-radio"></div>
                        <div class="deploy-endpoint-option-title">Update Existing Endpoint</div>
                    </div>
                    <div class="deploy-endpoint-option-content">
                        <!-- No endpoints message -->
                        <div class="deploy-no-endpoints-msg hidden" id="deployNoEndpointsMsg">
                            <i class="fas fa-info-circle"></i>
                            <span>No existing endpoints for this model. Deploy first to create one.</span>
                        </div>
                        <div class="deploy-services-container" id="deployServicesContainer">
                            <select id="deployServicesSelect" class="deploy-services-select"
                                    onchange="DeployWizard.selectExistingService(this.value)"
                                    onclick="event.stopPropagation()">
                                <option value="">Select an endpoint...</option>
                            </select>
                            <div class="deploy-services-loading hidden" id="deployServicesLoading">
                                <i class="fas fa-spinner fa-spin"></i> Loading endpoints...
                            </div>
                        </div>
                        <div class="deploy-service-warning hidden" id="deployServiceWarning">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>This will update the existing service with the new model version.</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Deployment Preset Toggle - matches subchapter-header-tablet pattern -->
            <div class="deploy-preset-toggle expanded" id="deployPresetToggle" onclick="DeployWizard.togglePresets()">
                <span class="deploy-preset-toggle-text"><i class="fas fa-layer-group mr-2 text-indigo-500"></i>Deployment Preset</span>
                <i class="fas fa-chevron-right deploy-preset-toggle-chevron"></i>
            </div>

            <!-- Deployment Preset Panel (expanded by default) -->
            <div class="deploy-preset-options visible" id="deployPresetOptions">
                <div class="deploy-preset-cards">
                    <!-- Development Preset -->
                    <div class="deploy-preset-card" data-preset="development" onclick="DeployWizard.selectPreset('development')">
                        <div class="deploy-preset-name">Development</div>
                        <div class="deploy-preset-specs">
                            <strong>0-2</strong> instances
                        </div>
                        <div class="deploy-preset-specs">
                            <strong>2Gi</strong> / <strong>1</strong> CPU
                        </div>
                        <div class="deploy-preset-use-case">Testing, low traffic</div>
                    </div>

                    <!-- Production Preset -->
                    <div class="deploy-preset-card selected" data-preset="production" onclick="DeployWizard.selectPreset('production')">
                        <div class="deploy-preset-recommended">Recommended</div>
                        <div class="deploy-preset-name">Production</div>
                        <div class="deploy-preset-specs">
                            <strong>1-10</strong> instances
                        </div>
                        <div class="deploy-preset-specs">
                            <strong>4Gi</strong> / <strong>2</strong> CPU
                        </div>
                        <div class="deploy-preset-use-case">Standard workload</div>
                    </div>

                    <!-- High Traffic Preset -->
                    <div class="deploy-preset-card" data-preset="high_traffic" onclick="DeployWizard.selectPreset('high_traffic')">
                        <div class="deploy-preset-name">High Traffic</div>
                        <div class="deploy-preset-specs">
                            <strong>2-50</strong> instances
                        </div>
                        <div class="deploy-preset-specs">
                            <strong>8Gi</strong> / <strong>4</strong> CPU
                        </div>
                        <div class="deploy-preset-use-case">High concurrency</div>
                    </div>
                </div>
            </div>

            <!-- Advanced Options Toggle - matches subchapter-header-tablet pattern -->
            <div class="deploy-advanced-toggle" id="deployAdvancedToggle" onclick="DeployWizard.toggleAdvanced()">
                <span class="deploy-advanced-toggle-text"><i class="fas fa-cog mr-2 text-green-500"></i>Advanced Options</span>
                <i class="fas fa-chevron-right deploy-advanced-toggle-chevron"></i>
            </div>

            <!-- Advanced Options Panel (collapsed by default) -->
            <div class="deploy-advanced-options" id="deployAdvancedOptions">
                <div class="deploy-options-grid">
                    <div class="deploy-option-field">
                        <label class="deploy-option-label" for="deployMinInstances">Min Instances</label>
                        <input type="number" id="deployMinInstances" class="deploy-option-input"
                               min="0" max="100" value="1"
                               onchange="DeployWizard.updateConfig('min_instances', this.value)">
                    </div>
                    <div class="deploy-option-field">
                        <label class="deploy-option-label" for="deployMaxInstances">Max Instances</label>
                        <input type="number" id="deployMaxInstances" class="deploy-option-input"
                               min="1" max="100" value="10"
                               onchange="DeployWizard.updateConfig('max_instances', this.value)">
                    </div>
                    <div class="deploy-option-field">
                        <label class="deploy-option-label" for="deployMemory">Memory</label>
                        <select id="deployMemory" class="deploy-option-select"
                                onchange="DeployWizard.updateConfig('memory', this.value)">
                            <option value="1Gi">1 Gi</option>
                            <option value="2Gi">2 Gi</option>
                            <option value="4Gi" selected>4 Gi</option>
                            <option value="8Gi">8 Gi</option>
                            <option value="16Gi">16 Gi</option>
                        </select>
                    </div>
                    <div class="deploy-option-field">
                        <label class="deploy-option-label" for="deployCpu">CPU</label>
                        <select id="deployCpu" class="deploy-option-select"
                                onchange="DeployWizard.updateConfig('cpu', this.value)">
                            <option value="1">1 vCPU</option>
                            <option value="2" selected>2 vCPU</option>
                            <option value="4">4 vCPU</option>
                            <option value="8">8 vCPU</option>
                        </select>
                    </div>
                    <div class="deploy-option-field">
                        <label class="deploy-option-label" for="deployTimeout">Timeout</label>
                        <select id="deployTimeout" class="deploy-option-select"
                                onchange="DeployWizard.updateConfig('timeout', this.value)">
                            <option value="100">100 s</option>
                            <option value="200">200 s</option>
                            <option value="300" selected>300 s</option>
                            <option value="400">400 s</option>
                            <option value="500">500 s</option>
                            <option value="600">600 s</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Configuration Summary -->
            <div class="deploy-config-summary" id="deployConfigSummary">
                <div class="deploy-config-summary-title">
                    <i class="fas fa-clipboard-check text-purple-500"></i> Configuration Summary
                </div>
                <div class="deploy-config-summary-grid">
                    <div class="deploy-config-summary-item deploy-config-summary-endpoint">
                        <span class="deploy-config-summary-label">Endpoint:</span>
                        <span class="deploy-config-summary-value">
                            <span id="deploySummaryEndpoint">-</span>
                            <span class="deploy-config-summary-badge new" id="deploySummaryBadge">new</span>
                        </span>
                    </div>
                </div>
                <div class="deploy-config-summary-grid">
                    <div class="deploy-config-summary-item">
                        <span class="deploy-config-summary-label">Instances:</span>
                        <span class="deploy-config-summary-value" id="deploySummaryInstances">1-10</span>
                    </div>
                    <div class="deploy-config-summary-separator"></div>
                    <div class="deploy-config-summary-item">
                        <span class="deploy-config-summary-label">Memory:</span>
                        <span class="deploy-config-summary-value" id="deploySummaryMemory">4Gi</span>
                    </div>
                    <div class="deploy-config-summary-separator"></div>
                    <div class="deploy-config-summary-item">
                        <span class="deploy-config-summary-label">CPU:</span>
                        <span class="deploy-config-summary-value" id="deploySummaryCpu">2 vCPU</span>
                    </div>
                    <div class="deploy-config-summary-separator"></div>
                    <div class="deploy-config-summary-item">
                        <span class="deploy-config-summary-label">Timeout:</span>
                        <span class="deploy-config-summary-value" id="deploySummaryTimeout">300s</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button class="btn-neu btn-neu-action btn-neu-save" id="deployWizardDeployBtn" onclick="DeployWizard.deploy()">
                    <span class="btn-neu-inner">Deploy</span>
                </button>
                <button class="btn-neu btn-neu-action btn-neu-cancel" onclick="DeployWizard.close()">
                    <span class="btn-neu-inner">Cancel</span>
                </button>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div class="deploy-wizard-loading hidden" id="deployWizardLoading">
            <div class="deploy-wizard-loading-content">
                <i class="fas fa-spinner fa-spin"></i>
                <span>Deploying to Cloud Run...</span>
            </div>
        </div>
    </div>
</div>
