{% load static %}
<!--
    Experiment View Modal Component

    A reusable modal for displaying experiment details, styled like Vertex AI Pipelines.

    Usage:
        { % include 'includes/_exp_view_modal.html' % }

    Required CSS:
        <link rel="stylesheet" href="{ % static 'css/exp_view_modal.css' % }?v=1">
        <link rel="stylesheet" href="{ % static 'css/modals.css' % }?v=1">

    Required JavaScript:
        <script src="{ % static 'js/exp_view_modal.js' % }?v=1"></script>
        <script src="{ % static 'js/pipeline_dag.js' % }?v=1"></script>

    JavaScript API:
        - ExpViewModal.open(experimentId, options) - Open modal for an experiment
        - ExpViewModal.close() - Close the modal
        - ExpViewModal.populate(experimentData, options) - Populate modal with data
        - ExpViewModal.switchTab(tabName) - Switch to a specific tab

    Configuration options:
        {
            showTabs: ['overview', 'pipeline', 'data', 'training'],
            showDataInsights: true,
            showTrainingTab: true,
            fieldMapping: { ... },  // Custom field mapping
            onClose: function() { },  // Callback when modal closes
            endpoints: {
                experimentDetails: '/api/...',
                componentLogs: '/api/...',
                dataInsights: '/api/...',
                trainingData: '/api/...'
            }
        }
-->

<!-- Experiment View Modal -->
<div id="expViewModal" class="modal-overlay hidden" onclick="ExpViewModal.handleOverlayClick(event)">
    <div class="modal-container exp-view-modal" onclick="event.stopPropagation()">
        <!-- Header - New ETL-style (experiment mode) -->
        <div class="modal-header-soft soft-exp-pending" id="expViewHeader">
            <div class="modal-header-icon-badge"><i class="fas fa-flask"></i></div>
            <div style="flex: 1;">
                <h3 class="modal-header-title" id="expViewTitle">Exp #—</h3>
                <div class="modal-header-subtitle" id="expViewSubtitle">Experiment overview</div>
            </div>
            <div class="modal-header-status-circle pending" id="expViewStatusBadge">
                <i class="fas fa-spinner fa-spin"></i>
            </div>
        </div>

        <!-- Header - Legacy 3-Column Layout (training_run / model / endpoint modes) -->
        <div class="modal-header exp-view-header" id="expViewHeaderLegacy" style="display: none;">
            <!-- Column 1: Experiment Number (20%, centered) -->
            <div class="exp-view-header-number">
                <h3 class="exp-view-title" id="expViewTitleLegacy">Run #1</h3>
            </div>
            <!-- Column 2: Name, Description, Times (60%, left-aligned) -->
            <div class="exp-view-header-info">
                <div class="exp-view-exp-name" id="expViewExpName"></div>
                <div class="exp-view-description" id="expViewDescription"></div>
                <div class="exp-view-times">
                    <div>Start: <span id="expViewStartTime">-</span></div>
                    <div>End: <span id="expViewEndTime">-</span></div>
                </div>
                <div class="exp-view-header-type-row">
                    <span class="exp-view-header-type-badge" id="expViewTypeBadge"></span>
                </div>
            </div>
            <!-- Column 3: Status Panel (20%, centered) -->
            <div class="exp-view-status-panel" id="expViewStatusPanel">
                <div class="exp-view-status-icon" id="expViewStatusIcon">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="exp-view-nav-bar exp-nav-pending" id="expViewNavBar">
            <div class="exp-view-nav-pills" id="expViewTabs">
                <button class="exp-view-pill current" data-tab="overview" onclick="ExpViewModal.switchTab('overview')">Overview</button>
                <button class="exp-view-pill" data-tab="pipeline" onclick="ExpViewModal.switchTab('pipeline')">Pipeline</button>
                <button class="exp-view-pill" data-tab="data" onclick="ExpViewModal.switchTab('data')">Data Insights</button>
                <button class="exp-view-pill" data-tab="training" onclick="ExpViewModal.switchTab('training')">Training Runs</button>
                <button class="exp-view-pill" data-tab="versions" onclick="ExpViewModal.switchTab('versions')" style="display: none;">Versions</button>
                <button class="exp-view-pill" data-tab="artifacts" onclick="ExpViewModal.switchTab('artifacts')" style="display: none;">Artifacts</button>
                <button class="exp-view-pill" data-tab="lineage" onclick="ExpViewModal.switchTab('lineage')" style="display: none;">Lineage</button>
                <button class="exp-view-pill" data-tab="logs" onclick="ExpViewModal.switchTab('logs')" style="display: none;">Logs</button>
            </div>
        </div>

        <!-- Tab Content -->
        <div class="modal-body exp-view-body">
            <!-- Overview Tab -->
            <div id="expViewTabOverview" class="exp-view-tab-content active">
                <!-- Card Sections (experiment mode only) -->
                <div id="expViewCardSections" style="display: none;">
                    <!-- Card 1: Experiment Information -->
                    <div class="exp-detail-section" style="margin-bottom: 16px;">
                        <div class="exp-detail-section-title">Experiment Information</div>
                        <div class="exp-detail-section-body">
                            <div class="exp-detail-section-icon info"><i class="fas fa-info-circle"></i></div>
                            <div class="exp-detail-stats">
                                <div class="exp-detail-stat-info" id="expCardName">
                                    <div class="stat-label">Name</div>
                                    <div class="stat-value">—</div>
                                </div>
                                <div class="exp-detail-stat-info" id="expCardModelType">
                                    <div class="stat-label">Model Type</div>
                                    <div class="stat-value">—</div>
                                </div>
                                <div class="exp-detail-stat-info" id="expCardDescription" style="flex: 2;">
                                    <div class="stat-label">Description</div>
                                    <div class="stat-value">—</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Card 2: Timeline -->
                    <div class="exp-detail-section" style="margin-bottom: 16px;">
                        <div class="exp-detail-section-title">Timeline</div>
                        <div class="exp-detail-section-body">
                            <div class="exp-detail-section-icon timeline"><i class="fas fa-clock"></i></div>
                            <div class="exp-detail-stats">
                                <div class="exp-detail-stat-info" id="expCardStart">
                                    <div class="stat-label">Start</div>
                                    <div class="stat-value">—</div>
                                </div>
                                <div class="exp-detail-stat-info" id="expCardEnd">
                                    <div class="stat-label">End</div>
                                    <div class="stat-value">—</div>
                                </div>
                                <div class="exp-detail-stat-info" id="expCardDuration">
                                    <div class="stat-label">Duration</div>
                                    <div class="stat-value">—</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Card 3: Results (hidden when not completed) -->
                    <div class="exp-detail-section" id="expCardResults" style="margin-bottom: 16px; display: none;">
                        <div class="exp-detail-section-title">Results</div>
                        <div class="exp-detail-section-body" style="align-items: flex-start;">
                            <div class="exp-detail-section-icon results"><i class="fas fa-chart-bar"></i></div>
                            <div id="expCardMetricsContainer" style="flex: 1; display: flex; flex-direction: column; gap: 0;">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Dataset cards (rendered by JS, replacing the accordion) -->
                    <div id="expCardDatasetContainer" style="margin-bottom: 16px;">
                        <!-- Populated by renderDatasetDetails() in experiment mode -->
                    </div>
                </div>

                <!-- Legacy Results Summary (training_run mode) -->
                <div id="expViewResultsSummary" class="exp-view-results-summary hidden">
                    <h4 class="exp-view-group-title">Results</h4>
                    <div class="exp-view-metrics-row" id="expViewMetricsSummary">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- Accordion 1: Registry & Deployment (training_run mode only) -->
                <div id="expViewRegistryDeploymentSection" class="exp-view-accordion" style="display: none;">
                    <div class="exp-view-accordion-header" onclick="ExpViewModal.toggleAccordion('registryDeployment')">
                        <span class="exp-view-accordion-title">
                            <i class="fas fa-cube mr-2 text-purple-500"></i>Registry & Deployment
                        </span>
                        <span class="exp-view-accordion-status" id="expViewRegistryDeploymentStatus"></span>
                        <i id="expViewRegistryDeploymentChevron" class="fas fa-chevron-right exp-view-accordion-chevron"></i>
                    </div>
                    <div id="expViewRegistryDeploymentContent" class="exp-view-accordion-content hidden">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- Features Configuration (card sections) -->
                <div id="expViewFeaturesConfigContent" style="display: flex; flex-direction: column; gap: 16px; margin-bottom: 12px;">
                    <div class="exp-view-loading"><i class="fas fa-spinner fa-spin"></i> Loading...</div>
                </div>

                <!-- Accordion 2: Dataset Configuration (hidden in experiment mode) -->
                <div id="expViewDatasetAccordion" class="exp-view-accordion">
                    <div class="exp-view-accordion-header" onclick="ExpViewModal.toggleAccordion('dataset')">
                        <span class="exp-view-accordion-title">
                            <i class="fas fa-database mr-2 text-purple-500"></i><span class="exp-view-accordion-label">Dataset:</span> <span id="expViewDatasetName" class="exp-view-accordion-value">-</span>
                        </span>
                        <i id="expViewDatasetChevron" class="fas fa-chevron-right exp-view-accordion-chevron"></i>
                    </div>
                    <div id="expViewDatasetContent" class="exp-view-accordion-content hidden">
                        <div id="expViewDatasetDetails" class="exp-view-dataset-details">
                            <div class="exp-view-loading"><i class="fas fa-spinner fa-spin"></i> Loading...</div>
                        </div>
                    </div>
                </div>

                <!-- Accordion 4: Model Architecture -->
                <div class="exp-view-accordion">
                    <div class="exp-view-accordion-header" onclick="ExpViewModal.toggleAccordion('model')">
                        <span class="exp-view-accordion-title">
                            <i class="fas fa-project-diagram mr-2 text-green-500"></i><span class="exp-view-accordion-label">Model:</span> <span id="expViewModelConfigName" class="exp-view-accordion-value">-</span>
                        </span>
                        <span class="exp-view-accordion-badge" id="expViewModelTypeBadgeSmall"></span>
                        <i id="expViewModelChevron" class="fas fa-chevron-right exp-view-accordion-chevron"></i>
                    </div>
                    <div id="expViewModelContent" class="exp-view-accordion-content hidden">
                        <div id="expViewModelConfigContent">
                            <div class="exp-view-loading"><i class="fas fa-spinner fa-spin"></i> Loading...</div>
                        </div>
                    </div>
                </div>

                <!-- Accordion 5: Training Setup -->
                <div class="exp-view-accordion">
                    <div class="exp-view-accordion-header" onclick="ExpViewModal.toggleAccordion('trainingSetup')">
                        <span class="exp-view-accordion-title">
                            <i class="fas fa-cogs mr-2 text-orange-500"></i>Training Setup
                        </span>
                        <i id="expViewTrainingSetupChevron" class="fas fa-chevron-right exp-view-accordion-chevron"></i>
                    </div>
                    <div id="expViewTrainingSetupContent" class="exp-view-accordion-content hidden">
                        <div class="exp-view-training-setup-grid">
                            <!-- Sampling Column -->
                            <div class="exp-view-training-setup-column">
                                <h5 class="exp-view-training-setup-subtitle">Sampling</h5>
                                <div id="expViewSamplingChips" class="exp-view-training-params">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </div>
                            <!-- Training Parameters Column -->
                            <div class="exp-view-training-setup-column">
                                <h5 class="exp-view-training-setup-subtitle">Training Parameters</h5>
                                <div id="expViewTrainingParamsChips" class="exp-view-training-params">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pipeline Tab -->
            <div id="expViewTabPipeline" class="exp-view-tab-content">
                <!-- Progress Bar (for running experiments) -->
                <div id="expViewProgressSection" class="exp-view-progress-section" style="display: none;">
                    <div class="exp-view-progress-bar-container">
                        <div class="exp-view-progress-bar" id="expViewProgressBar" style="width: 0%"></div>
                    </div>
                    <span class="exp-view-progress-text" id="expViewProgressText">0%</span>
                </div>

                <!-- Pipeline DAG (include the pipeline DAG component) -->
                {% include 'includes/_pipeline_dag.html' %}

                <!-- Component Detail Panel (shown on node click) -->
                <div id="expViewComponentDetail" class="exp-view-component-detail hidden">
                    <!-- Header Section -->
                    <div class="component-logs-header">
                        <div class="component-logs-header-left">
                            <div class="component-logs-icon">
                                <i class="fas fa-cube"></i>
                            </div>
                            <div class="component-logs-info">
                                <h4 id="expViewComponentName">Component</h4>
                                <div class="component-logs-meta">
                                    <span class="component-status-badge" id="expViewComponentStatus">pending</span>
                                    <span class="component-duration">
                                        <i class="fas fa-clock"></i>
                                        <span id="expViewComponentDurationText">-</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="component-logs-actions">
                            <button class="logs-load-btn" id="expViewLoadLogsBtn" onclick="ExpViewModal.refreshComponentLogs()">
                                <i class="fas fa-sync-alt"></i>
                                <span>Load Logs</span>
                            </button>
                        </div>
                    </div>
                    <!-- Logs Container -->
                    <div class="component-logs-wrapper">
                        <div class="exp-view-logs-container" id="expViewLogsContainer">
                            <div class="logs-empty-state">
                                <div class="logs-empty-icon">
                                    <i class="fas fa-terminal"></i>
                                </div>
                                <p class="logs-empty-title">No logs loaded</p>
                                <p class="logs-empty-subtitle">Click "Load Logs" to fetch component output</p>
                            </div>
                        </div>
                    </div>
                    <!-- Footer with Legend -->
                    <div class="component-logs-footer">
                        <div class="logs-legend">
                            <span class="logs-legend-item"><span class="logs-severity-dot INFO"></span> Info</span>
                            <span class="logs-legend-item"><span class="logs-severity-dot WARNING"></span> Warning</span>
                            <span class="logs-legend-item"><span class="logs-severity-dot ERROR"></span> Error</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Insights Tab (lazy-loaded) -->
            <div id="expViewTabData" class="exp-view-tab-content">
                <div id="expViewDataLoading" class="exp-view-loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>Loading data insights...</span>
                </div>
                <div id="expViewDataContent" class="hidden">
                    <!-- Statistics Summary Section -->
                    <div class="exp-view-section-group">
                        <div class="exp-view-group-header">
                            <h4 class="exp-view-group-title">Dataset Statistics</h4>
                            <a id="expViewTfdvBtn" class="exp-view-tfdv-btn hidden" href="#" target="_blank">
                                <i class="fas fa-external-link-alt"></i> Open Full Report
                            </a>
                        </div>
                        <div id="expViewStatsContent">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Numeric Features Section -->
                    <div id="expViewNumericSection" class="exp-view-section-group hidden">
                        <h4 class="exp-view-group-title">
                            <span>Numeric Features</span>
                            <span id="expViewNumericCount" class="exp-view-feature-count"></span>
                        </h4>
                        <div id="expViewNumericContent">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Categorical Features Section -->
                    <div id="expViewCategoricalSection" class="exp-view-section-group hidden">
                        <h4 class="exp-view-group-title">
                            <span>Categorical Features</span>
                            <span id="expViewCategoricalCount" class="exp-view-feature-count"></span>
                        </h4>
                        <div id="expViewCategoricalContent">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Schema Section -->
                    <div class="exp-view-section-group">
                        <h4 class="exp-view-group-title">Schema</h4>
                        <div id="expViewSchemaContent">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </div>
                <div id="expViewDataError" class="exp-view-data-message hidden">
                    <i class="fas fa-info-circle"></i>
                    <span id="expViewDataErrorMessage">Data insights not available</span>
                </div>
            </div>

            <!-- Training Tab (lazy-loaded) -->
            <div id="expViewTabTraining" class="exp-view-tab-content">
                <div id="expViewTrainingLoading" class="exp-view-loading hidden">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>Loading training data...</span>
                </div>

                <!-- Training Curves - Placeholder (shown when no MLflow data) -->
                <div id="expViewTrainingPlaceholder" class="exp-view-section-group">
                    <h4 class="exp-view-group-title">Training Progress</h4>
                    <div class="exp-view-chart-placeholder">
                        <i class="fas fa-chart-line"></i>
                        <p id="expViewTrainingMessage">Loading training data...</p>
                    </div>
                </div>

                <!-- Training Curves - Charts (shown when MLflow data available) -->
                <div id="expViewTrainingCharts" class="exp-view-section-group hidden">
                    <h4 class="exp-view-group-title">Training Progress</h4>
                    <div class="training-charts-container">
                        <div class="training-chart-wrapper">
                            <h5 class="training-chart-title">Loss</h5>
                            <canvas id="trainingLossChart" height="170"></canvas>
                        </div>
                        <div class="training-chart-wrapper">
                            <h5 id="metricsChartTitle" class="training-chart-title">Recall Metrics</h5>
                            <canvas id="trainingMetricsChart" height="170"></canvas>
                        </div>
                    </div>
                    <!-- Second row: Combined Weight Analysis (Norm + Distribution) -->
                    <div class="training-chart-wrapper" style="margin-top: 16px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                            <h5 class="training-chart-title" style="margin: 0;">Weight Analysis</h5>
                            <select id="weightAnalysisTower" class="weight-stats-select" onchange="ExpViewModal.updateWeightAnalysisCharts()">
                                <option value="query">Query Tower</option>
                                <option value="candidate">Candidate Tower</option>
                            </select>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <h6 style="font-size: 12px; font-weight: 500; color: #6b7280; margin: 0 0 4px 0;">Weight Norm (L1/L2)</h6>
                                <canvas id="trainingGradientChart" height="150"></canvas>
                            </div>
                            <div>
                                <h6 style="font-size: 12px; font-weight: 500; color: #6b7280; margin: 0 0 4px 0;">Weight Distribution</h6>
                                <canvas id="trainingWeightStatsChart" height="150"></canvas>
                            </div>
                        </div>
                    </div>
                    <!-- Third row: Distribution Histogram (TensorBoard-style ridgeline) - Weights or Gradients -->
                    <div class="training-charts-container" style="margin-top: 16px;">
                        <div class="training-chart-wrapper" style="grid-column: span 2;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                                <h5 id="histogramChartTitle" class="training-chart-title" style="margin: 0;">Weight Distribution Histogram</h5>
                                <div style="display: flex; gap: 8px;">
                                    <select id="histogramDataType" class="weight-stats-select" onchange="ExpViewModal.updateWeightHistogramChart()">
                                        <option value="weights">Weights</option>
                                        <option value="gradients">Gradients</option>
                                    </select>
                                    <select id="weightHistogramTower" class="weight-stats-select" onchange="ExpViewModal.updateWeightHistogramChart()">
                                        <option value="query">Query Tower</option>
                                        <option value="candidate">Candidate Tower</option>
                                    </select>
                                </div>
                            </div>
                            <div id="trainingWeightHistogramChart" style="width: 100%;"></div>
                        </div>
                    </div>
                </div>

                <!-- Final Metrics -->
                <div id="expViewFinalMetrics" class="exp-view-section-group hidden">
                    <h4 class="exp-view-group-title">Final Metrics</h4>
                    <div class="exp-view-rows" id="expViewMetricsRows">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- Vocabulary Stats -->
                <div id="expViewVocabSection" class="exp-view-section-group hidden">
                    <h4 class="exp-view-group-title">Vocabularies</h4>
                    <div class="exp-view-rows" id="expViewVocabRows">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>


            <!-- Versions Tab (for model mode) -->
            <div id="expViewTabVersions" class="exp-view-tab-content">
                <!-- Populated by JavaScript -->
            </div>

            <!-- Artifacts Tab (for model mode) -->
            <div id="expViewTabArtifacts" class="exp-view-tab-content">
                <!-- Populated by JavaScript -->
            </div>

            <!-- Lineage Tab (for model mode) -->
            <div id="expViewTabLineage" class="exp-view-tab-content">
                <!-- Populated by JavaScript -->
            </div>

            <!-- Logs Tab (for endpoint mode) -->
            <div id="expViewTabLogs" class="exp-view-tab-content">
                <!-- Populated by JavaScript -->
            </div>
        </div>

        <!-- Footer -->
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="ExpViewModal.close()">
                    <span class="btn-neu-inner">Close</span>
                </button>
            </div>
        </div>
    </div>
</div>
