{% extends 'base_model.html' %}
{% load humanize %}
{% load static %}

{% block title %}{{ model.name }} - Configs{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/cards.css' %}?v=4">
<link rel="stylesheet" href="{% static 'css/modals.css' %}?v=2">
<style>
    /* Feature Config specific styles */
    .tensor-dim-bar {
        height: 8px;
        background: #e5e7eb;
        border-radius: 4px;
        overflow: hidden;
    }
    .tensor-dim-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.3s ease;
    }
    .tensor-dim-fill.buyer {
        background: linear-gradient(90deg, #3b82f6, #60a5fa);
    }
    .tensor-dim-fill.product {
        background: linear-gradient(90deg, #10b981, #34d399);
    }
    .tensor-breakdown {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-top: 8px;
    }
    .tensor-breakdown-item {
        font-size: 11px;
        padding: 2px 6px;
        background: #f3f4f6;
        border-radius: 4px;
        color: #6b7280;
    }
    .config-card {
        transition: all 0.2s ease;
    }
    .config-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 8px;
        border-radius: 9999px;
        font-size: 11px;
        font-weight: 500;
    }
    .status-badge.draft {
        background: #fef3c7;
        color: #92400e;
    }
    .status-badge.active {
        background: #d1fae5;
        color: #065f46;
    }
    .status-badge.archived {
        background: #e5e7eb;
        color: #6b7280;
    }
    .leakage-warning {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 6px;
        background: #fef3c7;
        border-radius: 4px;
        font-size: 11px;
        color: #92400e;
    }

    /* Drag and drop styles - Compact column cards */
    .column-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 6px 8px;
        cursor: grab;
        transition: all 0.15s ease;
        user-select: none;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .column-card:hover {
        border-color: #3b82f6;
        background: #f8fafc;
    }
    .column-card.dragging {
        opacity: 0.5;
        cursor: grabbing;
    }
    .column-card .drag-handle {
        color: #d1d5db;
        font-size: 10px;
        flex-shrink: 0;
    }
    .column-card .column-name {
        font-size: 12px;
        font-weight: 500;
        color: #374151;
        flex: 1;
        min-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .column-card .column-type {
        font-size: 10px;
        padding: 1px 4px;
        background: #f3f4f6;
        border-radius: 3px;
        color: #6b7280;
        text-transform: uppercase;
    }

    .drop-zone {
        min-height: 200px;
        border: 2px dashed #e5e7eb;
        border-radius: 12px;
        padding: 16px;
        transition: all 0.2s ease;
    }
    .drop-zone.drag-over {
        border-color: #3b82f6;
        background: #eff6ff;
    }
    .drop-zone-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 150px;
        color: #9ca3af;
    }

    .assigned-feature {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 8px;
    }
    .assigned-feature:hover {
        border-color: #d1d5db;
    }
    .feature-config-btn {
        width: 28px;
        height: 28px;
        border-radius: 6px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: none;
        cursor: pointer;
        transition: all 0.15s ease;
    }
    .feature-config-btn.settings {
        background: #f3f4f6;
        color: #6b7280;
    }
    .feature-config-btn.settings:hover {
        background: #e5e7eb;
        color: #374151;
    }
    .feature-config-btn.remove {
        background: #fef2f2;
        color: #dc2626;
    }
    .feature-config-btn.remove:hover {
        background: #fee2e2;
    }

    .cross-feature {
        background: #f0fdf4;
        border: 1px solid #bbf7d0;
        border-radius: 8px;
        padding: 10px 12px;
        margin-bottom: 8px;
    }

    /* Tensor preview */
    .tensor-preview-panel {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 16px;
    }
    .tensor-preview-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
    }
    .tensor-preview-title {
        font-weight: 600;
        color: #374151;
    }
    .tensor-preview-total {
        font-size: 24px;
        font-weight: 700;
    }
    .tensor-preview-total.buyer {
        color: #3b82f6;
    }
    .tensor-preview-total.product {
        color: #10b981;
    }
    .tensor-breakdown-bar {
        display: flex;
        height: 24px;
        border-radius: 6px;
        overflow: hidden;
        background: #e5e7eb;
        margin-bottom: 8px;
    }
    .tensor-breakdown-segment {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: 500;
        color: white;
        transition: width 0.3s ease;
        overflow: hidden;
        white-space: nowrap;
    }

    /* Modal form styles */
    .modal-form-group {
        margin-bottom: 16px;
    }
    .modal-form-label {
        display: block;
        font-size: 13px;
        font-weight: 500;
        color: #374151;
        margin-bottom: 6px;
    }
    .modal-form-hint {
        font-size: 12px;
        color: #6b7280;
        margin-top: 4px;
    }
    .transform-option {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        padding: 12px;
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        margin-bottom: 8px;
    }
    .transform-option input[type="checkbox"] {
        margin-top: 2px;
    }
    .transform-option-content {
        flex: 1;
    }
    .transform-option-title {
        font-weight: 500;
        color: #374151;
    }
    .transform-option-desc {
        font-size: 12px;
        color: #6b7280;
        margin-top: 2px;
    }
    .transform-option-dim {
        font-size: 12px;
        font-weight: 600;
        color: #3b82f6;
        white-space: nowrap;
    }

    /* Sample Table Styles */
    .sample-table-container {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        overflow: hidden;
    }
    .sample-table-wrapper {
        max-height: 240px;
        overflow: auto;
    }
    .sample-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
    }
    .sample-table th {
        position: sticky;
        top: 0;
        background: #f9fafb;
        padding: 8px 12px;
        text-align: left;
        font-weight: 600;
        color: #374151;
        border-bottom: 2px solid #e5e7eb;
        white-space: nowrap;
    }
    .sample-table td {
        padding: 6px 12px;
        border-bottom: 1px solid #f3f4f6;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .sample-table tr:hover td {
        background: #f9fafb;
    }

    /* Column assignment colors for sample table */
    .col-buyer {
        background-color: #eff6ff !important;
    }
    .col-product {
        background-color: #f0fdf4 !important;
    }
    .col-both {
        background-color: #fef2f2 !important;
    }
    .sample-table th.col-buyer {
        background-color: #dbeafe !important;
        border-bottom-color: #3b82f6;
    }
    .sample-table th.col-product {
        background-color: #dcfce7 !important;
        border-bottom-color: #10b981;
    }
    .sample-table th.col-both {
        background-color: #fee2e2 !important;
        border-bottom-color: #ef4444;
    }
    .null-value {
        color: #9ca3af;
        font-style: italic;
    }

    /* BQ type badge in column cards */
    .column-bq-type {
        font-size: 9px;
        padding: 1px 4px;
        background: #f3f4f6;
        border-radius: 3px;
        color: #6b7280;
        font-family: monospace;
        flex-shrink: 0;
        text-transform: uppercase;
    }

    /* Needs attention state for features without transforms */
    .feature-config-btn.needs-attention {
        background: #fef3c7;
        color: #d97706;
        animation: pulse-attention 2s infinite;
    }
    @keyframes pulse-attention {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }
    .assigned-feature.feature-needs-config {
        background: #fef3c7;
        border-color: #fcd34d;
    }

    /* Column card assignment states */
    .column-card.assigned-buyer {
        border-left: 2px solid #3b82f6;
        background: #eff6ff;
    }
    .column-card.assigned-product {
        border-left: 2px solid #10b981;
        background: #f0fdf4;
    }
    .column-card.assigned-both {
        border-left: 2px solid #ef4444;
        background: #fef2f2;
    }

    /* Primary ID Drop Zone Styles */
    .primary-id-zone {
        border: 2px dashed #f59e0b;
        border-radius: 10px;
        padding: 16px;
        margin-bottom: 12px;
        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        position: relative;
    }
    .primary-id-zone.buyer {
        border-color: #3b82f6;
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    }
    .primary-id-zone.product {
        border-color: #10b981;
        background: linear-gradient(135deg, #f0fdf4 0%, #d1fae5 100%);
    }
    .primary-id-zone.drag-over {
        border-style: solid;
        box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.3);
    }
    .primary-id-zone.buyer.drag-over {
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
    }
    .primary-id-zone.product.drag-over {
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3);
    }
    .primary-id-zone-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
    }
    .primary-id-zone-icon {
        width: 24px;
        height: 24px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
    }
    .primary-id-zone.buyer .primary-id-zone-icon {
        background: #3b82f6;
        color: white;
    }
    .primary-id-zone.product .primary-id-zone-icon {
        background: #10b981;
        color: white;
    }
    .primary-id-zone-title {
        font-weight: 600;
        font-size: 14px;
        color: #374151;
    }
    .primary-id-zone-required {
        font-size: 10px;
        font-weight: 500;
        padding: 2px 6px;
        border-radius: 4px;
        background: transparent;
        color: #6b7280;
        margin-left: auto;
    }
    .primary-id-zone-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        color: #6b7280;
        text-align: center;
    }
    .primary-id-zone-empty i {
        font-size: 24px;
        margin-bottom: 8px;
        opacity: 0.5;
    }
    .primary-id-zone-empty span {
        font-size: 13px;
    }

    /* Assigned Primary ID Feature */
    .primary-id-assigned {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 12px;
    }
    .primary-id-zone.buyer .primary-id-assigned {
        border-color: #93c5fd;
    }
    .primary-id-zone.product .primary-id-assigned {
        border-color: #6ee7b7;
    }

    /* Additional Features Section - Locked State */
    .additional-features-section {
        border: 2px dashed #e5e7eb;
        border-radius: 10px;
        padding: 16px;
        min-height: 120px;
        transition: all 0.3s ease;
    }
    .additional-features-section.buyer {
        border-color: #3b82f6;
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    }
    .additional-features-section.product {
        border-color: #10b981;
        background: linear-gradient(135deg, #f0fdf4 0%, #d1fae5 100%);
    }
    .additional-features-section.locked {
        opacity: 0.6;
        pointer-events: none;
    }
    .additional-features-section.locked::before {
        content: '';
        position: absolute;
        inset: 0;
        cursor: not-allowed;
    }
    .additional-features-section.drag-over {
        border-style: solid;
    }
    .additional-features-section.buyer.drag-over {
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
    }
    .additional-features-section.product.drag-over {
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3);
    }
    .additional-features-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
        color: #6b7280;
        font-size: 13px;
        font-weight: 500;
    }
    .additional-features-header i {
        font-size: 12px;
    }
    .locked-message {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        color: #9ca3af;
        text-align: center;
    }
    .locked-message i {
        font-size: 20px;
        margin-bottom: 8px;
    }
    .locked-message span {
        font-size: 12px;
    }

    /* Code Viewer Modal Styles */
    .code-viewer-tabs {
        display: flex;
        border-bottom: 1px solid #e5e7eb;
        margin-bottom: 16px;
    }
    .code-viewer-tab {
        padding: 10px 20px;
        font-size: 14px;
        font-weight: 500;
        color: #6b7280;
        background: transparent;
        border: none;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        margin-bottom: -1px;
        transition: all 0.15s ease;
    }
    .code-viewer-tab:hover {
        color: #374151;
        background: #f9fafb;
    }
    .code-viewer-tab.active {
        color: #3b82f6;
        border-bottom-color: #3b82f6;
    }
    .code-viewer-tab .tab-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 20px;
        height: 20px;
        padding: 0 6px;
        margin-left: 6px;
        font-size: 11px;
        font-weight: 600;
        border-radius: 10px;
        background: #e5e7eb;
        color: #6b7280;
    }
    .code-viewer-tab.active .tab-badge {
        background: #dbeafe;
        color: #3b82f6;
    }
    .code-viewer-content {
        display: none;
    }
    .code-viewer-content.active {
        display: block;
    }
    .code-container {
        position: relative;
        background: #1e293b;
        border-radius: 8px;
        overflow: hidden;
    }
    .code-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 14px;
        background: #334155;
        border-bottom: 1px solid #475569;
    }
    .code-filename {
        font-size: 12px;
        font-weight: 500;
        color: #94a3b8;
        font-family: 'SF Mono', Monaco, 'Courier New', monospace;
    }
    .code-actions {
        display: flex;
        gap: 8px;
    }
    .code-action-btn {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 5px 10px;
        font-size: 11px;
        font-weight: 500;
        color: #94a3b8;
        background: #475569;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.15s ease;
    }
    .code-action-btn:hover {
        background: #64748b;
        color: #e2e8f0;
    }
    .code-action-btn.copied {
        background: #10b981;
        color: white;
    }
    .code-block {
        max-height: 450px;
        overflow: auto;
        padding: 16px;
    }
    .code-block pre {
        margin: 0;
        padding: 0;
        font-family: 'SF Mono', Monaco, 'Courier New', monospace;
        font-size: 12px;
        line-height: 1.6;
        color: #e2e8f0;
        white-space: pre;
        tab-size: 4;
    }
    /* Simple syntax highlighting */
    .code-block .keyword {
        color: #c678dd;
    }
    .code-block .string {
        color: #98c379;
    }
    .code-block .comment {
        color: #7f848e;
        font-style: italic;
    }
    .code-block .function {
        color: #61afef;
    }
    .code-block .decorator {
        color: #e5c07b;
    }
    .code-block .number {
        color: #d19a66;
    }
    .code-block .class-name {
        color: #e5c07b;
    }
    .code-block .builtin {
        color: #56b6c2;
    }
    .code-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px;
        color: #9ca3af;
    }
    .code-empty i {
        font-size: 32px;
        margin-bottom: 12px;
        opacity: 0.5;
    }
    .code-empty span {
        font-size: 14px;
    }
    .code-meta {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 12px 16px;
        background: #f9fafb;
        border-radius: 8px;
        margin-bottom: 12px;
        font-size: 12px;
        color: #6b7280;
    }
    .code-meta-item {
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .code-meta-item i {
        color: #9ca3af;
    }
    /* Code validation status */
    .validation-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .validation-badge.valid {
        background: #dcfce7;
        color: #166534;
    }
    .validation-badge.invalid {
        background: #fee2e2;
        color: #991b1b;
    }
    .validation-badge.checking {
        background: #fef3c7;
        color: #92400e;
    }
    .validation-badge i {
        font-size: 10px;
    }
    .validation-error-banner {
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 6px;
        padding: 10px 14px;
        margin-bottom: 12px;
        display: flex;
        align-items: flex-start;
        gap: 10px;
    }
    .validation-error-banner i {
        color: #dc2626;
        margin-top: 2px;
    }
    .validation-error-banner .error-text {
        color: #991b1b;
        font-size: 13px;
        font-family: 'SF Mono', 'Monaco', 'Menlo', monospace;
    }
    .validation-error-banner .error-line {
        color: #dc2626;
        font-weight: 600;
    }

    /* Chapter Section Styles */
    .chapter-section {
        background: white;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        padding: 24px;
    }
    .chapter-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
    }
    .chapter-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
    }
    .chapter-icon.model-structure {
        background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
        color: white;
    }
    .chapter-icon.quick-test {
        background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
        color: white;
    }
    .chapter-icon.experiments {
        background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
        color: white;
    }
    .chapter-title {
        font-size: 20px;
        font-weight: 700;
        color: #111827;
    }
    .chapter-empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 48px 24px;
        color: #9ca3af;
        text-align: center;
    }
    .chapter-empty-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
    }
    .chapter-empty-text {
        font-size: 14px;
        max-width: 300px;
    }

    /* =========================================================================
       Model Config Card Styles
       ========================================================================= */
    .model-config-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 16px;
        transition: all 0.2s ease;
        cursor: pointer;
    }
    .model-config-card:hover {
        border-color: #8b5cf6;
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.1);
    }
    .model-config-card-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        margin-bottom: 8px;
        gap: 10px;
    }
    /* Model Config Compare Styles */
    .mc-compare-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }
    .mc-compare-header {
        padding: 12px;
        background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        border-radius: 8px;
        text-align: center;
    }
    .mc-compare-header-name {
        font-size: 16px;
        font-weight: 600;
        color: #111827;
    }
    .mc-compare-header-meta {
        font-size: 12px;
        color: #6b7280;
        margin-top: 4px;
    }
    .mc-compare-section-title {
        font-size: 11px;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 8px 0 4px 0;
        border-bottom: 1px solid #e5e7eb;
    }
    .mc-compare-section-title.full-width {
        grid-column: span 2;
    }
    .mc-compare-tower {
        border: 2px dashed;
        border-radius: 10px;
        padding: 10px;
    }
    .mc-compare-tower.buyer {
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        border-color: #3b82f6;
    }
    .mc-compare-tower.product {
        background: linear-gradient(135deg, #f0fdf4 0%, #d1fae5 100%);
        border-color: #10b981;
    }
    .mc-compare-tower.ranking,
    .mc-compare-tower-section.ranking {
        background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
        border-color: #a855f7;
    }
    .mc-compare-tower-section.ranking .mc-compare-tower-header {
        background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%);
    }
    .mc-compare-table {
        width: 100%;
        border-collapse: collapse;
    }
    .mc-compare-table td {
        padding: 6px 8px;
        background: white;
        border-radius: 6px;
        margin-bottom: 4px;
    }
    .mc-compare-table tr {
        display: block;
        margin-bottom: 6px;
    }
    .mc-compare-table tr:last-child {
        margin-bottom: 0;
    }
    .mc-compare-row-diff td {
        background: #fef3c7 !important;
    }
    .mc-compare-output-layer td {
        border: 2px solid #f87171 !important;
    }
    .mc-compare-layer {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
    }
    .mc-compare-layer-empty {
        color: #9ca3af;
        font-style: italic;
        text-align: center;
    }
    .mc-compare-params {
        margin-top: 8px;
        padding: 8px;
        background: rgba(255,255,255,0.7);
        border-radius: 6px;
        font-size: 11px;
        font-family: monospace;
        text-align: right;
        color: #374151;
    }
    .mc-compare-params.mc-compare-diff {
        background: #fef3c7;
        font-weight: 600;
    }
    .mc-compare-params-section {
        padding: 10px;
        background: #f9fafb;
        border-radius: 8px;
    }
    .mc-compare-param {
        display: flex;
        justify-content: space-between;
        padding: 6px 8px;
        font-size: 12px;
        border-radius: 4px;
        margin-bottom: 4px;
    }
    .mc-compare-param:last-child {
        margin-bottom: 0;
    }
    .mc-compare-param .label {
        color: #6b7280;
    }
    .mc-compare-param .value {
        font-weight: 600;
        color: #111827;
    }
    .mc-compare-param.mc-compare-diff {
        background: #fef3c7;
    }

    /* New aligned layer comparison styles */
    .mc-compare-tower-section {
        padding: 12px;
        border-radius: 8px;
    }
    .mc-compare-tower-section.buyer {
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    }
    .mc-compare-tower-section.product {
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
    }
    .mc-compare-tower-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 10px;
    }
    .mc-compare-tower-title {
        font-size: 13px;
        font-weight: 600;
        color: #374151;
    }
    .mc-compare-tower-section.buyer .mc-compare-tower-title {
        color: #1e40af;
    }
    .mc-compare-tower-section.product .mc-compare-tower-title {
        color: #166534;
    }
    .mc-compare-layers-grid {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }
    .mc-compare-layer-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }
    .mc-compare-layer-cell {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 10px;
        background: white;
        border-radius: 6px;
        border: 1px solid rgba(0, 0, 0, 0.08);
        min-height: 38px;
    }
    .mc-compare-tower-section.buyer .mc-compare-layer-cell {
        border-color: rgba(59, 130, 246, 0.15);
    }
    .mc-compare-tower-section.product .mc-compare-layer-cell {
        border-color: rgba(16, 185, 129, 0.15);
    }
    .mc-compare-layer-cell.output-layer {
        border: 2px solid #f87171 !important;
        background: #fef2f2;
    }
    .mc-compare-layer-cell.placeholder {
        background: transparent;
        border: 1px dashed rgba(0, 0, 0, 0.15);
    }
    .mc-compare-layer-cell.mc-compare-diff {
        background: #fef3c7;
    }
    .mc-compare-layer-cell .layer-badge {
        display: inline-flex;
        align-items: center;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        flex-shrink: 0;
    }
    .mc-compare-layer-cell .layer-badge.dense {
        background: #e5e7eb;
        color: #374151;
    }
    .mc-compare-layer-cell .layer-badge.dropout {
        background: #fef3c7;
        color: #92400e;
    }
    .mc-compare-layer-cell .layer-badge.batch_norm {
        background: #d1fae5;
        color: #065f46;
    }
    .mc-compare-layer-cell .layer-badge.layer_norm {
        background: #e0e7ff;
        color: #3730a3;
    }
    .mc-compare-layer-cell .layer-params {
        flex: 1;
        font-size: 12px;
        color: #4b5563;
    }
    .mc-compare-params-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid rgba(0, 0, 0, 0.06);
    }
    .mc-compare-params-cell {
        text-align: right;
        font-size: 11px;
        font-family: 'Monaco', 'Menlo', monospace;
        color: #6b7280;
    }
    .mc-compare-params-cell.mc-compare-diff {
        color: #92400e;
        font-weight: 600;
    }

    /* Settings comparison grid */
    .mc-compare-settings-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }
    .mc-compare-settings-card {
        background: #f9fafb;
        border-radius: 8px;
        padding: 12px;
    }
    .mc-compare-settings-card .setting-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 8px;
        border-radius: 4px;
        margin-bottom: 4px;
        font-size: 12px;
    }
    .mc-compare-settings-card .setting-row:last-child {
        margin-bottom: 0;
    }
    .mc-compare-settings-card .setting-row .label {
        color: #6b7280;
    }
    .mc-compare-settings-card .setting-row .value {
        font-weight: 600;
        color: #111827;
    }
    .mc-compare-settings-card .setting-row.mc-compare-diff {
        background: #fef3c7;
    }
    .mc-compare-settings-card .setting-row.mc-compare-diff .value {
        color: #92400e;
    }
    .model-config-name {
        font-size: 16px;
        font-weight: 600;
        color: #111827;
        margin-bottom: 2px;
    }
    .model-config-desc {
        font-size: 12px;
        color: #6b7280;
        line-height: 1.4;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 100%;
    }
    .model-config-meta {
        font-size: 11px;
        color: #9ca3af;
        margin-top: 4px;
    }
    .model-type-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        flex-shrink: 0;
    }
    .model-type-badge.retrieval {
        background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
        color: white;
    }
    .model-type-badge.ranking {
        background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
        color: white;
    }
    .model-type-badge.multitask {
        background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
        color: white;
    }

    /* Tower Architecture Visualization - Card Layout */
    .mc-card-body {
        display: flex;
        gap: 20px;
    }
    .mc-towers-section {
        flex: 0 0 55%;
        min-width: 0;
    }
    .mc-params-section {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .tower-visual {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }
    /* Aligned version: both towers same height with output layers aligned at bottom */
    .tower-visual-aligned .tower-stack {
        display: flex;
        flex-direction: column;
    }
    .tower-visual-aligned .tower-column {
        display: flex;
        flex-direction: column;
    }
    .tower-visual-aligned .tower-stack {
        flex: 1;
    }
    .tower-column {
        min-width: 0;
    }
    .tower-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 6px;
    }
    .tower-label {
        font-size: 10px;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .tower-output-dim {
        font-size: 10px;
        font-weight: 600;
        padding: 2px 6px;
        border-radius: 4px;
    }
    .tower-output-dim.buyer {
        background: #dbeafe;
        color: #1d4ed8;
    }
    .tower-output-dim.product {
        background: #d1fae5;
        color: #047857;
    }

    /* Tower Stack - Card version (matches wizard Step 2 style) */
    .tower-stack {
        display: flex;
        flex-direction: column;
        gap: 8px;
        border-radius: 10px;
        padding: 12px;
        border: 2px dashed;
    }
    .tower-stack.buyer {
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        border-color: #3b82f6;
    }
    .tower-stack.product {
        background: linear-gradient(135deg, #f0fdf4 0%, #d1fae5 100%);
        border-color: #10b981;
    }
    .tower-stack.ranking {
        background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
        border-color: #8b5cf6;
    }
    .tower-stack::-webkit-scrollbar {
        width: 4px;
    }
    .tower-stack::-webkit-scrollbar-track {
        background: transparent;
    }
    .tower-stack::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.15);
        border-radius: 2px;
    }
    .tower-stack::-webkit-scrollbar-thumb:hover {
        background: rgba(0, 0, 0, 0.25);
    }

    /* Card Layer Item - Wizard-like style (matches .layer-item from Step 2) */
    .card-layer-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 12px;
        background: white;
        border-radius: 8px;
        border: 1px solid rgba(0, 0, 0, 0.08);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
    }
    .tower-stack.buyer .card-layer-item {
        border-color: rgba(59, 130, 246, 0.2);
    }
    .tower-stack.product .card-layer-item {
        border-color: rgba(16, 185, 129, 0.2);
    }
    .tower-stack.ranking .card-layer-item {
        border-color: rgba(139, 92, 246, 0.2);
    }
    .card-layer-item.output-layer {
        border: 2px solid #f87171 !important;
    }
    .card-layer-item.empty-placeholder {
        background: transparent;
        border: 1px dashed rgba(0, 0, 0, 0.1);
        visibility: hidden;
    }
    .card-layer-item .card-drag-handle {
        color: #c4c4c4;
        font-size: 12px;
    }
    .card-layer-badge {
        display: inline-flex;
        align-items: center;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        flex-shrink: 0;
    }
    .card-layer-badge.dense {
        background: #e5e7eb;
        color: #374151;
    }
    .card-layer-badge.dropout {
        background: #fef3c7;
        color: #92400e;
    }
    .card-layer-badge.batch_norm {
        background: #d1fae5;
        color: #065f46;
    }
    .card-layer-badge.layer_norm {
        background: #e0e7ff;
        color: #3730a3;
    }
    .card-layer-params {
        flex: 1;
        font-size: 12px;
        color: #4b5563;
    }
    .card-layer-actions {
        display: flex;
        gap: 4px;
    }
    .card-layer-action-btn {
        width: 28px;
        height: 28px;
        border-radius: 6px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: none;
        cursor: pointer;
        transition: all 0.15s ease;
        background: #f3f4f6;
        color: #6b7280;
        font-size: 12px;
    }
    .card-layer-action-btn:hover {
        background: #e5e7eb;
        color: #374151;
    }

    /* Legacy tower-layer for View modal */
    .tower-layer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 6px 10px;
        background: white;
        border-radius: 6px;
        font-size: 12px;
        border: 1px solid #e5e7eb;
    }
    .tower-layer.output-layer {
        border: 2px solid #f87171;
    }
    .layer-type {
        font-weight: 500;
        color: #374151;
    }
    .layer-type.dense {
        color: #1d4ed8;
    }
    .layer-type.dropout {
        color: #dc2626;
    }
    .layer-type.batch_norm {
        color: #7c3aed;
    }
    .layer-type.layer_norm {
        color: #4f46e5;
    }
    .layer-params {
        font-size: 11px;
        color: #6b7280;
        font-family: 'Monaco', 'Menlo', monospace;
    }

    /* Model Summary Row */
    .model-summary-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px 16px;
        padding: 8px 12px;
        background: #f9fafb;
        border-radius: 6px;
        margin-bottom: 10px;
        font-size: 11px;
    }
    .mc-params-section .model-summary-row {
        justify-content: flex-start;
    }
    .model-summary-item {
        display: flex;
        align-items: center;
        gap: 4px;
    }
    .model-summary-label {
        color: #9ca3af;
    }
    .model-summary-value {
        font-weight: 600;
        color: #374151;
    }

    /* Training Params Preview */
    .training-params-preview {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
    }
    .param-chip {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 5px 10px;
        background: #f3f4f6;
        border-radius: 6px;
        font-size: 11px;
        color: #4b5563;
    }
    .param-chip-label {
        color: #9ca3af;
    }
    .param-chip-value {
        font-weight: 600;
    }
    .param-chip.retrieval-algo {
        background: #f5f3ff;
        border: 1px solid #e9d5ff;
    }
    .param-chip.retrieval-algo .param-chip-value {
        color: #7c3aed;
    }
    .param-chip.model-type-chip {
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 5px 12px;
    }
    .param-chip.model-type-chip.retrieval {
        background: #dcfce7;
        color: #166534;
        border: 1px solid #bbf7d0;
    }
    .param-chip.model-type-chip.retrieval .param-chip-value {
        color: #166534;
    }
    .param-chip.model-type-chip.ranking {
        background: #fef3c7;
        color: #92400e;
        border: 1px solid #fde68a;
    }
    .param-chip.model-type-chip.ranking .param-chip-value {
        color: #92400e;
    }
    .param-chip.model-type-chip.multitask {
        background: #fce7f3;
        color: #be185d;
        border: 1px solid #fbcfe8;
    }
    .param-chip.model-type-chip.multitask .param-chip-value {
        color: #be185d;
    }
    .param-chip.multitask-weights {
        background: #fdf2f8;
        border: 1px solid #fbcfe8;
    }
    .param-chip.multitask-weights .param-chip-label {
        color: #9d174d;
    }
    .param-chip.multitask-weights .param-chip-value {
        color: #be185d;
        font-weight: 600;
    }

    /* Ranking Row Grid (Row 2: Hyperparams | Ranking bar) */
    .ranking-row-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        margin-top: 8px;
        align-items: start;
    }
    .ranking-tower-cell {
        /* Ranking bar takes right column, aligned with Product tower above */
    }
    .ranking-tower-cell .tower-visualization {
        margin-bottom: 0;
    }
    .training-params-preview.ranking-layout {
        /* Left column for hyperparams in ranking row */
        margin-top: 0;
        padding: 8px 0;
    }

    /* View Modal Rating Head Container */
    #viewMcRatingHeadSection .tower-visual {
        /* Override 2-column grid for ranking section - it has only one tower */
        display: block;
    }
    #viewMcRatingHeadSection .tower-column.ranking {
        /* Ranking tower takes 50% of the modal width (same as one tower in the 2-column grid) */
        width: 50%;
    }
    .tower-header.ranking .tower-label {
        color: #7c3aed;
    }

    /* Compact Tower Display for Cards */
    .compact-tower-row {
        display: flex;
        gap: 16px;
        margin-bottom: 12px;
    }
    .compact-tower-item {
        flex: 1;
        min-width: 0;
    }
    .compact-tower-label {
        font-size: 10px;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .compact-tower-label.buyer {
        color: #3b82f6;
    }
    .compact-tower-label.product {
        color: #10b981;
    }
    .compact-tower-layers {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 2px;
        font-size: 11px;
    }
    .compact-layer-type {
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 500;
        font-size: 10px;
    }
    .compact-layer-type.dense {
        background: #e5e7eb;
        color: #374151;
    }
    .compact-layer-type.dropout {
        background: #fef3c7;
        color: #92400e;
    }
    .compact-layer-type.batch_norm {
        background: #d1fae5;
        color: #065f46;
    }
    .compact-layer-type.layer_norm {
        background: #e0e7ff;
        color: #3730a3;
    }
    .layer-arrow {
        color: #9ca3af;
        font-size: 10px;
        margin: 0 2px;
    }
    .output-dim-badge {
        font-size: 10px;
        font-weight: 600;
        padding: 2px 6px;
        border-radius: 4px;
        margin-left: auto;
    }
    .output-dim-badge.buyer {
        background: #dbeafe;
        color: #1d4ed8;
    }
    .output-dim-badge.product {
        background: #d1fae5;
        color: #047857;
    }

    /* Layer Bar Visualization (tensor-bar style for model layers) */
    .tower-visualization {
        margin-bottom: 4px;
    }
    .towers-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        margin-bottom: 8px;
    }
    .tower-visualization-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 4px;
    }
    .tower-visualization-label {
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .tower-visualization-label.buyer {
        color: #3b82f6;
    }
    .tower-visualization-label.product {
        color: #10b981;
    }
    .tower-visualization-label.ranking {
        color: #7c3aed;
    }
    .tower-params-badge {
        font-size: 10px;
        font-weight: 600;
        padding: 2px 8px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        gap: 4px;
    }
    .tower-params-badge.buyer {
        background: #dbeafe;
        color: #1d4ed8;
    }
    .tower-params-badge.product {
        background: #d1fae5;
        color: #047857;
    }
    .tower-params-badge.ranking {
        background: #ede9fe;
        color: #5b21b6;
    }
    .layer-bar-container {
        display: flex;
        height: 24px;
        border-radius: 6px;
        overflow: hidden;
        background: #f3f4f6;
        gap: 1px;
        width: 100%;
    }
    .layer-bar-segment {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: 600;
        color: white;
        position: relative;
        overflow: hidden;
    }
    .layer-bar-segment.dense.buyer {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }
    .layer-bar-segment.dense.product {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }
    .layer-bar-segment.dense.ranking {
        background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
    }
    .layer-bar-segment.dropout {
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    }
    .layer-bar-segment.batch_norm {
        background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);
    }
    .layer-bar-segment.layer_norm {
        background: linear-gradient(135deg, #818cf8 0%, #6366f1 100%);
    }
    .layer-bar-segment .layer-units {
        font-size: 11px;
        font-weight: 600;
    }
    .layer-bar-segment .layer-label-small {
        font-size: 9px;
        font-weight: 600;
    }
    .layer-bar-segment.output-layer::after {
        content: '';
        position: absolute;
        right: 0;
        top: 0;
        bottom: 0;
        width: 3px;
        background: rgba(255,255,255,0.4);
    }

    /* Model Config Action Buttons */
    .model-config-actions {
        display: flex;
        gap: 8px;
    }
    .mc-action-btn {
        padding: 6px 14px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 500;
        border: none;
        cursor: pointer;
        transition: all 0.15s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        min-width: 36px;
        height: 34px;
    }
    .mc-action-btn.view {
        background: #10b981;
        color: white;
        padding: 6px 16px;
    }
    .mc-action-btn.view:hover {
        background: #059669;
    }
    .mc-action-btn.edit {
        background: #f3f4f6;
        color: #6b7280;
        padding: 6px 12px;
    }
    .mc-action-btn.edit:hover {
        background: #e5e7eb;
        color: #374151;
    }
    .mc-action-btn.delete {
        background: #fef2f2;
        color: #ef4444;
        padding: 6px 12px;
    }
    .mc-action-btn.delete:hover {
        background: #fee2e2;
        color: #dc2626;
    }

    /* Model Config Card Footer */
    .model-config-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding-top: 12px;
        border-top: 1px solid #f3f4f6;
        margin-top: 12px;
    }
    .mc-footer-btn {
        padding: 6px 16px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
        border: 1px solid #e5e7eb;
        background: white;
        color: #6b7280;
        cursor: pointer;
        transition: all 0.15s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }
    .mc-footer-btn:hover {
        background: #f9fafb;
        border-color: #d1d5db;
        color: #374151;
    }

    /* Model Config List (full-width cards like feature configs) */
    .model-config-grid {
        display: flex;
        flex-direction: column;
        gap: 12px;
        max-height: 500px;
        overflow-y: auto;
    }

    /* Model Config Filter Bar */
    .mc-filter-bar {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 16px;
    }
    .mc-filter-group {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .mc-filter-label {
        font-size: 13px;
        font-weight: 500;
        color: #6b7280;
    }
    .mc-filter-select {
        padding: 6px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        font-size: 13px;
        background: white;
        min-width: 140px;
    }
    .mc-filter-select:focus {
        outline: none;
        border-color: #8b5cf6;
        box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.1);
    }
    .mc-search-input {
        flex: 1;
        padding: 6px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        font-size: 13px;
        background: white;
    }
    .mc-search-input:focus {
        outline: none;
        border-color: #8b5cf6;
        box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.1);
    }
    .mc-search-input::placeholder {
        color: #9ca3af;
    }

    /* Model Config Wizard Styles */
    .wizard-model-type-selector {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin-bottom: 24px;
    }
    .wizard-model-type-option {
        padding: 16px;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
    }
    .wizard-model-type-option:hover:not(.disabled) {
        border-color: #8b5cf6;
        background: #faf5ff;
    }
    .wizard-model-type-option.selected {
        border-color: #8b5cf6;
        background: #f5f3ff;
    }
    .wizard-model-type-option.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .wizard-model-type-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 8px;
        font-size: 20px;
    }
    .wizard-model-type-icon.retrieval {
        background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
        color: white;
    }
    .wizard-model-type-icon.ranking {
        background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
        color: white;
    }
    .wizard-model-type-icon.multitask {
        background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
        color: white;
    }
    .wizard-model-type-name {
        font-weight: 600;
        color: #111827;
        margin-bottom: 4px;
    }
    .wizard-model-type-desc {
        font-size: 12px;
        color: #6b7280;
    }
    .wizard-model-type-phase {
        font-size: 10px;
        color: #9ca3af;
        margin-top: 4px;
    }

    /* Preset Selector */
    .preset-selector {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
        margin-bottom: 16px;
    }
    .preset-option {
        padding: 12px 8px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
    }
    .preset-option:hover {
        border-color: #8b5cf6;
    }
    .preset-option.selected {
        border-color: #8b5cf6;
        background: #f5f3ff;
    }
    .preset-option-name {
        font-size: 12px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 2px;
    }
    .preset-option-desc {
        font-size: 10px;
        color: #9ca3af;
    }

    /* Tower Builder Panel - matches Feature Config styling */
    .tower-builder-panel {
        border: 2px dashed #e5e7eb;
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
    }
    .tower-builder-panel.buyer {
        border-color: #3b82f6;
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    }
    .tower-builder-panel.product {
        border-color: #10b981;
        background: linear-gradient(135deg, #f0fdf4 0%, #d1fae5 100%);
    }
    .tower-builder-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 16px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }
    .tower-builder-title {
        font-weight: 600;
        font-size: 14px;
        color: #374151;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .tower-builder-title .tower-icon {
        width: 28px;
        height: 28px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        color: white;
    }
    .tower-builder-panel.buyer .tower-icon {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
    }
    .tower-builder-panel.product .tower-icon {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
    }
    .tower-builder-summary {
        font-size: 13px;
        font-weight: 600;
    }
    .tower-builder-panel.buyer .tower-builder-summary {
        color: #2563eb;
    }
    .tower-builder-panel.product .tower-builder-summary {
        color: #059669;
    }
    .layer-list {
        padding: 12px;
        min-height: 100px;
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    .layer-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 12px;
        background: white;
        border: 1px solid rgba(0, 0, 0, 0.08);
        border-radius: 8px;
        margin-bottom: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        transition: all 0.2s ease;
    }
    .layer-item:hover {
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }
    .tower-builder-panel.buyer .layer-item {
        border-color: rgba(59, 130, 246, 0.2);
    }
    .tower-builder-panel.product .layer-item {
        border-color: rgba(16, 185, 129, 0.2);
    }
    .layer-item:last-child {
        margin-bottom: 0;
    }
    .layer-item .drag-handle {
        color: #c4c4c4;
        cursor: grab;
        transition: color 0.2s ease;
    }
    .layer-item:hover .drag-handle {
        color: #9ca3af;
    }
    .layer-item .drag-handle.disabled {
        cursor: default;
        opacity: 0.3;
    }
    .layer-item.dragging {
        opacity: 0.5;
        cursor: grabbing;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .layer-item.drag-over {
        border-color: #3b82f6;
        border-style: dashed;
        background: #eff6ff;
    }
    .layer-item .layer-type-badge {
        font-size: 10px;
        font-weight: 600;
        padding: 3px 8px;
        border-radius: 4px;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }
    .layer-item .layer-type-badge.dense {
        background: #e5e7eb;
        color: #374151;
    }
    .layer-item .layer-type-badge.dropout {
        background: #fef3c7;
        color: #92400e;
    }
    .layer-item .layer-type-badge.batch_norm {
        background: #d1fae5;
        color: #065f46;
    }
    .layer-item .layer-type-badge.layer_norm {
        background: #e0e7ff;
        color: #3730a3;
    }
    .layer-item .layer-params {
        flex: 1;
        font-size: 12px;
        color: #4b5563;
    }
    .layer-item .layer-actions {
        display: flex;
        gap: 4px;
    }
    .layer-action-btn {
        width: 28px;
        height: 28px;
        border-radius: 6px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: none;
        cursor: pointer;
        transition: all 0.15s ease;
        background: #f3f4f6;
        color: #6b7280;
        font-size: 12px;
    }
    .layer-action-btn:hover {
        background: #e5e7eb;
        color: #374151;
    }
    .layer-action-btn.delete {
        background: #fef2f2;
        color: #ef4444;
    }
    .layer-action-btn.delete:hover {
        background: #fee2e2;
        color: #dc2626;
    }
    /* Output Embedding Layer (last layer - special styling) */
    .layer-item.output-layer {
        border: 2px solid #f87171 !important;
        background: white;
        margin-top: auto;
    }
    .add-layer-btn {
        width: 100%;
        padding: 10px;
        border: 2px dashed rgba(0, 0, 0, 0.15);
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.5);
        color: #6b7280;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }
    .tower-builder-panel.buyer .add-layer-btn:hover {
        border-color: #3b82f6;
        color: #2563eb;
        background: rgba(255, 255, 255, 0.8);
    }
    .tower-builder-panel.product .add-layer-btn:hover {
        border-color: #10b981;
        color: #059669;
        background: rgba(255, 255, 255, 0.8);
    }

    /* Tower Params Summary (Keras-style) */
    .tower-params-summary {
        margin: 8px 12px 12px 12px;
        padding: 10px 12px;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 8px;
        border-top: 2px solid rgba(0, 0, 0, 0.1);
        font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
        font-size: 11px;
    }
    .tower-params-summary .params-row {
        display: flex;
        justify-content: space-between;
        padding: 2px 0;
        color: #374151;
    }
    .tower-params-summary .params-row span:first-child {
        color: #6b7280;
    }
    .tower-params-summary .params-row span:last-child {
        font-weight: 600;
        color: #1f2937;
    }
    /* View modal tower summaries - match tower colors */
    .tower-params-summary.view-modal {
        margin: 8px 0 0 0;
        border: 2px dashed;
        border-top: 2px dashed;
    }
    .tower-column:first-child .tower-params-summary.view-modal {
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        border-color: #3b82f6;
    }
    .tower-column:last-child .tower-params-summary.view-modal {
        background: linear-gradient(135deg, #f0fdf4 0%, #d1fae5 100%);
        border-color: #10b981;
    }
    .tower-column.ranking .tower-params-summary.view-modal {
        background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
        border-color: #8b5cf6;
    }

    /* Retrieval Algorithm Section */
    .retrieval-algorithm-section {
        margin-top: 24px;
        padding: 20px;
        background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%);
        border: 2px dashed #eab308;
        border-radius: 16px;
    }
    .retrieval-algorithm-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
    }
    .retrieval-algorithm-header .header-icon {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #eab308 0%, #ca8a04 100%);
        box-shadow: 0 2px 6px rgba(234, 179, 8, 0.3);
    }
    .retrieval-algorithm-header .header-icon i {
        color: white;
        font-size: 14px;
    }
    .retrieval-algorithm-header h4 {
        font-size: 14px;
        font-weight: 600;
        color: #854d0e;
        margin: 0;
    }
    .retrieval-algorithm-header p {
        font-size: 11px;
        color: #a16207;
        margin: 0;
    }
    .algorithm-options {
        display: flex;
        gap: 12px;
        margin-bottom: 16px;
    }
    .algorithm-option {
        flex: 1;
        padding: 16px;
        border-radius: 12px;
        border: 2px solid transparent;
        cursor: pointer;
        transition: all 0.2s ease;
        background: white;
    }
    .algorithm-option:hover {
        border-color: #fbbf24;
        box-shadow: 0 2px 8px rgba(234, 179, 8, 0.2);
    }
    .algorithm-option.selected {
        border-color: #eab308;
        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        box-shadow: 0 2px 8px rgba(234, 179, 8, 0.25);
    }
    .algorithm-option .option-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
    }
    .algorithm-option .option-radio {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        border: 2px solid #d1d5db;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }
    .algorithm-option.selected .option-radio {
        border-color: #eab308;
        background: #eab308;
    }
    .algorithm-option.selected .option-radio::after {
        content: '';
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: white;
    }
    .algorithm-option .option-title {
        font-size: 13px;
        font-weight: 600;
        color: #1f2937;
    }
    .algorithm-option .option-badge {
        font-size: 9px;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 600;
        text-transform: uppercase;
    }
    .algorithm-option .option-badge.default {
        background: #dcfce7;
        color: #166534;
    }
    .algorithm-option .option-badge.advanced {
        background: #fef3c7;
        color: #92400e;
    }
    .algorithm-option .option-desc {
        font-size: 11px;
        color: #6b7280;
        line-height: 1.4;
        margin-left: 28px;
    }
    .algorithm-params {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 12px 16px;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 10px;
        margin-top: 12px;
    }
    .algorithm-param-group {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .algorithm-param-group label {
        font-size: 12px;
        font-weight: 500;
        color: #854d0e;
        white-space: nowrap;
    }
    .algorithm-param-group input,
    .algorithm-param-group select {
        padding: 6px 10px;
        border: 1px solid #fbbf24;
        border-radius: 6px;
        font-size: 12px;
        background: white;
        color: #1f2937;
        width: 80px;
        text-align: center;
    }
    .algorithm-param-group input:focus,
    .algorithm-param-group select:focus {
        outline: none;
        border-color: #eab308;
        box-shadow: 0 0 0 2px rgba(234, 179, 8, 0.2);
    }
    .scann-params {
        margin-top: 12px;
        padding: 16px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 10px;
        border: 1px solid #fde68a;
    }
    .scann-params-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
    }
    .scann-param {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    .scann-param label {
        font-size: 11px;
        font-weight: 500;
        color: #92400e;
    }
    .scann-param input {
        padding: 6px 10px;
        border: 1px solid #fde68a;
        border-radius: 6px;
        font-size: 12px;
        background: white;
        color: #1f2937;
    }
    .scann-info-banner {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        padding: 10px 12px;
        background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%);
        border-radius: 8px;
        border: 1px solid #fde68a;
        margin-top: 12px;
    }
    .scann-info-banner i {
        color: #ca8a04;
        margin-top: 2px;
    }
    .scann-info-banner p {
        font-size: 11px;
        color: #854d0e;
        margin: 0;
        line-height: 1.4;
    }

    /* Rating Head Section (for Ranking models) */
    .rating-head-section {
        margin-top: 24px;
        padding: 20px;
        background: linear-gradient(135deg, #fdf4ff 0%, #fae8ff 100%);
        border: 2px dashed #d946ef;
        border-radius: 16px;
    }
    .rating-head-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
    }
    .rating-head-header .header-icon {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #d946ef 0%, #a855f7 100%);
        box-shadow: 0 2px 6px rgba(217, 70, 239, 0.3);
    }
    .rating-head-header .header-icon i {
        color: white;
        font-size: 14px;
    }
    .rating-head-header h4 {
        font-size: 14px;
        font-weight: 600;
        color: #86198f;
        margin: 0;
    }
    .rating-head-header p {
        font-size: 11px;
        color: #a21caf;
        margin: 0;
    }
    .tower-builder-panel.rating-head {
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid #f0abfc;
    }
    .tower-builder-panel.rating-head .tower-builder-header {
        background: linear-gradient(135deg, #fae8ff 0%, #f5d0fe 100%);
        border-bottom: 1px solid #f0abfc;
    }
    .tower-icon.rating {
        background: linear-gradient(135deg, #d946ef 0%, #a855f7 100%);
    }
    .rating-head-info-banner {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        padding: 10px 12px;
        background: linear-gradient(135deg, #fdf4ff 0%, #fae8ff 100%);
        border-radius: 8px;
        border: 1px solid #f0abfc;
        margin-top: 12px;
    }
    .rating-head-info-banner i {
        color: #a855f7;
        margin-top: 2px;
    }
    .rating-head-info-banner p {
        font-size: 11px;
        color: #86198f;
        margin: 0;
        line-height: 1.4;
    }

    /* Training Params Form */
    .training-params-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }
    .training-param-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }
    .training-param-label {
        font-size: 12px;
        font-weight: 500;
        color: #374151;
    }
    .training-param-input {
        padding: 10px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
    }
    .training-param-input:focus {
        outline: none;
        border-color: #8b5cf6;
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }

    /* Training Step Card-based Layout */
    .training-step-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }
    .training-panel {
        border: 2px dashed #e5e7eb;
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
    }
    .training-panel.optimizer {
        border-color: #8b5cf6;
        background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
    }
    .training-panel.hyperparams {
        border-color: #f59e0b;
        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
    }
    .training-panel.loss-function {
        border-color: #ec4899;
        background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%);
        grid-column: span 2;
    }
    .panel-icon.loss {
        background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
    }
    .loss-function-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
    }
    .loss-option {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px;
        border-radius: 10px;
        border: 2px solid transparent;
        cursor: pointer;
        transition: all 0.2s ease;
        background: white;
        position: relative;
    }
    .loss-option:hover {
        border-color: #f9a8d4;
        box-shadow: 0 2px 8px rgba(236, 72, 153, 0.15);
    }
    .loss-option.selected {
        border-color: #ec4899;
        background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%);
        box-shadow: 0 2px 8px rgba(236, 72, 153, 0.2);
    }
    .loss-option input[type="radio"] {
        display: none;
    }
    .loss-radio {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        border: 2px solid #d1d5db;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: all 0.2s ease;
    }
    .loss-option.selected .loss-radio {
        border-color: #ec4899;
        background: #ec4899;
    }
    .loss-option.selected .loss-radio::after {
        content: '';
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: white;
    }
    .loss-info {
        flex: 1;
        min-width: 0;
    }
    .loss-name {
        font-size: 13px;
        font-weight: 600;
        color: #1f2937;
    }
    .loss-desc {
        font-size: 10px;
        color: #6b7280;
    }
    .loss-badge {
        position: absolute;
        top: 6px;
        right: 8px;
        font-size: 8px;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 600;
        text-transform: uppercase;
        background: #fce7f3;
        color: #be185d;
    }
    .loss-info-text {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        margin-top: 12px;
        padding: 10px 12px;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 8px;
        border: 1px solid #fbcfe8;
    }
    .loss-info-text i {
        color: #ec4899;
        margin-top: 2px;
    }
    .loss-info-text p {
        font-size: 11px;
        color: #9d174d;
        margin: 0;
        line-height: 1.4;
    }

    /* Multitask Loss Weighting Styles */
    .training-panel.multitask-weights {
        border-color: #ec4899;
        background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%);
        grid-column: span 2;
    }
    .panel-icon.multitask {
        background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
        box-shadow: 0 2px 4px rgba(236, 72, 153, 0.3);
    }
    .weight-slider-container {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
    }
    .weight-slider-item {
        background: white;
        border-radius: 12px;
        padding: 16px;
        border: 1px solid #fbcfe8;
    }
    .weight-slider-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
    }
    .weight-slider-label {
        font-size: 13px;
        font-weight: 600;
        color: #374151;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .weight-slider-label i {
        color: #ec4899;
    }
    .weight-value {
        font-size: 18px;
        font-weight: 700;
        color: #be185d;
        min-width: 36px;
        text-align: right;
    }
    .weight-slider {
        width: 100%;
        height: 8px;
        border-radius: 4px;
        background: #fce7f3;
        outline: none;
        -webkit-appearance: none;
        appearance: none;
        cursor: pointer;
    }
    .weight-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(236, 72, 153, 0.4);
        transition: transform 0.2s ease;
    }
    .weight-slider::-webkit-slider-thumb:hover {
        transform: scale(1.1);
    }
    .weight-slider::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
        cursor: pointer;
        border: none;
        box-shadow: 0 2px 6px rgba(236, 72, 153, 0.4);
    }
    .weight-slider.retrieval::-webkit-slider-thumb {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        box-shadow: 0 2px 6px rgba(59, 130, 246, 0.4);
    }
    .weight-slider.retrieval::-moz-range-thumb {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        box-shadow: 0 2px 6px rgba(59, 130, 246, 0.4);
    }
    .weight-slider.ranking::-webkit-slider-thumb {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        box-shadow: 0 2px 6px rgba(245, 158, 11, 0.4);
    }
    .weight-slider.ranking::-moz-range-thumb {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        box-shadow: 0 2px 6px rgba(245, 158, 11, 0.4);
    }
    .weight-slider-hint {
        font-size: 10px;
        color: #9ca3af;
        margin-top: 8px;
        margin-bottom: 0;
    }
    .weight-validation-warning {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 12px;
        padding: 10px 12px;
        background: #fef2f2;
        border-radius: 8px;
        border: 1px solid #fecaca;
    }
    .weight-validation-warning i {
        color: #ef4444;
    }
    .weight-validation-warning p {
        font-size: 11px;
        color: #b91c1c;
        margin: 0;
        font-weight: 500;
    }
    .weight-info-banner {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        margin-top: 16px;
        padding: 10px 12px;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 8px;
        border: 1px solid #fbcfe8;
    }
    .weight-info-banner i {
        color: #ec4899;
        margin-top: 2px;
    }
    .weight-info-banner p {
        font-size: 11px;
        color: #9d174d;
        margin: 0;
        line-height: 1.4;
    }

    /* Multitask Architecture Diagram Styles */
    .multitask-arch-section {
        margin-top: 20px;
        border-radius: 12px;
        border: 2px solid #f472b6;
        background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%);
        overflow: hidden;
    }
    .multitask-arch-header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 16px;
        background: rgba(255, 255, 255, 0.5);
        border-bottom: 1px solid rgba(244, 114, 182, 0.2);
    }
    .multitask-arch-header .header-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
        color: white;
        font-size: 14px;
    }
    .multitask-arch-header h4 {
        margin: 0;
        font-size: 14px;
        font-weight: 600;
        color: #be185d;
    }
    .multitask-arch-header p {
        margin: 0;
        font-size: 11px;
        color: #9d174d;
    }
    .multitask-arch-diagram {
        padding: 20px;
    }
    .arch-row {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 40px;
    }
    .arch-row.towers-row {
        gap: 60px;
    }
    .arch-tower {
        padding: 12px 20px;
        border-radius: 10px;
        text-align: center;
        min-width: 140px;
    }
    .arch-tower.buyer {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        border: 2px solid #3b82f6;
    }
    .arch-tower.product {
        background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
        border: 2px solid #22c55e;
    }
    .arch-tower-label {
        font-size: 12px;
        font-weight: 600;
        color: #374151;
    }
    .arch-tower-summary {
        font-size: 11px;
        color: #6b7280;
        font-family: monospace;
    }
    .arch-row.arrows-row {
        padding: 8px 0;
    }
    .arch-arrow {
        font-size: 18px;
        color: #9ca3af;
    }
    .arch-row.embeddings-row {
        gap: 60px;
    }
    .arch-embedding {
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 11px;
        font-weight: 500;
    }
    .arch-embedding.buyer {
        background: #3b82f6;
        color: white;
    }
    .arch-embedding.product {
        background: #22c55e;
        color: white;
    }
    .arch-row.split-row {
        padding: 12px 0;
    }
    .arch-split-line {
        width: 200px;
        height: 2px;
        background: linear-gradient(90deg, #3b82f6, #ec4899, #f59e0b);
        border-radius: 2px;
        position: relative;
    }
    .arch-split-line::before,
    .arch-split-line::after {
        content: '';
        position: absolute;
        top: 8px;
        font-size: 14px;
        color: #9ca3af;
    }
    .arch-split-line::before {
        left: 30px;
    }
    .arch-split-line::after {
        right: 30px;
    }
    .arch-row.paths-row {
        gap: 30px;
        align-items: stretch;
    }
    .arch-path {
        flex: 1;
        max-width: 200px;
        border-radius: 12px;
        padding: 14px;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .arch-path.retrieval {
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        border: 2px solid #3b82f6;
    }
    .arch-path.ranking {
        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        border: 2px solid #f59e0b;
    }
    .arch-path-header {
        font-size: 12px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .arch-path.retrieval .arch-path-header {
        color: #1d4ed8;
    }
    .arch-path.ranking .arch-path-header {
        color: #b45309;
    }
    .arch-path-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
    }
    .arch-operation {
        font-size: 10px;
        padding: 4px 10px;
        border-radius: 6px;
        background: rgba(255, 255, 255, 0.7);
        color: #374151;
    }
    .arch-arrow-small {
        font-size: 12px;
        color: #9ca3af;
    }
    .arch-rating-head {
        display: flex;
        flex-direction: column;
        align-items: center;
        font-size: 10px;
        padding: 6px 10px;
        border-radius: 6px;
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border: 1px solid #f59e0b;
    }
    .arch-rating-head span:first-child {
        font-weight: 600;
        color: #92400e;
    }
    .arch-rating-head span:last-child {
        font-family: monospace;
        color: #b45309;
    }
    .arch-output {
        font-size: 10px;
        font-weight: 600;
        padding: 4px 10px;
        border-radius: 6px;
    }
    .arch-path.retrieval .arch-output {
        background: #3b82f6;
        color: white;
    }
    .arch-path.ranking .arch-output {
        background: #f59e0b;
        color: white;
    }
    .arch-path-metric {
        font-size: 9px;
        display: flex;
        align-items: center;
        gap: 4px;
        justify-content: center;
        padding-top: 6px;
        border-top: 1px solid rgba(0, 0, 0, 0.1);
    }
    .arch-path.retrieval .arch-path-metric {
        color: #1d4ed8;
    }
    .arch-path.ranking .arch-path-metric {
        color: #b45309;
    }
    .arch-row.loss-row {
        margin-top: 16px;
    }
    .arch-combined-loss {
        background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%);
        border: 2px solid #ec4899;
        border-radius: 10px;
        padding: 12px 20px;
    }
    .arch-loss-formula {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 12px;
        font-weight: 500;
    }
    .loss-term {
        padding: 4px 10px;
        border-radius: 6px;
    }
    .loss-term.retrieval {
        background: #dbeafe;
        color: #1d4ed8;
    }
    .loss-term.ranking {
        background: #fef3c7;
        color: #b45309;
    }
    .loss-plus {
        font-size: 14px;
        font-weight: 700;
        color: #ec4899;
    }

    .training-panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 16px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }
    .training-panel-title {
        font-weight: 600;
        font-size: 14px;
        color: #374151;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .training-panel-title .panel-icon {
        width: 28px;
        height: 28px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        color: white;
    }
    .training-panel.optimizer .panel-icon {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        box-shadow: 0 2px 4px rgba(139, 92, 246, 0.3);
    }
    .training-panel.hyperparams .panel-icon {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
    }
    .training-panel-body {
        padding: 16px;
        flex: 1;
    }
    .optimizer-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }
    .optimizer-option {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 14px;
        background: white;
        border: 2px solid transparent;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        min-height: 72px;
    }
    .optimizer-option:hover {
        border-color: rgba(139, 92, 246, 0.3);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }
    .optimizer-option.selected {
        border-color: #8b5cf6;
        background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
        box-shadow: 0 2px 8px rgba(139, 92, 246, 0.2);
    }
    .optimizer-option input[type="radio"] {
        display: none;
    }
    .optimizer-radio {
        width: 18px;
        height: 18px;
        border: 2px solid #d1d5db;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        flex-shrink: 0;
    }
    .optimizer-option.selected .optimizer-radio {
        border-color: #8b5cf6;
        background: #8b5cf6;
    }
    .optimizer-radio::after {
        content: '';
        width: 6px;
        height: 6px;
        background: white;
        border-radius: 50%;
        opacity: 0;
        transition: opacity 0.2s ease;
    }
    .optimizer-option.selected .optimizer-radio::after {
        opacity: 1;
    }
    .optimizer-info {
        flex: 1;
        min-width: 0;
    }
    .optimizer-name {
        font-weight: 600;
        font-size: 13px;
        color: #374151;
    }
    .optimizer-desc {
        font-size: 11px;
        color: #6b7280;
        margin-top: 2px;
    }
    .optimizer-badge {
        font-size: 9px;
        font-weight: 600;
        padding: 2px 6px;
        border-radius: 4px;
        background: #10b981;
        color: white;
        text-transform: uppercase;
        flex-shrink: 0;
    }
    .hyperparam-item {
        background: white;
        border: 1px solid rgba(0, 0, 0, 0.08);
        border-radius: 10px;
        padding: 14px;
        margin-bottom: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
    }
    .hyperparam-item:last-child {
        margin-bottom: 0;
    }
    .hyperparam-label {
        font-size: 12px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .hyperparam-label i {
        color: #f59e0b;
        font-size: 11px;
    }
    .hyperparam-input-wrapper {
        position: relative;
    }
    .hyperparam-input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.2s ease;
    }
    .hyperparam-input:focus {
        outline: none;
        border-color: #f59e0b;
        box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
    }
    .hyperparam-hint {
        font-size: 11px;
        color: #9ca3af;
        margin-top: 6px;
    }
    .lr-presets {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-top: 8px;
    }
    .lr-preset-btn {
        padding: 6px 0;
        width: 56px;
        font-size: 11px;
        font-weight: 500;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        background: white;
        color: #6b7280;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
    }
    .lr-preset-btn:hover {
        border-color: #f59e0b;
        color: #f59e0b;
    }
    .lr-preset-btn.active {
        background: #f59e0b;
        border-color: #f59e0b;
        color: white;
    }

    /* Fix for progress bar - ensure last pill has rounded right border */
    .progress-step-pill:last-child {
        border-top-right-radius: 24px;
        border-bottom-right-radius: 24px;
    }
    .progress-step-pill:first-child {
        border-top-left-radius: 24px;
        border-bottom-left-radius: 24px;
    }
</style>
{% endblock %}

{% block model_content %}
<div class="space-y-6">
    <!-- Modeling Container -->
    <div class="bg-white rounded-xl border border-black shadow-lg p-6">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-gray-900">Features</h2>
            <div class="btn-group">
                <button onclick="openCompareModal()" class="btn btn-secondary btn-sm" style="width: 150px;">
                    <i class="fas fa-columns"></i>Compare
                </button>
                <button onclick="openWizard()" class="btn btn-primary btn-sm" style="width: 150px;">
                    <i class="fas fa-plus"></i>New Feats Set
                </button>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="flex items-center gap-4 mb-4">
            <div class="flex items-center gap-2">
                <label class="text-sm font-medium text-gray-600">Dataset:</label>
                <select id="datasetFilter" onchange="filterConfigs()" class="form-select text-sm" style="min-width: 200px;">
                    <option value="">All Datasets</option>
                </select>
            </div>
            <div class="flex-1">
                <input type="text" id="searchInput" placeholder="Search feature configs..."
                       class="form-input w-full text-sm" onkeyup="debounceSearch()">
            </div>
        </div>

        <!-- Feature Configs List - scrollable, shows ~2 cards -->
        <div id="configsList" class="space-y-3" style="max-height: 420px; overflow-y: auto; min-height: 100px;">
            <!-- Loading state -->
            <div id="configsLoading" class="flex items-center justify-center py-12">
                <i class="fas fa-spinner fa-spin text-2xl text-gray-400 mr-3"></i>
                <span class="text-gray-500">Loading feature configs...</span>
            </div>
            <!-- Empty state (hidden by default) -->
            <div id="configsEmpty" class="card-empty-state hidden">
                <p class="card-empty-state-title">No feature configs yet</p>
                <p class="card-empty-state-text">Create your first feature config to define how columns are transformed for training</p>
            </div>
            <!-- Config cards will be inserted here -->
        </div>
    </div>

    <!-- Model Structure Chapter -->
    <div class="chapter-section">
        <div class="chapter-header">
            <div class="chapter-icon model-structure">
                <i class="fas fa-layer-group"></i>
            </div>
            <h2 class="chapter-title">Model Structure</h2>
            <div class="ml-auto flex gap-2">
                <button onclick="openModelConfigCompareModal()" class="btn btn-secondary btn-sm" style="width: 150px;">
                    <i class="fas fa-columns mr-1"></i>Compare
                </button>
                <button onclick="openModelConfigWizard()" class="btn btn-primary btn-sm" style="width: 150px;">
                    <i class="fas fa-plus mr-1"></i>New Model Config
                </button>
            </div>
        </div>
        <div id="modelStructureContent">
            <!-- Filter Bar -->
            <div id="mcFilterBar" class="mc-filter-bar hidden">
                <div class="mc-filter-group">
                    <label class="mc-filter-label">Model Type:</label>
                    <select id="mcModelTypeFilter" class="mc-filter-select" onchange="filterModelConfigs()">
                        <option value="">All Types</option>
                        <option value="retrieval">Retrieval</option>
                        <option value="ranking">Ranking</option>
                        <option value="multitask">Multitask</option>
                    </select>
                </div>
                <input type="text" id="mcSearchInput" class="mc-search-input"
                       placeholder="Search model configs..." onkeyup="debounceMcSearch()">
            </div>

            <!-- Loading state -->
            <div id="modelConfigsLoading" class="flex items-center justify-center py-8">
                <i class="fas fa-spinner fa-spin text-xl text-gray-400 mr-3"></i>
                <span class="text-gray-500">Loading model configs...</span>
            </div>
            <!-- Empty state (hidden by default) -->
            <div id="modelConfigsEmpty" class="chapter-empty-state hidden">
                <i class="fas fa-cubes chapter-empty-icon"></i>
                <p class="chapter-empty-text">No model configurations yet</p>
                <p class="text-sm text-gray-400 mt-2">Create your first model config to define neural network architecture</p>
                <button onclick="openModelConfigWizard()" class="btn btn-primary btn-sm mt-4">
                    <i class="fas fa-plus mr-1"></i>Create Model Config
                </button>
            </div>
            <!-- No results state (for filtered searches) -->
            <div id="modelConfigsNoResults" class="chapter-empty-state hidden">
                <i class="fas fa-search chapter-empty-icon"></i>
                <p class="chapter-empty-text">No matching model configs</p>
                <p class="text-sm text-gray-400 mt-2">Try adjusting your filters or search term</p>
            </div>
            <!-- Model config cards container -->
            <div id="modelConfigsGrid" class="model-config-grid hidden"></div>
        </div>
    </div>

</div>

<!-- Model Config Wizard Modal -->
<div id="modelConfigWizardModal" class="modal-overlay hidden">
    <div class="modal-container modal-container-wizard" style="max-width: 900px;">
        <!-- Modal Header -->
        <div class="modal-header-wizard">
            <div class="modal-header-content">
                <div class="modal-header-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);">
                    <i class="fas fa-layer-group text-lg text-white"></i>
                </div>
                <div class="modal-header-info">
                    <h3 class="modal-header-title" id="modelConfigWizardTitle">Create Model Config</h3>
                    <p class="modal-step-counter">Step <span id="mcCurrentStep">1</span> of 3</p>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress-bar-pills">
                <div id="mcProgress1" class="progress-step-pill current">Basic Info</div>
                <div id="mcProgress2" class="progress-step-pill future">Architecture</div>
                <div id="mcProgress3" class="progress-step-pill future">Training</div>
            </div>
        </div>

        <!-- Modal Body -->
        <div class="modal-body-wizard" style="max-height: calc(90vh - 200px); overflow-y: auto;">
            <!-- Step 1: Basic Info + Model Type -->
            <div id="mcStep1" class="wizard-step active">
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Model Type</label>
                    <div class="wizard-model-type-selector">
                        <div class="wizard-model-type-option selected" data-type="retrieval" onclick="selectModelType('retrieval')">
                            <div class="wizard-model-type-icon retrieval">
                                <i class="fas fa-search"></i>
                            </div>
                            <div class="wizard-model-type-name">Retrieval</div>
                            <div class="wizard-model-type-desc">Two-tower model for candidate retrieval</div>
                        </div>
                        <div class="wizard-model-type-option" data-type="ranking" onclick="selectModelType('ranking')">
                            <div class="wizard-model-type-icon ranking">
                                <i class="fas fa-sort-amount-down"></i>
                            </div>
                            <div class="wizard-model-type-name">Ranking</div>
                            <div class="wizard-model-type-desc">Score and rank retrieved candidates</div>
                        </div>
                        <div class="wizard-model-type-option" data-type="multitask" onclick="selectModelType('multitask')">
                            <div class="wizard-model-type-icon multitask">
                                <i class="fas fa-project-diagram"></i>
                            </div>
                            <div class="wizard-model-type-name">Multitask</div>
                            <div class="wizard-model-type-desc">Combined retrieval + ranking</div>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Configuration Name <span class="text-red-500">*</span></label>
                    <div class="relative">
                        <input type="text" id="mcName" class="training-param-input w-full" placeholder="e.g., Standard Retrieval v1"
                               oninput="debounceMcNameCheck()" onblur="checkMcNameAvailability()" />
                        <div id="mcNameStatus" class="absolute right-3 top-1/2 -translate-y-1/2 hidden">
                            <i id="mcNameSpinner" class="fas fa-spinner fa-spin text-gray-400 hidden"></i>
                            <i id="mcNameValid" class="fas fa-check-circle text-green-500 hidden"></i>
                            <i id="mcNameInvalid" class="fas fa-times-circle text-red-500 hidden"></i>
                        </div>
                    </div>
                    <p id="mcNameError" class="text-red-500 text-xs mt-1 hidden"></p>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                    <textarea id="mcDescription" class="training-param-input w-full" rows="2" placeholder="Optional description..."></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Start From Preset</label>
                    <div class="preset-selector">
                        <div class="preset-option" data-preset="minimal" onclick="selectPreset('minimal')">
                            <div class="preset-option-name">Minimal</div>
                            <div class="preset-option-desc">6432, fast</div>
                        </div>
                        <div class="preset-option selected" data-preset="standard" onclick="selectPreset('standard')">
                            <div class="preset-option-name">Standard</div>
                            <div class="preset-option-desc">1286432</div>
                        </div>
                        <div class="preset-option" data-preset="deep" onclick="selectPreset('deep')">
                            <div class="preset-option-name">Deep</div>
                            <div class="preset-option-desc">2561286432</div>
                        </div>
                        <div class="preset-option" data-preset="regularized" onclick="selectPreset('regularized')">
                            <div class="preset-option-name">Regularized</div>
                            <div class="preset-option-desc">With dropout</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Tower Architecture -->
            <div id="mcStep2" class="wizard-step">
                <div class="grid grid-cols-2 gap-6">
                    <!-- Buyer Tower -->
                    <div class="tower-builder-panel buyer">
                        <div class="tower-builder-header">
                            <div class="tower-builder-title">
                                <div class="tower-icon">
                                    <i class="fas fa-user"></i>
                                </div>
                                Buyer Tower (Query)
                            </div>
                            <span id="buyerTowerSummary" class="tower-builder-summary">1286432</span>
                        </div>
                        <div class="p-2">
                            <button class="add-layer-btn" onclick="addLayer('buyer')">
                                <i class="fas fa-plus"></i> Add Layer
                            </button>
                        </div>
                        <div class="layer-list" id="buyerLayerList">
                            <!-- Layers will be rendered here -->
                        </div>
                        <div class="tower-params-summary" id="buyerParamsSummary">
                            <div class="params-row"><span>Total params:</span><span id="buyerTotalParams">0</span></div>
                            <div class="params-row"><span>Trainable params:</span><span id="buyerTrainableParams">0</span></div>
                            <div class="params-row"><span>Non-trainable params:</span><span>0</span></div>
                        </div>
                    </div>

                    <!-- Product Tower -->
                    <div class="tower-builder-panel product">
                        <div class="tower-builder-header">
                            <div class="tower-builder-title">
                                <div class="tower-icon">
                                    <i class="fas fa-box"></i>
                                </div>
                                Product Tower (Candidate)
                            </div>
                            <span id="productTowerSummary" class="tower-builder-summary">1286432</span>
                        </div>
                        <div class="p-2">
                            <button class="add-layer-btn" onclick="addLayer('product')">
                                <i class="fas fa-plus"></i> Add Layer
                            </button>
                        </div>
                        <div class="layer-list" id="productLayerList">
                            <!-- Layers will be rendered here -->
                        </div>
                        <div class="tower-params-summary" id="productParamsSummary">
                            <div class="params-row"><span>Total params:</span><span id="productTotalParams">0</span></div>
                            <div class="params-row"><span>Trainable params:</span><span id="productTrainableParams">0</span></div>
                            <div class="params-row"><span>Non-trainable params:</span><span>0</span></div>
                        </div>
                    </div>
                </div>

                <!-- Retrieval Algorithm Section -->
                <div class="retrieval-algorithm-section">
                    <div class="retrieval-algorithm-header">
                        <div class="header-icon">
                            <i class="fas fa-search"></i>
                        </div>
                        <div>
                            <h4>Retrieval Algorithm</h4>
                            <p>How to find top candidates from the product catalog</p>
                        </div>
                    </div>

                    <div class="algorithm-options">
                        <!-- Brute Force Option -->
                        <div class="algorithm-option selected" onclick="selectRetrievalAlgorithm('brute_force')">
                            <div class="option-header">
                                <div class="option-radio"></div>
                                <span class="option-title">Brute Force</span>
                                <span class="option-badge default">Default</span>
                            </div>
                            <p class="option-desc">Exact nearest neighbor search. Computes similarity with all products. Best for catalogs under 10K items.</p>
                        </div>

                        <!-- ScaNN Option -->
                        <div class="algorithm-option" onclick="selectRetrievalAlgorithm('scann')">
                            <div class="option-header">
                                <div class="option-radio"></div>
                                <span class="option-title">ScaNN</span>
                                <span class="option-badge advanced">Large Scale</span>
                            </div>
                            <p class="option-desc">Approximate nearest neighbor. 10-20x faster for large catalogs. ~97% accuracy with optimized parameters.</p>
                        </div>
                    </div>

                    <!-- Brute Force Parameters -->
                    <div id="bruteForceParams" class="algorithm-params">
                        <div class="algorithm-param-group">
                            <label>Top K Results:</label>
                            <input type="number" id="mcTopK" value="100" min="10" max="1000" step="10" />
                        </div>
                        <span class="text-xs text-amber-700">Number of recommendations to retrieve per query</span>
                    </div>

                    <!-- ScaNN Parameters (hidden by default) -->
                    <div id="scannParams" class="scann-params hidden">
                        <div class="scann-params-grid">
                            <div class="scann-param">
                                <label>Top K Results</label>
                                <input type="number" id="mcScannTopK" value="100" min="10" max="1000" step="10" />
                            </div>
                            <div class="scann-param">
                                <label>Num Leaves</label>
                                <input type="number" id="mcScannNumLeaves" value="100" min="10" max="10000" step="10" />
                            </div>
                            <div class="scann-param">
                                <label>Leaves to Search</label>
                                <input type="number" id="mcScannLeavesToSearch" value="10" min="1" max="1000" step="1" />
                            </div>
                        </div>
                        <div class="scann-info-banner">
                            <i class="fas fa-info-circle"></i>
                            <p><strong>Recommended for catalogs with 10,000+ products.</strong> ScaNN uses tree-partitioning for fast approximate search. Default values work well for most cases. Increase "Leaves to Search" for higher accuracy.</p>
                        </div>
                    </div>
                </div>

                <!-- Rating Head Section (for Ranking models) -->
                <div id="ratingHeadSection" class="rating-head-section hidden">
                    <div class="rating-head-header">
                        <div class="header-icon">
                            <i class="fas fa-star"></i>
                        </div>
                        <div>
                            <h4>Rating Head</h4>
                            <p>Predicts rating from concatenated buyer and product embeddings</p>
                        </div>
                    </div>

                    <!-- Rating Head Tower Builder -->
                    <div class="tower-builder-panel rating-head">
                        <div class="tower-builder-header">
                            <div class="tower-builder-title">
                                <div class="tower-icon rating">
                                    <i class="fas fa-star"></i>
                                </div>
                                Rating Prediction Network
                            </div>
                            <span id="ratingHeadSummary" class="tower-builder-summary">12864321</span>
                        </div>
                        <div class="p-2">
                            <button class="add-layer-btn" onclick="addLayer('rating_head')">
                                <i class="fas fa-plus"></i> Add Layer
                            </button>
                        </div>
                        <div class="layer-list" id="ratingHeadLayerList">
                            <!-- Layers will be rendered here -->
                        </div>
                        <div class="tower-params-summary" id="ratingHeadParamsSummary">
                            <div class="params-row"><span>Total params:</span><span id="ratingHeadTotalParams">0</span></div>
                            <div class="params-row"><span>Trainable params:</span><span id="ratingHeadTrainableParams">0</span></div>
                            <div class="params-row"><span>Non-trainable params:</span><span>0</span></div>
                        </div>
                    </div>

                    <div class="rating-head-info-banner">
                        <i class="fas fa-info-circle"></i>
                        <p>The Rating Head structure is derived from the tower preset selected in Step 1. It receives concatenated embeddings from both towers and outputs a single scalar prediction. You can manually edit the layers below, and you'll select the rating column when running a Quick Test.</p>
                    </div>
                </div>

                <!-- Multitask Architecture Diagram (for Multitask models) -->
                <div id="multitaskArchSection" class="multitask-arch-section hidden">
                    <div class="multitask-arch-header">
                        <div class="header-icon">
                            <i class="fas fa-project-diagram"></i>
                        </div>
                        <div>
                            <h4>Multitask Architecture</h4>
                            <p>Combined retrieval and ranking in a single model</p>
                        </div>
                    </div>

                    <div class="multitask-arch-diagram">
                        <!-- Tower Inputs -->
                        <div class="arch-row towers-row">
                            <div class="arch-tower buyer">
                                <div class="arch-tower-label">Buyer Tower</div>
                                <div class="arch-tower-summary" id="archBuyerSummary">1286432</div>
                            </div>
                            <div class="arch-tower product">
                                <div class="arch-tower-label">Product Tower</div>
                                <div class="arch-tower-summary" id="archProductSummary">1286432</div>
                            </div>
                        </div>

                        <!-- Arrows down -->
                        <div class="arch-row arrows-row">
                            <div class="arch-arrow"></div>
                            <div class="arch-arrow"></div>
                        </div>

                        <!-- Embeddings -->
                        <div class="arch-row embeddings-row">
                            <div class="arch-embedding buyer">
                                <span id="archBuyerDim">32D</span> embed
                            </div>
                            <div class="arch-embedding product">
                                <span id="archProductDim">32D</span> embed
                            </div>
                        </div>

                        <!-- Split arrows -->
                        <div class="arch-row split-row">
                            <div class="arch-split-line"></div>
                        </div>

                        <!-- Two paths -->
                        <div class="arch-row paths-row">
                            <!-- Retrieval Path -->
                            <div class="arch-path retrieval">
                                <div class="arch-path-header">
                                    <i class="fas fa-search"></i>
                                    Retrieval Task
                                </div>
                                <div class="arch-path-content">
                                    <div class="arch-operation">Dot Product</div>
                                    <div class="arch-arrow-small"></div>
                                    <div class="arch-output">Similarity Score</div>
                                </div>
                                <div class="arch-path-metric">
                                    <i class="fas fa-chart-line"></i>
                                    FactorizedTopK
                                </div>
                            </div>

                            <!-- Ranking Path -->
                            <div class="arch-path ranking">
                                <div class="arch-path-header">
                                    <i class="fas fa-star"></i>
                                    Ranking Task
                                </div>
                                <div class="arch-path-content">
                                    <div class="arch-operation">Concatenate [<span id="archConcatDim">64D</span>]</div>
                                    <div class="arch-arrow-small"></div>
                                    <div class="arch-rating-head">
                                        <span>Rating Head</span>
                                        <span id="archRatingHeadSummary">12864321</span>
                                    </div>
                                    <div class="arch-arrow-small"></div>
                                    <div class="arch-output">Rating Prediction</div>
                                </div>
                                <div class="arch-path-metric">
                                    <i class="fas fa-bullseye"></i>
                                    <span id="archLossFunction">MSE</span>
                                </div>
                            </div>
                        </div>

                        <!-- Combined Loss -->
                        <div class="arch-row loss-row">
                            <div class="arch-combined-loss">
                                <div class="arch-loss-formula">
                                    <span class="loss-term retrieval">
                                        <span id="archRetrievalWeight">1.0</span>  Retrieval Loss
                                    </span>
                                    <span class="loss-plus">+</span>
                                    <span class="loss-term ranking">
                                        <span id="archRankingWeight">1.0</span>  Ranking Loss
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Step 3: Training Parameters -->
            <div id="mcStep3" class="wizard-step">
                <div class="training-step-container">
                    <!-- Optimizer Panel -->
                    <div class="training-panel optimizer">
                        <div class="training-panel-header">
                            <div class="training-panel-title">
                                <div class="panel-icon">
                                    <i class="fas fa-cogs"></i>
                                </div>
                                Optimizer
                            </div>
                        </div>
                        <div class="training-panel-body">
                            <div class="optimizer-grid">
                                <label class="optimizer-option selected" onclick="selectOptimizer('adagrad')">
                                    <input type="radio" name="mcOptimizer" value="adagrad" checked>
                                    <div class="optimizer-radio"></div>
                                    <div class="optimizer-info">
                                        <div class="optimizer-name">Adagrad</div>
                                        <div class="optimizer-desc">Best for sparse embeddings</div>
                                    </div>
                                    <span class="optimizer-badge">Recommended</span>
                                </label>
                                <label class="optimizer-option" onclick="selectOptimizer('adam')">
                                    <input type="radio" name="mcOptimizer" value="adam">
                                    <div class="optimizer-radio"></div>
                                    <div class="optimizer-info">
                                        <div class="optimizer-name">Adam</div>
                                        <div class="optimizer-desc">Adaptive moments</div>
                                    </div>
                                </label>
                                <label class="optimizer-option" onclick="selectOptimizer('sgd')">
                                    <input type="radio" name="mcOptimizer" value="sgd">
                                    <div class="optimizer-radio"></div>
                                    <div class="optimizer-info">
                                        <div class="optimizer-name">SGD</div>
                                        <div class="optimizer-desc">Classic gradient descent</div>
                                    </div>
                                </label>
                                <label class="optimizer-option" onclick="selectOptimizer('rmsprop')">
                                    <input type="radio" name="mcOptimizer" value="rmsprop">
                                    <div class="optimizer-radio"></div>
                                    <div class="optimizer-info">
                                        <div class="optimizer-name">RMSprop</div>
                                        <div class="optimizer-desc">Adaptive learning rate</div>
                                    </div>
                                </label>
                                <label class="optimizer-option" onclick="selectOptimizer('adamw')">
                                    <input type="radio" name="mcOptimizer" value="adamw">
                                    <div class="optimizer-radio"></div>
                                    <div class="optimizer-info">
                                        <div class="optimizer-name">AdamW</div>
                                        <div class="optimizer-desc">Adam with weight decay</div>
                                    </div>
                                </label>
                                <label class="optimizer-option" onclick="selectOptimizer('ftrl')">
                                    <input type="radio" name="mcOptimizer" value="ftrl">
                                    <div class="optimizer-radio"></div>
                                    <div class="optimizer-info">
                                        <div class="optimizer-name">FTRL</div>
                                        <div class="optimizer-desc">Follow the regularized leader</div>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Hyperparameters Panel -->
                    <div class="training-panel hyperparams">
                        <div class="training-panel-header">
                            <div class="training-panel-title">
                                <div class="panel-icon">
                                    <i class="fas fa-sliders-h"></i>
                                </div>
                                Hyperparameters
                            </div>
                        </div>
                        <div class="training-panel-body">
                            <!-- Learning Rate -->
                            <div class="hyperparam-item">
                                <label class="hyperparam-label">
                                    <i class="fas fa-tachometer-alt"></i>
                                    Learning Rate
                                </label>
                                <div class="hyperparam-input-wrapper">
                                    <input type="number" id="mcLearningRate" class="hyperparam-input" value="0.1" step="0.01" min="0.0001" max="1.0" />
                                </div>
                                <div class="lr-presets">
                                    <button type="button" class="lr-preset-btn" onclick="setLearningRate(0.001)">0.001</button>
                                    <button type="button" class="lr-preset-btn" onclick="setLearningRate(0.01)">0.01</button>
                                    <button type="button" class="lr-preset-btn active" onclick="setLearningRate(0.1)">0.1</button>
                                    <button type="button" class="lr-preset-btn" onclick="setLearningRate(0.5)">0.5</button>
                                </div>
                                <p class="hyperparam-hint">Higher for Adagrad (0.1), lower for Adam (0.001)</p>
                            </div>

                            <!-- Batch Size -->
                            <div class="hyperparam-item">
                                <label class="hyperparam-label">
                                    <i class="fas fa-layer-group"></i>
                                    Batch Size
                                </label>
                                <select id="mcBatchSize" class="hyperparam-input">
                                    <option value="512">512 (small datasets)</option>
                                    <option value="1024">1024</option>
                                    <option value="2048">2048</option>
                                    <option value="4096" selected>4096 (recommended)</option>
                                    <option value="8192">8192</option>
                                    <option value="16384">16384 (large datasets)</option>
                                </select>
                                <p class="hyperparam-hint">Larger batches = faster training, more GPU memory</p>
                            </div>
                        </div>
                    </div>

                    <!-- Loss Function Panel (for Ranking models) -->
                    <div id="lossFunctionPanel" class="training-panel loss-function hidden">
                        <div class="training-panel-header">
                            <div class="training-panel-title">
                                <div class="panel-icon loss">
                                    <i class="fas fa-bullseye"></i>
                                </div>
                                Loss Function
                            </div>
                        </div>
                        <div class="training-panel-body">
                            <div class="loss-function-grid">
                                <label class="loss-option selected" onclick="selectLossFunction('mse')">
                                    <input type="radio" name="mcLossFunction" value="mse" checked>
                                    <div class="loss-radio"></div>
                                    <div class="loss-info">
                                        <div class="loss-name">MSE</div>
                                        <div class="loss-desc">Mean Squared Error</div>
                                    </div>
                                    <span class="loss-badge">Recommended</span>
                                </label>
                                <label class="loss-option" onclick="selectLossFunction('binary_crossentropy')">
                                    <input type="radio" name="mcLossFunction" value="binary_crossentropy">
                                    <div class="loss-radio"></div>
                                    <div class="loss-info">
                                        <div class="loss-name">Binary CE</div>
                                        <div class="loss-desc">Binary Crossentropy</div>
                                    </div>
                                </label>
                                <label class="loss-option" onclick="selectLossFunction('huber')">
                                    <input type="radio" name="mcLossFunction" value="huber">
                                    <div class="loss-radio"></div>
                                    <div class="loss-info">
                                        <div class="loss-name">Huber</div>
                                        <div class="loss-desc">Robust to outliers</div>
                                    </div>
                                </label>
                            </div>
                            <div class="loss-info-text" id="lossInfoText">
                                <i class="fas fa-info-circle"></i>
                                <p>Best for continuous ratings (e.g., 1.0-5.0). Penalizes large prediction errors more heavily.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Multitask Loss Weighting Panel (for Multitask models) -->
                    <div id="multitaskWeightSection" class="training-panel multitask-weights hidden">
                        <div class="training-panel-header">
                            <div class="training-panel-title">
                                <div class="panel-icon multitask">
                                    <i class="fas fa-balance-scale"></i>
                                </div>
                                Loss Weighting
                            </div>
                        </div>
                        <div class="training-panel-body">
                            <div class="weight-slider-container">
                                <!-- Retrieval Weight Slider -->
                                <div class="weight-slider-item">
                                    <div class="weight-slider-header">
                                        <label class="weight-slider-label">
                                            <i class="fas fa-search"></i>
                                            Retrieval Weight
                                        </label>
                                        <span class="weight-value" id="retrievalWeightValue">1.0</span>
                                    </div>
                                    <input type="range" id="mcRetrievalWeight" class="weight-slider retrieval"
                                           min="0" max="1" step="0.1" value="1.0"
                                           oninput="updateRetrievalWeight(this.value)" />
                                    <p class="weight-slider-hint">Higher = Optimize for candidate selection (Recall@K)</p>
                                </div>

                                <!-- Ranking Weight Slider -->
                                <div class="weight-slider-item">
                                    <div class="weight-slider-header">
                                        <label class="weight-slider-label">
                                            <i class="fas fa-star"></i>
                                            Ranking Weight
                                        </label>
                                        <span class="weight-value" id="rankingWeightValue">1.0</span>
                                    </div>
                                    <input type="range" id="mcRankingWeight" class="weight-slider ranking"
                                           min="0" max="1" step="0.1" value="1.0"
                                           oninput="updateRankingWeight(this.value)" />
                                    <p class="weight-slider-hint">Higher = Optimize for rating prediction (RMSE)</p>
                                </div>
                            </div>

                            <!-- Weight Validation Warning -->
                            <div id="weightValidationWarning" class="weight-validation-warning hidden">
                                <i class="fas fa-exclamation-triangle"></i>
                                <p>At least one weight must be greater than 0</p>
                            </div>

                            <div class="weight-info-banner">
                                <i class="fas fa-info-circle"></i>
                                <p>Both tasks share the same embedding towers. Weights control how much each loss contributes to training. A balanced start (1.0 / 1.0) is recommended for initial experiments.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Summary Panel -->
                <div class="mt-4 p-4 bg-purple-50 rounded-lg border border-purple-200">
                    <h4 class="font-semibold text-purple-900 mb-3">Configuration Summary</h4>
                    <div class="grid grid-cols-3 gap-4 text-sm">
                        <div>
                            <span class="text-purple-700">Model Type:</span>
                            <span id="mcSummaryType" class="font-medium text-purple-900">Retrieval</span>
                        </div>
                        <div>
                            <span class="text-purple-700">Buyer Tower:</span>
                            <span id="mcSummaryBuyer" class="font-medium text-purple-900">1286432</span>
                        </div>
                        <div>
                            <span class="text-purple-700">Product Tower:</span>
                            <span id="mcSummaryProduct" class="font-medium text-purple-900">1286432</span>
                        </div>
                        <div>
                            <span class="text-purple-700">Output Dim:</span>
                            <span id="mcSummaryOutputDim" class="font-medium text-purple-900">32</span>
                        </div>
                        <div id="mcSummaryRetrievalRow">
                            <span class="text-purple-700">Retrieval:</span>
                            <span id="mcSummaryRetrieval" class="font-medium text-purple-900">Brute Force (Top 100)</span>
                        </div>
                        <div id="mcSummaryRatingHeadRow" class="hidden">
                            <span class="text-purple-700">Rating Head:</span>
                            <span id="mcSummaryRatingHead" class="font-medium text-purple-900">256641</span>
                        </div>
                        <div id="mcSummaryLossRow" class="hidden">
                            <span class="text-purple-700">Loss:</span>
                            <span id="mcSummaryLoss" class="font-medium text-purple-900">MSE</span>
                        </div>
                        <div id="mcSummaryWeightsRow" class="hidden">
                            <span class="text-purple-700">Weights:</span>
                            <span id="mcSummaryWeights" class="font-medium text-purple-900">Ret: 1.0 / Rank: 1.0</span>
                        </div>
                        <div>
                            <span class="text-purple-700">Est. Parameters:</span>
                            <span id="mcSummaryParams" class="font-medium text-purple-900">~50K</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="modal-footer-wizard-neu">
            <div class="footer-left">
                <button type="button" id="mcBtnBack" class="btn-neu btn-neu-nav hidden" onclick="mcPrevStep()">
                    <span class="btn-neu-inner"><i class="fas fa-chevron-left"></i></span>
                </button>
                <button type="button" id="mcBtnNext" class="btn-neu btn-neu-nav" onclick="mcNextStep()">
                    <span class="btn-neu-inner"><i class="fas fa-chevron-right"></i></span>
                </button>
            </div>
            <div class="footer-right">
                <button type="button" id="mcBtnCreate" class="btn-neu btn-neu-action btn-neu-save hidden" onclick="createModelConfig()">
                    <span class="btn-neu-inner">Save</span>
                </button>
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeModelConfigWizard()">
                    <span class="btn-neu-inner">Cancel</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Layer Modal -->
<div id="layerModal" class="modal-overlay hidden" onclick="closeLayerModal(event)">
    <div class="modal-container" style="max-width: 480px;" onclick="event.stopPropagation()">
        <div class="modal-header">
            <div class="flex items-center gap-3">
                <div id="layerModalIcon" class="w-8 h-8 rounded-lg flex items-center justify-center" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);">
                    <i class="fas fa-layer-group text-white text-sm"></i>
                </div>
                <div>
                    <h3 class="modal-title" id="layerModalTitle">Edit Layer</h3>
                    <p class="text-xs text-gray-500" id="layerModalSubtitle">Configure layer parameters</p>
                </div>
            </div>
        </div>
        <div class="modal-body">
            <input type="hidden" id="layerModalTower" />
            <input type="hidden" id="layerModalIndex" value="-1" />
            <input type="hidden" id="layerModalMode" value="add" />

            <div class="mb-4" id="layerTypeGroup">
                <label class="block text-sm font-medium text-gray-700 mb-2">Layer Type</label>
                <select id="layerType" class="training-param-input w-full" onchange="updateLayerModalFields()">
                    <option value="dense">Dense</option>
                    <option value="dropout">Dropout</option>
                    <option value="batch_norm">Batch Normalization</option>
                    <option value="layer_norm">Layer Normalization</option>
                </select>
            </div>

            <!-- Dense Layer Fields -->
            <div id="denseFieldsModal">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Units</label>
                    <div class="flex gap-2 flex-wrap items-center justify-center mb-3">
                        <button type="button" class="layer-units-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400" onclick="selectLayerUnits(32)">32</button>
                        <button type="button" class="layer-units-btn px-3 py-2 rounded-lg border transition-all bg-blue-500 text-white border-blue-500" onclick="selectLayerUnits(64)">64</button>
                        <button type="button" class="layer-units-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400" onclick="selectLayerUnits(128)">128</button>
                        <button type="button" class="layer-units-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400" onclick="selectLayerUnits(256)">256</button>
                        <button type="button" class="layer-units-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400" onclick="selectLayerUnits(512)">512</button>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="text-sm text-gray-600">Custom:</span>
                        <input type="number" id="layerUnitsCustom" class="training-param-input" style="width: 100px;" placeholder="e.g. 1024" min="8" max="2048" oninput="onLayerUnitsCustomInput(this.value)" />
                        <span class="text-xs text-gray-400">Range: 8 - 2048</span>
                    </div>
                    <input type="hidden" id="layerUnits" value="64" />
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Activation</label>
                    <select id="layerActivation" class="training-param-input w-full">
                        <option value="relu" selected>ReLU</option>
                        <option value="leaky_relu">Leaky ReLU</option>
                        <option value="elu">ELU</option>
                        <option value="selu">SELU</option>
                        <option value="tanh">Tanh</option>
                        <option value="sigmoid">Sigmoid</option>
                        <option value="swish">Swish</option>
                        <option value="linear">Linear (None)</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Regularization</label>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Type</label>
                            <select id="layerRegType" class="training-param-input w-full" onchange="updateRegStrengthVisibility()">
                                <option value="none">None</option>
                                <option value="l2">L2 (Ridge)</option>
                                <option value="l1">L1 (Lasso)</option>
                            </select>
                        </div>
                        <div id="regStrengthGroup">
                            <label class="block text-xs text-gray-500 mb-1">Strength</label>
                            <input type="number" id="layerRegStrength" class="training-param-input w-full" value="0.001" min="0.0001" max="0.1" step="0.0001" />
                        </div>
                    </div>
                    <p class="text-xs text-gray-400 mt-1">L2 shrinks weights; L1 creates sparsity. Typical: 0.001-0.01</p>
                </div>
            </div>

            <!-- Dropout Layer Fields -->
            <div id="dropoutFieldsModal" class="hidden">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Dropout Rate</label>
                    <input type="number" id="layerDropoutRate" class="training-param-input w-full" value="0.2" min="0.05" max="0.5" step="0.05" />
                    <p class="text-xs text-gray-400 mt-1">Fraction of units to drop. Typical: 0.1-0.3</p>
                </div>
            </div>

            <!-- Batch Norm Fields -->
            <div id="batchNormFieldsModal" class="hidden">
                <p class="text-sm text-gray-500 py-4">Batch Normalization normalizes layer inputs. No configurable parameters needed.</p>
            </div>

            <!-- Layer Norm Fields -->
            <div id="layerNormFieldsModal" class="hidden">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Epsilon</label>
                    <input type="number" id="layerNormEpsilon" class="training-param-input w-full" value="0.000001" min="0.0000001" max="0.001" step="0.0000001" />
                    <p class="text-xs text-gray-400 mt-1">Small constant for numerical stability. Default: 1e-6</p>
                </div>
                <p class="text-sm text-gray-500 py-2">Layer Normalization normalizes across features (not batch). Works well with variable batch sizes and during inference.</p>
            </div>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-save" id="layerModalSubmitBtn" onclick="submitLayerModal()">
                    <span class="btn-neu-inner">Save</span>
                </button>
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeLayerModal()">
                    <span class="btn-neu-inner">Cancel</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Output Layer Edit Modal (edits both towers) -->
<div id="outputLayerModal" class="modal-overlay hidden" onclick="closeOutputLayerModal(event)">
    <div class="modal-container" style="max-width: 480px;" onclick="event.stopPropagation()">
        <div class="modal-header">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                    <i class="fas fa-compress-arrows-alt text-white text-sm"></i>
                </div>
                <div>
                    <h3 class="modal-title">Edit Output Embedding Layer</h3>
                    <p class="text-xs text-gray-500">Changes apply to both Buyer and Product towers</p>
                </div>
            </div>
        </div>
        <div class="modal-body">
            <div class="p-3 mb-4 rounded-lg border border-amber-200" style="background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);">
                <div class="flex items-start gap-2">
                    <i class="fas fa-info-circle text-amber-500 mt-0.5"></i>
                    <p class="text-xs text-amber-700">The output embedding layer defines the final embedding dimension for both towers. Both towers must have matching output dimensions for comparison.</p>
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Embedding Dimension</label>
                <div class="flex gap-2 flex-wrap items-center justify-center mb-3">
                    <button type="button" class="output-dim-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400" onclick="selectOutputDim(8)">8D</button>
                    <button type="button" class="output-dim-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400" onclick="selectOutputDim(16)">16D</button>
                    <button type="button" class="output-dim-btn px-3 py-2 rounded-lg border transition-all bg-blue-500 text-white border-blue-500" onclick="selectOutputDim(32)">32D</button>
                    <button type="button" class="output-dim-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400" onclick="selectOutputDim(64)">64D</button>
                    <button type="button" class="output-dim-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400" onclick="selectOutputDim(128)">128D</button>
                    <button type="button" class="output-dim-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400" onclick="selectOutputDim(256)">256D</button>
                </div>
                <div class="flex items-center gap-3">
                    <span class="text-sm text-gray-600">Custom:</span>
                    <input type="number" id="outputLayerCustomDim" class="training-param-input" style="width: 100px;" placeholder="e.g. 512" min="4" max="1024" oninput="onOutputCustomDimInput(this.value)" />
                    <span class="text-xs text-gray-400">Range: 4 - 1024</span>
                </div>
                <input type="hidden" id="outputLayerUnits" value="32" />
                <p class="text-xs text-gray-400 mt-2"><i class="fas fa-lightbulb text-amber-500 mr-1"></i>Tip: Use larger dimensions (256-512) for millions of unique IDs, smaller (8-32) for few unique values</p>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Activation Function</label>
                <select id="outputLayerActivation" class="training-param-input w-full">
                    <option value="relu" selected>ReLU</option>
                    <option value="leaky_relu">Leaky ReLU</option>
                    <option value="elu">ELU</option>
                    <option value="tanh">Tanh</option>
                    <option value="linear">Linear (None)</option>
                </select>
            </div>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-save" onclick="submitOutputLayer()">
                    <span class="btn-neu-inner">Save</span>
                </button>
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeOutputLayerModal()">
                    <span class="btn-neu-inner">Cancel</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Model Config View Modal -->
<div id="modelConfigViewModal" class="modal-overlay hidden" onclick="closeModelConfigViewModal(event)">
    <div class="modal-container" style="max-width: 750px; max-height: 80vh; display: flex; flex-direction: column;" onclick="event.stopPropagation()">
        <div class="modal-header">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);">
                    <i class="fas fa-layer-group text-white"></i>
                </div>
                <div>
                    <h3 class="modal-title" id="viewMcName">Model Config Name</h3>
                    <p class="text-sm text-gray-500" id="viewMcDesc">Description</p>
                </div>
            </div>
        </div>
        <div class="modal-body" style="overflow-y: auto; flex: 1;">
            <!-- Model Type + Metadata Row -->
            <div class="flex items-center justify-between mb-4">
                <span id="viewMcTypeBadge" class="model-type-badge retrieval">Retrieval</span>
                <div class="text-sm text-gray-500">
                    Updated <span id="viewMcUpdatedAt"></span>
                    <span id="viewMcCreatedByWrapper"> by <span id="viewMcCreatedBy"></span></span>
                </div>
            </div>

            <!-- Tower Architecture -->
            <div class="mb-6">
                <h4 class="text-sm font-medium text-gray-700 mb-3">Tower Architecture</h4>
                <div class="tower-visual tower-visual-aligned">
                    <div class="tower-column">
                        <div class="tower-header">
                            <span class="tower-label">Buyer Tower</span>
                        </div>
                        <div id="viewMcBuyerStack" class="tower-stack buyer">
                            <!-- Layers will be inserted here -->
                        </div>
                        <div class="tower-params-summary view-modal" id="viewMcBuyerParamsSummary">
                            <div class="params-row"><span>Total params:</span><span id="viewMcBuyerTotalParams">0</span></div>
                            <div class="params-row"><span>Trainable params:</span><span id="viewMcBuyerTrainableParams">0</span></div>
                            <div class="params-row"><span>Non-trainable params:</span><span>0</span></div>
                        </div>
                    </div>
                    <div class="tower-column">
                        <div class="tower-header">
                            <span class="tower-label">Product Tower</span>
                        </div>
                        <div id="viewMcProductStack" class="tower-stack product">
                            <!-- Layers will be inserted here -->
                        </div>
                        <div class="tower-params-summary view-modal" id="viewMcProductParamsSummary">
                            <div class="params-row"><span>Total params:</span><span id="viewMcProductTotalParams">0</span></div>
                            <div class="params-row"><span>Trainable params:</span><span id="viewMcProductTrainableParams">0</span></div>
                            <div class="params-row"><span>Non-trainable params:</span><span>0</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Model Summary (hidden - now shown per-tower above) -->
            <div class="model-summary-row mb-6 hidden" id="viewMcSummaryRow">
                <div class="model-summary-item">
                    <span class="model-summary-label">Total params:</span>
                    <span class="model-summary-value" id="viewMcTotalParams">~25K</span>
                </div>
                <div class="model-summary-item">
                    <span class="model-summary-label">Trainable:</span>
                    <span class="model-summary-value" id="viewMcTrainableParams">~25K</span>
                </div>
                <div class="model-summary-item">
                    <span class="model-summary-label">Non-trainable:</span>
                    <span class="model-summary-value" id="viewMcNonTrainableParams">0</span>
                </div>
            </div>

            <!-- Training Parameters -->
            <div class="mb-4">
                <h4 class="text-sm font-medium text-gray-700 mb-3">Training Parameters</h4>
                <div class="training-params-preview" id="viewMcParams">
                    <!-- Will be populated dynamically -->
                </div>
            </div>

            <!-- Retrieval Algorithm (for retrieval models) -->
            <div id="viewMcRetrievalSection" class="mb-4 hidden">
                <h4 class="text-sm font-medium text-gray-700 mb-3">Retrieval Algorithm</h4>
                <div class="training-params-preview" id="viewMcRetrievalParams">
                    <!-- Will be populated dynamically -->
                </div>
            </div>

            <!-- Rating Head (for ranking and multitask models) -->
            <div id="viewMcRatingHeadSection" class="mb-6 hidden">
                <h4 class="text-sm font-medium text-gray-700 mb-3">Rating Head</h4>
                <div class="tower-visual">
                    <div class="tower-column ranking">
                        <div class="tower-header ranking">
                            <span class="tower-label">Ranking Tower</span>
                        </div>
                        <div id="viewMcRatingHeadStack" class="tower-stack ranking">
                            <!-- Layers will be inserted here -->
                        </div>
                        <div class="tower-params-summary view-modal" id="viewMcRatingHeadParamsSummary">
                            <div class="params-row"><span>Total params:</span><span id="viewMcRatingHeadTotalParams">0</span></div>
                            <div class="params-row"><span>Trainable params:</span><span id="viewMcRatingHeadTrainableParams">0</span></div>
                            <div class="params-row"><span>Non-trainable params:</span><span>0</span></div>
                        </div>
                    </div>
                </div>
                <div class="training-params-preview mt-3" id="viewMcLossParams">
                    <!-- Will be populated dynamically -->
                </div>
            </div>

            <!-- Multitask Weights (for multitask models) -->
            <div id="viewMcMultitaskSection" class="mb-4 hidden">
                <h4 class="text-sm font-medium text-gray-700 mb-3">Multitask Weights</h4>
                <div class="training-params-preview" id="viewMcMultitaskParams">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeModelConfigViewModal()">
                    <span class="btn-neu-inner">Close</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Clone Model Config Modal -->
<div id="cloneModelConfigModal" class="modal-overlay hidden">
    <div class="modal-container" style="max-width: 450px;">
        <div class="modal-header">
            <div class="modal-header-icon info">
                <i class="fas fa-copy"></i>
            </div>
            <h3 class="modal-header-title">Clone Model Config</h3>
        </div>
        <div class="modal-body">
            <div class="mb-4">
                <label for="cloneModelConfigName" class="block text-sm font-medium text-gray-700 mb-2">
                    New config name
                </label>
                <input type="text" id="cloneModelConfigName"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                       placeholder="Enter name for cloned config">
            </div>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-save" onclick="submitModelConfigClone()">
                    <span class="btn-neu-inner">Clone</span>
                </button>
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeModelConfigCloneModal()">
                    <span class="btn-neu-inner">Cancel</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Compare Model Configs Modal -->
<div id="compareModelConfigsModal" class="modal-overlay hidden">
    <div class="modal-container" style="max-width: 950px; max-height: 85vh; display: flex; flex-direction: column;">
        <div class="modal-header">
            <div class="modal-header-icon info">
                <i class="fas fa-columns"></i>
            </div>
            <h3 class="modal-header-title">Compare Model Configs</h3>
        </div>
        <div class="modal-body" style="overflow-y: auto; flex: 1;">
            <!-- Dropdowns row -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Left Model Config</label>
                    <select id="mcCompareLeftSelect" onchange="onMcCompareSelectChange('left')"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select model config...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Right Model Config</label>
                    <select id="mcCompareRightSelect" onchange="onMcCompareSelectChange('right')"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select model config...</option>
                    </select>
                </div>
            </div>
            <!-- Comparison content -->
            <div id="mcCompareContent" class="space-y-4">
                <!-- Header Section -->
                <div id="mcCompareHeaders" class="grid grid-cols-2 gap-4">
                    <div id="mcCompareLeftHeader" class="p-4 bg-white border border-gray-200 rounded-lg">
                        <div class="flex items-center justify-center h-full text-gray-400 py-4">
                            <span>Select a model config</span>
                        </div>
                    </div>
                    <div id="mcCompareRightHeader" class="p-4 bg-white border border-gray-200 rounded-lg">
                        <div class="flex items-center justify-center h-full text-gray-400 py-4">
                            <span>Select a model config</span>
                        </div>
                    </div>
                </div>
                <!-- Buyer Tower Section (aligned layers) -->
                <div id="mcCompareBuyerSection" class="mc-compare-tower-section buyer hidden">
                    <div class="mc-compare-tower-header">
                        <span class="mc-compare-tower-title">Buyer Tower</span>
                    </div>
                    <div id="mcCompareBuyerLayers" class="mc-compare-layers-grid">
                        <!-- Layer rows will be rendered here -->
                    </div>
                    <div id="mcCompareBuyerParams" class="mc-compare-params-row">
                        <!-- Params will be rendered here -->
                    </div>
                </div>
                <!-- Product Tower Section (aligned layers) -->
                <div id="mcCompareProductSection" class="mc-compare-tower-section product hidden">
                    <div class="mc-compare-tower-header">
                        <span class="mc-compare-tower-title">Product Tower</span>
                    </div>
                    <div id="mcCompareProductLayers" class="mc-compare-layers-grid">
                        <!-- Layer rows will be rendered here -->
                    </div>
                    <div id="mcCompareProductParams" class="mc-compare-params-row">
                        <!-- Params will be rendered here -->
                    </div>
                </div>
                <!-- Rating Head Section (for Ranking models) -->
                <div id="mcCompareRatingHeadSection" class="mc-compare-tower-section ranking hidden">
                    <div class="mc-compare-tower-header">
                        <span class="mc-compare-tower-title">Rating Head</span>
                    </div>
                    <div id="mcCompareRating_headLayers" class="mc-compare-layers-grid">
                        <!-- Layer rows will be rendered here -->
                    </div>
                    <div id="mcCompareRating_headParams" class="mc-compare-params-row">
                        <!-- Params will be rendered here -->
                    </div>
                </div>
                <!-- Training Settings Section -->
                <div id="mcCompareSettingsSection" class="hidden">
                    <div class="text-sm font-semibold text-gray-700 mb-3">Training Settings</div>
                    <div id="mcCompareSettingsGrid" class="mc-compare-settings-grid">
                        <!-- Settings cards will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeModelConfigCompareModal()">
                    <span class="btn-neu-inner">Close</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Feature Config Wizard Modal -->
<div id="featureConfigWizardModal" class="modal-overlay hidden">
    <div class="modal-container modal-container-wizard" style="max-width: 1100px;">
        <!-- Modal Header -->
        <div class="modal-header-wizard">
            <div class="modal-header-content">
                <div class="modal-header-icon info">
                    <i class="fas fa-cogs text-lg"></i>
                </div>
                <div class="modal-header-info">
                    <h3 class="modal-header-title" id="wizardTitle">Create Feature Config</h3>
                    <p class="modal-step-counter">Step <span id="currentStep">1</span> of 2</p>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress-bar-pills">
                <div id="progress1" class="progress-step-pill current">Basic Info</div>
                <div id="progress2" class="progress-step-pill future">Features</div>
            </div>
        </div>

        <!-- Modal Body -->
        <div class="modal-body-wizard" style="max-height: calc(90vh - 200px); overflow-y: auto; position: relative;">
            <!-- Loading overlay for wizard (covers modal body) -->
            <div id="wizardLoadingOverlay" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.9); z-index: 100;">
                <div style="position: sticky; top: 50%; transform: translateY(-50%); display: flex; align-items: center; justify-content: center; gap: 12px;">
                    <i class="fas fa-spinner fa-spin text-2xl text-blue-500"></i>
                    <span class="text-gray-600" id="wizardLoadingText">Loading...</span>
                </div>
            </div>

            <!-- Step 1: Basic Info -->
            <div id="wizardStep1" class="wizard-step active">
                <h4 class="wizard-section-title">Basic Information</h4>

                <!-- Config Name -->
                <div class="wizard-field-group">
                    <label class="wizard-field-label">Config Name <span class="required">*</span></label>
                    <div class="relative">
                        <input type="text" id="configName" placeholder="e.g., Rich Features v1"
                               class="form-input w-full" oninput="debounceConfigNameCheck()" onblur="checkConfigNameAvailability()">
                        <div id="configNameStatus" class="absolute right-3 top-1/2 -translate-y-1/2 hidden">
                            <i id="configNameSpinner" class="fas fa-spinner fa-spin text-gray-400 hidden"></i>
                            <i id="configNameValid" class="fas fa-check-circle text-green-500 hidden"></i>
                            <i id="configNameInvalid" class="fas fa-times-circle text-red-500 hidden"></i>
                        </div>
                    </div>
                    <p id="nameError" class="text-xs text-red-600 mt-1 hidden"></p>
                </div>

                <!-- Description -->
                <div class="wizard-field-group">
                    <label class="wizard-field-label">Description <span class="optional">(optional)</span></label>
                    <textarea id="configDescription" placeholder="Describe the purpose of this feature configuration..."
                              class="form-textarea w-full" rows="2"></textarea>
                </div>

                <!-- Dataset Selection -->
                <div class="wizard-field-group">
                    <label class="wizard-field-label">Base Dataset <span class="required">*</span></label>
                    <select id="configDataset" class="form-select w-full" onchange="onDatasetChange()">
                        <option value="">Select a dataset...</option>
                    </select>
                    <div id="datasetInfo" class="text-xs text-gray-500 mt-2 hidden">
                        <span id="datasetInfoText"></span>
                    </div>
                </div>

                <!-- Start From Options -->
                <div class="wizard-field-group">
                    <label class="wizard-field-label">Start From</label>
                    <div class="flex flex-wrap gap-3 mt-2">
                        <label class="flex items-center gap-2 p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition">
                            <input type="radio" name="startFrom" value="blank" checked onchange="onStartFromChange()">
                            <div>
                                <div class="font-medium text-sm">Blank</div>
                                <div class="text-xs text-gray-500">Start from scratch</div>
                            </div>
                        </label>
                        <label class="flex items-center gap-2 p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition">
                            <input type="radio" name="startFrom" value="clone" onchange="onStartFromChange()">
                            <div>
                                <div class="font-medium text-sm">Clone Existing</div>
                                <div class="text-xs text-gray-500">Copy from another config</div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Clone Selection (hidden by default) -->
                <div id="cloneSelection" class="wizard-field-group hidden">
                    <label class="wizard-field-label">Clone From</label>
                    <select id="cloneFromConfig" class="form-select w-full">
                        <option value="">Select a config to clone...</option>
                    </select>
                </div>

                <div class="wizard-info-box info">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>What is a Feature Config?</strong><br>
                        A feature config defines how dataset columns are transformed into tensors for the two-tower model (BuyerModel and ProductModel).
                    </div>
                </div>
            </div>

            <!-- Step 2: Feature Assignment -->
            <div id="wizardStep2" class="wizard-step hidden" style="position: relative;">
                <!-- Dataset Sample - Collapsible Tablet -->
                <div class="filter-subchapter" id="datasetSampleSubchapter">
                    <div class="subchapter-header-tablet" onclick="toggleModelingSubchapter('datasetSample')">
                        <span class="subchapter-title">Dataset Sample</span>
                        <span class="subchapter-filter-status" id="datasetSampleStatus"></span>
                        <i id="datasetSampleChevron" class="fas fa-chevron-right subchapter-chevron"></i>
                    </div>
                    <div id="datasetSampleContent" class="subchapter-content-outside hidden">
                        <div id="sampleDataTable" class="sample-table-container">
                            <!-- Table will be rendered here -->
                        </div>
                    </div>
                </div>

                <!-- Available Columns - Collapsible Tablet -->
                <div class="filter-subchapter" id="availableColumnsSubchapter">
                    <div class="subchapter-header-tablet" onclick="toggleModelingSubchapter('availableColumns')">
                        <span class="subchapter-title">Available Columns</span>
                        <span class="subchapter-filter-status" id="availableColumnsStatus"></span>
                        <i id="availableColumnsChevron" class="fas fa-chevron-down subchapter-chevron"></i>
                    </div>
                    <div id="availableColumnsContent" class="subchapter-content-outside">
                        <p class="text-xs text-gray-500 mb-2">Drag columns to BuyerModel or ProductModel</p>
                        <div id="availableColumns" class="grid grid-cols-4 gap-2" style="max-height: 180px; overflow-y: auto;">
                            <!-- Column cards will be inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Model Drop Zones -->
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <!-- Buyer Model -->
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                            <span class="w-3 h-3 rounded-full bg-blue-500"></span>
                            <h5 class="font-semibold text-gray-800">BuyerModel (Query Tower)</h5>
                        </div>

                        <!-- Primary ID Zone: Customer ID -->
                        <div id="customerIdZone" class="primary-id-zone buyer"
                             ondrop="dropPrimaryId(event, 'buyer')"
                             ondragover="allowDrop(event)"
                             ondragenter="dragEnterPrimaryId(event)"
                             ondragleave="dragLeavePrimaryId(event)">
                            <div class="primary-id-zone-header">
                                <div class="primary-id-zone-icon">
                                    <i class="fas fa-key"></i>
                                </div>
                                <span class="primary-id-zone-title">Customer ID</span>
                                <span class="primary-id-zone-required">Required</span>
                            </div>
                            <div id="customerIdContent">
                                <!-- Will be rendered by JS: empty state or assigned feature -->
                            </div>
                        </div>

                        <!-- Context Features Section -->
                        <div id="buyerAdditionalSection" class="additional-features-section buyer locked"
                             ondrop="dropFeature(event, 'buyer')"
                             ondragover="allowDropIfUnlocked(event, 'buyer')"
                             ondragenter="dragEnterIfUnlocked(event, 'buyer')"
                             ondragleave="dragLeave(event)">
                            <div class="additional-features-header">
                                <i class="fas fa-layer-group"></i>
                                <span>Context Features</span>
                            </div>
                            <div id="buyerLockedMessage" class="locked-message">
                                <i class="fas fa-lock"></i>
                                <span>Assign Customer ID first to add more features</span>
                            </div>
                            <div id="buyerModelFeatures"></div>
                            <div id="buyerModelCrosses" class="mt-3"></div>
                            <button type="button" class="btn btn-secondary btn-xs mt-2" onclick="openCrossModal('buyer')" id="addBuyerCrossBtn" style="display: none;">
                                <i class="fas fa-plus mr-1"></i>Add Cross Feature
                            </button>
                        </div>
                    </div>

                    <!-- Product Model -->
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                            <span class="w-3 h-3 rounded-full bg-green-500"></span>
                            <h5 class="font-semibold text-gray-800">ProductModel (Candidate Tower)</h5>
                        </div>

                        <!-- Primary ID Zone: Product ID -->
                        <div id="productIdZone" class="primary-id-zone product"
                             ondrop="dropPrimaryId(event, 'product')"
                             ondragover="allowDrop(event)"
                             ondragenter="dragEnterPrimaryId(event)"
                             ondragleave="dragLeavePrimaryId(event)">
                            <div class="primary-id-zone-header">
                                <div class="primary-id-zone-icon">
                                    <i class="fas fa-key"></i>
                                </div>
                                <span class="primary-id-zone-title">Product ID</span>
                                <span class="primary-id-zone-required">Required</span>
                            </div>
                            <div id="productIdContent">
                                <!-- Will be rendered by JS: empty state or assigned feature -->
                            </div>
                        </div>

                        <!-- Context Features Section -->
                        <div id="productAdditionalSection" class="additional-features-section product locked"
                             ondrop="dropFeature(event, 'product')"
                             ondragover="allowDropIfUnlocked(event, 'product')"
                             ondragenter="dragEnterIfUnlocked(event, 'product')"
                             ondragleave="dragLeave(event)">
                            <div class="additional-features-header">
                                <i class="fas fa-layer-group"></i>
                                <span>Context Features</span>
                            </div>
                            <div id="productLockedMessage" class="locked-message">
                                <i class="fas fa-lock"></i>
                                <span>Assign Product ID first to add more features</span>
                            </div>
                            <div id="productModelFeatures"></div>
                            <div id="productModelCrosses" class="mt-3"></div>
                            <button type="button" class="btn btn-secondary btn-xs mt-2" onclick="openCrossModal('product')" id="addProductCrossBtn" style="display: none;">
                                <i class="fas fa-plus mr-1"></i>Add Cross Feature
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tensor Preview -->
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <div class="tensor-preview-panel">
                        <div class="tensor-preview-header">
                            <span class="tensor-preview-title">Buyer Tensor</span>
                            <span id="buyerTensorTotal" class="tensor-preview-total buyer">0D</span>
                        </div>
                        <div id="buyerTensorBar" class="tensor-breakdown-bar"></div>
                        <div id="buyerTensorBreakdown" class="tensor-breakdown"></div>
                    </div>
                    <div class="tensor-preview-panel">
                        <div class="tensor-preview-header">
                            <span class="tensor-preview-title">Product Tensor</span>
                            <span id="productTensorTotal" class="tensor-preview-total product">0D</span>
                        </div>
                        <div id="productTensorBar" class="tensor-breakdown-bar"></div>
                        <div id="productTensorBreakdown" class="tensor-breakdown"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="modal-footer-wizard-neu">
            <div class="footer-left">
                <button type="button" id="backBtn" class="btn-neu btn-neu-nav hidden" onclick="prevStep()">
                    <span class="btn-neu-inner"><i class="fas fa-chevron-left"></i></span>
                </button>
                <button type="button" id="nextBtn" class="btn-neu btn-neu-nav" onclick="nextStep()">
                    <span class="btn-neu-inner"><i class="fas fa-chevron-right"></i></span>
                </button>
            </div>
            <div class="footer-right">
                <button type="button" id="saveBtn" class="btn-neu btn-neu-action btn-neu-save hidden" onclick="saveConfig()">
                    <span class="btn-neu-inner">Save</span>
                </button>
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeWizard()">
                    <span class="btn-neu-inner">Cancel</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Feature Configuration Modal -->
<div id="featureConfigModal" class="modal-overlay hidden">
    <div class="modal-container" style="max-width: 500px;">
        <div class="modal-header">
            <div class="modal-header-icon info">
                <i class="fas fa-cog"></i>
            </div>
            <h3 class="modal-header-title" id="featureModalTitle">Configure Feature</h3>
            <button type="button" class="modal-close-btn" onclick="closeFeatureModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" id="featureModalBody">
            <!-- Content will be dynamically generated -->
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-save" onclick="applyFeatureConfig()">
                    <span class="btn-neu-inner">Apply</span>
                </button>
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeFeatureModal()">
                    <span class="btn-neu-inner">Cancel</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Cross Feature Modal -->
<div id="crossFeatureModal" class="modal-overlay hidden">
    <div class="modal-container" style="max-width: 500px;">
        <div class="modal-header">
            <div class="modal-header-icon info">
                <i class="fas fa-times"></i>
            </div>
            <h3 class="modal-header-title">Add Cross Feature</h3>
            <button type="button" class="modal-close-btn" onclick="closeCrossModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="modal-form-group">
                <label class="modal-form-label">Select 2-3 features to cross</label>
                <div id="crossFeatureOptions" class="space-y-2">
                    <!-- Feature checkboxes will be inserted here -->
                </div>
            </div>
            <div id="crossPreview" class="text-sm text-gray-600 mt-3 hidden">
                Selected: <span id="crossPreviewText" class="font-medium"></span>
            </div>
            <!-- Bucketization options for numeric/temporal features -->
            <div id="crossBucketOptions" class="mt-4 hidden">
                <div class="text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-info-circle text-blue-500 mr-1"></i>
                    Numeric/temporal features need bucketization for crossing
                </div>
                <div id="crossBucketInputs" class="space-y-3">
                    <!-- Bucket inputs for each numeric/temporal feature will be inserted here -->
                </div>
            </div>
            <div class="modal-form-group mt-4">
                <label class="modal-form-label">Hash Bucket Size</label>
                <select id="crossHashBuckets" class="form-select w-full">
                    <option value="1000">1,000</option>
                    <option value="5000" selected>5,000</option>
                    <option value="10000">10,000</option>
                    <option value="50000">50,000</option>
                </select>
                <p class="modal-form-hint">Number of hash buckets for the crossed features</p>
            </div>
            <div class="modal-form-group">
                <label class="modal-form-label">Embedding Dimension</label>
                <select id="crossEmbedDim" class="form-select w-full">
                    <option value="8">8</option>
                    <option value="16" selected>16</option>
                    <option value="32">32</option>
                </select>
            </div>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-save" onclick="addCrossFeature()">
                    <span class="btn-neu-inner">Add Cross</span>
                </button>
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeCrossModal()">
                    <span class="btn-neu-inner">Cancel</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View Config Modal -->
<div id="viewConfigModal" class="modal-overlay hidden">
    <div class="modal-container" style="max-width: 880px;">
        <div class="modal-header">
            <div class="modal-header-icon info">
                <i class="fas fa-eye"></i>
            </div>
            <h3 class="modal-header-title" id="viewConfigTitle">Feature Config Details</h3>
        </div>
        <div class="modal-body" id="viewConfigBody" style="max-height: 70vh; overflow-y: auto;">
            <!-- Content will be dynamically generated -->
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeViewModal()">
                    <span class="btn-neu-inner">Close</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Clone Config Modal -->
<div id="cloneConfigModal" class="modal-overlay hidden">
    <div class="modal-container" style="max-width: 450px;">
        <div class="modal-header">
            <div class="modal-header-icon info">
                <i class="fas fa-copy"></i>
            </div>
            <h3 class="modal-header-title">Clone Feature Config</h3>
        </div>
        <div class="modal-body">
            <div class="mb-4">
                <label for="cloneConfigName" class="block text-sm font-medium text-gray-700 mb-2">
                    New config name
                </label>
                <input type="text" id="cloneConfigName"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                       placeholder="Enter name for cloned config">
            </div>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-save" onclick="submitClone()">
                    <span class="btn-neu-inner">Clone</span>
                </button>
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeCloneModal()">
                    <span class="btn-neu-inner">Cancel</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Compare Feature Sets Modal -->
<div id="compareModal" class="modal-overlay hidden">
    <div class="modal-container" style="max-width: 1000px;">
        <div class="modal-header">
            <div class="modal-header-icon info">
                <i class="fas fa-columns"></i>
            </div>
            <h3 class="modal-header-title">Compare Feature Sets</h3>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <!-- Dropdowns row -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Left Feature Set</label>
                    <select id="compareLeftSelect" onchange="onCompareSelectChange('left')"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select feature set...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Right Feature Set</label>
                    <select id="compareRightSelect" onchange="onCompareSelectChange('right')"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select feature set...</option>
                    </select>
                </div>
            </div>

            <!-- Comparison content - table layout for aligned rows -->
            <div class="border border-gray-200 rounded-lg overflow-hidden bg-white">
                <table class="w-full compare-table" id="compareTable">
                    <colgroup>
                        <col style="width: 50%">
                        <col style="width: 50%">
                    </colgroup>
                    <tbody id="compareTableBody">
                        <!-- Header row -->
                        <tr class="compare-row-header">
                            <td id="compareLeftHeader" class="p-4 align-top border-r border-gray-200 border-b">
                                <div class="flex items-center justify-center h-full text-gray-400 py-4">
                                    <span>Select a feature set</span>
                                </div>
                            </td>
                            <td id="compareRightHeader" class="p-4 align-top border-b">
                                <div class="flex items-center justify-center h-full text-gray-400 py-4">
                                    <span>Select a feature set</span>
                                </div>
                            </td>
                        </tr>
                        <!-- Source row -->
                        <tr class="compare-row-source hidden">
                            <td id="compareLeftSource" class="p-4 align-top border-r border-gray-200 border-b"></td>
                            <td id="compareRightSource" class="p-4 align-top border-b"></td>
                        </tr>
                        <!-- Buyer Tensor row -->
                        <tr class="compare-row-buyer hidden">
                            <td id="compareLeftBuyer" class="p-4 align-top border-r border-gray-200 border-b"></td>
                            <td id="compareRightBuyer" class="p-4 align-top border-b"></td>
                        </tr>
                        <!-- Product Tensor row -->
                        <tr class="compare-row-product hidden">
                            <td id="compareLeftProduct" class="p-4 align-top border-r border-gray-200"></td>
                            <td id="compareRightProduct" class="p-4 align-top"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeCompareModal()">
                    <span class="btn-neu-inner">Close</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Transform Code Viewer Modal -->
<div id="transformCodeViewerModal" class="modal-overlay hidden">
    <div class="modal-container" style="max-width: 900px;">
        <div class="modal-header">
            <div class="modal-header-icon info">
                <i class="fas fa-random"></i>
            </div>
            <h3 class="modal-header-title">Transform Code</h3>
            <button type="button" class="modal-close-btn" onclick="closeTransformCodeViewer()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" style="max-height: 75vh; overflow-y: auto;">
            <!-- Meta info -->
            <div class="code-meta">
                <div class="code-meta-item">
                    <i class="fas fa-clock"></i>
                    <span id="transformCodeGeneratedAt">-</span>
                </div>
                <div class="code-meta-item">
                    <i class="fas fa-sync-alt"></i>
                    <button onclick="regenerateTransformCode()" class="text-blue-600 hover:text-blue-800 font-medium">
                        Regenerate
                    </button>
                </div>
            </div>

            <!-- Transform Code Content -->
            <div id="transformValidationError" class="validation-error-banner" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                <div class="error-text">
                    <span id="transformErrorMsg"></span>
                    <span id="transformErrorLine" class="error-line"></span>
                </div>
            </div>
            <div class="code-container">
                <div class="code-header">
                    <span class="code-filename">preprocessing_fn.py</span>
                    <span id="transformValidationBadge" class="validation-badge checking">
                        <i class="fas fa-spinner fa-spin"></i> Checking
                    </span>
                    <span class="tab-badge" id="transformLineCount">-</span>
                    <div class="code-actions">
                        <button class="code-action-btn" onclick="copyCode('transform')" id="copyTransformBtn">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                        <button class="code-action-btn" onclick="downloadCode('transform')">
                            <i class="fas fa-download"></i> Download
                        </button>
                    </div>
                </div>
                <div class="code-block">
                    <pre id="transformCode"></pre>
                </div>
            </div>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left">
                <span class="text-sm text-gray-500" id="transformCodeConfigName"></span>
            </div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeTransformCodeViewer()">
                    <span class="btn-neu-inner">Close</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Trainer Code Viewer Modal -->
<div id="trainerCodeViewerModal" class="modal-overlay hidden">
    <div class="modal-container" style="max-width: 900px;">
        <div class="modal-header">
            <div class="modal-header-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);">
                <i class="fas fa-brain"></i>
            </div>
            <h3 class="modal-header-title">Trainer Code</h3>
            <button type="button" class="modal-close-btn" onclick="closeTrainerCodeViewer()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" style="max-height: 75vh; overflow-y: auto;">
            <!-- Meta info -->
            <div class="code-meta">
                <div class="code-meta-item">
                    <i class="fas fa-clock"></i>
                    <span id="trainerCodeGeneratedAt">-</span>
                </div>
                <div class="code-meta-item">
                    <i class="fas fa-sync-alt"></i>
                    <button onclick="regenerateTrainerCode()" class="text-blue-600 hover:text-blue-800 font-medium">
                        Regenerate
                    </button>
                </div>
            </div>

            <!-- Trainer Code Content -->
            <div id="trainerValidationError" class="validation-error-banner" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                <div class="error-text">
                    <span id="trainerErrorMsg"></span>
                    <span id="trainerErrorLine" class="error-line"></span>
                </div>
            </div>
            <div class="code-container">
                <div class="code-header">
                    <span class="code-filename">trainer_module.py</span>
                    <span id="trainerValidationBadge" class="validation-badge checking">
                        <i class="fas fa-spinner fa-spin"></i> Checking
                    </span>
                    <span class="tab-badge" id="trainerLineCount">-</span>
                    <div class="code-actions">
                        <button class="code-action-btn" onclick="copyCode('trainer')" id="copyTrainerBtn">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                        <button class="code-action-btn" onclick="downloadCode('trainer')">
                            <i class="fas fa-download"></i> Download
                        </button>
                    </div>
                </div>
                <div class="code-block">
                    <pre id="trainerCode"></pre>
                </div>
            </div>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left">
                <span class="text-sm text-gray-500" id="trainerCodeConfigName"></span>
            </div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeTrainerCodeViewer()">
                    <span class="btn-neu-inner">Close</span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
const modelId = {{ model.id }};
let allConfigs = [];
let allDatasets = [];
let currentStep = 1;
let editingConfigId = null;
let searchTimeout = null;
let isLoadingConfigForEdit = false;
let configNameCheckTimeout = null;
let configNameIsValid = false;

// Current feature config state
let configState = {
    name: '',
    description: '',
    datasetId: null,
    startFrom: 'blank',
    cloneFromId: null,
    // Primary ID features (required before adding other features)
    customerIdFeature: null,  // Primary ID for BuyerModel
    productIdFeature: null,   // Primary ID for ProductModel
    // Additional features (unlocked after primary ID is set)
    buyerFeatures: [],
    productFeatures: [],
    buyerCrosses: [],
    productCrosses: [],
    availableColumns: [],
    sampleRows: [],
    columnOrder: []
};

// Currently editing feature
let editingFeature = null;
let editingFeatureModel = null;
let crossFeatureModel = null;

// =============================================================================
// CSRF TOKEN HELPER
// =============================================================================

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// =============================================================================
// INITIALIZATION
// =============================================================================

document.addEventListener('DOMContentLoaded', function() {
    loadDatasets();
    loadConfigs();
    loadModelConfigs();
});

function loadDatasets() {
    fetch(`/api/models/${modelId}/configs/datasets/`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                allDatasets = data.data;
                populateDatasetFilters();
            }
        })
        .catch(err => console.error('Error loading datasets:', err));
}

function loadConfigs() {
    document.getElementById('configsLoading').classList.remove('hidden');
    document.getElementById('configsEmpty').classList.add('hidden');

    const datasetId = document.getElementById('datasetFilter').value;

    let url = `/api/models/${modelId}/feature-configs/?`;
    if (datasetId) url += `dataset_id=${datasetId}&`;

    fetch(url)
        .then(r => r.json())
        .then(data => {
            document.getElementById('configsLoading').classList.add('hidden');
            if (data.success) {
                allConfigs = data.data;
                renderConfigs();
            } else {
                showError(data.error || 'Failed to load configs');
            }
        })
        .catch(err => {
            document.getElementById('configsLoading').classList.add('hidden');
            console.error('Error loading configs:', err);
            showError('Failed to load feature configs');
        });
}

function populateDatasetFilters() {
    const filterSelect = document.getElementById('datasetFilter');
    const wizardSelect = document.getElementById('configDataset');

    // Clear existing options (except first)
    filterSelect.innerHTML = '<option value="">All Datasets</option>';
    wizardSelect.innerHTML = '<option value="">Select a dataset...</option>';

    allDatasets.forEach(ds => {
        const opt1 = document.createElement('option');
        opt1.value = ds.id;
        opt1.textContent = ds.name;
        filterSelect.appendChild(opt1);

        const opt2 = document.createElement('option');
        opt2.value = ds.id;
        opt2.textContent = ds.name;
        wizardSelect.appendChild(opt2);
    });
}

// =============================================================================
// RENDER CONFIGS LIST
// =============================================================================

function renderConfigs() {
    const container = document.getElementById('configsList');
    const emptyState = document.getElementById('configsEmpty');
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();

    // Filter by search
    let filtered = allConfigs;
    if (searchTerm) {
        filtered = allConfigs.filter(c =>
            c.name.toLowerCase().includes(searchTerm) ||
            (c.description && c.description.toLowerCase().includes(searchTerm))
        );
    }

    // Remove old cards
    container.querySelectorAll('.config-card').forEach(el => el.remove());

    if (filtered.length === 0) {
        emptyState.classList.remove('hidden');
        return;
    }

    emptyState.classList.add('hidden');

    filtered.forEach(config => {
        const card = createConfigCard(config);
        container.appendChild(card);
    });
}

function createConfigCard(config) {
    const card = document.createElement('div');
    card.className = 'config-card bg-white border border-gray-200 rounded-lg p-4 hover:border-gray-300';

    // Calculate tensor breakdowns from feature arrays
    const buyerResult = calculateTensorBreakdown(
        config.buyer_model_features || [],
        config.buyer_model_crosses || []
    );
    const productResult = calculateTensorBreakdown(
        config.product_model_features || [],
        config.product_model_crosses || []
    );

    const buyerDim = buyerResult.total || config.buyer_tensor_dim || 0;
    const productDim = productResult.total || config.product_tensor_dim || 0;

    const leakageWarning = config.columns_in_both_models && config.columns_in_both_models.length > 0
        ? `<span class="leakage-warning"><i class="fas fa-exclamation-triangle"></i>${config.columns_in_both_models.length} shared</span>`
        : '';

    const cardId = `config-${config.id}`;

    card.innerHTML = `
        <div class="flex items-start justify-between mb-2">
            <div class="flex items-center gap-2">
                <h3 class="font-semibold text-gray-900">${escapeHtml(config.name)}</h3>
                ${leakageWarning}
            </div>
            <div class="flex items-center gap-2">
                <button onclick="viewConfig(${config.id})" class="card-action-btn view" title="View feature set">
                    View
                </button>
                <button onclick="editConfig(${config.id})" class="card-action-btn edit" title="Edit feature set">
                    <i class="fas fa-external-link-alt"></i>
                </button>
                <button onclick="deleteConfig(${config.id}, '${escapeHtml(config.name)}')" class="card-action-btn delete" title="Delete feature set">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        <div class="flex items-center gap-3 text-xs text-gray-500 mb-2">
            <span>Dataset: ${escapeHtml(config.dataset_name)}</span>
            <span>Set version: ${config.version}</span>
            <span>Updated ${formatTimeAgo(config.updated_at)}${config.created_by ? ` by ${config.created_by}` : ''}</span>
        </div>
        ${config.description ? `<p class="text-sm text-gray-600 mb-3">${escapeHtml(config.description.length > 80 ? config.description.substring(0, 80) + '...' : config.description)}</p>` : ''}

        <div class="grid grid-cols-2 gap-4 mb-3">
            <div>
                <div class="flex items-center justify-between text-xs mb-1">
                    <span class="text-gray-500">Buyer Tensor</span>
                    <span class="font-semibold text-blue-600">${buyerDim}D</span>
                </div>
                <div id="${cardId}-buyer-bar" class="tensor-breakdown-bar"></div>
                <div class="text-xs text-gray-400 mt-1">${config.buyer_features_count || 0} features, ${config.buyer_crosses_count || 0} crosses</div>
            </div>
            <div>
                <div class="flex items-center justify-between text-xs mb-1">
                    <span class="text-gray-500">Product Tensor</span>
                    <span class="font-semibold text-green-600">${productDim}D</span>
                </div>
                <div id="${cardId}-product-bar" class="tensor-breakdown-bar"></div>
                <div class="text-xs text-gray-400 mt-1">${config.product_features_count || 0} features, ${config.product_crosses_count || 0} crosses</div>
            </div>
        </div>

        <div class="flex items-center gap-2 mt-3 pt-3 border-t border-gray-100">
            <button onclick="cloneConfig(${config.id})" class="btn btn-secondary btn-sm" style="width: 150px;">
                <i class="fas fa-copy"></i>Clone
            </button>
            <button onclick="viewTransformCode(${config.id}, '${escapeHtml(config.name)}')" class="btn btn-secondary btn-sm" style="width: 150px;" title="View generated TFX code">
                <i class="fas fa-code"></i>Code
            </button>
        </div>
    `;

    // Render tensor visualizations after card is in DOM (bars only, no breakdown tags)
    // Use maxTotal for proportional bar widths
    const maxTotal = Math.max(buyerResult.total || 0, productResult.total || 0);

    setTimeout(() => {
        const buyerBar = document.getElementById(`${cardId}-buyer-bar`);
        const productBar = document.getElementById(`${cardId}-product-bar`);

        if (buyerBar && buyerResult.breakdown.length > 0) {
            renderTensorPreview('buyer', buyerResult.total, buyerResult.breakdown, buyerBar, null, maxTotal);
        }
        if (productBar && productResult.breakdown.length > 0) {
            renderTensorPreview('product', productResult.total, productResult.breakdown, productBar, null, maxTotal);
        }
    }, 0);

    return card;
}

// =============================================================================
// WIZARD FUNCTIONS
// =============================================================================

function openWizard(configId = null) {
    editingConfigId = configId;
    currentStep = 1;

    // Reset state
    configState = {
        name: '',
        description: '',
        datasetId: null,
        startFrom: 'blank',
        cloneFromId: null,
        customerIdFeature: null,
        productIdFeature: null,
        buyerFeatures: [],
        productFeatures: [],
        buyerCrosses: [],
        productCrosses: [],
        availableColumns: [],
        sampleRows: [],
        columnOrder: []
    };

    // Reset form
    document.getElementById('configName').value = '';
    document.getElementById('configDescription').value = '';
    document.getElementById('configDataset').value = '';
    document.getElementById('datasetInfo').classList.add('hidden');
    document.querySelector('input[name="startFrom"][value="blank"]').checked = true;
    document.getElementById('cloneSelection').classList.add('hidden');

    // Reset name validation state
    configNameIsValid = false;
    resetConfigNameValidation();

    // Update UI
    document.getElementById('wizardTitle').textContent = configId ? 'Edit Feature Config' : 'Create Feature Config';
    updateWizardStep();

    // Show modal
    document.getElementById('featureConfigWizardModal').classList.remove('hidden');

    // If editing, load config data
    if (configId) {
        loadConfigForEdit(configId);
    }
}

function closeWizard() {
    document.getElementById('featureConfigWizardModal').classList.add('hidden');
    editingConfigId = null;
}

function loadConfigForEdit(configId) {
    isLoadingConfigForEdit = true;
    updateEditLoadingState();

    fetch(`/api/feature-configs/${configId}/`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const config = data.data;
                document.getElementById('configName').value = config.name;
                document.getElementById('configDescription').value = config.description || '';
                document.getElementById('configDataset').value = config.dataset_id;

                configState.name = config.name;
                configState.description = config.description || '';
                configState.datasetId = config.dataset_id;

                // Extract primary ID features from the features arrays
                // Assume first feature with is_primary_id flag is the primary ID
                const buyerFeatures = config.buyer_model_features || [];
                const productFeatures = config.product_model_features || [];

                // Find and extract primary ID features
                const buyerPrimaryIdx = buyerFeatures.findIndex(f => f.is_primary_id);
                if (buyerPrimaryIdx !== -1) {
                    configState.customerIdFeature = buyerFeatures[buyerPrimaryIdx];
                    configState.buyerFeatures = buyerFeatures.filter((_, idx) => idx !== buyerPrimaryIdx);
                } else {
                    configState.buyerFeatures = buyerFeatures;
                }

                const productPrimaryIdx = productFeatures.findIndex(f => f.is_primary_id);
                if (productPrimaryIdx !== -1) {
                    configState.productIdFeature = productFeatures[productPrimaryIdx];
                    configState.productFeatures = productFeatures.filter((_, idx) => idx !== productPrimaryIdx);
                } else {
                    configState.productFeatures = productFeatures;
                }

                configState.buyerCrosses = config.buyer_model_crosses || [];
                configState.productCrosses = config.product_model_crosses || [];

                // Mark name as valid since we're editing an existing config
                configNameIsValid = true;

                onDatasetChange();
            }
        })
        .finally(() => {
            isLoadingConfigForEdit = false;
            updateEditLoadingState();
        });
}

function showWizardLoading(show, text = 'Loading...') {
    const loadingOverlay = document.getElementById('wizardLoadingOverlay');
    const loadingText = document.getElementById('wizardLoadingText');
    const nextBtn = document.getElementById('nextBtn');
    const saveBtn = document.getElementById('saveBtn');

    if (loadingOverlay) {
        loadingOverlay.style.display = show ? 'block' : 'none';
    }
    if (loadingText) {
        loadingText.textContent = text;
    }
    if (nextBtn) {
        nextBtn.disabled = show;
        nextBtn.style.opacity = show ? '0.5' : '1';
    }
    if (saveBtn) {
        saveBtn.disabled = show;
        saveBtn.style.opacity = show ? '0.5' : '1';
    }
}

function updateEditLoadingState() {
    showWizardLoading(isLoadingConfigForEdit, 'Loading config data...');
}

function updateWizardStep() {
    // Update step visibility
    document.getElementById('wizardStep1').classList.toggle('hidden', currentStep !== 1);
    document.getElementById('wizardStep1').classList.toggle('active', currentStep === 1);
    document.getElementById('wizardStep2').classList.toggle('hidden', currentStep !== 2);
    document.getElementById('wizardStep2').classList.toggle('active', currentStep === 2);

    // Update progress pills - use completed/current/future classes
    for (let i = 1; i <= 2; i++) {
        const pill = document.getElementById(`progress${i}`);
        pill.classList.remove('current', 'completed', 'future');
        if (i < currentStep) {
            pill.classList.add('completed');
        } else if (i === currentStep) {
            pill.classList.add('current');
        } else {
            pill.classList.add('future');
        }
    }

    // Update buttons
    document.getElementById('backBtn').classList.toggle('hidden', currentStep === 1);
    document.getElementById('nextBtn').classList.toggle('hidden', currentStep === 2);
    document.getElementById('saveBtn').classList.toggle('hidden', currentStep !== 2);

    // Update step counter
    document.getElementById('currentStep').textContent = currentStep;
}

function nextStep() {
    // Block navigation while loading config data
    if (isLoadingConfigForEdit) {
        return;
    }

    if (currentStep === 1) {
        // Validate step 1
        const name = document.getElementById('configName').value.trim();
        const datasetId = document.getElementById('configDataset').value;

        if (!name) {
            document.getElementById('nameError').textContent = 'Name is required';
            document.getElementById('nameError').classList.remove('hidden');
            document.getElementById('configName').classList.add('border-red-500');
            return;
        }
        if (!datasetId) {
            showError('Please select a dataset');
            return;
        }
        // Check if name validation has been performed and is valid
        if (!configNameIsValid) {
            // Trigger validation if not done yet
            checkConfigNameAvailability();
            // Show error message
            document.getElementById('nameError').textContent = 'Please wait for name validation or choose a different name';
            document.getElementById('nameError').classList.remove('hidden');
            return;
        }

        configState.name = name;
        configState.description = document.getElementById('configDescription').value.trim();
        configState.datasetId = parseInt(datasetId);
        configState.startFrom = document.querySelector('input[name="startFrom"]:checked').value;

        // Load columns and initialize step 2
        loadColumnsForStep2();

        currentStep = 2;
        updateWizardStep();
    }
}

function prevStep() {
    if (currentStep > 1) {
        currentStep--;
        updateWizardStep();
    }
}

function validateConfigName() {
    document.getElementById('nameError').classList.add('hidden');
}

// Reset Feature Config name validation UI
function resetConfigNameValidation() {
    document.getElementById('configNameStatus').classList.add('hidden');
    document.getElementById('configNameSpinner').classList.add('hidden');
    document.getElementById('configNameValid').classList.add('hidden');
    document.getElementById('configNameInvalid').classList.add('hidden');
    document.getElementById('nameError').classList.add('hidden');
    document.getElementById('nameError').textContent = '';
    document.getElementById('configName').classList.remove('border-red-500', 'border-green-500');
}

// Debounced Feature Config name check
function debounceConfigNameCheck() {
    clearTimeout(configNameCheckTimeout);
    // Reset validation state while typing
    configNameIsValid = false;
    configNameCheckTimeout = setTimeout(() => {
        checkConfigNameAvailability();
    }, 400);
}

// Check Feature Config name availability
function checkConfigNameAvailability() {
    const name = document.getElementById('configName').value.trim();
    const datasetId = document.getElementById('configDataset').value;
    const statusEl = document.getElementById('configNameStatus');
    const spinnerEl = document.getElementById('configNameSpinner');
    const validEl = document.getElementById('configNameValid');
    const invalidEl = document.getElementById('configNameInvalid');
    const errorEl = document.getElementById('nameError');
    const inputEl = document.getElementById('configName');

    // Reset state
    statusEl.classList.add('hidden');
    spinnerEl.classList.add('hidden');
    validEl.classList.add('hidden');
    invalidEl.classList.add('hidden');
    errorEl.classList.add('hidden');
    inputEl.classList.remove('border-red-500', 'border-green-500');

    if (!name) {
        configNameIsValid = false;
        return;
    }

    if (!datasetId) {
        // Can't validate without dataset - mark as pending
        configNameIsValid = false;
        return;
    }

    // Show spinner
    statusEl.classList.remove('hidden');
    spinnerEl.classList.remove('hidden');

    // Build URL with query params
    let url = `/api/feature-configs/check-name/?name=${encodeURIComponent(name)}&dataset_id=${datasetId}`;
    if (editingConfigId) {
        url += `&exclude_id=${editingConfigId}`;
    }

    fetch(url)
        .then(r => r.json())
        .then(data => {
            spinnerEl.classList.add('hidden');

            if (data.success && data.data.available) {
                // Name is available
                configNameIsValid = true;
                validEl.classList.remove('hidden');
                inputEl.classList.add('border-green-500');
            } else {
                // Name is taken
                configNameIsValid = false;
                invalidEl.classList.remove('hidden');
                inputEl.classList.add('border-red-500');
                errorEl.textContent = data.data?.message || 'This name is already taken for this dataset';
                errorEl.classList.remove('hidden');
            }
        })
        .catch(err => {
            console.error('Error checking name:', err);
            spinnerEl.classList.add('hidden');
            configNameIsValid = false;
        });
}

function onDatasetChange() {
    const datasetId = document.getElementById('configDataset').value;
    const datasetInfo = document.getElementById('datasetInfo');

    if (datasetId) {
        const dataset = allDatasets.find(d => d.id == datasetId);
        if (dataset) {
            const rowsText = dataset.total_rows != null
                ? dataset.total_rows.toLocaleString() + ' rows'
                : 'Unknown rows';
            const colsText = dataset.column_count != null
                ? dataset.column_count + ' columns'
                : '? columns';
            document.getElementById('datasetInfoText').textContent = `${rowsText} | ${colsText}`;
            datasetInfo.classList.remove('hidden');
        }
        loadCloneOptions(datasetId);
        // Re-check name availability when dataset changes (name uniqueness is per dataset)
        const name = document.getElementById('configName').value.trim();
        if (name) {
            configNameIsValid = false;
            checkConfigNameAvailability();
        }
    } else {
        datasetInfo.classList.add('hidden');
        // Reset name validation when no dataset selected
        configNameIsValid = false;
        resetConfigNameValidation();
    }
}

function onStartFromChange() {
    const startFrom = document.querySelector('input[name="startFrom"]:checked').value;
    document.getElementById('cloneSelection').classList.toggle('hidden', startFrom !== 'clone');
}

function loadCloneOptions(datasetId) {
    const select = document.getElementById('cloneFromConfig');
    select.innerHTML = '<option value="">Select a config to clone...</option>';

    allConfigs.filter(c => c.dataset_id == datasetId).forEach(config => {
        const opt = document.createElement('option');
        opt.value = config.id;
        opt.textContent = `${config.name} (${config.buyer_tensor_dim || 0}D + ${config.product_tensor_dim || 0}D)`;
        select.appendChild(opt);
    });
}

// =============================================================================
// STEP 2: FEATURE ASSIGNMENT
// =============================================================================

function showStep2Loading(show) {
    showWizardLoading(show, 'Loading feature data...');
}

function loadColumnsForStep2() {
    const datasetId = configState.datasetId;
    const startFrom = configState.startFrom;

    // Show loading spinner
    showStep2Loading(true);

    // Use new schema-with-sample endpoint for accurate types and sample data
    fetch(`/api/datasets/${datasetId}/schema-with-sample/`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                configState.availableColumns = data.data.columns;
                configState.sampleRows = data.data.sample_rows || [];
                configState.columnOrder = data.data.column_order || [];

                // Handle start from options
                if (startFrom === 'clone') {
                    const cloneFromId = document.getElementById('cloneFromConfig').value;
                    if (cloneFromId) {
                        loadCloneData(cloneFromId);
                    } else {
                        renderStep2();
                        showStep2Loading(false);
                    }
                } else {
                    renderStep2();
                    showStep2Loading(false);
                }
            } else {
                console.error('Failed to load schema:', data.error);
                showError('Failed to load column schema');
                showStep2Loading(false);
            }
        })
        .catch(err => {
            console.error('Error loading schema:', err);
            showError('Error loading column schema');
            showStep2Loading(false);
        });
}

function loadCloneData(configId) {
    fetch(`/api/feature-configs/${configId}/`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const buyerFeatures = data.data.buyer_model_features || [];
                const productFeatures = data.data.product_model_features || [];

                // Find and extract primary ID features
                const buyerPrimaryIdx = buyerFeatures.findIndex(f => f.is_primary_id);
                if (buyerPrimaryIdx !== -1) {
                    configState.customerIdFeature = buyerFeatures[buyerPrimaryIdx];
                    configState.buyerFeatures = buyerFeatures.filter((_, idx) => idx !== buyerPrimaryIdx);
                } else {
                    configState.buyerFeatures = buyerFeatures;
                }

                const productPrimaryIdx = productFeatures.findIndex(f => f.is_primary_id);
                if (productPrimaryIdx !== -1) {
                    configState.productIdFeature = productFeatures[productPrimaryIdx];
                    configState.productFeatures = productFeatures.filter((_, idx) => idx !== productPrimaryIdx);
                } else {
                    configState.productFeatures = productFeatures;
                }

                configState.buyerCrosses = data.data.buyer_model_crosses || [];
                configState.productCrosses = data.data.product_model_crosses || [];
                renderStep2();
                showStep2Loading(false);
            } else {
                showStep2Loading(false);
            }
        })
        .catch(err => {
            console.error('Error loading clone data:', err);
            showStep2Loading(false);
        });
}

function renderStep2() {
    renderAvailableColumns();
    renderSampleTable();
    renderPrimaryIdZone('buyer');
    renderPrimaryIdZone('product');
    renderAssignedFeatures('buyer');
    renderAssignedFeatures('product');
    updateAdditionalFeaturesLockState();
    updateTensorPreview();
    updateSubchapterStatuses();
}

// Render the primary ID zone (Customer ID or Product ID)
function renderPrimaryIdZone(model) {
    const idFeature = model === 'buyer' ? configState.customerIdFeature : configState.productIdFeature;
    const contentContainer = document.getElementById(model === 'buyer' ? 'customerIdContent' : 'productIdContent');
    const idLabel = model === 'buyer' ? 'Customer ID' : 'Product ID';

    if (!idFeature) {
        // Empty state - show drop prompt
        contentContainer.innerHTML = `
            <div class="primary-id-zone-empty">
                <i class="fas fa-arrow-down"></i>
                <span>Drag a column here to set as ${idLabel}</span>
            </div>
        `;
    } else {
        // Assigned state - show the feature card
        const embedDim = idFeature.transforms?.embedding?.embedding_dim || 32;
        contentContainer.innerHTML = `
            <div class="primary-id-assigned">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <div class="font-medium text-sm">${escapeHtml(idFeature.column)}</div>
                        <div class="text-xs text-gray-500">
                            ${idFeature.bq_type || 'STRING'}  Text  Embed: ${embedDim}D
                        </div>
                    </div>
                    <div class="flex flex-col gap-1 ml-2">
                        <button type="button" class="feature-config-btn settings" onclick="openPrimaryIdConfig('${model}')" title="Configure embedding">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button type="button" class="feature-config-btn remove" onclick="removePrimaryId('${model}')" title="Remove">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
}

// Update lock state of additional features sections
function updateAdditionalFeaturesLockState() {
    const buyerSection = document.getElementById('buyerAdditionalSection');
    const productSection = document.getElementById('productAdditionalSection');
    const buyerLockedMsg = document.getElementById('buyerLockedMessage');
    const productLockedMsg = document.getElementById('productLockedMessage');

    // Buyer model: unlocked if customerIdFeature is set
    if (configState.customerIdFeature) {
        buyerSection.classList.remove('locked');
        buyerLockedMsg.style.display = 'none';
    } else {
        buyerSection.classList.add('locked');
        buyerLockedMsg.style.display = 'flex';
    }

    // Product model: unlocked if productIdFeature is set
    if (configState.productIdFeature) {
        productSection.classList.remove('locked');
        productLockedMsg.style.display = 'none';
    } else {
        productSection.classList.add('locked');
        productLockedMsg.style.display = 'flex';
    }
}

function toggleModelingSubchapter(name) {
    const content = document.getElementById(`${name}Content`);
    const chevron = document.getElementById(`${name}Chevron`);

    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        chevron.classList.remove('fa-chevron-right');
        chevron.classList.add('fa-chevron-down');
    } else {
        content.classList.add('hidden');
        chevron.classList.remove('fa-chevron-down');
        chevron.classList.add('fa-chevron-right');
    }
}

function updateSubchapterStatuses() {
    // Update Dataset Sample status
    const sampleStatus = document.getElementById('datasetSampleStatus');
    const sampleRows = configState.sampleRows || [];
    if (sampleStatus) {
        sampleStatus.textContent = sampleRows.length > 0 ? `${sampleRows.length} rows` : '';
    }

    // Update Available Columns status
    const columnsStatus = document.getElementById('availableColumnsStatus');
    const totalCols = configState.availableColumns.length;
    const buyerCount = configState.buyerFeatures.length;
    const productCount = configState.productFeatures.length;

    if (columnsStatus) {
        if (buyerCount > 0 || productCount > 0) {
            columnsStatus.textContent = `${buyerCount} buyer, ${productCount} product`;
        } else {
            columnsStatus.textContent = totalCols > 0 ? `${totalCols} columns` : '';
        }
    }
}

function renderAvailableColumns() {
    const container = document.getElementById('availableColumns');
    container.innerHTML = '';

    // Get assigned column names by model (including primary IDs)
    const buyerCols = new Set(configState.buyerFeatures.map(f => f.column));
    const productCols = new Set(configState.productFeatures.map(f => f.column));

    // Add primary ID columns to the sets
    if (configState.customerIdFeature) {
        buyerCols.add(configState.customerIdFeature.column);
    }
    if (configState.productIdFeature) {
        productCols.add(configState.productIdFeature.column);
    }

    configState.availableColumns.forEach(col => {
        const inBuyer = buyerCols.has(col.name);
        const inProduct = productCols.has(col.name);

        const card = document.createElement('div');
        card.className = 'column-card';

        // Add assignment state classes
        if (inBuyer && inProduct) {
            card.classList.add('assigned-both');
        } else if (inBuyer) {
            card.classList.add('assigned-buyer');
        } else if (inProduct) {
            card.classList.add('assigned-product');
        }

        // Only allow dragging if not assigned to both models
        const canDrag = !(inBuyer && inProduct);
        card.draggable = canDrag;
        card.dataset.column = JSON.stringify(col);
        if (canDrag) {
            card.ondragstart = (e) => dragStart(e, col);
            card.ondragend = dragEnd;
        }

        // Simple layout: drag handle | name | BQ type badge
        card.innerHTML = `
            <i class="fas fa-grip-vertical drag-handle"></i>
            <span class="column-name" title="${escapeHtml(col.name)}">${escapeHtml(col.name)}</span>
            <span class="column-bq-type">${formatBqType(col.bq_type || 'STRING')}</span>
        `;

        container.appendChild(card);
    });
}

function formatBqType(bqType) {
    // Format BigQuery types to shorter display names
    const typeMap = {
        'STRING': 'STR',
        'INTEGER': 'INT',
        'INT64': 'INT',
        'FLOAT': 'FLOAT',
        'FLOAT64': 'FLOAT',
        'NUMERIC': 'NUM',
        'BIGNUMERIC': 'NUM',
        'BOOLEAN': 'BOOL',
        'BOOL': 'BOOL',
        'TIMESTAMP': 'TIME',
        'DATETIME': 'TIME',
        'DATE': 'DATE',
        'TIME': 'TIME',
        'BYTES': 'BYTES',
    };
    return typeMap[bqType?.toUpperCase()] || bqType || 'STR';
}

// Data Type System
// Three main data types: numeric, text, temporal
const DATA_TYPES = {
    numeric: { label: 'Numeric', icon: 'hashtag' },
    text: { label: 'Text', icon: 'font' },
    temporal: { label: 'Temporal', icon: 'calendar' }
};

function getDataTypeLabel(dataType) {
    return DATA_TYPES[dataType]?.label || dataType;
}

function getDataTypeFromBqType(bqType) {
    // Map BigQuery type to our data type system
    const type = (bqType || 'STRING').toUpperCase();

    if (['INTEGER', 'INT64', 'FLOAT', 'FLOAT64', 'NUMERIC', 'BIGNUMERIC'].includes(type)) {
        return 'numeric';
    } else if (['TIMESTAMP', 'DATETIME', 'DATE', 'TIME'].includes(type)) {
        return 'temporal';
    } else {
        // STRING, BYTES, etc.
        return 'text';
    }
}

function getTransformOptionsForDataType(dataType) {
    // Return available transforms based on data type
    switch (dataType) {
        case 'numeric':
            return [
                { key: 'normalize', label: 'Normalize', desc: 'Scale to [-1, 1] range', outputDim: 1 },
                { key: 'bucketize', label: 'Bucketize', desc: 'Discretize into buckets + embed', outputDim: 'configurable' }
            ];
        case 'text':
            return [
                { key: 'embedding', label: 'Embedding', desc: 'Learn vector representation', outputDim: 'configurable' }
            ];
        case 'temporal':
            return [
                { key: 'normalize', label: 'Normalize', desc: 'Scale timestamp to [-1, 1]', outputDim: 1 },
                { key: 'cyclical', label: 'Cyclical', desc: 'Extract periodic patterns (month, week, etc.)', outputDim: 'varies' },
                { key: 'bucketize', label: 'Bucketize', desc: 'Discretize into time buckets + embed', outputDim: 'configurable' }
            ];
        default:
            return [];
    }
}

function updateFeatureDataType(model, idx, newDataType) {
    const features = model === 'buyer' ? configState.buyerFeatures : configState.productFeatures;
    if (features[idx]) {
        features[idx].data_type = newDataType;
        // Clear transforms when data type changes - user must reconfigure
        features[idx].transforms = {};
    }
    renderStep2();
}

function getFeatureDisplayInfo(feature) {
    // Returns display string showing data type and transform output
    const dataType = feature.data_type || getDataTypeFromBqType(feature.bq_type);
    const dataTypeLabel = getDataTypeLabel(dataType);
    const transforms = feature.transforms || {};

    // Calculate total output dimension
    let outputParts = [];
    let totalDim = 0;

    if (dataType === 'numeric') {
        if (transforms.normalize?.enabled) {
            outputParts.push('Norm: 1D');
            totalDim += 1;
        }
        if (transforms.bucketize?.enabled) {
            const dim = transforms.bucketize.embedding_dim || 32;
            outputParts.push(`Bucket: ${dim}D`);
            totalDim += dim;
        }
    } else if (dataType === 'text') {
        if (transforms.embedding?.enabled) {
            const dim = transforms.embedding.embedding_dim || 32;
            outputParts.push(`Embed: ${dim}D`);
            totalDim += dim;
        }
    } else if (dataType === 'temporal') {
        if (transforms.normalize?.enabled) {
            outputParts.push('Norm: 1D');
            totalDim += 1;
        }
        if (transforms.cyclical?.enabled) {
            const cyclical = transforms.cyclical;
            let cyclicalDim = 0;
            if (cyclical.yearly || cyclical.annual) cyclicalDim += 2;
            if (cyclical.quarterly) cyclicalDim += 2;
            if (cyclical.monthly) cyclicalDim += 2;
            if (cyclical.weekly) cyclicalDim += 2;
            if (cyclical.daily) cyclicalDim += 2;
            if (cyclicalDim > 0) {
                outputParts.push(`Cyclical: ${cyclicalDim}D`);
                totalDim += cyclicalDim;
            }
        }
        if (transforms.bucketize?.enabled) {
            const dim = transforms.bucketize.embedding_dim || 32;
            outputParts.push(`Bucket: ${dim}D`);
            totalDim += dim;
        }
    }

    const transformStr = outputParts.length > 0
        ? outputParts.join(' + ')
        : 'No transform selected';

    return {
        dataTypeLabel,
        transformStr,
        totalDim,
        hasTransforms: outputParts.length > 0
    };
}

function renderSampleTable() {
    const container = document.getElementById('sampleDataTable');
    const rows = configState.sampleRows || [];
    const columns = configState.columnOrder || [];

    if (rows.length === 0 || columns.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-sm p-4">No sample data available</p>';
        return;
    }

    // Get assignment status for each column (including primary IDs)
    const buyerCols = new Set(configState.buyerFeatures.map(f => f.column));
    const productCols = new Set(configState.productFeatures.map(f => f.column));

    // Add primary ID columns
    if (configState.customerIdFeature) {
        buyerCols.add(configState.customerIdFeature.column);
    }
    if (configState.productIdFeature) {
        productCols.add(configState.productIdFeature.column);
    }

    let html = `
        <div class="sample-table-wrapper">
            <table class="sample-table">
                <thead>
                    <tr>
                        ${columns.map(col => {
                            let headerClass = '';
                            const inBuyer = buyerCols.has(col);
                            const inProduct = productCols.has(col);

                            if (inBuyer && inProduct) {
                                headerClass = 'col-both';
                            } else if (inBuyer) {
                                headerClass = 'col-buyer';
                            } else if (inProduct) {
                                headerClass = 'col-product';
                            }

                            return `<th class="${headerClass}">${escapeHtml(col)}</th>`;
                        }).join('')}
                    </tr>
                </thead>
                <tbody>
                    ${rows.slice(0, 10).map(row => `
                        <tr>
                            ${columns.map(col => {
                                let cellClass = '';
                                const inBuyer = buyerCols.has(col);
                                const inProduct = productCols.has(col);

                                if (inBuyer && inProduct) {
                                    cellClass = 'col-both';
                                } else if (inBuyer) {
                                    cellClass = 'col-buyer';
                                } else if (inProduct) {
                                    cellClass = 'col-product';
                                }

                                const val = row[col];
                                const displayVal = val === null || val === undefined
                                    ? '<span class="null-value">NULL</span>'
                                    : escapeHtml(String(val));
                                return `<td class="${cellClass}">${displayVal}</td>`;
                            }).join('')}
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;

    container.innerHTML = html;
}

function renderAssignedFeatures(model) {
    const features = model === 'buyer' ? configState.buyerFeatures : configState.productFeatures;
    const crosses = model === 'buyer' ? configState.buyerCrosses : configState.productCrosses;
    const container = document.getElementById(`${model}ModelFeatures`);
    const crossContainer = document.getElementById(`${model}ModelCrosses`);
    const addCrossBtn = document.getElementById(`add${model.charAt(0).toUpperCase() + model.slice(1)}CrossBtn`);

    container.innerHTML = '';
    crossContainer.innerHTML = '';

    // Show/hide cross feature button based on whether there are features
    // (including primary ID feature)
    const hasPrimaryId = model === 'buyer' ? configState.customerIdFeature : configState.productIdFeature;
    const hasFeatures = features.length > 0 || hasPrimaryId;

    if (hasFeatures) {
        addCrossBtn.style.display = 'inline-flex';

        features.forEach((feature, idx) => {
            const el = createAssignedFeatureElement(feature, model, idx);
            container.appendChild(el);
        });
    } else {
        addCrossBtn.style.display = 'none';
    }

    crosses.forEach((cross, idx) => {
        const el = createCrossFeatureElement(cross, model, idx);
        crossContainer.appendChild(el);
    });
}

function createAssignedFeatureElement(feature, model, idx) {
    const div = document.createElement('div');

    // Get display info
    const displayInfo = getFeatureDisplayInfo(feature);
    const bqType = feature.bq_type || 'STRING';

    // Apply warning class to the outer div if no transforms selected
    div.className = displayInfo.hasTransforms ? 'assigned-feature' : 'assigned-feature feature-needs-config';

    div.innerHTML = `
        <div class="flex items-center justify-between">
            <div class="flex-1">
                <div class="font-medium text-sm">${escapeHtml(feature.column)}</div>
                <div class="text-xs ${displayInfo.hasTransforms ? 'text-gray-500' : 'text-amber-600'}">
                    ${bqType}  ${displayInfo.dataTypeLabel}  ${displayInfo.transformStr}
                </div>
            </div>
            <div class="flex flex-col gap-1 ml-2">
                <button type="button" class="feature-config-btn settings ${displayInfo.hasTransforms ? '' : 'needs-attention'}" onclick="openFeatureConfig('${model}', ${idx})" title="Configure transforms">
                    <i class="fas fa-cog"></i>
                </button>
                <button type="button" class="feature-config-btn remove" onclick="removeFeature('${model}', ${idx})" title="Remove">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
        </div>
    `;

    return div;
}

function getCrossFeatureNames(cross) {
    // Handle both old format (array of strings) and new format (array of objects)
    if (!cross.features || cross.features.length === 0) return [];
    if (typeof cross.features[0] === 'string') {
        return cross.features;
    }
    return cross.features.map(f => f.column);
}

function getCrossFeatureDetails(cross) {
    // Build detailed description including bucket info for numeric/temporal
    if (!cross.features || cross.features.length === 0) return '';
    if (typeof cross.features[0] === 'string') {
        return ''; // Old format, no bucket details
    }

    const details = cross.features
        .filter(f => f.crossing_buckets)
        .map(f => `${f.column}: ${f.crossing_buckets} buckets`);

    return details.length > 0 ? details.join(', ') : '';
}

function createCrossFeatureElement(cross, model, idx) {
    const div = document.createElement('div');
    div.className = 'cross-feature';

    const featureNames = getCrossFeatureNames(cross);
    const bucketDetails = getCrossFeatureDetails(cross);

    div.innerHTML = `
        <div class="flex items-center justify-between">
            <div>
                <div class="font-medium text-sm">${featureNames.join('  ')}</div>
                <div class="text-xs text-gray-500">
                    Hash: ${cross.hash_bucket_size.toLocaleString()}  ${cross.embedding_dim}D
                    ${bucketDetails ? `<br><span class="text-blue-600">${bucketDetails}</span>` : ''}
                </div>
            </div>
            <button type="button" class="feature-config-btn remove" onclick="removeCross('${model}', ${idx})">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;

    return div;
}

function getFeatureDimString(feature) {
    const parts = [];
    if (feature.type === 'string_embedding') {
        parts.push(`Embedding: ${feature.embedding_dim || 32}D`);
    } else if (feature.type === 'numeric') {
        const t = feature.transforms || {};
        if (t.normalize?.enabled) parts.push('Norm: 1D');
        if (t.bucketize?.enabled) parts.push(`Bucket: ${t.bucketize.embedding_dim || 32}D`);
    } else if (feature.type === 'timestamp') {
        const t = feature.transforms || {};
        if (t.normalize?.enabled) parts.push('Norm: 1D');
        const cyclical = t.cyclical || {};
        const cycles = ['yearly', 'annual', 'quarterly', 'monthly', 'weekly', 'daily'].filter(c => cyclical[c]).length;
        if (cycles > 0) parts.push(`Cyclical: ${cycles * 2}D`);
    }
    return parts.join(' + ') || 'Not configured';
}

// =============================================================================
// DRAG AND DROP
// =============================================================================

function dragStart(e, col) {
    e.target.classList.add('dragging');
    e.dataTransfer.setData('text/plain', JSON.stringify(col));
    e.dataTransfer.effectAllowed = 'move';
}

function dragEnd(e) {
    e.target.classList.remove('dragging');
}

function allowDrop(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
}

function dragEnter(e) {
    e.preventDefault();
    e.currentTarget.classList.add('drag-over');
}

function dragLeave(e) {
    e.currentTarget.classList.remove('drag-over');
}

function dropFeature(e, model) {
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');

    // Check if the model is unlocked (primary ID must be set first)
    const isUnlocked = model === 'buyer' ? configState.customerIdFeature : configState.productIdFeature;
    if (!isUnlocked) {
        return; // Can't drop if locked
    }

    const colData = JSON.parse(e.dataTransfer.getData('text/plain'));
    const feature = createDefaultFeature(colData);

    if (model === 'buyer') {
        configState.buyerFeatures.push(feature);
    } else {
        configState.productFeatures.push(feature);
    }

    renderStep2();
}

// =============================================================================
// PRIMARY ID DROP HANDLING
// =============================================================================

function dragEnterPrimaryId(e) {
    e.preventDefault();
    e.currentTarget.classList.add('drag-over');
}

function dragLeavePrimaryId(e) {
    e.currentTarget.classList.remove('drag-over');
}

function allowDropIfUnlocked(e, model) {
    const isUnlocked = model === 'buyer' ? configState.customerIdFeature : configState.productIdFeature;
    if (isUnlocked) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
    }
}

function dragEnterIfUnlocked(e, model) {
    const isUnlocked = model === 'buyer' ? configState.customerIdFeature : configState.productIdFeature;
    if (isUnlocked) {
        e.preventDefault();
        e.currentTarget.classList.add('drag-over');
    }
}

function dropPrimaryId(e, model) {
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');

    const colData = JSON.parse(e.dataTransfer.getData('text/plain'));

    // Create primary ID feature with forced text type and embedding transform
    const primaryIdFeature = {
        column: colData.name,
        bq_type: colData.bq_type || colData.type || 'STRING',
        data_type: 'text',  // Force to text regardless of original type
        is_primary_id: true,
        stats: colData.stats || {},
        transforms: {
            embedding: {
                enabled: true,
                embedding_dim: 32,  // Default 32D
                vocab_size: 100000
            }
        }
    };

    if (model === 'buyer') {
        configState.customerIdFeature = primaryIdFeature;
    } else {
        configState.productIdFeature = primaryIdFeature;
    }

    renderStep2();
}

function removePrimaryId(model) {
    if (model === 'buyer') {
        configState.customerIdFeature = null;
        // Also clear additional features since the model is now locked
        configState.buyerFeatures = [];
        configState.buyerCrosses = [];
    } else {
        configState.productIdFeature = null;
        // Also clear additional features since the model is now locked
        configState.productFeatures = [];
        configState.productCrosses = [];
    }
    renderStep2();
}

function openPrimaryIdConfig(model) {
    const feature = model === 'buyer' ? configState.customerIdFeature : configState.productIdFeature;
    if (!feature) return;

    editingFeature = {...feature, _model: model, _isPrimaryId: true};
    editingFeatureModel = model;

    const idLabel = model === 'buyer' ? 'Customer ID' : 'Product ID';
    document.getElementById('featureModalTitle').textContent = `Configure: ${idLabel}`;
    renderPrimaryIdConfigForm();
    document.getElementById('featureConfigModal').classList.remove('hidden');
}

function renderPrimaryIdConfigForm() {
    const body = document.getElementById('featureModalBody');
    const embedDim = editingFeature.transforms?.embedding?.embedding_dim || 32;
    const presetDims = [8, 16, 32, 64, 128, 256];
    const isCustom = !presetDims.includes(embedDim);

    body.innerHTML = `
        <div class="mb-4">
            <div class="text-sm text-gray-600 mb-2">
                <strong>Column:</strong> ${escapeHtml(editingFeature.column)}
            </div>
            <div class="text-sm text-gray-500">
                Original type: ${editingFeature.bq_type || 'STRING'}  <span class="text-blue-600 font-medium">Text (forced)</span>
            </div>
        </div>

        <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg mb-4">
            <div class="text-sm text-blue-800">
                <i class="fas fa-info-circle mr-2"></i>
                Primary ID columns use text embedding. Other transforms are not available.
            </div>
        </div>

        <div class="modal-form-group">
            <label class="modal-form-label">Embedding Dimension</label>
            <div class="flex gap-2 flex-wrap items-center justify-center">
                ${presetDims.map(dim => `
                    <button type="button"
                            class="primary-id-dim-btn px-3 py-2 rounded-lg border transition-all ${embedDim === dim && !isCustom
                                ? 'bg-blue-500 text-white border-blue-500'
                                : 'bg-white text-gray-700 border-gray-300 hover:border-blue-400'}"
                            onclick="selectPrimaryIdDim(${dim})">
                        ${dim}D
                    </button>
                `).join('')}
            </div>
            <div class="flex items-center gap-3 mt-3">
                <span class="text-sm text-gray-600">Custom:</span>
                <input type="number"
                       id="customEmbedDimInput"
                       class="form-input text-sm"
                       style="width: 100px;"
                       min="4"
                       max="1024"
                       step="1"
                       value="${isCustom ? embedDim : ''}"
                       placeholder="e.g. 512"
                       onchange="onCustomDimChange(this.value)"
                       oninput="onCustomDimInput(this.value)">
                <span class="text-xs text-gray-500">Range: 4 - 1024</span>
            </div>
            <p class="modal-form-hint mt-2">
                <i class="fas fa-lightbulb text-amber-500 mr-1"></i>
                Tip: Use larger dimensions (256-512) for millions of unique IDs, smaller (8-32) for few unique values
            </p>
        </div>

        <input type="hidden" id="primaryIdEmbedDim" value="${embedDim}">
    `;
}

function selectPrimaryIdDim(dim) {
    document.getElementById('primaryIdEmbedDim').value = dim;

    // Clear custom input when preset is selected
    const customInput = document.getElementById('customEmbedDimInput');
    if (customInput) {
        customInput.value = '';
    }

    // Update button styles
    const buttons = document.querySelectorAll('.primary-id-dim-btn');
    buttons.forEach(btn => {
        const btnDim = parseInt(btn.textContent);
        if (btnDim === dim) {
            btn.className = 'primary-id-dim-btn px-3 py-2 rounded-lg border transition-all bg-blue-500 text-white border-blue-500';
        } else {
            btn.className = 'primary-id-dim-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400';
        }
    });
}

function onCustomDimInput(value) {
    // Live update as user types - deselect preset buttons
    if (value) {
        const buttons = document.querySelectorAll('.primary-id-dim-btn');
        buttons.forEach(btn => {
            btn.className = 'primary-id-dim-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400';
        });
    }
}

function onCustomDimChange(value) {
    // Validate and set the custom dimension
    let dim = parseInt(value);
    if (isNaN(dim) || dim < 4) {
        dim = 4;
        document.getElementById('customEmbedDimInput').value = 4;
    } else if (dim > 1024) {
        dim = 1024;
        document.getElementById('customEmbedDimInput').value = 1024;
    }

    document.getElementById('primaryIdEmbedDim').value = dim;

    // Deselect all preset buttons
    const buttons = document.querySelectorAll('.primary-id-dim-btn');
    buttons.forEach(btn => {
        btn.className = 'primary-id-dim-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400';
    });
}

function applyPrimaryIdConfig() {
    const model = editingFeature._model;
    const newDim = parseInt(document.getElementById('primaryIdEmbedDim').value) || 32;

    if (model === 'buyer' && configState.customerIdFeature) {
        configState.customerIdFeature.transforms.embedding.embedding_dim = newDim;
    } else if (model === 'product' && configState.productIdFeature) {
        configState.productIdFeature.transforms.embedding.embedding_dim = newDim;
    }

    closeFeatureModal();
    renderStep2();
}

// =============================================================================
// TEXT EMBEDDING DIMENSION SELECTION (for context features)
// =============================================================================

function selectTextEmbedDim(dim) {
    document.getElementById('featureEmbedDim').value = dim;

    // Clear custom input when preset is selected
    const customInput = document.getElementById('customTextEmbedDimInput');
    if (customInput) {
        customInput.value = '';
    }

    // Update dimension label
    const dimLabel = document.getElementById('embeddingDimLabel');
    if (dimLabel) {
        dimLabel.textContent = `+${dim}D`;
    }

    // Update button styles
    const buttons = document.querySelectorAll('.text-embed-dim-btn');
    buttons.forEach(btn => {
        const btnDim = parseInt(btn.textContent);
        if (btnDim === dim) {
            btn.className = 'text-embed-dim-btn px-3 py-2 rounded-lg border transition-all bg-blue-500 text-white border-blue-500';
        } else {
            btn.className = 'text-embed-dim-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400';
        }
    });
}

function onCustomTextEmbedDimInput(value) {
    // Live update as user types - deselect preset buttons
    if (value) {
        const buttons = document.querySelectorAll('.text-embed-dim-btn');
        buttons.forEach(btn => {
            btn.className = 'text-embed-dim-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400';
        });
    }
}

function onCustomTextEmbedDimChange(value) {
    // Validate and set the custom dimension
    let dim = parseInt(value);
    if (isNaN(dim) || dim < 4) {
        dim = 4;
        document.getElementById('customTextEmbedDimInput').value = 4;
    } else if (dim > 1024) {
        dim = 1024;
        document.getElementById('customTextEmbedDimInput').value = 1024;
    }

    document.getElementById('featureEmbedDim').value = dim;

    // Update dimension label
    const dimLabel = document.getElementById('embeddingDimLabel');
    if (dimLabel) {
        dimLabel.textContent = `+${dim}D`;
    }

    // Deselect all preset buttons
    const buttons = document.querySelectorAll('.text-embed-dim-btn');
    buttons.forEach(btn => {
        btn.className = 'text-embed-dim-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400';
    });
}

function createDefaultFeature(col) {
    // Create feature with BQ type, but NO transforms applied
    // User must configure transforms via the settings modal
    const bqType = col.bq_type || col.type || 'STRING';
    const dataType = getDataTypeFromBqType(bqType);

    return {
        column: col.name,
        bq_type: bqType,
        data_type: dataType,  // Numeric, Text, or Temporal
        stats: col.stats || {},
        transforms: {}  // Empty - user must configure
    };
}

function detectCyclicalPeriod(col) {
    const colName = (col.name || '').toLowerCase();
    const min = col.stats?.min;
    const max = col.stats?.max;

    // Try to detect from column name
    if (colName.includes('hour')) return 24;
    if (colName.includes('day_of_week') || colName.includes('weekday')) return 7;
    if (colName.includes('month')) return 12;
    if (colName.includes('day_of_month') || colName.includes('day')) return 31;
    if (colName.includes('quarter')) return 4;

    // Try to detect from value range
    if (min !== undefined && max !== undefined) {
        if (min >= 0 && max <= 23) return 24;
        if (min >= 0 && max <= 6) return 7;
        if (min >= 1 && max <= 12) return 12;
        if (min >= 1 && max <= 31) return 31;
        if (min >= 1 && max <= 4) return 4;
    }

    return 12; // Default to monthly
}

function getRecommendedEmbedDim(cardinality) {
    if (cardinality < 50) return 8;
    if (cardinality < 500) return 16;
    if (cardinality < 5000) return 32;
    if (cardinality < 50000) return 64;
    if (cardinality < 500000) return 96;
    return 128;
}

function removeFeature(model, idx) {
    if (model === 'buyer') {
        configState.buyerFeatures.splice(idx, 1);
    } else {
        configState.productFeatures.splice(idx, 1);
    }
    renderStep2();
}

function removeCross(model, idx) {
    if (model === 'buyer') {
        configState.buyerCrosses.splice(idx, 1);
    } else {
        configState.productCrosses.splice(idx, 1);
    }
    renderStep2();
}

// =============================================================================
// TENSOR PREVIEW
// =============================================================================

/**
 * Calculate tensor breakdown from feature arrays
 * @param {Array} features - Array of feature objects
 * @param {Array} crosses - Array of cross feature objects
 * @returns {Object} { total: number, breakdown: Array<{name, dim, is_cross?}> }
 */
function calculateTensorBreakdown(features, crosses) {
    const breakdown = [];
    let total = 0;

    // Process features
    (features || []).forEach(feature => {
        const info = getFeatureDisplayInfo(feature);
        if (info.totalDim > 0) {
            breakdown.push({ name: feature.column, dim: info.totalDim });
            total += info.totalDim;
        }
    });

    // Process cross features
    (crosses || []).forEach(cross => {
        const dim = cross.embedding_dim || 16;
        const featureNames = getCrossFeatureNames(cross);
        const name = featureNames.join('  ');
        breakdown.push({ name: name, dim: dim, is_cross: true });
        total += dim;
    });

    return { total, breakdown };
}

function updateTensorPreview() {
    // Calculate buyer tensor dimensions
    const buyerFeatures = [];
    if (configState.customerIdFeature) {
        buyerFeatures.push(configState.customerIdFeature);
    }
    buyerFeatures.push(...configState.buyerFeatures);
    const buyerResult = calculateTensorBreakdown(buyerFeatures, configState.buyerCrosses);

    // Calculate product tensor dimensions
    const productFeatures = [];
    if (configState.productIdFeature) {
        productFeatures.push(configState.productIdFeature);
    }
    productFeatures.push(...configState.productFeatures);
    const productResult = calculateTensorBreakdown(productFeatures, configState.productCrosses);

    // Render both previews
    renderTensorPreview('buyer', buyerResult.total, buyerResult.breakdown);
    renderTensorPreview('product', productResult.total, productResult.breakdown);
}

/**
 * Render tensor visualization bar and breakdown tags
 * Can be called with either:
 *   - model name (for wizard): renderTensorPreview('buyer', total, breakdown)
 *   - DOM elements directly (for cards): renderTensorPreview('buyer', total, breakdown, barEl, breakdownEl, maxTotal)
 * @param maxTotal - max total across both tensors for proportional bar width
 */
function renderTensorPreview(model, total, breakdown, barContainer = null, breakdownContainer = null, maxTotal = null) {
    // Get containers - either from params or by ID (wizard mode)
    if (!barContainer) {
        document.getElementById(`${model}TensorTotal`).textContent = `${total}D`;
        barContainer = document.getElementById(`${model}TensorBar`);
        breakdownContainer = document.getElementById(`${model}TensorBreakdown`);
    }

    barContainer.innerHTML = '';
    if (breakdownContainer) breakdownContainer.innerHTML = '';

    if (!breakdown || breakdown.length === 0) return;

    // Set bar container width proportionally if maxTotal provided
    if (maxTotal && maxTotal > 0) {
        const widthPercent = (total / maxTotal) * 100;
        barContainer.style.width = `${widthPercent}%`;
    } else {
        barContainer.style.width = '100%';
    }

    const colors = model === 'buyer'
        ? ['#3b82f6', '#60a5fa', '#93c5fd', '#bfdbfe', '#dbeafe']
        : ['#10b981', '#34d399', '#6ee7b7', '#a7f3d0', '#d1fae5'];

    breakdown.forEach((item, idx) => {
        const pct = (item.dim / total) * 100;
        const color = colors[idx % colors.length];

        const segment = document.createElement('div');
        segment.className = 'tensor-breakdown-segment';
        segment.style.width = `${pct}%`;
        segment.style.backgroundColor = color;
        segment.title = `${item.name}: ${item.dim}D`;
        if (pct > 10) {
            segment.textContent = item.dim;
        }
        barContainer.appendChild(segment);

        if (breakdownContainer) {
            const tag = document.createElement('span');
            tag.className = 'tensor-breakdown-item';
            tag.textContent = `${item.name}: ${item.dim}D`;
            breakdownContainer.appendChild(tag);
        }
    });
}

// =============================================================================
// FEATURE CONFIGURATION MODAL
// =============================================================================

function openFeatureConfig(model, idx) {
    editingFeatureModel = model;
    const features = model === 'buyer' ? configState.buyerFeatures : configState.productFeatures;
    editingFeature = {...features[idx], _idx: idx};

    document.getElementById('featureModalTitle').textContent = `Configure: ${editingFeature.column}`;
    renderFeatureConfigForm();
    document.getElementById('featureConfigModal').classList.remove('hidden');
}

function closeFeatureModal() {
    document.getElementById('featureConfigModal').classList.add('hidden');
    editingFeature = null;
    editingFeatureModel = null;
}

function renderFeatureConfigForm() {
    const body = document.getElementById('featureModalBody');
    const dataType = editingFeature.data_type || getDataTypeFromBqType(editingFeature.bq_type);
    const t = editingFeature.transforms || {};

    // Build data type selector
    const dataTypeOptions = ['numeric', 'text', 'temporal'].map(dt =>
        `<option value="${dt}" ${dataType === dt ? 'selected' : ''}>${getDataTypeLabel(dt)}</option>`
    ).join('');

    let transformsHtml = '';

    if (dataType === 'numeric') {
        transformsHtml = `
            <div class="transform-option">
                <input type="checkbox" id="featureNormalize" ${t.normalize?.enabled ? 'checked' : ''}>
                <div class="transform-option-content">
                    <div class="transform-option-title">Normalize</div>
                    <div class="transform-option-desc">Scale values to [-1, 1] range</div>
                </div>
                <span class="transform-option-dim">+1D</span>
            </div>
            <div class="transform-option">
                <input type="checkbox" id="featureBucketize" ${t.bucketize?.enabled ? 'checked' : ''}>
                <div class="transform-option-content">
                    <div class="transform-option-title">Bucketize + Embed</div>
                    <div class="transform-option-desc">Discretize into buckets with learned embedding</div>
                    <div class="mt-2">
                        <label class="text-xs text-gray-500">Buckets:</label>
                        <select id="featureBuckets" class="form-select form-select-sm ml-2" style="width: 80px;">
                            ${[10, 50, 100, 200].map(b =>
                                `<option value="${b}" ${(t.bucketize?.buckets || 100) == b ? 'selected' : ''}>${b}</option>`
                            ).join('')}
                        </select>
                        <label class="text-xs text-gray-500 ml-3">Dim:</label>
                        <select id="featureBucketDim" class="form-select form-select-sm ml-2" style="width: 80px;">
                            ${[8, 16, 32, 64].map(d =>
                                `<option value="${d}" ${(t.bucketize?.embedding_dim || 32) == d ? 'selected' : ''}>${d}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
                <span class="transform-option-dim" id="bucketizeDimLabel">+${t.bucketize?.embedding_dim || 32}D</span>
            </div>
        `;
    } else if (dataType === 'text') {
        const embedDim = t.embedding?.embedding_dim || 32;
        const presetDims = [8, 16, 32, 64, 128, 256];
        const isCustomDim = !presetDims.includes(embedDim);

        transformsHtml = `
            <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg">
                <div class="flex items-center justify-between mb-3">
                    <div>
                        <div class="font-medium text-gray-800">Embedding</div>
                        <div class="text-xs text-gray-500">Learn vector representation for categorical values</div>
                    </div>
                    <span class="text-blue-600 font-medium" id="embeddingDimLabel">+${embedDim}D</span>
                </div>

                <div class="mb-3">
                    <label class="text-xs text-gray-600 font-medium mb-2 block">Embedding Dimension</label>
                    <div class="flex gap-2 flex-wrap items-center justify-center">
                        ${presetDims.map(dim => `
                            <button type="button"
                                    class="text-embed-dim-btn px-3 py-2 rounded-lg border transition-all ${embedDim === dim && !isCustomDim
                                        ? 'bg-blue-500 text-white border-blue-500'
                                        : 'bg-white text-gray-700 border-gray-300 hover:border-blue-400'}"
                                    onclick="selectTextEmbedDim(${dim})">
                                ${dim}D
                            </button>
                        `).join('')}
                    </div>
                    <div class="flex items-center gap-3 mt-3 justify-center">
                        <span class="text-xs text-gray-600">Custom:</span>
                        <input type="number"
                               id="customTextEmbedDimInput"
                               class="form-input text-sm"
                               style="width: 80px;"
                               min="4"
                               max="1024"
                               step="1"
                               value="${isCustomDim ? embedDim : ''}"
                               placeholder="e.g. 512"
                               onchange="onCustomTextEmbedDimChange(this.value)"
                               oninput="onCustomTextEmbedDimInput(this.value)">
                        <span class="text-xs text-gray-400">4 - 1024</span>
                    </div>
                </div>

                <div class="border-t border-gray-200 pt-3 mt-3 space-y-2">
                    <div class="flex items-start gap-2 text-xs text-gray-600">
                        <i class="fas fa-database text-blue-500 mt-0.5"></i>
                        <span><strong>Vocabulary:</strong> Auto-detected from training data (no manual limit needed)</span>
                    </div>
                    <div class="flex items-start gap-2 text-xs text-gray-600">
                        <i class="fas fa-plus-circle text-green-500 mt-0.5"></i>
                        <span><strong>+1 OOV:</strong> One extra dimension is automatically reserved for new/unknown values</span>
                    </div>
                </div>
            </div>
            <input type="hidden" id="featureEmbedDim" value="${embedDim}">
        `;
    } else if (dataType === 'temporal') {
        const c = t.cyclical || {};
        transformsHtml = `
            <div class="transform-option">
                <input type="checkbox" id="featureNormalize" ${t.normalize?.enabled ? 'checked' : ''}>
                <div class="transform-option-content">
                    <div class="transform-option-title">Normalize</div>
                    <div class="transform-option-desc">Scale timestamp to [-1, 1] range</div>
                </div>
                <span class="transform-option-dim">+1D</span>
            </div>
            <div class="transform-option" style="flex-direction: column; align-items: stretch;">
                <div class="flex items-start gap-2 w-full">
                    <div class="transform-option-content flex-1">
                        <div class="transform-option-title">Cyclical Features</div>
                        <div class="transform-option-desc">Extract periodic patterns using sin/cos encoding</div>
                    </div>
                    <span class="transform-option-dim">varies</span>
                </div>
                <div class="space-y-1 mt-3">
                    <label class="flex items-center gap-2 text-xs">
                        <input type="checkbox" id="cyclicalYearly" ${c.yearly ? 'checked' : ''}>
                        <span>Yearly (month of year)</span>
                        <span class="text-blue-600 ml-auto">+2D</span>
                    </label>
                    <label class="flex items-center gap-2 text-xs">
                        <input type="checkbox" id="cyclicalQuarterly" ${c.quarterly ? 'checked' : ''}>
                        <span>Quarterly (month of quarter)</span>
                        <span class="text-blue-600 ml-auto">+2D</span>
                    </label>
                    <label class="flex items-center gap-2 text-xs">
                        <input type="checkbox" id="cyclicalMonthly" ${c.monthly ? 'checked' : ''}>
                        <span>Monthly (day of month)</span>
                        <span class="text-blue-600 ml-auto">+2D</span>
                    </label>
                    <label class="flex items-center gap-2 text-xs">
                        <input type="checkbox" id="cyclicalWeekly" ${c.weekly ? 'checked' : ''}>
                        <span>Weekly (day of week)</span>
                        <span class="text-blue-600 ml-auto">+2D</span>
                    </label>
                    <label class="flex items-center gap-2 text-xs">
                        <input type="checkbox" id="cyclicalDaily" ${c.daily ? 'checked' : ''}>
                        <span>Daily (hour of day)</span>
                        <span class="text-blue-600 ml-auto">+2D</span>
                    </label>
                </div>
            </div>
            <div class="transform-option">
                <input type="checkbox" id="featureBucketize" ${t.bucketize?.enabled ? 'checked' : ''}>
                <div class="transform-option-content">
                    <div class="transform-option-title">Bucketize + Embed</div>
                    <div class="transform-option-desc">Discretize into time buckets with learned embedding</div>
                    <div class="mt-2">
                        <label class="text-xs text-gray-500">Buckets:</label>
                        <select id="featureBuckets" class="form-select form-select-sm ml-2" style="width: 80px;">
                            ${[10, 50, 100, 200].map(b =>
                                `<option value="${b}" ${(t.bucketize?.buckets || 100) == b ? 'selected' : ''}>${b}</option>`
                            ).join('')}
                        </select>
                        <label class="text-xs text-gray-500 ml-3">Dim:</label>
                        <select id="featureBucketDim" class="form-select form-select-sm ml-2" style="width: 80px;">
                            ${[8, 16, 32, 64].map(d =>
                                `<option value="${d}" ${(t.bucketize?.embedding_dim || 32) == d ? 'selected' : ''}>${d}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
                <span class="transform-option-dim">+${t.bucketize?.embedding_dim || 32}D</span>
            </div>
        `;
    }

    body.innerHTML = `
        <div class="modal-form-group">
            <label class="modal-form-label">Data Type</label>
            <select id="modalDataType" class="form-select w-full" onchange="onModalDataTypeChange(this.value)">
                ${dataTypeOptions}
            </select>
            <p class="modal-form-hint">Original BQ type: ${editingFeature.bq_type || 'STRING'}</p>
        </div>
        <div class="modal-form-group">
            <label class="modal-form-label">Transformations</label>
            <p class="text-xs text-gray-500 mb-2">Select at least one transformation to include this feature in the model</p>
            <div id="transformOptions">
                ${transformsHtml}
            </div>
        </div>
    `;
}

function onModalDataTypeChange(newDataType) {
    // Update the editing feature's data type and re-render the form
    editingFeature.data_type = newDataType;
    editingFeature.transforms = {};  // Clear transforms when type changes
    renderFeatureConfigForm();
}

function applyFeatureConfig() {
    // Check if we're editing a primary ID feature
    if (editingFeature._isPrimaryId) {
        applyPrimaryIdConfig();
        return;
    }

    const features = editingFeatureModel === 'buyer' ? configState.buyerFeatures : configState.productFeatures;
    const idx = editingFeature._idx;
    const dataType = editingFeature.data_type || getDataTypeFromBqType(editingFeature.bq_type);

    // Update the data type
    features[idx].data_type = dataType;

    // Build transforms based on data type
    const transforms = {};

    if (dataType === 'numeric') {
        const normalizeEl = document.getElementById('featureNormalize');
        const bucketizeEl = document.getElementById('featureBucketize');

        if (normalizeEl?.checked) {
            transforms.normalize = { enabled: true, range: [-1, 1] };
        }
        if (bucketizeEl?.checked) {
            transforms.bucketize = {
                enabled: true,
                buckets: parseInt(document.getElementById('featureBuckets').value) || 100,
                embedding_dim: parseInt(document.getElementById('featureBucketDim').value) || 32
            };
        }
    } else if (dataType === 'text') {
        // Text features always use embedding (no checkbox needed)
        // Vocab size is auto-detected from training data, so we don't store it
        transforms.embedding = {
            enabled: true,
            embedding_dim: parseInt(document.getElementById('featureEmbedDim').value) || 32
        };
    } else if (dataType === 'temporal') {
        const normalizeEl = document.getElementById('featureNormalize');
        const bucketizeEl = document.getElementById('featureBucketize');

        if (normalizeEl?.checked) {
            transforms.normalize = { enabled: true, range: [-1, 1] };
        }

        // Check if any cyclical option is selected
        const yearly = document.getElementById('cyclicalYearly')?.checked || false;
        const quarterly = document.getElementById('cyclicalQuarterly')?.checked || false;
        const monthly = document.getElementById('cyclicalMonthly')?.checked || false;
        const weekly = document.getElementById('cyclicalWeekly')?.checked || false;
        const daily = document.getElementById('cyclicalDaily')?.checked || false;

        if (yearly || quarterly || monthly || weekly || daily) {
            transforms.cyclical = {
                enabled: true,
                yearly: yearly,
                quarterly: quarterly,
                monthly: monthly,
                weekly: weekly,
                daily: daily
            };
        }

        if (bucketizeEl?.checked) {
            transforms.bucketize = {
                enabled: true,
                buckets: parseInt(document.getElementById('featureBuckets').value) || 100,
                embedding_dim: parseInt(document.getElementById('featureBucketDim').value) || 32
            };
        }
    }

    features[idx].transforms = transforms;

    closeFeatureModal();
    renderStep2();
}

// =============================================================================
// CROSS FEATURE MODAL
// =============================================================================

function openCrossModal(model) {
    crossFeatureModel = model;

    // Get all features for this model, including the primary ID
    const primaryId = model === 'buyer' ? configState.customerIdFeature : configState.productIdFeature;
    const additionalFeatures = model === 'buyer' ? configState.buyerFeatures : configState.productFeatures;

    // Combine: primary ID first, then additional features
    const allFeatures = primaryId ? [primaryId, ...additionalFeatures] : additionalFeatures;

    const container = document.getElementById('crossFeatureOptions');
    container.innerHTML = '';

    allFeatures.forEach(f => {
        const label = document.createElement('label');
        const isPrimaryId = f.is_primary_id;
        const dataType = f.data_type || getDataTypeFromBqType(f.bq_type);
        const dataTypeLabel = getDataTypeLabel(dataType);

        // Determine badge color based on data type
        let typeBadge = '';
        if (isPrimaryId) {
            typeBadge = '<span class="text-xs bg-amber-100 text-amber-700 px-1 rounded">ID</span>';
        } else if (dataType === 'numeric') {
            typeBadge = '<span class="text-xs bg-blue-100 text-blue-700 px-1 rounded">Numeric</span>';
        } else if (dataType === 'temporal') {
            typeBadge = '<span class="text-xs bg-purple-100 text-purple-700 px-1 rounded">Temporal</span>';
        } else {
            typeBadge = '<span class="text-xs bg-gray-100 text-gray-600 px-1 rounded">Text</span>';
        }

        label.className = 'flex items-center gap-2 p-2 border rounded cursor-pointer hover:bg-gray-50';
        label.innerHTML = `
            <input type="checkbox" class="cross-feature-checkbox" value="${f.column}"
                   data-type="${dataType}" onchange="updateCrossPreview()">
            <span class="text-sm flex-1">${f.column}</span>
            ${typeBadge}
        `;
        container.appendChild(label);
    });

    // Reset bucket options
    document.getElementById('crossBucketOptions').classList.add('hidden');
    document.getElementById('crossBucketInputs').innerHTML = '';
    document.getElementById('crossPreview').classList.add('hidden');
    document.getElementById('crossFeatureModal').classList.remove('hidden');
}

function closeCrossModal() {
    document.getElementById('crossFeatureModal').classList.add('hidden');
    crossFeatureModel = null;
}

function updateCrossPreview() {
    const checkedInputs = Array.from(document.querySelectorAll('.cross-feature-checkbox:checked'));
    const checked = checkedInputs.map(cb => cb.value);

    if (checked.length >= 2) {
        document.getElementById('crossPreviewText').textContent = checked.join('  ');
        document.getElementById('crossPreview').classList.remove('hidden');
    } else {
        document.getElementById('crossPreview').classList.add('hidden');
    }

    // Check for numeric/temporal features that need bucketization
    const numericTemporalFeatures = checkedInputs.filter(cb => {
        const dataType = cb.dataset.type;
        return dataType === 'numeric' || dataType === 'temporal';
    });

    const bucketOptionsContainer = document.getElementById('crossBucketOptions');
    const bucketInputsContainer = document.getElementById('crossBucketInputs');

    if (numericTemporalFeatures.length > 0) {
        bucketInputsContainer.innerHTML = '';

        numericTemporalFeatures.forEach(cb => {
            const column = cb.value;
            const dataType = cb.dataset.type;
            const typeLabel = dataType === 'numeric' ? 'Numeric' : 'Temporal';
            const typeColor = dataType === 'numeric' ? 'blue' : 'purple';

            const div = document.createElement('div');
            div.className = 'flex items-center gap-3 p-3 bg-gray-50 rounded-lg border';
            div.innerHTML = `
                <div class="flex-1">
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-medium">${column}</span>
                        <span class="text-xs bg-${typeColor}-100 text-${typeColor}-700 px-1 rounded">${typeLabel}</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">Buckets for crossing (coarse granularity recommended)</div>
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-xs text-gray-600">Buckets:</label>
                    <select class="cross-bucket-select form-select text-sm" data-column="${column}" style="width: 80px;">
                        <option value="5">5</option>
                        <option value="10" selected>10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
            `;
            bucketInputsContainer.appendChild(div);
        });

        bucketOptionsContainer.classList.remove('hidden');
    } else {
        bucketOptionsContainer.classList.add('hidden');
        bucketInputsContainer.innerHTML = '';
    }
}

function addCrossFeature() {
    const checkedInputs = Array.from(document.querySelectorAll('.cross-feature-checkbox:checked'));

    if (checkedInputs.length < 2) {
        showError('Please select at least 2 features');
        return;
    }
    if (checkedInputs.length > 3) {
        showError('Please select at most 3 features');
        return;
    }

    // Build features array with type and bucket info
    const features = checkedInputs.map(cb => {
        const column = cb.value;
        const dataType = cb.dataset.type;

        const featureConfig = {
            column: column,
            type: dataType
        };

        // Add crossing_buckets for numeric/temporal features
        if (dataType === 'numeric' || dataType === 'temporal') {
            const bucketSelect = document.querySelector(`.cross-bucket-select[data-column="${column}"]`);
            if (bucketSelect) {
                featureConfig.crossing_buckets = parseInt(bucketSelect.value);
            }
        }

        return featureConfig;
    });

    const cross = {
        features: features,
        hash_bucket_size: parseInt(document.getElementById('crossHashBuckets').value),
        embedding_dim: parseInt(document.getElementById('crossEmbedDim').value)
    };

    if (crossFeatureModel === 'buyer') {
        configState.buyerCrosses.push(cross);
    } else {
        configState.productCrosses.push(cross);
    }

    closeCrossModal();
    renderStep2();
}

// =============================================================================
// SAVE CONFIG
// =============================================================================

function saveConfig() {
    // Validate: require primary ID features
    if (!configState.customerIdFeature) {
        showError('Customer ID is required. Please drag a column to the Customer ID zone.');
        return;
    }
    if (!configState.productIdFeature) {
        showError('Product ID is required. Please drag a column to the Product ID zone.');
        return;
    }

    // Build feature arrays with primary IDs at the front
    const buyerFeatures = [configState.customerIdFeature, ...configState.buyerFeatures];
    const productFeatures = [configState.productIdFeature, ...configState.productFeatures];

    const payload = {
        name: configState.name,
        description: configState.description,
        dataset_id: configState.datasetId,
        buyer_model_features: buyerFeatures,
        product_model_features: productFeatures,
        buyer_model_crosses: configState.buyerCrosses,
        product_model_crosses: configState.productCrosses
    };

    const url = editingConfigId
        ? `/api/feature-configs/${editingConfigId}/update/`
        : `/api/models/${modelId}/feature-configs/create/`;
    const method = editingConfigId ? 'PUT' : 'POST';

    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            closeWizard();
            loadConfigs();
            showSuccess(editingConfigId ? 'Feature config updated' : 'Feature config created');
        } else {
            showError(data.error || data.errors?.name || 'Failed to save');
        }
    })
    .catch(err => {
        console.error('Error saving:', err);
        showError('Failed to save feature config');
    });
}

// =============================================================================
// CONFIG ACTIONS
// =============================================================================

function viewConfig(configId) {
    fetch(`/api/feature-configs/${configId}/`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                renderViewModal(data.data);
                document.getElementById('viewConfigModal').classList.remove('hidden');
            }
        });
}

function renderViewModal(config) {
    document.getElementById('viewConfigTitle').textContent = config.name;

    // Calculate tensor breakdowns for detailed view
    const buyerResult = calculateTensorBreakdown(
        config.buyer_model_features || [],
        config.buyer_model_crosses || []
    );
    const productResult = calculateTensorBreakdown(
        config.product_model_features || [],
        config.product_model_crosses || []
    );

    // Build dataset info section
    const datasetInfoHtml = buildDatasetInfoHtml(config.dataset_info, config.dataset_name);

    const body = document.getElementById('viewConfigBody');
    body.innerHTML = `
        <div class="mb-3">
            <div class="text-sm text-gray-500">Dataset: <span class="font-medium text-gray-700">${config.dataset_name}</span></div>
        </div>

        ${datasetInfoHtml}

        <div class="grid grid-cols-2 gap-4">
            <div class="p-4 bg-blue-50 rounded-lg">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="font-semibold text-blue-800">Buyer Tensor</h4>
                    <span class="font-semibold text-blue-600">${buyerResult.total}D</span>
                </div>
                <div id="viewModal-buyer-bar" class="tensor-breakdown-bar mb-3"></div>
                <div class="space-y-1">
                    ${buyerResult.breakdown.map(item => `
                        <div class="flex items-center justify-between text-sm">
                            <span class="${item.is_cross ? 'text-blue-600 italic' : 'text-blue-700'}">${item.name}</span>
                            <span class="text-blue-500 font-medium">${item.dim}D</span>
                        </div>
                    `).join('')}
                </div>
            </div>
            <div class="p-4 bg-green-50 rounded-lg">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="font-semibold text-green-800">Product Tensor</h4>
                    <span class="font-semibold text-green-600">${productResult.total}D</span>
                </div>
                <div id="viewModal-product-bar" class="tensor-breakdown-bar mb-3"></div>
                <div class="space-y-1">
                    ${productResult.breakdown.map(item => `
                        <div class="flex items-center justify-between text-sm">
                            <span class="${item.is_cross ? 'text-green-600 italic' : 'text-green-700'}">${item.name}</span>
                            <span class="text-green-500 font-medium">${item.dim}D</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;

    // Render tensor bars in view modal with proportional widths
    const maxTotal = Math.max(buyerResult.total || 0, productResult.total || 0);

    setTimeout(() => {
        const buyerBar = document.getElementById('viewModal-buyer-bar');
        const productBar = document.getElementById('viewModal-product-bar');
        if (buyerBar && buyerResult.breakdown.length > 0) {
            renderTensorPreview('buyer', buyerResult.total, buyerResult.breakdown, buyerBar, null, maxTotal);
        }
        if (productBar && productResult.breakdown.length > 0) {
            renderTensorPreview('product', productResult.total, productResult.breakdown, productBar, null, maxTotal);
        }
    }, 0);
}

/**
 * Build HTML for dataset information section in View modal.
 * @param {Object} info - Dataset info from API (dataset_info field)
 * @param {string} datasetName - Name of the dataset
 * @returns {string} HTML string for dataset info section
 */
function buildDatasetInfoHtml(info, datasetName) {
    if (!info || !info.primary_table) {
        return ''; // No dataset info available
    }

    // Build tables line
    const tables = [info.primary_table + ' (primary)'];
    (info.secondary_tables || []).forEach(t => {
        if (t) tables.push(t);
    });
    const tablesLine = tables.join(' &bull; ');

    // Build joins lines
    const joins = info.joins || [];
    const joinsHtml = joins.length > 0
        ? joins.map(j => `<div class="text-gray-700">${j}</div>`).join('')
        : '<span class="text-gray-400 italic">No joins</span>';

    // Build filters badges
    const filterBadges = [];
    if (info.filters?.dates) filterBadges.push(info.filters.dates);
    if (info.filters?.customers) filterBadges.push(info.filters.customers);
    if (info.filters?.products) filterBadges.push(info.filters.products);
    const filtersLine = filterBadges.length > 0
        ? filterBadges.join(' &bull; ')
        : '<span class="text-gray-400 italic">No filters</span>';

    // Row count badge
    const rowsBadge = info.estimated_rows
        ? `${info.estimated_rows.toLocaleString()} rows`
        : '';

    return `
        <div class="mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <div class="flex items-center justify-between mb-3">
                <h4 class="font-semibold text-gray-700">
                    <i class="fas fa-database mr-2 text-gray-400"></i>Dataset Source
                </h4>
                ${rowsBadge ? `<span class="text-sm font-medium text-gray-500 bg-white px-2 py-1 rounded border border-gray-200">${rowsBadge}</span>` : ''}
            </div>
            <div class="space-y-2 text-sm">
                <div class="flex">
                    <span class="text-gray-500 w-16 flex-shrink-0">Tables:</span>
                    <span class="text-gray-700">${tablesLine}</span>
                </div>
                ${joins.length > 0 ? `
                <div class="flex">
                    <span class="text-gray-500 w-16 flex-shrink-0">Joins:</span>
                    <div class="text-gray-700">${joinsHtml}</div>
                </div>
                ` : ''}
                <div class="flex">
                    <span class="text-gray-500 w-16 flex-shrink-0">Filters:</span>
                    <span class="text-gray-700">${filtersLine}</span>
                </div>
            </div>
        </div>
    `;
}

function closeViewModal() {
    document.getElementById('viewConfigModal').classList.add('hidden');
}

// =============================================================================
// COMPARE FEATURE SETS FUNCTIONS
// =============================================================================

let compareLeftConfig = null;
let compareRightConfig = null;

function openCompareModal() {
    // Populate dropdowns with all feature sets
    const leftSelect = document.getElementById('compareLeftSelect');
    const rightSelect = document.getElementById('compareRightSelect');

    // Clear existing options except the placeholder
    leftSelect.innerHTML = '<option value="">Select feature set...</option>';
    rightSelect.innerHTML = '<option value="">Select feature set...</option>';

    // Add all configs to both dropdowns
    allConfigs.forEach(config => {
        const optionLeft = document.createElement('option');
        optionLeft.value = config.id;
        optionLeft.textContent = config.name;
        leftSelect.appendChild(optionLeft);

        const optionRight = document.createElement('option');
        optionRight.value = config.id;
        optionRight.textContent = config.name;
        rightSelect.appendChild(optionRight);
    });

    // Reset to placeholder state
    resetCompareColumn('left');
    resetCompareColumn('right');

    // Hide data rows
    document.querySelector('.compare-row-source').classList.add('hidden');
    document.querySelector('.compare-row-buyer').classList.add('hidden');
    document.querySelector('.compare-row-product').classList.add('hidden');

    // Reset state
    compareLeftConfig = null;
    compareRightConfig = null;

    // Show modal
    document.getElementById('compareModal').classList.remove('hidden');
}

function closeCompareModal() {
    document.getElementById('compareModal').classList.add('hidden');
    compareLeftConfig = null;
    compareRightConfig = null;
}

function resetCompareColumn(side) {
    const prefix = side === 'left' ? 'compareLeft' : 'compareRight';

    document.getElementById(`${prefix}Header`).innerHTML = `
        <div class="flex items-center justify-center h-full text-gray-400 py-4">
            <span>Select a feature set</span>
        </div>
    `;
    document.getElementById(`${prefix}Source`).innerHTML = '';
    document.getElementById(`${prefix}Buyer`).innerHTML = '';
    document.getElementById(`${prefix}Product`).innerHTML = '';
}

function onCompareSelectChange(side) {
    const selectId = side === 'left' ? 'compareLeftSelect' : 'compareRightSelect';
    const configId = document.getElementById(selectId).value;

    if (!configId) {
        // Reset this side
        resetCompareColumn(side);
        if (side === 'left') compareLeftConfig = null;
        else compareRightConfig = null;
        updateCompareRowVisibility();
        return;
    }

    // Show loading state in header
    const prefix = side === 'left' ? 'compareLeft' : 'compareRight';
    document.getElementById(`${prefix}Header`).innerHTML = `
        <div class="flex items-center justify-center h-full text-gray-400 py-4">
            <i class="fas fa-spinner fa-spin mr-2"></i>Loading...
        </div>
    `;

    // Fetch config data
    fetch(`/api/feature-configs/${configId}/`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                if (side === 'left') compareLeftConfig = data.data;
                else compareRightConfig = data.data;
                renderCompareColumn(data.data, side);
                updateCompareRowVisibility();
            } else {
                document.getElementById(`${prefix}Header`).innerHTML = `
                    <div class="flex items-center justify-center h-full text-red-400 py-4">
                        <span>Failed to load</span>
                    </div>
                `;
            }
        })
        .catch(err => {
            console.error('Error loading config for compare:', err);
            document.getElementById(`${prefix}Header`).innerHTML = `
                <div class="flex items-center justify-center h-full text-red-400 py-4">
                    <span>Error loading</span>
                </div>
            `;
        });
}

function updateCompareRowVisibility() {
    // Show rows only if at least one side has data
    const hasData = compareLeftConfig || compareRightConfig;
    document.querySelector('.compare-row-source').classList.toggle('hidden', !hasData);
    document.querySelector('.compare-row-buyer').classList.toggle('hidden', !hasData);
    document.querySelector('.compare-row-product').classList.toggle('hidden', !hasData);
}

function renderCompareColumn(config, side) {
    const prefix = side === 'left' ? 'compareLeft' : 'compareRight';

    // Calculate tensor breakdowns
    const buyerResult = calculateTensorBreakdown(
        config.buyer_model_features || [],
        config.buyer_model_crosses || []
    );
    const productResult = calculateTensorBreakdown(
        config.product_model_features || [],
        config.product_model_crosses || []
    );

    // Build dataset info
    const datasetInfo = config.dataset_info || {};

    // Render Header
    document.getElementById(`${prefix}Header`).innerHTML = `
        <h4 class="font-semibold text-gray-900">${escapeHtml(config.name)}</h4>
        <div class="text-sm text-gray-500">Dataset: ${escapeHtml(config.dataset_name)}</div>
    `;

    // Render Source
    document.getElementById(`${prefix}Source`).innerHTML = buildCompareSourceHtml(datasetInfo);

    // Render Buyer Tensor
    document.getElementById(`${prefix}Buyer`).innerHTML = `
        <div class="p-3 bg-blue-50 rounded-lg">
            <div class="flex items-center justify-between mb-2">
                <h5 class="font-semibold text-blue-800 text-sm">Buyer Tensor</h5>
                <span class="font-semibold text-blue-600 text-sm">${buyerResult.total}D</span>
            </div>
            <div id="compare-${side}-buyer-bar" class="tensor-breakdown-bar mb-2"></div>
            <div class="space-y-1">
                ${buyerResult.breakdown.map(item => `
                    <div class="flex items-center justify-between text-xs">
                        <span class="${item.is_cross ? 'text-blue-600 italic' : 'text-blue-700'}">${item.name}</span>
                        <span class="text-blue-500 font-medium">${item.dim}D</span>
                    </div>
                `).join('')}
            </div>
        </div>
    `;

    // Render Product Tensor
    document.getElementById(`${prefix}Product`).innerHTML = `
        <div class="p-3 bg-green-50 rounded-lg">
            <div class="flex items-center justify-between mb-2">
                <h5 class="font-semibold text-green-800 text-sm">Product Tensor</h5>
                <span class="font-semibold text-green-600 text-sm">${productResult.total}D</span>
            </div>
            <div id="compare-${side}-product-bar" class="tensor-breakdown-bar mb-2"></div>
            <div class="space-y-1">
                ${productResult.breakdown.map(item => `
                    <div class="flex items-center justify-between text-xs">
                        <span class="${item.is_cross ? 'text-green-600 italic' : 'text-green-700'}">${item.name}</span>
                        <span class="text-green-500 font-medium">${item.dim}D</span>
                    </div>
                `).join('')}
            </div>
        </div>
    `;

    // Render tensor bars with proportional widths
    const maxTotal = Math.max(buyerResult.total || 0, productResult.total || 0);

    setTimeout(() => {
        const buyerBar = document.getElementById(`compare-${side}-buyer-bar`);
        const productBar = document.getElementById(`compare-${side}-product-bar`);
        if (buyerBar && buyerResult.breakdown.length > 0) {
            renderTensorPreview('buyer', buyerResult.total, buyerResult.breakdown, buyerBar, null, maxTotal);
        }
        if (productBar && productResult.breakdown.length > 0) {
            renderTensorPreview('product', productResult.total, productResult.breakdown, productBar, null, maxTotal);
        }
    }, 0);
}

/**
 * Build compact source info HTML for Compare modal
 */
function buildCompareSourceHtml(info) {
    if (!info || !info.primary_table) {
        return '<div class="p-3 bg-gray-100 rounded-lg text-sm text-gray-400 italic">No dataset info</div>';
    }

    // Build tables line
    const tables = [info.primary_table];
    (info.secondary_tables || []).forEach(t => {
        if (t) tables.push(t);
    });
    const tablesLine = tables.join(', ');

    // Build filters
    const filterBadges = [];
    if (info.filters?.dates) filterBadges.push(info.filters.dates);
    if (info.filters?.customers) filterBadges.push(info.filters.customers);
    if (info.filters?.products) filterBadges.push(info.filters.products);
    const filtersLine = filterBadges.length > 0
        ? filterBadges.join(' &bull; ')
        : '<span class="text-gray-400 italic">None</span>';

    // Row count
    const rowsBadge = info.estimated_rows
        ? `${info.estimated_rows.toLocaleString()} rows`
        : '';

    return `
        <div class="p-3 bg-gray-100 rounded-lg">
            <div class="flex items-center justify-between mb-2">
                <span class="font-medium text-gray-700 text-sm">
                    <i class="fas fa-database mr-1 text-gray-400"></i>Source
                </span>
                ${rowsBadge ? `<span class="text-xs font-medium text-gray-500">${rowsBadge}</span>` : ''}
            </div>
            <div class="space-y-1 text-xs">
                <div><span class="text-gray-500">Tables:</span> <span class="text-gray-700">${tablesLine}</span></div>
                <div><span class="text-gray-500">Filters:</span> <span class="text-gray-700">${filtersLine}</span></div>
            </div>
        </div>
    `;
}

/**
 * Build compact dataset info HTML for Compare modal columns (legacy - kept for compatibility)
 */
function buildCompareDatasetHtml(info) {
    if (!info || !info.primary_table) {
        return '<div class="mb-4 p-3 bg-gray-100 rounded-lg text-sm text-gray-400 italic">No dataset info</div>';
    }

    // Build tables line
    const tables = [info.primary_table];
    (info.secondary_tables || []).forEach(t => {
        if (t) tables.push(t);
    });
    const tablesLine = tables.join(', ');

    // Build filters
    const filterBadges = [];
    if (info.filters?.dates) filterBadges.push(info.filters.dates);
    if (info.filters?.customers) filterBadges.push(info.filters.customers);
    if (info.filters?.products) filterBadges.push(info.filters.products);
    const filtersLine = filterBadges.length > 0
        ? filterBadges.join(' &bull; ')
        : '<span class="text-gray-400 italic">None</span>';

    // Row count
    const rowsBadge = info.estimated_rows
        ? `${info.estimated_rows.toLocaleString()} rows`
        : '';

    return `
        <div class="mb-4 p-3 bg-gray-100 rounded-lg">
            <div class="flex items-center justify-between mb-2">
                <span class="font-medium text-gray-700 text-sm">
                    <i class="fas fa-database mr-1 text-gray-400"></i>Source
                </span>
                ${rowsBadge ? `<span class="text-xs font-medium text-gray-500">${rowsBadge}</span>` : ''}
            </div>
            <div class="space-y-1 text-xs">
                <div><span class="text-gray-500">Tables:</span> <span class="text-gray-700">${tablesLine}</span></div>
                <div><span class="text-gray-500">Filters:</span> <span class="text-gray-700">${filtersLine}</span></div>
            </div>
        </div>
    `;
}

// =============================================================================
// CODE VIEWER FUNCTIONS
// =============================================================================

let currentCodeViewerConfigId = null;
let currentCodeData = { transform: '', trainer: '' };

// Transform Code Viewer
function viewTransformCode(configId, configName) {
    currentCodeViewerConfigId = configId;
    document.getElementById('transformCodeConfigName').textContent = configName;

    // Clear previous content
    document.getElementById('transformCode').textContent = 'Loading...';
    document.getElementById('transformLineCount').textContent = '-';
    document.getElementById('transformCodeGeneratedAt').textContent = 'Loading...';

    // Reset validation badge
    updateValidationBadge('transform', 'checking');

    // Show modal
    document.getElementById('transformCodeViewerModal').classList.remove('hidden');

    // Fetch transform code
    fetch(`/api/feature-configs/${configId}/generated-code/?type=transform`)
        .then(r => r.json())
        .then(data => {
            if (data.success && data.data.code) {
                currentCodeData.transform = data.data.code;
                const highlighted = highlightPython(data.data.code);
                document.getElementById('transformCode').innerHTML = highlighted;
                const lineCount = data.data.code.split('\n').length;
                document.getElementById('transformLineCount').textContent = `${lineCount} lines`;
                updateValidationBadge('transform', data.data.is_valid ? 'valid' : 'invalid',
                                      data.data.validation_error, data.data.error_line);
            } else {
                currentCodeData.transform = '';
                document.getElementById('transformCode').innerHTML = '<span class="comment"># No transform code generated yet</span>';
                document.getElementById('transformLineCount').textContent = '0';
                updateValidationBadge('transform', 'valid');
            }

            if (data.data?.generated_at) {
                document.getElementById('transformCodeGeneratedAt').textContent = `Generated ${formatTimeAgo(data.data.generated_at)}`;
            } else {
                document.getElementById('transformCodeGeneratedAt').textContent = 'Not generated';
            }
        })
        .catch(err => {
            console.error('Error fetching transform code:', err);
            document.getElementById('transformCode').innerHTML = '<span class="comment"># Error loading code</span>';
            updateValidationBadge('transform', 'invalid', 'Failed to load code');
        });
}

function closeTransformCodeViewer() {
    document.getElementById('transformCodeViewerModal').classList.add('hidden');
}

function regenerateTransformCode() {
    if (!currentCodeViewerConfigId) return;

    const configName = document.getElementById('transformCodeConfigName').textContent;

    // Show loading state
    document.getElementById('transformCode').textContent = 'Regenerating...';
    updateValidationBadge('transform', 'checking');

    fetch(`/api/feature-configs/${currentCodeViewerConfigId}/regenerate-code/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ type: 'transform' })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            viewTransformCode(currentCodeViewerConfigId, configName);
            showSuccess('Transform code regenerated');
        } else {
            showError(data.error || 'Failed to regenerate code');
        }
    })
    .catch(err => {
        console.error('Error regenerating code:', err);
        showError('Failed to regenerate code');
    });
}

// Trainer Code Viewer
function viewTrainerCode(configId, configName) {
    currentCodeViewerConfigId = configId;
    document.getElementById('trainerCodeConfigName').textContent = configName;

    // Clear previous content
    document.getElementById('trainerCode').textContent = 'Loading...';
    document.getElementById('trainerLineCount').textContent = '-';
    document.getElementById('trainerCodeGeneratedAt').textContent = 'Loading...';

    // Reset validation badge
    updateValidationBadge('trainer', 'checking');

    // Show modal
    document.getElementById('trainerCodeViewerModal').classList.remove('hidden');

    // Fetch trainer code
    fetch(`/api/feature-configs/${configId}/generated-code/?type=trainer`)
        .then(r => r.json())
        .then(data => {
            if (data.success && data.data.code) {
                currentCodeData.trainer = data.data.code;
                const highlighted = highlightPython(data.data.code);
                document.getElementById('trainerCode').innerHTML = highlighted;
                const lineCount = data.data.code.split('\n').length;
                document.getElementById('trainerLineCount').textContent = `${lineCount} lines`;
                updateValidationBadge('trainer', data.data.is_valid ? 'valid' : 'invalid',
                                      data.data.validation_error, data.data.error_line);
            } else {
                currentCodeData.trainer = '';
                document.getElementById('trainerCode').innerHTML = '<span class="comment"># No trainer code generated yet</span>';
                document.getElementById('trainerLineCount').textContent = '0';
                updateValidationBadge('trainer', 'valid');
            }

            if (data.data?.generated_at) {
                document.getElementById('trainerCodeGeneratedAt').textContent = `Generated ${formatTimeAgo(data.data.generated_at)}`;
            } else {
                document.getElementById('trainerCodeGeneratedAt').textContent = 'Not generated';
            }
        })
        .catch(err => {
            console.error('Error fetching trainer code:', err);
            document.getElementById('trainerCode').innerHTML = '<span class="comment"># Error loading code</span>';
            updateValidationBadge('trainer', 'invalid', 'Failed to load code');
        });
}

function closeTrainerCodeViewer() {
    document.getElementById('trainerCodeViewerModal').classList.add('hidden');
}

function regenerateTrainerCode() {
    if (!currentCodeViewerConfigId) return;

    const configName = document.getElementById('trainerCodeConfigName').textContent;

    // Show loading state
    document.getElementById('trainerCode').textContent = 'Regenerating...';
    updateValidationBadge('trainer', 'checking');

    fetch(`/api/feature-configs/${currentCodeViewerConfigId}/regenerate-code/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ type: 'trainer' })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            viewTrainerCode(currentCodeViewerConfigId, configName);
            showSuccess('Trainer code regenerated');
        } else {
            showError(data.error || 'Failed to regenerate code');
        }
    })
    .catch(err => {
        console.error('Error regenerating code:', err);
        showError('Failed to regenerate code');
    });
}

// Trainer Code Selector (for Model Structure chapter)
function openTrainerCodeSelector() {
    // If no configs exist, show message
    if (!allConfigs || allConfigs.length === 0) {
        showError('No feature configs available. Create a feature config first.');
        return;
    }

    // If only one config, open it directly
    if (allConfigs.length === 1) {
        viewTrainerCode(allConfigs[0].id, allConfigs[0].name);
        return;
    }

    // Multiple configs - show selection dropdown
    const configOptions = allConfigs.map(c => `${c.name}`).join('\n');
    const selectedName = prompt(`Select a Feature Config to view Trainer code:\n\n${allConfigs.map((c, i) => `${i + 1}. ${c.name}`).join('\n')}\n\nEnter number:`);

    if (selectedName) {
        const index = parseInt(selectedName) - 1;
        if (index >= 0 && index < allConfigs.length) {
            viewTrainerCode(allConfigs[index].id, allConfigs[index].name);
        } else {
            showError('Invalid selection');
        }
    }
}

function updateValidationBadge(codeType, status, errorMsg = null, errorLine = null) {
    const badge = document.getElementById(`${codeType}ValidationBadge`);
    const errorBanner = document.getElementById(`${codeType}ValidationError`);
    const errorMsgEl = document.getElementById(`${codeType}ErrorMsg`);
    const errorLineEl = document.getElementById(`${codeType}ErrorLine`);

    // Update badge
    badge.classList.remove('valid', 'invalid', 'checking');
    badge.classList.add(status);

    if (status === 'valid') {
        badge.innerHTML = '<i class="fas fa-check-circle"></i> Valid';
        errorBanner.style.display = 'none';
    } else if (status === 'invalid') {
        badge.innerHTML = '<i class="fas fa-exclamation-circle"></i> Error';
        if (errorMsg) {
            errorMsgEl.textContent = errorMsg;
            errorLineEl.textContent = errorLine ? ` (line ${errorLine})` : '';
            errorBanner.style.display = 'flex';
        } else {
            errorBanner.style.display = 'none';
        }
    } else if (status === 'checking') {
        badge.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking';
        errorBanner.style.display = 'none';
    }
}

function highlightPython(code) {
    // Tokenization-based syntax highlighting to avoid regex conflicts
    // First, find all tokens and their positions, then build result

    const tokens = [];

    // Define token patterns (order matters for priority)
    const patterns = [
        // Triple-quoted strings (must come before single-line strings)
        { regex: /"""[\s\S]*?"""|'''[\s\S]*?'''/g, type: 'string' },
        // Comments
        { regex: /#[^\n]*/g, type: 'comment' },
        // Single and double quoted strings
        { regex: /'(?:[^'\\]|\\.)*'|"(?:[^"\\]|\\.)*"/g, type: 'string' },
        // Decorators
        { regex: /@\w+/g, type: 'decorator' },
        // Keywords (word boundaries)
        { regex: /\b(?:def|class|import|from|return|if|else|elif|for|while|try|except|finally|with|as|in|not|and|or|is|None|True|False|lambda|yield|raise|pass|break|continue|global|nonlocal|assert)\b/g, type: 'keyword' },
        // Builtins
        { regex: /\b(?:self|print|len|range|str|int|float|list|dict|tuple|set|type|isinstance|hasattr|getattr|setattr|super|property|staticmethod|classmethod|tf|tft|tfrs|logging|math)\b/g, type: 'builtin' },
        // Function calls and definitions
        { regex: /\b([a-zA-Z_]\w*)\s*(?=\()/g, type: 'function' },
        // Numbers
        { regex: /\b\d+\.?\d*\b/g, type: 'number' },
    ];

    // Find all tokens
    patterns.forEach(p => {
        let match;
        const regex = new RegExp(p.regex.source, 'g');
        while ((match = regex.exec(code)) !== null) {
            tokens.push({
                start: match.index,
                end: match.index + match[0].length,
                text: match[0],
                type: p.type
            });
        }
    });

    // Sort by start position
    tokens.sort((a, b) => a.start - b.start);

    // Remove overlapping tokens (keep first/higher priority)
    const filteredTokens = [];
    let lastEnd = 0;
    for (const token of tokens) {
        if (token.start >= lastEnd) {
            filteredTokens.push(token);
            lastEnd = token.end;
        }
    }

    // Build result
    let result = '';
    let pos = 0;

    for (const token of filteredTokens) {
        // Add unhighlighted text before this token
        if (token.start > pos) {
            result += escapeHtml(code.slice(pos, token.start));
        }
        // Add highlighted token
        result += `<span class="${token.type}">${escapeHtml(token.text)}</span>`;
        pos = token.end;
    }

    // Add remaining text
    if (pos < code.length) {
        result += escapeHtml(code.slice(pos));
    }

    return result;
}

function copyCode(type) {
    const code = currentCodeData[type];
    if (!code) {
        showError('No code to copy');
        return;
    }

    navigator.clipboard.writeText(code).then(() => {
        const btn = document.getElementById(type === 'transform' ? 'copyTransformBtn' : 'copyTrainerBtn');
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
        btn.classList.add('copied');

        setTimeout(() => {
            btn.innerHTML = originalHtml;
            btn.classList.remove('copied');
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy:', err);
        showError('Failed to copy code');
    });
}

function downloadCode(type) {
    const code = currentCodeData[type];
    if (!code) {
        showError('No code to download');
        return;
    }

    const filename = type === 'transform' ? 'preprocessing_fn.py' : 'trainer_module.py';
    const blob = new Blob([code], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function editConfig(configId) {
    openWizard(configId);
}

// Clone modal state
let cloneConfigId = null;

function cloneConfig(configId) {
    const config = allConfigs.find(c => c.id === configId);
    cloneConfigId = configId;

    // Pre-fill with suggested name
    const input = document.getElementById('cloneConfigName');
    input.value = `${config.name} (Copy)`;

    // Show modal
    document.getElementById('cloneConfigModal').classList.remove('hidden');

    // Focus input and select text
    setTimeout(() => {
        input.focus();
        input.select();
    }, 100);
}

function closeCloneModal() {
    document.getElementById('cloneConfigModal').classList.add('hidden');
    cloneConfigId = null;
}

function submitClone() {
    const newName = document.getElementById('cloneConfigName').value.trim();

    if (!newName) {
        showError('Please enter a name for the cloned config');
        return;
    }

    if (!cloneConfigId) {
        showError('No config selected for cloning');
        return;
    }

    fetch(`/api/feature-configs/${cloneConfigId}/clone/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({name: newName})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            closeCloneModal();
            loadConfigs();
            showSuccess('Config cloned successfully');
        } else {
            showError(data.error || 'Failed to clone');
        }
    });
}

function deleteConfig(configId, configName) {
    if (confirm(`Are you sure you want to delete "${configName}"?`)) {
        fetch(`/api/feature-configs/${configId}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrftoken
            }
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                loadConfigs();
                showSuccess('Config deleted');
            } else {
                showError(data.error || 'Failed to delete');
            }
        });
    }
}

// =============================================================================
// UTILITIES
// =============================================================================

function filterConfigs() {
    loadConfigs();
}

function debounceSearch() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        renderConfigs();
    }, 300);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatTimeAgo(isoString) {
    if (!isoString) return 'Unknown';
    const date = new Date(isoString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'just now';
    if (diffMins < 60) return `${diffMins} min ago`;
    if (diffHours < 24) return `${diffHours} hours ago`;
    if (diffDays < 7) return `${diffDays} days ago`;
    return date.toLocaleDateString();
}

function showError(message) {
    alert('Error: ' + message);
}

function showSuccess(message) {
    // Could use a toast notification here
    console.log('Success:', message);
}

// =============================================================================
// MODEL CONFIG FUNCTIONALITY
// =============================================================================

let allModelConfigs = [];
let mcCurrentStep = 1;
let editingModelConfigId = null;
let viewingModelConfig = null;
let presetsData = {};
let mcSearchTimeout = null;
let mcNameCheckTimeout = null;
let mcNameIsValid = false;
let mcCompareLeftConfig = null;  // Left side config in compare modal
let mcCompareRightConfig = null; // Right side config in compare modal

// Model Config State
let mcState = {
    modelType: 'retrieval',
    name: '',
    description: '',
    selectedPreset: 'standard',
    buyerTowerLayers: [],
    productTowerLayers: [],
    // Retrieval Algorithm Settings (for retrieval models)
    retrievalAlgorithm: 'brute_force',
    topK: 100,
    scannNumLeaves: 100,
    scannLeavesToSearch: 10,
    // Rating Head Settings (for ranking models)
    ratingHeadLayers: [],
    ratingHeadPreset: 'standard',
    lossFunction: 'mse',
    // Multitask Settings (for multitask models)
    retrievalWeight: 1.0,
    rankingWeight: 1.0,
    // Common settings
    outputEmbeddingDim: 32,
    optimizer: 'adagrad',
    learningRate: 0.1,
    batchSize: 4096
};

// Load Model Configs
function loadModelConfigs() {
    document.getElementById('modelConfigsLoading').classList.remove('hidden');
    document.getElementById('modelConfigsEmpty').classList.add('hidden');
    document.getElementById('modelConfigsNoResults').classList.add('hidden');
    document.getElementById('modelConfigsGrid').classList.add('hidden');
    document.getElementById('mcFilterBar').classList.add('hidden');

    fetch('/api/model-configs/?include_details=true')
        .then(r => r.json())
        .then(data => {
            document.getElementById('modelConfigsLoading').classList.add('hidden');
            if (data.success) {
                allModelConfigs = data.data;
                // Cache for QuickTest dropdown
                window.modelConfigsCache = data.data;
                renderModelConfigs();
            } else {
                console.error('Error loading model configs:', data.error);
            }
        })
        .catch(err => {
            document.getElementById('modelConfigsLoading').classList.add('hidden');
            console.error('Error loading model configs:', err);
        });
}

// Filter Model Configs
function filterModelConfigs() {
    renderModelConfigs();
}

// Debounced search for Model Configs
function debounceMcSearch() {
    clearTimeout(mcSearchTimeout);
    mcSearchTimeout = setTimeout(() => {
        filterModelConfigs();
    }, 300);
}

// Get filtered model configs based on current filter settings
function getFilteredModelConfigs() {
    const typeFilter = document.getElementById('mcModelTypeFilter').value;
    const searchTerm = document.getElementById('mcSearchInput').value.toLowerCase().trim();

    let filtered = allModelConfigs;

    // Apply model type filter
    if (typeFilter) {
        filtered = filtered.filter(mc => mc.model_type === typeFilter);
    }

    // Apply search filter
    if (searchTerm) {
        filtered = filtered.filter(mc =>
            mc.name.toLowerCase().includes(searchTerm) ||
            (mc.description && mc.description.toLowerCase().includes(searchTerm))
        );
    }

    return filtered;
}

// Parse tower summary string (e.g., "1286432") into layer array
function parseTowerSummary(summary) {
    if (!summary || summary === 'Empty') return [];

    // Split by arrow characters ( or ->)
    const units = summary.split(/|->/).map(s => parseInt(s.trim())).filter(n => !isNaN(n));

    // Convert to layer objects
    return units.map(u => ({
        type: 'dense',
        units: u,
        activation: 'relu'
    }));
}

// Render aligned tower layers for model config card (wizard-like style matching Step 2)
// Placeholders are inserted before the output layer to keep output layers aligned at bottom
function renderCardTowerLayers(buyerLayers, productLayers) {
    const maxLen = Math.max(buyerLayers.length, productLayers.length);
    if (maxLen === 0) {
        return {
            buyer: '<div class="text-xs text-gray-400 italic p-2">No layers</div>',
            product: '<div class="text-xs text-gray-400 italic p-2">No layers</div>'
        };
    }

    const renderLayer = (layer, isOutput) => {
        let badge = '';
        let params = '';

        if (layer.type === 'dense') {
            badge = '<span class="card-layer-badge dense">Dense</span>';
            params = `${layer.units} units`;
            if (layer.activation) params += `, ${layer.activation}`;
            if (layer.l2_regularization) params += `, L2=${layer.l2_regularization}`;
            else if (layer.l2_reg) params += `, L2=${layer.l2_reg}`;
        } else if (layer.type === 'dropout') {
            badge = '<span class="card-layer-badge dropout">Dropout</span>';
            params = `rate: ${layer.rate}`;
        } else if (layer.type === 'batch_norm') {
            badge = '<span class="card-layer-badge batch_norm">BatchNorm</span>';
            params = '';
        } else if (layer.type === 'layer_norm') {
            badge = '<span class="card-layer-badge layer_norm">LayerNorm</span>';
            params = layer.epsilon ? `: ${layer.epsilon}` : '';
        }

        // View-only mode: drag handle | badge | params (no action buttons)
        return `
            <div class="card-layer-item${isOutput ? ' output-layer' : ''}">
                <span class="card-drag-handle"><i class="fas fa-grip-vertical"></i></span>
                ${badge}
                <span class="card-layer-params">${params}</span>
            </div>
        `;
    };

    const renderPlaceholder = () => '<div class="card-layer-item empty-placeholder">&nbsp;</div>';

    // Build tower HTML with placeholders inserted before output layer
    const buildTowerHtml = (layers, placeholderCount) => {
        if (layers.length === 0) return '';

        const result = [];
        // All layers except the last (output layer)
        for (let i = 0; i < layers.length - 1; i++) {
            result.push(renderLayer(layers[i], false));
        }
        // Insert placeholders before output layer
        for (let i = 0; i < placeholderCount; i++) {
            result.push(renderPlaceholder());
        }
        // Output layer (last layer)
        result.push(renderLayer(layers[layers.length - 1], true));

        return result.join('');
    };

    const buyerPlaceholders = maxLen - buyerLayers.length;
    const productPlaceholders = maxLen - productLayers.length;

    return {
        buyer: buildTowerHtml(buyerLayers, buyerPlaceholders),
        product: buildTowerHtml(productLayers, productPlaceholders)
    };
}

// Render Tower Stack (vertical layer visualization) - for View modal
function renderTowerStack(layers, tower) {
    if (!layers || layers.length === 0) {
        return '<div class="text-xs text-gray-400 italic p-2">No layers</div>';
    }

    return layers.map((layer, idx) => {
        let typeClass = layer.type || 'dense';
        let layerLabel = '';
        let params = '';

        if (layer.type === 'dense') {
            layerLabel = 'Dense';
            params = `${layer.units}`;
            if (layer.activation) {
                params += `, ${layer.activation}`;
            }
        } else if (layer.type === 'dropout') {
            layerLabel = 'Dropout';
            params = `${(layer.rate * 100).toFixed(0)}%`;
        } else if (layer.type === 'batch_norm') {
            layerLabel = 'BatchNorm';
            params = '';
        } else if (layer.type === 'layer_norm') {
            layerLabel = 'LayerNorm';
            params = layer.epsilon ? `=${layer.epsilon}` : '';
        } else {
            layerLabel = layer.type;
            params = '';
        }

        const isLast = idx === layers.length - 1;
        return `
            <div class="tower-layer ${isLast ? tower : ''}">
                <span class="layer-type ${typeClass}">${layerLabel}</span>
                <span class="layer-params">${params}</span>
            </div>
        `;
    }).join('');
}

// Get compact tower text representation for card display (e.g., "Dense  Dense  Dense")
function getCompactTowerText(layers) {
    if (!layers || layers.length === 0) {
        return '<span class="text-gray-400 italic">No layers</span>';
    }

    const typeLabels = {
        'dense': 'Dense',
        'dropout': 'Drop',
        'batch_norm': 'BN',
        'layer_norm': 'LN'
    };

    return layers.map(layer => {
        const label = typeLabels[layer.type] || layer.type;
        return `<span class="compact-layer-type ${layer.type}">${label}</span>`;
    }).join('<span class="layer-arrow"></span>');
}

// Calculate parameters for a single tower (for layer bar display)
function calculateSingleTowerParams(layers, inputDim = 100) {
    let params = 0;
    let prevDim = inputDim;
    for (const layer of layers) {
        if (layer.type === 'dense') {
            // Dense layer: input_dim * units + units (bias)
            params += prevDim * layer.units + layer.units;
            prevDim = layer.units;
        } else if (layer.type === 'batch_norm') {
            // BatchNorm: 4 params per feature (gamma, beta, moving_mean, moving_var)
            params += prevDim * 4;
        } else if (layer.type === 'layer_norm') {
            // LayerNorm: 2 params per feature (gamma, beta)
            params += prevDim * 2;
        }
        // Dropout has no parameters
    }
    return params;
}

// Format parameter count for display
function formatParamCount(n) {
    if (n >= 1000000) return `${(n / 1000000).toFixed(1)}M`;
    if (n >= 1000) return `${(n / 1000).toFixed(1)}K`;
    return n.toString();
}

// Render layer bar visualization (tensor-bar style for model layers)
// maxTotalUnits: max total units across both towers (for proportional bar width)
function renderLayerBar(tower, layers, container, maxTotalUnits = null) {
    if (!container) return;
    container.innerHTML = '';

    if (!layers || layers.length === 0) {
        container.innerHTML = '<div class="text-gray-400 text-xs italic p-2">No layers</div>';
        return;
    }

    // Calculate total units from dense layers in this tower
    const towerTotal = layers
        .filter(l => l.type === 'dense')
        .reduce((sum, l) => sum + (l.units || 32), 0);

    // Set container width proportional to this tower's total vs max total
    if (maxTotalUnits && maxTotalUnits > 0) {
        const widthPercent = (towerTotal / maxTotalUnits) * 100;
        container.style.width = `${widthPercent}%`;
    }

    // Color palettes for vanishing gradient effect (matching tensor breakdown bars)
    const buyerColors = ['#3b82f6', '#60a5fa', '#93c5fd', '#bfdbfe', '#dbeafe'];
    const productColors = ['#10b981', '#34d399', '#6ee7b7', '#a7f3d0', '#d1fae5'];
    const rankingColors = ['#8b5cf6', '#a78bfa', '#c4b5fd', '#ddd6fe', '#ede9fe'];
    let colors;
    if (tower === 'buyer') colors = buyerColors;
    else if (tower === 'product') colors = productColors;
    else colors = rankingColors;

    // Find last dense layer index (output layer)
    let lastDenseIdx = -1;
    for (let i = layers.length - 1; i >= 0; i--) {
        if (layers[i].type === 'dense') {
            lastDenseIdx = i;
            break;
        }
    }

    // Track dense layer index for color assignment
    let denseLayerIdx = 0;

    layers.forEach((layer, idx) => {
        const segment = document.createElement('div');
        const isOutput = (layer.type === 'dense' && idx === lastDenseIdx);

        if (layer.type === 'dense') {
            const units = layer.units || 32;
            // Use flex-grow proportional to units within this tower
            const flexGrow = units / towerTotal;
            segment.className = `layer-bar-segment dense ${tower}${isOutput ? ' output-layer' : ''}`;
            segment.style.flex = `${flexGrow} 0 0`;
            segment.style.minWidth = '24px';
            // Apply vanishing gradient color from palette
            segment.style.background = colors[denseLayerIdx % colors.length];
            segment.title = `Dense: ${units} units${layer.activation ? ', ' + layer.activation : ''}${isOutput ? ' (Output)' : ''}`;

            // Always show units
            segment.innerHTML = `<span class="layer-units">${units}</span>`;
            denseLayerIdx++;
        } else if (layer.type === 'dropout') {
            segment.className = 'layer-bar-segment dropout';
            segment.style.flex = '0 0 20px';
            segment.title = `Dropout: rate=${layer.rate || 0.2}`;
            segment.innerHTML = '<span class="layer-label-small">D</span>';
        } else if (layer.type === 'batch_norm') {
            segment.className = 'layer-bar-segment batch_norm';
            segment.style.flex = '0 0 24px';
            segment.title = 'Batch Normalization';
            segment.innerHTML = '<span class="layer-label-small">BN</span>';
        } else if (layer.type === 'layer_norm') {
            segment.className = 'layer-bar-segment layer_norm';
            segment.style.flex = '0 0 24px';
            segment.title = `Layer Normalization${layer.epsilon ? ', =' + layer.epsilon : ''}`;
            segment.innerHTML = '<span class="layer-label-small">LN</span>';
        }

        container.appendChild(segment);
    });
}

// Calculate total dense units for a tower
function calculateTotalDenseUnits(layers) {
    return (layers || [])
        .filter(l => l.type === 'dense')
        .reduce((sum, l) => sum + (l.units || 32), 0);
}

// Calculate max total units across both towers (for proportional bar widths)
function calculateMaxTotalUnits(buyerLayers, productLayers) {
    const buyerTotal = calculateTotalDenseUnits(buyerLayers);
    const productTotal = calculateTotalDenseUnits(productLayers);
    return Math.max(buyerTotal, productTotal);
}

// Generate tower visualization HTML for model config cards
// Now accepts featureSetDim as input dimension for accurate parameter calculation
function generateTowerVisualizationHtml(tower, layers, featureSetDim = 100) {
    const params = calculateSingleTowerParams(layers, featureSetDim);
    const formattedParams = formatParamCount(params);
    const containerId = `tower-bar-${tower}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

    // Determine label based on tower type
    let label = 'BUYER';
    if (tower === 'product') label = 'PRODUCT';
    else if (tower === 'ranking') label = 'RANKING';

    return {
        html: `
            <div class="tower-visualization">
                <div class="tower-visualization-header">
                    <span class="tower-visualization-label ${tower}">${label}</span>
                    <span class="tower-params-badge ${tower}">~${formattedParams} params</span>
                </div>
                <div class="layer-bar-container" id="${containerId}"></div>
            </div>
        `,
        containerId: containerId,
        layers: layers,
        tower: tower,
        featureSetDim: featureSetDim
    };
}

// Calculate model parameter summary
function calculateModelSummary(mc) {
    // Estimate parameters based on layer configurations
    // This is a simplified estimation for display purposes
    let totalParams = 0;
    let trainableParams = 0;

    const estimateTowerParams = (layers, inputDim = 100) => {
        let params = 0;
        let prevDim = inputDim;
        for (const layer of layers) {
            if (layer.type === 'dense') {
                // Dense layer: input_dim * units + units (bias)
                params += prevDim * layer.units + layer.units;
                prevDim = layer.units;
            } else if (layer.type === 'batch_norm') {
                // BatchNorm: 4 params per feature (gamma, beta, moving_mean, moving_var)
                params += prevDim * 4;
            } else if (layer.type === 'layer_norm') {
                // LayerNorm: 2 params per feature (gamma, beta)
                params += prevDim * 2;
            }
            // Dropout has no parameters
        }
        return params;
    };

    // Get layers from the full config if available
    const buyerLayers = mc.buyer_tower_layers || [];
    const productLayers = mc.product_tower_layers || [];

    if (buyerLayers.length > 0 || productLayers.length > 0) {
        totalParams = estimateTowerParams(buyerLayers, 100) + estimateTowerParams(productLayers, 50);
        trainableParams = totalParams;
    } else {
        // Fallback: estimate from summary string (e.g., "1286432")
        const estimateFromSummary = (summary, inputDim = 100) => {
            if (!summary || summary === 'Empty') return 0;
            const units = summary.split('').map(n => parseInt(n)).filter(n => !isNaN(n));
            let params = 0;
            let prevDim = inputDim;
            for (const u of units) {
                params += prevDim * u + u;
                prevDim = u;
            }
            return params;
        };
        totalParams = estimateFromSummary(mc.buyer_tower_summary, 100) +
                      estimateFromSummary(mc.product_tower_summary, 50);
        trainableParams = totalParams;
    }

    // Format the number
    const formatParams = (n) => {
        if (n >= 1000000) return `${(n / 1000000).toFixed(1)}M`;
        if (n >= 1000) return `${(n / 1000).toFixed(1)}K`;
        return n.toString();
    };

    return {
        total: formatParams(totalParams),
        trainable: formatParams(trainableParams),
        nonTrainable: '0'
    };
}

// Format time ago for model configs
function formatMcTimeAgo(isoString) {
    if (!isoString) return '';
    const date = new Date(isoString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'just now';
    if (diffMins < 60) return `${diffMins} min ago`;
    if (diffHours < 24) return `${diffHours} hours ago`;
    if (diffDays === 1) return 'yesterday';
    if (diffDays < 30) return `${diffDays} days ago`;
    return date.toLocaleDateString();
}

// Show toast notification
function showMcToast(message, type = 'info') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 text-white text-sm font-medium transition-opacity duration-300`;
    toast.style.backgroundColor = type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#6b7280';
    toast.textContent = message;
    document.body.appendChild(toast);

    // Remove after 3 seconds
    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Render Model Config Cards
function renderModelConfigs() {
    const grid = document.getElementById('modelConfigsGrid');
    const empty = document.getElementById('modelConfigsEmpty');
    const noResults = document.getElementById('modelConfigsNoResults');
    const filterBar = document.getElementById('mcFilterBar');

    // If no configs at all, show empty state and hide filter bar
    if (allModelConfigs.length === 0) {
        empty.classList.remove('hidden');
        noResults.classList.add('hidden');
        grid.classList.add('hidden');
        filterBar.classList.add('hidden');
        return;
    }

    // Show filter bar when there are configs
    filterBar.classList.remove('hidden');

    // Get filtered results
    const filtered = getFilteredModelConfigs();

    // If no results after filtering, show no results state
    if (filtered.length === 0) {
        empty.classList.add('hidden');
        noResults.classList.remove('hidden');
        grid.classList.add('hidden');
        return;
    }

    empty.classList.add('hidden');
    noResults.classList.add('hidden');
    grid.classList.remove('hidden');

    grid.innerHTML = filtered.map(mc => {
        const summary = calculateModelSummary(mc);
        const descTruncated = mc.description && mc.description.length > 80
            ? mc.description.substring(0, 80) + '...'
            : mc.description;

        // Get layers for layer bar visualization
        const buyerLayers = mc.buyer_tower_layers && mc.buyer_tower_layers.length > 0
            ? mc.buyer_tower_layers
            : parseTowerSummary(mc.buyer_tower_summary);

        const productLayers = mc.product_tower_layers && mc.product_tower_layers.length > 0
            ? mc.product_tower_layers
            : parseTowerSummary(mc.product_tower_summary);

        // Get ranking layers if this is a ranking or multitask model
        const rankingLayers = (mc.model_type === 'ranking' || mc.model_type === 'multitask') && mc.rating_head_layers && mc.rating_head_layers.length > 0
            ? mc.rating_head_layers
            : [];

        // Calculate max total units across all towers for proportional bar widths
        const maxTotalUnits = calculateMaxTotalUnits(buyerLayers, productLayers);
        // For ranking model, also consider ranking layers for max units
        const rankingTotalUnits = rankingLayers.length > 0 ? calculateTotalDenseUnits(rankingLayers) : 0;
        const overallMaxUnits = Math.max(maxTotalUnits, rankingTotalUnits);

        // Use same input dimension (100) for both towers for consistent parameter estimation
        // In reality, input dim depends on feature set, but we use 100 as default estimate
        const inputDim = 100;
        // For ranking head, input is concatenated embeddings (output_embedding_dim * 2)
        const rankingInputDim = (mc.output_embedding_dim || 32) * 2;

        // Generate tower visualization with unique IDs
        const buyerViz = generateTowerVisualizationHtml('buyer', buyerLayers, inputDim);
        const productViz = generateTowerVisualizationHtml('product', productLayers, inputDim);
        const rankingViz = rankingLayers.length > 0
            ? generateTowerVisualizationHtml('ranking', rankingLayers, rankingInputDim)
            : null;

        return `
        <div class="model-config-card" onclick="viewModelConfig(${mc.id})"
             data-buyer-bar-id="${buyerViz.containerId}"
             data-product-bar-id="${productViz.containerId}"
             ${rankingViz ? `data-ranking-bar-id="${rankingViz.containerId}"` : ''}
             data-buyer-layers='${JSON.stringify(buyerLayers)}'
             data-product-layers='${JSON.stringify(productLayers)}'
             ${rankingLayers.length > 0 ? `data-ranking-layers='${JSON.stringify(rankingLayers)}'` : ''}
             data-max-total-units="${overallMaxUnits}">
            <!-- Header: Name & Actions -->
            <div class="model-config-card-header">
                <div style="flex: 1; min-width: 0;">
                    <div class="model-config-name">${escapeHtml(mc.name)}</div>
                    ${descTruncated ? `<div class="model-config-desc">${escapeHtml(descTruncated)}</div>` : ''}
                    <div class="model-config-meta">Updated ${formatMcTimeAgo(mc.updated_at)}${mc.created_by ? ` by ${mc.created_by}` : ''}</div>
                </div>
                <div class="flex items-center gap-2" onclick="event.stopPropagation()">
                    <div class="model-config-actions">
                        <button class="mc-action-btn view" onclick="viewModelConfig(${mc.id})" title="View">
                            View
                        </button>
                        <button class="mc-action-btn edit" onclick="editModelConfigById(${mc.id})" title="Edit">
                            <i class="fas fa-external-link-alt"></i>
                        </button>
                        <button class="mc-action-btn delete" onclick="deleteModelConfig(${mc.id})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Row 1: Tower Layer Bar Visualizations (Buyer | Product) -->
            <div class="towers-grid">
                ${buyerViz.html}
                ${productViz.html}
            </div>

            <!-- Row 2: For Ranking/Multitask models - Hyperparams | Ranking bar -->
            ${rankingViz ? `
            <div class="ranking-row-grid">
                <!-- Left: Model Type & Training Params -->
                <div class="training-params-preview ranking-layout">
                    <div class="param-chip model-type-chip ${mc.model_type}">
                        <span class="param-chip-value">${mc.model_type_display}</span>
                    </div>
                    <div class="param-chip">
                        <span class="param-chip-label">Opt:</span>
                        <span class="param-chip-value">${mc.optimizer_display}</span>
                    </div>
                    <div class="param-chip">
                        <span class="param-chip-label">LR:</span>
                        <span class="param-chip-value">${mc.learning_rate}</span>
                    </div>
                    <div class="param-chip">
                        <span class="param-chip-label">Batch:</span>
                        <span class="param-chip-value">${mc.batch_size}</span>
                    </div>
                    <div class="param-chip">
                        <span class="param-chip-label">Loss:</span>
                        <span class="param-chip-value">${mc.loss_function_display || 'MSE'}</span>
                    </div>
                    ${mc.model_type === 'multitask' ? `
                    <div class="param-chip multitask-weights">
                        <span class="param-chip-label">Weights:</span>
                        <span class="param-chip-value">Ret ${mc.retrieval_weight || 1.0} / Rank ${mc.ranking_weight || 1.0}</span>
                    </div>
                    <div class="param-chip">
                        <span class="param-chip-label">Top N:</span>
                        <span class="param-chip-value">${mc.top_k || 100}</span>
                    </div>
                    ` : ''}
                </div>
                <!-- Right: Ranking bar -->
                <div class="ranking-tower-cell">
                    ${rankingViz.html}
                </div>
            </div>
            ` : `
            <!-- For Retrieval models - just hyperparams row -->
            <div class="training-params-preview">
                <div class="param-chip model-type-chip ${mc.model_type}">
                    <span class="param-chip-value">${mc.model_type_display}</span>
                </div>
                <div class="param-chip">
                    <span class="param-chip-label">Opt:</span>
                    <span class="param-chip-value">${mc.optimizer_display}</span>
                </div>
                <div class="param-chip">
                    <span class="param-chip-label">LR:</span>
                    <span class="param-chip-value">${mc.learning_rate}</span>
                </div>
                <div class="param-chip">
                    <span class="param-chip-label">Batch:</span>
                    <span class="param-chip-value">${mc.batch_size}</span>
                </div>
                <div class="param-chip">
                    <span class="param-chip-label">Top N:</span>
                    <span class="param-chip-value">${mc.top_k || 100}</span>
                </div>
                <div class="param-chip">
                    <span class="param-chip-label">Algorithm:</span>
                    <span class="param-chip-value">${mc.retrieval_algorithm_display || 'Brute Force'}</span>
                </div>
            </div>
            `}

            <!-- Footer: Clone button (Code is generated at runtime when combined with FeatureConfig) -->
            <div class="flex items-center gap-2 mt-3 pt-3 border-t border-gray-100" onclick="event.stopPropagation()">
                <button onclick="cloneModelConfigById(${mc.id})" class="btn btn-secondary btn-sm" style="width: 150px;" title="Clone this config">
                    <i class="fas fa-copy"></i>Clone
                </button>
            </div>
        </div>
        `;
    }).join('');

    // Render layer bars after HTML is in DOM
    setTimeout(() => {
        document.querySelectorAll('.model-config-card').forEach(card => {
            const buyerBarId = card.dataset.buyerBarId;
            const productBarId = card.dataset.productBarId;
            const rankingBarId = card.dataset.rankingBarId;
            const buyerLayers = JSON.parse(card.dataset.buyerLayers || '[]');
            const productLayers = JSON.parse(card.dataset.productLayers || '[]');
            const rankingLayers = card.dataset.rankingLayers ? JSON.parse(card.dataset.rankingLayers) : [];
            const maxTotalUnits = parseInt(card.dataset.maxTotalUnits) || 416;

            const buyerContainer = document.getElementById(buyerBarId);
            const productContainer = document.getElementById(productBarId);
            const rankingContainer = rankingBarId ? document.getElementById(rankingBarId) : null;

            if (buyerContainer) {
                renderLayerBar('buyer', buyerLayers, buyerContainer, maxTotalUnits);
            }
            if (productContainer) {
                renderLayerBar('product', productLayers, productContainer, maxTotalUnits);
            }
            if (rankingContainer && rankingLayers.length > 0) {
                // Ranking bar: use same maxTotalUnits for proportional width relative to other bars
                renderLayerBar('ranking', rankingLayers, rankingContainer, maxTotalUnits);
            }
        });
    }, 0);
}

// Edit Model Config by ID (opens wizard in edit mode)
function editModelConfigById(id) {
    // Fetch full config and open wizard
    fetch(`/api/model-configs/${id}/`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const mc = data.data;
                editingModelConfigId = mc.id;
                mcCurrentStep = 1;

                // Populate state from config
                mcState.modelType = mc.model_type;
                mcState.name = mc.name;
                mcState.description = mc.description || '';
                mcState.buyerTowerLayers = mc.buyer_tower_layers || [];
                mcState.productTowerLayers = mc.product_tower_layers || [];
                mcState.outputEmbeddingDim = mc.output_embedding_dim || 32;
                mcState.retrievalAlgorithm = mc.retrieval_algorithm || 'brute_force';
                mcState.topK = mc.top_k || 100;
                mcState.scannNumLeaves = mc.scann_num_leaves || 100;
                mcState.scannLeavesToSearch = mc.scann_leaves_to_search || 10;
                mcState.optimizer = mc.optimizer || 'adagrad';
                mcState.learningRate = mc.learning_rate || 0.1;
                mcState.batchSize = mc.batch_size || 4096;
                // Rating head settings (for ranking/multitask models)
                mcState.ratingHeadLayers = mc.rating_head_layers || [];
                mcState.lossFunction = mc.loss_function || 'mse';
                // Multitask settings
                mcState.retrievalWeight = mc.retrieval_weight !== undefined ? mc.retrieval_weight : 1.0;
                mcState.rankingWeight = mc.ranking_weight !== undefined ? mc.ranking_weight : 1.0;

                // Update wizard UI
                document.getElementById('mcName').value = mc.name;
                document.getElementById('mcDescription').value = mc.description || '';
                selectModelType(mc.model_type);
                selectRetrievalAlgorithm(mcState.retrievalAlgorithm);
                document.getElementById('mcTopK').value = mcState.topK;
                document.getElementById('mcScannTopK').value = mcState.topK;
                document.getElementById('mcScannNumLeaves').value = mcState.scannNumLeaves;
                document.getElementById('mcScannLeavesToSearch').value = mcState.scannLeavesToSearch;
                selectOptimizer(mcState.optimizer);
                setLearningRate(mcState.learningRate);
                document.getElementById('mcBatchSize').value = mcState.batchSize;

                // For ranking/multitask models, also select the loss function
                if (mc.model_type === 'ranking' || mc.model_type === 'multitask') {
                    selectLossFunction(mcState.lossFunction);
                }

                // For multitask models, populate weight sliders
                if (mc.model_type === 'multitask') {
                    const retSlider = document.getElementById('mcRetrievalWeight');
                    const rankSlider = document.getElementById('mcRankingWeight');
                    if (retSlider) {
                        retSlider.value = mcState.retrievalWeight;
                        document.getElementById('retrievalWeightValue').textContent = mcState.retrievalWeight.toFixed(1);
                    }
                    if (rankSlider) {
                        rankSlider.value = mcState.rankingWeight;
                        document.getElementById('rankingWeightValue').textContent = mcState.rankingWeight.toFixed(1);
                    }
                    updateMultitaskSummary();
                    updateMultitaskArchDiagram();
                }

                renderTowerLayers();
                updateTowerSummaries();

                // For ranking/multitask models, render the rating head layers
                if ((mc.model_type === 'ranking' || mc.model_type === 'multitask') && mcState.ratingHeadLayers.length > 0) {
                    renderRatingHeadLayers();
                    updateRatingHeadSummary();
                }

                // Mark name as valid since we're editing an existing config
                mcNameIsValid = true;

                document.getElementById('modelConfigWizardTitle').textContent = 'Edit Model Config';
                document.getElementById('modelConfigWizardModal').classList.remove('hidden');
                updateMcStep();
            }
        })
        .catch(err => console.error('Error loading model config for edit:', err));
}

// Open Model Config Wizard
function openModelConfigWizard() {
    editingModelConfigId = null;
    mcCurrentStep = 1;
    resetMcState();
    loadPresets();
    document.getElementById('modelConfigWizardTitle').textContent = 'Create Model Config';
    document.getElementById('modelConfigWizardModal').classList.remove('hidden');
    updateMcStep();
}

// Close Model Config Wizard
function closeModelConfigWizard() {
    document.getElementById('modelConfigWizardModal').classList.add('hidden');
}

// Reset Model Config State
function resetMcState() {
    mcState = {
        modelType: 'retrieval',
        name: '',
        description: '',
        selectedPreset: 'standard',
        buyerTowerLayers: [],
        productTowerLayers: [],
        outputEmbeddingDim: 32,
        // Retrieval Algorithm Settings
        retrievalAlgorithm: 'brute_force',
        topK: 100,
        scannNumLeaves: 100,
        scannLeavesToSearch: 10,
        // Rating Head Settings (for ranking/multitask models)
        ratingHeadLayers: [],
        ratingHeadPreset: 'standard',
        lossFunction: 'mse',
        // Multitask Settings (balanced start as default)
        retrievalWeight: 1.0,
        rankingWeight: 1.0,
        // Training params
        optimizer: 'adagrad',
        learningRate: 0.1,
        batchSize: 4096
    };
    document.getElementById('mcName').value = '';
    document.getElementById('mcDescription').value = '';
    selectModelType('retrieval');
    selectPreset('standard');
    // Reset retrieval algorithm UI
    selectRetrievalAlgorithm('brute_force');
    document.getElementById('mcTopK').value = 100;
    document.getElementById('mcScannTopK').value = 100;
    document.getElementById('mcScannNumLeaves').value = 100;
    document.getElementById('mcScannLeavesToSearch').value = 10;
    // Reset training params UI
    selectOptimizer('adagrad');
    setLearningRate(0.1);
    document.getElementById('mcBatchSize').value = 4096;
    // Reset multitask weight sliders UI
    const retSlider = document.getElementById('mcRetrievalWeight');
    const rankSlider = document.getElementById('mcRankingWeight');
    if (retSlider) {
        retSlider.value = 1.0;
        document.getElementById('retrievalWeightValue').textContent = '1.0';
    }
    if (rankSlider) {
        rankSlider.value = 1.0;
        document.getElementById('rankingWeightValue').textContent = '1.0';
    }
    // Reset name validation state
    mcNameIsValid = false;
    resetMcNameValidation();
}

// Reset Model Config name validation UI
function resetMcNameValidation() {
    document.getElementById('mcNameStatus').classList.add('hidden');
    document.getElementById('mcNameSpinner').classList.add('hidden');
    document.getElementById('mcNameValid').classList.add('hidden');
    document.getElementById('mcNameInvalid').classList.add('hidden');
    document.getElementById('mcNameError').classList.add('hidden');
    document.getElementById('mcNameError').textContent = '';
    document.getElementById('mcName').classList.remove('border-red-500', 'border-green-500');
}

// Debounced Model Config name check
function debounceMcNameCheck() {
    clearTimeout(mcNameCheckTimeout);
    mcNameCheckTimeout = setTimeout(() => {
        checkMcNameAvailability();
    }, 400);
}

// Check Model Config name availability
function checkMcNameAvailability() {
    const name = document.getElementById('mcName').value.trim();
    const statusEl = document.getElementById('mcNameStatus');
    const spinnerEl = document.getElementById('mcNameSpinner');
    const validEl = document.getElementById('mcNameValid');
    const invalidEl = document.getElementById('mcNameInvalid');
    const errorEl = document.getElementById('mcNameError');
    const inputEl = document.getElementById('mcName');

    // Reset state
    statusEl.classList.add('hidden');
    spinnerEl.classList.add('hidden');
    validEl.classList.add('hidden');
    invalidEl.classList.add('hidden');
    errorEl.classList.add('hidden');
    inputEl.classList.remove('border-red-500', 'border-green-500');

    if (!name) {
        mcNameIsValid = false;
        return;
    }

    // Show spinner
    statusEl.classList.remove('hidden');
    spinnerEl.classList.remove('hidden');

    // Build URL with query params
    let url = `/api/model-configs/check-name/?name=${encodeURIComponent(name)}`;
    if (editingModelConfigId) {
        url += `&exclude_id=${editingModelConfigId}`;
    }

    fetch(url)
        .then(r => r.json())
        .then(data => {
            spinnerEl.classList.add('hidden');

            if (data.success && data.data.available) {
                // Name is available
                mcNameIsValid = true;
                validEl.classList.remove('hidden');
                inputEl.classList.add('border-green-500');
            } else {
                // Name is taken
                mcNameIsValid = false;
                invalidEl.classList.remove('hidden');
                inputEl.classList.add('border-red-500');
                errorEl.textContent = data.data?.message || 'This name is already taken';
                errorEl.classList.remove('hidden');
            }
        })
        .catch(err => {
            console.error('Error checking name:', err);
            spinnerEl.classList.add('hidden');
            mcNameIsValid = false;
        });
}

// Load Presets from API
function loadPresets() {
    fetch('/api/model-configs/presets/')
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                presetsData = data.data;
                applyPreset('standard');
            }
        })
        .catch(err => console.error('Error loading presets:', err));
}

// Select Model Type
function selectModelType(type) {
    if (type !== 'retrieval' && type !== 'ranking' && type !== 'multitask') return;

    mcState.modelType = type;
    document.querySelectorAll('.wizard-model-type-option').forEach(opt => {
        opt.classList.toggle('selected', opt.dataset.type === type);
    });

    // Show/hide sections based on model type
    const retrievalSection = document.querySelector('.retrieval-algorithm-section');
    const ratingHeadSection = document.getElementById('ratingHeadSection');
    const multitaskArchSection = document.getElementById('multitaskArchSection');
    const multitaskWeightSection = document.getElementById('multitaskWeightSection');

    if (type === 'retrieval') {
        if (retrievalSection) retrievalSection.classList.remove('hidden');
        if (ratingHeadSection) ratingHeadSection.classList.add('hidden');
        if (multitaskArchSection) multitaskArchSection.classList.add('hidden');
        if (multitaskWeightSection) multitaskWeightSection.classList.add('hidden');
    } else if (type === 'ranking') {
        if (retrievalSection) retrievalSection.classList.add('hidden');
        if (ratingHeadSection) ratingHeadSection.classList.remove('hidden');
        if (multitaskArchSection) multitaskArchSection.classList.add('hidden');
        if (multitaskWeightSection) multitaskWeightSection.classList.add('hidden');
        // Generate rating head from current tower preset if empty
        if (mcState.ratingHeadLayers.length === 0) {
            mcState.ratingHeadLayers = generateRatingHeadFromTower(mcState.buyerTowerLayers);
        }
        renderRatingHeadLayers();
        updateRatingHeadSummary();
    } else if (type === 'multitask') {
        // Multitask shows BOTH retrieval algorithm AND rating head
        if (retrievalSection) retrievalSection.classList.remove('hidden');
        if (ratingHeadSection) ratingHeadSection.classList.remove('hidden');
        if (multitaskArchSection) multitaskArchSection.classList.remove('hidden');
        if (multitaskWeightSection) multitaskWeightSection.classList.remove('hidden');
        // Generate rating head from current tower preset if empty
        if (mcState.ratingHeadLayers.length === 0) {
            mcState.ratingHeadLayers = generateRatingHeadFromTower(mcState.buyerTowerLayers);
        }
        renderRatingHeadLayers();
        updateRatingHeadSummary();
        updateMultitaskArchDiagram();
    }
}

// Select Preset
function selectPreset(preset) {
    mcState.selectedPreset = preset;
    document.querySelectorAll('.preset-option').forEach(opt => {
        opt.classList.toggle('selected', opt.dataset.preset === preset);
    });
    applyPreset(preset);
}

// Apply Preset Configuration
function applyPreset(presetName) {
    const preset = presetsData[presetName];
    if (!preset) return;

    mcState.buyerTowerLayers = JSON.parse(JSON.stringify(preset.buyer_tower_layers || []));
    mcState.productTowerLayers = JSON.parse(JSON.stringify(preset.product_tower_layers || []));
    mcState.outputEmbeddingDim = preset.output_embedding_dim || 32;

    // Generate Rating Head layers from tower preset (for ranking models)
    mcState.ratingHeadLayers = generateRatingHeadFromTower(preset.buyer_tower_layers || []);
    mcState.ratingHeadPreset = presetName;

    renderTowerLayers();
    updateTowerSummaries();

    // If ranking or multitask model is selected, also render rating head
    if (mcState.modelType === 'ranking' || mcState.modelType === 'multitask') {
        renderRatingHeadLayers();
        updateRatingHeadSummary();
    }

    // If multitask, also update the architecture diagram
    if (mcState.modelType === 'multitask') {
        updateMultitaskArchDiagram();
    }
}

// Generate Rating Head layers from tower layers
// Takes tower Dense layers, copies their structure with relu activation,
// and appends a final Dense(1) output layer with linear activation
function generateRatingHeadFromTower(towerLayers) {
    const ratingHeadLayers = [];

    // Extract Dense layers from tower (ignore dropout, batch_norm)
    for (const layer of towerLayers) {
        if (layer.type === 'dense') {
            ratingHeadLayers.push({
                type: 'dense',
                units: layer.units,
                activation: 'relu',
                l2_reg: 0.0  // No regularization by default
            });
        }
    }

    // Append final Dense(1) output layer with linear activation
    ratingHeadLayers.push({
        type: 'dense',
        units: 1,
        activation: null  // Linear activation for scalar output
    });

    return ratingHeadLayers;
}

// Select Optimizer (Step 3)
function selectOptimizer(optimizer) {
    mcState.optimizer = optimizer;

    // Update radio buttons
    document.querySelectorAll('input[name="mcOptimizer"]').forEach(radio => {
        radio.checked = radio.value === optimizer;
    });

    // Update visual selection
    document.querySelectorAll('.optimizer-option').forEach(opt => {
        const radio = opt.querySelector('input[type="radio"]');
        opt.classList.toggle('selected', radio && radio.value === optimizer);
    });

    // Suggest learning rate based on optimizer
    const lrSuggestions = {
        'adagrad': 0.1,
        'adam': 0.001,
        'sgd': 0.01,
        'rmsprop': 0.001,
        'adamw': 0.001,
        'ftrl': 0.1
    };

    if (lrSuggestions[optimizer]) {
        setLearningRate(lrSuggestions[optimizer]);
    }
}

// Select Loss Function (Step 3, for Ranking models)
function selectLossFunction(loss) {
    mcState.lossFunction = loss;

    // Update radio buttons
    document.querySelectorAll('input[name="mcLossFunction"]').forEach(radio => {
        radio.checked = radio.value === loss;
    });

    // Update visual selection
    document.querySelectorAll('.loss-option').forEach(opt => {
        const radio = opt.querySelector('input[type="radio"]');
        opt.classList.toggle('selected', radio && radio.value === loss);
    });

    // Update info text
    const infoTexts = {
        'mse': 'Best for continuous ratings (e.g., 1.0-5.0). Penalizes large prediction errors more heavily.',
        'binary_crossentropy': 'For binary outcomes (like/dislike, click/no-click). Use when rating is 0 or 1.',
        'huber': 'Robust to outliers. Combines MSE for small errors and MAE for large errors. Good when ratings have noise.'
    };

    const infoTextEl = document.getElementById('lossInfoText');
    if (infoTextEl) {
        const pEl = infoTextEl.querySelector('p');
        if (pEl) {
            pEl.textContent = infoTexts[loss] || infoTexts['mse'];
        }
    }
}

// Set Learning Rate (Step 3)
function setLearningRate(value) {
    mcState.learningRate = value;
    document.getElementById('mcLearningRate').value = value;

    // Update preset buttons
    document.querySelectorAll('.lr-preset-btn').forEach(btn => {
        const btnValue = parseFloat(btn.textContent);
        btn.classList.toggle('active', btnValue === value);
    });
}

// Update Retrieval Weight (Multitask)
function updateRetrievalWeight(value) {
    const weight = parseFloat(value);
    mcState.retrievalWeight = weight;
    document.getElementById('retrievalWeightValue').textContent = weight.toFixed(1);
    validateMultitaskWeights();
    updateMultitaskSummary();
}

// Update Ranking Weight (Multitask)
function updateRankingWeight(value) {
    const weight = parseFloat(value);
    mcState.rankingWeight = weight;
    document.getElementById('rankingWeightValue').textContent = weight.toFixed(1);
    validateMultitaskWeights();
    updateMultitaskSummary();
}

// Validate Multitask Weights (at least one > 0)
function validateMultitaskWeights() {
    const warning = document.getElementById('weightValidationWarning');
    if (!warning) return true;

    if (mcState.retrievalWeight === 0 && mcState.rankingWeight === 0) {
        warning.classList.remove('hidden');
        return false;
    } else {
        warning.classList.add('hidden');
        return true;
    }
}

// Update Multitask Summary in Step 3
function updateMultitaskSummary() {
    const summaryWeights = document.getElementById('mcSummaryWeights');
    if (summaryWeights) {
        summaryWeights.textContent = `Ret: ${mcState.retrievalWeight.toFixed(1)} / Rank: ${mcState.rankingWeight.toFixed(1)}`;
    }
}

// Update Multitask Architecture Diagram
function updateMultitaskArchDiagram() {
    // Update tower summaries
    const buyerSummary = getTowerSummary(mcState.buyerTowerLayers);
    const productSummary = getTowerSummary(mcState.productTowerLayers);
    const ratingHeadSummary = getTowerSummary(mcState.ratingHeadLayers);

    const archBuyerSummary = document.getElementById('archBuyerSummary');
    const archProductSummary = document.getElementById('archProductSummary');
    const archRatingHeadSummary = document.getElementById('archRatingHeadSummary');

    if (archBuyerSummary) archBuyerSummary.textContent = buyerSummary;
    if (archProductSummary) archProductSummary.textContent = productSummary;
    if (archRatingHeadSummary) archRatingHeadSummary.textContent = ratingHeadSummary;

    // Update embedding dimensions
    const outputDim = mcState.outputEmbeddingDim || 32;
    const archBuyerDim = document.getElementById('archBuyerDim');
    const archProductDim = document.getElementById('archProductDim');
    const archConcatDim = document.getElementById('archConcatDim');

    if (archBuyerDim) archBuyerDim.textContent = `${outputDim}D`;
    if (archProductDim) archProductDim.textContent = `${outputDim}D`;
    if (archConcatDim) archConcatDim.textContent = `${outputDim * 2}D`;

    // Update loss function
    const archLossFunction = document.getElementById('archLossFunction');
    if (archLossFunction) {
        const lossLabels = { 'mse': 'MSE', 'binary_crossentropy': 'Binary CE', 'huber': 'Huber' };
        archLossFunction.textContent = lossLabels[mcState.lossFunction] || 'MSE';
    }

    // Update weights
    const archRetrievalWeight = document.getElementById('archRetrievalWeight');
    const archRankingWeight = document.getElementById('archRankingWeight');

    if (archRetrievalWeight) archRetrievalWeight.textContent = mcState.retrievalWeight.toFixed(1);
    if (archRankingWeight) archRankingWeight.textContent = mcState.rankingWeight.toFixed(1);
}

// Helper function to get tower summary string
function getTowerSummary(layers) {
    if (!layers || layers.length === 0) return 'Empty';
    const units = layers.filter(l => l.type === 'dense').map(l => l.units);
    return units.join('') || 'Empty';
}

// Get selected optimizer value
function getSelectedOptimizer() {
    const selected = document.querySelector('input[name="mcOptimizer"]:checked');
    return selected ? selected.value : 'adagrad';
}

// Render Tower Layers
function renderTowerLayers() {
    renderLayerList('buyer', mcState.buyerTowerLayers);
    renderLayerList('product', mcState.productTowerLayers);
}

function renderLayerList(tower, layers) {
    const list = document.getElementById(`${tower}LayerList`);
    if (!list) return;

    // Find the last Dense layer index (output embedding layer)
    let lastDenseIdx = -1;
    for (let i = layers.length - 1; i >= 0; i--) {
        if (layers[i].type === 'dense') {
            lastDenseIdx = i;
            break;
        }
    }

    list.innerHTML = layers.map((layer, idx) => {
        let badge = '';
        let params = '';
        const isOutputLayer = (layer.type === 'dense' && idx === lastDenseIdx);

        if (layer.type === 'dense') {
            badge = '<span class="layer-type-badge dense">Dense</span>';
            let regInfo = '';
            if (layer.l2_reg) regInfo = `, L2=${layer.l2_reg}`;
            else if (layer.l1_reg) regInfo = `, L1=${layer.l1_reg}`;
            params = `${layer.units} units, ${layer.activation || 'relu'}${regInfo}`;
        } else if (layer.type === 'dropout') {
            badge = '<span class="layer-type-badge dropout">Dropout</span>';
            params = `rate: ${layer.rate}`;
        } else if (layer.type === 'batch_norm') {
            badge = '<span class="layer-type-badge batch_norm">BatchNorm</span>';
            params = '';
        } else if (layer.type === 'layer_norm') {
            badge = '<span class="layer-type-badge layer_norm">LayerNorm</span>';
            params = layer.epsilon ? `: ${layer.epsilon}` : '';
        }

        // For output layer: use editOutputLayer and no delete button
        const editAction = isOutputLayer
            ? `onclick="editOutputLayer()" title="Edit Output Layer (both towers)"`
            : `onclick="editLayer('${tower}', ${idx})" title="Edit"`;

        const deleteBtn = isOutputLayer
            ? ''
            : `<button class="layer-action-btn delete" onclick="removeLayer('${tower}', ${idx})" title="Delete">
                   <i class="fas fa-trash"></i>
               </button>`;

        // Draggable for all layers except the output layer
        const draggable = isOutputLayer ? 'false' : 'true';
        const dragHandleClass = isOutputLayer ? 'drag-handle disabled' : 'drag-handle';

        return `
            <div class="layer-item${isOutputLayer ? ' output-layer' : ''}"
                 data-index="${idx}"
                 data-tower="${tower}"
                 draggable="${draggable}"
                 ondragstart="layerDragStart(event, '${tower}', ${idx})"
                 ondragend="layerDragEnd(event)"
                 ondragover="layerDragOver(event)"
                 ondrop="layerDrop(event, '${tower}', ${idx})">
                <span class="${dragHandleClass}"><i class="fas fa-grip-vertical"></i></span>
                ${badge}
                <span class="layer-params">${params}</span>
                <div class="layer-actions">
                    <button class="layer-action-btn" ${editAction}>
                        <i class="fas fa-external-link-alt"></i>
                    </button>
                    ${deleteBtn}
                </div>
            </div>
        `;
    }).join('');
}

// Layer Drag and Drop
let layerDragData = null;

function layerDragStart(event, tower, index) {
    // Don't allow dragging the output layer
    let layers;
    if (tower === 'buyer') layers = mcState.buyerTowerLayers;
    else if (tower === 'product') layers = mcState.productTowerLayers;
    else if (tower === 'rating_head') layers = mcState.ratingHeadLayers;

    const lastDenseIdx = getLastDenseLayerIndex(layers);
    if (index === lastDenseIdx) {
        event.preventDefault();
        return;
    }

    layerDragData = { tower, index };
    event.target.classList.add('dragging');
    event.dataTransfer.effectAllowed = 'move';
    event.dataTransfer.setData('text/plain', JSON.stringify({ tower, index }));
}

function layerDragEnd(event) {
    event.target.classList.remove('dragging');
    // Remove all drag-over classes
    document.querySelectorAll('.layer-item.drag-over').forEach(el => {
        el.classList.remove('drag-over');
    });
    layerDragData = null;
}

function layerDragOver(event) {
    event.preventDefault();
    event.dataTransfer.dropEffect = 'move';

    const layerItem = event.target.closest('.layer-item');
    if (layerItem && !layerItem.classList.contains('output-layer')) {
        // Remove drag-over from all other items
        document.querySelectorAll('.layer-item.drag-over').forEach(el => {
            if (el !== layerItem) el.classList.remove('drag-over');
        });
        layerItem.classList.add('drag-over');
    }
}

function layerDrop(event, targetTower, targetIndex) {
    event.preventDefault();

    const layerItem = event.target.closest('.layer-item');
    if (layerItem) {
        layerItem.classList.remove('drag-over');
    }

    if (!layerDragData) return;

    const { tower: sourceTower, index: sourceIndex } = layerDragData;

    // Only allow reordering within the same tower
    if (sourceTower !== targetTower) {
        layerDragData = null;
        return;
    }

    // Get the appropriate layers array
    let layers;
    if (sourceTower === 'buyer') layers = mcState.buyerTowerLayers;
    else if (sourceTower === 'product') layers = mcState.productTowerLayers;
    else if (sourceTower === 'rating_head') layers = mcState.ratingHeadLayers;

    const lastDenseIdx = getLastDenseLayerIndex(layers);

    // Can't drop onto or after the output layer
    if (targetIndex >= lastDenseIdx) {
        targetIndex = lastDenseIdx - 1;
    }

    // Don't do anything if dropped on same position
    if (sourceIndex === targetIndex) {
        layerDragData = null;
        return;
    }

    // Perform the reorder
    const [movedLayer] = layers.splice(sourceIndex, 1);

    // Adjust target index if we removed from before target
    let insertIndex = targetIndex;
    if (sourceIndex < targetIndex) {
        insertIndex = targetIndex - 1;
    }

    // Make sure we don't insert after the output layer
    const newLastDenseIdx = getLastDenseLayerIndex(layers);
    if (insertIndex >= newLastDenseIdx) {
        insertIndex = newLastDenseIdx;
    }

    layers.splice(insertIndex, 0, movedLayer);

    // Update state and re-render based on tower type
    if (sourceTower === 'buyer') {
        mcState.buyerTowerLayers = layers;
        renderTowerLayers();
        updateTowerSummaries();
    } else if (sourceTower === 'product') {
        mcState.productTowerLayers = layers;
        renderTowerLayers();
        updateTowerSummaries();
    } else if (sourceTower === 'rating_head') {
        mcState.ratingHeadLayers = layers;
        renderRatingHeadLayers();
    }

    layerDragData = null;
}

// Update Tower Summaries
function updateTowerSummaries() {
    const buyerSummary = getTowerSummary(mcState.buyerTowerLayers);
    const productSummary = getTowerSummary(mcState.productTowerLayers);

    const buyerEl = document.getElementById('buyerTowerSummary');
    const productEl = document.getElementById('productTowerSummary');

    if (buyerEl) buyerEl.textContent = buyerSummary;
    if (productEl) productEl.textContent = productSummary;

    // Update params summaries
    updateTowerParams('buyer', mcState.buyerTowerLayers);
    updateTowerParams('product', mcState.productTowerLayers);
}

function getTowerSummary(layers) {
    const units = layers.filter(l => l.type === 'dense').map(l => l.units);
    return units.length > 0 ? units.join('') : 'Empty';
}

// Calculate and display tower parameters (Keras-style)
function updateTowerParams(tower, layers) {
    const totalParamsEl = document.getElementById(`${tower}TotalParams`);
    const trainableParamsEl = document.getElementById(`${tower}TrainableParams`);

    if (!totalParamsEl || !trainableParamsEl) return;

    const params = calculateTowerParams(layers);
    totalParamsEl.textContent = formatNumber(params);
    trainableParamsEl.textContent = formatNumber(params);
}

function calculateTowerParams(layers) {
    let totalParams = 0;
    let prevUnits = 100; // Assume input dimension (will be from FeatureConfig in reality)

    for (const layer of layers) {
        if (layer.type === 'dense') {
            // Dense layer: (input_units * output_units) + output_units (bias)
            const units = layer.units || 32;
            totalParams += (prevUnits * units) + units;
            prevUnits = units;
        }
        // Dropout and BatchNorm have 0 trainable params in this context
    }

    return totalParams;
}

function formatNumber(num) {
    if (num >= 1000000) {
        return (num / 1000000).toFixed(2) + 'M';
    } else if (num >= 1000) {
        return num.toLocaleString();
    }
    return num.toString();
}

// Layer Modal (Add/Edit)
function addLayer(tower) {
    openLayerModal(tower, -1, 'add');
}

function editLayer(tower, index) {
    openLayerModal(tower, index, 'edit');
}

function openLayerModal(tower, index, mode) {
    document.getElementById('layerModalTower').value = tower;
    document.getElementById('layerModalIndex').value = index;
    document.getElementById('layerModalMode').value = mode;

    const titleEl = document.getElementById('layerModalTitle');
    const subtitleEl = document.getElementById('layerModalSubtitle');
    const submitBtn = document.getElementById('layerModalSubmitBtn');
    const typeSelect = document.getElementById('layerType');
    let towerName = tower === 'buyer' ? 'Buyer Tower' : (tower === 'product' ? 'Product Tower' : 'Rating Head');

    if (mode === 'edit') {
        titleEl.textContent = 'Edit Layer';
        subtitleEl.textContent = `${towerName} - Layer ${index + 1}`;
        submitBtn.innerHTML = '<span class="btn-neu-inner">Save</span>';

        // Get the layer data
        let layers;
        if (tower === 'buyer') layers = mcState.buyerTowerLayers;
        else if (tower === 'product') layers = mcState.productTowerLayers;
        else if (tower === 'rating_head') layers = mcState.ratingHeadLayers;
        const layer = layers[index];

        // Populate fields from existing layer
        typeSelect.value = layer.type;

        if (layer.type === 'dense') {
            const units = layer.units || 64;
            document.getElementById('layerUnits').value = units;
            updateLayerUnitsButtons(units);
            document.getElementById('layerActivation').value = layer.activation || 'relu';

            // Set regularization
            if (layer.l2_reg) {
                document.getElementById('layerRegType').value = 'l2';
                document.getElementById('layerRegStrength').value = layer.l2_reg;
            } else if (layer.l1_reg) {
                document.getElementById('layerRegType').value = 'l1';
                document.getElementById('layerRegStrength').value = layer.l1_reg;
            } else {
                document.getElementById('layerRegType').value = 'none';
                document.getElementById('layerRegStrength').value = 0.001;
            }
        } else if (layer.type === 'dropout') {
            document.getElementById('layerDropoutRate').value = layer.rate || 0.2;
        } else if (layer.type === 'layer_norm') {
            document.getElementById('layerNormEpsilon').value = layer.epsilon || 1e-6;
        }

        // Disable type change in edit mode
        typeSelect.disabled = true;
    } else {
        titleEl.textContent = 'Add Layer';
        subtitleEl.textContent = `Add to ${towerName}`;
        submitBtn.innerHTML = '<span class="btn-neu-inner">Add Layer</span>';

        // Reset to defaults for add mode
        typeSelect.value = 'dense';
        typeSelect.disabled = false;
        document.getElementById('layerUnits').value = 64;
        document.getElementById('layerUnitsCustom').value = '';
        updateLayerUnitsButtons(64);
        document.getElementById('layerActivation').value = 'relu';
        document.getElementById('layerRegType').value = 'none';
        document.getElementById('layerRegStrength').value = 0.001;
        document.getElementById('layerDropoutRate').value = 0.2;
        document.getElementById('layerNormEpsilon').value = 0.000001;
    }

    updateLayerModalFields();
    updateRegStrengthVisibility();
    document.getElementById('layerModal').classList.remove('hidden');
}

function updateLayerModalFields() {
    const type = document.getElementById('layerType').value;
    document.getElementById('denseFieldsModal').classList.toggle('hidden', type !== 'dense');
    document.getElementById('dropoutFieldsModal').classList.toggle('hidden', type !== 'dropout');
    document.getElementById('batchNormFieldsModal').classList.toggle('hidden', type !== 'batch_norm');
    document.getElementById('layerNormFieldsModal').classList.toggle('hidden', type !== 'layer_norm');
}

function updateRegStrengthVisibility() {
    const regType = document.getElementById('layerRegType').value;
    const strengthGroup = document.getElementById('regStrengthGroup');
    strengthGroup.style.visibility = regType === 'none' ? 'hidden' : 'visible';
}

// Layer Units button selection
function selectLayerUnits(units) {
    document.getElementById('layerUnits').value = units;
    document.getElementById('layerUnitsCustom').value = '';
    updateLayerUnitsButtons(units);
}

function onLayerUnitsCustomInput(value) {
    if (value) {
        const units = parseInt(value);
        if (units >= 8 && units <= 2048) {
            document.getElementById('layerUnits').value = units;
            // Deselect all preset buttons when custom value is entered
            updateLayerUnitsButtons(null);
        }
    }
}

function updateLayerUnitsButtons(selectedUnits) {
    const presetUnits = [32, 64, 128, 256, 512];
    const buttons = document.querySelectorAll('.layer-units-btn');
    const customInput = document.getElementById('layerUnitsCustom');

    buttons.forEach(btn => {
        const btnUnits = parseInt(btn.textContent);
        if (btnUnits === selectedUnits) {
            btn.className = 'layer-units-btn px-3 py-2 rounded-lg border transition-all bg-blue-500 text-white border-blue-500';
        } else {
            btn.className = 'layer-units-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400';
        }
    });

    // If selected units is not a preset, show it in custom input
    if (selectedUnits && !presetUnits.includes(selectedUnits)) {
        customInput.value = selectedUnits;
    } else if (customInput) {
        customInput.value = '';
    }
}

// Retrieval Algorithm Selection
function selectRetrievalAlgorithm(algorithm) {
    mcState.retrievalAlgorithm = algorithm;

    // Update UI - toggle selected class on options
    const options = document.querySelectorAll('.algorithm-option');
    options.forEach(opt => {
        const optAlgorithm = opt.onclick.toString().includes('brute_force') ? 'brute_force' : 'scann';
        if (optAlgorithm === algorithm) {
            opt.classList.add('selected');
        } else {
            opt.classList.remove('selected');
        }
    });

    // Show/hide parameter panels
    const bruteForceParams = document.getElementById('bruteForceParams');
    const scannParams = document.getElementById('scannParams');

    if (algorithm === 'brute_force') {
        bruteForceParams.classList.remove('hidden');
        scannParams.classList.add('hidden');
    } else {
        bruteForceParams.classList.add('hidden');
        scannParams.classList.remove('hidden');
    }
}

// Update retrieval algorithm state from inputs
function updateRetrievalAlgorithmState() {
    if (mcState.retrievalAlgorithm === 'brute_force') {
        mcState.topK = parseInt(document.getElementById('mcTopK').value) || 100;
    } else {
        mcState.topK = parseInt(document.getElementById('mcScannTopK').value) || 100;
        mcState.scannNumLeaves = parseInt(document.getElementById('mcScannNumLeaves').value) || 100;
        mcState.scannLeavesToSearch = parseInt(document.getElementById('mcScannLeavesToSearch').value) || 10;
    }
}

// =============================================================================
// Rating Head Functions (for Ranking models)
// =============================================================================

// Render rating head layers
function renderRatingHeadLayers() {
    const list = document.getElementById('ratingHeadLayerList');
    if (!list) return;

    const layers = mcState.ratingHeadLayers;

    // Find the last Dense layer (output layer - must be Dense(1))
    let lastDenseIdx = -1;
    for (let i = layers.length - 1; i >= 0; i--) {
        if (layers[i].type === 'dense') {
            lastDenseIdx = i;
            break;
        }
    }

    list.innerHTML = layers.map((layer, idx) => {
        let badge = '';
        let params = '';
        const isOutputLayer = (layer.type === 'dense' && idx === lastDenseIdx);

        if (layer.type === 'dense') {
            badge = '<span class="layer-type-badge dense">Dense</span>';
            let regInfo = '';
            if (layer.l2_reg) regInfo = `, L2=${layer.l2_reg}`;
            else if (layer.l1_reg) regInfo = `, L1=${layer.l1_reg}`;
            const activation = layer.activation || 'linear';
            params = `${layer.units} units, ${activation}${regInfo}`;
        } else if (layer.type === 'dropout') {
            badge = '<span class="layer-type-badge dropout">Dropout</span>';
            params = `rate: ${layer.rate}`;
        } else if (layer.type === 'batch_norm') {
            badge = '<span class="layer-type-badge batch_norm">BatchNorm</span>';
            params = '';
        } else if (layer.type === 'layer_norm') {
            badge = '<span class="layer-type-badge layer_norm">LayerNorm</span>';
            params = layer.epsilon ? `: ${layer.epsilon}` : '';
        }

        // Output layer (Dense(1)) cannot be deleted but can be edited
        const deleteBtn = isOutputLayer
            ? ''
            : `<button class="layer-action-btn delete" onclick="removeRatingHeadLayer(${idx})" title="Delete">
                   <i class="fas fa-trash"></i>
               </button>`;

        const outputLabel = isOutputLayer ? '<span class="output-layer-label">Output</span>' : '';

        // Draggable for all layers except the output layer
        const draggable = isOutputLayer ? 'false' : 'true';
        const dragHandleClass = isOutputLayer ? 'drag-handle disabled' : 'drag-handle';

        return `
            <div class="layer-item${isOutputLayer ? ' output-layer' : ''}"
                 data-index="${idx}"
                 data-tower="rating_head"
                 draggable="${draggable}"
                 ondragstart="layerDragStart(event, 'rating_head', ${idx})"
                 ondragend="layerDragEnd(event)"
                 ondragover="layerDragOver(event)"
                 ondrop="layerDrop(event, 'rating_head', ${idx})">
                <span class="${dragHandleClass}"><i class="fas fa-grip-vertical"></i></span>
                ${badge}
                <span class="layer-params">${params}</span>
                ${outputLabel}
                <div class="layer-actions">
                    <button class="layer-action-btn" onclick="editRatingHeadLayer(${idx})" title="Edit">
                        <i class="fas fa-external-link-alt"></i>
                    </button>
                    ${deleteBtn}
                </div>
            </div>
        `;
    }).join('');

    updateRatingHeadSummary();
    updateRatingHeadParams();
}

// Update rating head summary (e.g., "256641")
function updateRatingHeadSummary() {
    const summaryEl = document.getElementById('ratingHeadSummary');
    if (!summaryEl) return;

    const units = mcState.ratingHeadLayers
        .filter(l => l.type === 'dense')
        .map(l => l.units);

    summaryEl.textContent = units.length > 0 ? units.join('') : 'Empty';
}

// Update rating head parameter count estimation
function updateRatingHeadParams() {
    const totalParamsEl = document.getElementById('ratingHeadTotalParams');
    const trainableParamsEl = document.getElementById('ratingHeadTrainableParams');
    if (!totalParamsEl) return;

    // Input is concatenated embeddings from both towers
    let prevDim = mcState.outputEmbeddingDim * 2;
    let totalParams = 0;

    mcState.ratingHeadLayers.forEach(layer => {
        if (layer.type === 'dense') {
            totalParams += prevDim * layer.units + layer.units; // weights + bias
            prevDim = layer.units;
        }
    });

    totalParamsEl.textContent = formatParamCount(totalParams);
    trainableParamsEl.textContent = formatParamCount(totalParams);
}

// Add layer to rating head
function addRatingHeadLayer() {
    openLayerModal('rating_head', -1, 'add');
}

// Edit rating head layer
function editRatingHeadLayer(index) {
    openLayerModal('rating_head', index, 'edit');
}

// Remove rating head layer
function removeRatingHeadLayer(index) {
    mcState.ratingHeadLayers.splice(index, 1);
    renderRatingHeadLayers();
}

// Get rating head summary for display
function getRatingHeadSummary() {
    const units = mcState.ratingHeadLayers
        .filter(l => l.type === 'dense')
        .map(l => l.units);
    return units.length > 0 ? units.join('') : 'None';
}

// Get rating head summary from layers array (for card rendering)
function getRatingHeadSummaryFromLayers(layers) {
    if (!layers || layers.length === 0) return 'None';
    const units = layers
        .filter(l => l.type === 'dense')
        .map(l => l.units);
    return units.length > 0 ? units.join('') : 'None';
}

function closeLayerModal(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('layerModal').classList.add('hidden');
    // Re-enable type select in case it was disabled
    document.getElementById('layerType').disabled = false;
}

function submitLayerModal() {
    const tower = document.getElementById('layerModalTower').value;
    const index = parseInt(document.getElementById('layerModalIndex').value);
    const mode = document.getElementById('layerModalMode').value;
    const type = document.getElementById('layerType').value;

    let layer = { type };

    if (type === 'dense') {
        layer.units = parseInt(document.getElementById('layerUnits').value);
        layer.activation = document.getElementById('layerActivation').value;
        if (layer.activation === 'linear') layer.activation = null;

        const regType = document.getElementById('layerRegType').value;
        if (regType === 'l2') {
            layer.l2_reg = parseFloat(document.getElementById('layerRegStrength').value);
        } else if (regType === 'l1') {
            layer.l1_reg = parseFloat(document.getElementById('layerRegStrength').value);
        }
    } else if (type === 'dropout') {
        layer.rate = parseFloat(document.getElementById('layerDropoutRate').value);
    } else if (type === 'layer_norm') {
        layer.epsilon = parseFloat(document.getElementById('layerNormEpsilon').value) || 1e-6;
    }
    // batch_norm has no additional fields

    let layers;
    if (tower === 'buyer') layers = mcState.buyerTowerLayers;
    else if (tower === 'product') layers = mcState.productTowerLayers;
    else if (tower === 'rating_head') layers = mcState.ratingHeadLayers;

    if (mode === 'edit') {
        // Replace existing layer
        layers[index] = layer;
    } else {
        // Add new layer - insert BEFORE the last Dense layer (output layer)
        const lastDenseIdx = getLastDenseLayerIndex(layers);
        if (lastDenseIdx !== -1) {
            // Insert before the output layer
            layers.splice(lastDenseIdx, 0, layer);
        } else {
            // No output layer exists, just push
            layers.push(layer);
        }
    }

    // Re-render the appropriate tower/section
    if (tower === 'rating_head') {
        renderRatingHeadLayers();
    } else {
        renderTowerLayers();
        updateTowerSummaries();
    }
    closeLayerModal();
}

function removeLayer(tower, index) {
    if (tower === 'buyer') {
        mcState.buyerTowerLayers.splice(index, 1);
    } else {
        mcState.productTowerLayers.splice(index, 1);
    }
    renderTowerLayers();
    updateTowerSummaries();
}

// Output Layer Modal (edits last Dense layer on both towers)
function getLastDenseLayerIndex(layers) {
    for (let i = layers.length - 1; i >= 0; i--) {
        if (layers[i].type === 'dense') return i;
    }
    return -1;
}

function editOutputLayer() {
    // Get the last Dense layer from buyer tower (both should match)
    const buyerIdx = getLastDenseLayerIndex(mcState.buyerTowerLayers);
    if (buyerIdx === -1) {
        alert('No Dense layer found in Buyer tower');
        return;
    }

    const buyerLayer = mcState.buyerTowerLayers[buyerIdx];
    const currentUnits = buyerLayer.units || 32;

    // Populate modal with current values
    document.getElementById('outputLayerUnits').value = currentUnits;
    document.getElementById('outputLayerActivation').value = buyerLayer.activation || 'relu';

    // Update dimension button selection
    updateOutputDimButtons(currentUnits);

    document.getElementById('outputLayerModal').classList.remove('hidden');
}

// Output dimension button selection
function selectOutputDim(dim) {
    document.getElementById('outputLayerUnits').value = dim;
    document.getElementById('outputLayerCustomDim').value = '';
    updateOutputDimButtons(dim);
}

function onOutputCustomDimInput(value) {
    if (value) {
        const dim = parseInt(value);
        if (dim >= 4 && dim <= 1024) {
            document.getElementById('outputLayerUnits').value = dim;
            // Deselect all preset buttons when custom value is entered
            updateOutputDimButtons(null);
        }
    }
}

function updateOutputDimButtons(selectedDim) {
    const presetDims = [8, 16, 32, 64, 128, 256];
    const buttons = document.querySelectorAll('.output-dim-btn');
    const customInput = document.getElementById('outputLayerCustomDim');

    buttons.forEach(btn => {
        const btnDim = parseInt(btn.textContent);
        if (btnDim === selectedDim) {
            btn.className = 'output-dim-btn px-3 py-2 rounded-lg border transition-all bg-blue-500 text-white border-blue-500';
        } else {
            btn.className = 'output-dim-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400';
        }
    });

    // If selected dim is not a preset, show it in custom input
    if (selectedDim && !presetDims.includes(selectedDim)) {
        customInput.value = selectedDim;
    } else {
        customInput.value = '';
    }
}

function closeOutputLayerModal(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('outputLayerModal').classList.add('hidden');
}

function submitOutputLayer() {
    const units = parseInt(document.getElementById('outputLayerUnits').value);
    let activation = document.getElementById('outputLayerActivation').value;
    if (activation === 'linear') activation = null;

    // Update last Dense layer in buyer tower
    const buyerIdx = getLastDenseLayerIndex(mcState.buyerTowerLayers);
    if (buyerIdx !== -1) {
        mcState.buyerTowerLayers[buyerIdx].units = units;
        mcState.buyerTowerLayers[buyerIdx].activation = activation;
    }

    // Update last Dense layer in product tower
    const productIdx = getLastDenseLayerIndex(mcState.productTowerLayers);
    if (productIdx !== -1) {
        mcState.productTowerLayers[productIdx].units = units;
        mcState.productTowerLayers[productIdx].activation = activation;
    }

    // Update state
    mcState.outputEmbeddingDim = units;

    renderTowerLayers();
    updateTowerSummaries();
    closeOutputLayerModal();
}

// Navigation
function mcNextStep() {
    if (mcCurrentStep === 1) {
        const name = document.getElementById('mcName').value.trim();
        if (!name) {
            document.getElementById('mcNameError').textContent = 'Name is required';
            document.getElementById('mcNameError').classList.remove('hidden');
            document.getElementById('mcName').classList.add('border-red-500');
            return;
        }
        // Check if name validation has been performed and is valid
        if (!mcNameIsValid) {
            // Trigger validation if not done yet
            checkMcNameAvailability();
            // Show error message
            document.getElementById('mcNameError').textContent = 'Please wait for name validation or choose a different name';
            document.getElementById('mcNameError').classList.remove('hidden');
            return;
        }
        mcState.name = name;
        mcState.description = document.getElementById('mcDescription').value.trim();
    }

    if (mcCurrentStep < 3) {
        mcCurrentStep++;
        updateMcStep();
    }
}

function mcPrevStep() {
    if (mcCurrentStep > 1) {
        mcCurrentStep--;
        updateMcStep();
    }
}

function updateMcStep() {
    // Update step content visibility (use 'active' class, not 'hidden')
    document.getElementById('mcStep1').classList.toggle('active', mcCurrentStep === 1);
    document.getElementById('mcStep2').classList.toggle('active', mcCurrentStep === 2);
    document.getElementById('mcStep3').classList.toggle('active', mcCurrentStep === 3);

    // Update progress pills
    for (let i = 1; i <= 3; i++) {
        const pill = document.getElementById(`mcProgress${i}`);
        pill.classList.remove('current', 'completed', 'future');
        if (i < mcCurrentStep) {
            pill.classList.add('completed');
        } else if (i === mcCurrentStep) {
            pill.classList.add('current');
        } else {
            pill.classList.add('future');
        }
    }

    // Update step counter
    document.getElementById('mcCurrentStep').textContent = mcCurrentStep;

    // Update buttons
    document.getElementById('mcBtnBack').classList.toggle('hidden', mcCurrentStep === 1);
    document.getElementById('mcBtnNext').classList.toggle('hidden', mcCurrentStep === 3);
    document.getElementById('mcBtnCreate').classList.toggle('hidden', mcCurrentStep !== 3);

    // Update summary on step 3
    if (mcCurrentStep === 3) {
        updateMcSummary();
        // Show/hide loss function panel based on model type (ranking or multitask)
        const lossFunctionPanel = document.getElementById('lossFunctionPanel');
        if (lossFunctionPanel) {
            lossFunctionPanel.classList.toggle('hidden', mcState.modelType !== 'ranking' && mcState.modelType !== 'multitask');
        }
        // Show/hide multitask weight section
        const multitaskWeightSection = document.getElementById('multitaskWeightSection');
        if (multitaskWeightSection) {
            multitaskWeightSection.classList.toggle('hidden', mcState.modelType !== 'multitask');
        }
    }

    // Render layers when entering step 2
    if (mcCurrentStep === 2) {
        renderTowerLayers();
        updateTowerSummaries();
        // Render rating head layers if ranking or multitask model
        if (mcState.modelType === 'ranking' || mcState.modelType === 'multitask') {
            renderRatingHeadLayers();
        }
        // Update multitask architecture diagram if multitask model
        if (mcState.modelType === 'multitask') {
            updateMultitaskArchDiagram();
        }
    }
}

function updateMcSummary() {
    // Set model type display
    const modelTypeLabels = { 'retrieval': 'Retrieval', 'ranking': 'Ranking', 'multitask': 'Multitask' };
    document.getElementById('mcSummaryType').textContent = modelTypeLabels[mcState.modelType] || 'Retrieval';

    document.getElementById('mcSummaryBuyer').textContent = getTowerSummary(mcState.buyerTowerLayers);
    document.getElementById('mcSummaryProduct').textContent = getTowerSummary(mcState.productTowerLayers);
    document.getElementById('mcSummaryOutputDim').textContent = mcState.outputEmbeddingDim || 32;

    // Handle retrieval vs ranking vs multitask specific info
    const retrievalRow = document.getElementById('mcSummaryRetrievalRow');
    const ratingHeadRow = document.getElementById('mcSummaryRatingHeadRow');
    const lossRow = document.getElementById('mcSummaryLossRow');
    const weightsRow = document.getElementById('mcSummaryWeightsRow');

    if (mcState.modelType === 'ranking') {
        // Hide retrieval, show rating head
        if (retrievalRow) retrievalRow.classList.add('hidden');
        if (ratingHeadRow) ratingHeadRow.classList.remove('hidden');
        if (lossRow) lossRow.classList.remove('hidden');
        if (weightsRow) weightsRow.classList.add('hidden');

        // Update rating head summary
        const ratingHeadSummaryEl = document.getElementById('mcSummaryRatingHead');
        if (ratingHeadSummaryEl) {
            ratingHeadSummaryEl.textContent = getRatingHeadSummary();
        }

        // Update loss function summary
        const lossSummaryEl = document.getElementById('mcSummaryLoss');
        if (lossSummaryEl) {
            const lossLabels = { 'mse': 'MSE', 'binary_crossentropy': 'Binary CE', 'huber': 'Huber' };
            lossSummaryEl.textContent = lossLabels[mcState.lossFunction] || 'MSE';
        }
    } else if (mcState.modelType === 'multitask') {
        // Show both retrieval and rating head for multitask
        if (retrievalRow) retrievalRow.classList.remove('hidden');
        if (ratingHeadRow) ratingHeadRow.classList.remove('hidden');
        if (lossRow) lossRow.classList.remove('hidden');
        if (weightsRow) weightsRow.classList.remove('hidden');

        // Update retrieval algorithm state from inputs
        updateRetrievalAlgorithmState();

        // Display retrieval algorithm info
        if (mcState.retrievalAlgorithm === 'brute_force') {
            document.getElementById('mcSummaryRetrieval').textContent = `Brute Force (Top ${mcState.topK})`;
        } else {
            document.getElementById('mcSummaryRetrieval').textContent = `ScaNN (Top ${mcState.topK})`;
        }

        // Update rating head summary
        const ratingHeadSummaryEl = document.getElementById('mcSummaryRatingHead');
        if (ratingHeadSummaryEl) {
            ratingHeadSummaryEl.textContent = getRatingHeadSummary();
        }

        // Update loss function summary
        const lossSummaryEl = document.getElementById('mcSummaryLoss');
        if (lossSummaryEl) {
            const lossLabels = { 'mse': 'MSE', 'binary_crossentropy': 'Binary CE', 'huber': 'Huber' };
            lossSummaryEl.textContent = lossLabels[mcState.lossFunction] || 'MSE';
        }

        // Update weights summary
        updateMultitaskSummary();
    } else {
        // Show retrieval, hide rating head (retrieval mode)
        if (retrievalRow) retrievalRow.classList.remove('hidden');
        if (ratingHeadRow) ratingHeadRow.classList.add('hidden');
        if (lossRow) lossRow.classList.add('hidden');
        if (weightsRow) weightsRow.classList.add('hidden');

        // Update retrieval algorithm state from inputs before summary
        updateRetrievalAlgorithmState();

        // Display retrieval algorithm info
        if (mcState.retrievalAlgorithm === 'brute_force') {
            document.getElementById('mcSummaryRetrieval').textContent = `Brute Force (Top ${mcState.topK})`;
        } else {
            document.getElementById('mcSummaryRetrieval').textContent = `ScaNN (Top ${mcState.topK})`;
        }
    }

    // Estimate params (rough calculation)
    const buyerParams = estimateTowerParams(mcState.buyerTowerLayers);
    const productParams = estimateTowerParams(mcState.productTowerLayers);
    let totalParams = buyerParams + productParams;

    // Add rating head params for ranking/multitask models
    if (mcState.modelType === 'ranking' || mcState.modelType === 'multitask') {
        const ratingHeadParams = estimateRatingHeadParams();
        totalParams += ratingHeadParams;
    }

    document.getElementById('mcSummaryParams').textContent = formatParams(totalParams);
}

function estimateRatingHeadParams() {
    let params = 0;
    let prevDim = (mcState.outputEmbeddingDim || 32) * 2; // Concatenated embeddings
    for (const layer of mcState.ratingHeadLayers) {
        if (layer.type === 'dense') {
            params += prevDim * layer.units + layer.units;
            prevDim = layer.units;
        }
    }
    return params;
}

function estimateTowerParams(layers) {
    let params = 0;
    let prevDim = 100; // Assume input dim
    for (const layer of layers) {
        if (layer.type === 'dense') {
            params += prevDim * layer.units + layer.units;
            prevDim = layer.units;
        }
    }
    return params;
}

function formatParams(num) {
    if (num >= 1000000) return `~${(num / 1000000).toFixed(1)}M`;
    if (num >= 1000) return `~${(num / 1000).toFixed(0)}K`;
    return `~${num}`;
}

// Save Model Config (handles both create and update)
function createModelConfig() {
    // Update retrieval algorithm state from inputs
    updateRetrievalAlgorithmState();

    // Validate multitask weights
    if (mcState.modelType === 'multitask') {
        if (mcState.retrievalWeight === 0 && mcState.rankingWeight === 0) {
            alert('At least one weight must be greater than 0 for multitask models.');
            return;
        }
    }

    const payload = {
        name: mcState.name,
        description: mcState.description,
        model_type: mcState.modelType,
        buyer_tower_layers: mcState.buyerTowerLayers,
        product_tower_layers: mcState.productTowerLayers,
        output_embedding_dim: mcState.outputEmbeddingDim || 32,
        // Retrieval algorithm settings (for retrieval/multitask models)
        retrieval_algorithm: mcState.retrievalAlgorithm,
        top_k: mcState.topK,
        scann_num_leaves: mcState.scannNumLeaves,
        scann_leaves_to_search: mcState.scannLeavesToSearch,
        // Rating head settings (for ranking/multitask models)
        rating_head_layers: mcState.ratingHeadLayers,
        loss_function: mcState.lossFunction,
        // Multitask settings
        retrieval_weight: mcState.retrievalWeight,
        ranking_weight: mcState.rankingWeight,
        // Training params
        optimizer: getSelectedOptimizer(),
        learning_rate: parseFloat(document.getElementById('mcLearningRate').value),
        batch_size: parseInt(document.getElementById('mcBatchSize').value)
    };

    // Determine endpoint based on edit mode
    const isEditing = editingModelConfigId !== null;
    const url = isEditing
        ? `/api/model-configs/${editingModelConfigId}/update/`
        : '/api/model-configs/create/';
    const method = isEditing ? 'PUT' : 'POST';

    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            closeModelConfigWizard();
            loadModelConfigs();
            showToast(isEditing ? 'Model config updated successfully' : 'Model config created successfully', 'success');
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(err => {
        console.error(isEditing ? 'Error updating model config:' : 'Error creating model config:', err);
        alert(isEditing ? 'Error updating model config' : 'Error creating model config');
    });
}

// View Model Config
function viewModelConfig(id) {
    // First try to find in cached list, then fetch full details
    const mcBasic = allModelConfigs.find(c => c.id === id);
    if (!mcBasic) return;

    // Show modal immediately with basic info, then fetch full details
    viewingModelConfig = mcBasic;
    document.getElementById('modelConfigViewModal').classList.remove('hidden');

    // Populate basic info
    document.getElementById('viewMcName').textContent = mcBasic.name;
    document.getElementById('viewMcDesc').textContent = mcBasic.description || 'No description';

    const badge = document.getElementById('viewMcTypeBadge');
    badge.className = `model-type-badge ${mcBasic.model_type}`;
    badge.textContent = mcBasic.model_type_display;

    document.getElementById('viewMcUpdatedAt').textContent = formatMcTimeAgo(mcBasic.updated_at);
    if (mcBasic.created_by) {
        document.getElementById('viewMcCreatedBy').textContent = mcBasic.created_by;
        document.getElementById('viewMcCreatedByWrapper').style.display = '';
    } else {
        document.getElementById('viewMcCreatedByWrapper').style.display = 'none';
    }

    // Fetch full details for tower visualization
    fetch(`/api/model-configs/${id}/`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const mc = data.data;
                viewingModelConfig = mc;
                populateViewModal(mc);
            } else {
                // Fallback to basic info
                populateViewModalBasic(mcBasic);
            }
        })
        .catch(err => {
            console.error('Error fetching model config details:', err);
            populateViewModalBasic(mcBasic);
        });
}

// Populate View Modal with full details
function populateViewModal(mc) {
    // Tower stacks - use detailed visualization with aligned layers
    const buyerLayers = mc.buyer_tower_layers || [];
    const productLayers = mc.product_tower_layers || [];
    const towerHtml = renderCardTowerLayers(buyerLayers, productLayers);

    document.getElementById('viewMcBuyerStack').innerHTML = towerHtml.buyer;
    document.getElementById('viewMcProductStack').innerHTML = towerHtml.product;

    // Per-tower parameter summaries
    const buyerParams = calculateSingleTowerParams(buyerLayers);
    const productParams = calculateSingleTowerParams(productLayers);
    document.getElementById('viewMcBuyerTotalParams').textContent = buyerParams.toLocaleString();
    document.getElementById('viewMcBuyerTrainableParams').textContent = buyerParams.toLocaleString();
    document.getElementById('viewMcProductTotalParams').textContent = productParams.toLocaleString();
    document.getElementById('viewMcProductTrainableParams').textContent = productParams.toLocaleString();

    // Combined model summary
    const summary = calculateModelSummary(mc);
    document.getElementById('viewMcTotalParams').textContent = `~${summary.total}`;
    document.getElementById('viewMcTrainableParams').textContent = `~${summary.trainable}`;
    document.getElementById('viewMcNonTrainableParams').textContent = summary.nonTrainable;

    // Training parameters
    document.getElementById('viewMcParams').innerHTML = `
        <div class="param-chip">
            <span class="param-chip-label">Optimizer:</span>
            <span class="param-chip-value">${mc.optimizer_display}</span>
        </div>
        <div class="param-chip">
            <span class="param-chip-label">Learning Rate:</span>
            <span class="param-chip-value">${mc.learning_rate}</span>
        </div>
        <div class="param-chip">
            <span class="param-chip-label">Batch Size:</span>
            <span class="param-chip-value">${mc.batch_size}</span>
        </div>
        <div class="param-chip">
            <span class="param-chip-label">Output Dim:</span>
            <span class="param-chip-value">${mc.output_embedding_dim}D</span>
        </div>
    `;

    // Retrieval algorithm section (for retrieval and multitask models)
    const retrievalSection = document.getElementById('viewMcRetrievalSection');
    if (['retrieval', 'multitask'].includes(mc.model_type)) {
        retrievalSection.classList.remove('hidden');
        document.getElementById('viewMcRetrievalParams').innerHTML = `
            <div class="param-chip retrieval-algo">
                <span class="param-chip-label">Algorithm:</span>
                <span class="param-chip-value">${mc.retrieval_algorithm_display || 'Brute Force'}</span>
            </div>
            <div class="param-chip">
                <span class="param-chip-label">Top-K:</span>
                <span class="param-chip-value">${mc.top_k || 100}</span>
            </div>
            ${mc.retrieval_algorithm === 'scann' ? `
            <div class="param-chip">
                <span class="param-chip-label">Num Leaves:</span>
                <span class="param-chip-value">${mc.scann_num_leaves || 100}</span>
            </div>
            <div class="param-chip">
                <span class="param-chip-label">Leaves to Search:</span>
                <span class="param-chip-value">${mc.scann_leaves_to_search || 10}</span>
            </div>
            ` : ''}
        `;
    } else {
        retrievalSection.classList.add('hidden');
    }

    // Rating Head section (for ranking and multitask models)
    const ratingHeadSection = document.getElementById('viewMcRatingHeadSection');
    if (ratingHeadSection) {
        if (['ranking', 'multitask'].includes(mc.model_type)) {
            ratingHeadSection.classList.remove('hidden');
            const ratingHeadLayers = mc.rating_head_layers || [];
            const ratingHeadSummary = getRatingHeadSummaryFromLayers(ratingHeadLayers);
            const ratingHeadParams = calculateSingleTowerParams(ratingHeadLayers, (mc.output_embedding_dim || 32) * 2);

            document.getElementById('viewMcRatingHeadStack').innerHTML = renderRatingHeadLayersForView(ratingHeadLayers);
            document.getElementById('viewMcRatingHeadTotalParams').textContent = ratingHeadParams.toLocaleString();
            document.getElementById('viewMcRatingHeadTrainableParams').textContent = ratingHeadParams.toLocaleString();

            // Update loss function display
            const lossParams = document.getElementById('viewMcLossParams');
            if (lossParams) {
                lossParams.innerHTML = `
                    <div class="param-chip">
                        <span class="param-chip-label">Loss Function:</span>
                        <span class="param-chip-value">${mc.loss_function_display || 'MSE'}</span>
                    </div>
                `;
            }
        } else {
            ratingHeadSection.classList.add('hidden');
        }
    }

    // Multitask weights section (for multitask models only)
    const multitaskSection = document.getElementById('viewMcMultitaskSection');
    if (multitaskSection) {
        if (mc.model_type === 'multitask') {
            multitaskSection.classList.remove('hidden');
            document.getElementById('viewMcMultitaskParams').innerHTML = `
                <div class="param-chip">
                    <span class="param-chip-label">Retrieval Weight:</span>
                    <span class="param-chip-value">${Math.round((mc.retrieval_weight !== undefined ? mc.retrieval_weight : 1) * 100)}%</span>
                </div>
                <div class="param-chip">
                    <span class="param-chip-label">Ranking Weight:</span>
                    <span class="param-chip-value">${Math.round((mc.ranking_weight !== undefined ? mc.ranking_weight : 1) * 100)}%</span>
                </div>
            `;
        } else {
            multitaskSection.classList.add('hidden');
        }
    }
}

// Helper to render rating head layers for view modal (same style as Buyer/Product towers)
function renderRatingHeadLayersForView(layers) {
    if (!layers || layers.length === 0) {
        return '<div class="text-xs text-gray-400 italic p-2">No layers defined</div>';
    }

    return layers.map((layer, idx) => {
        const isOutput = idx === layers.length - 1 && layer.type === 'dense' && layer.units === 1;
        let badge = '';
        let params = '';

        if (layer.type === 'dense') {
            badge = '<span class="card-layer-badge dense">Dense</span>';
            params = `${layer.units} units`;
            if (layer.activation) params += `, ${layer.activation}`;
            if (layer.l2_reg) params += `, L2=${layer.l2_reg}`;
        } else if (layer.type === 'dropout') {
            badge = '<span class="card-layer-badge dropout">Dropout</span>';
            params = `rate: ${layer.rate}`;
        } else if (layer.type === 'batch_norm') {
            badge = '<span class="card-layer-badge batch_norm">BatchNorm</span>';
            params = '';
        } else if (layer.type === 'layer_norm') {
            badge = '<span class="card-layer-badge layer_norm">LayerNorm</span>';
            params = layer.epsilon ? `: ${layer.epsilon}` : '';
        }

        return `
            <div class="card-layer-item${isOutput ? ' output-layer' : ''}">
                <span class="card-drag-handle"><i class="fas fa-grip-vertical"></i></span>
                ${badge}
                <span class="card-layer-params">${params}</span>
            </div>
        `;
    }).join('');
}

// Populate View Modal with basic info only (fallback)
function populateViewModalBasic(mc) {
    // Tower stacks - parse from summary string, use detailed visualization
    const buyerLayers = parseTowerSummary(mc.buyer_tower_summary);
    const productLayers = parseTowerSummary(mc.product_tower_summary);
    const towerHtml = renderCardTowerLayers(buyerLayers, productLayers);

    document.getElementById('viewMcBuyerStack').innerHTML = towerHtml.buyer;
    document.getElementById('viewMcProductStack').innerHTML = towerHtml.product;

    // Per-tower parameter summaries
    const buyerParams = calculateSingleTowerParams(buyerLayers);
    const productParams = calculateSingleTowerParams(productLayers);
    document.getElementById('viewMcBuyerTotalParams').textContent = buyerParams.toLocaleString();
    document.getElementById('viewMcBuyerTrainableParams').textContent = buyerParams.toLocaleString();
    document.getElementById('viewMcProductTotalParams').textContent = productParams.toLocaleString();
    document.getElementById('viewMcProductTrainableParams').textContent = productParams.toLocaleString();

    // Combined model summary
    const summary = calculateModelSummary(mc);
    document.getElementById('viewMcTotalParams').textContent = `~${summary.total}`;
    document.getElementById('viewMcTrainableParams').textContent = `~${summary.trainable}`;
    document.getElementById('viewMcNonTrainableParams').textContent = summary.nonTrainable;

    // Training parameters
    document.getElementById('viewMcParams').innerHTML = `
        <div class="param-chip">
            <span class="param-chip-label">Optimizer:</span>
            <span class="param-chip-value">${mc.optimizer_display}</span>
        </div>
        <div class="param-chip">
            <span class="param-chip-label">Learning Rate:</span>
            <span class="param-chip-value">${mc.learning_rate}</span>
        </div>
        <div class="param-chip">
            <span class="param-chip-label">Batch Size:</span>
            <span class="param-chip-value">${mc.batch_size}</span>
        </div>
        <div class="param-chip">
            <span class="param-chip-label">Output Dim:</span>
            <span class="param-chip-value">${mc.output_embedding_dim || 32}D</span>
        </div>
    `;

    // Retrieval section (for retrieval and multitask models)
    const retrievalSection = document.getElementById('viewMcRetrievalSection');
    if (['retrieval', 'multitask'].includes(mc.model_type)) {
        retrievalSection.classList.remove('hidden');
        document.getElementById('viewMcRetrievalParams').innerHTML = `
            <div class="param-chip retrieval-algo">
                <span class="param-chip-label">Algorithm:</span>
                <span class="param-chip-value">${mc.retrieval_algorithm_display || 'Brute Force'}</span>
            </div>
            <div class="param-chip">
                <span class="param-chip-label">Top-K:</span>
                <span class="param-chip-value">${mc.top_k || 100}</span>
            </div>
        `;
    } else {
        retrievalSection.classList.add('hidden');
    }

    // Rating Head section (for ranking and multitask models) - hide in basic mode
    const ratingHeadSection = document.getElementById('viewMcRatingHeadSection');
    if (ratingHeadSection) {
        // In basic mode, we don't have detailed layer info, so hide Rating Head
        // The full populateViewModal will handle this when details are loaded
        if (!['ranking', 'multitask'].includes(mc.model_type)) {
            ratingHeadSection.classList.add('hidden');
        }
    }

    // Multitask weights section (for multitask models)
    const multitaskSection = document.getElementById('viewMcMultitaskSection');
    if (multitaskSection) {
        if (mc.model_type === 'multitask') {
            multitaskSection.classList.remove('hidden');
            document.getElementById('viewMcMultitaskParams').innerHTML = `
                <div class="param-chip">
                    <span class="param-chip-label">Retrieval Weight:</span>
                    <span class="param-chip-value">${Math.round((mc.retrieval_weight !== undefined ? mc.retrieval_weight : 1) * 100)}%</span>
                </div>
                <div class="param-chip">
                    <span class="param-chip-label">Ranking Weight:</span>
                    <span class="param-chip-value">${Math.round((mc.ranking_weight !== undefined ? mc.ranking_weight : 1) * 100)}%</span>
                </div>
            `;
        } else {
            multitaskSection.classList.add('hidden');
        }
    }
}

function closeModelConfigViewModal(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('modelConfigViewModal').classList.add('hidden');
    viewingModelConfig = null;
}

// Clone Model Config
function cloneModelConfig() {
    if (!viewingModelConfig) return;
    cloneModelConfigById(viewingModelConfig.id);
    closeModelConfigViewModal();
}

let cloneModelConfigId = null;

function cloneModelConfigById(id) {
    // Find the model config to get its name
    const mc = allModelConfigs.find(c => c.id === id);
    cloneModelConfigId = id;

    const input = document.getElementById('cloneModelConfigName');
    input.value = mc ? `${mc.name} (Copy)` : '';

    document.getElementById('cloneModelConfigModal').classList.remove('hidden');
    input.focus();
    input.select();
}

function closeModelConfigCloneModal() {
    document.getElementById('cloneModelConfigModal').classList.add('hidden');
    cloneModelConfigId = null;
}

function submitModelConfigClone() {
    const newName = document.getElementById('cloneModelConfigName').value.trim();
    if (!newName) {
        alert('Please enter a name for the cloned config');
        return;
    }

    if (!cloneModelConfigId) {
        alert('No model config selected');
        return;
    }

    fetch(`/api/model-configs/${cloneModelConfigId}/clone/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ name: newName })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            closeModelConfigCloneModal();
            loadModelConfigs();
            showToast('Model config cloned successfully', 'success');
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(err => {
        console.error('Error cloning model config:', err);
        alert('Error cloning model config');
    });
}

// =============================================================================
// MODEL CONFIG COMPARE FUNCTIONALITY
// =============================================================================

function openModelConfigCompareModal() {
    // Populate dropdowns with all model configs
    const leftSelect = document.getElementById('mcCompareLeftSelect');
    const rightSelect = document.getElementById('mcCompareRightSelect');

    // Clear existing options except placeholder
    leftSelect.innerHTML = '<option value="">Select model config...</option>';
    rightSelect.innerHTML = '<option value="">Select model config...</option>';

    // Add all configs to both dropdowns
    allModelConfigs.forEach(config => {
        const optionLeft = document.createElement('option');
        optionLeft.value = config.id;
        optionLeft.textContent = config.name;
        leftSelect.appendChild(optionLeft);

        const optionRight = document.createElement('option');
        optionRight.value = config.id;
        optionRight.textContent = config.name;
        rightSelect.appendChild(optionRight);
    });

    // Reset state
    mcCompareLeftConfig = null;
    mcCompareRightConfig = null;

    // Reset headers to placeholder state
    document.getElementById('mcCompareLeftHeader').innerHTML = `
        <div class="flex items-center justify-center h-full text-gray-400 py-4">
            <span>Select a model config</span>
        </div>
    `;
    document.getElementById('mcCompareRightHeader').innerHTML = `
        <div class="flex items-center justify-center h-full text-gray-400 py-4">
            <span>Select a model config</span>
        </div>
    `;

    // Hide data sections
    document.getElementById('mcCompareBuyerSection').classList.add('hidden');
    document.getElementById('mcCompareProductSection').classList.add('hidden');
    document.getElementById('mcCompareSettingsSection').classList.add('hidden');

    // Show modal
    document.getElementById('compareModelConfigsModal').classList.remove('hidden');
}

function closeModelConfigCompareModal() {
    document.getElementById('compareModelConfigsModal').classList.add('hidden');
    mcCompareLeftConfig = null;
    mcCompareRightConfig = null;
}

function resetMcCompareColumn(side) {
    const prefix = side === 'left' ? 'mcCompareLeft' : 'mcCompareRight';

    document.getElementById(`${prefix}Header`).innerHTML = `
        <div class="flex items-center justify-center h-full text-gray-400 py-4">
            <span>Select a model config</span>
        </div>
    `;

    // Re-render comparison view
    renderMcCompareView();
}

function onMcCompareSelectChange(side) {
    const selectId = side === 'left' ? 'mcCompareLeftSelect' : 'mcCompareRightSelect';
    const configId = document.getElementById(selectId).value;

    if (!configId) {
        // Reset this side
        if (side === 'left') mcCompareLeftConfig = null;
        else mcCompareRightConfig = null;
        resetMcCompareColumn(side);
        updateMcCompareRowVisibility();
        return;
    }

    // Show loading state
    const prefix = side === 'left' ? 'mcCompareLeft' : 'mcCompareRight';
    document.getElementById(`${prefix}Header`).innerHTML = `
        <div class="flex items-center justify-center h-full text-gray-400 py-4">
            <i class="fas fa-spinner fa-spin mr-2"></i>Loading...
        </div>
    `;

    // Fetch config data
    fetch(`/api/model-configs/${configId}/`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                if (side === 'left') mcCompareLeftConfig = data.data;
                else mcCompareRightConfig = data.data;
                renderMcCompareView();
                updateMcCompareRowVisibility();
            } else {
                document.getElementById(`${prefix}Header`).innerHTML = `
                    <div class="flex items-center justify-center h-full text-red-400 py-4">
                        <span>Failed to load</span>
                    </div>
                `;
            }
        })
        .catch(err => {
            console.error('Error loading model config:', err);
            document.getElementById(`${prefix}Header`).innerHTML = `
                <div class="flex items-center justify-center h-full text-red-400 py-4">
                    <span>Error loading config</span>
                </div>
            `;
        });
}

function updateMcCompareRowVisibility() {
    const hasAny = mcCompareLeftConfig !== null || mcCompareRightConfig !== null;

    document.getElementById('mcCompareBuyerSection').classList.toggle('hidden', !hasAny);
    document.getElementById('mcCompareProductSection').classList.toggle('hidden', !hasAny);
    document.getElementById('mcCompareSettingsSection').classList.toggle('hidden', !hasAny);
}

/**
 * Main render function for the comparison view
 * Renders both configs side-by-side with aligned layers
 */
function renderMcCompareView() {
    const leftConfig = mcCompareLeftConfig;
    const rightConfig = mcCompareRightConfig;

    // Render headers
    renderMcCompareHeader('mcCompareLeftHeader', leftConfig);
    renderMcCompareHeader('mcCompareRightHeader', rightConfig);

    // Render tower sections with aligned layers
    renderMcCompareTowerSection(
        'buyer',
        leftConfig?.buyer_tower_layers || [],
        rightConfig?.buyer_tower_layers || [],
        leftConfig,
        rightConfig
    );

    renderMcCompareTowerSection(
        'product',
        leftConfig?.product_tower_layers || [],
        rightConfig?.product_tower_layers || [],
        leftConfig,
        rightConfig
    );

    // Render Rating Head section (for Ranking and Multitask models)
    const leftHasRatingHead = ['ranking', 'multitask'].includes(leftConfig?.model_type);
    const rightHasRatingHead = ['ranking', 'multitask'].includes(rightConfig?.model_type);
    const ratingHeadSection = document.getElementById('mcCompareRatingHeadSection');

    if (leftHasRatingHead || rightHasRatingHead) {
        ratingHeadSection.classList.remove('hidden');
        renderMcCompareTowerSection(
            'rating_head',
            leftHasRatingHead ? (leftConfig?.rating_head_layers || []) : [],
            rightHasRatingHead ? (rightConfig?.rating_head_layers || []) : [],
            leftConfig,
            rightConfig,
            leftHasRatingHead,  // leftSupported - true if model has rating head
            rightHasRatingHead  // rightSupported - true if model has rating head
        );
    } else {
        ratingHeadSection.classList.add('hidden');
    }

    // Render settings section
    renderMcCompareSettings(leftConfig, rightConfig);
}

/**
 * Render a single header card
 */
function renderMcCompareHeader(elementId, config) {
    const element = document.getElementById(elementId);
    if (!config) {
        element.innerHTML = `
            <div class="flex items-center justify-center h-full text-gray-400 py-4">
                <span>Select a model config</span>
            </div>
        `;
        return;
    }

    const modelTypeBadgeClass = config.model_type || 'retrieval';
    element.innerHTML = `
        <div class="flex items-start justify-between">
            <div>
                <div class="font-semibold text-gray-900 text-lg">${escapeHtml(config.name)}</div>
                ${config.description ? `<div class="text-sm text-gray-400 mt-1 max-w-xs truncate">${escapeHtml(config.description)}</div>` : ''}
            </div>
            <span class="model-type-badge ${modelTypeBadgeClass}">${config.model_type_display || config.model_type}</span>
        </div>
    `;
}

/**
 * Render a tower section with aligned layers
 */
function renderMcCompareTowerSection(tower, leftLayers, rightLayers, leftConfig, rightConfig, leftSupported = true, rightSupported = true) {
    const layersContainer = document.getElementById(`mcCompare${tower.charAt(0).toUpperCase() + tower.slice(1)}Layers`);
    const paramsContainer = document.getElementById(`mcCompare${tower.charAt(0).toUpperCase() + tower.slice(1)}Params`);

    // Check if we need to show N/A for either side (model doesn't support this component)
    const leftShowNA = leftConfig && !leftSupported;
    const rightShowNA = rightConfig && !rightSupported;

    // Align layers with output layers at the bottom
    const alignedRows = alignTowerLayers(leftLayers, rightLayers);

    // Render aligned layer rows
    layersContainer.innerHTML = alignedRows.map((row, idx) => {
        const isOutput = idx === alignedRows.length - 1 && (row.left || row.right);
        const isDifferent = layersAreDifferent(row.left, row.right);

        return `
            <div class="mc-compare-layer-row">
                ${renderMcCompareLayerCell(row.left, isOutput, isDifferent && row.left && row.right, leftShowNA)}
                ${renderMcCompareLayerCell(row.right, isOutput, isDifferent && row.left && row.right, rightShowNA)}
            </div>
        `;
    }).join('');

    // Render params comparison
    const leftParams = calculateSingleTowerParams(leftLayers);
    const rightParams = calculateSingleTowerParams(rightLayers);
    const paramsDifferent = leftConfig && rightConfig && leftParams !== rightParams;

    paramsContainer.innerHTML = `
        <div class="mc-compare-params-cell ${paramsDifferent ? 'mc-compare-diff' : ''}">
            ${leftShowNA ? 'N/A' : (leftConfig ? `Params: ${leftParams.toLocaleString()}` : '')}
        </div>
        <div class="mc-compare-params-cell ${paramsDifferent ? 'mc-compare-diff' : ''}">
            ${rightShowNA ? 'N/A' : (rightConfig ? `Params: ${rightParams.toLocaleString()}` : '')}
        </div>
    `;
}

/**
 * Align two tower layer arrays with output layers at bottom
 * Returns array of {left, right} pairs
 */
function alignTowerLayers(leftLayers, rightLayers) {
    const result = [];
    const maxLen = Math.max(leftLayers.length, rightLayers.length);

    if (maxLen === 0) {
        return [{ left: null, right: null }];
    }

    // Separate output layers (last layer) from regular layers
    const leftRegular = leftLayers.length > 0 ? leftLayers.slice(0, -1) : [];
    const leftOutput = leftLayers.length > 0 ? leftLayers[leftLayers.length - 1] : null;
    const rightRegular = rightLayers.length > 0 ? rightLayers.slice(0, -1) : [];
    const rightOutput = rightLayers.length > 0 ? rightLayers[rightLayers.length - 1] : null;

    // Calculate placeholders needed before output layer
    const maxRegular = Math.max(leftRegular.length, rightRegular.length);

    // Add regular layers with placeholders
    for (let i = 0; i < maxRegular; i++) {
        result.push({
            left: i < leftRegular.length ? leftRegular[i] : null,
            right: i < rightRegular.length ? rightRegular[i] : null
        });
    }

    // Add output layer row (always aligned at bottom)
    if (leftOutput || rightOutput) {
        result.push({
            left: leftOutput,
            right: rightOutput
        });
    }

    return result;
}

/**
 * Render a single layer cell
 */
function renderMcCompareLayerCell(layer, isOutput, isDifferent, showNA = false) {
    if (!layer) {
        if (showNA) {
            return `<div class="mc-compare-layer-cell placeholder na-cell"><span class="text-gray-400 text-sm">N/A</span></div>`;
        }
        return `<div class="mc-compare-layer-cell placeholder"></div>`;
    }

    let badge = '';
    let params = '';

    if (layer.type === 'dense') {
        badge = '<span class="layer-badge dense">Dense</span>';
        params = `${layer.units} units, ${layer.activation || 'relu'}`;
        const l2 = layer.l2_regularization || layer.l2_reg;
        if (l2) params += `, L2=${l2}`;
    } else if (layer.type === 'dropout') {
        badge = '<span class="layer-badge dropout">Dropout</span>';
        params = `rate: ${layer.rate}`;
    } else if (layer.type === 'batch_norm') {
        badge = '<span class="layer-badge batch_norm">BatchNorm</span>';
        params = '';
    } else if (layer.type === 'layer_norm') {
        badge = '<span class="layer-badge layer_norm">LayerNorm</span>';
        params = layer.epsilon ? `: ${layer.epsilon}` : '';
    }

    const classes = ['mc-compare-layer-cell'];
    if (isOutput) classes.push('output-layer');
    if (isDifferent) classes.push('mc-compare-diff');

    return `
        <div class="${classes.join(' ')}">
            ${badge}
            <span class="layer-params">${params}</span>
        </div>
    `;
}

/**
 * Check if two layers are different
 */
function layersAreDifferent(layer1, layer2) {
    if (!layer1 || !layer2) return true;
    if (layer1.type !== layer2.type) return true;

    if (layer1.type === 'dense') {
        if (layer1.units !== layer2.units) return true;
        if (layer1.activation !== layer2.activation) return true;
        const l2_1 = layer1.l2_regularization || layer1.l2_reg || 0;
        const l2_2 = layer2.l2_regularization || layer2.l2_reg || 0;
        if (l2_1 !== l2_2) return true;
    } else if (layer1.type === 'dropout') {
        if (layer1.rate !== layer2.rate) return true;
    } else if (layer1.type === 'layer_norm') {
        if (layer1.epsilon !== layer2.epsilon) return true;
    }
    // batch_norm has no params to compare

    return false;
}

/**
 * Render the settings comparison section
 */
function renderMcCompareSettings(leftConfig, rightConfig) {
    const container = document.getElementById('mcCompareSettingsGrid');

    // Build settings rows data
    const settingsRows = [
        { label: 'Optimizer', leftValue: leftConfig?.optimizer_display || leftConfig?.optimizer, rightValue: rightConfig?.optimizer_display || rightConfig?.optimizer, leftRaw: leftConfig?.optimizer, rightRaw: rightConfig?.optimizer },
        { label: 'Learning Rate', leftValue: leftConfig?.learning_rate, rightValue: rightConfig?.learning_rate },
        { label: 'Batch Size', leftValue: leftConfig?.batch_size, rightValue: rightConfig?.batch_size },
        { label: 'Output Dim', leftValue: leftConfig ? `${leftConfig.output_embedding_dim}D` : null, rightValue: rightConfig ? `${rightConfig.output_embedding_dim}D` : null, leftRaw: leftConfig?.output_embedding_dim, rightRaw: rightConfig?.output_embedding_dim },
    ];

    // Helper functions to check model capabilities
    const hasRetrievalSettings = (modelType) => ['retrieval', 'multitask'].includes(modelType);
    const hasRankingSettings = (modelType) => ['ranking', 'multitask'].includes(modelType);
    const isMultitask = (modelType) => modelType === 'multitask';

    // Add retrieval-specific settings (for retrieval and multitask models)
    if (hasRetrievalSettings(leftConfig?.model_type) || hasRetrievalSettings(rightConfig?.model_type)) {
        settingsRows.push(
            {
                label: 'Algorithm',
                leftValue: hasRetrievalSettings(leftConfig?.model_type) ? (leftConfig?.retrieval_algorithm_display || leftConfig?.retrieval_algorithm || 'Brute Force') : 'N/A',
                rightValue: hasRetrievalSettings(rightConfig?.model_type) ? (rightConfig?.retrieval_algorithm_display || rightConfig?.retrieval_algorithm || 'Brute Force') : 'N/A',
                leftRaw: hasRetrievalSettings(leftConfig?.model_type) ? leftConfig?.retrieval_algorithm : null,
                rightRaw: hasRetrievalSettings(rightConfig?.model_type) ? rightConfig?.retrieval_algorithm : null
            },
            {
                label: 'Top-K',
                leftValue: hasRetrievalSettings(leftConfig?.model_type) ? (leftConfig?.top_k || 100) : 'N/A',
                rightValue: hasRetrievalSettings(rightConfig?.model_type) ? (rightConfig?.top_k || 100) : 'N/A',
                leftRaw: hasRetrievalSettings(leftConfig?.model_type) ? (leftConfig?.top_k || 100) : null,
                rightRaw: hasRetrievalSettings(rightConfig?.model_type) ? (rightConfig?.top_k || 100) : null
            }
        );
    }

    // Add ranking-specific settings (for ranking and multitask models)
    if (hasRankingSettings(leftConfig?.model_type) || hasRankingSettings(rightConfig?.model_type)) {
        settingsRows.push(
            {
                label: 'Loss Function',
                leftValue: hasRankingSettings(leftConfig?.model_type) ? (leftConfig?.loss_function_display || leftConfig?.loss_function || 'MSE') : 'N/A',
                rightValue: hasRankingSettings(rightConfig?.model_type) ? (rightConfig?.loss_function_display || rightConfig?.loss_function || 'MSE') : 'N/A',
                leftRaw: hasRankingSettings(leftConfig?.model_type) ? leftConfig?.loss_function : null,
                rightRaw: hasRankingSettings(rightConfig?.model_type) ? rightConfig?.loss_function : null
            }
        );
    }

    // Add multitask-specific settings (loss weights as percentages)
    if (isMultitask(leftConfig?.model_type) || isMultitask(rightConfig?.model_type)) {
        const formatWeight = (weight) => weight !== null && weight !== undefined ? `${Math.round(weight * 100)}%` : 'N/A';
        settingsRows.push(
            {
                label: 'Retrieval Weight',
                leftValue: isMultitask(leftConfig?.model_type) ? formatWeight(leftConfig?.retrieval_weight) : 'N/A',
                rightValue: isMultitask(rightConfig?.model_type) ? formatWeight(rightConfig?.retrieval_weight) : 'N/A',
                leftRaw: isMultitask(leftConfig?.model_type) ? leftConfig?.retrieval_weight : null,
                rightRaw: isMultitask(rightConfig?.model_type) ? rightConfig?.retrieval_weight : null
            },
            {
                label: 'Ranking Weight',
                leftValue: isMultitask(leftConfig?.model_type) ? formatWeight(leftConfig?.ranking_weight) : 'N/A',
                rightValue: isMultitask(rightConfig?.model_type) ? formatWeight(rightConfig?.ranking_weight) : 'N/A',
                leftRaw: isMultitask(leftConfig?.model_type) ? leftConfig?.ranking_weight : null,
                rightRaw: isMultitask(rightConfig?.model_type) ? rightConfig?.ranking_weight : null
            }
        );
    }

    const renderSettingsCard = (config, rows, side) => {
        if (!config) {
            return `<div class="mc-compare-settings-card">
                <div class="text-center text-gray-400 py-4">No config selected</div>
            </div>`;
        }

        return `<div class="mc-compare-settings-card">
            ${rows.map(row => {
                const value = side === 'left' ? row.leftValue : row.rightValue;
                const rawLeft = row.leftRaw !== undefined ? row.leftRaw : row.leftValue;
                const rawRight = row.rightRaw !== undefined ? row.rightRaw : row.rightValue;
                const otherConfig = side === 'left' ? rightConfig : leftConfig;
                const isDiff = otherConfig && rawLeft !== rawRight;

                return `
                    <div class="setting-row ${isDiff ? 'mc-compare-diff' : ''}">
                        <span class="label">${row.label}</span>
                        <span class="value">${value !== null && value !== undefined ? value : '-'}</span>
                    </div>
                `;
            }).join('')}
        </div>`;
    };

    container.innerHTML = `
        ${renderSettingsCard(leftConfig, settingsRows, 'left')}
        ${renderSettingsCard(rightConfig, settingsRows, 'right')}
    `;
}

// Delete Model Config
function deleteModelConfig(id) {
    if (!confirm('Are you sure you want to delete this model config?')) return;

    fetch(`/api/model-configs/${id}/delete/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            loadModelConfigs();
            showToast('Model config deleted', 'success');
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(err => {
        console.error('Error deleting model config:', err);
        alert('Error deleting model config');
    });
}

// Edit Model Config (opens wizard in edit mode) - from View modal
function editModelConfig() {
    if (!viewingModelConfig) return;
    editModelConfigById(viewingModelConfig.id);
    closeModelConfigViewModal();
}

// Helper: Escape HTML
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Helper: Show Toast (if not already defined)
if (typeof showToast !== 'function') {
    function showToast(message, type) {
        console.log(`[${type}] ${message}`);
    }
}
</script>
{% endblock %}
