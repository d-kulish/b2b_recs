{% extends 'base_model.html' %}
{% load humanize %}
{% load static %}

{% block title %}{{ model.name }} - Configs{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/cards.css' %}?v=4">
<link rel="stylesheet" href="{% static 'css/modals.css' %}?v=2">
<style>
    /* =========================================================================
       CONFIGS DASHBOARD CHAPTER STYLES
       ========================================================================= */

    /* KPI Row Layout */
    .configs-dashboard-kpi-row {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
        margin-bottom: 24px;
    }

    /* Individual KPI Card */
    .configs-dashboard-kpi-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .configs-dashboard-kpi-card:hover {
        border-color: #d1d5db;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    .configs-dashboard-kpi-card.active {
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .configs-dashboard-kpi-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
    }

    .configs-dashboard-kpi-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .configs-dashboard-kpi-icon.datasets {
        background: linear-gradient(135deg, #6366f1, #818cf8);
    }

    .configs-dashboard-kpi-icon.features {
        background: linear-gradient(135deg, #10b981, #34d399);
    }

    .configs-dashboard-kpi-icon.models {
        background: linear-gradient(135deg, #f59e0b, #fbbf24);
    }

    .configs-dashboard-kpi-icon i {
        color: white;
        font-size: 18px;
    }

    .configs-dashboard-kpi-title {
        font-size: 14px;
        font-weight: 600;
        color: #374151;
    }

    .configs-dashboard-kpi-stats {
        display: flex;
        gap: 12px;
    }

    .configs-dashboard-kpi-stat {
        flex: 1;
        text-align: center;
        padding: 10px 8px;
        background: #f9fafb;
        border-radius: 8px;
    }

    .configs-dashboard-kpi-value {
        font-size: 24px;
        font-weight: 700;
        color: #111827;
        line-height: 1.2;
    }

    .configs-dashboard-kpi-value.active {
        color: #10b981;
    }

    .configs-dashboard-kpi-value.unused {
        color: #9ca3af;
    }

    .configs-dashboard-kpi-label {
        font-size: 11px;
        color: #6b7280;
        margin-top: 2px;
    }

    /* Complexity Bar */
    .configs-dashboard-complexity-row {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #f3f4f6;
    }

    .configs-dashboard-complexity-label {
        font-size: 11px;
        color: #6b7280;
        margin-bottom: 6px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .configs-dashboard-complexity-bar {
        height: 6px;
        background: #e5e7eb;
        border-radius: 3px;
        overflow: hidden;
        display: flex;
    }

    .configs-dashboard-complexity-segment {
        height: 100%;
        transition: width 0.3s ease;
    }

    .configs-dashboard-complexity-segment.low {
        background: #10b981;
    }

    .configs-dashboard-complexity-segment.medium {
        background: #f59e0b;
    }

    .configs-dashboard-complexity-segment.high {
        background: #ef4444;
    }

    /* Coverage Matrix Section */
    .configs-dashboard-section {
        margin-top: 24px;
        padding-top: 24px;
        border-top: 1px solid #e5e7eb;
    }

    .configs-dashboard-section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
    }

    .configs-dashboard-section-title {
        font-size: 16px;
        font-weight: 600;
        color: #374151;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .configs-dashboard-section-title i {
        color: #6b7280;
        font-size: 14px;
    }

    /* Coverage Matrix Table */
    .configs-dashboard-matrix {
        width: 100%;
        border-collapse: separate;
        border-spacing: 2px;
        font-size: 12px;
    }

    .configs-dashboard-matrix th {
        padding: 8px 12px;
        text-align: center;
        font-weight: 500;
        color: #6b7280;
        background: #f9fafb;
        border-radius: 6px;
    }

    .configs-dashboard-matrix th.row-header {
        text-align: left;
        max-width: 150px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .configs-dashboard-matrix td {
        padding: 0;
    }

    .configs-dashboard-matrix-cell {
        width: 100%;
        height: 40px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 500;
        color: white;
    }

    .configs-dashboard-matrix-cell:hover {
        transform: scale(1.05);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    /* Heat colors for coverage matrix */
    .configs-dashboard-heat-0 {
        background: #f3f4f6;
        color: #9ca3af;
    }

    .configs-dashboard-heat-1 {
        background: #dbeafe;
        color: #1e40af;
    }

    .configs-dashboard-heat-2 {
        background: #93c5fd;
        color: #1e40af;
    }

    .configs-dashboard-heat-3 {
        background: #3b82f6;
        color: white;
    }

    .configs-dashboard-heat-4 {
        background: #1d4ed8;
        color: white;
    }

    .configs-dashboard-matrix-cell-na {
        background: repeating-linear-gradient(
            45deg,
            #f3f4f6,
            #f3f4f6 4px,
            #e5e7eb 4px,
            #e5e7eb 8px
        );
        color: #9ca3af;
        cursor: not-allowed;
    }

    /* Relationships Diagram */
    .configs-dashboard-relationships {
        min-height: 200px;
        position: relative;
        overflow-x: auto;
    }

    .configs-dashboard-flow-container {
        display: flex;
        align-items: flex-start;
        gap: 60px;
        padding: 20px 0;
    }

    .configs-dashboard-flow-column {
        display: flex;
        flex-direction: column;
        gap: 12px;
        min-width: 180px;
    }

    .configs-dashboard-flow-title {
        font-size: 11px;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 8px;
        text-align: center;
    }

    .configs-dashboard-node {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 10px 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
    }

    .configs-dashboard-node:hover {
        border-color: #6366f1;
        box-shadow: 0 2px 8px rgba(99, 102, 241, 0.15);
    }

    .configs-dashboard-node.dataset {
        border-left: 3px solid #6366f1;
    }

    .configs-dashboard-node.feature-config {
        border-left: 3px solid #10b981;
    }

    .configs-dashboard-node-name {
        font-size: 13px;
        font-weight: 500;
        color: #374151;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .configs-dashboard-node-meta {
        font-size: 11px;
        color: #9ca3af;
        margin-top: 4px;
    }

    .configs-dashboard-node-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 500;
        margin-top: 6px;
    }

    .configs-dashboard-node-badge.experiments {
        background: #dbeafe;
        color: #1e40af;
    }

    /* Connection lines (SVG) */
    .configs-dashboard-connections {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
    }

    .configs-dashboard-connection {
        fill: none;
        stroke: #d1d5db;
        stroke-width: 2;
    }

    .configs-dashboard-connection.active {
        stroke: #6366f1;
        stroke-width: 2;
    }

    /* Empty State */
    .configs-dashboard-empty {
        text-align: center;
        padding: 40px 20px;
        color: #6b7280;
    }

    .configs-dashboard-empty i {
        font-size: 48px;
        color: #d1d5db;
        margin-bottom: 16px;
    }

    .configs-dashboard-empty-title {
        font-size: 16px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
    }

    .configs-dashboard-empty-text {
        font-size: 14px;
        margin-bottom: 20px;
    }

    /* Loading State */
    .configs-dashboard-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px 20px;
        color: #6b7280;
    }

    /* Feature Config specific styles */
    .tensor-dim-bar {
        height: 8px;
        background: #e5e7eb;
        border-radius: 4px;
        overflow: hidden;
    }
    .tensor-dim-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.3s ease;
    }
    .tensor-dim-fill.buyer {
        background: linear-gradient(90deg, #3b82f6, #60a5fa);
    }
    .tensor-dim-fill.product {
        background: linear-gradient(90deg, #10b981, #34d399);
    }
    .tensor-breakdown {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-top: 8px;
    }
    .tensor-breakdown-item {
        font-size: 11px;
        padding: 2px 6px;
        background: #f3f4f6;
        border-radius: 4px;
        color: #6b7280;
    }
    .config-card {
        transition: all 0.2s ease;
    }
    .config-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 8px;
        border-radius: 9999px;
        font-size: 11px;
        font-weight: 500;
    }
    .status-badge.draft {
        background: #fef3c7;
        color: #92400e;
    }
    .status-badge.active {
        background: #d1fae5;
        color: #065f46;
    }
    .status-badge.archived {
        background: #e5e7eb;
        color: #6b7280;
    }
    .leakage-warning {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 6px;
        background: #fef3c7;
        border-radius: 4px;
        font-size: 11px;
        color: #92400e;
    }

    /* Model type compatibility badge */
    .model-type-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 500;
        white-space: nowrap;
    }
    .model-type-badge i {
        font-size: 9px;
    }
    .model-type-retrieval {
        background: #dbeafe;
        color: #1e40af;
        border: 1px solid #bfdbfe;
    }
    .model-type-all {
        background: linear-gradient(135deg, #dbeafe 0%, #fae8ff 50%, #ffedd5 100%);
        color: #6b21a8;
        border: 1px solid #e9d5ff;
    }
    .model-type-ranking {
        background: #fef3c7;
        color: #92400e;
        border: 1px solid #fde68a;
    }
    .model-type-hybrid {
        background: linear-gradient(135deg, #dbeafe 0%, #f3e8ff 100%);
        color: #6b21a8;
        border: 1px solid #e9d5ff;
    }

    /* Drag and drop styles - Compact column cards */
    .column-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 6px 8px;
        cursor: grab;
        transition: all 0.15s ease;
        user-select: none;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .column-card:hover {
        border-color: #3b82f6;
        background: #f8fafc;
    }
    .column-card.dragging {
        opacity: 0.5;
        cursor: grabbing;
    }
    .column-card .drag-handle {
        color: #d1d5db;
        font-size: 10px;
        flex-shrink: 0;
    }
    .column-card .column-name {
        font-size: 12px;
        font-weight: 500;
        color: #374151;
        flex: 1;
        min-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .column-card .column-type {
        font-size: 10px;
        padding: 1px 4px;
        background: #f3f4f6;
        border-radius: 3px;
        color: #6b7280;
        text-transform: uppercase;
    }

    .drop-zone {
        min-height: 200px;
        border: 2px dashed #e5e7eb;
        border-radius: 12px;
        padding: 16px;
        transition: all 0.2s ease;
    }
    .drop-zone.drag-over {
        border-color: #3b82f6;
        background: #eff6ff;
    }
    .drop-zone-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 150px;
        color: #9ca3af;
    }

    .assigned-feature {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 8px;
    }
    .assigned-feature:hover {
        border-color: #d1d5db;
    }
    .feature-config-btn {
        width: 28px;
        height: 28px;
        border-radius: 6px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: none;
        cursor: pointer;
        transition: all 0.15s ease;
    }
    .feature-config-btn.settings {
        background: #f3f4f6;
        color: #6b7280;
    }
    .feature-config-btn.settings:hover {
        background: #e5e7eb;
        color: #374151;
    }
    .feature-config-btn.remove {
        background: #fef2f2;
        color: #dc2626;
    }
    .feature-config-btn.remove:hover {
        background: #fee2e2;
    }

    .cross-feature {
        background: #f0fdf4;
        border: 1px solid #bbf7d0;
        border-radius: 8px;
        padding: 10px 12px;
        margin-bottom: 8px;
    }

    /* Target Column Zone (for Ranking models) */
    .target-column-section {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #e5e7eb;
    }
    .target-column-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
    }
    .target-column-header h5 {
        margin: 0;
        font-weight: 600;
        color: #374151;
    }
    .target-column-badge {
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.7em;
        font-weight: 600;
        background-color: #fef3c7;
        color: #92400e;
    }
    .target-column-zone {
        min-height: 70px;
        border: 2px dashed #f59e0b;
        border-radius: 8px;
        padding: 16px;
        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        transition: all 0.2s ease;
    }
    .target-column-zone.drag-over {
        border-color: #d97706;
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
    }
    .target-column-zone .placeholder-text {
        text-align: center;
        color: #92400e;
    }
    .target-column-zone .placeholder-text p {
        margin: 0 0 4px 0;
        font-size: 0.875rem;
    }
    .target-column-zone .placeholder-text small {
        color: #b45309;
        font-size: 0.75rem;
    }
    .target-column-card {
        background: white;
        border: 2px solid #f59e0b;
        border-radius: 8px;
        padding: 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .target-column-card .column-info {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .target-column-card .column-name {
        font-weight: 600;
        color: #92400e;
    }
    .target-column-card .column-type {
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.7em;
        background-color: #fef3c7;
        color: #92400e;
    }
    .target-column-config {
        margin-top: 12px;
        padding: 12px;
        background: #fffbeb;
        border: 1px solid #fde68a;
        border-radius: 8px;
    }
    .target-column-config h6 {
        margin: 0 0 8px 0;
        font-size: 0.8rem;
        font-weight: 600;
        color: #92400e;
    }
    .target-column-config .form-check {
        margin-bottom: 6px;
    }
    .target-column-config .form-check-label {
        font-size: 0.8rem;
        color: #78350f;
    }
    .target-column-config .form-check-label small {
        color: #a16207;
    }

    /* Target Column Card (View Modal - matching experiments page style) */
    .target-column-view-card {
        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        border: 1.5px solid #fbbf24;
        border-radius: 10px;
        padding: 12px 14px;
        margin-bottom: 16px;
    }
    .target-column-view-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
        font-size: 13px;
        font-weight: 600;
        color: #b45309;
    }
    .target-column-view-header i {
        color: #f59e0b;
    }
    .target-column-view-badge {
        background: #fbbf24;
        color: white;
        font-size: 10px;
        font-weight: 600;
        padding: 2px 8px;
        border-radius: 10px;
        margin-left: auto;
    }
    .target-column-view-content {
        display: flex;
        align-items: center;
        gap: 10px;
        background: white;
        border: 1px solid #fcd34d;
        border-radius: 8px;
        padding: 8px 12px;
    }
    .target-column-view-name {
        font-weight: 600;
        color: #92400e;
        font-size: 14px;
    }
    .target-column-view-type {
        background: #fef3c7;
        color: #b45309;
        font-size: 11px;
        font-weight: 500;
        padding: 2px 8px;
        border-radius: 4px;
        text-transform: uppercase;
    }
    .target-column-view-transforms {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 10px;
    }
    .target-transform-tag {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        background: white;
        border: 1px solid #fcd34d;
        color: #92400e;
        font-size: 11px;
        padding: 3px 8px;
        border-radius: 6px;
    }
    .target-transform-tag i {
        font-size: 10px;
        color: #f59e0b;
    }

    /* Clip Options Container */
    .clip-options-container {
        margin-left: 24px;
        margin-top: 8px;
        padding: 12px;
        background: #fefce8;
        border: 1px solid #fef08a;
        border-radius: 8px;
    }
    .clip-bound-row {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 8px;
    }
    .clip-bound-check {
        min-width: 110px;
        margin-right: 0;
    }
    .clip-bound-check .form-check-label {
        font-size: 0.8rem;
        color: #78350f;
    }
    .clip-percentile-select {
        width: 80px;
        padding: 4px 8px;
        font-size: 0.8rem;
        border: 1px solid #fde68a;
        border-radius: 4px;
        background: #fff;
        color: #78350f;
    }
    .clip-percentile-label {
        font-size: 0.75rem;
        color: #a16207;
    }
    .clip-info-text {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px dashed #fde68a;
        font-size: 0.75rem;
        color: #92400e;
        line-height: 1.4;
    }
    .clip-info-text i {
        color: #f59e0b;
        margin-right: 4px;
    }

    /* Config type badge in list */
    .config-type-badge {
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.65em;
        font-weight: 600;
        margin-left: 8px;
    }
    .config-type-badge.retrieval {
        background-color: #dbeafe;
        color: #1e40af;
    }
    .config-type-badge.ranking {
        background-color: #fef3c7;
        color: #92400e;
    }

    /* Tensor preview */
    .tensor-preview-panel {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 16px;
    }
    .tensor-preview-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
    }
    .tensor-preview-title {
        font-weight: 600;
        color: #374151;
    }
    .tensor-preview-total {
        font-size: 24px;
        font-weight: 700;
    }
    .tensor-preview-total.buyer {
        color: #3b82f6;
    }
    .tensor-preview-total.product {
        color: #10b981;
    }
    .tensor-breakdown-bar {
        display: flex;
        height: 24px;
        border-radius: 6px;
        overflow: hidden;
        background: #e5e7eb;
        margin-bottom: 8px;
    }
    .tensor-breakdown-segment {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: 500;
        color: white;
        transition: width 0.3s ease;
        overflow: hidden;
        white-space: nowrap;
    }

    /* Modal form styles */
    .modal-form-group {
        margin-bottom: 16px;
    }
    .modal-form-label {
        display: block;
        font-size: 13px;
        font-weight: 500;
        color: #374151;
        margin-bottom: 6px;
    }
    .modal-form-hint {
        font-size: 12px;
        color: #6b7280;
        margin-top: 4px;
    }
    .transform-option {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        padding: 12px;
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        margin-bottom: 8px;
    }
    .transform-option input[type="checkbox"] {
        margin-top: 2px;
    }
    .transform-option-content {
        flex: 1;
    }
    .transform-option-title {
        font-weight: 500;
        color: #374151;
    }
    .transform-option-desc {
        font-size: 12px;
        color: #6b7280;
        margin-top: 2px;
    }
    .transform-option-dim {
        font-size: 12px;
        font-weight: 600;
        color: #3b82f6;
        white-space: nowrap;
    }

    /* Sample Table Styles */
    .sample-table-container {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        overflow: hidden;
    }
    .sample-table-wrapper {
        max-height: 240px;
        overflow: auto;
    }
    .sample-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
    }
    .sample-table th {
        position: sticky;
        top: 0;
        background: #f9fafb;
        padding: 8px 12px;
        text-align: left;
        font-weight: 600;
        color: #374151;
        border-bottom: 2px solid #e5e7eb;
        white-space: nowrap;
    }
    .sample-table td {
        padding: 6px 12px;
        border-bottom: 1px solid #f3f4f6;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .sample-table tr:hover td {
        background: #f9fafb;
    }

    /* Column assignment colors for sample table */
    .col-buyer {
        background-color: #eff6ff !important;
    }
    .col-product {
        background-color: #f0fdf4 !important;
    }
    .col-both {
        background-color: #fef2f2 !important;
    }
    .sample-table th.col-buyer {
        background-color: #dbeafe !important;
        border-bottom-color: #3b82f6;
    }
    .sample-table th.col-product {
        background-color: #dcfce7 !important;
        border-bottom-color: #10b981;
    }
    .sample-table th.col-both {
        background-color: #fee2e2 !important;
        border-bottom-color: #ef4444;
    }
    .null-value {
        color: #9ca3af;
        font-style: italic;
    }

    /* BQ type badge in column cards */
    .column-bq-type {
        font-size: 9px;
        padding: 1px 4px;
        background: #f3f4f6;
        border-radius: 3px;
        color: #6b7280;
        font-family: monospace;
        flex-shrink: 0;
        text-transform: uppercase;
    }

    /* Needs attention state for features without transforms */
    .feature-config-btn.needs-attention {
        background: #fef3c7;
        color: #d97706;
        animation: pulse-attention 2s infinite;
    }
    @keyframes pulse-attention {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }
    .assigned-feature.feature-needs-config {
        background: #fef3c7;
        border-color: #fcd34d;
    }

    /* Column card assignment states */
    .column-card.assigned-buyer {
        border-left: 2px solid #3b82f6;
        background: #eff6ff;
    }
    .column-card.assigned-product {
        border-left: 2px solid #10b981;
        background: #f0fdf4;
    }
    .column-card.assigned-both {
        border-left: 2px solid #ef4444;
        background: #fef2f2;
    }

    /* Primary ID Drop Zone Styles */
    .primary-id-zone {
        border: 2px dashed #f59e0b;
        border-radius: 10px;
        padding: 16px;
        margin-bottom: 12px;
        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        position: relative;
    }
    .primary-id-zone.buyer {
        border-color: #3b82f6;
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    }
    .primary-id-zone.product {
        border-color: #10b981;
        background: linear-gradient(135deg, #f0fdf4 0%, #d1fae5 100%);
    }
    .primary-id-zone.drag-over {
        border-style: solid;
        box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.3);
    }
    .primary-id-zone.buyer.drag-over {
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
    }
    .primary-id-zone.product.drag-over {
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3);
    }
    .primary-id-zone-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
    }
    .primary-id-zone-icon {
        width: 24px;
        height: 24px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
    }
    .primary-id-zone.buyer .primary-id-zone-icon {
        background: #3b82f6;
        color: white;
    }
    .primary-id-zone.product .primary-id-zone-icon {
        background: #10b981;
        color: white;
    }
    .primary-id-zone-title {
        font-weight: 600;
        font-size: 14px;
        color: #374151;
    }
    .primary-id-zone-required {
        font-size: 10px;
        font-weight: 500;
        padding: 2px 6px;
        border-radius: 4px;
        background: transparent;
        color: #6b7280;
        margin-left: auto;
    }
    .primary-id-zone-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        color: #6b7280;
        text-align: center;
    }
    .primary-id-zone-empty i {
        font-size: 24px;
        margin-bottom: 8px;
        opacity: 0.5;
    }
    .primary-id-zone-empty span {
        font-size: 13px;
    }

    /* Assigned Primary ID Feature */
    .primary-id-assigned {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 12px;
    }
    .primary-id-zone.buyer .primary-id-assigned {
        border-color: #93c5fd;
    }
    .primary-id-zone.product .primary-id-assigned {
        border-color: #6ee7b7;
    }

    /* Additional Features Section - Locked State */
    .additional-features-section {
        border: 2px dashed #e5e7eb;
        border-radius: 10px;
        padding: 16px;
        min-height: 120px;
        transition: all 0.3s ease;
    }
    .additional-features-section.buyer {
        border-color: #3b82f6;
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    }
    .additional-features-section.product {
        border-color: #10b981;
        background: linear-gradient(135deg, #f0fdf4 0%, #d1fae5 100%);
    }
    .additional-features-section.locked {
        opacity: 0.6;
        pointer-events: none;
    }
    .additional-features-section.locked::before {
        content: '';
        position: absolute;
        inset: 0;
        cursor: not-allowed;
    }
    .additional-features-section.drag-over {
        border-style: solid;
    }
    .additional-features-section.buyer.drag-over {
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
    }
    .additional-features-section.product.drag-over {
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3);
    }
    .additional-features-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
        color: #6b7280;
        font-size: 13px;
        font-weight: 500;
    }
    .additional-features-header i {
        font-size: 12px;
    }
    .locked-message {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        color: #9ca3af;
        text-align: center;
    }
    .locked-message i {
        font-size: 20px;
        margin-bottom: 8px;
    }
    .locked-message span {
        font-size: 12px;
    }

    /* Code Viewer Modal Styles */
    .code-viewer-tabs {
        display: flex;
        border-bottom: 1px solid #e5e7eb;
        margin-bottom: 16px;
    }
    .code-viewer-tab {
        padding: 10px 20px;
        font-size: 14px;
        font-weight: 500;
        color: #6b7280;
        background: transparent;
        border: none;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        margin-bottom: -1px;
        transition: all 0.15s ease;
    }
    .code-viewer-tab:hover {
        color: #374151;
        background: #f9fafb;
    }
    .code-viewer-tab.active {
        color: #3b82f6;
        border-bottom-color: #3b82f6;
    }
    .code-viewer-tab .tab-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 20px;
        height: 20px;
        padding: 0 6px;
        margin-left: 6px;
        font-size: 11px;
        font-weight: 600;
        border-radius: 10px;
        background: #e5e7eb;
        color: #6b7280;
    }
    .code-viewer-tab.active .tab-badge {
        background: #dbeafe;
        color: #3b82f6;
    }
    .code-viewer-content {
        display: none;
    }
    .code-viewer-content.active {
        display: block;
    }
    .code-container {
        position: relative;
        background: #1e293b;
        border-radius: 8px;
        overflow: hidden;
    }
    .code-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 14px;
        background: #334155;
        border-bottom: 1px solid #475569;
    }
    .code-filename {
        font-size: 12px;
        font-weight: 500;
        color: #94a3b8;
        font-family: 'SF Mono', Monaco, 'Courier New', monospace;
    }
    .code-actions {
        display: flex;
        gap: 8px;
    }
    .code-action-btn {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 5px 10px;
        font-size: 11px;
        font-weight: 500;
        color: #94a3b8;
        background: #475569;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.15s ease;
    }
    .code-action-btn:hover {
        background: #64748b;
        color: #e2e8f0;
    }
    .code-action-btn.copied {
        background: #10b981;
        color: white;
    }
    .code-block {
        max-height: 450px;
        overflow: auto;
        padding: 16px;
    }
    .code-block pre {
        margin: 0;
        padding: 0;
        font-family: 'SF Mono', Monaco, 'Courier New', monospace;
        font-size: 12px;
        line-height: 1.6;
        color: #e2e8f0;
        white-space: pre;
        tab-size: 4;
    }
    /* Simple syntax highlighting */
    .code-block .keyword {
        color: #c678dd;
    }
    .code-block .string {
        color: #98c379;
    }
    .code-block .comment {
        color: #7f848e;
        font-style: italic;
    }
    .code-block .function {
        color: #61afef;
    }
    .code-block .decorator {
        color: #e5c07b;
    }
    .code-block .number {
        color: #d19a66;
    }
    .code-block .class-name {
        color: #e5c07b;
    }
    .code-block .builtin {
        color: #56b6c2;
    }
    .code-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px;
        color: #9ca3af;
    }
    .code-empty i {
        font-size: 32px;
        margin-bottom: 12px;
        opacity: 0.5;
    }
    .code-empty span {
        font-size: 14px;
    }
    .code-meta {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 12px 16px;
        background: #f9fafb;
        border-radius: 8px;
        margin-bottom: 12px;
        font-size: 12px;
        color: #6b7280;
    }
    .code-meta-item {
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .code-meta-item i {
        color: #9ca3af;
    }
    /* Code validation status */
    .validation-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .validation-badge.valid {
        background: #dcfce7;
        color: #166534;
    }
    .validation-badge.invalid {
        background: #fee2e2;
        color: #991b1b;
    }
    .validation-badge.checking {
        background: #fef3c7;
        color: #92400e;
    }
    .validation-badge i {
        font-size: 10px;
    }
    .validation-error-banner {
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 6px;
        padding: 10px 14px;
        margin-bottom: 12px;
        display: flex;
        align-items: flex-start;
        gap: 10px;
    }
    .validation-error-banner i {
        color: #dc2626;
        margin-top: 2px;
    }
    .validation-error-banner .error-text {
        color: #991b1b;
        font-size: 13px;
        font-family: 'SF Mono', 'Monaco', 'Menlo', monospace;
    }
    .validation-error-banner .error-line {
        color: #dc2626;
        font-weight: 600;
    }

    /* Chapter Section Styles */
    .chapter-section {
        background: white;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        padding: 24px;
    }
    .chapter-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
    }
    .chapter-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
    }
    .chapter-icon.features {
        background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
        color: white;
    }
    .chapter-icon.model-structure {
        background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
        color: white;
    }
    .chapter-icon.quick-test {
        background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
        color: white;
    }
    .chapter-icon.experiments {
        background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
        color: white;
    }
    .chapter-title {
        font-size: 24px;
        font-weight: 700;
        color: #111827;
    }
    .chapter-empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 48px 24px;
        color: #9ca3af;
        text-align: center;
    }
    .chapter-empty-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
    }
    .chapter-empty-text {
        font-size: 14px;
        max-width: 300px;
    }

    /* =========================================================================
       Model Config Card Styles
       ========================================================================= */
    .model-config-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 16px;
        transition: all 0.2s ease;
        cursor: pointer;
    }
    .model-config-card:hover {
        border-color: #8b5cf6;
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.1);
    }
    .model-config-card-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        margin-bottom: 8px;
        gap: 10px;
    }
    /* Model Config Compare Styles */
    .mc-compare-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }
    .mc-compare-header {
        padding: 12px;
        background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        border-radius: 8px;
        text-align: center;
    }
    .mc-compare-header-name {
        font-size: 16px;
        font-weight: 600;
        color: #111827;
    }
    .mc-compare-header-meta {
        font-size: 12px;
        color: #6b7280;
        margin-top: 4px;
    }
    .mc-compare-section-title {
        font-size: 11px;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 8px 0 4px 0;
        border-bottom: 1px solid #e5e7eb;
    }
    .mc-compare-section-title.full-width {
        grid-column: span 2;
    }
    .mc-compare-tower {
        border: 2px dashed;
        border-radius: 10px;
        padding: 10px;
    }
    .mc-compare-tower.buyer {
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        border-color: #3b82f6;
    }
    .mc-compare-tower.product {
        background: linear-gradient(135deg, #f0fdf4 0%, #d1fae5 100%);
        border-color: #10b981;
    }
    .mc-compare-tower.ranking,
    .mc-compare-tower-section.ranking {
        background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
        border-color: #a855f7;
    }
    .mc-compare-tower-section.ranking .mc-compare-tower-header {
        background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%);
    }
    .mc-compare-table {
        width: 100%;
        border-collapse: collapse;
    }
    .mc-compare-table td {
        padding: 6px 8px;
        background: white;
        border-radius: 6px;
        margin-bottom: 4px;
    }
    .mc-compare-table tr {
        display: block;
        margin-bottom: 6px;
    }
    .mc-compare-table tr:last-child {
        margin-bottom: 0;
    }
    .mc-compare-row-diff td {
        background: #fef3c7 !important;
    }
    .mc-compare-output-layer td {
        border: 2px solid #f87171 !important;
    }
    .mc-compare-layer {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
    }
    .mc-compare-layer-empty {
        color: #9ca3af;
        font-style: italic;
        text-align: center;
    }
    .mc-compare-params {
        margin-top: 8px;
        padding: 8px;
        background: rgba(255,255,255,0.7);
        border-radius: 6px;
        font-size: 11px;
        font-family: monospace;
        text-align: right;
        color: #374151;
    }
    .mc-compare-params.mc-compare-diff {
        background: #fef3c7;
        font-weight: 600;
    }
    .mc-compare-params-section {
        padding: 10px;
        background: #f9fafb;
        border-radius: 8px;
    }
    .mc-compare-param {
        display: flex;
        justify-content: space-between;
        padding: 6px 8px;
        font-size: 12px;
        border-radius: 4px;
        margin-bottom: 4px;
    }
    .mc-compare-param:last-child {
        margin-bottom: 0;
    }
    .mc-compare-param .label {
        color: #6b7280;
    }
    .mc-compare-param .value {
        font-weight: 600;
        color: #111827;
    }
    .mc-compare-param.mc-compare-diff {
        background: #fef3c7;
    }

    /* New aligned layer comparison styles */
    .mc-compare-tower-section {
        padding: 12px;
        border-radius: 8px;
    }
    .mc-compare-tower-section.buyer {
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    }
    .mc-compare-tower-section.product {
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
    }
    .mc-compare-tower-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 10px;
    }
    .mc-compare-tower-title {
        font-size: 13px;
        font-weight: 600;
        color: #374151;
    }
    .mc-compare-tower-section.buyer .mc-compare-tower-title {
        color: #1e40af;
    }
    .mc-compare-tower-section.product .mc-compare-tower-title {
        color: #166534;
    }
    .mc-compare-layers-grid {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }
    .mc-compare-layer-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }
    .mc-compare-layer-cell {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 10px;
        background: white;
        border-radius: 6px;
        border: 1px solid rgba(0, 0, 0, 0.08);
        min-height: 38px;
    }
    .mc-compare-tower-section.buyer .mc-compare-layer-cell {
        border-color: rgba(59, 130, 246, 0.15);
    }
    .mc-compare-tower-section.product .mc-compare-layer-cell {
        border-color: rgba(16, 185, 129, 0.15);
    }
    .mc-compare-layer-cell.output-layer {
        border: 2px solid #f87171 !important;
        background: #fef2f2;
    }
    .mc-compare-layer-cell.placeholder {
        background: transparent;
        border: 1px dashed rgba(0, 0, 0, 0.15);
    }
    .mc-compare-layer-cell.mc-compare-diff {
        background: #fef3c7;
    }
    .mc-compare-layer-cell .layer-badge {
        display: inline-flex;
        align-items: center;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        flex-shrink: 0;
    }
    .mc-compare-layer-cell .layer-badge.dense {
        background: #e5e7eb;
        color: #374151;
    }
    .mc-compare-layer-cell .layer-badge.dropout {
        background: #fef3c7;
        color: #92400e;
    }
    .mc-compare-layer-cell .layer-badge.batch_norm {
        background: #d1fae5;
        color: #065f46;
    }
    .mc-compare-layer-cell .layer-badge.layer_norm {
        background: #e0e7ff;
        color: #3730a3;
    }
    .mc-compare-layer-cell .layer-params {
        flex: 1;
        font-size: 12px;
        color: #4b5563;
    }

    /* New accordion-based layer badges */
    .mc-layer-badge {
        display: inline-flex;
        align-items: center;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 9px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        flex-shrink: 0;
    }
    .mc-layer-badge.dense {
        background: #e5e7eb;
        color: #374151;
    }
    .mc-layer-badge.dropout {
        background: #fef3c7;
        color: #92400e;
    }
    .mc-layer-badge.batch_norm {
        background: #d1fae5;
        color: #065f46;
    }
    .mc-layer-badge.layer_norm {
        background: #e0e7ff;
        color: #3730a3;
    }

    .mc-compare-params-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid rgba(0, 0, 0, 0.06);
    }
    .mc-compare-params-cell {
        text-align: right;
        font-size: 11px;
        font-family: 'Monaco', 'Menlo', monospace;
        color: #6b7280;
    }
    .mc-compare-params-cell.mc-compare-diff {
        color: #92400e;
        font-weight: 600;
    }

    /* Aligned Tower Styles */
    .mc-aligned-tower-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }
    .mc-tower-wrapper {
        display: flex;
        flex-direction: column;
    }
    .mc-tower-layers {
        display: flex;
        flex-direction: column;
        gap: 6px;
        flex: 1;
    }
    .mc-layer-card {
        border: 1px solid;
        border-radius: 6px;
        padding: 8px 10px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        min-height: 36px;
    }
    .mc-layer-card .mc-layer-info {
        display: flex;
        align-items: center;
        gap: 6px;
        flex: 1;
    }
    .mc-layer-card .mc-layer-name {
        font-size: 12px;
        font-weight: 500;
    }
    .mc-layer-card .mc-layer-units {
        font-size: 11px;
        font-family: 'Monaco', 'Menlo', monospace;
        opacity: 0.8;
    }
    .mc-layer-output {
        border-width: 2px !important;
        border-style: solid !important;
    }
    .mc-layer-params-text {
        font-size: 11px;
        font-family: 'Monaco', 'Menlo', monospace;
        color: #6b7280;
        white-space: nowrap;
    }
    .mc-layer-placeholder {
        border: 1px dashed #d1d5db;
        border-radius: 6px;
        min-height: 36px;
        background: #f9fafb;
    }
    .mc-tower-params {
        margin-top: 6px;
        padding: 6px 10px;
        background: #f9fafb;
        border-radius: 4px;
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    .mc-param-row {
        display: flex;
        justify-content: space-between;
        font-size: 11px;
        font-family: 'Monaco', 'Menlo', monospace;
    }
    .mc-param-row .mc-param-label {
        opacity: 0.7;
    }
    .mc-param-row .mc-param-value {
        font-weight: 500;
    }
    .mc-tower-na {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100px;
        border: 2px dashed #d1d5db;
        border-radius: 8px;
        background: #f9fafb;
        color: #9ca3af;
        font-style: italic;
        font-size: 13px;
    }

    /* Settings comparison grid */
    .mc-compare-settings-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }
    .mc-compare-settings-card {
        background: #f9fafb;
        border-radius: 8px;
        padding: 12px;
    }
    .mc-compare-settings-card .setting-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 8px;
        border-radius: 4px;
        margin-bottom: 4px;
        font-size: 12px;
    }
    .mc-compare-settings-card .setting-row:last-child {
        margin-bottom: 0;
    }
    .mc-compare-settings-card .setting-row .label {
        color: #6b7280;
    }
    .mc-compare-settings-card .setting-row .value {
        font-weight: 600;
        color: #111827;
    }
    .mc-compare-settings-card .setting-row.mc-compare-diff {
        background: #fef3c7;
    }
    .mc-compare-settings-card .setting-row.mc-compare-diff .value {
        color: #92400e;
    }
    .model-config-name {
        font-size: 16px;
        font-weight: 600;
        color: #111827;
        margin-bottom: 2px;
    }
    .model-config-desc {
        font-size: 12px;
        color: #6b7280;
        line-height: 1.4;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 100%;
    }
    .model-config-meta {
        font-size: 11px;
        color: #9ca3af;
        margin-top: 4px;
    }
    /* Tower Architecture Visualization - Card Layout */
    .mc-card-body {
        display: flex;
        gap: 20px;
    }
    .mc-towers-section {
        flex: 0 0 55%;
        min-width: 0;
    }
    .mc-params-section {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .tower-visual {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }
    /* Aligned version: both towers same height with output layers aligned at bottom */
    .tower-visual-aligned .tower-stack {
        display: flex;
        flex-direction: column;
    }
    .tower-visual-aligned .tower-column {
        display: flex;
        flex-direction: column;
    }
    .tower-visual-aligned .tower-stack {
        flex: 1;
    }
    .tower-column {
        min-width: 0;
    }
    .tower-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 6px;
    }
    .tower-label {
        font-size: 10px;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .tower-output-dim {
        font-size: 10px;
        font-weight: 600;
        padding: 2px 6px;
        border-radius: 4px;
    }
    .tower-output-dim.buyer {
        background: #dbeafe;
        color: #1d4ed8;
    }
    .tower-output-dim.product {
        background: #d1fae5;
        color: #047857;
    }

    /* Tower Stack - Card version (matches wizard Step 2 style) */
    .tower-stack {
        display: flex;
        flex-direction: column;
        gap: 8px;
        border-radius: 10px;
        padding: 12px;
        border: 2px dashed;
    }
    .tower-stack.buyer {
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        border-color: #3b82f6;
    }
    .tower-stack.product {
        background: linear-gradient(135deg, #f0fdf4 0%, #d1fae5 100%);
        border-color: #10b981;
    }
    .tower-stack.ranking {
        background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
        border-color: #8b5cf6;
    }
    .tower-stack::-webkit-scrollbar {
        width: 4px;
    }
    .tower-stack::-webkit-scrollbar-track {
        background: transparent;
    }
    .tower-stack::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.15);
        border-radius: 2px;
    }
    .tower-stack::-webkit-scrollbar-thumb:hover {
        background: rgba(0, 0, 0, 0.25);
    }

    /* Card Layer Item - Wizard-like style (matches .layer-item from Step 2) */
    .card-layer-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 12px;
        background: white;
        border-radius: 8px;
        border: 1px solid rgba(0, 0, 0, 0.08);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
    }
    .tower-stack.buyer .card-layer-item {
        border-color: rgba(59, 130, 246, 0.2);
    }
    .tower-stack.product .card-layer-item {
        border-color: rgba(16, 185, 129, 0.2);
    }
    .tower-stack.ranking .card-layer-item {
        border-color: rgba(139, 92, 246, 0.2);
    }
    .card-layer-item.output-layer {
        border: 2px solid #f87171 !important;
    }
    .card-layer-item.empty-placeholder {
        background: transparent;
        border: 1px dashed rgba(0, 0, 0, 0.1);
        visibility: hidden;
    }
    .card-layer-item .card-drag-handle {
        color: #c4c4c4;
        font-size: 12px;
    }
    .card-layer-badge {
        display: inline-flex;
        align-items: center;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        flex-shrink: 0;
    }
    .card-layer-badge.dense {
        background: #e5e7eb;
        color: #374151;
    }
    .card-layer-badge.dropout {
        background: #fef3c7;
        color: #92400e;
    }
    .card-layer-badge.batch_norm {
        background: #d1fae5;
        color: #065f46;
    }
    .card-layer-badge.layer_norm {
        background: #e0e7ff;
        color: #3730a3;
    }
    .card-layer-params {
        flex: 1;
        font-size: 12px;
        color: #4b5563;
    }
    .card-layer-actions {
        display: flex;
        gap: 4px;
    }
    .card-layer-action-btn {
        width: 28px;
        height: 28px;
        border-radius: 6px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: none;
        cursor: pointer;
        transition: all 0.15s ease;
        background: #f3f4f6;
        color: #6b7280;
        font-size: 12px;
    }
    .card-layer-action-btn:hover {
        background: #e5e7eb;
        color: #374151;
    }

    /* Legacy tower-layer for View modal */
    .tower-layer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 6px 10px;
        background: white;
        border-radius: 6px;
        font-size: 12px;
        border: 1px solid #e5e7eb;
    }
    .tower-layer.output-layer {
        border: 2px solid #f87171;
    }
    .layer-type {
        font-weight: 500;
        color: #374151;
    }
    .layer-type.dense {
        color: #1d4ed8;
    }
    .layer-type.dropout {
        color: #dc2626;
    }
    .layer-type.batch_norm {
        color: #7c3aed;
    }
    .layer-type.layer_norm {
        color: #4f46e5;
    }
    .layer-params {
        font-size: 11px;
        color: #6b7280;
        font-family: 'Monaco', 'Menlo', monospace;
    }

    /* Model Summary Row */
    .model-summary-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px 16px;
        padding: 8px 12px;
        background: #f9fafb;
        border-radius: 6px;
        margin-bottom: 10px;
        font-size: 11px;
    }
    .mc-params-section .model-summary-row {
        justify-content: flex-start;
    }
    .model-summary-item {
        display: flex;
        align-items: center;
        gap: 4px;
    }
    .model-summary-label {
        color: #9ca3af;
    }
    .model-summary-value {
        font-weight: 600;
        color: #374151;
    }

    /* Training Params Preview */
    .training-params-preview {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
    }
    .param-chip {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 5px 10px;
        background: #f3f4f6;
        border-radius: 6px;
        font-size: 11px;
        color: #4b5563;
    }
    .param-chip-label {
        color: #9ca3af;
    }
    .param-chip-value {
        font-weight: 600;
    }
    .param-chip.retrieval-algo {
        background: #f5f3ff;
        border: 1px solid #e9d5ff;
    }
    .param-chip.retrieval-algo .param-chip-value {
        color: #7c3aed;
    }
    .param-chip.multitask-weights {
        background: #fdf2f8;
        border: 1px solid #fbcfe8;
    }
    .param-chip.multitask-weights .param-chip-label {
        color: #9d174d;
    }
    .param-chip.multitask-weights .param-chip-value {
        color: #be185d;
        font-weight: 600;
    }

    /* Ranking Row Grid (Row 2: Hyperparams | Ranking bar) */
    .ranking-row-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        margin-top: 8px;
        align-items: start;
    }
    .ranking-tower-cell {
        /* Ranking bar takes right column, aligned with Product tower above */
    }
    .ranking-tower-cell .tower-visualization {
        margin-bottom: 0;
    }
    .training-params-preview.ranking-layout {
        /* Left column for hyperparams in ranking row */
        margin-top: 0;
        padding: 8px 0;
    }

    /* View Modal Rating Head Container */
    #viewMcRatingHeadSection .tower-visual {
        /* Override 2-column grid for ranking section - it has only one tower */
        display: block;
    }
    #viewMcRatingHeadSection .tower-column.ranking {
        /* Ranking tower takes 50% of the modal width (same as one tower in the 2-column grid) */
        width: 50%;
    }
    .tower-header.ranking .tower-label {
        color: #7c3aed;
    }

    /* Compact Tower Display for Cards */
    .compact-tower-row {
        display: flex;
        gap: 16px;
        margin-bottom: 12px;
    }
    .compact-tower-item {
        flex: 1;
        min-width: 0;
    }
    .compact-tower-label {
        font-size: 10px;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .compact-tower-label.buyer {
        color: #3b82f6;
    }
    .compact-tower-label.product {
        color: #10b981;
    }
    .compact-tower-layers {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 2px;
        font-size: 11px;
    }
    .compact-layer-type {
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 500;
        font-size: 10px;
    }
    .compact-layer-type.dense {
        background: #e5e7eb;
        color: #374151;
    }
    .compact-layer-type.dropout {
        background: #fef3c7;
        color: #92400e;
    }
    .compact-layer-type.batch_norm {
        background: #d1fae5;
        color: #065f46;
    }
    .compact-layer-type.layer_norm {
        background: #e0e7ff;
        color: #3730a3;
    }
    .layer-arrow {
        color: #9ca3af;
        font-size: 10px;
        margin: 0 2px;
    }
    .output-dim-badge {
        font-size: 10px;
        font-weight: 600;
        padding: 2px 6px;
        border-radius: 4px;
        margin-left: auto;
    }
    .output-dim-badge.buyer {
        background: #dbeafe;
        color: #1d4ed8;
    }
    .output-dim-badge.product {
        background: #d1fae5;
        color: #047857;
    }

    /* Layer Bar Visualization (tensor-bar style for model layers) */
    .tower-visualization {
        margin-bottom: 4px;
    }
    .towers-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        margin-bottom: 8px;
    }
    .tower-visualization-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 4px;
    }
    .tower-visualization-label {
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .tower-visualization-label.buyer {
        color: #3b82f6;
    }
    .tower-visualization-label.product {
        color: #10b981;
    }
    .tower-visualization-label.ranking {
        color: #7c3aed;
    }
    .tower-params-badge {
        font-size: 10px;
        font-weight: 600;
        padding: 2px 8px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        gap: 4px;
    }
    .tower-params-badge.buyer {
        background: #dbeafe;
        color: #1d4ed8;
    }
    .tower-params-badge.product {
        background: #d1fae5;
        color: #047857;
    }
    .tower-params-badge.ranking {
        background: #ede9fe;
        color: #5b21b6;
    }
    .layer-bar-container {
        display: flex;
        height: 24px;
        border-radius: 6px;
        overflow: hidden;
        background: #f3f4f6;
        gap: 1px;
        width: 100%;
    }
    .layer-bar-segment {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: 600;
        color: white;
        position: relative;
        overflow: hidden;
    }
    .layer-bar-segment.dense.buyer {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }
    .layer-bar-segment.dense.product {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }
    .layer-bar-segment.dense.ranking {
        background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
    }
    .layer-bar-segment.dropout {
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    }
    .layer-bar-segment.batch_norm {
        background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);
    }
    .layer-bar-segment.layer_norm {
        background: linear-gradient(135deg, #818cf8 0%, #6366f1 100%);
    }
    .layer-bar-segment .layer-units {
        font-size: 11px;
        font-weight: 600;
    }
    .layer-bar-segment .layer-label-small {
        font-size: 9px;
        font-weight: 600;
    }
    .layer-bar-segment.output-layer::after {
        content: '';
        position: absolute;
        right: 0;
        top: 0;
        bottom: 0;
        width: 3px;
        background: rgba(255,255,255,0.4);
    }

    /* Model Config Action Buttons */
    .model-config-actions {
        display: flex;
        gap: 8px;
    }
    .mc-action-btn {
        padding: 6px 14px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 500;
        border: none;
        cursor: pointer;
        transition: all 0.15s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        min-width: 36px;
        height: 34px;
    }
    .mc-action-btn.view {
        background: #10b981;
        color: white;
        padding: 6px 16px;
        width: 128px;
        height: 32px;
        font-weight: 600;
    }
    .mc-action-btn.view:hover {
        background: #059669;
    }
    .mc-action-btn.edit {
        background: #f3f4f6;
        color: #6b7280;
        padding: 6px 12px;
    }
    .mc-action-btn.edit:hover {
        background: #e5e7eb;
        color: #374151;
    }
    .mc-action-btn.delete {
        background: #fef2f2;
        color: #ef4444;
        padding: 6px 12px;
    }
    .mc-action-btn.delete:hover {
        background: #fee2e2;
        color: #dc2626;
    }

    /* Model Config Card Footer */
    .model-config-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding-top: 12px;
        border-top: 1px solid #f3f4f6;
        margin-top: 12px;
    }
    .mc-footer-btn {
        padding: 6px 16px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
        border: 1px solid #e5e7eb;
        background: white;
        color: #6b7280;
        cursor: pointer;
        transition: all 0.15s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }
    .mc-footer-btn:hover {
        background: #f9fafb;
        border-color: #d1d5db;
        color: #374151;
    }

    /* Model Config List (full-width cards like feature configs) */
    .model-config-grid {
        display: flex;
        flex-direction: column;
        gap: 12px;
        max-height: 500px;
        overflow-y: auto;
    }

    /* Model Config Filter Bar */
    .mc-filter-bar {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 16px;
    }
    .mc-filter-group {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .mc-filter-label {
        font-size: 14px;
        font-weight: 500;
        color: #4b5563;
    }
    .mc-filter-select {
        padding: 8px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        font-size: 14px;
        min-width: 200px;
        background: white;
    }
    .mc-filter-select:focus {
        outline: none;
        border-color: #8b5cf6;
        box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.1);
    }
    .mc-search-input {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        font-size: 14px;
        background: white;
    }
    .mc-search-input:focus {
        outline: none;
        border-color: #8b5cf6;
        box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.1);
    }
    .mc-search-input::placeholder {
        color: #9ca3af;
    }

    /* Model Config Wizard Styles */
    .wizard-model-type-selector {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin-bottom: 24px;
    }
    .wizard-model-type-option {
        padding: 10px 12px;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .wizard-model-type-option:hover:not(.disabled) {
        border-color: #8b5cf6;
        background: #faf5ff;
    }
    .wizard-model-type-option.selected {
        border-color: #8b5cf6;
        background: #f5f3ff;
    }
    .wizard-model-type-option.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .wizard-model-type-icon {
        width: 40px;
        height: 40px;
        min-width: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        flex-shrink: 0;
    }
    .wizard-model-type-icon.retrieval {
        background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
        color: white;
    }
    .wizard-model-type-icon.ranking {
        background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
        color: white;
    }
    .wizard-model-type-icon.multitask {
        background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
        color: white;
    }
    .wizard-model-type-content {
        flex: 1;
        text-align: left;
        min-width: 0;
    }
    .wizard-model-type-name {
        font-weight: 600;
        color: #111827;
        font-size: 14px;
        margin-bottom: 2px;
    }
    .wizard-model-type-desc {
        font-size: 11px;
        color: #6b7280;
        line-height: 1.3;
    }
    .wizard-model-type-phase {
        font-size: 10px;
        color: #9ca3af;
        margin-top: 4px;
    }

    /* Preset Selector */
    .preset-selector {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
        margin-bottom: 16px;
    }
    .preset-option {
        padding: 12px 8px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
    }
    .preset-option:hover {
        border-color: #8b5cf6;
    }
    .preset-option.selected {
        border-color: #8b5cf6;
        background: #f5f3ff;
    }
    .preset-option-name {
        font-size: 12px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 2px;
    }
    .preset-option-desc {
        font-size: 10px;
        color: #9ca3af;
    }

    /* Tower Builder Panel - matches Feature Config styling */
    .tower-builder-panel {
        border: 2px dashed #e5e7eb;
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
    }
    .tower-builder-panel.buyer {
        border-color: #3b82f6;
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    }
    .tower-builder-panel.product {
        border-color: #10b981;
        background: linear-gradient(135deg, #f0fdf4 0%, #d1fae5 100%);
    }
    .tower-builder-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 16px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }
    .tower-builder-title {
        font-weight: 600;
        font-size: 14px;
        color: #374151;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .tower-builder-title .tower-icon {
        width: 28px;
        height: 28px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        color: white;
    }
    .tower-builder-panel.buyer .tower-icon {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
    }
    .tower-builder-panel.product .tower-icon {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
    }
    .tower-builder-summary {
        font-size: 13px;
        font-weight: 600;
    }
    .tower-builder-panel.buyer .tower-builder-summary {
        color: #2563eb;
    }
    .tower-builder-panel.product .tower-builder-summary {
        color: #059669;
    }
    .layer-list {
        padding: 12px;
        min-height: 100px;
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    .layer-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 12px;
        background: white;
        border: 1px solid rgba(0, 0, 0, 0.08);
        border-radius: 8px;
        margin-bottom: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        transition: all 0.2s ease;
    }
    .layer-item:hover {
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }
    .tower-builder-panel.buyer .layer-item {
        border-color: rgba(59, 130, 246, 0.2);
    }
    .tower-builder-panel.product .layer-item {
        border-color: rgba(16, 185, 129, 0.2);
    }
    .layer-item:last-child {
        margin-bottom: 0;
    }
    .layer-item .drag-handle {
        color: #c4c4c4;
        cursor: grab;
        transition: color 0.2s ease;
    }
    .layer-item:hover .drag-handle {
        color: #9ca3af;
    }
    .layer-item .drag-handle.disabled {
        cursor: default;
        opacity: 0.3;
    }
    .layer-item.dragging {
        opacity: 0.5;
        cursor: grabbing;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .layer-item.drag-over {
        border-color: #3b82f6;
        border-style: dashed;
        background: #eff6ff;
    }
    .layer-item .layer-type-badge {
        font-size: 10px;
        font-weight: 600;
        padding: 3px 8px;
        border-radius: 4px;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }
    .layer-item .layer-type-badge.dense {
        background: #e5e7eb;
        color: #374151;
    }
    .layer-item .layer-type-badge.dropout {
        background: #fef3c7;
        color: #92400e;
    }
    .layer-item .layer-type-badge.batch_norm {
        background: #d1fae5;
        color: #065f46;
    }
    .layer-item .layer-type-badge.layer_norm {
        background: #e0e7ff;
        color: #3730a3;
    }
    .layer-item .layer-params {
        flex: 1;
        font-size: 12px;
        color: #4b5563;
    }
    .layer-item .layer-actions {
        display: flex;
        gap: 4px;
    }
    .layer-action-btn {
        width: 28px;
        height: 28px;
        border-radius: 6px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: none;
        cursor: pointer;
        transition: all 0.15s ease;
        background: #f3f4f6;
        color: #6b7280;
        font-size: 12px;
    }
    .layer-action-btn:hover {
        background: #e5e7eb;
        color: #374151;
    }
    .layer-action-btn.delete {
        background: #fef2f2;
        color: #ef4444;
    }
    .layer-action-btn.delete:hover {
        background: #fee2e2;
        color: #dc2626;
    }
    /* Output Embedding Layer (last layer - special styling) */
    .layer-item.output-layer {
        border: 2px solid #f87171 !important;
        background: white;
        margin-top: auto;
    }
    .add-layer-btn {
        width: 100%;
        padding: 10px;
        border: 2px dashed rgba(0, 0, 0, 0.15);
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.5);
        color: #6b7280;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }
    .tower-builder-panel.buyer .add-layer-btn:hover {
        border-color: #3b82f6;
        color: #2563eb;
        background: rgba(255, 255, 255, 0.8);
    }
    .tower-builder-panel.product .add-layer-btn:hover {
        border-color: #10b981;
        color: #059669;
        background: rgba(255, 255, 255, 0.8);
    }

    /* Tower Params Summary (Keras-style) */
    .tower-params-summary {
        margin: 8px 12px 12px 12px;
        padding: 10px 12px;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 8px;
        border-top: 2px solid rgba(0, 0, 0, 0.1);
        font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
        font-size: 11px;
    }
    .tower-params-summary .params-row {
        display: flex;
        justify-content: space-between;
        padding: 2px 0;
        color: #374151;
    }
    .tower-params-summary .params-row span:first-child {
        color: #6b7280;
    }
    .tower-params-summary .params-row span:last-child {
        font-weight: 600;
        color: #1f2937;
    }
    /* View modal tower summaries - match tower colors */
    .tower-params-summary.view-modal {
        margin: 8px 0 0 0;
        border: 2px dashed;
        border-top: 2px dashed;
    }
    .tower-column:first-child .tower-params-summary.view-modal {
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        border-color: #3b82f6;
    }
    .tower-column:last-child .tower-params-summary.view-modal {
        background: linear-gradient(135deg, #f0fdf4 0%, #d1fae5 100%);
        border-color: #10b981;
    }
    .tower-column.ranking .tower-params-summary.view-modal {
        background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
        border-color: #8b5cf6;
    }

    /* Retrieval Algorithm Section */
    .retrieval-algorithm-section {
        margin-top: 24px;
        padding: 20px;
        background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%);
        border: 2px dashed #eab308;
        border-radius: 16px;
    }
    .retrieval-algorithm-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
    }
    .retrieval-algorithm-header .header-icon {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #eab308 0%, #ca8a04 100%);
        box-shadow: 0 2px 6px rgba(234, 179, 8, 0.3);
    }
    .retrieval-algorithm-header .header-icon i {
        color: white;
        font-size: 14px;
    }
    .retrieval-algorithm-header h4 {
        font-size: 14px;
        font-weight: 600;
        color: #854d0e;
        margin: 0;
    }
    .retrieval-algorithm-header p {
        font-size: 11px;
        color: #a16207;
        margin: 0;
    }
    .algorithm-options {
        display: flex;
        gap: 12px;
        margin-bottom: 16px;
    }
    .algorithm-option {
        flex: 1;
        padding: 16px;
        border-radius: 12px;
        border: 2px solid transparent;
        cursor: pointer;
        transition: all 0.2s ease;
        background: white;
    }
    .algorithm-option:hover {
        border-color: #fbbf24;
        box-shadow: 0 2px 8px rgba(234, 179, 8, 0.2);
    }
    .algorithm-option.selected {
        border-color: #eab308;
        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        box-shadow: 0 2px 8px rgba(234, 179, 8, 0.25);
    }
    .algorithm-option .option-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
    }
    .algorithm-option .option-radio {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        border: 2px solid #d1d5db;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }
    .algorithm-option.selected .option-radio {
        border-color: #eab308;
        background: #eab308;
    }
    .algorithm-option.selected .option-radio::after {
        content: '';
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: white;
    }
    .algorithm-option .option-title {
        font-size: 13px;
        font-weight: 600;
        color: #1f2937;
    }
    .algorithm-option .option-badge {
        font-size: 9px;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 600;
        text-transform: uppercase;
    }
    .algorithm-option .option-badge.default {
        background: #dcfce7;
        color: #166534;
    }
    .algorithm-option .option-badge.advanced {
        background: #fef3c7;
        color: #92400e;
    }
    .algorithm-option .option-desc {
        font-size: 11px;
        color: #6b7280;
        line-height: 1.4;
        margin-left: 28px;
    }
    .algorithm-params {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 12px 16px;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 10px;
        margin-top: 12px;
    }
    .algorithm-param-group {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .algorithm-param-group label {
        font-size: 12px;
        font-weight: 500;
        color: #854d0e;
        white-space: nowrap;
    }
    .algorithm-param-group input,
    .algorithm-param-group select {
        padding: 6px 10px;
        border: 1px solid #fbbf24;
        border-radius: 6px;
        font-size: 12px;
        background: white;
        color: #1f2937;
        width: 80px;
        text-align: center;
    }
    .algorithm-param-group input:focus,
    .algorithm-param-group select:focus {
        outline: none;
        border-color: #eab308;
        box-shadow: 0 0 0 2px rgba(234, 179, 8, 0.2);
    }
    .scann-params {
        margin-top: 12px;
        padding: 16px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 10px;
        border: 1px solid #fde68a;
    }
    .scann-params-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
    }
    .scann-param {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    .scann-param label {
        font-size: 11px;
        font-weight: 500;
        color: #92400e;
    }
    .scann-param input {
        padding: 6px 10px;
        border: 1px solid #fde68a;
        border-radius: 6px;
        font-size: 12px;
        background: white;
        color: #1f2937;
    }
    .scann-info-banner {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        padding: 10px 12px;
        background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%);
        border-radius: 8px;
        border: 1px solid #fde68a;
        margin-top: 12px;
    }
    .scann-info-banner i {
        color: #ca8a04;
        margin-top: 2px;
    }
    .scann-info-banner p {
        font-size: 11px;
        color: #854d0e;
        margin: 0;
        line-height: 1.4;
    }

    /* Rating Head Section (for Ranking models) */
    .rating-head-section {
        margin-top: 24px;
        padding: 20px;
        background: linear-gradient(135deg, #fdf4ff 0%, #fae8ff 100%);
        border: 2px dashed #d946ef;
        border-radius: 16px;
    }
    .rating-head-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
    }
    .rating-head-header .header-icon {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #d946ef 0%, #a855f7 100%);
        box-shadow: 0 2px 6px rgba(217, 70, 239, 0.3);
    }
    .rating-head-header .header-icon i {
        color: white;
        font-size: 14px;
    }
    .rating-head-header h4 {
        font-size: 14px;
        font-weight: 600;
        color: #86198f;
        margin: 0;
    }
    .rating-head-header p {
        font-size: 11px;
        color: #a21caf;
        margin: 0;
    }
    .tower-builder-panel.rating-head {
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid #f0abfc;
    }
    .tower-builder-panel.rating-head .tower-builder-header {
        background: linear-gradient(135deg, #fae8ff 0%, #f5d0fe 100%);
        border-bottom: 1px solid #f0abfc;
    }
    .tower-icon.rating {
        background: linear-gradient(135deg, #d946ef 0%, #a855f7 100%);
    }
    .rating-head-info-banner {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        padding: 10px 12px;
        background: linear-gradient(135deg, #fdf4ff 0%, #fae8ff 100%);
        border-radius: 8px;
        border: 1px solid #f0abfc;
        margin-top: 12px;
    }
    .rating-head-info-banner i {
        color: #a855f7;
        margin-top: 2px;
    }
    .rating-head-info-banner p {
        font-size: 11px;
        color: #86198f;
        margin: 0;
        line-height: 1.4;
    }

    /* Training Params Form */
    .training-params-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }
    .training-param-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }
    .training-param-label {
        font-size: 12px;
        font-weight: 500;
        color: #374151;
    }
    .training-param-input {
        padding: 10px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
    }
    .training-param-input:focus {
        outline: none;
        border-color: #8b5cf6;
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }

    /* Training Step Card-based Layout */
    .training-step-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }
    .training-panel {
        border: 2px dashed #e5e7eb;
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
    }
    .training-panel.optimizer {
        border-color: #8b5cf6;
        background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
    }
    .training-panel.hyperparams {
        border-color: #f59e0b;
        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
    }
    .training-panel.loss-function {
        border-color: #ec4899;
        background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%);
        grid-column: span 2;
    }
    .panel-icon.loss {
        background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
    }
    .loss-function-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
    }
    .loss-option {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px;
        border-radius: 10px;
        border: 2px solid transparent;
        cursor: pointer;
        transition: all 0.2s ease;
        background: white;
        position: relative;
    }
    .loss-option:hover {
        border-color: #f9a8d4;
        box-shadow: 0 2px 8px rgba(236, 72, 153, 0.15);
    }
    .loss-option.selected {
        border-color: #ec4899;
        background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%);
        box-shadow: 0 2px 8px rgba(236, 72, 153, 0.2);
    }
    .loss-option input[type="radio"] {
        display: none;
    }
    .loss-radio {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        border: 2px solid #d1d5db;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: all 0.2s ease;
    }
    .loss-option.selected .loss-radio {
        border-color: #ec4899;
        background: #ec4899;
    }
    .loss-option.selected .loss-radio::after {
        content: '';
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: white;
    }
    .loss-info {
        flex: 1;
        min-width: 0;
    }
    .loss-name {
        font-size: 13px;
        font-weight: 600;
        color: #1f2937;
    }
    .loss-desc {
        font-size: 10px;
        color: #6b7280;
    }
    .loss-badge {
        position: absolute;
        top: 6px;
        right: 8px;
        font-size: 8px;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 600;
        text-transform: uppercase;
        background: #fce7f3;
        color: #be185d;
    }
    .loss-info-text {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        margin-top: 12px;
        padding: 10px 12px;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 8px;
        border: 1px solid #fbcfe8;
    }
    .loss-info-text i {
        color: #ec4899;
        margin-top: 2px;
    }
    .loss-info-text p {
        font-size: 11px;
        color: #9d174d;
        margin: 0;
        line-height: 1.4;
    }

    /* Multitask Loss Weighting Styles */
    .training-panel.multitask-weights {
        border-color: #ec4899;
        background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%);
        grid-column: span 2;
    }
    .panel-icon.multitask {
        background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
        box-shadow: 0 2px 4px rgba(236, 72, 153, 0.3);
    }
    .weight-slider-container {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
    }
    .weight-slider-item {
        background: white;
        border-radius: 12px;
        padding: 16px;
        border: 1px solid #fbcfe8;
    }
    .weight-slider-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
    }
    .weight-slider-label {
        font-size: 13px;
        font-weight: 600;
        color: #374151;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .weight-slider-label i {
        color: #ec4899;
    }
    .weight-value {
        font-size: 18px;
        font-weight: 700;
        color: #be185d;
        min-width: 36px;
        text-align: right;
    }
    .weight-slider {
        width: 100%;
        height: 8px;
        border-radius: 4px;
        background: #fce7f3;
        outline: none;
        -webkit-appearance: none;
        appearance: none;
        cursor: pointer;
    }
    .weight-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(236, 72, 153, 0.4);
        transition: transform 0.2s ease;
    }
    .weight-slider::-webkit-slider-thumb:hover {
        transform: scale(1.1);
    }
    .weight-slider::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
        cursor: pointer;
        border: none;
        box-shadow: 0 2px 6px rgba(236, 72, 153, 0.4);
    }
    .weight-slider.retrieval::-webkit-slider-thumb {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        box-shadow: 0 2px 6px rgba(59, 130, 246, 0.4);
    }
    .weight-slider.retrieval::-moz-range-thumb {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        box-shadow: 0 2px 6px rgba(59, 130, 246, 0.4);
    }
    .weight-slider.ranking::-webkit-slider-thumb {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        box-shadow: 0 2px 6px rgba(245, 158, 11, 0.4);
    }
    .weight-slider.ranking::-moz-range-thumb {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        box-shadow: 0 2px 6px rgba(245, 158, 11, 0.4);
    }
    .weight-slider-hint {
        font-size: 10px;
        color: #9ca3af;
        margin-top: 8px;
        margin-bottom: 0;
    }
    .weight-validation-warning {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 12px;
        padding: 10px 12px;
        background: #fef2f2;
        border-radius: 8px;
        border: 1px solid #fecaca;
    }
    .weight-validation-warning i {
        color: #ef4444;
    }
    .weight-validation-warning p {
        font-size: 11px;
        color: #b91c1c;
        margin: 0;
        font-weight: 500;
    }
    .weight-info-banner {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        margin-top: 16px;
        padding: 10px 12px;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 8px;
        border: 1px solid #fbcfe8;
    }
    .weight-info-banner i {
        color: #ec4899;
        margin-top: 2px;
    }
    .weight-info-banner p {
        font-size: 11px;
        color: #9d174d;
        margin: 0;
        line-height: 1.4;
    }

    /* Multitask Architecture Diagram Styles */
    .multitask-arch-section {
        margin-top: 20px;
        border-radius: 12px;
        border: 2px solid #f472b6;
        background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%);
        overflow: hidden;
    }
    .multitask-arch-header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 16px;
        background: rgba(255, 255, 255, 0.5);
        border-bottom: 1px solid rgba(244, 114, 182, 0.2);
    }
    .multitask-arch-header .header-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
        color: white;
        font-size: 14px;
    }
    .multitask-arch-header h4 {
        margin: 0;
        font-size: 14px;
        font-weight: 600;
        color: #be185d;
    }
    .multitask-arch-header p {
        margin: 0;
        font-size: 11px;
        color: #9d174d;
    }
    .multitask-arch-diagram {
        padding: 20px;
    }
    .arch-row {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 40px;
    }
    .arch-row.towers-row {
        gap: 60px;
    }
    .arch-tower {
        padding: 12px 20px;
        border-radius: 10px;
        text-align: center;
        min-width: 140px;
    }
    .arch-tower.buyer {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        border: 2px solid #3b82f6;
    }
    .arch-tower.product {
        background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
        border: 2px solid #22c55e;
    }
    .arch-tower-label {
        font-size: 12px;
        font-weight: 600;
        color: #374151;
    }
    .arch-tower-summary {
        font-size: 11px;
        color: #6b7280;
        font-family: monospace;
    }
    .arch-row.arrows-row {
        padding: 8px 0;
    }
    .arch-arrow {
        font-size: 18px;
        color: #9ca3af;
    }
    .arch-row.embeddings-row {
        gap: 60px;
    }
    .arch-embedding {
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 11px;
        font-weight: 500;
    }
    .arch-embedding.buyer {
        background: #3b82f6;
        color: white;
    }
    .arch-embedding.product {
        background: #22c55e;
        color: white;
    }
    .arch-row.split-row {
        padding: 12px 0;
    }
    .arch-split-line {
        width: 200px;
        height: 2px;
        background: linear-gradient(90deg, #3b82f6, #ec4899, #f59e0b);
        border-radius: 2px;
        position: relative;
    }
    .arch-split-line::before,
    .arch-split-line::after {
        content: '';
        position: absolute;
        top: 8px;
        font-size: 14px;
        color: #9ca3af;
    }
    .arch-split-line::before {
        left: 30px;
    }
    .arch-split-line::after {
        right: 30px;
    }
    .arch-row.paths-row {
        gap: 30px;
        align-items: stretch;
    }
    .arch-path {
        flex: 1;
        max-width: 200px;
        border-radius: 12px;
        padding: 14px;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .arch-path.retrieval {
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        border: 2px solid #3b82f6;
    }
    .arch-path.ranking {
        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        border: 2px solid #f59e0b;
    }
    .arch-path-header {
        font-size: 12px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .arch-path.retrieval .arch-path-header {
        color: #1d4ed8;
    }
    .arch-path.ranking .arch-path-header {
        color: #b45309;
    }
    .arch-path-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
    }
    .arch-operation {
        font-size: 10px;
        padding: 4px 10px;
        border-radius: 6px;
        background: rgba(255, 255, 255, 0.7);
        color: #374151;
    }
    .arch-arrow-small {
        font-size: 12px;
        color: #9ca3af;
    }
    .arch-rating-head {
        display: flex;
        flex-direction: column;
        align-items: center;
        font-size: 10px;
        padding: 6px 10px;
        border-radius: 6px;
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border: 1px solid #f59e0b;
    }
    .arch-rating-head span:first-child {
        font-weight: 600;
        color: #92400e;
    }
    .arch-rating-head span:last-child {
        font-family: monospace;
        color: #b45309;
    }
    .arch-output {
        font-size: 10px;
        font-weight: 600;
        padding: 4px 10px;
        border-radius: 6px;
    }
    .arch-path.retrieval .arch-output {
        background: #3b82f6;
        color: white;
    }
    .arch-path.ranking .arch-output {
        background: #f59e0b;
        color: white;
    }
    .arch-path-metric {
        font-size: 9px;
        display: flex;
        align-items: center;
        gap: 4px;
        justify-content: center;
        padding-top: 6px;
        border-top: 1px solid rgba(0, 0, 0, 0.1);
    }
    .arch-path.retrieval .arch-path-metric {
        color: #1d4ed8;
    }
    .arch-path.ranking .arch-path-metric {
        color: #b45309;
    }
    .arch-row.loss-row {
        margin-top: 16px;
    }
    .arch-combined-loss {
        background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%);
        border: 2px solid #ec4899;
        border-radius: 10px;
        padding: 12px 20px;
    }
    .arch-loss-formula {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 12px;
        font-weight: 500;
    }
    .loss-term {
        padding: 4px 10px;
        border-radius: 6px;
    }
    .loss-term.retrieval {
        background: #dbeafe;
        color: #1d4ed8;
    }
    .loss-term.ranking {
        background: #fef3c7;
        color: #b45309;
    }
    .loss-plus {
        font-size: 14px;
        font-weight: 700;
        color: #ec4899;
    }

    .training-panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 16px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }
    .training-panel-title {
        font-weight: 600;
        font-size: 14px;
        color: #374151;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .training-panel-title .panel-icon {
        width: 28px;
        height: 28px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        color: white;
    }
    .training-panel.optimizer .panel-icon {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        box-shadow: 0 2px 4px rgba(139, 92, 246, 0.3);
    }
    .training-panel.hyperparams .panel-icon {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
    }
    .training-panel-body {
        padding: 16px;
        flex: 1;
    }
    .optimizer-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }
    .optimizer-option {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 14px;
        background: white;
        border: 2px solid transparent;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        min-height: 72px;
    }
    .optimizer-option:hover {
        border-color: rgba(139, 92, 246, 0.3);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }
    .optimizer-option.selected {
        border-color: #8b5cf6;
        background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
        box-shadow: 0 2px 8px rgba(139, 92, 246, 0.2);
    }
    .optimizer-option input[type="radio"] {
        display: none;
    }
    .optimizer-radio {
        width: 18px;
        height: 18px;
        border: 2px solid #d1d5db;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        flex-shrink: 0;
    }
    .optimizer-option.selected .optimizer-radio {
        border-color: #8b5cf6;
        background: #8b5cf6;
    }
    .optimizer-radio::after {
        content: '';
        width: 6px;
        height: 6px;
        background: white;
        border-radius: 50%;
        opacity: 0;
        transition: opacity 0.2s ease;
    }
    .optimizer-option.selected .optimizer-radio::after {
        opacity: 1;
    }
    .optimizer-info {
        flex: 1;
        min-width: 0;
    }
    .optimizer-name {
        font-weight: 600;
        font-size: 13px;
        color: #374151;
    }
    .optimizer-desc {
        font-size: 11px;
        color: #6b7280;
        margin-top: 2px;
    }
    .optimizer-badge {
        font-size: 9px;
        font-weight: 600;
        padding: 2px 6px;
        border-radius: 4px;
        background: #10b981;
        color: white;
        text-transform: uppercase;
        flex-shrink: 0;
    }
    .hyperparam-item {
        background: white;
        border: 1px solid rgba(0, 0, 0, 0.08);
        border-radius: 10px;
        padding: 14px;
        margin-bottom: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
    }
    .hyperparam-item:last-child {
        margin-bottom: 0;
    }
    .hyperparam-label {
        font-size: 12px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .hyperparam-label i {
        color: #f59e0b;
        font-size: 11px;
    }
    .hyperparam-input-wrapper {
        position: relative;
    }
    .hyperparam-input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.2s ease;
    }
    .hyperparam-input:focus {
        outline: none;
        border-color: #f59e0b;
        box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
    }
    .hyperparam-hint {
        font-size: 11px;
        color: #9ca3af;
        margin-top: 6px;
    }
    .lr-presets {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-top: 8px;
    }
    .lr-preset-btn {
        padding: 6px 0;
        width: 56px;
        font-size: 11px;
        font-weight: 500;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        background: white;
        color: #6b7280;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
    }
    .lr-preset-btn:hover {
        border-color: #f59e0b;
        color: #f59e0b;
    }
    .lr-preset-btn.active {
        background: #f59e0b;
        border-color: #f59e0b;
        color: white;
    }

    /* Fix for progress bar - ensure last pill has rounded right border */
    .progress-step-pill:last-child {
        border-top-right-radius: 24px;
        border-bottom-right-radius: 24px;
    }
    .progress-step-pill:first-child {
        border-top-left-radius: 24px;
        border-bottom-left-radius: 24px;
    }
</style>
{% endblock %}

{% block model_content %}
<div class="space-y-6">
    <!-- =========================================================================== -->
    <!-- CHAPTER 0: CONFIGS DASHBOARD -->
    <!-- =========================================================================== -->
    <div class="bg-white rounded-xl border border-black shadow-lg p-6">
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3">
                <div class="chapter-icon" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);">
                    <i class="fas fa-th-large"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-900">Configs Dashboard</h2>
            </div>
        </div>

        <!-- Loading State -->
        <div id="cfgDashboardLoading" class="configs-dashboard-loading">
            <i class="fas fa-spinner fa-spin text-2xl text-gray-400 mr-3"></i>
            <span class="text-gray-500">Loading dashboard...</span>
        </div>

        <!-- Empty State -->
        <div id="cfgDashboardEmpty" class="configs-dashboard-empty hidden">
            <i class="fas fa-cubes"></i>
            <p class="configs-dashboard-empty-title">No configurations yet</p>
            <p class="configs-dashboard-empty-text">Create your first dataset to start building ML configurations</p>
            <button onclick="ds_openWizard()" class="btn btn-primary">
                <i class="fas fa-plus mr-2"></i>Create Dataset
            </button>
        </div>

        <!-- Dashboard Content -->
        <div id="cfgDashboardContent" class="hidden">
            <!-- KPI Row: 3 Cards (Datasets, Features, Models) -->
            <div id="cfgKpiRow" class="configs-dashboard-kpi-row">
                <!-- Dynamically populated by JavaScript -->
            </div>

            <!-- Coverage Matrix Section -->
            <div id="cfgCoverageSection" class="configs-dashboard-section">
                <div class="configs-dashboard-section-header">
                    <h3 class="configs-dashboard-section-title">
                        <i class="fas fa-th"></i>
                        Coverage Matrix
                    </h3>
                    <span class="text-sm text-gray-500">FeatureConfig  ModelConfig experiment counts</span>
                </div>
                <div id="cfgCoverageMatrix" style="overflow-x: auto;">
                    <!-- Dynamically populated by JavaScript -->
                </div>
            </div>

            <!-- Relationships Diagram Section -->
            <div id="cfgRelationshipsSection" class="configs-dashboard-section">
                <div class="configs-dashboard-section-header">
                    <h3 class="configs-dashboard-section-title">
                        <i class="fas fa-project-diagram"></i>
                        Configuration Flow
                    </h3>
                    <span class="text-sm text-gray-500">Dataset  FeatureConfig  Experiments</span>
                </div>
                <div id="cfgRelationshipsDiagram" class="configs-dashboard-relationships">
                    <!-- Dynamically populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- =========================================================================== -->
    <!-- CHAPTER 1: DATASETS -->
    <!-- =========================================================================== -->
    <div class="bg-white rounded-xl border border-black shadow-lg p-6">
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3">
                <div class="chapter-icon" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);">
                    <i class="fas fa-database"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-900">Datasets</h2>
            </div>
            <div class="btn-group">
                <button onclick="ds_openCompareModal()" class="btn btn-secondary btn-sm" style="width: 140px;">
                    <i class="fas fa-columns"></i>Compare
                </button>
                <button onclick="ds_openWizard()" class="btn btn-primary btn-sm" style="width: 140px;">
                    <i class="fas fa-plus"></i>New Dataset
                </button>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="flex items-center gap-4 mb-4">
            <div class="flex-1">
                <input type="text" id="dsSearchInput" placeholder="Search datasets..."
                       class="form-input w-full text-sm" onkeyup="ds_debounceSearch()">
            </div>
        </div>

        <!-- Datasets List Container -->
        <div id="datasetsList" class="space-y-3" style="max-height: 420px; overflow-y: auto; min-height: 100px;">
            <!-- Loading state -->
            <div id="datasetsLoading" class="flex items-center justify-center py-12">
                <i class="fas fa-spinner fa-spin text-2xl text-gray-400 mr-3"></i>
                <span class="text-gray-500">Loading datasets...</span>
            </div>
            <!-- Empty state (hidden by default) -->
            <div id="datasetsEmpty" class="card-empty-state hidden">
                <p class="card-empty-state-title">No datasets configured</p>
                <p class="card-empty-state-text">Create your first dataset to define training data for your ML models</p>
            </div>
            <!-- Dataset cards will be inserted here by JavaScript -->
        </div>

        <!-- Pagination -->
        <div id="dsPaginationContainer" class="hidden mt-4 pt-4 border-t border-gray-200">
            <div class="flex items-center justify-between">
                <div id="dsPaginationInfo" class="text-sm text-gray-600"></div>
                <div id="dsPaginationButtons" class="flex items-center gap-2"></div>
            </div>
        </div>
    </div>

    <!-- =========================================================================== -->
    <!-- CHAPTER 2: FEATURES -->
    <!-- =========================================================================== -->
    <div class="bg-white rounded-xl border border-black shadow-lg p-6">
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3">
                <div class="chapter-icon features">
                    <i class="fas fa-microchip"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-900">Features</h2>
            </div>
            <div class="btn-group">
                <button onclick="fc_openCompareModal()" class="btn btn-secondary btn-sm" style="width: 150px;">
                    <i class="fas fa-columns"></i>Compare
                </button>
                <button onclick="fc_openWizard()" class="btn btn-primary btn-sm" style="width: 150px;">
                    <i class="fas fa-plus"></i>New Feats Set
                </button>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="flex items-center gap-4 mb-4">
            <div class="flex items-center gap-2">
                <label class="text-sm font-medium text-gray-600">Dataset:</label>
                <select id="datasetFilter" onchange="filterConfigs()" class="form-select text-sm" style="min-width: 200px;">
                    <option value="">All Datasets</option>
                </select>
            </div>
            <div class="flex-1">
                <input type="text" id="searchInput" placeholder="Search feature configs..."
                       class="form-input w-full text-sm" onkeyup="fc_debounceSearch()">
            </div>
        </div>

        <!-- Feature Configs List - scrollable, shows ~2 cards -->
        <div id="configsList" class="space-y-3" style="max-height: 420px; overflow-y: auto; min-height: 100px;">
            <!-- Loading state -->
            <div id="configsLoading" class="flex items-center justify-center py-12">
                <i class="fas fa-spinner fa-spin text-2xl text-gray-400 mr-3"></i>
                <span class="text-gray-500">Loading feature configs...</span>
            </div>
            <!-- Empty state (hidden by default) -->
            <div id="configsEmpty" class="card-empty-state hidden">
                <p class="card-empty-state-title">No feature configs yet</p>
                <p class="card-empty-state-text">Create your first feature config to define how columns are transformed for training</p>
            </div>
            <!-- Config cards will be inserted here -->
        </div>
    </div>

    <!-- =========================================================================== -->
    <!-- CHAPTER 3: MODEL STRUCTURE -->
    <!-- =========================================================================== -->
    <div class="chapter-section" style="border-color: black;">
        <div class="chapter-header">
            <div class="chapter-icon model-structure">
                <i class="fas fa-layer-group"></i>
            </div>
            <h2 class="chapter-title">Model Structure</h2>
            <div class="ml-auto flex gap-2">
                <button onclick="mc_openCompareModal()" class="btn btn-secondary btn-sm" style="width: 150px;">
                    <i class="fas fa-columns mr-1"></i>Compare
                </button>
                <button onclick="openModelConfigWizard()" class="btn btn-primary btn-sm" style="width: 150px;">
                    <i class="fas fa-plus mr-1"></i>New Model Config
                </button>
            </div>
        </div>
        <div id="modelStructureContent">
            <!-- Filter Bar -->
            <div id="mcFilterBar" class="mc-filter-bar hidden">
                <div class="mc-filter-group">
                    <label class="mc-filter-label">Model Type:</label>
                    <select id="mcModelTypeFilter" class="mc-filter-select" onchange="filterModelConfigs()">
                        <option value="">All Types</option>
                        <option value="retrieval">Retrieval</option>
                        <option value="ranking">Ranking</option>
                        <option value="multitask">Multitask</option>
                    </select>
                </div>
                <input type="text" id="mcSearchInput" class="mc-search-input"
                       placeholder="Search model configs..." onkeyup="debounceMcSearch()">
            </div>

            <!-- Loading state -->
            <div id="modelConfigsLoading" class="flex items-center justify-center py-8">
                <i class="fas fa-spinner fa-spin text-xl text-gray-400 mr-3"></i>
                <span class="text-gray-500">Loading model configs...</span>
            </div>
            <!-- Empty state (hidden by default) -->
            <div id="modelConfigsEmpty" class="chapter-empty-state hidden">
                <i class="fas fa-cubes chapter-empty-icon"></i>
                <p class="chapter-empty-text">No model configurations yet</p>
                <p class="text-sm text-gray-400 mt-2">Create your first model config to define neural network architecture</p>
                <button onclick="openModelConfigWizard()" class="btn btn-primary btn-sm mt-4">
                    <i class="fas fa-plus mr-1"></i>Create Model Config
                </button>
            </div>
            <!-- No results state (for filtered searches) -->
            <div id="modelConfigsNoResults" class="chapter-empty-state hidden">
                <i class="fas fa-search chapter-empty-icon"></i>
                <p class="chapter-empty-text">No matching model configs</p>
                <p class="text-sm text-gray-400 mt-2">Try adjusting your filters or search term</p>
            </div>
            <!-- Model config cards container -->
            <div id="modelConfigsGrid" class="model-config-grid hidden"></div>
        </div>
    </div>

</div>

<!-- =========================================================================== -->
<!-- DATASET WIZARD MODAL -->
<!-- =========================================================================== -->
<div id="dsWizardModal" class="modal-overlay hidden">
    <div class="modal-container modal-container-wizard modal-dataset-wizard">
        <!-- Modal Header -->
        <div class="modal-header-wizard">
            <div class="modal-header-content">
                <div class="modal-header-icon info">
                    <i class="fas fa-table text-lg"></i>
                </div>
                <div class="modal-header-info">
                    <h3 class="modal-header-title" id="dsWizardTitle">Create Dataset</h3>
                    <p class="modal-step-counter">Step <span id="dsCurrentStep">1</span> of 4</p>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress-bar-pills">
                <div id="dsProgress1" class="progress-step-pill current">Info</div>
                <div id="dsProgress2" class="progress-step-pill future">Tables</div>
                <div id="dsProgress3" class="progress-step-pill future">Schema</div>
                <div id="dsProgress4" class="progress-step-pill future">Filters</div>
            </div>
        </div>

        <!-- Modal Body -->
        <div class="modal-body-wizard">
            <!-- Step 1: Basic Info -->
            <div id="dsStep1" class="wizard-step active">
                <h4 class="wizard-section-title">Basic Information</h4>

                <!-- Dataset Name -->
                <div class="wizard-field-group">
                    <label class="wizard-field-label">Dataset Name <span class="required">*</span></label>
                    <input type="text" id="dsDatasetName" placeholder="e.g., Transactions Q4 2024"
                           class="form-input w-full" oninput="ds_validateDatasetName()">
                    <p id="dsNameError" class="text-xs text-red-600 mt-1 hidden"></p>
                    <p id="dsNameSuccess" class="text-xs text-green-600 mt-1 hidden">
                        <i class="fas fa-check-circle mr-1"></i>Name is available
                    </p>
                </div>

                <!-- Description -->
                <div class="wizard-field-group">
                    <label class="wizard-field-label">Description <span class="optional">(optional)</span></label>
                    <textarea id="dsDatasetDescription" placeholder="Describe the purpose of this dataset..."
                              class="form-textarea w-full" rows="3"></textarea>
                </div>

                <div class="wizard-info-box info">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>What is a Dataset?</strong><br>
                        A dataset defines which BigQuery tables, columns, and filters to use for training your ML models.
                    </div>
                </div>
            </div>

            <!-- Step 2: Source Tables -->
            <div id="dsStep2" class="wizard-step">
                <h4 class="wizard-section-title">Select Source Tables</h4>
                <p class="wizard-section-subtitle">Choose tables from your BigQuery raw_data dataset.</p>

                <!-- Primary Table -->
                <div class="wizard-field-group">
                    <label class="wizard-field-label">Primary Table <span class="required">*</span></label>
                    <div class="wizard-list-container">
                        <div id="dsPrimaryTableList" class="list-content" style="max-height: 160px;">
                            <p class="text-center text-gray-500 py-4">
                                <i class="fas fa-spinner fa-spin mr-2"></i>Loading tables...
                            </p>
                        </div>
                    </div>
                    <p class="wizard-field-hint">
                        <i class="fas fa-info-circle mr-1"></i>
                        The primary table contains your main transaction/interaction data.
                    </p>
                </div>

                <!-- Secondary Tables -->
                <div class="wizard-field-group">
                    <label class="wizard-field-label">Secondary Tables <span class="optional">(optional)</span></label>
                    <div class="wizard-list-container">
                        <div id="dsSecondaryTableList" class="list-content" style="max-height: 140px;">
                            <p class="text-center text-gray-500 py-4">Select a primary table first</p>
                        </div>
                    </div>
                    <p class="wizard-field-hint">
                        <i class="fas fa-link mr-1"></i>
                        Additional tables to join (e.g., products, customers). You'll configure joins in the next step.
                    </p>
                </div>
            </div>

            <!-- Step 3: Visual Schema Builder -->
            <div id="dsStep3" class="wizard-step">
                <div class="schema-builder-container">
                    <!-- Header with title -->
                    <div class="schema-builder-header">
                        <div>
                            <h4 class="wizard-section-title" style="margin-bottom: 2px;">Schema Builder</h4>
                            <p class="wizard-section-subtitle" style="margin-bottom: 0;">Connect tables and select columns for your dataset.</p>
                        </div>
                    </div>

                    <!-- Table Cards Area -->
                    <div class="schema-cards-area" id="dsSchemaCardsArea">
                        <!-- SVG for connection lines -->
                        <svg class="schema-connections-svg" id="dsConnectionsSvg"></svg>

                        <!-- Loading state (outside container so it survives innerHTML replacement) -->
                        <div class="schema-loading" id="dsSchemaLoading">
                            <i class="fas fa-spinner fa-spin"></i>
                            Loading table samples...
                        </div>

                        <!-- Table cards container (contents replaced by ds_renderTableCards) -->
                        <div class="schema-cards-container" id="dsSchemaCardsContainer">
                        </div>
                    </div>

                    <!-- Preview Section -->
                    <div class="schema-preview-section">
                        <!-- Stats bar -->
                        <div class="schema-preview-stats" id="dsPreviewStats">
                            <div class="stat-item">
                                <span>Preview:</span>
                                <span class="stat-value" id="dsPreviewRowCount">-</span>
                                <span>rows</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value" id="dsPreviewColCount">-</span>
                                <span>columns</span>
                            </div>
                            <div class="stat-item" id="dsPreviewWarnings" style="display: none;">
                                <i class="fas fa-exclamation-triangle stat-warning"></i>
                                <span class="stat-warning" id="dsPreviewWarningText"></span>
                            </div>
                        </div>

                        <!-- Preview table -->
                        <div class="schema-preview-table-container" id="dsPreviewTableContainer">
                            <div class="schema-preview-empty" id="dsPreviewEmpty">
                                <i class="fas fa-table"></i>
                                Select columns to see a preview of your dataset
                            </div>
                            <table class="schema-preview-table" id="dsPreviewTable" style="display: none;">
                                <thead id="dsPreviewTableHead"></thead>
                                <tbody id="dsPreviewTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Join Popover (hidden by default) -->
                <div class="join-popover hidden" id="dsJoinPopover">
                    <div class="join-popover-header">Join Type</div>
                    <div class="join-popover-warning hidden" id="dsJoinPopoverWarning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span id="dsJoinPopoverWarningText">Non-unique join key</span>
                    </div>
                    <div class="join-popover-option" data-type="left" onclick="ds_setJoinType('left')">
                        <i class="fas fa-check"></i> LEFT JOIN
                    </div>
                    <div class="join-popover-option" data-type="inner" onclick="ds_setJoinType('inner')">
                        <i class="fas fa-check"></i> INNER JOIN
                    </div>
                    <div class="join-popover-option danger" onclick="ds_removeSelectedJoin()">
                        <i class="fas fa-trash"></i> Remove
                    </div>
                </div>

                <!-- Column Info Popover for connect mode (hidden by default) -->
                <div class="column-info-popover hidden" id="dsColumnInfoPopover">
                    <div class="column-info-name" id="dsColumnInfoName">column_name</div>
                    <div class="column-info-type" id="dsColumnInfoType">
                        <span class="column-info-label">Type:</span>
                        <span class="column-info-value" id="dsColumnInfoTypeValue">STRING</span>
                    </div>
                    <div class="column-info-samples" id="dsColumnInfoSamples">
                        <span class="column-info-label">Samples:</span>
                        <span class="column-info-value" id="dsColumnInfoSamplesValue"></span>
                    </div>
                    <div class="column-info-hint" id="dsColumnInfoHint">
                        Click a column in another table to connect
                    </div>
                    <div class="column-info-warning hidden" id="dsColumnInfoWarning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span id="dsColumnInfoWarningText">Type mismatch</span>
                    </div>
                    <div class="column-info-compatible hidden" id="dsColumnInfoCompatible">
                        <i class="fas fa-check-circle"></i>
                        <span>Compatible</span>
                    </div>
                </div>
            </div>

            <!-- Step 4: Filtering -->
            <div id="dsStep4" class="wizard-step">
                <h4 class="wizard-section-title">Filtering</h4>
                <p class="wizard-section-subtitle">Configure filters to select the data for your dataset.</p>

                <!-- Sub-chapter 1: Dates -->
                <div class="filter-subchapter" id="dsHistorySubchapter">
                    <div class="subchapter-header-tablet" onclick="ds_toggleSubchapter('history')">
                        <span class="subchapter-title">Dates</span>
                        <span class="subchapter-filter-status" id="dsDatesFilterStatus"></span>
                        <i id="dsHistoryChevron" class="fas fa-chevron-right subchapter-chevron"></i>
                    </div>
                    <div id="dsHistoryContent" class="subchapter-content-outside hidden">
                        <!-- Filter Buttons Row -->
                        <div class="filter-buttons-row">
                            <!-- Timestamp Column Dropdown -->
                            <div class="filter-button-wrapper">
                                <span class="filter-button-label">Select timestamp column</span>
                                <div class="timestamp-column-select-wrapper">
                                    <select id="dsTimestampColumn" class="form-select timestamp-column-select" onchange="ds_onTimestampColumnChange();">
                                        <option value="">Select column...</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Rolling Window Button -->
                            <div class="filter-button-wrapper">
                                <span class="filter-button-label">Set number of days</span>
                                <button type="button" class="filter-button" id="dsRollingWindowBtn" onclick="ds_toggleFilterPopup('rollingWindow')">
                                    <i class="fas fa-history"></i>
                                    <span>Rolling Window</span>
                                </button>
                                <div class="filter-popup" id="dsRollingWindowPopup">
                                    <div class="filter-popup-header">Set Rolling Window</div>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="dsRollingDays" value="30" min="1" max="365"
                                               class="form-input w-20 text-sm" onchange="ds_onRollingDaysChange()">
                                        <span class="text-sm text-gray-600">days</span>
                                        <button type="button" class="btn btn-sm btn-primary" onclick="ds_applyRollingWindow()">Apply</button>
                                    </div>
                                    <p class="filter-popup-hint">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        Days from the latest available date
                                    </p>
                                </div>
                            </div>

                            <!-- Start Date Button -->
                            <div class="filter-button-wrapper">
                                <span class="filter-button-label">Select start date</span>
                                <button type="button" class="filter-button" id="dsStartDateBtn" onclick="ds_toggleFilterPopup('startDate')">
                                    <i class="fas fa-calendar-alt"></i>
                                    <span>Start Date</span>
                                </button>
                                <div class="filter-popup" id="dsStartDatePopup">
                                    <div class="filter-popup-header">Select Start Date</div>
                                    <input type="date" id="dsStartDateInput" class="form-input w-full text-sm" onchange="ds_onStartDateChange(); ds_closeFilterPopup('startDate');">
                                    <p class="filter-popup-hint">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        Fixed start date for the dataset
                                    </p>
                                </div>
                            </div>

                            <!-- Refresh Dataset Button -->
                            <div class="filter-button-wrapper">
                                <span class="filter-button-label">&nbsp;</span>
                                <button type="button" class="filter-button filter-button-refresh filter-button-disabled" id="dsRefreshDatasetBtn" onclick="ds_refreshDatasetHistory()" disabled>
                                    <i class="fas fa-sync-alt"></i>
                                    <span>Refresh Dataset</span>
                                </button>
                            </div>
                        </div>

                        <!-- Summary Line -->
                        <div class="filter-summary-line" id="dsDatesFilterSummary">
                            <div class="filter-summary-items" id="dsDatesFilterSummaryItems">
                                <span class="filter-summary-empty">No filters selected</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sub-chapter 2: Customers -->
                <div class="filter-subchapter" id="dsCustomersSubchapter">
                    <div class="subchapter-header-tablet" onclick="ds_toggleSubchapter('customers')">
                        <span class="subchapter-title">Customers</span>
                        <span class="subchapter-filter-status" id="dsCustomersFilterStatus"></span>
                        <i id="dsCustomersChevron" class="fas fa-chevron-right subchapter-chevron"></i>
                    </div>
                    <div id="dsCustomersContent" class="subchapter-content-outside hidden">
                        <!-- Filter Buttons Row -->
                        <div class="filter-buttons-row">
                            <div class="filter-button-wrapper">
                                <span class="filter-button-label">Filter by revenue</span>
                                <button type="button" class="filter-button" onclick="ds_openTopCustomersModal()">
                                    <i class="fas fa-chart-line"></i>
                                    Top Customers
                                </button>
                            </div>
                            <div class="filter-button-wrapper">
                                <span class="filter-button-label">Filter by metrics</span>
                                <button type="button" class="filter-button" onclick="ds_openCustomerMetricsModal()">
                                    <i class="fas fa-calculator"></i>
                                    Customer Metrics
                                </button>
                            </div>
                            <div class="filter-button-wrapper">
                                <span class="filter-button-label">Filter by columns</span>
                                <button type="button" class="filter-button" onclick="ds_openCustomerFilterColumnsModal()">
                                    <i class="fas fa-filter"></i>
                                    Filter Columns
                                </button>
                            </div>
                            <div class="filter-button-wrapper">
                                <span class="filter-button-label">&nbsp;</span>
                                <button type="button" class="filter-button filter-button-refresh filter-button-disabled" onclick="ds_refreshCustomerFilters()" id="dsRefreshCustomerFiltersBtn" disabled>
                                    <i class="fas fa-sync-alt"></i>
                                    Refresh Dataset
                                </button>
                            </div>
                        </div>

                        <!-- Summary Line -->
                        <div class="filter-summary-line" id="dsCustomersFilterSummary">
                            <div class="filter-summary-items" id="dsCustomersFilterSummaryItems">
                                <span class="filter-summary-empty">No filters selected</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sub-chapter 3: Products -->
                <div class="filter-subchapter" id="dsProductsSubchapter">
                    <div class="subchapter-header-tablet" onclick="ds_toggleSubchapter('products')">
                        <span class="subchapter-title">Products</span>
                        <span class="subchapter-filter-status" id="dsProductsFilterStatus"></span>
                        <i id="dsProductsChevron" class="fas fa-chevron-right subchapter-chevron"></i>
                    </div>
                    <div id="dsProductsContent" class="subchapter-content-outside hidden">
                        <!-- Filter Buttons Row -->
                        <div class="filter-buttons-row">
                            <div class="filter-button-wrapper">
                                <span class="filter-button-label">Filter by revenue</span>
                                <button type="button" class="filter-button" onclick="ds_openTopProductsModal()">
                                    <i class="fas fa-chart-line"></i>
                                    Top Products
                                </button>
                            </div>
                            <div class="filter-button-wrapper">
                                <span class="filter-button-label">Filter by metrics</span>
                                <button type="button" class="filter-button" onclick="ds_openProductMetricsModal()">
                                    <i class="fas fa-calculator"></i>
                                    Product Metrics
                                </button>
                            </div>
                            <div class="filter-button-wrapper">
                                <span class="filter-button-label">Filter by columns</span>
                                <button type="button" class="filter-button" onclick="ds_openFilterColumnsModal()">
                                    <i class="fas fa-filter"></i>
                                    Filter Columns
                                </button>
                            </div>
                            <div class="filter-button-wrapper">
                                <span class="filter-button-label">&nbsp;</span>
                                <button type="button" class="filter-button filter-button-refresh filter-button-disabled" onclick="ds_refreshProductFilters()" id="dsRefreshProductFiltersBtn" disabled>
                                    <i class="fas fa-sync-alt"></i>
                                    Refresh Dataset
                                </button>
                            </div>
                        </div>

                        <!-- Summary Line -->
                        <div class="filter-summary-line" id="dsProductsFilterSummary">
                            <div class="filter-summary-items" id="dsProductsFilterSummaryItems">
                                <span class="filter-summary-empty">No filters selected</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dataset Summary Panel (matches original model_dataset.html design) -->
                <div class="dataset-summary-panel" id="dsSummarySubchapter" style="margin-top: 16px;">
                    <div class="dataset-summary-header">
                        <i class="fas fa-chart-bar"></i>
                        <span>Dataset Summary</span>
                        <span class="dataset-summary-total-rows" id="dsSummaryTotalRowsBadge"></span>
                    </div>
                    <div class="dataset-summary-content">
                        <!-- Loading state -->
                        <div id="dsSummaryLoading" class="dataset-summary-empty hidden">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span>Loading dataset statistics...</span>
                        </div>
                        <!-- Empty state before refresh -->
                        <div id="dsSummaryEmpty" class="dataset-summary-empty">
                            <i class="fas fa-info-circle"></i>
                            <span>Loading dataset statistics...</span>
                        </div>
                        <!-- Populated state after refresh -->
                        <div id="dsSummaryStats" class="dataset-summary-data hidden">
                            <!-- Filters Applied Row -->
                            <div class="dataset-filters-applied" id="dsFiltersAppliedSection">
                                <div class="filter-badge" id="dsFilterBadgeDates">
                                    <i class="fas fa-calendar-alt"></i>
                                    <span id="dsFilterBadgeDatesText">All dates</span>
                                </div>
                                <div class="filter-badge" id="dsFilterBadgeCustomers">
                                    <i class="fas fa-users"></i>
                                    <span id="dsFilterBadgeCustomersText">All customers</span>
                                </div>
                                <div class="filter-badge" id="dsFilterBadgeProducts">
                                    <i class="fas fa-box"></i>
                                    <span id="dsFilterBadgeProductsText">All products</span>
                                </div>
                            </div>
                            <!-- Column Stats Table -->
                            <div class="column-stats-table-wrapper">
                                <table class="column-stats-table" id="dsColumnStatsTable">
                                    <thead>
                                        <tr>
                                            <th>Column</th>
                                            <th>Data Type</th>
                                            <th>Statistics</th>
                                        </tr>
                                    </thead>
                                    <tbody id="dsColumnStatsTableBody">
                                        <!-- Populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Footer (Neumorphic Style) -->
        <div class="modal-footer-wizard-neu">
            <div class="footer-left">
                <button onclick="ds_prevStep()" class="btn-neu btn-neu-nav hidden" id="dsPrevButton">
                    <span class="btn-neu-inner"><i class="fas fa-chevron-left"></i></span>
                </button>
                <button onclick="ds_nextStep()" class="btn-neu btn-neu-nav" id="dsNextButton" disabled>
                    <span class="btn-neu-inner"><i class="fas fa-chevron-right"></i></span>
                </button>
            </div>
            <div class="footer-right">
                <button onclick="ds_saveDataset()" class="btn-neu btn-neu-action btn-neu-save hidden" id="dsSaveButton">
                    <span class="btn-neu-inner">Save</span>
                </button>
                <button onclick="ds_closeWizard()" class="btn-neu btn-neu-action btn-neu-cancel">
                    <span class="btn-neu-inner">Cancel</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Dataset Notification Modal (auto-closes) -->
<div id="dsNotificationModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[110] flex items-center justify-center p-4" onclick="ds_closeNotification()">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md border border-gray-300" onclick="event.stopPropagation()">
        <div id="dsNotificationHeader" class="px-5 py-4">
            <div class="flex items-center gap-3">
                <i id="dsNotificationIcon" class="fas fa-info-circle text-blue-600 text-xl"></i>
                <h3 id="dsNotificationTitle" class="text-base font-bold text-gray-900">Notification</h3>
            </div>
        </div>
        <div class="px-5 py-4 pt-0">
            <div id="dsNotificationMessage" class="text-sm text-gray-700 whitespace-pre-line"></div>
        </div>
    </div>
</div>

<!-- Dataset Delete Confirmation Modal -->
<div id="dsDeleteModal" class="modal-overlay hidden">
    <div class="modal-container modal-container-sm">
        <div class="modal-header">
            <div class="modal-header-icon danger">
                <i class="fas fa-trash-alt"></i>
            </div>
            <h3 class="modal-header-title">Delete Dataset</h3>
        </div>
        <div class="modal-body">
            <p class="text-gray-600">Are you sure you want to delete dataset <strong id="dsDeleteDatasetName"></strong>?</p>
            <p class="text-sm text-red-600 mt-2">This action cannot be undone.</p>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button onclick="ds_confirmDelete()" class="btn-neu btn-neu-action btn-neu-danger">
                    <span class="btn-neu-inner">Delete</span>
                </button>
                <button onclick="ds_closeDeleteModal()" class="btn-neu btn-neu-action btn-neu-cancel">
                    <span class="btn-neu-inner">Cancel</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Dataset Compare Modal -->
<div id="dsCompareModal" class="modal-overlay hidden">
    <div class="modal-container" style="max-width: 1000px;">
        <div class="modal-header">
            <div class="modal-header-icon info">
                <i class="fas fa-columns"></i>
            </div>
            <h3 class="modal-header-title">Compare Datasets</h3>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <!-- Dropdowns row -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Left Dataset</label>
                    <select id="dsCompareLeftSelect" onchange="ds_onCompareSelectChange('left')"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select dataset...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Right Dataset</label>
                    <select id="dsCompareRightSelect" onchange="ds_onCompareSelectChange('right')"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select dataset...</option>
                    </select>
                </div>
            </div>

            <!-- Comparison content - accordion layout -->
            <div id="dsCompareAccordions" class="ds-compare-accordions">
                <!-- Accordion 1: Basic Info -->
                <div class="filter-subchapter ds-compare-section" id="dsCompareBasicInfoSection">
                    <div class="subchapter-header-tablet" onclick="ds_toggleCompareSection('basicInfo')">
                        <span class="subchapter-title"><i class="fas fa-info-circle mr-2 text-blue-500"></i>Basic Info</span>
                        <span class="subchapter-filter-status" id="dsCompareBasicInfoStatus"></span>
                        <i id="dsCompareBasicInfoChevron" class="fas fa-chevron-right subchapter-chevron"></i>
                    </div>
                    <div id="dsCompareBasicInfoContent" class="subchapter-content-outside hidden">
                        <div class="ds-compare-grid">
                            <div id="dsCompareLeftBasicInfo" class="ds-compare-cell">
                                <div class="ds-compare-placeholder">Select a dataset</div>
                            </div>
                            <div id="dsCompareRightBasicInfo" class="ds-compare-cell">
                                <div class="ds-compare-placeholder">Select a dataset</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Accordion 2: Tables & Joins -->
                <div class="filter-subchapter ds-compare-section" id="dsCompareTablesSection">
                    <div class="subchapter-header-tablet" onclick="ds_toggleCompareSection('tables')">
                        <span class="subchapter-title"><i class="fas fa-database mr-2 text-purple-500"></i>Tables & Joins</span>
                        <span class="subchapter-filter-status" id="dsCompareTablesStatus"></span>
                        <i id="dsCompareTablesChevron" class="fas fa-chevron-right subchapter-chevron"></i>
                    </div>
                    <div id="dsCompareTablesContent" class="subchapter-content-outside hidden">
                        <div class="ds-compare-grid">
                            <div id="dsCompareLeftTables" class="ds-compare-cell"></div>
                            <div id="dsCompareRightTables" class="ds-compare-cell"></div>
                        </div>
                    </div>
                </div>

                <!-- Accordion 3: Columns Selected -->
                <div class="filter-subchapter ds-compare-section" id="dsCompareColumnsSection">
                    <div class="subchapter-header-tablet" onclick="ds_toggleCompareSection('columns')">
                        <span class="subchapter-title"><i class="fas fa-columns mr-2 text-teal-500"></i>Columns Selected</span>
                        <span class="subchapter-filter-status" id="dsCompareColumnsStatus"></span>
                        <i id="dsCompareColumnsChevron" class="fas fa-chevron-right subchapter-chevron"></i>
                    </div>
                    <div id="dsCompareColumnsContent" class="subchapter-content-outside hidden">
                        <div class="ds-compare-grid">
                            <div id="dsCompareLeftColumns" class="ds-compare-cell"></div>
                            <div id="dsCompareRightColumns" class="ds-compare-cell"></div>
                        </div>
                    </div>
                </div>

                <!-- Accordion 4: Filters Applied -->
                <div class="filter-subchapter ds-compare-section" id="dsCompareFiltersSection">
                    <div class="subchapter-header-tablet" onclick="ds_toggleCompareSection('filters')">
                        <span class="subchapter-title"><i class="fas fa-filter mr-2 text-green-500"></i>Filters Applied</span>
                        <span class="subchapter-filter-status" id="dsCompareFiltersStatus"></span>
                        <i id="dsCompareFiltersChevron" class="fas fa-chevron-right subchapter-chevron"></i>
                    </div>
                    <div id="dsCompareFiltersContent" class="subchapter-content-outside hidden">
                        <div class="ds-compare-grid">
                            <div id="dsCompareLeftFilters" class="ds-compare-cell"></div>
                            <div id="dsCompareRightFilters" class="ds-compare-cell"></div>
                        </div>
                    </div>
                </div>

                <!-- Accordion 5: Statistics -->
                <div class="filter-subchapter ds-compare-section" id="dsCompareStatsSection">
                    <div class="subchapter-header-tablet" onclick="ds_toggleCompareSection('stats')">
                        <span class="subchapter-title"><i class="fas fa-chart-bar mr-2 text-orange-500"></i>Statistics</span>
                        <span class="subchapter-filter-status" id="dsCompareStatsStatus"></span>
                        <i id="dsCompareStatsChevron" class="fas fa-chevron-right subchapter-chevron"></i>
                    </div>
                    <div id="dsCompareStatsContent" class="subchapter-content-outside hidden">
                        <div class="ds-compare-grid">
                            <div id="dsCompareLeftStats" class="ds-compare-cell"></div>
                            <div id="dsCompareRightStats" class="ds-compare-cell"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="ds_closeCompareModal()">
                    <span class="btn-neu-inner">Close</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Dataset Detail Modal -->
<div id="dsDetailModal" class="modal-overlay hidden">
    <div class="modal-container" style="max-width: 880px;">
        <div class="modal-header">
            <div class="modal-header-icon info">
                <i class="fas fa-database"></i>
            </div>
            <h3 class="modal-header-title" id="dsDetailTitle">Dataset Details</h3>
        </div>
        <div class="modal-body" id="dsDetailContent" style="max-height: 70vh; overflow-y: auto;">
            <!-- Content will be loaded dynamically -->
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button onclick="ds_closeDetailModal()" class="btn-neu btn-neu-action btn-neu-cancel">
                    <span class="btn-neu-inner">Close</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Dataset Query Preview Modal -->
<div id="dsQueryModal" class="modal-overlay hidden">
    <div class="modal-container modal-container-lg">
        <div class="modal-header">
            <div class="modal-header-icon info">
                <i class="fas fa-code"></i>
            </div>
            <h3 class="modal-header-title">Generated SQL Query</h3>
        </div>
        <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
            <div id="dsQueryValidation" class="mb-4 hidden">
                <div class="flex items-center gap-2 text-sm">
                    <i class="fas fa-check-circle text-green-500"></i>
                    <span>Query validated successfully</span>
                </div>
            </div>
            <pre id="dsQueryContent" class="bg-gray-900 text-gray-100 p-4 rounded-lg text-sm overflow-x-auto" style="white-space: pre-wrap; word-break: break-word;"></pre>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button onclick="ds_copyQuery()" class="btn-neu btn-neu-action btn-neu-secondary">
                    <span class="btn-neu-inner"><i class="fas fa-copy mr-1"></i>Copy</span>
                </button>
                <button onclick="ds_closeQueryModal()" class="btn-neu btn-neu-action btn-neu-cancel">
                    <span class="btn-neu-inner">Close</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Dataset Clone Modal -->
<div id="dsCloneModal" class="modal-overlay hidden">
    <div class="modal-container" style="max-width: 450px;">
        <div class="modal-header">
            <div class="modal-header-icon info">
                <i class="fas fa-clone"></i>
            </div>
            <h3 class="modal-header-title">Clone Dataset</h3>
        </div>
        <div class="modal-body">
            <p class="text-sm text-gray-600 mb-4">
                Create a copy of <strong id="dsCloneSourceName"></strong> with a new name.
            </p>
            <div class="wizard-field-group">
                <label for="dsCloneName" class="block text-sm font-medium text-gray-700 mb-2">
                    New Dataset Name
                </label>
                <input type="text" id="dsCloneName"
                       class="form-input w-full"
                       placeholder="Enter name for cloned dataset">
            </div>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button onclick="ds_confirmClone()" class="btn-neu btn-neu-action btn-neu-save">
                    <span class="btn-neu-inner"><i class="fas fa-clone mr-1"></i>Clone</span>
                </button>
                <button onclick="ds_closeCloneModal()" class="btn-neu btn-neu-action btn-neu-cancel">
                    <span class="btn-neu-inner">Cancel</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Dataset Top Products Modal -->
<div class="modal-overlay hidden" id="dsTopProductsModal">
    <div class="modal-container modal-container-lg">
        <div class="modal-header">
            <div class="modal-header-icon info">
                <i class="fas fa-chart-line"></i>
            </div>
            <h3 class="modal-header-title">Top Products by Revenue</h3>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <!-- Hidden checkbox to maintain state compatibility -->
            <input type="checkbox" id="dsEnableTopProducts" style="display: none;">

            <!-- Top Products Configuration (always visible) -->
            <div id="dsTopProductsConfig">
                <!-- Row: Product ID, Revenue Column, Analyze Button -->
                <div class="top-products-config-row">
                    <div class="top-products-field">
                        <label class="text-xs font-medium text-gray-600 mb-1 block">Product ID Column</label>
                        <select id="dsProductIdColumn" class="form-select text-sm" onchange="ds_onProductColumnChange()">
                            <option value="">Select column...</option>
                        </select>
                    </div>
                    <div class="top-products-field">
                        <label class="text-xs font-medium text-gray-600 mb-1 block">Revenue Column</label>
                        <select id="dsRevenueColumn" class="form-select text-sm" onchange="ds_onRevenueColumnChange()">
                            <option value="">Select column...</option>
                        </select>
                    </div>
                    <div class="top-products-field top-products-field-btn">
                        <label class="text-xs font-medium text-gray-600 mb-1 block">&nbsp;</label>
                        <button type="button" id="dsAnalyzeProductsBtn" onclick="ds_analyzeProductRevenue()"
                                class="filter-button filter-button-refresh filter-button-disabled" disabled>
                            <i class="fas fa-sync-alt"></i>
                            <span>Analyze</span>
                        </button>
                    </div>
                </div>

                <!-- Analysis Results (hidden until analyzed) -->
                <div id="dsProductAnalysisResults" class="hidden">
                    <!-- Revenue Distribution Chart -->
                    <div class="wizard-field-group">
                        <label class="text-xs font-medium text-gray-600 mb-2 block">Cumulative Revenue Distribution</label>
                        <div id="dsRevenueChartContainer" class="revenue-chart-container">
                            <svg id="dsRevenueDistributionChart"></svg>
                        </div>
                    </div>

                    <!-- Threshold Input -->
                    <div class="wizard-field-group">
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-gray-600">Include products covering up to</span>
                            <input type="number" id="dsRevenueThreshold" value="80" min="1" max="100"
                                   class="form-input w-20 text-sm text-center" onchange="ds_onThresholdChange()">
                            <span class="text-sm text-gray-600">% of cumulative revenue</span>
                        </div>
                    </div>

                    <!-- Analysis Summary -->
                    <div id="dsProductAnalysisSummary" class="analysis-summary-box">
                        <div class="analysis-summary-header">
                            <i class="fas fa-chart-pie mr-2"></i>
                            Analysis Results
                        </div>
                        <div class="analysis-summary-content">
                            <div class="analysis-stat">
                                <span class="stat-label">Total products:</span>
                                <span id="dsTotalProductsCount" class="stat-value">-</span>
                            </div>
                            <div class="analysis-stat">
                                <span class="stat-label">Selected products:</span>
                                <span id="dsSelectedProductsCount" class="stat-value">-</span>
                                <span id="dsSelectedProductsPercent" class="stat-percent"></span>
                            </div>
                            <div class="analysis-stat">
                                <span class="stat-label">Revenue coverage:</span>
                                <span id="dsRevenueCoverage" class="stat-value">-</span>
                                <span id="dsRevenueCoverageAmount" class="stat-amount"></span>
                            </div>
                        </div>
                        <div class="analysis-summary-footer">
                            <i class="fas fa-info-circle mr-1"></i>
                            Product list computed dynamically at training time
                        </div>
                    </div>
                </div>

                <!-- Analysis Error -->
                <div id="dsProductAnalysisError" class="hidden">
                    <div class="wizard-info-box error">
                        <i class="fas fa-exclamation-circle"></i>
                        <span id="dsProductAnalysisErrorText">Analysis failed</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button onclick="ds_applyTopProductsFilter()" class="btn-neu btn-neu-action btn-neu-save">
                    <span class="btn-neu-inner">Apply</span>
                </button>
                <button onclick="ds_closeTopProductsModal()" class="btn-neu btn-neu-action btn-neu-cancel">
                    <span class="btn-neu-inner">Cancel</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Dataset Top Customers Modal -->
<div class="modal-overlay hidden" id="dsTopCustomersModal">
    <div class="modal-container modal-container-lg">
        <div class="modal-header">
            <div class="modal-header-icon info">
                <i class="fas fa-chart-line"></i>
            </div>
            <h3 class="modal-header-title">Top Customers by Revenue</h3>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <!-- Hidden checkbox to maintain state compatibility -->
            <input type="checkbox" id="dsEnableTopCustomers" style="display: none;">

            <!-- Top Customers Configuration (always visible) -->
            <div id="dsTopCustomersConfig">
                <!-- Row: Customer ID, Revenue Column, Analyze Button -->
                <div class="top-products-config-row">
                    <div class="top-products-field">
                        <label class="text-xs font-medium text-gray-600 mb-1 block">Customer ID Column</label>
                        <select id="dsCustomerIdColumn" class="form-select text-sm" onchange="ds_onCustomerColumnChange()">
                            <option value="">Select column...</option>
                        </select>
                    </div>
                    <div class="top-products-field">
                        <label class="text-xs font-medium text-gray-600 mb-1 block">Revenue Column</label>
                        <select id="dsCustomerRevenueColumn" class="form-select text-sm" onchange="ds_onCustomerRevenueColumnChange()">
                            <option value="">Select column...</option>
                        </select>
                    </div>
                    <div class="top-products-field top-products-field-btn">
                        <label class="text-xs font-medium text-gray-600 mb-1 block">&nbsp;</label>
                        <button type="button" id="dsAnalyzeCustomersBtn" onclick="ds_analyzeCustomerRevenue()"
                                class="filter-button filter-button-refresh filter-button-disabled" disabled>
                            <i class="fas fa-sync-alt"></i>
                            <span>Analyze</span>
                        </button>
                    </div>
                </div>

                <!-- Analysis Results (hidden until analyzed) -->
                <div id="dsCustomerAnalysisResults" class="hidden">
                    <!-- Revenue Distribution Chart -->
                    <div class="wizard-field-group">
                        <label class="text-xs font-medium text-gray-600 mb-2 block">Cumulative Revenue Distribution</label>
                        <div id="dsCustomerRevenueChartContainer" class="revenue-chart-container">
                            <svg id="dsCustomerRevenueDistributionChart"></svg>
                        </div>
                    </div>

                    <!-- Threshold Input -->
                    <div class="wizard-field-group">
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-gray-600">Include customers covering up to</span>
                            <input type="number" id="dsCustomerRevenueThreshold" value="80" min="1" max="100"
                                   class="form-input w-20 text-sm text-center" onchange="ds_onCustomerThresholdChange()">
                            <span class="text-sm text-gray-600">% of cumulative revenue</span>
                        </div>
                    </div>

                    <!-- Analysis Summary -->
                    <div id="dsCustomerAnalysisSummary" class="analysis-summary-box">
                        <div class="analysis-summary-header">
                            <i class="fas fa-chart-pie mr-2"></i>
                            Analysis Results
                        </div>
                        <div class="analysis-summary-content">
                            <div class="analysis-stat">
                                <span class="stat-label">Total customers:</span>
                                <span id="dsTotalCustomersCount" class="stat-value">-</span>
                            </div>
                            <div class="analysis-stat">
                                <span class="stat-label">Selected customers:</span>
                                <span id="dsSelectedCustomersCount" class="stat-value">-</span>
                                <span id="dsSelectedCustomersPercent" class="stat-percent"></span>
                            </div>
                            <div class="analysis-stat">
                                <span class="stat-label">Revenue coverage:</span>
                                <span id="dsCustomerRevenueCoverage" class="stat-value">-</span>
                                <span id="dsCustomerRevenueCoverageAmount" class="stat-amount"></span>
                            </div>
                        </div>
                        <div class="analysis-summary-footer">
                            <i class="fas fa-info-circle mr-1"></i>
                            Customer list computed dynamically at training time
                        </div>
                    </div>
                </div>

                <!-- Analysis Error -->
                <div id="dsCustomerAnalysisError" class="hidden">
                    <div class="wizard-info-box error">
                        <i class="fas fa-exclamation-circle"></i>
                        <span id="dsCustomerAnalysisErrorText">Analysis failed</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button onclick="ds_applyTopCustomersFilter()" class="btn-neu btn-neu-action btn-neu-save">
                    <span class="btn-neu-inner">Apply</span>
                </button>
                <button onclick="ds_closeTopCustomersModal()" class="btn-neu btn-neu-action btn-neu-cancel">
                    <span class="btn-neu-inner">Cancel</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Dataset Product Metrics Modal -->
<div class="modal-overlay hidden" id="dsProductMetricsModal">
    <div class="modal-container modal-container-lg">
        <div class="modal-header">
            <div class="modal-header-icon info">
                <i class="fas fa-calculator"></i>
            </div>
            <h3 class="modal-header-title">Product Metrics Filters</h3>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <!-- Existing Aggregation Filters List -->
            <div id="dsExistingProductAggregationFiltersSection" class="hidden">
                <label class="text-xs font-medium text-gray-600 mb-2 block">Existing Filters</label>
                <div class="existing-filters-list" id="dsExistingProductAggregationFiltersList">
                    <!-- Filter items will be inserted here dynamically -->
                </div>
                <div class="existing-filters-divider"></div>
            </div>

            <!-- Transaction Count Filter Section -->
            <div class="customer-metrics-section">
                <div class="customer-metrics-section-header">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Transaction Count Filter</span>
                </div>
                <div class="customer-metrics-section-body">
                    <p class="wizard-field-hint mb-3">
                        <i class="fas fa-info-circle mr-1"></i>
                        Filter products based on their number of transactions
                    </p>
                    <div class="customer-metrics-form-row">
                        <div class="customer-metrics-field">
                            <label class="text-xs font-medium text-gray-600 mb-1 block">Product ID Column</label>
                            <select id="dsProductTxnCountProductColumn" class="form-select text-sm">
                                <option value="">Select column...</option>
                            </select>
                        </div>
                        <div class="customer-metrics-field">
                            <label class="text-xs font-medium text-gray-600 mb-1 block">Filter Type</label>
                            <select id="dsProductTxnCountFilterType" class="form-select text-sm" onchange="ds_updateProductTxnCountInputs()">
                                <option value="greater_than">Greater than</option>
                                <option value="less_than">Less than</option>
                                <option value="range">Range</option>
                            </select>
                        </div>
                        <div class="customer-metrics-field" id="dsProductTxnCountValueContainer">
                            <label class="text-xs font-medium text-gray-600 mb-1 block">Value</label>
                            <input type="number" id="dsProductTxnCountValue" class="form-input text-sm" min="1" placeholder="e.g., 5">
                        </div>
                        <div class="customer-metrics-field hidden" id="dsProductTxnCountMinContainer">
                            <label class="text-xs font-medium text-gray-600 mb-1 block">Min</label>
                            <input type="number" id="dsProductTxnCountMin" class="form-input text-sm" min="0" placeholder="Min">
                        </div>
                        <div class="customer-metrics-field hidden" id="dsProductTxnCountMaxContainer">
                            <label class="text-xs font-medium text-gray-600 mb-1 block">Max</label>
                            <input type="number" id="dsProductTxnCountMax" class="form-input text-sm" min="0" placeholder="Max">
                        </div>
                        <div class="customer-metrics-field customer-metrics-field-btn">
                            <label class="text-xs font-medium text-gray-600 mb-1 block">&nbsp;</label>
                            <button type="button" class="filter-button" onclick="ds_addProductTransactionCountFilter()">
                                <i class="fas fa-plus"></i>
                                Add Filter
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Revenue Filter Section -->
            <div class="customer-metrics-section">
                <div class="customer-metrics-section-header">
                    <i class="fas fa-dollar-sign"></i>
                    <span>Revenue Filter</span>
                </div>
                <div class="customer-metrics-section-body">
                    <p class="wizard-field-hint mb-3">
                        <i class="fas fa-info-circle mr-1"></i>
                        Filter products based on their total revenue
                    </p>
                    <div class="customer-metrics-form-row">
                        <div class="customer-metrics-field">
                            <label class="text-xs font-medium text-gray-600 mb-1 block">Product ID Column</label>
                            <select id="dsProductRevenueProductColumn" class="form-select text-sm">
                                <option value="">Select column...</option>
                            </select>
                        </div>
                        <div class="customer-metrics-field">
                            <label class="text-xs font-medium text-gray-600 mb-1 block">Amount Column</label>
                            <select id="dsProductRevenueAmountColumn" class="form-select text-sm">
                                <option value="">Select column...</option>
                            </select>
                        </div>
                        <div class="customer-metrics-field">
                            <label class="text-xs font-medium text-gray-600 mb-1 block">Filter Type</label>
                            <select id="dsProductRevenueFilterType" class="form-select text-sm" onchange="ds_updateProductRevenueInputs()">
                                <option value="greater_than">Greater than</option>
                                <option value="less_than">Less than</option>
                                <option value="range">Range</option>
                            </select>
                        </div>
                    </div>
                    <div class="customer-metrics-form-row mt-3">
                        <div class="customer-metrics-field" id="dsProductRevenueValueContainer">
                            <label class="text-xs font-medium text-gray-600 mb-1 block">Value</label>
                            <input type="number" id="dsProductRevenueValue" class="form-input text-sm" min="0" step="0.01" placeholder="e.g., 1000">
                        </div>
                        <div class="customer-metrics-field hidden" id="dsProductRevenueMinContainer">
                            <label class="text-xs font-medium text-gray-600 mb-1 block">Min</label>
                            <input type="number" id="dsProductRevenueMin" class="form-input text-sm" min="0" step="0.01" placeholder="Min">
                        </div>
                        <div class="customer-metrics-field hidden" id="dsProductRevenueMaxContainer">
                            <label class="text-xs font-medium text-gray-600 mb-1 block">Max</label>
                            <input type="number" id="dsProductRevenueMax" class="form-input text-sm" min="0" step="0.01" placeholder="Max">
                        </div>
                        <div class="customer-metrics-field customer-metrics-field-btn">
                            <label class="text-xs font-medium text-gray-600 mb-1 block">&nbsp;</label>
                            <button type="button" class="filter-button" onclick="ds_addProductRevenueFilter()">
                                <i class="fas fa-plus"></i>
                                Add Filter
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button onclick="ds_applyProductMetricsFilters()" class="btn-neu btn-neu-action btn-neu-save">
                    <span class="btn-neu-inner">Apply</span>
                </button>
                <button onclick="ds_cancelProductMetricsModal()" class="btn-neu btn-neu-action btn-neu-cancel">
                    <span class="btn-neu-inner">Cancel</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Dataset Customer Metrics Modal -->
<div class="modal-overlay hidden" id="dsCustomerMetricsModal">
    <div class="modal-container modal-container-lg">
        <div class="modal-header">
            <div class="modal-header-icon info">
                <i class="fas fa-calculator"></i>
            </div>
            <h3 class="modal-header-title">Customer Metrics Filters</h3>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <!-- Existing Aggregation Filters List -->
            <div id="dsExistingAggregationFiltersSection" class="hidden">
                <label class="text-xs font-medium text-gray-600 mb-2 block">Existing Filters</label>
                <div class="existing-filters-list" id="dsExistingAggregationFiltersList">
                    <!-- Filter items will be inserted here dynamically -->
                </div>
                <div class="existing-filters-divider"></div>
            </div>

            <!-- Transaction Count Filter Section -->
            <div class="customer-metrics-section">
                <div class="customer-metrics-section-header">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Transaction Count Filter</span>
                </div>
                <div class="customer-metrics-section-body">
                    <p class="wizard-field-hint mb-3">
                        <i class="fas fa-info-circle mr-1"></i>
                        Filter customers based on their number of transactions
                    </p>
                    <div class="customer-metrics-form-row">
                        <div class="customer-metrics-field">
                            <label class="text-xs font-medium text-gray-600 mb-1 block">Customer ID Column</label>
                            <select id="dsTxnCountCustomerColumn" class="form-select text-sm">
                                <option value="">Select column...</option>
                            </select>
                        </div>
                        <div class="customer-metrics-field">
                            <label class="text-xs font-medium text-gray-600 mb-1 block">Filter Type</label>
                            <select id="dsTxnCountFilterType" class="form-select text-sm" onchange="ds_updateTxnCountInputs()">
                                <option value="greater_than">Greater than</option>
                                <option value="less_than">Less than</option>
                                <option value="range">Range</option>
                            </select>
                        </div>
                        <div class="customer-metrics-field" id="dsTxnCountValueContainer">
                            <label class="text-xs font-medium text-gray-600 mb-1 block">Value</label>
                            <input type="number" id="dsTxnCountValue" class="form-input text-sm" min="1" placeholder="e.g., 5">
                        </div>
                        <div class="customer-metrics-field hidden" id="dsTxnCountMinContainer">
                            <label class="text-xs font-medium text-gray-600 mb-1 block">Min</label>
                            <input type="number" id="dsTxnCountMin" class="form-input text-sm" min="0" placeholder="Min">
                        </div>
                        <div class="customer-metrics-field hidden" id="dsTxnCountMaxContainer">
                            <label class="text-xs font-medium text-gray-600 mb-1 block">Max</label>
                            <input type="number" id="dsTxnCountMax" class="form-input text-sm" min="0" placeholder="Max">
                        </div>
                        <div class="customer-metrics-field customer-metrics-field-btn">
                            <label class="text-xs font-medium text-gray-600 mb-1 block">&nbsp;</label>
                            <button type="button" class="filter-button" onclick="ds_addTransactionCountFilter()">
                                <i class="fas fa-plus"></i>
                                Add Filter
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Spending Filter Section -->
            <div class="customer-metrics-section">
                <div class="customer-metrics-section-header">
                    <i class="fas fa-dollar-sign"></i>
                    <span>Spending Filter</span>
                </div>
                <div class="customer-metrics-section-body">
                    <p class="wizard-field-hint mb-3">
                        <i class="fas fa-info-circle mr-1"></i>
                        Filter customers based on their total spending
                    </p>
                    <div class="customer-metrics-form-row">
                        <div class="customer-metrics-field">
                            <label class="text-xs font-medium text-gray-600 mb-1 block">Customer ID Column</label>
                            <select id="dsSpendingCustomerColumn" class="form-select text-sm">
                                <option value="">Select column...</option>
                            </select>
                        </div>
                        <div class="customer-metrics-field">
                            <label class="text-xs font-medium text-gray-600 mb-1 block">Amount Column</label>
                            <select id="dsSpendingAmountColumn" class="form-select text-sm">
                                <option value="">Select column...</option>
                            </select>
                        </div>
                        <div class="customer-metrics-field">
                            <label class="text-xs font-medium text-gray-600 mb-1 block">Filter Type</label>
                            <select id="dsSpendingFilterType" class="form-select text-sm" onchange="ds_updateSpendingInputs()">
                                <option value="greater_than">Greater than</option>
                                <option value="less_than">Less than</option>
                                <option value="range">Range</option>
                            </select>
                        </div>
                    </div>
                    <div class="customer-metrics-form-row mt-3">
                        <div class="customer-metrics-field" id="dsSpendingValueContainer">
                            <label class="text-xs font-medium text-gray-600 mb-1 block">Value</label>
                            <input type="number" id="dsSpendingValue" class="form-input text-sm" min="0" step="0.01" placeholder="e.g., 1000">
                        </div>
                        <div class="customer-metrics-field hidden" id="dsSpendingMinContainer">
                            <label class="text-xs font-medium text-gray-600 mb-1 block">Min</label>
                            <input type="number" id="dsSpendingMin" class="form-input text-sm" min="0" step="0.01" placeholder="Min">
                        </div>
                        <div class="customer-metrics-field hidden" id="dsSpendingMaxContainer">
                            <label class="text-xs font-medium text-gray-600 mb-1 block">Max</label>
                            <input type="number" id="dsSpendingMax" class="form-input text-sm" min="0" step="0.01" placeholder="Max">
                        </div>
                        <div class="customer-metrics-field customer-metrics-field-btn">
                            <label class="text-xs font-medium text-gray-600 mb-1 block">&nbsp;</label>
                            <button type="button" class="filter-button" onclick="ds_addSpendingFilter()">
                                <i class="fas fa-plus"></i>
                                Add Filter
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button onclick="ds_applyCustomerMetricsFilters()" class="btn-neu btn-neu-action btn-neu-save">
                    <span class="btn-neu-inner">Apply</span>
                </button>
                <button onclick="ds_cancelCustomerMetricsModal()" class="btn-neu btn-neu-action btn-neu-cancel">
                    <span class="btn-neu-inner">Cancel</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Dataset Filter Columns Modal -->
<div class="modal-overlay hidden" id="dsFilterColumnsModal">
    <div class="modal-container modal-container-lg">
        <div class="modal-header">
            <div class="modal-header-icon info">
                <i class="fas fa-filter"></i>
            </div>
            <h3 class="modal-header-title">Filter Columns</h3>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <!-- Existing Filters List -->
            <div id="dsExistingFiltersSection" class="hidden">
                <label class="text-xs font-medium text-gray-600 mb-2 block">Existing Filters</label>
                <div class="existing-filters-list" id="dsExistingFiltersList">
                    <!-- Filter items will be inserted here dynamically -->
                </div>
                <div class="existing-filters-divider"></div>
            </div>

            <!-- Add New Filter Section -->
            <div id="dsAddFilterSection">
                <label class="text-xs font-medium text-gray-600 mb-2 block">Add New Filter</label>
                <div class="add-filter-form-group">
                    <select id="dsFilterColumnSelect" class="form-select w-full text-sm" onchange="ds_onFilterColumnSelect()">
                        <option value="">Select column...</option>
                    </select>
                </div>

                <!-- Inline Filter Configuration (appears based on column type) -->
                <div id="dsFilterConfigContainer" class="hidden">
                    <!-- Category Filter Config -->
                    <div id="dsCategoryFilterConfig" class="filter-config-panel hidden">
                        <div class="filter-config-header">
                            <span id="dsCategoryFilterColumnName" class="filter-config-column-name"></span>
                            <span class="filter-config-type-badge">STRING</span>
                        </div>
                        <div class="filter-config-body">
                            <div class="category-filter-mode" style="margin-bottom: 12px;">
                                <label>
                                    <input type="radio" name="dsNewCategoryMode" value="include" checked>
                                    Include selected
                                </label>
                                <label>
                                    <input type="radio" name="dsNewCategoryMode" value="exclude">
                                    Exclude selected
                                </label>
                            </div>
                            <div class="category-filter-values-container" id="dsNewCategoryValuesContainer">
                                <!-- List mode or autocomplete will be rendered here -->
                            </div>
                        </div>
                    </div>

                    <!-- Numeric Filter Config -->
                    <div id="dsNumericFilterConfig" class="filter-config-panel hidden">
                        <div class="filter-config-header">
                            <span id="dsNumericFilterColumnName" class="filter-config-column-name"></span>
                            <span id="dsNumericFilterTypeBadge" class="filter-config-type-badge">INTEGER</span>
                        </div>
                        <div class="filter-config-stats" id="dsNumericFilterStats">
                            <!-- Range: X - Y | Nulls: Z% -->
                        </div>
                        <div class="filter-config-body">
                            <div class="numeric-filter-type" style="margin-bottom: 12px;">
                                <label>
                                    <input type="radio" name="dsNewNumericType" value="range" checked onchange="ds_updateNumericFilterInputs()">
                                    Range
                                </label>
                                <label>
                                    <input type="radio" name="dsNewNumericType" value="greater_than" onchange="ds_updateNumericFilterInputs()">
                                    Greater than
                                </label>
                                <label>
                                    <input type="radio" name="dsNewNumericType" value="less_than" onchange="ds_updateNumericFilterInputs()">
                                    Less than
                                </label>
                                <label>
                                    <input type="radio" name="dsNewNumericType" value="equals" onchange="ds_updateNumericFilterInputs()">
                                    Equals
                                </label>
                                <label>
                                    <input type="radio" name="dsNewNumericType" value="not_equals" onchange="ds_updateNumericFilterInputs()">
                                    Not Equals
                                </label>
                            </div>
                            <div class="numeric-filter-inputs" id="dsNewNumericInputs">
                                <div class="numeric-filter-input-group">
                                    <label class="numeric-filter-input-label">Min</label>
                                    <input type="number" class="numeric-filter-input" id="dsNewNumericMin" placeholder="">
                                </div>
                                <div class="numeric-filter-input-group">
                                    <label class="numeric-filter-input-label">Max</label>
                                    <input type="number" class="numeric-filter-input" id="dsNewNumericMax" placeholder="">
                                </div>
                            </div>
                            <div class="numeric-filter-null-handling" id="dsNewNumericNullHandling">
                                <label>
                                    <input type="checkbox" id="dsNewNumericIncludeNulls" checked>
                                    Include NULL values
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Date Filter Config -->
                    <div id="dsDateFilterConfig" class="filter-config-panel hidden">
                        <div class="filter-config-header">
                            <span id="dsDateFilterColumnName" class="filter-config-column-name"></span>
                            <span class="filter-config-type-badge">DATE</span>
                        </div>
                        <div class="filter-config-stats" id="dsDateFilterStats">
                            <!-- Range: YYYY-MM-DD - YYYY-MM-DD -->
                        </div>
                        <div class="filter-config-body">
                            <div class="date-filter-type" style="margin-bottom: 12px;">
                                <label>
                                    <input type="radio" name="dsNewDateType" value="relative" checked onchange="ds_updateDateFilterInputs()">
                                    Relative
                                </label>
                                <label>
                                    <input type="radio" name="dsNewDateType" value="range" onchange="ds_updateDateFilterInputs()">
                                    Date Range
                                </label>
                            </div>
                            <!-- Relative Date Options -->
                            <div class="date-filter-relative" id="dsNewDateRelativeInputs">
                                <select id="dsNewDateRelativeOption" class="form-select w-full text-sm">
                                    <option value="last_7_days">Last 7 days</option>
                                    <option value="last_30_days" selected>Last 30 days</option>
                                    <option value="last_90_days">Last 90 days</option>
                                    <option value="this_month">This month</option>
                                    <option value="this_quarter">This quarter</option>
                                    <option value="this_year">This year</option>
                                </select>
                            </div>
                            <!-- Date Range Inputs -->
                            <div class="date-filter-range hidden" id="dsNewDateRangeInputs">
                                <div class="date-filter-input-group">
                                    <label class="date-filter-input-label">Start Date</label>
                                    <input type="date" class="form-input text-sm" id="dsNewDateStart">
                                </div>
                                <div class="date-filter-input-group">
                                    <label class="date-filter-input-label">End Date</label>
                                    <input type="date" class="form-input text-sm" id="dsNewDateEnd">
                                </div>
                            </div>
                            <div class="date-filter-null-handling" id="dsNewDateNullHandling" style="margin-top: 12px;">
                                <label>
                                    <input type="checkbox" id="dsNewDateIncludeNulls" checked>
                                    Include NULL values
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button onclick="ds_applyFilterColumnsModal()" class="btn-neu btn-neu-action btn-neu-save">
                    <span class="btn-neu-inner">Apply</span>
                </button>
                <button onclick="ds_closeFilterColumnsModal()" class="btn-neu btn-neu-action btn-neu-cancel">
                    <span class="btn-neu-inner">Cancel</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Model Config Wizard Modal -->
<div id="modelConfigWizardModal" class="modal-overlay hidden">
    <div class="modal-container modal-container-wizard" style="max-width: 900px;">
        <!-- Modal Header -->
        <div class="modal-header-wizard">
            <div class="modal-header-content">
                <div class="modal-header-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);">
                    <i class="fas fa-layer-group text-lg text-white"></i>
                </div>
                <div class="modal-header-info">
                    <h3 class="modal-header-title" id="modelConfigWizardTitle">Create Model Config</h3>
                    <p class="modal-step-counter">Step <span id="mcCurrentStep">1</span> of 3</p>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress-bar-pills">
                <div id="mcProgress1" class="progress-step-pill current">Basic Info</div>
                <div id="mcProgress2" class="progress-step-pill future">Architecture</div>
                <div id="mcProgress3" class="progress-step-pill future">Training</div>
            </div>
        </div>

        <!-- Modal Body -->
        <div class="modal-body-wizard" style="max-height: calc(90vh - 200px); overflow-y: auto;">
            <!-- Step 1: Basic Info + Model Type -->
            <div id="mcStep1" class="wizard-step active">
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Model Type</label>
                    <div class="wizard-model-type-selector">
                        <div class="wizard-model-type-option selected" data-type="retrieval" onclick="selectModelType('retrieval')">
                            <div class="wizard-model-type-icon retrieval">
                                <i class="fas fa-search"></i>
                            </div>
                            <div class="wizard-model-type-content">
                                <div class="wizard-model-type-name">Retrieval</div>
                                <div class="wizard-model-type-desc">Two-tower model for candidate retrieval</div>
                            </div>
                        </div>
                        <div class="wizard-model-type-option" data-type="ranking" onclick="selectModelType('ranking')">
                            <div class="wizard-model-type-icon ranking">
                                <i class="fas fa-sort-amount-down"></i>
                            </div>
                            <div class="wizard-model-type-content">
                                <div class="wizard-model-type-name">Ranking</div>
                                <div class="wizard-model-type-desc">Score and rank retrieved candidates</div>
                            </div>
                        </div>
                        <div class="wizard-model-type-option" data-type="multitask" onclick="selectModelType('multitask')">
                            <div class="wizard-model-type-icon multitask">
                                <i class="fas fa-project-diagram"></i>
                            </div>
                            <div class="wizard-model-type-content">
                                <div class="wizard-model-type-name">Multitask</div>
                                <div class="wizard-model-type-desc">Combined retrieval + ranking</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Configuration Name <span class="text-red-500">*</span></label>
                    <div class="relative">
                        <input type="text" id="mcName" class="training-param-input w-full" placeholder="e.g., Standard Retrieval v1"
                               oninput="debounceMcNameCheck()" onblur="checkMcNameAvailability()" />
                        <div id="mcNameStatus" class="absolute right-3 top-1/2 -translate-y-1/2 hidden">
                            <i id="mcNameSpinner" class="fas fa-spinner fa-spin text-gray-400 hidden"></i>
                            <i id="mcNameValid" class="fas fa-check-circle text-green-500 hidden"></i>
                            <i id="mcNameInvalid" class="fas fa-times-circle text-red-500 hidden"></i>
                        </div>
                    </div>
                    <p id="mcNameError" class="text-red-500 text-xs mt-1 hidden"></p>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                    <textarea id="mcDescription" class="training-param-input w-full" rows="2" placeholder="Optional description..."></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Start From Preset</label>
                    <div class="preset-selector">
                        <div class="preset-option" data-preset="minimal" onclick="selectPreset('minimal')">
                            <div class="preset-option-name">Minimal</div>
                            <div class="preset-option-desc">6432, fast</div>
                        </div>
                        <div class="preset-option selected" data-preset="standard" onclick="selectPreset('standard')">
                            <div class="preset-option-name">Standard</div>
                            <div class="preset-option-desc">1286432</div>
                        </div>
                        <div class="preset-option" data-preset="deep" onclick="selectPreset('deep')">
                            <div class="preset-option-name">Deep</div>
                            <div class="preset-option-desc">2561286432</div>
                        </div>
                        <div class="preset-option" data-preset="regularized" onclick="selectPreset('regularized')">
                            <div class="preset-option-name">Regularized</div>
                            <div class="preset-option-desc">With dropout</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Tower Architecture -->
            <div id="mcStep2" class="wizard-step">
                <div class="grid grid-cols-2 gap-6">
                    <!-- Buyer Tower -->
                    <div class="tower-builder-panel buyer">
                        <div class="tower-builder-header">
                            <div class="tower-builder-title">
                                <div class="tower-icon">
                                    <i class="fas fa-user"></i>
                                </div>
                                Buyer Tower (Query)
                            </div>
                            <span id="buyerTowerSummary" class="tower-builder-summary">1286432</span>
                        </div>
                        <div class="p-2">
                            <button class="add-layer-btn" onclick="addLayer('buyer')">
                                <i class="fas fa-plus"></i> Add Layer
                            </button>
                        </div>
                        <div class="layer-list" id="buyerLayerList">
                            <!-- Layers will be rendered here -->
                        </div>
                        <div class="tower-params-summary" id="buyerParamsSummary">
                            <div class="params-row"><span>Total params:</span><span id="buyerTotalParams">0</span></div>
                            <div class="params-row"><span>Trainable params:</span><span id="buyerTrainableParams">0</span></div>
                            <div class="params-row"><span>Non-trainable params:</span><span>0</span></div>
                        </div>
                    </div>

                    <!-- Product Tower -->
                    <div class="tower-builder-panel product">
                        <div class="tower-builder-header">
                            <div class="tower-builder-title">
                                <div class="tower-icon">
                                    <i class="fas fa-box"></i>
                                </div>
                                Product Tower (Candidate)
                            </div>
                            <span id="productTowerSummary" class="tower-builder-summary">1286432</span>
                        </div>
                        <div class="p-2">
                            <button class="add-layer-btn" onclick="addLayer('product')">
                                <i class="fas fa-plus"></i> Add Layer
                            </button>
                        </div>
                        <div class="layer-list" id="productLayerList">
                            <!-- Layers will be rendered here -->
                        </div>
                        <div class="tower-params-summary" id="productParamsSummary">
                            <div class="params-row"><span>Total params:</span><span id="productTotalParams">0</span></div>
                            <div class="params-row"><span>Trainable params:</span><span id="productTrainableParams">0</span></div>
                            <div class="params-row"><span>Non-trainable params:</span><span>0</span></div>
                        </div>
                    </div>
                </div>

                <!-- Retrieval Algorithm Section -->
                <div class="retrieval-algorithm-section">
                    <div class="retrieval-algorithm-header">
                        <div class="header-icon">
                            <i class="fas fa-search"></i>
                        </div>
                        <div>
                            <h4>Retrieval Algorithm</h4>
                            <p>How to find top candidates from the product catalog</p>
                        </div>
                    </div>

                    <div class="algorithm-options">
                        <!-- Brute Force Option -->
                        <div class="algorithm-option selected" onclick="selectRetrievalAlgorithm('brute_force')">
                            <div class="option-header">
                                <div class="option-radio"></div>
                                <span class="option-title">Brute Force</span>
                                <span class="option-badge default">Default</span>
                            </div>
                            <p class="option-desc">Exact nearest neighbor search. Computes similarity with all products. Best for catalogs under 10K items.</p>
                        </div>

                        <!-- ScaNN Option -->
                        <div class="algorithm-option" onclick="selectRetrievalAlgorithm('scann')">
                            <div class="option-header">
                                <div class="option-radio"></div>
                                <span class="option-title">ScaNN</span>
                                <span class="option-badge advanced">Large Scale</span>
                            </div>
                            <p class="option-desc">Approximate nearest neighbor. 10-20x faster for large catalogs. ~97% accuracy with optimized parameters.</p>
                        </div>
                    </div>

                    <!-- Brute Force Parameters -->
                    <div id="bruteForceParams" class="algorithm-params">
                        <div class="algorithm-param-group">
                            <label>Top K Results:</label>
                            <input type="number" id="mcTopK" value="100" min="10" max="1000" step="10" />
                        </div>
                        <span class="text-xs text-amber-700">Number of recommendations to retrieve per query</span>
                    </div>

                    <!-- ScaNN Parameters (hidden by default) -->
                    <div id="scannParams" class="scann-params hidden">
                        <div class="scann-params-grid">
                            <div class="scann-param">
                                <label>Top K Results</label>
                                <input type="number" id="mcScannTopK" value="100" min="10" max="1000" step="10" />
                            </div>
                            <div class="scann-param">
                                <label>Num Leaves</label>
                                <input type="number" id="mcScannNumLeaves" value="100" min="10" max="10000" step="10" />
                            </div>
                            <div class="scann-param">
                                <label>Leaves to Search</label>
                                <input type="number" id="mcScannLeavesToSearch" value="10" min="1" max="1000" step="1" />
                            </div>
                        </div>
                        <div class="scann-info-banner">
                            <i class="fas fa-info-circle"></i>
                            <p><strong>Recommended for catalogs with 10,000+ products.</strong> ScaNN uses tree-partitioning for fast approximate search. Default values work well for most cases. Increase "Leaves to Search" for higher accuracy.</p>
                        </div>
                    </div>
                </div>

                <!-- Rating Head Section (for Ranking models) -->
                <div id="ratingHeadSection" class="rating-head-section hidden">
                    <div class="rating-head-header">
                        <div class="header-icon">
                            <i class="fas fa-star"></i>
                        </div>
                        <div>
                            <h4>Rating Head</h4>
                            <p>Predicts rating from concatenated buyer and product embeddings</p>
                        </div>
                    </div>

                    <!-- Rating Head Tower Builder -->
                    <div class="tower-builder-panel rating-head">
                        <div class="tower-builder-header">
                            <div class="tower-builder-title">
                                <div class="tower-icon rating">
                                    <i class="fas fa-star"></i>
                                </div>
                                Rating Prediction Network
                            </div>
                            <span id="ratingHeadSummary" class="tower-builder-summary">12864321</span>
                        </div>
                        <div class="p-2">
                            <button class="add-layer-btn" onclick="addLayer('rating_head')">
                                <i class="fas fa-plus"></i> Add Layer
                            </button>
                        </div>
                        <div class="layer-list" id="ratingHeadLayerList">
                            <!-- Layers will be rendered here -->
                        </div>
                        <div class="tower-params-summary" id="ratingHeadParamsSummary">
                            <div class="params-row"><span>Total params:</span><span id="ratingHeadTotalParams">0</span></div>
                            <div class="params-row"><span>Trainable params:</span><span id="ratingHeadTrainableParams">0</span></div>
                            <div class="params-row"><span>Non-trainable params:</span><span>0</span></div>
                        </div>
                    </div>

                    <div class="rating-head-info-banner">
                        <i class="fas fa-info-circle"></i>
                        <p>The Rating Head structure is derived from the tower preset selected in Step 1. It receives concatenated embeddings from both towers and outputs a single scalar prediction. You can manually edit the layers below, and you'll select the rating column when running a Quick Test.</p>
                    </div>
                </div>

                <!-- Multitask Architecture Diagram (for Multitask models) -->
                <div id="multitaskArchSection" class="multitask-arch-section hidden">
                    <div class="multitask-arch-header">
                        <div class="header-icon">
                            <i class="fas fa-project-diagram"></i>
                        </div>
                        <div>
                            <h4>Multitask Architecture</h4>
                            <p>Combined retrieval and ranking in a single model</p>
                        </div>
                    </div>

                    <div class="multitask-arch-diagram">
                        <!-- Tower Inputs -->
                        <div class="arch-row towers-row">
                            <div class="arch-tower buyer">
                                <div class="arch-tower-label">Buyer Tower</div>
                                <div class="arch-tower-summary" id="archBuyerSummary">1286432</div>
                            </div>
                            <div class="arch-tower product">
                                <div class="arch-tower-label">Product Tower</div>
                                <div class="arch-tower-summary" id="archProductSummary">1286432</div>
                            </div>
                        </div>

                        <!-- Arrows down -->
                        <div class="arch-row arrows-row">
                            <div class="arch-arrow"></div>
                            <div class="arch-arrow"></div>
                        </div>

                        <!-- Embeddings -->
                        <div class="arch-row embeddings-row">
                            <div class="arch-embedding buyer">
                                <span id="archBuyerDim">32D</span> embed
                            </div>
                            <div class="arch-embedding product">
                                <span id="archProductDim">32D</span> embed
                            </div>
                        </div>

                        <!-- Split arrows -->
                        <div class="arch-row split-row">
                            <div class="arch-split-line"></div>
                        </div>

                        <!-- Two paths -->
                        <div class="arch-row paths-row">
                            <!-- Retrieval Path -->
                            <div class="arch-path retrieval">
                                <div class="arch-path-header">
                                    <i class="fas fa-search"></i>
                                    Retrieval Task
                                </div>
                                <div class="arch-path-content">
                                    <div class="arch-operation">Dot Product</div>
                                    <div class="arch-arrow-small"></div>
                                    <div class="arch-output">Similarity Score</div>
                                </div>
                                <div class="arch-path-metric">
                                    <i class="fas fa-chart-line"></i>
                                    FactorizedTopK
                                </div>
                            </div>

                            <!-- Ranking Path -->
                            <div class="arch-path ranking">
                                <div class="arch-path-header">
                                    <i class="fas fa-star"></i>
                                    Ranking Task
                                </div>
                                <div class="arch-path-content">
                                    <div class="arch-operation">Concatenate [<span id="archConcatDim">64D</span>]</div>
                                    <div class="arch-arrow-small"></div>
                                    <div class="arch-rating-head">
                                        <span>Rating Head</span>
                                        <span id="archRatingHeadSummary">12864321</span>
                                    </div>
                                    <div class="arch-arrow-small"></div>
                                    <div class="arch-output">Rating Prediction</div>
                                </div>
                                <div class="arch-path-metric">
                                    <i class="fas fa-bullseye"></i>
                                    <span id="archLossFunction">MSE</span>
                                </div>
                            </div>
                        </div>

                        <!-- Combined Loss -->
                        <div class="arch-row loss-row">
                            <div class="arch-combined-loss">
                                <div class="arch-loss-formula">
                                    <span class="loss-term retrieval">
                                        <span id="archRetrievalWeight">1.0</span>  Retrieval Loss
                                    </span>
                                    <span class="loss-plus">+</span>
                                    <span class="loss-term ranking">
                                        <span id="archRankingWeight">1.0</span>  Ranking Loss
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Step 3: Training Parameters -->
            <div id="mcStep3" class="wizard-step">
                <div class="training-step-container">
                    <!-- Optimizer Panel -->
                    <div class="training-panel optimizer">
                        <div class="training-panel-header">
                            <div class="training-panel-title">
                                <div class="panel-icon">
                                    <i class="fas fa-cogs"></i>
                                </div>
                                Optimizer
                            </div>
                        </div>
                        <div class="training-panel-body">
                            <div class="optimizer-grid">
                                <label class="optimizer-option selected" onclick="selectOptimizer('adagrad')">
                                    <input type="radio" name="mcOptimizer" value="adagrad" checked>
                                    <div class="optimizer-radio"></div>
                                    <div class="optimizer-info">
                                        <div class="optimizer-name">Adagrad</div>
                                        <div class="optimizer-desc">Best for sparse embeddings</div>
                                    </div>
                                    <span class="optimizer-badge">Recommended</span>
                                </label>
                                <label class="optimizer-option" onclick="selectOptimizer('adam')">
                                    <input type="radio" name="mcOptimizer" value="adam">
                                    <div class="optimizer-radio"></div>
                                    <div class="optimizer-info">
                                        <div class="optimizer-name">Adam</div>
                                        <div class="optimizer-desc">Adaptive moments</div>
                                    </div>
                                </label>
                                <label class="optimizer-option" onclick="selectOptimizer('sgd')">
                                    <input type="radio" name="mcOptimizer" value="sgd">
                                    <div class="optimizer-radio"></div>
                                    <div class="optimizer-info">
                                        <div class="optimizer-name">SGD</div>
                                        <div class="optimizer-desc">Classic gradient descent</div>
                                    </div>
                                </label>
                                <label class="optimizer-option" onclick="selectOptimizer('rmsprop')">
                                    <input type="radio" name="mcOptimizer" value="rmsprop">
                                    <div class="optimizer-radio"></div>
                                    <div class="optimizer-info">
                                        <div class="optimizer-name">RMSprop</div>
                                        <div class="optimizer-desc">Adaptive learning rate</div>
                                    </div>
                                </label>
                                <label class="optimizer-option" onclick="selectOptimizer('adamw')">
                                    <input type="radio" name="mcOptimizer" value="adamw">
                                    <div class="optimizer-radio"></div>
                                    <div class="optimizer-info">
                                        <div class="optimizer-name">AdamW</div>
                                        <div class="optimizer-desc">Adam with weight decay</div>
                                    </div>
                                </label>
                                <label class="optimizer-option" onclick="selectOptimizer('ftrl')">
                                    <input type="radio" name="mcOptimizer" value="ftrl">
                                    <div class="optimizer-radio"></div>
                                    <div class="optimizer-info">
                                        <div class="optimizer-name">FTRL</div>
                                        <div class="optimizer-desc">Follow the regularized leader</div>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Hyperparameters Panel -->
                    <div class="training-panel hyperparams">
                        <div class="training-panel-header">
                            <div class="training-panel-title">
                                <div class="panel-icon">
                                    <i class="fas fa-sliders-h"></i>
                                </div>
                                Hyperparameters
                            </div>
                        </div>
                        <div class="training-panel-body">
                            <!-- Learning Rate -->
                            <div class="hyperparam-item">
                                <label class="hyperparam-label">
                                    <i class="fas fa-tachometer-alt"></i>
                                    Learning Rate
                                </label>
                                <div class="hyperparam-input-wrapper">
                                    <input type="number" id="mcLearningRate" class="hyperparam-input" value="0.1" step="0.01" min="0.0001" max="1.0" />
                                </div>
                                <div class="lr-presets">
                                    <button type="button" class="lr-preset-btn" onclick="setLearningRate(0.001)">0.001</button>
                                    <button type="button" class="lr-preset-btn" onclick="setLearningRate(0.01)">0.01</button>
                                    <button type="button" class="lr-preset-btn active" onclick="setLearningRate(0.1)">0.1</button>
                                    <button type="button" class="lr-preset-btn" onclick="setLearningRate(0.5)">0.5</button>
                                </div>
                                <p class="hyperparam-hint">Higher for Adagrad (0.1), lower for Adam (0.001)</p>
                            </div>

                            <!-- Batch Size -->
                            <div class="hyperparam-item">
                                <label class="hyperparam-label">
                                    <i class="fas fa-layer-group"></i>
                                    Batch Size
                                </label>
                                <select id="mcBatchSize" class="hyperparam-input">
                                    <option value="512">512 (small datasets)</option>
                                    <option value="1024">1024</option>
                                    <option value="2048">2048</option>
                                    <option value="4096" selected>4096 (recommended)</option>
                                    <option value="8192">8192</option>
                                    <option value="16384">16384 (large datasets)</option>
                                </select>
                                <p class="hyperparam-hint">Larger batches = faster training, more GPU memory</p>
                            </div>
                        </div>
                    </div>

                    <!-- Loss Function Panel (for Ranking models) -->
                    <div id="lossFunctionPanel" class="training-panel loss-function hidden">
                        <div class="training-panel-header">
                            <div class="training-panel-title">
                                <div class="panel-icon loss">
                                    <i class="fas fa-bullseye"></i>
                                </div>
                                Loss Function
                            </div>
                        </div>
                        <div class="training-panel-body">
                            <div class="loss-function-grid">
                                <label class="loss-option selected" onclick="selectLossFunction('mse')">
                                    <input type="radio" name="mcLossFunction" value="mse" checked>
                                    <div class="loss-radio"></div>
                                    <div class="loss-info">
                                        <div class="loss-name">MSE</div>
                                        <div class="loss-desc">Mean Squared Error</div>
                                    </div>
                                    <span class="loss-badge">Recommended</span>
                                </label>
                                <label class="loss-option" onclick="selectLossFunction('binary_crossentropy')">
                                    <input type="radio" name="mcLossFunction" value="binary_crossentropy">
                                    <div class="loss-radio"></div>
                                    <div class="loss-info">
                                        <div class="loss-name">Binary CE</div>
                                        <div class="loss-desc">Binary Crossentropy</div>
                                    </div>
                                </label>
                                <label class="loss-option" onclick="selectLossFunction('huber')">
                                    <input type="radio" name="mcLossFunction" value="huber">
                                    <div class="loss-radio"></div>
                                    <div class="loss-info">
                                        <div class="loss-name">Huber</div>
                                        <div class="loss-desc">Robust to outliers</div>
                                    </div>
                                </label>
                            </div>
                            <div class="loss-info-text" id="lossInfoText">
                                <i class="fas fa-info-circle"></i>
                                <p>Best for continuous ratings (e.g., 1.0-5.0). Penalizes large prediction errors more heavily.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Multitask Loss Weighting Panel (for Multitask models) -->
                    <div id="multitaskWeightSection" class="training-panel multitask-weights hidden">
                        <div class="training-panel-header">
                            <div class="training-panel-title">
                                <div class="panel-icon multitask">
                                    <i class="fas fa-balance-scale"></i>
                                </div>
                                Loss Weighting
                            </div>
                        </div>
                        <div class="training-panel-body">
                            <div class="weight-slider-container">
                                <!-- Retrieval Weight Slider -->
                                <div class="weight-slider-item">
                                    <div class="weight-slider-header">
                                        <label class="weight-slider-label">
                                            <i class="fas fa-search"></i>
                                            Retrieval Weight
                                        </label>
                                        <span class="weight-value" id="retrievalWeightValue">1.0</span>
                                    </div>
                                    <input type="range" id="mcRetrievalWeight" class="weight-slider retrieval"
                                           min="0" max="1" step="0.1" value="1.0"
                                           oninput="updateRetrievalWeight(this.value)" />
                                    <p class="weight-slider-hint">Higher = Optimize for candidate selection (Recall@K)</p>
                                </div>

                                <!-- Ranking Weight Slider -->
                                <div class="weight-slider-item">
                                    <div class="weight-slider-header">
                                        <label class="weight-slider-label">
                                            <i class="fas fa-star"></i>
                                            Ranking Weight
                                        </label>
                                        <span class="weight-value" id="rankingWeightValue">1.0</span>
                                    </div>
                                    <input type="range" id="mcRankingWeight" class="weight-slider ranking"
                                           min="0" max="1" step="0.1" value="1.0"
                                           oninput="updateRankingWeight(this.value)" />
                                    <p class="weight-slider-hint">Higher = Optimize for rating prediction (RMSE)</p>
                                </div>
                            </div>

                            <!-- Weight Validation Warning -->
                            <div id="weightValidationWarning" class="weight-validation-warning hidden">
                                <i class="fas fa-exclamation-triangle"></i>
                                <p>At least one weight must be greater than 0</p>
                            </div>

                            <div class="weight-info-banner">
                                <i class="fas fa-info-circle"></i>
                                <p>Both tasks share the same embedding towers. Weights control how much each loss contributes to training. A balanced start (1.0 / 1.0) is recommended for initial experiments.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Summary Panel -->
                <div class="mt-4 p-4 bg-purple-50 rounded-lg border border-purple-200">
                    <h4 class="font-semibold text-purple-900 mb-3">Configuration Summary</h4>
                    <div class="grid grid-cols-3 gap-4 text-sm">
                        <div>
                            <span class="text-purple-700">Model Type:</span>
                            <span id="mcSummaryType" class="font-medium text-purple-900">Retrieval</span>
                        </div>
                        <div>
                            <span class="text-purple-700">Buyer Tower:</span>
                            <span id="mcSummaryBuyer" class="font-medium text-purple-900">1286432</span>
                        </div>
                        <div>
                            <span class="text-purple-700">Product Tower:</span>
                            <span id="mcSummaryProduct" class="font-medium text-purple-900">1286432</span>
                        </div>
                        <div>
                            <span class="text-purple-700">Output Dim:</span>
                            <span id="mcSummaryOutputDim" class="font-medium text-purple-900">32</span>
                        </div>
                        <div id="mcSummaryRetrievalRow">
                            <span class="text-purple-700">Retrieval:</span>
                            <span id="mcSummaryRetrieval" class="font-medium text-purple-900">Brute Force (Top 100)</span>
                        </div>
                        <div id="mcSummaryRatingHeadRow" class="hidden">
                            <span class="text-purple-700">Rating Head:</span>
                            <span id="mcSummaryRatingHead" class="font-medium text-purple-900">256641</span>
                        </div>
                        <div id="mcSummaryLossRow" class="hidden">
                            <span class="text-purple-700">Loss:</span>
                            <span id="mcSummaryLoss" class="font-medium text-purple-900">MSE</span>
                        </div>
                        <div id="mcSummaryWeightsRow" class="hidden">
                            <span class="text-purple-700">Weights:</span>
                            <span id="mcSummaryWeights" class="font-medium text-purple-900">Ret: 1.0 / Rank: 1.0</span>
                        </div>
                        <div>
                            <span class="text-purple-700">Est. Parameters:</span>
                            <span id="mcSummaryParams" class="font-medium text-purple-900">~50K</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="modal-footer-wizard-neu">
            <div class="footer-left">
                <button type="button" id="mcBtnBack" class="btn-neu btn-neu-nav hidden" onclick="mcPrevStep()">
                    <span class="btn-neu-inner"><i class="fas fa-chevron-left"></i></span>
                </button>
                <button type="button" id="mcBtnNext" class="btn-neu btn-neu-nav" onclick="mcNextStep()">
                    <span class="btn-neu-inner"><i class="fas fa-chevron-right"></i></span>
                </button>
            </div>
            <div class="footer-right">
                <button type="button" id="mcBtnCreate" class="btn-neu btn-neu-action btn-neu-save hidden" onclick="createModelConfig()">
                    <span class="btn-neu-inner">Save</span>
                </button>
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeModelConfigWizard()">
                    <span class="btn-neu-inner">Cancel</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Layer Modal -->
<div id="layerModal" class="modal-overlay hidden" onclick="closeLayerModal(event)">
    <div class="modal-container" style="max-width: 480px;" onclick="event.stopPropagation()">
        <div class="modal-header">
            <div class="flex items-center gap-3">
                <div id="layerModalIcon" class="w-8 h-8 rounded-lg flex items-center justify-center" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);">
                    <i class="fas fa-layer-group text-white text-sm"></i>
                </div>
                <div>
                    <h3 class="modal-title" id="layerModalTitle">Edit Layer</h3>
                    <p class="text-xs text-gray-500" id="layerModalSubtitle">Configure layer parameters</p>
                </div>
            </div>
        </div>
        <div class="modal-body">
            <input type="hidden" id="layerModalTower" />
            <input type="hidden" id="layerModalIndex" value="-1" />
            <input type="hidden" id="layerModalMode" value="add" />

            <div class="mb-4" id="layerTypeGroup">
                <label class="block text-sm font-medium text-gray-700 mb-2">Layer Type</label>
                <select id="layerType" class="training-param-input w-full" onchange="updateLayerModalFields()">
                    <option value="dense">Dense</option>
                    <option value="dropout">Dropout</option>
                    <option value="batch_norm">Batch Normalization</option>
                    <option value="layer_norm">Layer Normalization</option>
                </select>
            </div>

            <!-- Dense Layer Fields -->
            <div id="denseFieldsModal">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Units</label>
                    <div class="flex gap-2 flex-wrap items-center justify-center mb-3">
                        <button type="button" class="layer-units-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400" onclick="selectLayerUnits(32)">32</button>
                        <button type="button" class="layer-units-btn px-3 py-2 rounded-lg border transition-all bg-blue-500 text-white border-blue-500" onclick="selectLayerUnits(64)">64</button>
                        <button type="button" class="layer-units-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400" onclick="selectLayerUnits(128)">128</button>
                        <button type="button" class="layer-units-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400" onclick="selectLayerUnits(256)">256</button>
                        <button type="button" class="layer-units-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400" onclick="selectLayerUnits(512)">512</button>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="text-sm text-gray-600">Custom:</span>
                        <input type="number" id="layerUnitsCustom" class="training-param-input" style="width: 100px;" placeholder="e.g. 1024" min="8" max="2048" oninput="onLayerUnitsCustomInput(this.value)" />
                        <span class="text-xs text-gray-400">Range: 8 - 2048</span>
                    </div>
                    <input type="hidden" id="layerUnits" value="64" />
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Activation</label>
                    <select id="layerActivation" class="training-param-input w-full">
                        <option value="relu" selected>ReLU</option>
                        <option value="leaky_relu">Leaky ReLU</option>
                        <option value="elu">ELU</option>
                        <option value="selu">SELU</option>
                        <option value="tanh">Tanh</option>
                        <option value="sigmoid">Sigmoid</option>
                        <option value="swish">Swish</option>
                        <option value="linear">Linear (None)</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Regularization</label>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Type</label>
                            <select id="layerRegType" class="training-param-input w-full" onchange="updateRegStrengthVisibility()">
                                <option value="none">None</option>
                                <option value="l2">L2 (Ridge)</option>
                                <option value="l1">L1 (Lasso)</option>
                            </select>
                        </div>
                        <div id="regStrengthGroup">
                            <label class="block text-xs text-gray-500 mb-1">Strength</label>
                            <input type="number" id="layerRegStrength" class="training-param-input w-full" value="0.001" min="0.0001" max="0.1" step="0.0001" />
                        </div>
                    </div>
                    <p class="text-xs text-gray-400 mt-1">L2 shrinks weights; L1 creates sparsity. Typical: 0.001-0.01</p>
                </div>
            </div>

            <!-- Dropout Layer Fields -->
            <div id="dropoutFieldsModal" class="hidden">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Dropout Rate</label>
                    <input type="number" id="layerDropoutRate" class="training-param-input w-full" value="0.2" min="0.05" max="0.5" step="0.05" />
                    <p class="text-xs text-gray-400 mt-1">Fraction of units to drop. Typical: 0.1-0.3</p>
                </div>
            </div>

            <!-- Batch Norm Fields -->
            <div id="batchNormFieldsModal" class="hidden">
                <p class="text-sm text-gray-500 py-4">Batch Normalization normalizes layer inputs. No configurable parameters needed.</p>
            </div>

            <!-- Layer Norm Fields -->
            <div id="layerNormFieldsModal" class="hidden">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Epsilon</label>
                    <input type="number" id="layerNormEpsilon" class="training-param-input w-full" value="0.000001" min="0.0000001" max="0.001" step="0.0000001" />
                    <p class="text-xs text-gray-400 mt-1">Small constant for numerical stability. Default: 1e-6</p>
                </div>
                <p class="text-sm text-gray-500 py-2">Layer Normalization normalizes across features (not batch). Works well with variable batch sizes and during inference.</p>
            </div>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-save" id="layerModalSubmitBtn" onclick="submitLayerModal()">
                    <span class="btn-neu-inner">Save</span>
                </button>
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeLayerModal()">
                    <span class="btn-neu-inner">Cancel</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Output Layer Edit Modal (edits both towers) -->
<div id="outputLayerModal" class="modal-overlay hidden" onclick="closeOutputLayerModal(event)">
    <div class="modal-container" style="max-width: 480px;" onclick="event.stopPropagation()">
        <div class="modal-header">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                    <i class="fas fa-compress-arrows-alt text-white text-sm"></i>
                </div>
                <div>
                    <h3 class="modal-title">Edit Output Embedding Layer</h3>
                    <p class="text-xs text-gray-500">Changes apply to both Buyer and Product towers</p>
                </div>
            </div>
        </div>
        <div class="modal-body">
            <div class="p-3 mb-4 rounded-lg border border-amber-200" style="background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);">
                <div class="flex items-start gap-2">
                    <i class="fas fa-info-circle text-amber-500 mt-0.5"></i>
                    <p class="text-xs text-amber-700">The output embedding layer defines the final embedding dimension for both towers. Both towers must have matching output dimensions for comparison.</p>
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Embedding Dimension</label>
                <div class="flex gap-2 flex-wrap items-center justify-center mb-3">
                    <button type="button" class="output-dim-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400" onclick="selectOutputDim(8)">8D</button>
                    <button type="button" class="output-dim-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400" onclick="selectOutputDim(16)">16D</button>
                    <button type="button" class="output-dim-btn px-3 py-2 rounded-lg border transition-all bg-blue-500 text-white border-blue-500" onclick="selectOutputDim(32)">32D</button>
                    <button type="button" class="output-dim-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400" onclick="selectOutputDim(64)">64D</button>
                    <button type="button" class="output-dim-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400" onclick="selectOutputDim(128)">128D</button>
                    <button type="button" class="output-dim-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400" onclick="selectOutputDim(256)">256D</button>
                </div>
                <div class="flex items-center gap-3">
                    <span class="text-sm text-gray-600">Custom:</span>
                    <input type="number" id="outputLayerCustomDim" class="training-param-input" style="width: 100px;" placeholder="e.g. 512" min="4" max="1024" oninput="onOutputCustomDimInput(this.value)" />
                    <span class="text-xs text-gray-400">Range: 4 - 1024</span>
                </div>
                <input type="hidden" id="outputLayerUnits" value="32" />
                <p class="text-xs text-gray-400 mt-2"><i class="fas fa-lightbulb text-amber-500 mr-1"></i>Tip: Use larger dimensions (256-512) for millions of unique IDs, smaller (8-32) for few unique values</p>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Activation Function</label>
                <select id="outputLayerActivation" class="training-param-input w-full">
                    <option value="relu" selected>ReLU</option>
                    <option value="leaky_relu">Leaky ReLU</option>
                    <option value="elu">ELU</option>
                    <option value="tanh">Tanh</option>
                    <option value="linear">Linear (None)</option>
                </select>
            </div>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-save" onclick="submitOutputLayer()">
                    <span class="btn-neu-inner">Save</span>
                </button>
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeOutputLayerModal()">
                    <span class="btn-neu-inner">Cancel</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Model Config View Modal -->
<div id="modelConfigViewModal" class="modal-overlay hidden" onclick="closeModelConfigViewModal(event)">
    <div class="modal-container" style="max-width: 750px; max-height: 80vh; display: flex; flex-direction: column;" onclick="event.stopPropagation()">
        <div class="modal-header">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);">
                    <i class="fas fa-layer-group text-white"></i>
                </div>
                <div>
                    <h3 class="modal-title" id="viewMcName">Model Config Name</h3>
                    <p class="text-sm text-gray-500" id="viewMcDesc">Description</p>
                </div>
            </div>
        </div>
        <div class="modal-body" style="overflow-y: auto; flex: 1;">
            <!-- Model Type + Metadata Row -->
            <div class="flex items-center justify-between mb-4">
                <span id="viewMcTypeBadge" class="model-type-badge retrieval">Retrieval</span>
                <div class="text-sm text-gray-500">
                    Updated <span id="viewMcUpdatedAt"></span>
                    <span id="viewMcCreatedByWrapper"> by <span id="viewMcCreatedBy"></span></span>
                </div>
            </div>

            <!-- Tower Architecture -->
            <div class="mb-6">
                <h4 class="text-sm font-medium text-gray-700 mb-3">Tower Architecture</h4>
                <div class="tower-visual tower-visual-aligned">
                    <div class="tower-column">
                        <div class="tower-header">
                            <span class="tower-label">Buyer Tower</span>
                        </div>
                        <div id="viewMcBuyerStack" class="tower-stack buyer">
                            <!-- Layers will be inserted here -->
                        </div>
                        <div class="tower-params-summary view-modal" id="viewMcBuyerParamsSummary">
                            <div class="params-row"><span>Total params:</span><span id="viewMcBuyerTotalParams">0</span></div>
                            <div class="params-row"><span>Trainable params:</span><span id="viewMcBuyerTrainableParams">0</span></div>
                            <div class="params-row"><span>Non-trainable params:</span><span>0</span></div>
                        </div>
                    </div>
                    <div class="tower-column">
                        <div class="tower-header">
                            <span class="tower-label">Product Tower</span>
                        </div>
                        <div id="viewMcProductStack" class="tower-stack product">
                            <!-- Layers will be inserted here -->
                        </div>
                        <div class="tower-params-summary view-modal" id="viewMcProductParamsSummary">
                            <div class="params-row"><span>Total params:</span><span id="viewMcProductTotalParams">0</span></div>
                            <div class="params-row"><span>Trainable params:</span><span id="viewMcProductTrainableParams">0</span></div>
                            <div class="params-row"><span>Non-trainable params:</span><span>0</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Model Summary (hidden - now shown per-tower above) -->
            <div class="model-summary-row mb-6 hidden" id="viewMcSummaryRow">
                <div class="model-summary-item">
                    <span class="model-summary-label">Total params:</span>
                    <span class="model-summary-value" id="viewMcTotalParams">~25K</span>
                </div>
                <div class="model-summary-item">
                    <span class="model-summary-label">Trainable:</span>
                    <span class="model-summary-value" id="viewMcTrainableParams">~25K</span>
                </div>
                <div class="model-summary-item">
                    <span class="model-summary-label">Non-trainable:</span>
                    <span class="model-summary-value" id="viewMcNonTrainableParams">0</span>
                </div>
            </div>

            <!-- Training Parameters -->
            <div class="mb-4">
                <h4 class="text-sm font-medium text-gray-700 mb-3">Training Parameters</h4>
                <div class="training-params-preview" id="viewMcParams">
                    <!-- Will be populated dynamically -->
                </div>
            </div>

            <!-- Retrieval Algorithm (for retrieval models) -->
            <div id="viewMcRetrievalSection" class="mb-4 hidden">
                <h4 class="text-sm font-medium text-gray-700 mb-3">Retrieval Algorithm</h4>
                <div class="training-params-preview" id="viewMcRetrievalParams">
                    <!-- Will be populated dynamically -->
                </div>
            </div>

            <!-- Rating Head (for ranking and multitask models) -->
            <div id="viewMcRatingHeadSection" class="mb-6 hidden">
                <h4 class="text-sm font-medium text-gray-700 mb-3">Rating Head</h4>
                <div class="tower-visual">
                    <div class="tower-column ranking">
                        <div class="tower-header ranking">
                            <span class="tower-label">Ranking Tower</span>
                        </div>
                        <div id="viewMcRatingHeadStack" class="tower-stack ranking">
                            <!-- Layers will be inserted here -->
                        </div>
                        <div class="tower-params-summary view-modal" id="viewMcRatingHeadParamsSummary">
                            <div class="params-row"><span>Total params:</span><span id="viewMcRatingHeadTotalParams">0</span></div>
                            <div class="params-row"><span>Trainable params:</span><span id="viewMcRatingHeadTrainableParams">0</span></div>
                            <div class="params-row"><span>Non-trainable params:</span><span>0</span></div>
                        </div>
                    </div>
                </div>
                <div class="training-params-preview mt-3" id="viewMcLossParams">
                    <!-- Will be populated dynamically -->
                </div>
            </div>

            <!-- Multitask Weights (for multitask models) -->
            <div id="viewMcMultitaskSection" class="mb-4 hidden">
                <h4 class="text-sm font-medium text-gray-700 mb-3">Multitask Weights</h4>
                <div class="training-params-preview" id="viewMcMultitaskParams">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeModelConfigViewModal()">
                    <span class="btn-neu-inner">Close</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Clone Model Config Modal -->
<div id="cloneModelConfigModal" class="modal-overlay hidden">
    <div class="modal-container" style="max-width: 450px;">
        <div class="modal-header">
            <div class="modal-header-icon info">
                <i class="fas fa-copy"></i>
            </div>
            <h3 class="modal-header-title">Clone Model Config</h3>
        </div>
        <div class="modal-body">
            <div class="mb-4">
                <label for="cloneModelConfigName" class="block text-sm font-medium text-gray-700 mb-2">
                    New config name
                </label>
                <input type="text" id="cloneModelConfigName"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                       placeholder="Enter name for cloned config">
            </div>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-save" onclick="submitModelConfigClone()">
                    <span class="btn-neu-inner">Clone</span>
                </button>
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeModelConfigCloneModal()">
                    <span class="btn-neu-inner">Cancel</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Compare Model Configs Modal -->
<div id="compareModelConfigsModal" class="modal-overlay hidden">
    <div class="modal-container" style="max-width: 1000px;">
        <div class="modal-header">
            <div class="modal-header-icon info">
                <i class="fas fa-columns"></i>
            </div>
            <h3 class="modal-header-title">Compare Model Configs</h3>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <!-- Dropdowns row -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Left Model Config</label>
                    <select id="mcCompareLeftSelect" onchange="mc_onCompareSelectChange('left')"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select model config...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Right Model Config</label>
                    <select id="mcCompareRightSelect" onchange="mc_onCompareSelectChange('right')"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select model config...</option>
                    </select>
                </div>
            </div>

            <!-- Comparison content - accordion layout -->
            <div id="mcCompareAccordions" class="ds-compare-accordions">
                <!-- Accordion 1: Basic Info -->
                <div class="filter-subchapter ds-compare-section" id="mcCompareBasicInfoSection">
                    <div class="subchapter-header-tablet" onclick="mc_toggleCompareSection('basicInfo')">
                        <span class="subchapter-title"><i class="fas fa-info-circle mr-2 text-blue-500"></i>Basic Info</span>
                        <span class="subchapter-filter-status" id="mcCompareBasicInfoStatus"></span>
                        <i id="mcCompareBasicInfoChevron" class="fas fa-chevron-right subchapter-chevron"></i>
                    </div>
                    <div id="mcCompareBasicInfoContent" class="subchapter-content-outside hidden">
                        <div class="ds-compare-grid">
                            <div id="mcCompareLeftBasicInfo" class="ds-compare-cell">
                                <div class="ds-compare-placeholder">Select a model config</div>
                            </div>
                            <div id="mcCompareRightBasicInfo" class="ds-compare-cell">
                                <div class="ds-compare-placeholder">Select a model config</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Accordion 2: Buyer Tower -->
                <div class="filter-subchapter ds-compare-section" id="mcCompareBuyerSection">
                    <div class="subchapter-header-tablet" onclick="mc_toggleCompareSection('buyer')">
                        <span class="subchapter-title"><i class="fas fa-user mr-2 text-blue-500"></i>Buyer Tower</span>
                        <span class="subchapter-filter-status" id="mcCompareBuyerStatus"></span>
                        <i id="mcCompareBuyerChevron" class="fas fa-chevron-right subchapter-chevron"></i>
                    </div>
                    <div id="mcCompareBuyerContent" class="subchapter-content-outside hidden">
                        <div class="ds-compare-grid">
                            <div id="mcCompareLeftBuyer" class="ds-compare-cell">
                                <div class="ds-compare-placeholder">Select a model config</div>
                            </div>
                            <div id="mcCompareRightBuyer" class="ds-compare-cell">
                                <div class="ds-compare-placeholder">Select a model config</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Accordion 3: Product Tower -->
                <div class="filter-subchapter ds-compare-section" id="mcCompareProductSection">
                    <div class="subchapter-header-tablet" onclick="mc_toggleCompareSection('product')">
                        <span class="subchapter-title"><i class="fas fa-box mr-2 text-green-500"></i>Product Tower</span>
                        <span class="subchapter-filter-status" id="mcCompareProductStatus"></span>
                        <i id="mcCompareProductChevron" class="fas fa-chevron-right subchapter-chevron"></i>
                    </div>
                    <div id="mcCompareProductContent" class="subchapter-content-outside hidden">
                        <div class="ds-compare-grid">
                            <div id="mcCompareLeftProduct" class="ds-compare-cell">
                                <div class="ds-compare-placeholder">Select a model config</div>
                            </div>
                            <div id="mcCompareRightProduct" class="ds-compare-cell">
                                <div class="ds-compare-placeholder">Select a model config</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Accordion 4: Rating Head (for Ranking/Multitask models) -->
                <div class="filter-subchapter ds-compare-section hidden" id="mcCompareRatingHeadSection">
                    <div class="subchapter-header-tablet" onclick="mc_toggleCompareSection('ratingHead')">
                        <span class="subchapter-title"><i class="fas fa-star mr-2 text-purple-500"></i>Rating Head</span>
                        <span class="subchapter-filter-status" id="mcCompareRatingHeadStatus"></span>
                        <i id="mcCompareRatingHeadChevron" class="fas fa-chevron-right subchapter-chevron"></i>
                    </div>
                    <div id="mcCompareRatingHeadContent" class="subchapter-content-outside hidden">
                        <div class="ds-compare-grid">
                            <div id="mcCompareLeftRatingHead" class="ds-compare-cell">
                                <div class="ds-compare-placeholder">Select a model config</div>
                            </div>
                            <div id="mcCompareRightRatingHead" class="ds-compare-cell">
                                <div class="ds-compare-placeholder">Select a model config</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Accordion 5: Training Settings -->
                <div class="filter-subchapter ds-compare-section" id="mcCompareSettingsSection">
                    <div class="subchapter-header-tablet" onclick="mc_toggleCompareSection('settings')">
                        <span class="subchapter-title"><i class="fas fa-cog mr-2 text-orange-500"></i>Training Settings</span>
                        <span class="subchapter-filter-status" id="mcCompareSettingsStatus"></span>
                        <i id="mcCompareSettingsChevron" class="fas fa-chevron-right subchapter-chevron"></i>
                    </div>
                    <div id="mcCompareSettingsContent" class="subchapter-content-outside hidden">
                        <div class="ds-compare-grid">
                            <div id="mcCompareLeftSettings" class="ds-compare-cell">
                                <div class="ds-compare-placeholder">Select a model config</div>
                            </div>
                            <div id="mcCompareRightSettings" class="ds-compare-cell">
                                <div class="ds-compare-placeholder">Select a model config</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="mc_closeCompareModal()">
                    <span class="btn-neu-inner">Close</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Feature Config Wizard Modal -->
<div id="featureConfigWizardModal" class="modal-overlay hidden">
    <div class="modal-container modal-container-wizard" style="max-width: 1100px;">
        <!-- Modal Header -->
        <div class="modal-header-wizard">
            <div class="modal-header-content">
                <div class="modal-header-icon info">
                    <i class="fas fa-cogs text-lg"></i>
                </div>
                <div class="modal-header-info">
                    <h3 class="modal-header-title" id="wizardTitle">Create Feature Config</h3>
                    <p class="modal-step-counter">Step <span id="currentStep">1</span> of 2</p>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress-bar-pills">
                <div id="progress1" class="progress-step-pill current">Basic Info</div>
                <div id="progress2" class="progress-step-pill future">Features</div>
            </div>
        </div>

        <!-- Modal Body -->
        <div class="modal-body-wizard" style="max-height: calc(90vh - 200px); overflow-y: auto; position: relative;">
            <!-- Loading overlay for wizard (covers modal body) -->
            <div id="wizardLoadingOverlay" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.9); z-index: 100;">
                <div style="position: sticky; top: 50%; transform: translateY(-50%); display: flex; align-items: center; justify-content: center; gap: 12px;">
                    <i class="fas fa-spinner fa-spin text-2xl text-blue-500"></i>
                    <span class="text-gray-600" id="wizardLoadingText">Loading...</span>
                </div>
            </div>

            <!-- Step 1: Basic Info -->
            <div id="wizardStep1" class="wizard-step active">
                <h4 class="wizard-section-title">Basic Information</h4>

                <!-- Config Name -->
                <div class="wizard-field-group">
                    <label class="wizard-field-label">Config Name <span class="required">*</span></label>
                    <div class="relative">
                        <input type="text" id="configName" placeholder="e.g., Rich Features v1"
                               class="form-input w-full" oninput="debounceConfigNameCheck()" onblur="checkConfigNameAvailability()">
                        <div id="configNameStatus" class="absolute right-3 top-1/2 -translate-y-1/2 hidden">
                            <i id="configNameSpinner" class="fas fa-spinner fa-spin text-gray-400 hidden"></i>
                            <i id="configNameValid" class="fas fa-check-circle text-green-500 hidden"></i>
                            <i id="configNameInvalid" class="fas fa-times-circle text-red-500 hidden"></i>
                        </div>
                    </div>
                    <p id="nameError" class="text-xs text-red-600 mt-1 hidden"></p>
                </div>

                <!-- Description -->
                <div class="wizard-field-group">
                    <label class="wizard-field-label">Description <span class="optional">(optional)</span></label>
                    <textarea id="configDescription" placeholder="Describe the purpose of this feature configuration..."
                              class="form-textarea w-full" rows="2"></textarea>
                </div>

                <!-- Dataset Selection -->
                <div class="wizard-field-group">
                    <label class="wizard-field-label">Base Dataset <span class="required">*</span></label>
                    <select id="configDataset" class="form-select w-full" onchange="onDatasetChange()">
                        <option value="">Select a dataset...</option>
                    </select>
                    <div id="datasetInfo" class="text-xs text-gray-500 mt-2 hidden">
                        <span id="datasetInfoText"></span>
                    </div>
                </div>

                <!-- Start From Options -->
                <div class="wizard-field-group">
                    <label class="wizard-field-label">Start From</label>
                    <div class="wizard-tab-group" style="display: flex; gap: 0.5rem; width: 100%; margin-top: 8px;">
                        <button type="button" onclick="selectStartFrom('blank')" id="startFromBlank" class="wizard-tab active" style="flex: 1; text-align: center;">
                            Blank
                        </button>
                        <button type="button" onclick="selectStartFrom('clone')" id="startFromClone" class="wizard-tab" style="flex: 1; text-align: center;">
                            Clone Existing
                        </button>
                    </div>
                    <input type="hidden" name="startFrom" id="startFromValue" value="blank">
                </div>

                <!-- Clone Selection (hidden by default) -->
                <div id="cloneSelection" class="wizard-field-group hidden">
                    <label class="wizard-field-label">Clone From</label>
                    <select id="cloneFromConfig" class="form-select w-full">
                        <option value="">Select a config to clone...</option>
                    </select>
                </div>

                <div class="wizard-info-box info">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>What is a Feature Config?</strong><br>
                        A feature config defines how dataset columns are transformed into tensors for the two-tower model (BuyerModel and ProductModel).
                    </div>
                </div>
            </div>

            <!-- Step 2: Feature Assignment -->
            <div id="wizardStep2" class="wizard-step hidden" style="position: relative;">
                <!-- Dataset Sample - Collapsible Tablet -->
                <div class="filter-subchapter" id="datasetSampleSubchapter">
                    <div class="subchapter-header-tablet" onclick="toggleModelingSubchapter('datasetSample')">
                        <span class="subchapter-title">Dataset Sample</span>
                        <span class="subchapter-filter-status" id="datasetSampleStatus"></span>
                        <i id="datasetSampleChevron" class="fas fa-chevron-right subchapter-chevron"></i>
                    </div>
                    <div id="datasetSampleContent" class="subchapter-content-outside hidden">
                        <div id="sampleDataTable" class="sample-table-container">
                            <!-- Table will be rendered here -->
                        </div>
                    </div>
                </div>

                <!-- Available Columns - Collapsible Tablet -->
                <div class="filter-subchapter" id="availableColumnsSubchapter">
                    <div class="subchapter-header-tablet" onclick="toggleModelingSubchapter('availableColumns')">
                        <span class="subchapter-title">Available Columns</span>
                        <span class="subchapter-filter-status" id="availableColumnsStatus"></span>
                        <i id="availableColumnsChevron" class="fas fa-chevron-down subchapter-chevron"></i>
                    </div>
                    <div id="availableColumnsContent" class="subchapter-content-outside">
                        <p class="text-xs text-gray-500 mb-2">Drag columns to BuyerModel or ProductModel</p>
                        <div id="availableColumns" class="grid grid-cols-4 gap-2" style="max-height: 180px; overflow-y: auto;">
                            <!-- Column cards will be inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Model Drop Zones -->
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <!-- Buyer Model -->
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                            <span class="w-3 h-3 rounded-full bg-blue-500"></span>
                            <h5 class="font-semibold text-gray-800">BuyerModel (Query Tower)</h5>
                        </div>

                        <!-- Primary ID Zone: Customer ID -->
                        <div id="customerIdZone" class="primary-id-zone buyer"
                             ondrop="dropPrimaryId(event, 'buyer')"
                             ondragover="allowDrop(event)"
                             ondragenter="dragEnterPrimaryId(event)"
                             ondragleave="dragLeavePrimaryId(event)">
                            <div class="primary-id-zone-header">
                                <div class="primary-id-zone-icon">
                                    <i class="fas fa-key"></i>
                                </div>
                                <span class="primary-id-zone-title">Customer ID</span>
                                <span class="primary-id-zone-required">Required</span>
                            </div>
                            <div id="customerIdContent">
                                <!-- Will be rendered by JS: empty state or assigned feature -->
                            </div>
                        </div>

                        <!-- Context Features Section -->
                        <div id="buyerAdditionalSection" class="additional-features-section buyer locked"
                             ondrop="dropFeature(event, 'buyer')"
                             ondragover="allowDropIfUnlocked(event, 'buyer')"
                             ondragenter="dragEnterIfUnlocked(event, 'buyer')"
                             ondragleave="dragLeave(event)">
                            <div class="additional-features-header">
                                <i class="fas fa-layer-group"></i>
                                <span>Context Features</span>
                            </div>
                            <div id="buyerLockedMessage" class="locked-message">
                                <i class="fas fa-lock"></i>
                                <span>Assign Customer ID first to add more features</span>
                            </div>
                            <div id="buyerModelFeatures"></div>
                            <div id="buyerModelCrosses" class="mt-3"></div>
                            <button type="button" class="btn btn-secondary btn-xs mt-2" onclick="openCrossModal('buyer')" id="addBuyerCrossBtn" style="display: none;">
                                <i class="fas fa-plus mr-1"></i>Add Cross Feature
                            </button>
                        </div>
                    </div>

                    <!-- Product Model -->
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                            <span class="w-3 h-3 rounded-full bg-green-500"></span>
                            <h5 class="font-semibold text-gray-800">ProductModel (Candidate Tower)</h5>
                        </div>

                        <!-- Primary ID Zone: Product ID -->
                        <div id="productIdZone" class="primary-id-zone product"
                             ondrop="dropPrimaryId(event, 'product')"
                             ondragover="allowDrop(event)"
                             ondragenter="dragEnterPrimaryId(event)"
                             ondragleave="dragLeavePrimaryId(event)">
                            <div class="primary-id-zone-header">
                                <div class="primary-id-zone-icon">
                                    <i class="fas fa-key"></i>
                                </div>
                                <span class="primary-id-zone-title">Product ID</span>
                                <span class="primary-id-zone-required">Required</span>
                            </div>
                            <div id="productIdContent">
                                <!-- Will be rendered by JS: empty state or assigned feature -->
                            </div>
                        </div>

                        <!-- Context Features Section -->
                        <div id="productAdditionalSection" class="additional-features-section product locked"
                             ondrop="dropFeature(event, 'product')"
                             ondragover="allowDropIfUnlocked(event, 'product')"
                             ondragenter="dragEnterIfUnlocked(event, 'product')"
                             ondragleave="dragLeave(event)">
                            <div class="additional-features-header">
                                <i class="fas fa-layer-group"></i>
                                <span>Context Features</span>
                            </div>
                            <div id="productLockedMessage" class="locked-message">
                                <i class="fas fa-lock"></i>
                                <span>Assign Product ID first to add more features</span>
                            </div>
                            <div id="productModelFeatures"></div>
                            <div id="productModelCrosses" class="mt-3"></div>
                            <button type="button" class="btn btn-secondary btn-xs mt-2" onclick="openCrossModal('product')" id="addProductCrossBtn" style="display: none;">
                                <i class="fas fa-plus mr-1"></i>Add Cross Feature
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tensor Preview -->
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <div class="tensor-preview-panel">
                        <div class="tensor-preview-header">
                            <span class="tensor-preview-title">Buyer Tensor</span>
                            <span id="buyerTensorTotal" class="tensor-preview-total buyer">0D</span>
                        </div>
                        <div id="buyerTensorBar" class="tensor-breakdown-bar"></div>
                        <div id="buyerTensorBreakdown" class="tensor-breakdown"></div>
                    </div>
                    <div class="tensor-preview-panel">
                        <div class="tensor-preview-header">
                            <span class="tensor-preview-title">Product Tensor</span>
                            <span id="productTensorTotal" class="tensor-preview-total product">0D</span>
                        </div>
                        <div id="productTensorBar" class="tensor-breakdown-bar"></div>
                        <div id="productTensorBreakdown" class="tensor-breakdown"></div>
                    </div>
                </div>

                <!-- Target Column Zone (for Ranking models) -->
                <div class="target-column-section mt-4">
                    <div class="target-column-header">
                        <i class="fas fa-bullseye" style="color: #f59e0b;"></i>
                        <h5>Target Column</h5>
                        <span class="target-column-badge">For Ranking Models</span>
                    </div>

                    <div id="targetColumnZone" class="target-column-zone"
                         ondrop="dropTargetColumn(event)"
                         ondragover="allowDrop(event)"
                         ondragenter="dragEnterTarget(event)"
                         ondragleave="dragLeaveTarget(event)">
                        <div id="targetColumnPlaceholder" class="placeholder-text">
                            <p><i class="fas fa-arrow-down mr-1"></i>Drop a numeric column here to use as prediction target</p>
                            <small>e.g., rating, sales, quantity, price  will be excluded from Buyer/Product models</small>
                        </div>
                        <div id="targetColumnContent" style="display: none;">
                            <!-- Filled when column is dropped -->
                        </div>
                    </div>

                    <!-- Target Column Configuration (appears when column is set) -->
                    <div id="targetColumnConfig" class="target-column-config" style="display: none;">
                        <h6><i class="fas fa-sliders-h mr-1"></i>Target Transforms (Optional)</h6>

                        <!-- Normalize -->
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="targetNormalize" onchange="updateTargetTransforms()">
                            <label class="form-check-label" for="targetNormalize">
                                Normalize to 0-1 range <small>(recommended for ratings)</small>
                            </label>
                        </div>

                        <!-- Log Transform -->
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="targetLogTransform" onchange="updateTargetTransforms()">
                            <label class="form-check-label" for="targetLogTransform">
                                Log transform <small>(for skewed distributions like revenue)</small>
                            </label>
                        </div>

                        <!-- Clip Outliers -->
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="targetClipOutliers" onchange="toggleClipOptions()">
                            <label class="form-check-label" for="targetClipOutliers">
                                Clip outliers
                            </label>
                        </div>

                        <!-- Clip Options (shown when clip is enabled) -->
                        <div id="clipOutliersOptions" class="clip-options-container" style="display: none;">
                            <!-- Lower Bound -->
                            <div class="clip-bound-row">
                                <div class="form-check form-check-inline clip-bound-check">
                                    <input type="checkbox" class="form-check-input" id="clipLowerEnabled" onchange="updateTargetTransforms()">
                                    <label class="form-check-label" for="clipLowerEnabled">Lower bound</label>
                                </div>
                                <select id="clipLowerPercentile" class="form-select form-select-sm clip-percentile-select" onchange="updateTargetTransforms()">
                                    <option value="1">1st</option>
                                    <option value="5">5th</option>
                                    <option value="10">10th</option>
                                </select>
                                <span class="clip-percentile-label">percentile</span>
                            </div>

                            <!-- Upper Bound -->
                            <div class="clip-bound-row">
                                <div class="form-check form-check-inline clip-bound-check">
                                    <input type="checkbox" class="form-check-input" id="clipUpperEnabled" onchange="updateTargetTransforms()" checked>
                                    <label class="form-check-label" for="clipUpperEnabled">Upper bound</label>
                                </div>
                                <select id="clipUpperPercentile" class="form-select form-select-sm clip-percentile-select" onchange="updateTargetTransforms()">
                                    <option value="75">75th</option>
                                    <option value="80">80th</option>
                                    <option value="90">90th</option>
                                    <option value="95">95th</option>
                                    <option value="99" selected>99th</option>
                                    <option value="99.9">99.9th</option>
                                </select>
                                <span class="clip-percentile-label">percentile</span>
                            </div>

                            <!-- Info text -->
                            <div class="clip-info-text">
                                <i class="fas fa-info-circle"></i>
                                Clipping caps extreme values at the selected percentiles. Values outside the range are set to the boundary value (not removed from training).
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="modal-footer-wizard-neu">
            <div class="footer-left">
                <button type="button" id="backBtn" class="btn-neu btn-neu-nav hidden" onclick="fc_prevStep()">
                    <span class="btn-neu-inner"><i class="fas fa-chevron-left"></i></span>
                </button>
                <button type="button" id="nextBtn" class="btn-neu btn-neu-nav" onclick="fc_nextStep()">
                    <span class="btn-neu-inner"><i class="fas fa-chevron-right"></i></span>
                </button>
            </div>
            <div class="footer-right">
                <button type="button" id="saveBtn" class="btn-neu btn-neu-action btn-neu-save hidden" onclick="saveConfig()">
                    <span class="btn-neu-inner">Save</span>
                </button>
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="fc_closeWizard()">
                    <span class="btn-neu-inner">Cancel</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Feature Configuration Modal -->
<div id="featureConfigModal" class="modal-overlay hidden">
    <div class="modal-container" style="max-width: 500px;">
        <div class="modal-header">
            <div class="modal-header-icon info">
                <i class="fas fa-cog"></i>
            </div>
            <h3 class="modal-header-title" id="featureModalTitle">Configure Feature</h3>
            <button type="button" class="modal-close-btn" onclick="closeFeatureModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" id="featureModalBody">
            <!-- Content will be dynamically generated -->
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-save" onclick="applyFeatureConfig()">
                    <span class="btn-neu-inner">Apply</span>
                </button>
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeFeatureModal()">
                    <span class="btn-neu-inner">Cancel</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Cross Feature Modal -->
<div id="crossFeatureModal" class="modal-overlay hidden">
    <div class="modal-container" style="max-width: 550px; max-height: 85vh; display: flex; flex-direction: column;">
        <div class="modal-header">
            <div class="modal-header-icon info">
                <i class="fas fa-times"></i>
            </div>
            <h3 class="modal-header-title">Add Cross Feature</h3>
        </div>
        <div class="modal-body" style="overflow-y: auto; flex: 1;">
            <div class="modal-form-group">
                <label class="modal-form-label">Select 2-3 features to cross</label>
                <div id="crossFeatureOptions" class="space-y-2">
                    <!-- Feature checkboxes will be inserted here -->
                </div>
            </div>
            <div id="crossPreview" class="text-sm text-gray-600 mt-3 hidden">
                Selected: <span id="crossPreviewText" class="font-medium"></span>
            </div>
            <!-- Bucketization options for numeric/temporal features -->
            <div id="crossBucketOptions" class="mt-4 hidden">
                <div class="text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-info-circle text-blue-500 mr-1"></i>
                    Numeric/temporal features need bucketization for crossing
                </div>
                <div id="crossBucketInputs" class="space-y-3">
                    <!-- Bucket inputs for each numeric/temporal feature will be inserted here -->
                </div>
            </div>
            <div class="modal-form-group mt-4">
                <label class="modal-form-label">Hash Bucket Size</label>
                <select id="crossHashBuckets" class="form-select w-full">
                    <option value="1000">1,000</option>
                    <option value="5000" selected>5,000</option>
                    <option value="10000">10,000</option>
                    <option value="50000">50,000</option>
                </select>
                <p class="modal-form-hint">Number of hash buckets for the crossed features</p>
            </div>
            <div class="modal-form-group">
                <label class="modal-form-label">Embedding Dimension</label>
                <select id="crossEmbedDim" class="form-select w-full">
                    <option value="8">8</option>
                    <option value="16" selected>16</option>
                    <option value="32">32</option>
                </select>
            </div>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-save" onclick="addCrossFeature()">
                    <span class="btn-neu-inner">Ok</span>
                </button>
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeCrossModal()">
                    <span class="btn-neu-inner">Cancel</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View Config Modal -->
<div id="viewConfigModal" class="modal-overlay hidden">
    <div class="modal-container" style="max-width: 880px;">
        <div class="modal-header">
            <div class="modal-header-icon info">
                <i class="fas fa-eye"></i>
            </div>
            <h3 class="modal-header-title" id="viewConfigTitle">Feature Config Details</h3>
        </div>
        <div class="modal-body" id="viewConfigBody" style="max-height: 70vh; overflow-y: auto;">
            <!-- Content will be dynamically generated -->
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeViewModal()">
                    <span class="btn-neu-inner">Close</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Clone Config Modal -->
<div id="cloneConfigModal" class="modal-overlay hidden">
    <div class="modal-container" style="max-width: 450px;">
        <div class="modal-header">
            <div class="modal-header-icon info">
                <i class="fas fa-copy"></i>
            </div>
            <h3 class="modal-header-title">Clone Feature Config</h3>
        </div>
        <div class="modal-body">
            <div class="mb-4">
                <label for="cloneConfigName" class="block text-sm font-medium text-gray-700 mb-2">
                    New config name
                </label>
                <input type="text" id="cloneConfigName"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                       placeholder="Enter name for cloned config">
            </div>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-save" onclick="submitClone()">
                    <span class="btn-neu-inner">Clone</span>
                </button>
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeCloneModal()">
                    <span class="btn-neu-inner">Cancel</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Compare Feature Sets Modal -->
<div id="compareModal" class="modal-overlay hidden">
    <div class="modal-container" style="max-width: 1000px;">
        <div class="modal-header">
            <div class="modal-header-icon info">
                <i class="fas fa-columns"></i>
            </div>
            <h3 class="modal-header-title">Compare Feature Sets</h3>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <!-- Dropdowns row -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Left Feature Set</label>
                    <select id="compareLeftSelect" onchange="fc_onCompareSelectChange('left')"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select feature set...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Right Feature Set</label>
                    <select id="compareRightSelect" onchange="fc_onCompareSelectChange('right')"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select feature set...</option>
                    </select>
                </div>
            </div>

            <!-- Comparison content - accordion layout -->
            <div id="fcCompareAccordions" class="ds-compare-accordions">
                <!-- Accordion 1: Basic Info -->
                <div class="filter-subchapter ds-compare-section" id="fcCompareBasicInfoSection">
                    <div class="subchapter-header-tablet" onclick="fc_toggleCompareSection('basicInfo')">
                        <span class="subchapter-title"><i class="fas fa-info-circle mr-2 text-blue-500"></i>Basic Info</span>
                        <span class="subchapter-filter-status" id="fcCompareBasicInfoStatus"></span>
                        <i id="fcCompareBasicInfoChevron" class="fas fa-chevron-right subchapter-chevron"></i>
                    </div>
                    <div id="fcCompareBasicInfoContent" class="subchapter-content-outside hidden">
                        <div class="ds-compare-grid">
                            <div id="fcCompareLeftBasicInfo" class="ds-compare-cell">
                                <div class="ds-compare-placeholder">Select a feature set</div>
                            </div>
                            <div id="fcCompareRightBasicInfo" class="ds-compare-cell">
                                <div class="ds-compare-placeholder">Select a feature set</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Accordion 2: Source (Dataset Info) -->
                <div class="filter-subchapter ds-compare-section" id="fcCompareSourceSection">
                    <div class="subchapter-header-tablet" onclick="fc_toggleCompareSection('source')">
                        <span class="subchapter-title"><i class="fas fa-database mr-2 text-purple-500"></i>Source</span>
                        <span class="subchapter-filter-status" id="fcCompareSourceStatus"></span>
                        <i id="fcCompareSourceChevron" class="fas fa-chevron-right subchapter-chevron"></i>
                    </div>
                    <div id="fcCompareSourceContent" class="subchapter-content-outside hidden">
                        <div class="ds-compare-grid">
                            <div id="fcCompareLeftSource" class="ds-compare-cell">
                                <div class="ds-compare-placeholder">Select a feature set</div>
                            </div>
                            <div id="fcCompareRightSource" class="ds-compare-cell">
                                <div class="ds-compare-placeholder">Select a feature set</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Accordion 3: Buyer Tensor -->
                <div class="filter-subchapter ds-compare-section" id="fcCompareBuyerSection">
                    <div class="subchapter-header-tablet" onclick="fc_toggleCompareSection('buyer')">
                        <span class="subchapter-title"><i class="fas fa-user mr-2 text-blue-500"></i>Buyer Tensor</span>
                        <span class="subchapter-filter-status" id="fcCompareBuyerStatus"></span>
                        <i id="fcCompareBuyerChevron" class="fas fa-chevron-right subchapter-chevron"></i>
                    </div>
                    <div id="fcCompareBuyerContent" class="subchapter-content-outside hidden">
                        <div class="ds-compare-grid">
                            <div id="fcCompareLeftBuyer" class="ds-compare-cell">
                                <div class="ds-compare-placeholder">Select a feature set</div>
                            </div>
                            <div id="fcCompareRightBuyer" class="ds-compare-cell">
                                <div class="ds-compare-placeholder">Select a feature set</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Accordion 4: Product Tensor -->
                <div class="filter-subchapter ds-compare-section" id="fcCompareProductSection">
                    <div class="subchapter-header-tablet" onclick="fc_toggleCompareSection('product')">
                        <span class="subchapter-title"><i class="fas fa-box mr-2 text-green-500"></i>Product Tensor</span>
                        <span class="subchapter-filter-status" id="fcCompareProductStatus"></span>
                        <i id="fcCompareProductChevron" class="fas fa-chevron-right subchapter-chevron"></i>
                    </div>
                    <div id="fcCompareProductContent" class="subchapter-content-outside hidden">
                        <div class="ds-compare-grid">
                            <div id="fcCompareLeftProduct" class="ds-compare-cell">
                                <div class="ds-compare-placeholder">Select a feature set</div>
                            </div>
                            <div id="fcCompareRightProduct" class="ds-compare-cell">
                                <div class="ds-compare-placeholder">Select a feature set</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="fc_closeCompareModal()">
                    <span class="btn-neu-inner">Close</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Transform Code Viewer Modal -->
<div id="transformCodeViewerModal" class="modal-overlay hidden">
    <div class="modal-container" style="max-width: 900px;">
        <div class="modal-header">
            <div class="modal-header-icon info">
                <i class="fas fa-random"></i>
            </div>
            <h3 class="modal-header-title">Transform Code</h3>
            <button type="button" class="modal-close-btn" onclick="closeTransformCodeViewer()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" style="max-height: 75vh; overflow-y: auto;">
            <!-- Meta info -->
            <div class="code-meta">
                <div class="code-meta-item">
                    <i class="fas fa-clock"></i>
                    <span id="transformCodeGeneratedAt">-</span>
                </div>
                <div class="code-meta-item">
                    <i class="fas fa-sync-alt"></i>
                    <button onclick="regenerateTransformCode()" class="text-blue-600 hover:text-blue-800 font-medium">
                        Regenerate
                    </button>
                </div>
            </div>

            <!-- Transform Code Content -->
            <div id="transformValidationError" class="validation-error-banner" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                <div class="error-text">
                    <span id="transformErrorMsg"></span>
                    <span id="transformErrorLine" class="error-line"></span>
                </div>
            </div>
            <div class="code-container">
                <div class="code-header">
                    <span class="code-filename">preprocessing_fn.py</span>
                    <span id="transformValidationBadge" class="validation-badge checking">
                        <i class="fas fa-spinner fa-spin"></i> Checking
                    </span>
                    <span class="tab-badge" id="transformLineCount">-</span>
                    <div class="code-actions">
                        <button class="code-action-btn" onclick="copyCode('transform')" id="copyTransformBtn">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                        <button class="code-action-btn" onclick="downloadCode('transform')">
                            <i class="fas fa-download"></i> Download
                        </button>
                    </div>
                </div>
                <div class="code-block">
                    <pre id="transformCode"></pre>
                </div>
            </div>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left">
                <span class="text-sm text-gray-500" id="transformCodeConfigName"></span>
            </div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeTransformCodeViewer()">
                    <span class="btn-neu-inner">Close</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Trainer Code Viewer Modal -->
<div id="trainerCodeViewerModal" class="modal-overlay hidden">
    <div class="modal-container" style="max-width: 900px;">
        <div class="modal-header">
            <div class="modal-header-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);">
                <i class="fas fa-brain"></i>
            </div>
            <h3 class="modal-header-title">Trainer Code</h3>
            <button type="button" class="modal-close-btn" onclick="closeTrainerCodeViewer()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" style="max-height: 75vh; overflow-y: auto;">
            <!-- Meta info -->
            <div class="code-meta">
                <div class="code-meta-item">
                    <i class="fas fa-clock"></i>
                    <span id="trainerCodeGeneratedAt">-</span>
                </div>
                <div class="code-meta-item">
                    <i class="fas fa-sync-alt"></i>
                    <button onclick="regenerateTrainerCode()" class="text-blue-600 hover:text-blue-800 font-medium">
                        Regenerate
                    </button>
                </div>
            </div>

            <!-- Trainer Code Content -->
            <div id="trainerValidationError" class="validation-error-banner" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                <div class="error-text">
                    <span id="trainerErrorMsg"></span>
                    <span id="trainerErrorLine" class="error-line"></span>
                </div>
            </div>
            <div class="code-container">
                <div class="code-header">
                    <span class="code-filename">trainer_module.py</span>
                    <span id="trainerValidationBadge" class="validation-badge checking">
                        <i class="fas fa-spinner fa-spin"></i> Checking
                    </span>
                    <span class="tab-badge" id="trainerLineCount">-</span>
                    <div class="code-actions">
                        <button class="code-action-btn" onclick="copyCode('trainer')" id="copyTrainerBtn">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                        <button class="code-action-btn" onclick="downloadCode('trainer')">
                            <i class="fas fa-download"></i> Download
                        </button>
                    </div>
                </div>
                <div class="code-block">
                    <pre id="trainerCode"></pre>
                </div>
            </div>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left">
                <span class="text-sm text-gray-500" id="trainerCodeConfigName"></span>
            </div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeTrainerCodeViewer()">
                    <span class="btn-neu-inner">Close</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- D3.js for charts (used in dataset filter modals) -->
<script src="https://d3js.org/d3.v7.min.js"></script>

<script>
const modelId = {{ model.id }};
let allConfigs = [];
let allDatasets = [];
let currentStep = 1;
let editingConfigId = null;
let searchTimeout = null;
let isLoadingConfigForEdit = false;
let configNameCheckTimeout = null;
let configNameIsValid = false;

// Current feature config state
let configState = {
    name: '',
    description: '',
    datasetId: null,
    startFrom: 'blank',
    cloneFromId: null,
    // Primary ID features (required before adding other features)
    customerIdFeature: null,  // Primary ID for BuyerModel
    productIdFeature: null,   // Primary ID for ProductModel
    // Additional features (unlocked after primary ID is set)
    buyerFeatures: [],
    productFeatures: [],
    buyerCrosses: [],
    productCrosses: [],
    availableColumns: [],
    sampleRows: [],
    columnOrder: [],
    // Target column for ranking models
    targetColumn: null
};

// Currently editing feature
let editingFeature = null;
let editingFeatureModel = null;
let crossFeatureModel = null;

// =============================================================================
// CSRF TOKEN HELPER
// =============================================================================

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// =============================================================================
// DATASETS CHAPTER - State Variables
// =============================================================================

let ds_allDatasets = [];
let ds_searchTimeout = null;
let ds_currentPage = 1;

// =============================================================================
// DATASETS CHAPTER - Load & Render
// =============================================================================

function ds_loadDatasets(page = 1) {
    const search = document.getElementById('dsSearchInput').value;

    let url = `/api/models/${modelId}/datasets/?page=${page}&per_page=10`;
    if (search) url += `&search=${encodeURIComponent(search)}`;

    document.getElementById('datasetsLoading').classList.remove('hidden');
    document.getElementById('datasetsEmpty').classList.add('hidden');

    fetch(url)
        .then(r => r.json())
        .then(data => {
            document.getElementById('datasetsLoading').classList.add('hidden');
            if (data.status === 'success') {
                ds_allDatasets = data.datasets;
                ds_currentPage = page;
                ds_renderDatasetsList(data.datasets);
                ds_renderPagination(data.pagination);
                // Also refresh the Feature Config dataset dropdown
                fc_loadDatasets();
            } else {
                console.error('Failed to load datasets:', data.message);
            }
        })
        .catch(err => {
            document.getElementById('datasetsLoading').classList.add('hidden');
            console.error('Error loading datasets:', err);
        });
}

function ds_renderDatasetsList(datasets) {
    const container = document.getElementById('datasetsList');
    const emptyState = document.getElementById('datasetsEmpty');
    const loadingState = document.getElementById('datasetsLoading');

    // Remove existing cards (keep loading and empty states)
    container.querySelectorAll('.card').forEach(el => el.remove());

    loadingState.classList.add('hidden');

    if (!datasets || datasets.length === 0) {
        emptyState.classList.remove('hidden');
        return;
    }

    emptyState.classList.add('hidden');

    datasets.forEach(ds => {
        // Format description (truncate to 50 chars)
        const description = ds.description
            ? `${ds_escapeHtml(ds.description.substring(0, 50))}${ds.description.length > 50 ? '...' : ''}`
            : 'N/A';

        // Format primary table (strip raw_data. prefix)
        const primaryTable = ds.primary_table
            ? ds.primary_table.replace('raw_data.', '')
            : 'N/A';

        // Format secondary tables count
        const secondaryCount = ds.secondary_tables?.length || 0;
        const secondaryText = secondaryCount === 0
            ? 'None'
            : `${secondaryCount} table${secondaryCount !== 1 ? 's' : ''}`;

        // Format stats from summary_snapshot
        const rowCount = ds.snapshot_total_rows != null
            ? ds_formatNumber(ds.snapshot_total_rows)
            : 'N/A';
        const columnCount = ds.snapshot_column_count != null
            ? ds.snapshot_column_count
            : 'N/A';

        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
            <div class="card-container-dataset">
                <!-- Column 1 (40%): Name + Description + Version -->
                <div class="card-content">
                    <div class="card-header">
                        <h4 class="card-title">${ds_escapeHtml(ds.name)}</h4>
                    </div>
                    <div class="card-body">
                        <span class="card-value text-gray-500 text-xs">${description}</span>
                    </div>
                    <div class="card-version text-gray-400" style="font-size: 10px; margin-top: 2px;">
                        Version: ${ds.version || 1}
                    </div>
                </div>

                <!-- Column 2 (30%): Primary + Secondary Tables -->
                <div class="card-meta-column">
                    <span class="card-label">Primary:</span>
                    <span class="card-schedule-info">${ds_escapeHtml(primaryTable)}</span>
                    <span class="card-label">Secondary:</span>
                    <span class="card-schedule-info">${secondaryText}</span>
                </div>

                <!-- Column 3 (15%): Dataset Stats -->
                <div class="card-meta-column">
                    <span class="card-label">Rows:</span>
                    <span class="card-schedule-info">${rowCount}</span>
                    <span class="card-label">Columns:</span>
                    <span class="card-schedule-info">${columnCount}</span>
                </div>

                <!-- Column 4+5: View, Edit & Delete (horizontal row like Features card) -->
                <div class="flex items-center gap-2" style="grid-column: span 2; justify-content: flex-end;">
                    <button onclick="ds_viewDataset(${ds.id})" class="card-action-btn view" title="View details">
                        View
                    </button>
                    <button onclick="ds_editDataset(${ds.id})" class="card-action-btn edit" title="Edit dataset">
                        <i class="fas fa-external-link-alt"></i>
                    </button>
                    <button onclick="ds_deleteDataset(${ds.id}, '${ds_escapeHtml(ds.name)}')" class="card-action-btn delete" title="Delete dataset">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>

            <!-- Footer: Clone & SQL buttons (matching Features card style) -->
            <div class="flex items-center gap-2 mt-3 pt-3 border-t border-gray-100">
                <button onclick="ds_cloneDataset(${ds.id}, '${ds_escapeHtml(ds.name)}')" class="btn btn-secondary btn-sm" style="width: 150px;">
                    <i class="fas fa-copy"></i>Clone
                </button>
                <button onclick="ds_viewGeneratedQuery(${ds.id})" class="btn btn-secondary btn-sm" style="width: 150px;" title="View generated SQL query">
                    <i class="fas fa-code"></i>SQL
                </button>
            </div>
        `;
        container.appendChild(card);
    });
}

function ds_renderPagination(pagination) {
    const container = document.getElementById('dsPaginationContainer');
    const infoEl = document.getElementById('dsPaginationInfo');
    const buttonsEl = document.getElementById('dsPaginationButtons');

    if (!pagination || pagination.total <= pagination.per_page) {
        container.classList.add('hidden');
        return;
    }

    container.classList.remove('hidden');

    const start = (pagination.page - 1) * pagination.per_page + 1;
    const end = Math.min(pagination.page * pagination.per_page, pagination.total);
    infoEl.textContent = `Showing ${start}-${end} of ${pagination.total}`;

    let buttons = '';
    if (pagination.page > 1) {
        buttons += `<button onclick="ds_loadDatasets(${pagination.page - 1})" class="btn btn-secondary btn-sm">Previous</button>`;
    }

    for (let i = 1; i <= pagination.pages; i++) {
        if (i === pagination.page) {
            buttons += `<button class="btn btn-primary btn-sm">${i}</button>`;
        } else {
            buttons += `<button onclick="ds_loadDatasets(${i})" class="btn btn-secondary btn-sm">${i}</button>`;
        }
    }

    if (pagination.page < pagination.pages) {
        buttons += `<button onclick="ds_loadDatasets(${pagination.page + 1})" class="btn btn-secondary btn-sm">Next</button>`;
    }

    buttonsEl.innerHTML = buttons;
}

function ds_debounceSearch() {
    clearTimeout(ds_searchTimeout);
    ds_searchTimeout = setTimeout(() => ds_loadDatasets(1), 300);
}

// Utility functions for datasets
function ds_escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function ds_formatNumber(num) {
    if (num === null || num === undefined) return 'N/A';
    if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
    if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
    return num.toString();
}

// =============================================================================
// DATASET WIZARD - State Variables
// =============================================================================

let ds_currentWizardStep = 1;
let ds_wizardEditMode = false;
let ds_wizardEditDatasetId = null;
let ds_nameCheckTimeout = null;

let ds_wizardData = {
    name: '',
    description: '',
    primaryTable: null,
    secondaryTables: [],
    joinConfig: {},
    selectedColumns: {},
    columnAliases: {},
    filters: {}
};

let ds_availableTables = [];
let ds_tableSchemas = {};
let ds_currentDatasetId = null;
let ds_datasetStatsData = null;  // Store stats for snapshot when saving

let ds_schemaBuilderState = {
    sessionId: null,
    tables: {},
    selectedColumns: {},
    columnAliases: {},
    joins: [],
    connectMode: null,
    previewData: null,
    selectedJoinIndex: null
};

// Store card positions for Schema Builder
let ds_cardPositions = {};

// Drag state for Schema Builder
let ds_dragState = {
    isDragging: false,
    table: null,
    startX: 0,
    startY: 0,
    cardStartX: 0,
    cardStartY: 0
};

// Preview debounce
let ds_previewDebounceTimer = null;
const DS_PREVIEW_DEBOUNCE_MS = 500;

// =============================================================================
// DATASET WIZARD - Open/Close/Reset
// =============================================================================

function ds_openWizard(datasetId = null) {
    ds_wizardEditMode = datasetId !== null;
    ds_wizardEditDatasetId = datasetId;

    ds_resetWizard();

    document.getElementById('dsWizardModal').classList.remove('hidden');
    document.getElementById('dsWizardTitle').textContent = ds_wizardEditMode ? 'Edit Dataset' : 'Create Dataset';

    // Load BigQuery tables for Step 2
    ds_loadBqTables();

    if (ds_wizardEditMode) {
        ds_loadDatasetForEdit(datasetId);
    }
}

function ds_closeWizard() {
    document.getElementById('dsWizardModal').classList.add('hidden');
    ds_resetWizard();
}

function ds_resetWizard() {
    ds_currentWizardStep = 1;

    ds_wizardData = {
        name: '',
        description: '',
        primaryTable: null,
        secondaryTables: [],
        joinConfig: {},
        selectedColumns: {},
        columnAliases: {},
        filters: {}
    };

    ds_schemaBuilderState = {
        sessionId: null,
        tables: {},
        selectedColumns: {},
        columnAliases: {},
        joins: [],
        connectMode: null,
        previewData: null,
        selectedJoinIndex: null
    };

    // Reset card positions so tables are re-positioned fresh
    ds_cardPositions = {};

    // Reset dates filter state (pending/committed model)
    ds_datesFilterState = {
        pending: {
            timestampColumn: null,
            mode: 'rolling',
            rollingDays: 30,
            startDate: null
        },
        committed: {
            timestampColumn: null,
            mode: 'rolling',
            rollingDays: 30,
            startDate: null
        }
    };
    ds_historyFilterMode = 'rolling';

    // Reset dataset stats data (for snapshot)
    ds_datasetStatsData = null;

    // Reset product filters state (pending/committed model)
    ds_productFiltersState = {
        columnAnalysis: {},
        committed: {
            topRevenue: { enabled: false, productColumn: null, revenueColumn: null, thresholdPercent: 80 },
            categoryFilters: [],
            numericFilters: [],
            dateFilters: [],
            aggregationFilters: []
        },
        pending: {
            topRevenue: { enabled: false, productColumn: null, revenueColumn: null, thresholdPercent: 80 },
            categoryFilters: [],
            numericFilters: [],
            dateFilters: [],
            aggregationFilters: []
        }
    };

    // Reset customer filters state (pending/committed model)
    ds_customerFiltersState = {
        columnAnalysis: {},
        committed: {
            topRevenue: { enabled: false, customerColumn: null, revenueColumn: null, thresholdPercent: 80 },
            categoryFilters: [],
            numericFilters: [],
            dateFilters: [],
            aggregationFilters: []
        },
        pending: {
            topRevenue: { enabled: false, customerColumn: null, revenueColumn: null, thresholdPercent: 80 },
            categoryFilters: [],
            numericFilters: [],
            dateFilters: [],
            aggregationFilters: []
        }
    };

    // Reset analysis data
    ds_productAnalysisData = null;
    ds_customerAnalysisData = null;

    // Reset form fields
    document.getElementById('dsDatasetName').value = '';
    document.getElementById('dsDatasetDescription').value = '';
    document.getElementById('dsNameError').classList.add('hidden');
    document.getElementById('dsNameSuccess').classList.add('hidden');

    // Reset UI
    ds_showStep(1);
    ds_updateNavigationButtons(1);
}

// =============================================================================
// DATASET WIZARD - Step Navigation
// =============================================================================

function ds_showStep(step) {
    // Hide all steps
    for (let i = 1; i <= 4; i++) {
        const stepEl = document.getElementById(`dsStep${i}`);
        if (stepEl) stepEl.classList.remove('active');

        const pill = document.getElementById(`dsProgress${i}`);
        if (pill) {
            pill.classList.remove('current', 'completed');
            if (i < step) pill.classList.add('completed');
            else if (i === step) pill.classList.add('current');
            else pill.classList.add('future');
        }
    }

    // Show current step
    const currentStepEl = document.getElementById(`dsStep${step}`);
    if (currentStepEl) currentStepEl.classList.add('active');

    // Update step counter
    document.getElementById('dsCurrentStep').textContent = step;

    ds_currentWizardStep = step;
    ds_updateNavigationButtons(step);
}

function ds_updateNavigationButtons(step) {
    const prevBtn = document.getElementById('dsPrevButton');
    const nextBtn = document.getElementById('dsNextButton');
    const saveBtn = document.getElementById('dsSaveButton');

    // Previous button
    if (step > 1) {
        prevBtn.classList.remove('hidden');
    } else {
        prevBtn.classList.add('hidden');
    }

    // Next/Save buttons
    if (step < 4) {
        nextBtn.classList.remove('hidden');
        saveBtn.classList.add('hidden');
    } else {
        nextBtn.classList.add('hidden');
        saveBtn.classList.remove('hidden');
    }

    ds_validateCurrentStep();
}

function ds_validateCurrentStep() {
    const nextBtn = document.getElementById('dsNextButton');
    const saveBtn = document.getElementById('dsSaveButton');
    let isValid = false;

    switch (ds_currentWizardStep) {
        case 1:
            const name = document.getElementById('dsDatasetName').value.trim();
            isValid = name.length > 0;
            break;
        case 2:
            isValid = ds_wizardData.primaryTable !== null;
            break;
        case 3:
            const hasSelectedColumns = Object.values(ds_schemaBuilderState.selectedColumns)
                .some(cols => cols && cols.length > 0);
            isValid = hasSelectedColumns;
            break;
        case 4:
            isValid = true; // Filters are optional
            break;
    }

    nextBtn.disabled = !isValid;
    saveBtn.disabled = !isValid;
}

function ds_nextStep() {
    if (ds_currentWizardStep >= 4) return;

    // Collect data from current step
    ds_collectStepData(ds_currentWizardStep);

    const nextStep = ds_currentWizardStep + 1;

    // Initialize step-specific content
    if (nextStep === 3 && !ds_schemaBuilderState.sessionId) {
        ds_loadSchemaBuilder();
    }

    // Moving to Step 4: Collect schema builder data, then fetch column analysis
    if (nextStep === 4) {
        // Transfer data from schemaBuilderState to wizardData (like original model_dataset.html)
        ds_collectSchemaBuilderData();

        ds_fetchColumnAnalysis().then(() => {
            // Populate filter dropdowns with selected columns (needs column types for timestamp filter)
            ds_populateFilterColumnDropdowns();

            // In edit mode, restore ALL saved filter states using consolidated function
            // (matches original model_dataset.html approach with restoreFiltersFromSavedData)
            if (ds_wizardEditMode && ds_wizardData.filters && Object.keys(ds_wizardData.filters).length > 0) {
                ds_restoreFiltersFromSavedData(ds_wizardData.filters);
                // Load stats WITH filters applied
                ds_loadDatasetStats(true);
            } else {
                // New dataset - load unfiltered stats
                ds_loadDatasetStats(false);
            }
        });
    }

    ds_showStep(nextStep);
}

function ds_prevStep() {
    if (ds_currentWizardStep <= 1) return;
    ds_showStep(ds_currentWizardStep - 1);
}

function ds_collectStepData(step) {
    switch (step) {
        case 1:
            ds_wizardData.name = document.getElementById('dsDatasetName').value.trim();
            ds_wizardData.description = document.getElementById('dsDatasetDescription').value.trim();
            break;
        case 2:
            // Primary/secondary tables already collected via event handlers
            break;
        case 3:
            // Schema builder data already in ds_schemaBuilderState
            break;
        case 4:
            // Collect ALL filter data - matches original model_dataset.html approach
            // This ensures filters are saved even if user didn't click "Refresh Dataset"

            // Ensure filters object exists
            if (!ds_wizardData.filters) {
                ds_wizardData.filters = {};
            }

            // ===========================================
            // 1. HISTORY FILTER (dates) - read from DOM
            // ===========================================
            const timestampCol = document.getElementById('dsTimestampColumn')?.value;
            const rollingDays = parseInt(document.getElementById('dsRollingDays')?.value) || 30;
            const startDateValue = document.getElementById('dsStartDateInput')?.value || null;

            if (timestampCol) {
                // Save based on the current filter mode (ds_historyFilterMode is 'rolling' or 'startDate')
                if (ds_historyFilterMode === 'startDate' && startDateValue) {
                    // Start Date mode - save start_date, no rolling_days
                    ds_wizardData.filters.history = {
                        timestamp_column: timestampCol,
                        start_date: startDateValue
                    };
                } else {
                    // Rolling Window mode (default) - save rolling_days, no start_date
                    ds_wizardData.filters.history = {
                        timestamp_column: timestampCol,
                        rolling_days: rollingDays
                    };
                }
            }

            // ===========================================
            // 2. PRODUCT FILTER - build from committed state
            // ===========================================
            const productCommitted = ds_productFiltersState.committed;
            const hasProductFilters = productCommitted.topRevenue.enabled ||
                productCommitted.aggregationFilters.length > 0 ||
                productCommitted.categoryFilters.length > 0 ||
                productCommitted.numericFilters.length > 0 ||
                productCommitted.dateFilters.length > 0;

            if (hasProductFilters) {
                const productFilter = {};

                // Top revenue filter
                if (productCommitted.topRevenue.enabled) {
                    productFilter.top_revenue = {
                        enabled: true,
                        product_column: productCommitted.topRevenue.productColumn,
                        revenue_column: productCommitted.topRevenue.revenueColumn,
                        threshold_percent: productCommitted.topRevenue.thresholdPercent
                    };
                }

                // Aggregation filters
                if (productCommitted.aggregationFilters.length > 0) {
                    productFilter.aggregation_filters = productCommitted.aggregationFilters.map(f => ({
                        type: f.type,
                        product_column: f.productColumn,
                        amount_column: f.amountColumn,
                        filter_type: f.filterType,
                        value: f.value,
                        min: f.min,
                        max: f.max
                    }));
                }

                // Category filters
                if (productCommitted.categoryFilters.length > 0) {
                    productFilter.category_filters = productCommitted.categoryFilters
                        .filter(f => f.values && f.values.length > 0)
                        .map(f => ({
                            column: f.column,
                            mode: f.mode,
                            values: f.values
                        }));
                }

                // Numeric filters
                if (productCommitted.numericFilters.length > 0) {
                    productFilter.numeric_filters = productCommitted.numericFilters.map(f => ({
                        column: f.column,
                        type: f.type,
                        min: f.min,
                        max: f.max,
                        value: f.value,
                        include_nulls: f.includeNulls
                    }));
                }

                // Date filters
                if (productCommitted.dateFilters.length > 0) {
                    productFilter.date_filters = productCommitted.dateFilters.map(f => ({
                        column: f.column,
                        type: f.type,
                        value: f.value,
                        start: f.start,
                        end: f.end
                    }));
                }

                ds_wizardData.filters.product_filter = productFilter;
            }

            // ===========================================
            // 3. CUSTOMER FILTER - build from committed state
            // ===========================================
            const customerCommitted = ds_customerFiltersState.committed;
            const hasCustomerFilters = customerCommitted.topRevenue.enabled ||
                customerCommitted.aggregationFilters.length > 0 ||
                customerCommitted.categoryFilters.length > 0 ||
                customerCommitted.numericFilters.length > 0 ||
                customerCommitted.dateFilters.length > 0;

            if (hasCustomerFilters) {
                const customerFilter = {};

                // Top revenue filter
                if (customerCommitted.topRevenue.enabled) {
                    customerFilter.top_revenue = {
                        enabled: true,
                        customer_column: customerCommitted.topRevenue.customerColumn,
                        revenue_column: customerCommitted.topRevenue.revenueColumn,
                        percent: customerCommitted.topRevenue.thresholdPercent
                    };
                }

                // Aggregation filters
                if (customerCommitted.aggregationFilters.length > 0) {
                    customerFilter.aggregation_filters = customerCommitted.aggregationFilters.map(f => ({
                        type: f.type,
                        customer_column: f.customerColumn,
                        amount_column: f.amountColumn,
                        filter_type: f.filterType,
                        value: f.value,
                        min: f.min,
                        max: f.max
                    }));
                }

                // Category filters
                if (customerCommitted.categoryFilters.length > 0) {
                    customerFilter.category_filters = customerCommitted.categoryFilters
                        .filter(f => f.values && f.values.length > 0)
                        .map(f => ({
                            column: f.column,
                            mode: f.mode,
                            values: f.values
                        }));
                }

                // Numeric filters
                if (customerCommitted.numericFilters.length > 0) {
                    customerFilter.numeric_filters = customerCommitted.numericFilters.map(f => ({
                        column: f.column,
                        type: f.type || f.filterType,
                        min: f.min,
                        max: f.max,
                        value: f.value,
                        include_nulls: f.includeNulls
                    }));
                }

                // Date filters
                if (customerCommitted.dateFilters.length > 0) {
                    customerFilter.date_filters = customerCommitted.dateFilters.map(f => ({
                        column: f.column,
                        type: f.type,
                        value: f.value,
                        start: f.start,
                        end: f.end
                    }));
                }

                ds_wizardData.filters.customer_filter = customerFilter;
            }
            break;
    }
}

// =============================================================================
// DATASET WIZARD - Step 1: Name Validation
// =============================================================================

function ds_validateDatasetName() {
    const name = document.getElementById('dsDatasetName').value.trim();
    const errorEl = document.getElementById('dsNameError');
    const successEl = document.getElementById('dsNameSuccess');

    if (!name) {
        errorEl.classList.add('hidden');
        successEl.classList.add('hidden');
        ds_validateCurrentStep();
        return;
    }

    clearTimeout(ds_nameCheckTimeout);
    ds_nameCheckTimeout = setTimeout(() => {
        fetch(`/api/models/${modelId}/datasets/check-name/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                name: name,
                exclude_id: ds_wizardEditDatasetId
            })
        })
        .then(r => r.json())
        .then(data => {
            if (data.available) {
                errorEl.classList.add('hidden');
                successEl.classList.remove('hidden');
            } else {
                successEl.classList.add('hidden');
                errorEl.textContent = data.message || 'Name already exists';
                errorEl.classList.remove('hidden');
            }
            ds_validateCurrentStep();
        })
        .catch(err => {
            console.error('Error checking name:', err);
        });
    }, 300);
}

// =============================================================================
// DATASET WIZARD - Step 2: BigQuery Tables
// =============================================================================

function ds_loadBqTables() {
    fetch(`/api/models/${modelId}/bq-tables/`)
        .then(r => r.json())
        .then(data => {
            if (data.status === 'success') {
                ds_availableTables = data.tables;
                ds_renderPrimaryTableList();
                ds_renderSecondaryTableList();  // Re-render to clear stale checkboxes from previous session
            }
        })
        .catch(err => console.error('Error loading BQ tables:', err));
}

function ds_renderPrimaryTableList() {
    const container = document.getElementById('dsPrimaryTableList');

    if (!ds_availableTables || ds_availableTables.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-500 py-4">No tables available</p>';
        return;
    }

    container.innerHTML = ds_availableTables.map(t => {
        const shortName = t.full_name.replace('raw_data.', '');
        const isSelected = ds_wizardData.primaryTable === t.full_name;
        return `
            <div class="wizard-selection-card ${isSelected ? 'selected' : ''}" onclick="ds_onPrimaryTableSelect('${t.full_name}')">
                <div class="flex items-center gap-3">
                    <input type="radio" name="dsPrimaryTable" value="${t.full_name}" ${isSelected ? 'checked' : ''}>
                    <div>
                        <div class="font-medium text-gray-900">${ds_escapeHtml(shortName)}</div>
                        <div class="text-xs text-gray-500">${ds_formatNumber(t.row_count)} rows  ${t.column_count} columns</div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function ds_onPrimaryTableSelect(tableName) {
    ds_wizardData.primaryTable = tableName;
    ds_wizardData.secondaryTables = [];

    // Invalidate Schema Builder session so it reloads when returning to Step 3
    ds_schemaBuilderState.sessionId = null;

    ds_renderPrimaryTableList();
    ds_renderSecondaryTableList();
    ds_loadTableSchema(tableName);
    ds_validateCurrentStep();
}

function ds_renderSecondaryTableList() {
    const container = document.getElementById('dsSecondaryTableList');

    if (!ds_wizardData.primaryTable) {
        container.innerHTML = '<p class="text-center text-gray-500 py-4">Select a primary table first</p>';
        return;
    }

    const otherTables = ds_availableTables.filter(t => t.full_name !== ds_wizardData.primaryTable);

    if (otherTables.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-500 py-4">No additional tables available</p>';
        return;
    }

    container.innerHTML = otherTables.map(t => {
        const shortName = t.full_name.replace('raw_data.', '');
        const isSelected = ds_wizardData.secondaryTables.includes(t.full_name);
        return `
            <div class="wizard-selection-card ${isSelected ? 'selected' : ''}">
                <label class="flex items-center gap-3 cursor-pointer w-full">
                    <input type="checkbox" value="${t.full_name}" ${isSelected ? 'checked' : ''}
                           onchange="ds_onSecondaryTableToggle('${t.full_name}', this.checked)">
                    <div>
                        <div class="font-medium text-gray-900">${ds_escapeHtml(shortName)}</div>
                        <div class="text-xs text-gray-500">${ds_formatNumber(t.row_count)} rows  ${t.column_count} columns</div>
                    </div>
                </label>
            </div>
        `;
    }).join('');
}

function ds_onSecondaryTableToggle(tableName, isChecked) {
    if (isChecked) {
        if (!ds_wizardData.secondaryTables.includes(tableName)) {
            ds_wizardData.secondaryTables.push(tableName);
            ds_loadTableSchema(tableName);
        }
    } else {
        ds_wizardData.secondaryTables = ds_wizardData.secondaryTables.filter(t => t !== tableName);
    }

    // Invalidate Schema Builder session so it reloads when returning to Step 3
    ds_schemaBuilderState.sessionId = null;

    ds_renderSecondaryTableList();
}

function ds_loadTableSchema(tableName) {
    fetch(`/api/models/${modelId}/bq-tables/${encodeURIComponent(tableName)}/schema/`)
        .then(r => r.json())
        .then(data => {
            if (data.status === 'success') {
                ds_tableSchemas[tableName] = data.columns;
            }
        })
        .catch(err => console.error('Error loading schema:', err));
}

// =============================================================================
// DATASET WIZARD - Step 3: Schema Builder (Simplified)
// =============================================================================

function ds_loadSchemaBuilder() {
    const allTables = [ds_wizardData.primaryTable, ...ds_wizardData.secondaryTables].filter(Boolean);
    const container = document.getElementById('dsSchemaCardsContainer');
    const loadingEl = document.getElementById('dsSchemaLoading');

    loadingEl.style.display = 'flex';

    fetch(`/api/models/${modelId}/datasets/load-samples/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ tables: allTables })
    })
    .then(r => r.json())
    .then(data => {
        loadingEl.style.display = 'none';
        if (data.status === 'success') {
            ds_schemaBuilderState.sessionId = data.session_id;
            ds_schemaBuilderState.tables = data.tables;
            ds_renderTableCards();

            // Trigger preview if columns are already selected (edit mode)
            const hasSelectedColumns = Object.values(ds_schemaBuilderState.selectedColumns)
                .some(cols => cols && cols.length > 0);
            if (hasSelectedColumns) {
                ds_refreshPreview();
            }
        }
    })
    .catch(err => {
        loadingEl.style.display = 'none';
        console.error('Error loading samples:', err);
    });
}

function ds_renderTableCards() {
    const container = document.getElementById('dsSchemaCardsContainer');
    const allTables = [ds_wizardData.primaryTable, ...ds_wizardData.secondaryTables].filter(Boolean);

    let html = '';
    allTables.forEach((tableName, idx) => {
        const shortName = tableName.replace('raw_data.', '');
        const isPrimary = idx === 0;
        const tableData = ds_schemaBuilderState.tables[tableName] || {};
        const columns = tableData.columns || [];
        const selectedCols = ds_schemaBuilderState.selectedColumns[tableName] || [];
        const allSelected = columns.length > 0 && selectedCols.length === columns.length;

        html += `
            <div class="schema-table-card ${isPrimary ? 'primary' : 'secondary'}" data-table="${tableName}" id="dsCard_${shortName}">
                <div class="schema-card-header" onmousedown="ds_startDrag(event, '${tableName}')">
                    <span class="schema-card-title">${ds_escapeHtml(shortName)}</span>
                    <span class="schema-card-badge ${isPrimary ? 'primary' : 'secondary'}">${isPrimary ? 'Primary' : 'Secondary'}</span>
                </div>
                <div class="schema-select-all-row">
                    <label class="schema-select-all-label">
                        <input type="checkbox" ${allSelected ? 'checked' : ''}
                               onchange="ds_toggleAllColumns('${tableName}', this.checked)">
                        <span>${allSelected ? 'Deselect All' : 'Select All'}</span>
                    </label>
                    <span class="schema-column-count">${selectedCols.length}/${columns.length}</span>
                </div>
                <div class="schema-column-list" id="dsColumnList_${shortName}">
                    ${columns.map(col => ds_renderColumnItem(tableName, col, selectedCols, isPrimary)).join('')}
                </div>
            </div>
        `;
    });

    container.innerHTML = html;

    // Position cards: distribute evenly across container
    ds_positionCardsInitially(allTables);

    // Setup drag handlers for moving cards
    ds_setupDragHandlers();

    // Setup scroll handlers for column lists
    ds_setupColumnScrollHandlers();

    // Update connection lines after rendering
    setTimeout(ds_updateConnectionLines, 50);
}

// Render a single column item with connection dot/plus
function ds_renderColumnItem(table, col, selectedCols, isPrimary) {
    const shortTable = table.replace('raw_data.', '');
    const isSelected = selectedCols.includes(col.name);

    // Determine if column is a recommended join key based on naming patterns
    const colLower = col.name.toLowerCase();
    const keyPatterns = ['_id', 'id_', '_key', 'key_', '_code', 'code_'];
    const isRecommendedJoinKey = col.is_potential_join_key ||
                      keyPatterns.some(p => colLower.includes(p)) ||
                      colLower === 'id';

    // Check if this column is part of an existing join
    const isConnected = ds_schemaBuilderState.joins.some(j =>
        (j.leftCol === col.name && ds_wizardData.primaryTable === table) ||
        (j.rightCol === col.name && j.rightTable === table)
    );

    // Determine what to show in the connection area:
    // - Connected: colored dot (always visible)
    // - Recommended but not connected: empty dot (always visible)
    // - Not recommended and not connected: "+" on hover
    let connectionElement;
    if (isConnected) {
        // Connected column - show colored dot
        connectionElement = `
            <div class="schema-connection-dot connected"
                 data-table="${table}" data-column="${col.name}"
                 onclick="ds_onConnectionDotClick('${table}', '${col.name}', event)"></div>
        `;
    } else if (isRecommendedJoinKey) {
        // Recommended join key - show empty dot
        connectionElement = `
            <div class="schema-connection-dot recommended"
                 data-table="${table}" data-column="${col.name}"
                 onclick="ds_onConnectionDotClick('${table}', '${col.name}', event)"></div>
        `;
    } else {
        // Regular column - show "+" on hover
        connectionElement = `
            <div class="schema-connection-plus"
                 data-table="${table}" data-column="${col.name}"
                 onclick="ds_onConnectionDotClick('${table}', '${col.name}', event)">+</div>
        `;
    }

    return `
        <div class="schema-column-item ${isConnected ? 'connected' : ''}" data-table="${table}" data-column="${col.name}"
             data-type="${col.type || 'unknown'}">
            <input type="checkbox" ${isSelected ? 'checked' : ''}
                   onchange="ds_onColumnToggle('${table}', '${col.name}', this.checked)">
            <span class="schema-column-name">${col.name}</span>
            <span class="schema-column-type">${(col.type || '').substring(0, 3).toLowerCase()}</span>
            ${connectionElement}
        </div>
    `;
}

function ds_onColumnToggle(tableName, columnName, isChecked) {
    if (!ds_schemaBuilderState.selectedColumns[tableName]) {
        ds_schemaBuilderState.selectedColumns[tableName] = [];
    }

    if (isChecked) {
        if (!ds_schemaBuilderState.selectedColumns[tableName].includes(columnName)) {
            ds_schemaBuilderState.selectedColumns[tableName].push(columnName);
        }
    } else {
        ds_schemaBuilderState.selectedColumns[tableName] =
            ds_schemaBuilderState.selectedColumns[tableName].filter(c => c !== columnName);
    }

    ds_validateCurrentStep();
    ds_debouncedRefreshPreview();
}

// Toggle all columns for a table (Select All / Deselect All)
function ds_toggleAllColumns(tableName, selectAll) {
    const tableData = ds_schemaBuilderState.tables[tableName] || {};
    const columns = tableData.columns || [];

    if (selectAll) {
        // Select all columns
        ds_schemaBuilderState.selectedColumns[tableName] = columns.map(col => col.name);
    } else {
        // Deselect all columns
        ds_schemaBuilderState.selectedColumns[tableName] = [];
    }

    // Re-render cards to update checkboxes and Select All state
    ds_renderTableCards();
    ds_validateCurrentStep();
    ds_refreshPreview();
}

function ds_debouncedRefreshPreview() {
    if (ds_previewDebounceTimer) {
        clearTimeout(ds_previewDebounceTimer);
    }
    ds_previewDebounceTimer = setTimeout(ds_refreshPreview, DS_PREVIEW_DEBOUNCE_MS);
}

function ds_refreshPreview() {
    // Check if we have a session and selected columns
    if (!ds_schemaBuilderState.sessionId) {
        ds_renderPreviewEmpty();
        return;
    }

    const totalCols = Object.values(ds_schemaBuilderState.selectedColumns)
        .reduce((sum, cols) => sum + (cols?.length || 0), 0);

    if (totalCols === 0) {
        ds_renderPreviewEmpty();
        return;
    }

    // Build joins array for API
    const joins = ds_schemaBuilderState.joins.map(j => ({
        table: j.rightTable,
        left_col: j.leftCol,
        right_col: j.rightCol,
        type: j.type
    }));

    // Debug logging for join issues
    console.log('[DS Preview] Session ID:', ds_schemaBuilderState.sessionId);
    console.log('[DS Preview] Primary table:', ds_wizardData.primaryTable);
    console.log('[DS Preview] Joins:', JSON.stringify(joins, null, 2));
    console.log('[DS Preview] Selected columns:', JSON.stringify(ds_schemaBuilderState.selectedColumns, null, 2));

    // Make API call to get preview data
    fetch(`/api/models/${modelId}/datasets/preview/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
            session_id: ds_schemaBuilderState.sessionId,
            primary_table: ds_wizardData.primaryTable,
            joins: joins,
            selected_columns: ds_schemaBuilderState.selectedColumns
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('[DS Preview] Response:', JSON.stringify(data, null, 2));
        if (data.stats?.warnings?.length > 0) {
            console.warn('[DS Preview] Warnings:', data.stats.warnings);
        }
        if (data.status === 'success') {
            ds_schemaBuilderState.previewData = data;
            ds_renderPreview(data);
        } else {
            ds_renderPreviewError(data.message || 'Failed to generate preview');
        }
    })
    .catch(error => {
        console.error('Error generating preview:', error);
        ds_renderPreviewError('Failed to generate preview');
    });
}

function ds_renderPreviewEmpty() {
    document.getElementById('dsPreviewRowCount').textContent = '-';
    document.getElementById('dsPreviewColCount').textContent = '-';
    document.getElementById('dsPreviewTable').style.display = 'none';
    document.getElementById('dsPreviewEmpty').style.display = 'flex';
    document.getElementById('dsPreviewWarnings').style.display = 'none';
}

function ds_renderPreview(data) {
    // Update stats
    document.getElementById('dsPreviewRowCount').textContent = data.stats?.total_rows || 0;
    document.getElementById('dsPreviewColCount').textContent = data.column_order?.length || 0;

    // Show warnings if any
    const warningsEl = document.getElementById('dsPreviewWarnings');
    const warningTextEl = document.getElementById('dsPreviewWarningText');
    if (data.stats?.warnings?.length > 0) {
        warningsEl.style.display = 'flex';
        warningTextEl.textContent = data.stats.warnings[0];
    } else if (Object.keys(data.stats?.null_counts || {}).length > 0) {
        const nullCounts = data.stats.null_counts;
        const firstNull = Object.entries(nullCounts)[0];
        warningsEl.style.display = 'flex';
        warningTextEl.textContent = `${firstNull[1]} nulls in ${firstNull[0]}`;
    } else {
        warningsEl.style.display = 'none';
    }

    // Render table
    const table = document.getElementById('dsPreviewTable');
    const thead = document.getElementById('dsPreviewTableHead');
    const tbody = document.getElementById('dsPreviewTableBody');
    const empty = document.getElementById('dsPreviewEmpty');

    if (!data.preview_rows || data.preview_rows.length === 0) {
        table.style.display = 'none';
        empty.style.display = 'flex';
        return;
    }

    table.style.display = 'table';
    empty.style.display = 'none';

    // Headers (editable via double-click for column aliasing)
    const aliases = ds_schemaBuilderState.columnAliases || {};
    thead.innerHTML = '<tr>' + (data.column_order || []).map(col => {
        const alias = aliases[col] || col;
        return `<th class="editable-header" data-original="${col}" title="Double-click to rename" ondblclick="ds_startColumnRename(this, '${col}')">${ds_escapeHtml(alias)}</th>`;
    }).join('') + '</tr>';

    // Rows
    tbody.innerHTML = (data.preview_rows || []).filter(row => row != null).map(row => {
        return '<tr>' + (data.column_order || []).map(col => {
            const val = row[col];
            if (val === null || val === undefined) {
                return `<td class="null-value">NULL</td>`;
            }
            const strVal = String(val);
            const displayVal = strVal.length > 30 ? strVal.substring(0, 30) + '...' : strVal;
            return `<td title="${ds_escapeHtml(strVal)}">${ds_escapeHtml(displayVal)}</td>`;
        }).join('') + '</tr>';
    }).join('');

    ds_validateCurrentStep();
}

function ds_renderPreviewError(message) {
    document.getElementById('dsPreviewRowCount').textContent = '-';
    document.getElementById('dsPreviewColCount').textContent = '-';
    document.getElementById('dsPreviewTable').style.display = 'none';
    document.getElementById('dsPreviewEmpty').style.display = 'flex';
    document.getElementById('dsPreviewEmpty').innerHTML = `
        <i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i>
        <span style="color: #b45309;">${ds_escapeHtml(message)}</span>
    `;
}

// =============================================================================
// DATASET WIZARD - Step 3: Column Renaming (Aliases)
// =============================================================================

// Start inline editing of a column header
function ds_startColumnRename(th, originalName) {
    // Prevent double-click text selection
    if (th.querySelector('input')) return;

    // Ensure columnAliases exists
    if (!ds_schemaBuilderState.columnAliases) {
        ds_schemaBuilderState.columnAliases = {};
    }

    const currentAlias = ds_schemaBuilderState.columnAliases[originalName] || originalName;
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'column-rename-input';
    input.value = currentAlias;
    input.dataset.original = originalName;

    input.onblur = () => ds_finishColumnRename(input, th, originalName);
    input.onkeydown = (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            input.blur();
        }
        if (e.key === 'Escape') {
            e.preventDefault();
            input.value = currentAlias;
            input.blur();
        }
    };

    th.innerHTML = '';
    th.appendChild(input);
    input.focus();
    input.select();
}

// Finish inline editing and save the alias
function ds_finishColumnRename(input, th, originalName) {
    const newAlias = input.value.trim();

    // Ensure columnAliases exists
    if (!ds_schemaBuilderState.columnAliases) {
        ds_schemaBuilderState.columnAliases = {};
    }

    // Update state: if alias is same as original, remove it; otherwise save it
    if (newAlias && newAlias !== originalName) {
        ds_schemaBuilderState.columnAliases[originalName] = newAlias;
    } else {
        delete ds_schemaBuilderState.columnAliases[originalName];
    }

    // Update display
    const displayName = ds_schemaBuilderState.columnAliases[originalName] || originalName;
    th.textContent = displayName;
}

// Helper function to get column display name (alias or short column name)
// Handles both formats: "table.column" (dropdowns) and "table_column" (preview)
// Returns alias if set, otherwise returns just the column name without table prefix
function ds_getColumnDisplayName(columnName) {
    // Try to find alias first
    if (ds_schemaBuilderState.columnAliases) {
        // Try direct match first
        if (ds_schemaBuilderState.columnAliases[columnName]) {
            return ds_schemaBuilderState.columnAliases[columnName];
        }
        // Try converting dot to underscore (dropdown format -> preview format)
        const underscoreFormat = columnName.replace('.', '_');
        if (ds_schemaBuilderState.columnAliases[underscoreFormat]) {
            return ds_schemaBuilderState.columnAliases[underscoreFormat];
        }
        // Try converting underscore to dot (preview format -> dropdown format)
        const dotFormat = columnName.replace('_', '.');
        if (ds_schemaBuilderState.columnAliases[dotFormat]) {
            return ds_schemaBuilderState.columnAliases[dotFormat];
        }
    }
    // No alias found - return short column name (without table prefix)
    // Handle both "table.column" and "table_column" formats
    if (columnName.includes('.')) {
        return columnName.split('.').pop();
    }
    // For underscore format, find the table name and strip it
    const parts = columnName.split('_');
    if (parts.length > 1) {
        // Check if first part looks like a table name (common patterns)
        const tables = Object.keys(ds_schemaBuilderState.tables || {});
        for (const table of tables) {
            const tablePrefix = table.replace('raw_data.', '') + '_';
            if (columnName.startsWith(tablePrefix)) {
                return columnName.substring(tablePrefix.length);
            }
        }
    }
    return columnName;
}

// =============================================================================
// DATASET WIZARD - Step 3: Collect Schema Builder Data (for Save)
// =============================================================================

// Transfer data from ds_schemaBuilderState to ds_wizardData before saving
// This matches the original model_dataset.html behavior
function ds_collectSchemaBuilderData() {
    // Convert joins to the format expected by the backend
    ds_wizardData.joinConfig = {};
    ds_schemaBuilderState.joins.forEach(join => {
        ds_wizardData.joinConfig[join.rightTable] = {
            join_key: join.leftCol,
            secondary_column: join.rightCol,
            join_type: join.type
        };
    });

    // Update secondaryTables to only include tables that have joins configured
    // This prevents the backend from trying to join tables without proper configuration
    const joinedTables = ds_schemaBuilderState.joins.map(j => j.rightTable);
    ds_wizardData.secondaryTables = ds_wizardData.secondaryTables.filter(table =>
        joinedTables.includes(table)
    );

    // Determine which tables are in use (primary + joined secondary tables)
    const tablesInUse = [ds_wizardData.primaryTable, ...ds_wizardData.secondaryTables];

    // Transfer only selected columns from tables that are in use
    ds_wizardData.selectedColumns = {};
    tablesInUse.forEach(table => {
        if (ds_schemaBuilderState.selectedColumns[table]) {
            ds_wizardData.selectedColumns[table] = [...ds_schemaBuilderState.selectedColumns[table]];
        }
    });

    // Transfer column aliases
    ds_wizardData.columnAliases = {...ds_schemaBuilderState.columnAliases};
}

// =============================================================================
// DATASET WIZARD - Step 3: Schema Builder Positioning & Drag
// =============================================================================

function ds_positionCardsInitially(allTables) {
    const container = document.getElementById('dsSchemaCardsContainer');
    if (!container) return;

    const containerRect = container.getBoundingClientRect();

    // Use fixed dimensions based on CSS if container not yet sized
    const containerWidth = Math.max(containerRect.width, 900);
    const containerHeight = Math.max(containerRect.height, 350);

    const cardWidth = 220;
    const cardHeight = 280; // Approximate card height including columns
    const horizontalGap = 40; // Gap between cards

    const numTables = allTables.length;

    allTables.forEach((table, index) => {
        const shortName = table.replace('raw_data.', '');
        const card = document.getElementById(`dsCard_${shortName}`);
        if (!card) return;

        let x, y;

        // Check if we have saved positions
        if (ds_cardPositions[table]) {
            x = ds_cardPositions[table].x;
            y = ds_cardPositions[table].y;
        } else {
            // Calculate horizontal layout: distribute cards evenly across container width
            const totalCardsWidth = numTables * cardWidth + (numTables - 1) * horizontalGap;
            const startX = Math.max(20, (containerWidth - totalCardsWidth) / 2);

            // Position each card in a row
            x = startX + index * (cardWidth + horizontalGap);
            y = (containerHeight - cardHeight) / 2;

            // Keep within bounds
            x = Math.max(10, Math.min(x, containerWidth - cardWidth - 10));
            y = Math.max(10, Math.min(y, containerHeight - cardHeight - 10));
        }

        card.style.left = x + 'px';
        card.style.top = y + 'px';

        // Save position
        ds_cardPositions[table] = { x, y };
    });
}

function ds_setupDragHandlers() {
    // Remove existing handlers to avoid duplicates
    document.removeEventListener('mousemove', ds_onDragMove);
    document.removeEventListener('mouseup', ds_onDragEnd);

    // Add fresh handlers
    document.addEventListener('mousemove', ds_onDragMove);
    document.addEventListener('mouseup', ds_onDragEnd);
}

function ds_startDrag(event, table) {
    // Don't start drag if clicking on checkbox or other interactive elements
    if (event.target.tagName === 'INPUT' || event.target.tagName === 'LABEL') {
        return;
    }

    event.preventDefault();

    const shortName = table.replace('raw_data.', '');
    const card = document.getElementById(`dsCard_${shortName}`);
    if (!card) return;

    ds_dragState = {
        isDragging: true,
        table: table,
        startX: event.clientX,
        startY: event.clientY,
        cardStartX: parseInt(card.style.left) || 0,
        cardStartY: parseInt(card.style.top) || 0
    };

    card.classList.add('dragging');
}

function ds_onDragMove(event) {
    if (!ds_dragState.isDragging) return;

    const shortName = ds_dragState.table.replace('raw_data.', '');
    const card = document.getElementById(`dsCard_${shortName}`);
    if (!card) return;

    const container = document.getElementById('dsSchemaCardsContainer');
    const containerRect = container.getBoundingClientRect();

    const deltaX = event.clientX - ds_dragState.startX;
    const deltaY = event.clientY - ds_dragState.startY;

    let newX = ds_dragState.cardStartX + deltaX;
    let newY = ds_dragState.cardStartY + deltaY;

    // Keep within container bounds
    const cardRect = card.getBoundingClientRect();
    const maxX = containerRect.width - cardRect.width;
    const maxY = containerRect.height - cardRect.height;

    newX = Math.max(0, Math.min(newX, maxX));
    newY = Math.max(0, Math.min(newY, maxY));

    card.style.left = newX + 'px';
    card.style.top = newY + 'px';

    // Save position
    ds_cardPositions[ds_dragState.table] = { x: newX, y: newY };

    // Update connection lines while dragging
    ds_updateConnectionLines();
}

function ds_onDragEnd(event) {
    if (!ds_dragState.isDragging) return;

    const shortName = ds_dragState.table.replace('raw_data.', '');
    const card = document.getElementById(`dsCard_${shortName}`);
    if (card) {
        card.classList.remove('dragging');
    }

    ds_dragState.isDragging = false;
    ds_dragState.table = null;
}

function ds_setupColumnScrollHandlers() {
    // Setup scroll event listeners on column lists (if needed for connection lines later)
    document.querySelectorAll('#dsSchemaCardsContainer .schema-column-list').forEach(list => {
        list.removeEventListener('scroll', ds_onColumnScroll);
        list.addEventListener('scroll', ds_onColumnScroll);
    });
}

function ds_onColumnScroll() {
    // Update connection lines when column list is scrolled
    ds_updateConnectionLines();
}

// =============================================================================
// DATASET WIZARD - Step 3: Connection/Join System
// =============================================================================

// Color palette for connection lines
const DS_JOIN_COLORS = [
    '#2563eb', // Blue
    '#16a34a', // Green
    '#dc2626', // Red
    '#9333ea', // Purple
    '#ea580c', // Orange
    '#0891b2', // Cyan
    '#c026d3', // Fuchsia
    '#ca8a04', // Yellow
];

// Connection dot/plus click handling
function ds_onConnectionDotClick(table, column, event) {
    // Get click position for popover
    const clickX = event ? event.clientX : 0;
    const clickY = event ? event.clientY : 0;

    const connectMode = ds_schemaBuilderState.connectMode;

    if (!connectMode) {
        // Start connect mode
        ds_schemaBuilderState.connectMode = { table, column };

        // Show source column info popover
        ds_showColumnInfoPopover(table, column, clickX, clickY, true);

        // Highlight source element and valid targets
        ds_highlightConnectModeElements(table, column);

        // Add event listeners for cancel actions
        document.addEventListener('keydown', ds_handleConnectModeKeydown);
        document.addEventListener('click', ds_handleConnectModeOutsideClick, true);

    } else {
        // Complete or cancel connection
        if (connectMode.table === table && connectMode.column === column) {
            // Clicked same element - cancel
            ds_exitConnectMode();
        } else if (connectMode.table !== table) {
            // Valid target - create join
            ds_createJoin(connectMode.table, connectMode.column, table, column);
            ds_exitConnectMode();
        }
        // If same table but different column - ignore
    }
}

// Highlight elements during connect mode
function ds_highlightConnectModeElements(sourceTable, sourceColumn) {
    // Highlight source dot/plus
    document.querySelectorAll('#dsSchemaCardsContainer .schema-connection-dot, #dsSchemaCardsContainer .schema-connection-plus').forEach(el => {
        if (el.dataset.table === sourceTable && el.dataset.column === sourceColumn) {
            el.classList.add('connect-mode');
        } else if (el.dataset.table !== sourceTable) {
            // Highlight valid targets (different table)
            el.classList.add('connect-mode-target');
        }
    });

    // Add hover listeners for target columns
    document.querySelectorAll('#dsSchemaCardsContainer .schema-column-item').forEach(item => {
        if (item.dataset.table !== sourceTable) {
            item.addEventListener('mouseenter', ds_handleTargetColumnHover);
            item.addEventListener('mouseleave', ds_handleTargetColumnLeave);
        }
    });
}

// Handle hover on target column during connect mode
function ds_handleTargetColumnHover(event) {
    const item = event.currentTarget;
    const table = item.dataset.table;
    const column = item.dataset.column;

    if (!ds_schemaBuilderState.connectMode || table === ds_schemaBuilderState.connectMode.table) {
        return;
    }

    // Get column type for compatibility check
    const sourceType = ds_getColumnType(ds_schemaBuilderState.connectMode.table, ds_schemaBuilderState.connectMode.column);
    const targetType = ds_getColumnType(table, column);
    const isCompatible = ds_checkTypeCompatibility(sourceType, targetType);

    // Show target popover near cursor
    ds_showColumnInfoPopover(table, column, event.clientX + 15, event.clientY + 15, false, sourceType, isCompatible);
}

// Handle mouse leave on target column
function ds_handleTargetColumnLeave(event) {
    // Hide target info but keep source info
    if (ds_schemaBuilderState.connectMode) {
        const popover = document.getElementById('dsColumnInfoPopover');
        // Reset to source info
        ds_showColumnInfoPopover(
            ds_schemaBuilderState.connectMode.table,
            ds_schemaBuilderState.connectMode.column,
            parseInt(popover.style.left),
            parseInt(popover.style.top),
            true
        );
    }
}

// Get column type from state
function ds_getColumnType(table, column) {
    const tableData = ds_schemaBuilderState.tables[table];
    if (!tableData || !tableData.columns) return 'unknown';

    const col = tableData.columns.find(c => c.name === column);
    return col ? col.type : 'unknown';
}

// Get sample values for a column
function ds_getColumnSamples(table, column) {
    const tableData = ds_schemaBuilderState.tables[table];
    if (!tableData || !tableData.sample_preview) return [];

    return tableData.sample_preview
        .map(row => row[column])
        .filter(v => v !== null && v !== undefined)
        .slice(0, 5);
}

// Format sample values for display
function ds_formatSampleValues(samples) {
    if (!samples || samples.length === 0) return 'No samples';

    return samples.map(v => {
        if (typeof v === 'string') {
            // Truncate long strings
            return v.length > 15 ? `"${v.substring(0, 15)}..."` : `"${v}"`;
        }
        return String(v);
    }).join(', ');
}

// Check if two types are compatible for joining
function ds_checkTypeCompatibility(type1, type2) {
    if (!type1 || !type2 || type1 === 'unknown' || type2 === 'unknown') {
        return true; // Allow if unknown
    }

    // Normalize types
    const normalize = (t) => {
        t = t.toUpperCase();
        if (t.includes('INT')) return 'INTEGER';
        if (t.includes('FLOAT') || t.includes('NUMERIC') || t.includes('DECIMAL')) return 'NUMERIC';
        if (t.includes('STRING') || t.includes('VARCHAR') || t.includes('CHAR')) return 'STRING';
        if (t.includes('DATE') || t.includes('TIME')) return 'DATETIME';
        if (t.includes('BOOL')) return 'BOOLEAN';
        return t;
    };

    const n1 = normalize(type1);
    const n2 = normalize(type2);

    // Same normalized type
    if (n1 === n2) return true;

    // Numeric types can join together
    if ((n1 === 'INTEGER' || n1 === 'NUMERIC') && (n2 === 'INTEGER' || n2 === 'NUMERIC')) {
        return true;
    }

    return false;
}

// Show column info popover
function ds_showColumnInfoPopover(table, column, x, y, isSource, sourceType = null, isCompatible = true) {
    const popover = document.getElementById('dsColumnInfoPopover');
    const type = ds_getColumnType(table, column);
    const samples = ds_getColumnSamples(table, column);

    // Update popover content
    document.getElementById('dsColumnInfoName').textContent = column;
    document.getElementById('dsColumnInfoTypeValue').textContent = type || 'unknown';
    document.getElementById('dsColumnInfoSamplesValue').textContent = ds_formatSampleValues(samples);

    // Show/hide hint, warning, compatible messages
    const hintEl = document.getElementById('dsColumnInfoHint');
    const warningEl = document.getElementById('dsColumnInfoWarning');
    const compatibleEl = document.getElementById('dsColumnInfoCompatible');

    if (isSource) {
        hintEl.classList.remove('hidden');
        warningEl.classList.add('hidden');
        compatibleEl.classList.add('hidden');
    } else {
        hintEl.classList.add('hidden');

        if (!isCompatible) {
            warningEl.classList.remove('hidden');
            compatibleEl.classList.add('hidden');
            document.getElementById('dsColumnInfoWarningText').textContent =
                `Type mismatch: ${sourceType}  ${type}`;
        } else {
            warningEl.classList.add('hidden');
            compatibleEl.classList.remove('hidden');
        }
    }

    // Position popover
    popover.style.left = `${x + 10}px`;
    popover.style.top = `${y + 10}px`;

    // Ensure popover stays within viewport
    const rect = popover.getBoundingClientRect();
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;

    if (rect.right > viewportWidth) {
        popover.style.left = `${x - rect.width - 10}px`;
    }
    if (rect.bottom > viewportHeight) {
        popover.style.top = `${y - rect.height - 10}px`;
    }

    popover.classList.remove('hidden');
}

// Hide column info popover
function ds_hideColumnInfoPopover() {
    document.getElementById('dsColumnInfoPopover').classList.add('hidden');
}

// Handle Escape key to cancel connect mode
function ds_handleConnectModeKeydown(event) {
    if (event.key === 'Escape') {
        ds_exitConnectMode();
    }
}

// Handle click outside to cancel connect mode
function ds_handleConnectModeOutsideClick(event) {
    // Check if click is on a connection element
    const isConnectionElement = event.target.closest('.schema-connection-dot, .schema-connection-plus');
    const isColumnItem = event.target.closest('.schema-column-item');

    if (!isConnectionElement && !isColumnItem) {
        ds_exitConnectMode();
    }
}

function ds_exitConnectMode() {
    ds_schemaBuilderState.connectMode = null;

    // Remove highlight classes
    document.querySelectorAll('#dsSchemaCardsContainer .schema-connection-dot, #dsSchemaCardsContainer .schema-connection-plus').forEach(el => {
        el.classList.remove('connect-mode', 'connect-mode-target');
    });

    // Remove hover listeners
    document.querySelectorAll('#dsSchemaCardsContainer .schema-column-item').forEach(item => {
        item.removeEventListener('mouseenter', ds_handleTargetColumnHover);
        item.removeEventListener('mouseleave', ds_handleTargetColumnLeave);
    });

    // Remove event listeners
    document.removeEventListener('keydown', ds_handleConnectModeKeydown);
    document.removeEventListener('click', ds_handleConnectModeOutsideClick, true);

    // Hide popover
    ds_hideColumnInfoPopover();
}

function ds_createJoin(leftTable, leftCol, rightTable, rightCol) {
    console.log('[DS Join] Creating join - Input:', { leftTable, leftCol, rightTable, rightCol });
    console.log('[DS Join] Primary table:', ds_wizardData.primaryTable);

    // Ensure primary table is always on the left
    if (leftTable !== ds_wizardData.primaryTable && rightTable === ds_wizardData.primaryTable) {
        [leftTable, leftCol, rightTable, rightCol] = [rightTable, rightCol, leftTable, leftCol];
        console.log('[DS Join] Swapped to:', { leftTable, leftCol, rightTable, rightCol });
    }

    // Check if join already exists for this secondary table
    const existingIndex = ds_schemaBuilderState.joins.findIndex(j =>
        j.rightTable === rightTable
    );

    const joinData = {
        leftTable,
        leftCol,
        rightTable,
        rightCol,
        type: 'left',
        warning: null  // Will be populated if join key is not unique
    };

    console.log('[DS Join] Final join data:', joinData);

    if (existingIndex >= 0) {
        // Update existing join
        ds_schemaBuilderState.joins[existingIndex] = joinData;
    } else {
        // Add new join
        ds_schemaBuilderState.joins.push(joinData);
    }

    ds_renderTableCards();
    ds_refreshPreview();
}

function ds_removeJoin(index) {
    ds_schemaBuilderState.joins.splice(index, 1);
    ds_renderTableCards();
    ds_refreshPreview();
    ds_hideJoinPopover();
}

function ds_setJoinType(type) {
    if (ds_schemaBuilderState.selectedJoinIndex !== null) {
        ds_schemaBuilderState.joins[ds_schemaBuilderState.selectedJoinIndex].type = type;
        ds_refreshPreview();
        ds_hideJoinPopover();
    }
}

function ds_removeSelectedJoin() {
    if (ds_schemaBuilderState.selectedJoinIndex !== null) {
        ds_removeJoin(ds_schemaBuilderState.selectedJoinIndex);
    }
}

function ds_showJoinPopover(index, clientX, clientY) {
    ds_schemaBuilderState.selectedJoinIndex = index;
    const popover = document.getElementById('dsJoinPopover');
    const join = ds_schemaBuilderState.joins[index];

    // Update active state for join type options
    popover.querySelectorAll('.join-popover-option[data-type]').forEach(opt => {
        opt.classList.toggle('active', opt.dataset.type === join.type);
    });

    // Show/hide warning section
    const warningEl = document.getElementById('dsJoinPopoverWarning');
    const warningTextEl = document.getElementById('dsJoinPopoverWarningText');
    if (join.warning) {
        warningEl.classList.remove('hidden');
        warningTextEl.textContent = join.warning;
    } else {
        warningEl.classList.add('hidden');
    }

    // Use fixed positioning with viewport coordinates
    popover.style.position = 'fixed';
    popover.style.left = clientX + 'px';
    popover.style.top = clientY + 'px';
    popover.classList.remove('hidden');

    // Ensure popover stays within viewport
    const rect = popover.getBoundingClientRect();
    if (rect.right > window.innerWidth) {
        popover.style.left = (clientX - rect.width) + 'px';
    }
    if (rect.bottom > window.innerHeight) {
        popover.style.top = (clientY - rect.height) + 'px';
    }

    // Add click-outside listener to close popover (delayed to avoid immediate trigger)
    setTimeout(() => {
        document.addEventListener('click', ds_handleJoinPopoverOutsideClick, true);
    }, 0);
}

function ds_hideJoinPopover() {
    ds_schemaBuilderState.selectedJoinIndex = null;
    document.getElementById('dsJoinPopover').classList.add('hidden');
    document.removeEventListener('click', ds_handleJoinPopoverOutsideClick, true);
}

// Handle click outside join popover to close it
function ds_handleJoinPopoverOutsideClick(event) {
    const popover = document.getElementById('dsJoinPopover');
    if (!popover.contains(event.target)) {
        ds_hideJoinPopover();
    }
}

// =============================================================================
// DATASET WIZARD - Step 3: SVG Connection Lines
// =============================================================================

function ds_updateConnectionLines() {
    const svg = document.getElementById('dsConnectionsSvg');
    const cardsArea = document.getElementById('dsSchemaCardsArea');

    if (!svg || !cardsArea) return;

    // Clear existing lines
    svg.innerHTML = '';

    // Reset all connection dot colors first
    document.querySelectorAll('#dsSchemaCardsContainer .schema-connection-dot.connected').forEach(dot => {
        dot.style.borderColor = '';
        dot.style.backgroundColor = '';
    });

    // Draw lines for each join
    ds_schemaBuilderState.joins.forEach((join, index) => {
        // Get the card elements
        const leftCard = document.querySelector(`#dsSchemaCardsContainer .schema-table-card[data-table="${join.leftTable}"]`);
        const rightCard = document.querySelector(`#dsSchemaCardsContainer .schema-table-card[data-table="${join.rightTable}"]`);

        if (leftCard && rightCard) {
            const areaRect = cardsArea.getBoundingClientRect();

            // Determine which side each card should connect from
            const sides = ds_getConnectionSides(leftCard, rightCard);

            // Get column-level anchor points
            const leftAnchor = ds_getColumnAnchorPoint(join.leftTable, join.leftCol, sides.leftSide, areaRect, cardsArea);
            const rightAnchor = ds_getColumnAnchorPoint(join.rightTable, join.rightCol, sides.rightSide, areaRect, cardsArea);

            // If we couldn't find the columns, fall back to card-level connection
            if (!leftAnchor || !rightAnchor) {
                const leftCardRect = leftCard.getBoundingClientRect();
                const rightCardRect = rightCard.getBoundingClientRect();
                const connection = ds_calculateBestConnectionPoints(leftCardRect, rightCardRect, areaRect, cardsArea);
                ds_drawConnectionLine(svg, connection.x1, connection.y1, connection.x2, connection.y2, index, areaRect, false, false, null, null);
                return;
            }

            // Get color for this join
            const color = DS_JOIN_COLORS[index % DS_JOIN_COLORS.length];

            // Draw the connection line (pass warning info)
            const hasWarning = join.warning !== null;
            ds_drawConnectionLine(svg, leftAnchor.x, leftAnchor.y, rightAnchor.x, rightAnchor.y, index, areaRect,
                leftAnchor.isClipped, rightAnchor.isClipped, leftAnchor.clipDirection, rightAnchor.clipDirection, hasWarning);

            // Color the connection dots
            const leftDot = document.querySelector(`#dsSchemaCardsContainer .schema-connection-dot[data-table="${join.leftTable}"][data-column="${join.leftCol}"]`);
            const rightDot = document.querySelector(`#dsSchemaCardsContainer .schema-connection-dot[data-table="${join.rightTable}"][data-column="${join.rightCol}"]`);

            if (leftDot) {
                leftDot.style.borderColor = color;
                leftDot.style.backgroundColor = color;
            }
            if (rightDot) {
                rightDot.style.borderColor = color;
                rightDot.style.backgroundColor = color;
            }
        }
    });
}

// Determine which side each card should connect from based on relative positions
function ds_getConnectionSides(leftCard, rightCard) {
    const leftRect = leftCard.getBoundingClientRect();
    const rightRect = rightCard.getBoundingClientRect();

    const leftCenterX = leftRect.left + leftRect.width / 2;
    const rightCenterX = rightRect.left + rightRect.width / 2;

    if (leftCenterX < rightCenterX) {
        // Left card is actually on the left
        return { leftSide: 'right', rightSide: 'left' };
    } else {
        // Left card is actually on the right
        return { leftSide: 'left', rightSide: 'right' };
    }
}

// Get anchor point for a column, handling scrolled/clipped columns
function ds_getColumnAnchorPoint(table, column, side, areaRect, cardsArea) {
    const shortName = table.replace('raw_data.', '');
    const card = document.getElementById(`dsCard_${shortName}`);
    const columnEl = document.querySelector(`#dsSchemaCardsContainer .schema-column-item[data-table="${table}"][data-column="${column}"]`);

    if (!card || !columnEl) {
        return null;
    }

    const cardRect = card.getBoundingClientRect();
    const columnRect = columnEl.getBoundingClientRect();

    // Find the scrollable column list container
    const columnList = card.querySelector('.schema-column-list');
    const listRect = columnList ? columnList.getBoundingClientRect() : cardRect;

    // Determine X coordinate based on which side to connect
    const x = side === 'right' ? cardRect.right : cardRect.left;

    // Calculate column's vertical center
    const columnCenterY = columnRect.top + columnRect.height / 2;

    // Check if column is visible within the scrollable area
    let y = columnCenterY;
    let isClipped = false;
    let clipDirection = null;

    if (columnList) {
        if (columnRect.bottom < listRect.top) {
            // Column is scrolled above visible area
            y = listRect.top + 10;
            isClipped = true;
            clipDirection = 'up';
        } else if (columnRect.top > listRect.bottom) {
            // Column is scrolled below visible area
            y = listRect.bottom - 10;
            isClipped = true;
            clipDirection = 'down';
        } else if (columnRect.top < listRect.top) {
            // Column is partially clipped at top
            y = listRect.top + 5;
            isClipped = true;
            clipDirection = 'up';
        } else if (columnRect.bottom > listRect.bottom) {
            // Column is partially clipped at bottom
            y = listRect.bottom - 5;
            isClipped = true;
            clipDirection = 'down';
        }
    }

    // Convert to SVG coordinates (relative to cards area)
    return {
        x: x - areaRect.left + cardsArea.scrollLeft,
        y: y - areaRect.top + cardsArea.scrollTop,
        isClipped,
        clipDirection
    };
}

function ds_calculateBestConnectionPoints(rect1, rect2, areaRect, cardsArea) {
    // Calculate centers of each card
    const center1 = {
        x: rect1.left + rect1.width / 2,
        y: rect1.top + rect1.height / 2
    };
    const center2 = {
        x: rect2.left + rect2.width / 2,
        y: rect2.top + rect2.height / 2
    };

    // Determine which edges to connect based on relative positions
    let x1, y1, x2, y2;

    // Horizontal distance vs vertical distance
    const dx = center2.x - center1.x;
    const dy = center2.y - center1.y;

    if (Math.abs(dx) > Math.abs(dy)) {
        // Cards are more horizontal - connect left/right edges
        if (dx > 0) {
            // Card 2 is to the right of Card 1
            x1 = rect1.right;
            y1 = center1.y;
            x2 = rect2.left;
            y2 = center2.y;
        } else {
            // Card 2 is to the left of Card 1
            x1 = rect1.left;
            y1 = center1.y;
            x2 = rect2.right;
            y2 = center2.y;
        }
    } else {
        // Cards are more vertical - connect top/bottom edges
        if (dy > 0) {
            // Card 2 is below Card 1
            x1 = center1.x;
            y1 = rect1.bottom;
            x2 = center2.x;
            y2 = rect2.top;
        } else {
            // Card 2 is above Card 1
            x1 = center1.x;
            y1 = rect1.top;
            x2 = center2.x;
            y2 = rect2.bottom;
        }
    }

    // Convert to SVG coordinates (relative to cards area)
    return {
        x1: x1 - areaRect.left + cardsArea.scrollLeft,
        y1: y1 - areaRect.top + cardsArea.scrollTop,
        x2: x2 - areaRect.left + cardsArea.scrollLeft,
        y2: y2 - areaRect.top + cardsArea.scrollTop
    };
}

// Draw a connection line with optional arrow indicators for clipped columns
function ds_drawConnectionLine(svg, x1, y1, x2, y2, index, areaRect, leftClipped, rightClipped, leftClipDir, rightClipDir, hasWarning = false) {
    const color = hasWarning ? '#f59e0b' : DS_JOIN_COLORS[index % DS_JOIN_COLORS.length]; // Orange for warning
    const cardsArea = document.getElementById('dsSchemaCardsArea');

    // Create a curved path for better visibility
    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    const d = ds_createCurvedPath(x1, y1, x2, y2);
    path.setAttribute('d', d);
    path.setAttribute('class', hasWarning ? 'join-line join-line-warning' : 'join-line');
    path.setAttribute('stroke', color);
    path.setAttribute('fill', 'none');
    if (hasWarning) {
        path.setAttribute('stroke-dasharray', '8,4'); // Dashed line for warning
        path.setAttribute('stroke-width', '3');
    }
    path.style.pointerEvents = 'stroke';
    path.onclick = (e) => {
        e.stopPropagation();
        ds_showJoinPopover(index, e.clientX, e.clientY);
    };

    svg.appendChild(path);

    // Add circles or arrows at connection points
    if (leftClipped && leftClipDir) {
        ds_drawClipArrow(svg, x1, y1, leftClipDir, color);
    } else {
        const circle1 = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle1.setAttribute('cx', x1);
        circle1.setAttribute('cy', y1);
        circle1.setAttribute('r', 4);
        circle1.setAttribute('fill', color);
        svg.appendChild(circle1);
    }

    if (rightClipped && rightClipDir) {
        ds_drawClipArrow(svg, x2, y2, rightClipDir, color);
    } else {
        const circle2 = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle2.setAttribute('cx', x2);
        circle2.setAttribute('cy', y2);
        circle2.setAttribute('r', 4);
        circle2.setAttribute('fill', color);
        svg.appendChild(circle2);
    }
}

// Draw an arrow indicator for clipped columns
function ds_drawClipArrow(svg, x, y, direction, color) {
    const arrow = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    const size = 6;

    let d;
    if (direction === 'up') {
        // Upward arrow ()
        d = `M ${x} ${y - size} L ${x - size} ${y + size} L ${x + size} ${y + size} Z`;
    } else {
        // Downward arrow ()
        d = `M ${x} ${y + size} L ${x - size} ${y - size} L ${x + size} ${y - size} Z`;
    }

    arrow.setAttribute('d', d);
    arrow.setAttribute('fill', color);
    arrow.setAttribute('class', 'clip-arrow');
    svg.appendChild(arrow);
}

function ds_createCurvedPath(x1, y1, x2, y2) {
    // Create a smooth bezier curve between the two points
    const midX = (x1 + x2) / 2;
    const midY = (y1 + y2) / 2;

    // Calculate control points for a smooth curve
    const dx = x2 - x1;
    const dy = y2 - y1;

    // Curve amount based on distance
    const curveAmount = Math.min(Math.abs(dx), Math.abs(dy)) * 0.3;

    let cx1, cy1, cx2, cy2;

    if (Math.abs(dx) > Math.abs(dy)) {
        // Horizontal connection - curve vertically
        cx1 = x1 + dx * 0.3;
        cy1 = y1;
        cx2 = x2 - dx * 0.3;
        cy2 = y2;
    } else {
        // Vertical connection - curve horizontally
        cx1 = x1;
        cy1 = y1 + dy * 0.3;
        cx2 = x2;
        cy2 = y2 - dy * 0.3;
    }

    return `M ${x1} ${y1} C ${cx1} ${cy1}, ${cx2} ${cy2}, ${x2} ${y2}`;
}

// =============================================================================
// DATASET WIZARD - Step 4: Filters (Simplified)
// =============================================================================

function ds_toggleSubchapter(name) {
    const content = document.getElementById(`ds${name.charAt(0).toUpperCase() + name.slice(1)}Content`);
    const chevron = document.getElementById(`ds${name.charAt(0).toUpperCase() + name.slice(1)}Chevron`);

    if (!content) return;

    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        if (chevron) chevron.classList.add('expanded');
    } else {
        content.classList.add('hidden');
        if (chevron) chevron.classList.remove('expanded');
    }
}

// Track active filter mode: 'rolling' or 'startDate'
let ds_historyFilterMode = 'rolling';
let ds_activeFilterPopup = null;

// Dates Filter State Management
let ds_datesFilterState = {
    pending: {
        timestampColumn: null,
        mode: 'rolling',
        rollingDays: 30,
        startDate: null
    },
    committed: {
        timestampColumn: null,
        mode: 'rolling',
        rollingDays: 30,
        startDate: null
    }
};

function ds_toggleFilterPopup(popupName) {
    // Build the correct ID: rollingWindow -> dsRollingWindowPopup
    const popupId = `ds${popupName.charAt(0).toUpperCase() + popupName.slice(1)}Popup`;
    const buttonId = `ds${popupName.charAt(0).toUpperCase() + popupName.slice(1)}Btn`;
    const popup = document.getElementById(popupId);
    const button = document.getElementById(buttonId);

    if (!popup || !button) return;

    // Don't open popup if button is disabled
    if (button.disabled) {
        return;
    }

    // Close any other open popups
    document.querySelectorAll('.filter-popup.show').forEach(p => {
        if (p.id !== popupId) {
            p.classList.remove('show');
        }
    });
    document.querySelectorAll('.filter-button.active').forEach(b => {
        if (b.id !== buttonId) {
            b.classList.remove('active');
        }
    });

    // Toggle current popup
    if (popup.classList.contains('show')) {
        popup.classList.remove('show');
        button.classList.remove('active');
        ds_activeFilterPopup = null;
    } else {
        // Position popup below the button using fixed positioning
        const buttonRect = button.getBoundingClientRect();
        popup.style.top = (buttonRect.bottom + 8) + 'px';
        popup.style.left = buttonRect.left + 'px';

        popup.classList.add('show');
        button.classList.add('active');
        ds_activeFilterPopup = popupName;

        // If opening start date popup, set default to today
        if (popupName === 'startDate') {
            const startDateInput = document.getElementById('dsStartDateInput');
            if (startDateInput && !startDateInput.value) {
                startDateInput.value = new Date().toISOString().split('T')[0];
            }
        }
    }
}

function ds_closeFilterPopup(popupName) {
    const popupId = `ds${popupName.charAt(0).toUpperCase() + popupName.slice(1)}Popup`;
    const buttonId = `ds${popupName.charAt(0).toUpperCase() + popupName.slice(1)}Btn`;
    const popup = document.getElementById(popupId);
    const button = document.getElementById(buttonId);

    if (popup) popup.classList.remove('show');
    if (button) button.classList.remove('active');
    if (ds_activeFilterPopup === popupName) {
        ds_activeFilterPopup = null;
    }
}

// Close popups when clicking outside
document.addEventListener('click', function(e) {
    if (ds_activeFilterPopup && !e.target.closest('.filter-button-wrapper')) {
        ds_closeFilterPopup(ds_activeFilterPopup);
    }
});

function ds_onTimestampColumnChange() {
    ds_updateDatesRefreshButtonState();
    ds_updateDatesFilterSummary();
    ds_validateCurrentStep();
}

function ds_onRollingDaysChange() {
    ds_historyFilterMode = 'rolling';
    ds_updateDatesRefreshButtonState();
    ds_updateDatesFilterSummary();
    ds_validateCurrentStep();
}

function ds_onStartDateChange() {
    ds_historyFilterMode = 'startDate';
    ds_updateDatesRefreshButtonState();
    ds_updateDatesFilterSummary();
    ds_validateCurrentStep();
}

function ds_applyRollingWindow() {
    ds_historyFilterMode = 'rolling';
    ds_closeFilterPopup('rollingWindow');
    ds_updateDatesRefreshButtonState();
    ds_updateDatesFilterSummary();
    ds_validateCurrentStep();
}

// Get current pending dates filter state from UI elements
function ds_getDatesFilterPendingState() {
    return {
        timestampColumn: document.getElementById('dsTimestampColumn')?.value || null,
        mode: ds_historyFilterMode,
        rollingDays: parseInt(document.getElementById('dsRollingDays')?.value) || 30,
        startDate: document.getElementById('dsStartDateInput')?.value || null
    };
}

// Update Dates Refresh Dataset button state
function ds_updateDatesRefreshButtonState() {
    const refreshBtn = document.getElementById('dsRefreshDatasetBtn');
    if (!refreshBtn) return;

    // Get current pending state from UI
    const pendingState = ds_getDatesFilterPendingState();

    // Enable button if pending state differs from committed state
    const pendingJson = JSON.stringify(pendingState);
    const committedJson = JSON.stringify(ds_datesFilterState.committed);
    const hasChanges = pendingJson !== committedJson;

    // Also need a timestamp column selected to enable
    const hasTimestamp = !!pendingState.timestampColumn;

    const shouldEnable = hasTimestamp && hasChanges;

    refreshBtn.disabled = !shouldEnable;
    refreshBtn.classList.toggle('filter-button-disabled', !shouldEnable);
}

// =============================================================================
// CONSOLIDATED FILTER RESTORE (matches original model_dataset.html)
// =============================================================================

/**
 * Restore ALL filter states from saved dataset configuration.
 * Called when entering Step 4 in edit mode.
 * This is the consolidated function matching original restoreFiltersFromSavedData().
 *
 * @param {Object} filters - The saved filters from ds_wizardData.filters
 */
function ds_restoreFiltersFromSavedData(filters) {
    if (!filters || Object.keys(filters).length === 0) {
        console.log('[DS Restore] No filters to restore');
        return;
    }

    console.log('[DS Restore] Restoring filters from saved data:', filters);

    // ===========================================
    // 1. RESTORE DATES FILTER
    // ===========================================
    if (filters.history) {
        const history = filters.history;
        console.log('[DS Restore] Restoring history filter:', history);

        // Set UI elements
        const timestampSelect = document.getElementById('dsTimestampColumn');
        if (timestampSelect && history.timestamp_column) {
            // Try to find the option - may need to match with or without table prefix
            let found = false;
            for (let i = 0; i < timestampSelect.options.length; i++) {
                const optVal = timestampSelect.options[i].value;
                if (optVal === history.timestamp_column ||
                    optVal.endsWith('.' + history.timestamp_column.split('.').pop())) {
                    timestampSelect.selectedIndex = i;
                    found = true;
                    console.log('[DS Restore] Found timestamp column option:', optVal);
                    break;
                }
            }
            if (!found) {
                console.warn('[DS Restore] Could not find timestamp column in dropdown:', history.timestamp_column);
            }
        }

        const rollingDaysInput = document.getElementById('dsRollingDays');
        if (rollingDaysInput && history.rolling_days) {
            rollingDaysInput.value = history.rolling_days;
        }

        const startDateInput = document.getElementById('dsStartDateInput');
        if (history.start_date) {
            ds_historyFilterMode = 'startDate';
            if (startDateInput) startDateInput.value = history.start_date;
        } else {
            ds_historyFilterMode = 'rolling';
        }

        // Set committed state - use the actual dropdown value
        const actualTimestampValue = timestampSelect?.value || history.timestamp_column;
        ds_datesFilterState.committed = {
            timestampColumn: actualTimestampValue || null,
            mode: history.start_date ? 'startDate' : 'rolling',
            rollingDays: history.rolling_days || 30,
            startDate: history.start_date || null
        };
        // Copy to pending so "no changes" state is detected
        ds_datesFilterState.pending = {...ds_datesFilterState.committed};

        // Update UI state
        ds_updateDatesFilterStatus();  // Update header badge
        ds_updateDatesFilterSummary();
        ds_updateDatesRefreshButtonState();
    }

    // ===========================================
    // 2. RESTORE PRODUCTS FILTER
    // ===========================================
    if (filters.product_filter || filters.products) {
        const productFilter = filters.product_filter || {};
        const legacyProducts = filters.products || {};
        console.log('[DS Restore] Restoring product filter:', productFilter);

        // Handle top_revenue filter
        if (productFilter.top_revenue?.enabled || productFilter.top_revenue?.product_column || legacyProducts.product_column) {
            const topRevenue = productFilter.top_revenue || {};

            ds_productFiltersState.committed.topRevenue = {
                enabled: true,
                productColumn: topRevenue.product_column || legacyProducts.product_column,
                revenueColumn: topRevenue.revenue_column || legacyProducts.revenue_column,
                thresholdPercent: topRevenue.threshold_percent || topRevenue.percent || legacyProducts.threshold_percent || 80
            };
        }

        // Handle aggregation filters
        if (productFilter.aggregation_filters?.length > 0) {
            ds_productFiltersState.committed.aggregationFilters = productFilter.aggregation_filters.map(f => ({
                type: f.type,
                productColumn: f.product_column,
                amountColumn: f.amount_column,
                filterType: f.filter_type,
                value: f.value,
                min: f.min,
                max: f.max
            }));
        }

        // Handle category filters
        if (productFilter.category_filters?.length > 0) {
            ds_productFiltersState.committed.categoryFilters = productFilter.category_filters.map(f => ({
                column: f.column,
                mode: f.mode,
                values: f.values || []
            }));
        }

        // Handle numeric filters
        if (productFilter.numeric_filters?.length > 0) {
            ds_productFiltersState.committed.numericFilters = productFilter.numeric_filters.map(f => ({
                column: f.column,
                type: f.type,
                min: f.min,
                max: f.max,
                value: f.value,
                includeNulls: f.include_nulls
            }));
        }

        // Handle date filters
        if (productFilter.date_filters?.length > 0) {
            ds_productFiltersState.committed.dateFilters = productFilter.date_filters.map(f => ({
                column: f.column,
                type: f.type,
                value: f.value,
                start: f.start,
                end: f.end
            }));
        }

        // Copy committed to pending (no unapplied changes)
        ds_productFiltersState.pending = JSON.parse(JSON.stringify(ds_productFiltersState.committed));

        // Debug: Log the restored state
        console.log('[DS Restore] Product committed state after restore:', JSON.stringify(ds_productFiltersState.committed, null, 2));

        // Update UI
        ds_updateProductsFilterStatus();
        ds_updateProductsRefreshButtonState();
        ds_updateProductsFilterSummary();
    }

    // ===========================================
    // 3. RESTORE CUSTOMERS FILTER
    // ===========================================
    if (filters.customer_filter) {
        const customerFilter = filters.customer_filter;
        console.log('[DS Restore] Restoring customer filter:', customerFilter);

        // Handle top_revenue filter
        if (customerFilter.top_revenue) {
            ds_customerFiltersState.committed.topRevenue = {
                enabled: true,
                customerColumn: customerFilter.top_revenue.customer_column,
                revenueColumn: customerFilter.top_revenue.revenue_column,
                thresholdPercent: customerFilter.top_revenue.percent || customerFilter.top_revenue.threshold_percent || 80
            };
        }

        // Handle aggregation filters
        if (customerFilter.aggregation_filters?.length > 0) {
            ds_customerFiltersState.committed.aggregationFilters = customerFilter.aggregation_filters.map(f => ({
                type: f.type,
                customerColumn: f.customer_column,
                amountColumn: f.amount_column,
                filterType: f.filter_type,
                value: f.value,
                min: f.min,
                max: f.max
            }));
        }

        // Handle category filters
        if (customerFilter.category_filters?.length > 0) {
            ds_customerFiltersState.committed.categoryFilters = customerFilter.category_filters.map(f => ({
                column: f.column,
                mode: f.mode,
                values: f.values || []
            }));
        }

        // Handle numeric filters
        if (customerFilter.numeric_filters?.length > 0) {
            ds_customerFiltersState.committed.numericFilters = customerFilter.numeric_filters.map(f => ({
                column: f.column,
                type: f.type || f.filter_type,
                min: f.min,
                max: f.max,
                value: f.value,
                includeNulls: f.include_nulls
            }));
        }

        // Handle date filters
        if (customerFilter.date_filters?.length > 0) {
            ds_customerFiltersState.committed.dateFilters = customerFilter.date_filters.map(f => ({
                column: f.column,
                type: f.type,
                value: f.value,
                start: f.start,
                end: f.end
            }));
        }

        // Copy committed to pending (no unapplied changes)
        ds_customerFiltersState.pending = JSON.parse(JSON.stringify(ds_customerFiltersState.committed));

        // Update UI
        ds_updateCustomersFilterStatus();
        ds_updateCustomersRefreshButtonState();
        ds_updateCustomersFilterSummary();
    }

    console.log('[DS Restore] Filter restoration complete');
}

// Restore dates filter state when editing an existing dataset
function ds_restoreDatesFilterState() {
    const history = ds_wizardData.filters?.history;
    if (!history || !history.timestamp_column) return;

    // Populate UI elements
    const timestampSelect = document.getElementById('dsTimestampColumn');
    const rollingDaysInput = document.getElementById('dsRollingDays');
    const startDateInput = document.getElementById('dsStartDateInput');

    if (timestampSelect) {
        timestampSelect.value = history.timestamp_column;
    }

    // Determine filter mode and populate corresponding input
    if (history.start_date) {
        ds_historyFilterMode = 'startDate';
        if (startDateInput) startDateInput.value = history.start_date;
        if (rollingDaysInput) rollingDaysInput.value = history.rolling_days || 30;
    } else {
        ds_historyFilterMode = 'rolling';
        if (rollingDaysInput) rollingDaysInput.value = history.rolling_days || 30;
    }

    // Set committed state to match saved filters (pending = committed means no changes)
    ds_datesFilterState.committed = {
        timestampColumn: history.timestamp_column,
        mode: history.start_date ? 'startDate' : 'rolling',
        rollingDays: history.rolling_days || 30,
        startDate: history.start_date || null
    };
    // Copy to pending so "no changes" state is detected
    ds_datesFilterState.pending = {...ds_datesFilterState.committed};

    // Update UI state
    ds_updateDatesFilterSummary();
    ds_updateDatesRefreshButtonState();
}

/**
 * Restore product filter state from saved dataset filters.
 * Converts DB format (snake_case) to state format.
 */
function ds_restoreProductFilterState() {
    const productFilter = ds_wizardData.filters?.product_filter;
    if (!productFilter) return;

    // Restore top revenue filter
    if (productFilter.top_revenue) {
        const topRev = productFilter.top_revenue;
        ds_productFiltersState.committed.topRevenue = {
            enabled: topRev.enabled !== false,  // Default to true if exists
            productColumn: topRev.product_column,
            revenueColumn: topRev.revenue_column,
            thresholdPercent: topRev.threshold_percent || topRev.percent || 80
        };
        ds_productFiltersState.pending.topRevenue = {...ds_productFiltersState.committed.topRevenue};
    }

    // Restore category filters
    if (productFilter.category_filters?.length > 0) {
        ds_productFiltersState.committed.categoryFilters = productFilter.category_filters.map(f => ({
            column: f.column,
            mode: f.mode,
            values: f.values || []
        }));
        ds_productFiltersState.pending.categoryFilters = [...ds_productFiltersState.committed.categoryFilters];
    }

    // Restore aggregation filters
    if (productFilter.aggregation_filters?.length > 0) {
        ds_productFiltersState.committed.aggregationFilters = productFilter.aggregation_filters.map(f => ({
            type: f.type,
            productColumn: f.product_column,
            amountColumn: f.amount_column,
            filterType: f.filter_type,
            value: f.value,
            min: f.min,
            max: f.max
        }));
        ds_productFiltersState.pending.aggregationFilters = [...ds_productFiltersState.committed.aggregationFilters];
    }

    // Update UI summary
    ds_updateProductsFilterStatus();
}

/**
 * Restore customer filter state from saved dataset filters.
 * Converts DB format (snake_case) to state format.
 */
function ds_restoreCustomerFilterState() {
    const customerFilter = ds_wizardData.filters?.customer_filter;
    if (!customerFilter) return;

    // Restore top revenue filter
    if (customerFilter.top_revenue) {
        const topRev = customerFilter.top_revenue;
        ds_customerFiltersState.committed.topRevenue = {
            enabled: topRev.enabled !== false,  // Default to true if exists
            customerColumn: topRev.customer_column,
            revenueColumn: topRev.revenue_column,
            thresholdPercent: topRev.threshold_percent || topRev.percent || 80
        };
        ds_customerFiltersState.pending.topRevenue = {...ds_customerFiltersState.committed.topRevenue};
    }

    // Restore category filters
    if (customerFilter.category_filters?.length > 0) {
        ds_customerFiltersState.committed.categoryFilters = customerFilter.category_filters.map(f => ({
            column: f.column,
            mode: f.mode,
            values: f.values || []
        }));
        ds_customerFiltersState.pending.categoryFilters = [...ds_customerFiltersState.committed.categoryFilters];
    }

    // Restore aggregation filters
    if (customerFilter.aggregation_filters?.length > 0) {
        ds_customerFiltersState.committed.aggregationFilters = customerFilter.aggregation_filters.map(f => ({
            type: f.type,
            customerColumn: f.customer_column,
            amountColumn: f.amount_column,
            filterType: f.filter_type,
            value: f.value,
            min: f.min,
            max: f.max
        }));
        ds_customerFiltersState.pending.aggregationFilters = [...ds_customerFiltersState.committed.aggregationFilters];
    }

    // Update UI summary
    ds_updateCustomersFilterStatus();
}

// Update the dates filter summary line
function ds_updateDatesFilterSummary() {
    const summaryItems = document.getElementById('dsDatesFilterSummaryItems');
    if (!summaryItems) return;

    const timestampCol = document.getElementById('dsTimestampColumn')?.value;
    const rollingDays = document.getElementById('dsRollingDays')?.value || 30;
    const startDate = document.getElementById('dsStartDateInput')?.value;

    if (!timestampCol) {
        summaryItems.innerHTML = '<span class="filter-summary-empty">No filters selected</span>';
        return;
    }

    let summaryText = '';
    if (ds_historyFilterMode === 'rolling') {
        summaryText = `Last ${rollingDays} days from ${timestampCol.split('.').pop()}`;
    } else if (ds_historyFilterMode === 'startDate' && startDate) {
        summaryText = `From ${startDate} using ${timestampCol.split('.').pop()}`;
    } else {
        summaryText = `Using ${timestampCol.split('.').pop()}`;
    }

    summaryItems.innerHTML = `<span class="filter-summary-item">${summaryText}</span>`;
}

function ds_refreshDatasetHistory() {
    const timestampCol = document.getElementById('dsTimestampColumn')?.value;
    const rollingDays = document.getElementById('dsRollingDays')?.value || 30;
    const startDate = document.getElementById('dsStartDateInput')?.value;

    if (!timestampCol) {
        alert('Please select a timestamp column first');
        return;
    }

    // Commit the current pending state
    ds_datesFilterState.committed = {
        timestampColumn: timestampCol,
        mode: ds_historyFilterMode,
        rollingDays: parseInt(rollingDays) || 30,
        startDate: startDate || null
    };

    // Save to wizardData.filters for persistence
    ds_wizardData.filters = ds_wizardData.filters || {};
    ds_wizardData.filters.history = {
        timestamp_column: timestampCol,
        rolling_days: parseInt(rollingDays) || 30,
        start_date: startDate || null
    };

    // Refresh dataset stats with current filter settings
    ds_loadDatasetStats(true);

    // Update button state (should become disabled since pending = committed)
    ds_updateDatesRefreshButtonState();

    // Re-validate step 4
    ds_validateCurrentStep();
}

// =============================================================================
// STEP 4 - Column Analysis & Filter Dropdowns
// =============================================================================

/**
 * Fetch column type information for the selected columns.
 * Called when entering Step 4 to enable type-aware filtering.
 */
async function ds_fetchColumnAnalysis() {
    if (!ds_schemaBuilderState.sessionId) return;

    try {
        const response = await fetch(`/api/models/${modelId}/datasets/analyze-columns/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                session_id: ds_schemaBuilderState.sessionId,
                selected_columns: ds_schemaBuilderState.selectedColumns
            })
        });

        const data = await response.json();
        if (data.status === 'success') {
            ds_productFiltersState.columnAnalysis = data.columns;
            ds_customerFiltersState.columnAnalysis = data.columns;
        }
    } catch (error) {
        console.error('Error fetching column analysis:', error);
    }
}

/**
 * Populate filter column dropdowns with selected columns.
 * Timestamp dropdown only shows DATE/DATETIME/TIMESTAMP columns.
 */
function ds_populateFilterColumnDropdowns() {
    // Get all selected columns from schema builder
    const allColumns = [];
    Object.entries(ds_schemaBuilderState.selectedColumns || {}).forEach(([table, cols]) => {
        const shortTable = table.replace('raw_data.', '');
        cols.forEach(col => {
            allColumns.push({
                table: shortTable,
                column: col,
                fullName: `${shortTable}.${col}`
            });
        });
    });

    // Populate timestamp column dropdown (only DATE/TIMESTAMP type columns)
    const timestampSelect = document.getElementById('dsTimestampColumn');
    if (!timestampSelect) return;

    const currentTimestamp = timestampSelect.value;  // Preserve current selection
    timestampSelect.innerHTML = '<option value="">Select column...</option>';

    // Get column type info from analysis cache
    const colAnalysis = ds_productFiltersState.columnAnalysis || ds_customerFiltersState.columnAnalysis || {};
    const dateTypes = ['DATE', 'DATETIME', 'TIMESTAMP', 'TIME'];

    allColumns.forEach(c => {
        // Only show DATE/TIMESTAMP type columns
        const colInfo = colAnalysis[c.fullName];
        const colType = colInfo?.type?.toUpperCase() || '';
        if (!dateTypes.includes(colType)) {
            return;  // Skip non-date columns
        }

        const option = document.createElement('option');
        option.value = c.fullName;
        option.textContent = c.fullName;  // Show full name like "invoices.date"
        // Restore previous selection if it exists
        if (c.fullName === currentTimestamp) option.selected = true;
        timestampSelect.appendChild(option);
    });

    // Also populate product filter dropdowns
    ds_populateProductFilterDropdowns(allColumns);
}

/**
 * Populate product filter dropdowns (product ID and revenue columns).
 */
function ds_populateProductFilterDropdowns(allColumns = null) {
    if (!allColumns) {
        allColumns = [];
        Object.entries(ds_schemaBuilderState.selectedColumns || {}).forEach(([table, cols]) => {
            const shortTable = table.replace('raw_data.', '');
            cols.forEach(col => {
                allColumns.push({
                    table: shortTable,
                    column: col,
                    fullName: `${shortTable}.${col}`
                });
            });
        });
    }

    // Get the timestamp column that's currently selected
    const timestampCol = document.getElementById('dsTimestampColumn')?.value;

    // Get column type info from analysis cache
    const colAnalysis = ds_productFiltersState.columnAnalysis || {};
    const numericTypes = ['INTEGER', 'INT64', 'FLOAT', 'FLOAT64', 'NUMERIC', 'BIGNUMERIC', 'DECIMAL'];

    // Populate product ID dropdown
    const productSelect = document.getElementById('dsProductIdColumn');
    if (productSelect) {
        const currentProduct = productSelect.value;
        productSelect.innerHTML = '<option value="">Select column...</option>';
        allColumns.forEach(c => {
            // Exclude timestamp column
            if (timestampCol && c.fullName === timestampCol) return;

            const option = document.createElement('option');
            option.value = c.fullName;
            option.textContent = c.fullName;
            if (c.fullName === currentProduct) option.selected = true;
            productSelect.appendChild(option);
        });
    }

    // Populate revenue column dropdown (only numeric columns)
    const revenueSelect = document.getElementById('dsRevenueColumn');
    if (revenueSelect) {
        const currentRevenue = revenueSelect.value;
        const productCol = productSelect?.value;

        revenueSelect.innerHTML = '<option value="">Select column...</option>';
        allColumns.forEach(c => {
            // Only show numeric columns for revenue
            const colInfo = colAnalysis[c.fullName];
            const colType = colInfo?.type?.toUpperCase() || '';
            if (!numericTypes.includes(colType)) return;

            // Exclude the selected product column
            if (productCol && c.fullName === productCol) return;
            // Exclude timestamp column
            if (timestampCol && c.fullName === timestampCol) return;

            const option = document.createElement('option');
            option.value = c.fullName;
            option.textContent = c.fullName;
            if (c.fullName === currentRevenue) option.selected = true;
            revenueSelect.appendChild(option);
        });
    }
}

// =============================================================================
// DATASET SUMMARY - Step 4 Statistics
// =============================================================================

/**
 * Load dataset statistics for the Summary panel in Step 4.
 * Called when entering Step 4 or when user clicks "Refresh Dataset".
 *
 * @param {boolean} withFilters - If true, include current filter settings
 */
function ds_loadDatasetStats(withFilters = false) {
    const loadingEl = document.getElementById('dsSummaryLoading');
    const emptyEl = document.getElementById('dsSummaryEmpty');
    const statsEl = document.getElementById('dsSummaryStats');

    // Show loading state
    loadingEl.classList.remove('hidden');
    emptyEl.classList.add('hidden');
    statsEl.classList.add('hidden');

    // Build request payload from wizard state
    const payload = {
        primary_table: ds_wizardData.primaryTable,
        secondary_tables: ds_wizardData.secondaryTables || [],
        selected_columns: ds_schemaBuilderState.selectedColumns || {},
        join_config: ds_convertJoinsToConfig(ds_schemaBuilderState.joins || [])
    };

    // Include filters if requested (for Refresh button)
    if (withFilters) {
        payload.filters = ds_buildFiltersPayload();
    }

    fetch(`/api/models/${modelId}/datasets/stats/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
        loadingEl.classList.add('hidden');

        if (data.status === 'success') {
            ds_datasetStatsData = data;  // Store for snapshot when saving
            ds_renderDatasetStats(data);
            statsEl.classList.remove('hidden');
        } else {
            emptyEl.textContent = data.message || 'Failed to load statistics';
            emptyEl.classList.remove('hidden');
        }
    })
    .catch(err => {
        console.error('Error loading dataset stats:', err);
        loadingEl.classList.add('hidden');
        emptyEl.textContent = 'Failed to load statistics. Please try again.';
        emptyEl.classList.remove('hidden');
    });
}

/**
 * Build filters payload from committed filter states.
 * Uses the COMMITTED state from each sub-chapter (set when user clicks "Refresh Dataset").
 */
function ds_buildFiltersPayload() {
    const filters = {};

    // ===========================================
    // 1. DATE FILTERS (from committed state)
    // ===========================================
    const datesCommitted = ds_datesFilterState.committed;
    if (datesCommitted.timestampColumn) {
        filters.timestamp_column = datesCommitted.timestampColumn;

        if (datesCommitted.mode === 'rolling') {
            filters.date_filter = { type: 'rolling', days: datesCommitted.rollingDays };
        } else if (datesCommitted.mode === 'startDate' && datesCommitted.startDate) {
            filters.date_filter = { type: 'fixed', start_date: datesCommitted.startDate };
        }
    }

    // ===========================================
    // 2. CUSTOMER FILTERS (from committed state)
    // ===========================================
    const customerCommitted = ds_customerFiltersState.committed;
    const customerFilter = {};

    // Top customers by revenue (nested structure expected by API)
    if (customerCommitted.topRevenue?.enabled) {
        customerFilter.top_revenue = {
            customer_column: customerCommitted.topRevenue.customerColumn,
            revenue_column: customerCommitted.topRevenue.revenueColumn,
            percent: customerCommitted.topRevenue.thresholdPercent
        };
    }

    // Aggregation filters (transaction count, spending)
    if (customerCommitted.aggregationFilters?.length > 0) {
        customerFilter.aggregation_filters = customerCommitted.aggregationFilters.map(f => ({
            type: f.type,
            customer_column: f.customerColumn,
            amount_column: f.amountColumn || null,
            filter_type: f.filterType,
            value: f.value,
            min: f.min,
            max: f.max
        }));
    }

    // Category filters
    if (customerCommitted.categoryFilters?.length > 0) {
        customerFilter.category_filters = customerCommitted.categoryFilters.map(f => ({
            column: f.column,
            mode: f.mode,
            values: f.values
        }));
    }

    // Numeric filters
    if (customerCommitted.numericFilters?.length > 0) {
        customerFilter.numeric_filters = customerCommitted.numericFilters.map(f => ({
            column: f.column,
            type: f.type,
            min: f.min,
            max: f.max,
            value: f.value,
            include_nulls: f.includeNulls
        }));
    }

    if (Object.keys(customerFilter).length > 0) {
        filters.customer_filter = customerFilter;
    }

    // ===========================================
    // 3. PRODUCT FILTERS (from committed state)
    // ===========================================
    const productCommitted = ds_productFiltersState.committed;
    const productFilter = {};

    // Top products by revenue (nested structure expected by API)
    if (productCommitted.topRevenue?.enabled) {
        productFilter.top_revenue = {
            enabled: true,
            product_column: productCommitted.topRevenue.productColumn,
            revenue_column: productCommitted.topRevenue.revenueColumn,
            threshold_percent: productCommitted.topRevenue.thresholdPercent
        };
    }

    // Aggregation filters (transaction count, total revenue)
    if (productCommitted.aggregationFilters?.length > 0) {
        productFilter.aggregation_filters = productCommitted.aggregationFilters.map(f => ({
            type: f.type,
            product_column: f.productColumn,
            amount_column: f.amountColumn || null,
            filter_type: f.filterType,
            value: f.value,
            min: f.min,
            max: f.max
        }));
    }

    // Category filters
    if (productCommitted.categoryFilters?.length > 0) {
        productFilter.category_filters = productCommitted.categoryFilters.map(f => ({
            column: f.column,
            mode: f.mode,
            values: f.values
        }));
    }

    // Numeric filters
    if (productCommitted.numericFilters?.length > 0) {
        productFilter.numeric_filters = productCommitted.numericFilters.map(f => ({
            column: f.column,
            type: f.type,
            min: f.min,
            max: f.max,
            value: f.value,
            include_nulls: f.includeNulls
        }));
    }

    if (Object.keys(productFilter).length > 0) {
        filters.product_filter = productFilter;
    }

    // Debug: Log what we're building
    console.log('[DS BuildFilters] Product state check:', {
        topRevenueEnabled: ds_productFiltersState.committed.topRevenue?.enabled,
        topRevenue: ds_productFiltersState.committed.topRevenue,
        builtProductFilter: productFilter
    });
    console.log('[DS BuildFilters] Final filters payload:', JSON.stringify(filters, null, 2));

    return Object.keys(filters).length > 0 ? filters : null;
}

/**
 * Render dataset statistics in the Summary panel.
 * Matches the original model_dataset.html design.
 */
function ds_renderDatasetStats(data) {
    const filters = data.filters_applied || {};
    const summary = data.summary || {};
    const columnStats = data.column_stats || {};

    // --- Total Rows Badge in Header ---
    const totalRowsBadge = document.getElementById('dsSummaryTotalRowsBadge');
    if (summary.total_rows) {
        totalRowsBadge.textContent = `${summary.total_rows.toLocaleString()} rows`;
    } else {
        totalRowsBadge.textContent = '';
    }

    // --- Filter Badges ---
    const datesBadge = document.getElementById('dsFilterBadgeDates');
    const customersBadge = document.getElementById('dsFilterBadgeCustomers');
    const productsBadge = document.getElementById('dsFilterBadgeProducts');

    // Dates filter
    if (filters.dates?.type === 'rolling') {
        document.getElementById('dsFilterBadgeDatesText').textContent = `Last ${filters.dates.days} days`;
        datesBadge.classList.add('filter-active');
    } else if (filters.dates?.type === 'fixed') {
        document.getElementById('dsFilterBadgeDatesText').textContent = `From ${filters.dates.start_date}`;
        datesBadge.classList.add('filter-active');
    } else {
        document.getElementById('dsFilterBadgeDatesText').textContent = 'All dates';
        datesBadge.classList.remove('filter-active');
    }

    // Customers filter
    if (filters.customers?.type === 'multiple') {
        const count = filters.customers.count || filters.customers.filters?.length || 0;
        document.getElementById('dsFilterBadgeCustomersText').textContent = count === 1 ? '1 filter' : `${count} filters`;
        customersBadge.classList.add('filter-active');
    } else if (filters.customers?.type && filters.customers.type !== 'none') {
        document.getElementById('dsFilterBadgeCustomersText').textContent = 'Filtered';
        customersBadge.classList.add('filter-active');
    } else {
        document.getElementById('dsFilterBadgeCustomersText').textContent = 'All customers';
        customersBadge.classList.remove('filter-active');
    }

    // Products filter
    if (filters.products?.type === 'multiple') {
        const count = filters.products.count || filters.products.filters?.length || 0;
        document.getElementById('dsFilterBadgeProductsText').textContent = count === 1 ? '1 filter' : `${count} filters`;
        productsBadge.classList.add('filter-active');
    } else if (filters.products?.type === 'top_revenue') {
        document.getElementById('dsFilterBadgeProductsText').textContent = `Top ${filters.products.percent}% revenue`;
        productsBadge.classList.add('filter-active');
    } else if (filters.products?.type && filters.products.type !== 'none') {
        document.getElementById('dsFilterBadgeProductsText').textContent = 'Filtered';
        productsBadge.classList.add('filter-active');
    } else {
        document.getElementById('dsFilterBadgeProductsText').textContent = 'All products';
        productsBadge.classList.remove('filter-active');
    }

    // --- Column Stats Table ---
    const tableBody = document.getElementById('dsColumnStatsTableBody');
    tableBody.innerHTML = '';

    for (const [columnName, stats] of Object.entries(columnStats)) {
        const row = document.createElement('tr');

        // Column name cell (show alias if set, otherwise short column name)
        const nameCell = document.createElement('td');
        const displayName = ds_getColumnDisplayName(columnName);
        nameCell.innerHTML = `<span class="column-name">${ds_escapeHtml(displayName)}</span>`;
        row.appendChild(nameCell);

        // Data type cell
        const typeCell = document.createElement('td');
        typeCell.innerHTML = `<span class="column-type">${stats.type || 'N/A'}</span>`;
        row.appendChild(typeCell);

        // Stats cell
        const statsCell = document.createElement('td');
        statsCell.innerHTML = ds_formatColumnStats(stats);
        row.appendChild(statsCell);

        tableBody.appendChild(row);
    }
}

/**
 * Format column statistics for display in the stats table.
 * Matches the original model_dataset.html formatColumnStats function.
 */
function ds_formatColumnStats(stats) {
    const items = [];

    // Handle different column types
    if (stats.type === 'STRING' || stats.type === 'BYTES') {
        if (stats.unique_count !== undefined) {
            items.push(`<span class="stat-item"><span class="stat-label">Unique:</span> <span class="stat-value">${stats.unique_count.toLocaleString()}</span></span>`);
        }
    } else if (['INT64', 'FLOAT64', 'NUMERIC', 'BIGNUMERIC', 'INTEGER', 'FLOAT'].includes(stats.type)) {
        if (stats.min !== undefined && stats.min !== null) {
            items.push(`<span class="stat-item"><span class="stat-label">Min:</span> <span class="stat-value">${ds_formatNumber(stats.min)}</span></span>`);
        }
        if (stats.max !== undefined && stats.max !== null) {
            items.push(`<span class="stat-item"><span class="stat-label">Max:</span> <span class="stat-value">${ds_formatNumber(stats.max)}</span></span>`);
        }
        if (stats.avg !== undefined && stats.avg !== null) {
            items.push(`<span class="stat-item"><span class="stat-label">Avg:</span> <span class="stat-value">${ds_formatNumber(stats.avg)}</span></span>`);
        }
    } else if (['DATE', 'DATETIME', 'TIMESTAMP'].includes(stats.type)) {
        if (stats.min) {
            items.push(`<span class="stat-item"><span class="stat-label">Min:</span> <span class="stat-value">${stats.min}</span></span>`);
        }
        if (stats.max) {
            items.push(`<span class="stat-item"><span class="stat-label">Max:</span> <span class="stat-value">${stats.max}</span></span>`);
        }
        if (stats.unique_count !== undefined) {
            items.push(`<span class="stat-item"><span class="stat-label">Unique:</span> <span class="stat-value">${stats.unique_count.toLocaleString()}</span></span>`);
        }
    } else if (stats.type === 'BOOL') {
        if (stats.true_count !== undefined) {
            items.push(`<span class="stat-item"><span class="stat-label">True:</span> <span class="stat-value">${stats.true_count.toLocaleString()}</span></span>`);
        }
        if (stats.false_count !== undefined) {
            items.push(`<span class="stat-item"><span class="stat-label">False:</span> <span class="stat-value">${stats.false_count.toLocaleString()}</span></span>`);
        }
    }

    // Add null count if present
    if (stats.null_count !== undefined && stats.null_count > 0) {
        const nullPercent = stats.null_percent !== undefined ? ` (${stats.null_percent.toFixed(1)}%)` : '';
        items.push(`<span class="stat-item"><span class="stat-label">Nulls:</span> <span class="stat-value">${stats.null_count.toLocaleString()}${nullPercent}</span></span>`);
    }

    return items.length > 0 ? `<span class="column-stats-details">${items.join('')}</span>` : '<span class="text-gray-400"></span>';
}

// =============================================================================
// FILTER STATE MANAGEMENT (Phase 3)
// =============================================================================

// Analysis data from API calls
let ds_productAnalysisData = null;
let ds_customerAnalysisData = null;

// Modal snapshots for Cancel functionality
let ds_productMetricsModalSnapshot = null;
let ds_customerMetricsModalSnapshot = null;

// Product filters state
let ds_productFiltersState = {
    columnAnalysis: {},
    committed: {
        topRevenue: { enabled: false, productColumn: null, revenueColumn: null, thresholdPercent: 80 },
        categoryFilters: [],
        numericFilters: [],
        dateFilters: [],
        aggregationFilters: []
    },
    pending: {
        topRevenue: { enabled: false, productColumn: null, revenueColumn: null, thresholdPercent: 80 },
        categoryFilters: [],
        numericFilters: [],
        dateFilters: [],
        aggregationFilters: []
    }
};

// Customer filters state
let ds_customerFiltersState = {
    columnAnalysis: {},
    committed: {
        topRevenue: { enabled: false, customerColumn: null, revenueColumn: null, thresholdPercent: 80 },
        categoryFilters: [],
        numericFilters: [],
        dateFilters: [],
        aggregationFilters: []
    },
    pending: {
        topRevenue: { enabled: false, customerColumn: null, revenueColumn: null, thresholdPercent: 80 },
        categoryFilters: [],
        numericFilters: [],
        dateFilters: [],
        aggregationFilters: []
    }
};

// =============================================================================
// TOP PRODUCTS MODAL
// =============================================================================

function ds_openTopProductsModal() {
    const modal = document.getElementById('dsTopProductsModal');
    modal.classList.remove('hidden');

    // Auto-enable top products filter when modal opens
    document.getElementById('dsEnableTopProducts').checked = true;
    ds_productFiltersState.pending.topRevenue.enabled = true;

    // Populate column dropdowns
    ds_populateTopProductsDropdowns();

    // Restore values from pending state if they exist
    const pending = ds_productFiltersState.pending.topRevenue;
    if (pending.productColumn) {
        document.getElementById('dsProductIdColumn').value = pending.productColumn;
    }
    if (pending.revenueColumn) {
        document.getElementById('dsRevenueColumn').value = pending.revenueColumn;
    }
    document.getElementById('dsRevenueThreshold').value = pending.thresholdPercent || 80;

    // Update analyze button state
    ds_updateAnalyzeButtonState();

    // Show analysis results if we have data
    if (ds_productAnalysisData) {
        document.getElementById('dsProductAnalysisResults').classList.remove('hidden');
        ds_drawRevenueDistributionChart(ds_productAnalysisData.distribution, pending.thresholdPercent || 80);
        ds_updateProductSelectionForThreshold(pending.thresholdPercent || 80);
    }
}

function ds_closeTopProductsModal() {
    const modal = document.getElementById('dsTopProductsModal');
    modal.classList.add('hidden');
}

function ds_populateTopProductsDropdowns() {
    const productIdSelect = document.getElementById('dsProductIdColumn');
    const revenueSelect = document.getElementById('dsRevenueColumn');

    // Get selected columns from schema builder
    const columns = [];
    Object.entries(ds_schemaBuilderState.selectedColumns || {}).forEach(([table, cols]) => {
        const shortTable = table.replace('raw_data.', '');
        cols.forEach(col => {
            columns.push({ table: shortTable, column: col, fullName: `${shortTable}.${col}` });
        });
    });

    // Get column types from analysis if available
    const colAnalysis = ds_productFiltersState.columnAnalysis || {};

    // Get timestamp column to exclude
    const timestampCol = document.getElementById('dsTimestampColumn')?.value;

    // Filter for numeric columns for revenue
    const numericColumns = columns.filter(col => {
        const info = colAnalysis[col.fullName];
        const isNumeric = info?.type && ['INTEGER', 'FLOAT', 'INT64', 'FLOAT64', 'NUMERIC', 'BIGNUMERIC'].includes(info.type.toUpperCase());
        const isTimestamp = timestampCol && col.fullName === timestampCol;
        return isNumeric && !isTimestamp;
    });

    // Populate Product ID dropdown
    productIdSelect.innerHTML = '<option value="">Select column...</option>';
    columns.forEach(col => {
        if (timestampCol && col.fullName === timestampCol) return;
        const option = document.createElement('option');
        option.value = col.fullName;
        option.textContent = ds_getColumnDisplayName(col.fullName);
        productIdSelect.appendChild(option);
    });

    // Populate Revenue dropdown (numeric columns only)
    revenueSelect.innerHTML = '<option value="">Select column...</option>';
    numericColumns.forEach(col => {
        const option = document.createElement('option');
        option.value = col.fullName;
        option.textContent = ds_getColumnDisplayName(col.fullName);
        revenueSelect.appendChild(option);
    });
}

function ds_onProductColumnChange() {
    ds_updateAnalyzeButtonState();
}

function ds_onRevenueColumnChange() {
    ds_updateAnalyzeButtonState();
}

function ds_updateAnalyzeButtonState() {
    const productCol = document.getElementById('dsProductIdColumn')?.value;
    const revenueCol = document.getElementById('dsRevenueColumn')?.value;
    const analyzeBtn = document.getElementById('dsAnalyzeProductsBtn');

    if (productCol && revenueCol) {
        analyzeBtn.disabled = false;
        analyzeBtn.classList.remove('filter-button-disabled');
    } else {
        analyzeBtn.disabled = true;
        analyzeBtn.classList.add('filter-button-disabled');
    }
}

async function ds_analyzeProductRevenue() {
    const productCol = document.getElementById('dsProductIdColumn')?.value;
    const revenueCol = document.getElementById('dsRevenueColumn')?.value;

    if (!productCol || !revenueCol) {
        ds_showProductAnalysisError('Please select both Product ID and Revenue columns');
        return;
    }

    const analyzeBtn = document.getElementById('dsAnalyzeProductsBtn');
    analyzeBtn.disabled = true;
    analyzeBtn.classList.add('filter-button-disabled');
    analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Analyzing...</span>';

    // Build ALL filters from committed state
    // This ensures product analysis respects all applied filters (dates, customers, products)
    const filters = {};
    const datesCommitted = ds_datesFilterState.committed;
    const customerCommitted = ds_customerFiltersState.committed;
    const productCommitted = ds_productFiltersState.committed;

    // Get date filter parameters from committed dates state
    const timestampColumn = datesCommitted.timestampColumn || null;
    const rollingDays = (datesCommitted.mode === 'rolling' && datesCommitted.timestampColumn)
        ? datesCommitted.rollingDays
        : null;

    // Customer category filters (e.g., city, region) - cross-filter
    if (customerCommitted.categoryFilters?.length > 0) {
        filters.customer_filter = filters.customer_filter || {};
        filters.customer_filter.category_filters = customerCommitted.categoryFilters.map(f => ({
            column: f.column,
            mode: f.mode,
            values: f.values
        }));
    }

    // Customer numeric filters - cross-filter
    if (customerCommitted.numericFilters?.length > 0) {
        filters.customer_filter = filters.customer_filter || {};
        filters.customer_filter.numeric_filters = customerCommitted.numericFilters.map(f => ({
            column: f.column,
            filter_type: f.type,
            min: f.min,
            max: f.max,
            value: f.value,
            include_nulls: f.includeNulls
        }));
    }

    // Product category filters (e.g., category, brand) - same-chapter filter
    if (productCommitted.categoryFilters?.length > 0) {
        filters.product_filter = filters.product_filter || {};
        filters.product_filter.category_filters = productCommitted.categoryFilters.map(f => ({
            column: f.column,
            mode: f.mode,
            values: f.values
        }));
    }

    // Product numeric filters - same-chapter filter
    if (productCommitted.numericFilters?.length > 0) {
        filters.product_filter = filters.product_filter || {};
        filters.product_filter.numeric_filters = productCommitted.numericFilters.map(f => ({
            column: f.column,
            filter_type: f.type,
            min: f.min,
            max: f.max,
            value: f.value,
            include_nulls: f.includeNulls
        }));
    }

    try {
        const response = await fetch(`/api/models/${modelId}/datasets/analyze-product-revenue/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                primary_table: ds_wizardData.primaryTable,
                product_column: productCol,
                revenue_column: revenueCol,
                timestamp_column: timestampColumn,
                rolling_days: rollingDays,
                filters: Object.keys(filters).length > 0 ? filters : null
            })
        });

        const data = await response.json();

        if (data.status === 'success') {
            ds_productAnalysisData = data;
            ds_displayProductAnalysisResults(data);

            const resultsEl = document.getElementById('dsProductAnalysisResults');
            const errorEl = document.getElementById('dsProductAnalysisError');
            if (resultsEl) resultsEl.classList.remove('hidden');
            if (errorEl) errorEl.classList.add('hidden');
        } else {
            ds_showProductAnalysisError(data.message || 'Analysis failed');
        }
    } catch (error) {
        console.error('Error analyzing product revenue:', error);
        ds_showProductAnalysisError('Failed to analyze product revenue');
    } finally {
        analyzeBtn.disabled = false;
        analyzeBtn.classList.remove('filter-button-disabled');
        analyzeBtn.innerHTML = '<i class="fas fa-sync-alt"></i><span>Analyze</span>';
    }
}

function ds_displayProductAnalysisResults(data) {
    document.getElementById('dsTotalProductsCount').textContent = data.total_products.toLocaleString();

    const threshold = parseInt(document.getElementById('dsRevenueThreshold')?.value) || 80;
    ds_updateProductSelectionForThreshold(threshold, data);

    // Draw the chart after a small delay to ensure container is visible
    setTimeout(() => {
        ds_drawRevenueDistributionChart(data.distribution, threshold);
    }, 50);
}

function ds_updateProductSelectionForThreshold(threshold, data = null) {
    if (!data) data = ds_productAnalysisData;
    if (!data || !data.distribution) return;

    let productCount = null;
    let productPercent = null;
    for (const point of data.distribution) {
        if (point.cumulative_revenue_percent >= threshold) {
            productCount = point.product_count;
            productPercent = data.total_products > 0
                ? ((point.product_count / data.total_products) * 100).toFixed(0)
                : 0;
            break;
        }
    }

    if (productCount === null && data.distribution.length > 0) {
        const lastPoint = data.distribution[data.distribution.length - 1];
        productCount = lastPoint.product_count;
        productPercent = 100;
    }

    if (productCount !== null) {
        document.getElementById('dsSelectedProductsCount').textContent = productCount.toLocaleString();
        document.getElementById('dsSelectedProductsPercent').textContent = `(${productPercent}%)`;
    }

    document.getElementById('dsRevenueCoverage').textContent = `${threshold}%`;
    document.getElementById('dsRevenueCoverageAmount').textContent =
        `($${(data.total_revenue * threshold / 100 / 1000000).toFixed(1)}M of $${(data.total_revenue / 1000000).toFixed(1)}M)`;
}

function ds_onThresholdChange() {
    const threshold = parseInt(document.getElementById('dsRevenueThreshold')?.value) || 80;

    if (ds_productAnalysisData) {
        ds_updateProductSelectionForThreshold(threshold);
        ds_drawRevenueDistributionChart(ds_productAnalysisData.distribution, threshold);
    }
}

function ds_showProductAnalysisError(message) {
    const resultsEl = document.getElementById('dsProductAnalysisResults');
    const errorEl = document.getElementById('dsProductAnalysisError');
    const errorTextEl = document.getElementById('dsProductAnalysisErrorText');

    if (resultsEl) resultsEl.classList.add('hidden');
    if (errorEl) errorEl.classList.remove('hidden');
    if (errorTextEl) errorTextEl.textContent = message;
}

function ds_applyTopProductsFilter() {
    const productCol = document.getElementById('dsProductIdColumn')?.value;
    const revenueCol = document.getElementById('dsRevenueColumn')?.value;
    const threshold = parseInt(document.getElementById('dsRevenueThreshold')?.value) || 80;

    const isEnabled = productCol && revenueCol;

    ds_productFiltersState.pending.topRevenue = {
        enabled: isEnabled,
        productColumn: productCol || null,
        revenueColumn: revenueCol || null,
        thresholdPercent: threshold
    };

    ds_updateProductsFilterSummary();
    ds_closeTopProductsModal();
}

// =============================================================================
// D3.js REVENUE DISTRIBUTION CHART
// =============================================================================

function ds_drawRevenueDistributionChart(distribution, threshold = 80) {
    const container = document.getElementById('dsRevenueChartContainer');
    if (!container) return;

    // Check if D3 is available
    if (typeof d3 === 'undefined') {
        console.warn('D3.js not loaded, skipping chart render');
        return;
    }

    const svg = d3.select('#dsRevenueDistributionChart');
    if (svg.empty()) return;

    svg.selectAll('*').remove();

    if (!distribution || distribution.length === 0) return;

    const totalProducts = ds_productAnalysisData?.total_products || distribution[distribution.length - 1]?.product_count || 100;
    const totalRevenue = ds_productAnalysisData?.total_revenue || distribution[distribution.length - 1]?.cumulative_revenue || 0;

    const margin = { top: 20, right: 30, bottom: 50, left: 70 };
    const containerWidth = container.clientWidth || container.offsetWidth || 600;
    const width = Math.max(containerWidth - margin.left - margin.right, 200);
    const height = 200 - margin.top - margin.bottom;

    svg.attr('width', width + margin.left + margin.right)
       .attr('height', height + margin.top + margin.bottom);

    const g = svg.append('g')
        .attr('transform', `translate(${margin.left},${margin.top})`);

    const x = d3.scaleLinear()
        .domain([0, totalProducts])
        .range([0, width]);

    const y = d3.scaleLinear()
        .domain([0, totalRevenue])
        .range([height, 0]);

    const formatRevenue = (val) => {
        if (val >= 1000000) return `${(val / 1000000).toFixed(1)}M`;
        if (val >= 1000) return `${(val / 1000).toFixed(0)}K`;
        return val.toFixed(0);
    };

    // Grid lines
    g.append('g')
        .attr('class', 'grid')
        .attr('transform', `translate(0,${height})`)
        .call(d3.axisBottom(x).tickSize(-height).tickFormat('').ticks(Math.min(totalProducts, 10)))
        .style('stroke-dasharray', '3,3')
        .style('stroke-opacity', 0.2);

    g.append('g')
        .attr('class', 'grid')
        .call(d3.axisLeft(y).tickSize(-width).tickFormat('').ticks(5))
        .style('stroke-dasharray', '3,3')
        .style('stroke-opacity', 0.2);

    const line = d3.line()
        .x(d => x(d.product_count))
        .y(d => y(d.cumulative_revenue))
        .curve(d3.curveMonotoneX);

    const chartData = [{ product_count: 0, cumulative_revenue: 0, cumulative_revenue_percent: 0 }, ...distribution];

    g.append('path')
        .datum(chartData)
        .attr('fill', 'none')
        .attr('stroke', '#3b82f6')
        .attr('stroke-width', 2)
        .attr('d', line);

    const thresholdRevenue = totalRevenue * threshold / 100;
    const thresholdPoint = ds_findThresholdPoint(distribution, threshold);

    const area = d3.area()
        .x(d => x(d.product_count))
        .y0(height)
        .y1(d => y(d.cumulative_revenue))
        .curve(d3.curveMonotoneX);

    const areaData = [{ product_count: 0, cumulative_revenue: 0 },
                      ...distribution.filter(d => d.cumulative_revenue_percent <= threshold)];
    if (areaData.length > 1 && thresholdPoint) {
        areaData.push({ product_count: thresholdPoint.productCount, cumulative_revenue: thresholdRevenue });

        g.append('path')
            .datum(areaData)
            .attr('fill', '#3b82f6')
            .attr('fill-opacity', 0.1)
            .attr('d', area);
    }

    // Threshold line (horizontal)
    g.append('line')
        .attr('x1', 0)
        .attr('x2', width)
        .attr('y1', y(thresholdRevenue))
        .attr('y2', y(thresholdRevenue))
        .attr('stroke', '#ef4444')
        .attr('stroke-width', 1.5)
        .attr('stroke-dasharray', '5,5');

    g.append('text')
        .attr('x', width - 5)
        .attr('y', y(thresholdRevenue) - 5)
        .attr('text-anchor', 'end')
        .attr('fill', '#ef4444')
        .attr('font-size', '11px')
        .text(`${threshold}% revenue (${formatRevenue(thresholdRevenue)})`);

    if (thresholdPoint && thresholdPoint.productCount > 0) {
        g.append('line')
            .attr('x1', x(thresholdPoint.productCount))
            .attr('x2', x(thresholdPoint.productCount))
            .attr('y1', y(thresholdRevenue))
            .attr('y2', height)
            .attr('stroke', '#ef4444')
            .attr('stroke-width', 1)
            .attr('stroke-dasharray', '3,3');

        g.append('text')
            .attr('x', x(thresholdPoint.productCount))
            .attr('y', height + 35)
            .attr('text-anchor', 'middle')
            .attr('fill', '#ef4444')
            .attr('font-size', '10px')
            .text(`${Math.ceil(thresholdPoint.productCount)} products`);
    }

    // Axes
    g.append('g')
        .attr('transform', `translate(0,${height})`)
        .call(d3.axisBottom(x).ticks(Math.min(totalProducts, 10)).tickFormat(d => d.toLocaleString()))
        .selectAll('text')
        .style('font-size', '10px');

    g.append('g')
        .call(d3.axisLeft(y).ticks(5).tickFormat(formatRevenue))
        .selectAll('text')
        .style('font-size', '10px');

    // Axis labels
    g.append('text')
        .attr('x', width / 2)
        .attr('y', height + 45)
        .attr('text-anchor', 'middle')
        .attr('fill', '#666')
        .attr('font-size', '11px')
        .text('Products (ranked by revenue)');

    g.append('text')
        .attr('transform', 'rotate(-90)')
        .attr('x', -height / 2)
        .attr('y', -55)
        .attr('text-anchor', 'middle')
        .attr('fill', '#666')
        .attr('font-size', '11px')
        .text('Cumulative Revenue');
}

function ds_findThresholdPoint(distribution, threshold) {
    for (let i = 0; i < distribution.length - 1; i++) {
        if (distribution[i].cumulative_revenue_percent <= threshold &&
            distribution[i + 1].cumulative_revenue_percent >= threshold) {
            const ratio = (threshold - distribution[i].cumulative_revenue_percent) /
                (distribution[i + 1].cumulative_revenue_percent - distribution[i].cumulative_revenue_percent);
            return {
                productCount: distribution[i].product_count +
                    ratio * (distribution[i + 1].product_count - distribution[i].product_count)
            };
        }
    }
    return distribution[distribution.length - 1]
        ? { productCount: distribution[distribution.length - 1].product_count }
        : null;
}

// =============================================================================
// TOP CUSTOMERS MODAL
// =============================================================================

async function ds_openTopCustomersModal() {
    const modal = document.getElementById('dsTopCustomersModal');
    modal.classList.remove('hidden');

    document.getElementById('dsEnableTopCustomers').checked = true;
    ds_customerFiltersState.pending.topRevenue.enabled = true;

    ds_populateTopCustomersDropdowns();

    const pending = ds_customerFiltersState.pending.topRevenue;
    if (pending.customerColumn) {
        document.getElementById('dsCustomerIdColumn').value = pending.customerColumn;
    }
    if (pending.revenueColumn) {
        document.getElementById('dsCustomerRevenueColumn').value = pending.revenueColumn;
    }
    document.getElementById('dsCustomerRevenueThreshold').value = pending.thresholdPercent || 80;

    ds_updateCustomerAnalyzeButtonState();

    if (ds_customerAnalysisData) {
        document.getElementById('dsCustomerAnalysisResults').classList.remove('hidden');
        ds_updateCustomerRevenueChart(pending.thresholdPercent || 80);
    }
}

function ds_closeTopCustomersModal() {
    document.getElementById('dsTopCustomersModal').classList.add('hidden');
}

function ds_populateTopCustomersDropdowns() {
    const customerIdSelect = document.getElementById('dsCustomerIdColumn');
    const revenueSelect = document.getElementById('dsCustomerRevenueColumn');

    const columns = [];
    Object.entries(ds_schemaBuilderState.selectedColumns || {}).forEach(([table, cols]) => {
        const shortTable = table.replace('raw_data.', '');
        cols.forEach(col => {
            columns.push({ table: shortTable, column: col, fullName: `${shortTable}.${col}` });
        });
    });

    const colAnalysis = ds_customerFiltersState.columnAnalysis || {};
    const timestampCol = document.getElementById('dsTimestampColumn')?.value;

    const numericColumns = columns.filter(col => {
        const info = colAnalysis[col.fullName];
        const isNumeric = info?.type && ['INTEGER', 'FLOAT', 'INT64', 'FLOAT64', 'NUMERIC', 'BIGNUMERIC'].includes(info.type.toUpperCase());
        const isTimestamp = timestampCol && col.fullName === timestampCol;
        return isNumeric && !isTimestamp;
    });

    customerIdSelect.innerHTML = '<option value="">Select column...</option>';
    columns.forEach(col => {
        if (timestampCol && col.fullName === timestampCol) return;
        const option = document.createElement('option');
        option.value = col.fullName;
        option.textContent = ds_getColumnDisplayName(col.fullName);
        customerIdSelect.appendChild(option);
    });

    revenueSelect.innerHTML = '<option value="">Select column...</option>';
    numericColumns.forEach(col => {
        const option = document.createElement('option');
        option.value = col.fullName;
        option.textContent = ds_getColumnDisplayName(col.fullName);
        revenueSelect.appendChild(option);
    });
}

function ds_onCustomerColumnChange() {
    ds_updateCustomerAnalyzeButtonState();
}

function ds_onCustomerRevenueColumnChange() {
    ds_updateCustomerAnalyzeButtonState();
}

function ds_updateCustomerAnalyzeButtonState() {
    const customerCol = document.getElementById('dsCustomerIdColumn')?.value;
    const revenueCol = document.getElementById('dsCustomerRevenueColumn')?.value;
    const analyzeBtn = document.getElementById('dsAnalyzeCustomersBtn');

    if (customerCol && revenueCol) {
        analyzeBtn.disabled = false;
        analyzeBtn.classList.remove('filter-button-disabled');
    } else {
        analyzeBtn.disabled = true;
        analyzeBtn.classList.add('filter-button-disabled');
    }
}

async function ds_analyzeCustomerRevenue() {
    const customerCol = document.getElementById('dsCustomerIdColumn').value;
    const revenueCol = document.getElementById('dsCustomerRevenueColumn').value;

    if (!customerCol || !revenueCol) {
        ds_showNotification('Please select both customer ID and revenue columns', 'error');
        return;
    }

    const analyzeBtn = document.getElementById('dsAnalyzeCustomersBtn');
    const originalHtml = analyzeBtn.innerHTML;
    analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
    analyzeBtn.disabled = true;

    // Build ALL filters from committed state
    // This ensures customer analysis respects all applied filters (dates, customers, products)
    const filters = {};
    const datesCommitted = ds_datesFilterState.committed;
    const customerCommitted = ds_customerFiltersState.committed;
    const productCommitted = ds_productFiltersState.committed;

    // Get date filter parameters from committed dates state
    const timestampColumn = datesCommitted.timestampColumn || null;
    const rollingDays = (datesCommitted.mode === 'rolling' && datesCommitted.timestampColumn)
        ? datesCommitted.rollingDays
        : null;

    // Product category filters (e.g., category, brand) - cross-filter
    if (productCommitted.categoryFilters?.length > 0) {
        filters.product_filter = filters.product_filter || {};
        filters.product_filter.category_filters = productCommitted.categoryFilters.map(f => ({
            column: f.column,
            mode: f.mode,
            values: f.values
        }));
    }

    // Product numeric filters - cross-filter
    if (productCommitted.numericFilters?.length > 0) {
        filters.product_filter = filters.product_filter || {};
        filters.product_filter.numeric_filters = productCommitted.numericFilters.map(f => ({
            column: f.column,
            filter_type: f.type,
            min: f.min,
            max: f.max,
            value: f.value,
            include_nulls: f.includeNulls
        }));
    }

    // Customer category filters (e.g., city, region) - same-chapter filter
    // This is critical for filters like city=RIVNE to be applied
    if (customerCommitted.categoryFilters?.length > 0) {
        filters.customer_filter = filters.customer_filter || {};
        filters.customer_filter.category_filters = customerCommitted.categoryFilters.map(f => ({
            column: f.column,
            mode: f.mode,
            values: f.values
        }));
    }

    // Customer numeric filters - same-chapter filter
    if (customerCommitted.numericFilters?.length > 0) {
        filters.customer_filter = filters.customer_filter || {};
        filters.customer_filter.numeric_filters = customerCommitted.numericFilters.map(f => ({
            column: f.column,
            filter_type: f.type,
            min: f.min,
            max: f.max,
            value: f.value,
            include_nulls: f.includeNulls
        }));
    }

    try {
        const response = await fetch(`/api/models/${modelId}/datasets/analyze-customer-revenue/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                session_id: ds_schemaBuilderState.sessionId,
                customer_column: customerCol,
                revenue_column: revenueCol,
                timestamp_column: timestampColumn,
                rolling_days: rollingDays,
                filters: Object.keys(filters).length > 0 ? filters : null
            })
        });

        if (!response.ok) {
            throw new Error(`Analysis failed: ${response.statusText}`);
        }

        const data = await response.json();

        if (data.status === 'error') {
            throw new Error(data.message || 'Analysis failed');
        }

        ds_customerAnalysisData = data;

        ds_customerFiltersState.pending.topRevenue.customerColumn = customerCol;
        ds_customerFiltersState.pending.topRevenue.revenueColumn = revenueCol;

        document.getElementById('dsCustomerAnalysisResults').classList.remove('hidden');
        document.getElementById('dsCustomerAnalysisError').classList.add('hidden');

        ds_renderCustomerRevenueChart(data);

        const threshold = parseInt(document.getElementById('dsCustomerRevenueThreshold').value) || 80;
        ds_updateCustomerRevenueChart(threshold);

    } catch (error) {
        console.error('Customer revenue analysis failed:', error);
        document.getElementById('dsCustomerAnalysisError').classList.remove('hidden');
        document.getElementById('dsCustomerAnalysisErrorText').textContent = error.message;
        document.getElementById('dsCustomerAnalysisResults').classList.add('hidden');
    } finally {
        analyzeBtn.innerHTML = originalHtml;
        analyzeBtn.disabled = false;
    }
}

function ds_renderCustomerRevenueChart(data) {
    const container = document.getElementById('dsCustomerRevenueChartContainer');
    if (!container) return;

    // Check if D3 is available
    if (typeof d3 === 'undefined') {
        console.warn('D3.js not loaded, skipping chart render');
        return;
    }

    const svg = d3.select('#dsCustomerRevenueDistributionChart');
    if (svg.empty()) return;

    svg.selectAll('*').remove();

    const margin = { top: 20, right: 30, bottom: 50, left: 70 };
    const containerWidth = container.clientWidth || container.offsetWidth || 600;
    const width = Math.max(containerWidth - margin.left - margin.right, 200);
    const height = 200 - margin.top - margin.bottom;

    svg.attr('width', width + margin.left + margin.right)
       .attr('height', height + margin.top + margin.bottom);

    const g = svg.append('g')
        .attr('transform', `translate(${margin.left},${margin.top})`);

    const distributionData = data.distribution || [];
    const totalCustomers = data.total_customers || 0;
    const totalRevenue = data.total_revenue || 0;

    if (distributionData.length === 0) return;

    const chartData = [{ customer_percent: 0, cumulative_revenue_percent: 0, customer_count: 0 }, ...distributionData];

    const x = d3.scaleLinear()
        .domain([0, totalCustomers])
        .range([0, width]);

    // Y-axis now shows actual revenue in dollars (matching product chart)
    const y = d3.scaleLinear()
        .domain([0, totalRevenue])
        .range([height, 0]);

    const getCustomerCount = (d) => Math.round(totalCustomers * d.customer_percent / 100);
    const getRevenue = (d) => totalRevenue * d.cumulative_revenue_percent / 100;

    const formatRevenue = (val) => {
        if (val >= 1000000) return `${(val / 1000000).toFixed(1)}M`;
        if (val >= 1000) return `${(val / 1000).toFixed(0)}K`;
        return val.toFixed(0);
    };

    const formatCustomerCount = (val) => {
        if (val >= 1000000) return `${(val / 1000000).toFixed(1)}M`;
        if (val >= 1000) return `${(val / 1000).toFixed(0)}K`;
        return val.toLocaleString();
    };

    // Grid lines (matching product chart)
    g.append('g')
        .attr('class', 'grid')
        .attr('transform', `translate(0,${height})`)
        .call(d3.axisBottom(x).tickSize(-height).tickFormat('').ticks(Math.min(totalCustomers, 10)))
        .style('stroke-dasharray', '3,3')
        .style('stroke-opacity', 0.2);

    g.append('g')
        .attr('class', 'grid')
        .call(d3.axisLeft(y).tickSize(-width).tickFormat('').ticks(5))
        .style('stroke-dasharray', '3,3')
        .style('stroke-opacity', 0.2);

    const line = d3.line()
        .x(d => x(getCustomerCount(d)))
        .y(d => y(getRevenue(d)))
        .curve(d3.curveMonotoneX);

    const area = d3.area()
        .x(d => x(getCustomerCount(d)))
        .y0(height)
        .y1(d => y(getRevenue(d)))
        .curve(d3.curveMonotoneX);

    g.append('path')
        .datum(chartData)
        .attr('fill', '#3b82f6')
        .attr('fill-opacity', 0.1)
        .attr('d', area);

    g.append('path')
        .datum(chartData)
        .attr('fill', 'none')
        .attr('stroke', '#3b82f6')
        .attr('stroke-width', 2)
        .attr('d', line);

    // X-axis
    g.append('g')
        .attr('transform', `translate(0,${height})`)
        .call(d3.axisBottom(x).ticks(Math.min(totalCustomers, 10)).tickFormat(d => formatCustomerCount(d)))
        .selectAll('text')
        .style('font-size', '10px');

    // Y-axis with dollar formatting (matching product chart)
    g.append('g')
        .call(d3.axisLeft(y).ticks(5).tickFormat(formatRevenue))
        .selectAll('text')
        .style('font-size', '10px');

    // X-axis label
    g.append('text')
        .attr('x', width / 2)
        .attr('y', height + 45)
        .attr('text-anchor', 'middle')
        .style('font-size', '11px')
        .style('fill', '#666')
        .text('Customers (ranked by revenue)');

    // Y-axis label
    g.append('text')
        .attr('transform', 'rotate(-90)')
        .attr('y', -55)
        .attr('x', -height / 2)
        .attr('text-anchor', 'middle')
        .style('font-size', '11px')
        .style('fill', '#666')
        .text('Cumulative Revenue');

    // Store chart data for threshold updates
    svg.node().chartData = { x, y, height, width, g, distributionData: chartData, totalCustomers, totalRevenue, getCustomerCount, getRevenue, formatRevenue };
}

function ds_updateCustomerRevenueChart(threshold) {
    if (!ds_customerAnalysisData) return;

    // Check if D3 is available
    if (typeof d3 === 'undefined') return;

    const svg = d3.select('#dsCustomerRevenueDistributionChart');
    if (svg.empty()) return;
    const chartData = svg.node()?.chartData;
    if (!chartData) return;

    const { x, y, height, width, g, distributionData, totalCustomers, totalRevenue, getCustomerCount, formatRevenue } = chartData;

    g.selectAll('.threshold-line').remove();
    g.selectAll('.threshold-label').remove();

    let customerPercent = 100;
    for (const point of distributionData) {
        if (point.cumulative_revenue_percent >= threshold) {
            customerPercent = point.customer_percent;
            break;
        }
    }

    const customerCount = Math.round(totalCustomers * customerPercent / 100);
    const thresholdRevenue = totalRevenue * threshold / 100;

    // Horizontal threshold line - extends full width (matching product chart)
    g.append('line')
        .attr('class', 'threshold-line')
        .attr('x1', 0)
        .attr('x2', width)
        .attr('y1', y(thresholdRevenue))
        .attr('y2', y(thresholdRevenue))
        .attr('stroke', '#ef4444')
        .attr('stroke-width', 1.5)
        .attr('stroke-dasharray', '5,5');

    // Horizontal line label (matching product chart)
    g.append('text')
        .attr('class', 'threshold-label')
        .attr('x', width - 5)
        .attr('y', y(thresholdRevenue) - 5)
        .attr('text-anchor', 'end')
        .attr('fill', '#ef4444')
        .attr('font-size', '11px')
        .text(`${threshold}% revenue (${formatRevenue(thresholdRevenue)})`);

    // Vertical threshold line (matching product chart)
    if (customerCount > 0) {
        g.append('line')
            .attr('class', 'threshold-line')
            .attr('x1', x(customerCount))
            .attr('x2', x(customerCount))
            .attr('y1', y(thresholdRevenue))
            .attr('y2', height)
            .attr('stroke', '#ef4444')
            .attr('stroke-width', 1)
            .attr('stroke-dasharray', '3,3');

        // Vertical line label (matching product chart)
        g.append('text')
            .attr('class', 'threshold-label')
            .attr('x', x(customerCount))
            .attr('y', height + 35)
            .attr('text-anchor', 'middle')
            .attr('fill', '#ef4444')
            .attr('font-size', '10px')
            .text(`${customerCount.toLocaleString()} customers`);
    }

    // Update UI elements
    const totalCustomersCount = ds_customerAnalysisData.total_customers || 0;
    const selectedCustomers = Math.round(totalCustomersCount * customerPercent / 100);
    const selectedRevenue = totalRevenue * threshold / 100;

    document.getElementById('dsTotalCustomersCount').textContent = totalCustomersCount.toLocaleString();
    document.getElementById('dsSelectedCustomersCount').textContent = selectedCustomers.toLocaleString();
    document.getElementById('dsSelectedCustomersPercent').textContent = `(${customerPercent.toFixed(1)}%)`;
    document.getElementById('dsCustomerRevenueCoverage').textContent = `${threshold}%`;
    document.getElementById('dsCustomerRevenueCoverageAmount').textContent = `($${selectedRevenue.toLocaleString(undefined, { maximumFractionDigits: 0 })})`;

    ds_customerFiltersState.pending.topRevenue.thresholdPercent = threshold;
}

function ds_onCustomerThresholdChange() {
    const threshold = parseInt(document.getElementById('dsCustomerRevenueThreshold').value) || 80;
    ds_updateCustomerRevenueChart(threshold);
}

function ds_applyTopCustomersFilter() {
    const customerCol = document.getElementById('dsCustomerIdColumn')?.value;
    const revenueCol = document.getElementById('dsCustomerRevenueColumn')?.value;
    const threshold = parseInt(document.getElementById('dsCustomerRevenueThreshold')?.value) || 80;

    const isEnabled = customerCol && revenueCol;

    ds_customerFiltersState.pending.topRevenue = {
        enabled: isEnabled,
        customerColumn: customerCol || null,
        revenueColumn: revenueCol || null,
        thresholdPercent: threshold
    };

    ds_updateCustomersFilterSummary();
    ds_closeTopCustomersModal();
}

// =============================================================================
// PRODUCT METRICS MODAL
// =============================================================================

async function ds_openProductMetricsModal() {
    const modal = document.getElementById('dsProductMetricsModal');
    modal.classList.remove('hidden');

    ds_productMetricsModalSnapshot = JSON.parse(JSON.stringify(ds_productFiltersState.pending.aggregationFilters));

    ds_populateProductMetricsDropdowns();
    ds_renderExistingProductAggregationFilters();
    ds_resetProductMetricsInputs();
}

function ds_closeProductMetricsModal() {
    document.getElementById('dsProductMetricsModal').classList.add('hidden');
    ds_productMetricsModalSnapshot = null;
}

function ds_applyProductMetricsFilters() {
    ds_closeProductMetricsModal();
    ds_updateProductsFilterSummary();
}

function ds_cancelProductMetricsModal() {
    if (ds_productMetricsModalSnapshot !== null) {
        ds_productFiltersState.pending.aggregationFilters = ds_productMetricsModalSnapshot;
    }
    ds_closeProductMetricsModal();
    ds_updateProductsFilterSummary();
}

function ds_populateProductMetricsDropdowns() {
    const columns = [];
    Object.entries(ds_schemaBuilderState.selectedColumns || {}).forEach(([table, cols]) => {
        const shortTable = table.replace('raw_data.', '');
        cols.forEach(col => {
            columns.push({ table: shortTable, column: col, fullName: `${shortTable}.${col}` });
        });
    });

    const colAnalysis = ds_productFiltersState.columnAnalysis || {};
    const timestampCol = document.getElementById('dsTimestampColumn')?.value;

    const numericColumns = columns.filter(col => {
        const info = colAnalysis[col.fullName];
        const isNumeric = info?.type && ['INTEGER', 'FLOAT', 'INT64', 'FLOAT64', 'NUMERIC', 'BIGNUMERIC'].includes(info.type.toUpperCase());
        const isTimestamp = timestampCol && col.fullName === timestampCol;
        return isNumeric && !isTimestamp;
    });

    const txnCountProductSelect = document.getElementById('dsProductTxnCountProductColumn');
    txnCountProductSelect.innerHTML = '<option value="">Select column...</option>';
    columns.forEach(col => {
        if (timestampCol && col.fullName === timestampCol) return;
        const option = document.createElement('option');
        option.value = col.fullName;
        option.textContent = ds_getColumnDisplayName(col.fullName);
        txnCountProductSelect.appendChild(option);
    });

    const revenueProductSelect = document.getElementById('dsProductRevenueProductColumn');
    revenueProductSelect.innerHTML = '<option value="">Select column...</option>';
    columns.forEach(col => {
        if (timestampCol && col.fullName === timestampCol) return;
        const option = document.createElement('option');
        option.value = col.fullName;
        option.textContent = ds_getColumnDisplayName(col.fullName);
        revenueProductSelect.appendChild(option);
    });

    const revenueAmountSelect = document.getElementById('dsProductRevenueAmountColumn');
    revenueAmountSelect.innerHTML = '<option value="">Select column...</option>';
    numericColumns.forEach(col => {
        const option = document.createElement('option');
        option.value = col.fullName;
        option.textContent = ds_getColumnDisplayName(col.fullName);
        revenueAmountSelect.appendChild(option);
    });
}

function ds_resetProductMetricsInputs() {
    document.getElementById('dsProductTxnCountFilterType').value = 'greater_than';
    document.getElementById('dsProductTxnCountValue').value = '';
    document.getElementById('dsProductTxnCountMin').value = '';
    document.getElementById('dsProductTxnCountMax').value = '';
    ds_updateProductTxnCountInputs();

    document.getElementById('dsProductRevenueFilterType').value = 'greater_than';
    document.getElementById('dsProductRevenueValue').value = '';
    document.getElementById('dsProductRevenueMin').value = '';
    document.getElementById('dsProductRevenueMax').value = '';
    ds_updateProductRevenueInputs();
}

function ds_updateProductTxnCountInputs() {
    const filterType = document.getElementById('dsProductTxnCountFilterType').value;
    const valueContainer = document.getElementById('dsProductTxnCountValueContainer');
    const minContainer = document.getElementById('dsProductTxnCountMinContainer');
    const maxContainer = document.getElementById('dsProductTxnCountMaxContainer');

    if (filterType === 'range') {
        valueContainer.classList.add('hidden');
        minContainer.classList.remove('hidden');
        maxContainer.classList.remove('hidden');
    } else {
        valueContainer.classList.remove('hidden');
        minContainer.classList.add('hidden');
        maxContainer.classList.add('hidden');
    }
}

function ds_updateProductRevenueInputs() {
    const filterType = document.getElementById('dsProductRevenueFilterType').value;
    const valueContainer = document.getElementById('dsProductRevenueValueContainer');
    const minContainer = document.getElementById('dsProductRevenueMinContainer');
    const maxContainer = document.getElementById('dsProductRevenueMaxContainer');

    if (filterType === 'range') {
        valueContainer.classList.add('hidden');
        minContainer.classList.remove('hidden');
        maxContainer.classList.remove('hidden');
    } else {
        valueContainer.classList.remove('hidden');
        minContainer.classList.add('hidden');
        maxContainer.classList.add('hidden');
    }
}

function ds_addProductTransactionCountFilter() {
    const productColumn = document.getElementById('dsProductTxnCountProductColumn').value;
    const filterType = document.getElementById('dsProductTxnCountFilterType').value;

    if (!productColumn) {
        ds_showNotification('Please select a product ID column', 'error');
        return;
    }

    let filterData = {
        type: 'transaction_count',
        productColumn: productColumn,
        filterType: filterType
    };

    if (filterType === 'range') {
        const min = parseFloat(document.getElementById('dsProductTxnCountMin').value);
        const max = parseFloat(document.getElementById('dsProductTxnCountMax').value);
        if (isNaN(min) || isNaN(max)) {
            ds_showNotification('Please enter valid min and max values', 'error');
            return;
        }
        filterData.min = min;
        filterData.max = max;
    } else {
        const value = parseFloat(document.getElementById('dsProductTxnCountValue').value);
        if (isNaN(value)) {
            ds_showNotification('Please enter a valid value', 'error');
            return;
        }
        filterData.value = value;
    }

    ds_productFiltersState.pending.aggregationFilters.push(filterData);
    ds_renderExistingProductAggregationFilters();
    ds_updateProductsFilterSummary();

    document.getElementById('dsProductTxnCountProductColumn').value = '';
    document.getElementById('dsProductTxnCountValue').value = '';
    document.getElementById('dsProductTxnCountMin').value = '';
    document.getElementById('dsProductTxnCountMax').value = '';

    ds_showNotification('Transaction count filter added', 'success');
}

function ds_addProductRevenueFilter() {
    const productColumn = document.getElementById('dsProductRevenueProductColumn').value;
    const amountColumn = document.getElementById('dsProductRevenueAmountColumn').value;
    const filterType = document.getElementById('dsProductRevenueFilterType').value;

    if (!productColumn) {
        ds_showNotification('Please select a product ID column', 'error');
        return;
    }
    if (!amountColumn) {
        ds_showNotification('Please select an amount column', 'error');
        return;
    }

    let filterData = {
        type: 'revenue',
        productColumn: productColumn,
        amountColumn: amountColumn,
        filterType: filterType
    };

    if (filterType === 'range') {
        const min = parseFloat(document.getElementById('dsProductRevenueMin').value);
        const max = parseFloat(document.getElementById('dsProductRevenueMax').value);
        if (isNaN(min) || isNaN(max)) {
            ds_showNotification('Please enter valid min and max values', 'error');
            return;
        }
        filterData.min = min;
        filterData.max = max;
    } else {
        const value = parseFloat(document.getElementById('dsProductRevenueValue').value);
        if (isNaN(value)) {
            ds_showNotification('Please enter a valid value', 'error');
            return;
        }
        filterData.value = value;
    }

    ds_productFiltersState.pending.aggregationFilters.push(filterData);
    ds_renderExistingProductAggregationFilters();
    ds_populateProductMetricsDropdowns();
    ds_updateProductsFilterSummary();

    document.getElementById('dsProductRevenueProductColumn').value = '';
    document.getElementById('dsProductRevenueAmountColumn').value = '';
    document.getElementById('dsProductRevenueValue').value = '';
    document.getElementById('dsProductRevenueMin').value = '';
    document.getElementById('dsProductRevenueMax').value = '';

    ds_showNotification('Revenue filter added', 'success');
}

function ds_renderExistingProductAggregationFilters() {
    const container = document.getElementById('dsExistingProductAggregationFiltersList');
    const section = document.getElementById('dsExistingProductAggregationFiltersSection');
    const filters = ds_productFiltersState.pending.aggregationFilters;

    if (filters.length === 0) {
        section.classList.add('hidden');
        return;
    }

    section.classList.remove('hidden');
    container.innerHTML = filters.map((filter, index) => {
        let description = '';
        if (filter.type === 'transaction_count') {
            if (filter.filterType === 'range') {
                description = `Transactions: ${filter.min} - ${filter.max}`;
            } else if (filter.filterType === 'greater_than') {
                description = `Transactions > ${filter.value}`;
            } else {
                description = `Transactions < ${filter.value}`;
            }
            description += ` (grouped by ${filter.productColumn})`;
        } else if (filter.type === 'revenue') {
            if (filter.filterType === 'range') {
                description = `Revenue: $${filter.min} - $${filter.max}`;
            } else if (filter.filterType === 'greater_than') {
                description = `Revenue > $${filter.value}`;
            } else {
                description = `Revenue < $${filter.value}`;
            }
            description += ` (SUM of ${filter.amountColumn})`;
        }

        return `
            <div class="existing-filter-item">
                <div class="existing-filter-info">
                    <div class="existing-filter-column">
                        <span class="existing-filter-column-name">${filter.type === 'transaction_count' ? 'Transaction Count' : 'Revenue'}</span>
                        <span class="existing-filter-type-badge">${filter.filterType.replace('_', ' ')}</span>
                    </div>
                    <div class="existing-filter-value">${description}</div>
                </div>
                <div class="existing-filter-actions">
                    <button class="existing-filter-btn delete" onclick="ds_removeProductAggregationFilter(${index})" title="Remove">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

function ds_removeProductAggregationFilter(index) {
    ds_productFiltersState.pending.aggregationFilters.splice(index, 1);
    ds_renderExistingProductAggregationFilters();
    ds_populateProductMetricsDropdowns();
    ds_updateProductsFilterSummary();
}

// =============================================================================
// CUSTOMER METRICS MODAL
// =============================================================================

async function ds_openCustomerMetricsModal() {
    const modal = document.getElementById('dsCustomerMetricsModal');
    modal.classList.remove('hidden');

    ds_customerMetricsModalSnapshot = JSON.parse(JSON.stringify(ds_customerFiltersState.pending.aggregationFilters));

    ds_populateCustomerMetricsDropdowns();
    ds_renderExistingAggregationFilters();
    ds_resetCustomerMetricsInputs();
}

function ds_closeCustomerMetricsModal() {
    document.getElementById('dsCustomerMetricsModal').classList.add('hidden');
    ds_customerMetricsModalSnapshot = null;
}

function ds_applyCustomerMetricsFilters() {
    ds_closeCustomerMetricsModal();
    ds_updateCustomersFilterSummary();
}

function ds_cancelCustomerMetricsModal() {
    if (ds_customerMetricsModalSnapshot !== null) {
        ds_customerFiltersState.pending.aggregationFilters = ds_customerMetricsModalSnapshot;
    }
    ds_closeCustomerMetricsModal();
    ds_updateCustomersFilterSummary();
}

function ds_populateCustomerMetricsDropdowns() {
    const columns = [];
    Object.entries(ds_schemaBuilderState.selectedColumns || {}).forEach(([table, cols]) => {
        const shortTable = table.replace('raw_data.', '');
        cols.forEach(col => {
            columns.push({ table: shortTable, column: col, fullName: `${shortTable}.${col}` });
        });
    });

    const colAnalysis = ds_customerFiltersState.columnAnalysis || {};
    const timestampCol = document.getElementById('dsTimestampColumn')?.value;

    const numericColumns = columns.filter(col => {
        const info = colAnalysis[col.fullName];
        const isNumeric = info?.type && ['INTEGER', 'FLOAT', 'INT64', 'FLOAT64', 'NUMERIC', 'BIGNUMERIC'].includes(info.type.toUpperCase());
        const isTimestamp = timestampCol && col.fullName === timestampCol;
        return isNumeric && !isTimestamp;
    });

    const txnCountCustomerSelect = document.getElementById('dsTxnCountCustomerColumn');
    txnCountCustomerSelect.innerHTML = '<option value="">Select column...</option>';
    columns.forEach(col => {
        if (timestampCol && col.fullName === timestampCol) return;
        const option = document.createElement('option');
        option.value = col.fullName;
        option.textContent = ds_getColumnDisplayName(col.fullName);
        txnCountCustomerSelect.appendChild(option);
    });

    const spendingCustomerSelect = document.getElementById('dsSpendingCustomerColumn');
    spendingCustomerSelect.innerHTML = '<option value="">Select column...</option>';
    columns.forEach(col => {
        if (timestampCol && col.fullName === timestampCol) return;
        const option = document.createElement('option');
        option.value = col.fullName;
        option.textContent = ds_getColumnDisplayName(col.fullName);
        spendingCustomerSelect.appendChild(option);
    });

    const spendingAmountSelect = document.getElementById('dsSpendingAmountColumn');
    spendingAmountSelect.innerHTML = '<option value="">Select column...</option>';
    numericColumns.forEach(col => {
        const option = document.createElement('option');
        option.value = col.fullName;
        option.textContent = ds_getColumnDisplayName(col.fullName);
        spendingAmountSelect.appendChild(option);
    });
}

function ds_resetCustomerMetricsInputs() {
    document.getElementById('dsTxnCountFilterType').value = 'greater_than';
    document.getElementById('dsTxnCountValue').value = '';
    document.getElementById('dsTxnCountMin').value = '';
    document.getElementById('dsTxnCountMax').value = '';
    ds_updateTxnCountInputs();

    document.getElementById('dsSpendingFilterType').value = 'greater_than';
    document.getElementById('dsSpendingValue').value = '';
    document.getElementById('dsSpendingMin').value = '';
    document.getElementById('dsSpendingMax').value = '';
    ds_updateSpendingInputs();
}

function ds_updateTxnCountInputs() {
    const filterType = document.getElementById('dsTxnCountFilterType').value;
    const valueContainer = document.getElementById('dsTxnCountValueContainer');
    const minContainer = document.getElementById('dsTxnCountMinContainer');
    const maxContainer = document.getElementById('dsTxnCountMaxContainer');

    if (filterType === 'range') {
        valueContainer.classList.add('hidden');
        minContainer.classList.remove('hidden');
        maxContainer.classList.remove('hidden');
    } else {
        valueContainer.classList.remove('hidden');
        minContainer.classList.add('hidden');
        maxContainer.classList.add('hidden');
    }
}

function ds_updateSpendingInputs() {
    const filterType = document.getElementById('dsSpendingFilterType').value;
    const valueContainer = document.getElementById('dsSpendingValueContainer');
    const minContainer = document.getElementById('dsSpendingMinContainer');
    const maxContainer = document.getElementById('dsSpendingMaxContainer');

    if (filterType === 'range') {
        valueContainer.classList.add('hidden');
        minContainer.classList.remove('hidden');
        maxContainer.classList.remove('hidden');
    } else {
        valueContainer.classList.remove('hidden');
        minContainer.classList.add('hidden');
        maxContainer.classList.add('hidden');
    }
}

function ds_addTransactionCountFilter() {
    const customerColumn = document.getElementById('dsTxnCountCustomerColumn').value;
    const filterType = document.getElementById('dsTxnCountFilterType').value;

    if (!customerColumn) {
        ds_showNotification('Please select a customer ID column', 'error');
        return;
    }

    let filterData = {
        type: 'transaction_count',
        customerColumn: customerColumn,
        filterType: filterType
    };

    if (filterType === 'range') {
        const min = parseFloat(document.getElementById('dsTxnCountMin').value);
        const max = parseFloat(document.getElementById('dsTxnCountMax').value);
        if (isNaN(min) || isNaN(max)) {
            ds_showNotification('Please enter valid min and max values', 'error');
            return;
        }
        filterData.min = min;
        filterData.max = max;
    } else {
        const value = parseFloat(document.getElementById('dsTxnCountValue').value);
        if (isNaN(value)) {
            ds_showNotification('Please enter a valid value', 'error');
            return;
        }
        filterData.value = value;
    }

    ds_customerFiltersState.pending.aggregationFilters.push(filterData);
    ds_renderExistingAggregationFilters();
    ds_updateCustomersFilterSummary();

    document.getElementById('dsTxnCountCustomerColumn').value = '';
    document.getElementById('dsTxnCountValue').value = '';
    document.getElementById('dsTxnCountMin').value = '';
    document.getElementById('dsTxnCountMax').value = '';

    ds_showNotification('Transaction count filter added', 'success');
}

function ds_addSpendingFilter() {
    const customerColumn = document.getElementById('dsSpendingCustomerColumn').value;
    const amountColumn = document.getElementById('dsSpendingAmountColumn').value;
    const filterType = document.getElementById('dsSpendingFilterType').value;

    if (!customerColumn) {
        ds_showNotification('Please select a customer ID column', 'error');
        return;
    }
    if (!amountColumn) {
        ds_showNotification('Please select an amount column', 'error');
        return;
    }

    let filterData = {
        type: 'spending',
        customerColumn: customerColumn,
        amountColumn: amountColumn,
        filterType: filterType
    };

    if (filterType === 'range') {
        const min = parseFloat(document.getElementById('dsSpendingMin').value);
        const max = parseFloat(document.getElementById('dsSpendingMax').value);
        if (isNaN(min) || isNaN(max)) {
            ds_showNotification('Please enter valid min and max values', 'error');
            return;
        }
        filterData.min = min;
        filterData.max = max;
    } else {
        const value = parseFloat(document.getElementById('dsSpendingValue').value);
        if (isNaN(value)) {
            ds_showNotification('Please enter a valid value', 'error');
            return;
        }
        filterData.value = value;
    }

    ds_customerFiltersState.pending.aggregationFilters.push(filterData);
    ds_renderExistingAggregationFilters();
    ds_populateCustomerMetricsDropdowns();
    ds_updateCustomersFilterSummary();

    document.getElementById('dsSpendingCustomerColumn').value = '';
    document.getElementById('dsSpendingAmountColumn').value = '';
    document.getElementById('dsSpendingValue').value = '';
    document.getElementById('dsSpendingMin').value = '';
    document.getElementById('dsSpendingMax').value = '';

    ds_showNotification('Spending filter added', 'success');
}

function ds_renderExistingAggregationFilters() {
    const container = document.getElementById('dsExistingAggregationFiltersList');
    const section = document.getElementById('dsExistingAggregationFiltersSection');
    const filters = ds_customerFiltersState.pending.aggregationFilters;

    if (filters.length === 0) {
        section.classList.add('hidden');
        return;
    }

    section.classList.remove('hidden');
    container.innerHTML = filters.map((filter, index) => {
        let description = '';
        if (filter.type === 'transaction_count') {
            if (filter.filterType === 'range') {
                description = `Transactions: ${filter.min} - ${filter.max}`;
            } else if (filter.filterType === 'greater_than') {
                description = `Transactions > ${filter.value}`;
            } else {
                description = `Transactions < ${filter.value}`;
            }
            description += ` (grouped by ${filter.customerColumn})`;
        } else if (filter.type === 'spending') {
            if (filter.filterType === 'range') {
                description = `Spending: $${filter.min} - $${filter.max}`;
            } else if (filter.filterType === 'greater_than') {
                description = `Spending > $${filter.value}`;
            } else {
                description = `Spending < $${filter.value}`;
            }
            description += ` (SUM of ${filter.amountColumn})`;
        }

        return `
            <div class="existing-filter-item">
                <div class="existing-filter-info">
                    <div class="existing-filter-column">
                        <span class="existing-filter-column-name">${filter.type === 'transaction_count' ? 'Transaction Count' : 'Spending'}</span>
                        <span class="existing-filter-type-badge">${filter.filterType.replace('_', ' ')}</span>
                    </div>
                    <div class="existing-filter-value">${description}</div>
                </div>
                <div class="existing-filter-actions">
                    <button class="existing-filter-btn delete" onclick="ds_removeAggregationFilter(${index})" title="Remove">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

function ds_removeAggregationFilter(index) {
    ds_customerFiltersState.pending.aggregationFilters.splice(index, 1);
    ds_renderExistingAggregationFilters();
    ds_populateCustomerMetricsDropdowns();
    ds_updateCustomersFilterSummary();
}

// =============================================================================
// FILTER COLUMNS MODAL
// =============================================================================

// Track which sub-chapter (product/customer) opened the modal
let ds_filterColumnsContext = 'product';

function ds_openFilterColumnsModal() {
    ds_filterColumnsContext = 'product';
    const modal = document.getElementById('dsFilterColumnsModal');

    // Update modal title
    const titleEl = modal.querySelector('.modal-header-title');
    if (titleEl) titleEl.textContent = 'Filter Columns (Products)';

    modal.classList.remove('hidden');

    ds_populateFilterColumnsDropdown();
    ds_renderExistingFilters();
    ds_resetFilterColumnsInputs();
}

function ds_closeFilterColumnsModal() {
    document.getElementById('dsFilterColumnsModal').classList.add('hidden');
}

function ds_openCustomerFilterColumnsModal() {
    ds_filterColumnsContext = 'customer';
    const modal = document.getElementById('dsFilterColumnsModal');

    // Update modal title
    const titleEl = modal.querySelector('.modal-header-title');
    if (titleEl) titleEl.textContent = 'Filter Columns (Customers)';

    modal.classList.remove('hidden');

    ds_populateFilterColumnsDropdown();
    ds_renderExistingFilters();
    ds_resetFilterColumnsInputs();
}

function ds_populateFilterColumnsDropdown() {
    const select = document.getElementById('dsFilterColumnSelect');

    const columns = [];
    Object.entries(ds_schemaBuilderState.selectedColumns || {}).forEach(([table, cols]) => {
        const shortTable = table.replace('raw_data.', '');
        cols.forEach(col => {
            columns.push({ table: shortTable, column: col, fullName: `${shortTable}.${col}` });
        });
    });

    select.innerHTML = '<option value="">Select column...</option>';
    columns.forEach(col => {
        const option = document.createElement('option');
        option.value = col.fullName;
        option.textContent = ds_getColumnDisplayName(col.fullName);
        select.appendChild(option);
    });
}

async function ds_onFilterColumnSelect() {
    const select = document.getElementById('dsFilterColumnSelect');
    const selectedColumn = select.value;
    const configContainer = document.getElementById('dsFilterConfigContainer');

    // Store selected column for later use
    ds_productFiltersState.selectedFilterColumn = selectedColumn;

    if (!selectedColumn) {
        ds_resetFilterConfigArea();
        return;
    }

    // Fetch column analysis if not cached
    if (!ds_productFiltersState.columnAnalysis[selectedColumn] ||
        Object.keys(ds_productFiltersState.columnAnalysis).length === 0) {
        await ds_fetchColumnAnalysis();
    }

    const colInfo = ds_productFiltersState.columnAnalysis[selectedColumn];
    if (!colInfo) {
        console.error('Column analysis not found for:', selectedColumn);
        ds_resetFilterConfigArea();
        return;
    }

    ds_showFilterConfigForType(selectedColumn, colInfo);
}

function ds_resetFilterConfigArea() {
    const configContainer = document.getElementById('dsFilterConfigContainer');
    const categoryConfig = document.getElementById('dsCategoryFilterConfig');
    const numericConfig = document.getElementById('dsNumericFilterConfig');
    const dateConfig = document.getElementById('dsDateFilterConfig');

    configContainer.classList.add('hidden');
    categoryConfig.classList.add('hidden');
    numericConfig.classList.add('hidden');
    dateConfig.classList.add('hidden');
}

function ds_showFilterConfigForType(columnName, colInfo) {
    const configContainer = document.getElementById('dsFilterConfigContainer');
    const categoryConfig = document.getElementById('dsCategoryFilterConfig');
    const numericConfig = document.getElementById('dsNumericFilterConfig');
    const dateConfig = document.getElementById('dsDateFilterConfig');

    // Hide all configs first
    categoryConfig.classList.add('hidden');
    numericConfig.classList.add('hidden');
    dateConfig.classList.add('hidden');
    configContainer.classList.remove('hidden');

    // Use filter_type from analysis (category, numeric, date)
    if (colInfo.filter_type === 'category') {
        ds_showCategoryFilterConfig(columnName, colInfo);
    } else if (colInfo.filter_type === 'numeric') {
        ds_showNumericFilterConfig(columnName, colInfo);
    } else if (colInfo.filter_type === 'date') {
        ds_showDateFilterConfig(columnName, colInfo);
    }
}

function ds_showCategoryFilterConfig(columnName, colInfo) {
    const config = document.getElementById('dsCategoryFilterConfig');
    document.getElementById('dsCategoryFilterColumnName').textContent =
        `${ds_getColumnDisplayName(columnName)} - ${colInfo.unique_count} unique values`;

    // Render values list
    const valuesContainer = document.getElementById('dsNewCategoryValuesContainer');

    // Backend returns 'values' as array of {value, count} objects in list mode
    if (colInfo.display_mode === 'list' && colInfo.values) {
        valuesContainer.innerHTML = `
            <div class="category-filter-search">
                <input type="text" placeholder="Search values..." oninput="ds_filterCategoryValues(this.value)">
            </div>
            <div class="category-filter-list" id="dsNewCategoryValuesList">
                ${colInfo.values.map(item => `
                    <div class="category-filter-item" onclick="ds_toggleCategoryValue(this, '${String(item.value).replace(/'/g, "\\'")}', event)">
                        <label class="category-filter-item-label" onclick="event.stopPropagation()">
                            <input type="checkbox" value="${item.value}" onchange="this.closest('.category-filter-item').classList.toggle('selected', this.checked)">
                            ${item.value}
                        </label>
                        <span class="category-filter-item-count">(${item.count})</span>
                    </div>
                `).join('')}
            </div>
        `;
    } else {
        // Autocomplete mode for >100 values
        valuesContainer.innerHTML = `
            <div class="category-autocomplete-container">
                <input type="text" class="category-autocomplete-input" placeholder="Type to search values..."
                       oninput="ds_searchCategoryValues(this.value, '${columnName}')" id="dsCategoryAutocompleteInput">
                <div class="category-autocomplete-dropdown hidden" id="dsCategoryAutocompleteDropdown"></div>
            </div>
            <div class="category-selected-tags" id="dsCategorySelectedTags"></div>
        `;
    }

    // Reset mode selection
    const modeRadio = document.querySelector('input[name="dsNewCategoryMode"][value="include"]');
    if (modeRadio) modeRadio.checked = true;

    config.classList.remove('hidden');
}

function ds_showNumericFilterConfig(columnName, colInfo) {
    const config = document.getElementById('dsNumericFilterConfig');
    document.getElementById('dsNumericFilterColumnName').textContent = ds_getColumnDisplayName(columnName);
    document.getElementById('dsNumericFilterTypeBadge').textContent = colInfo.type;

    const statsEl = document.getElementById('dsNumericFilterStats');
    if (statsEl) {
        statsEl.textContent = `Range: ${colInfo.min} - ${colInfo.max} | Nulls: ${colInfo.null_percent || 0}%`;
    }

    // Reset filter type to range
    const rangeRadio = document.querySelector('input[name="dsNewNumericType"][value="range"]');
    if (rangeRadio) rangeRadio.checked = true;

    // Set placeholder values
    const minInput = document.getElementById('dsNewNumericMin');
    const maxInput = document.getElementById('dsNewNumericMax');
    if (minInput) {
        minInput.value = '';
        minInput.placeholder = colInfo.min || '';
    }
    if (maxInput) {
        maxInput.value = '';
        maxInput.placeholder = colInfo.max || '';
    }

    const includeNullsCheckbox = document.getElementById('dsNewNumericIncludeNulls');
    if (includeNullsCheckbox) includeNullsCheckbox.checked = true;

    config.classList.remove('hidden');
}

function ds_showDateFilterConfig(columnName, colInfo) {
    const config = document.getElementById('dsDateFilterConfig');
    document.getElementById('dsDateFilterColumnName').textContent = ds_getColumnDisplayName(columnName);

    const statsEl = document.getElementById('dsDateFilterStats');
    if (statsEl) {
        statsEl.textContent = `Range: ${colInfo.min_date || 'N/A'} - ${colInfo.max_date || 'N/A'}`;
    }

    // Reset inputs
    const relativeRadio = document.querySelector('input[name="dsNewDateType"][value="relative"]');
    if (relativeRadio) relativeRadio.checked = true;

    const relativeOption = document.getElementById('dsNewDateRelativeOption');
    if (relativeOption) relativeOption.value = 'last_30_days';

    config.classList.remove('hidden');
}

// Filter category values in the list based on search input
function ds_filterCategoryValues(searchText) {
    const items = document.querySelectorAll('#dsNewCategoryValuesList .category-filter-item');
    const searchLower = searchText.toLowerCase();

    items.forEach(item => {
        const label = item.querySelector('.category-filter-item-label');
        const text = label ? label.textContent.toLowerCase() : '';
        item.style.display = text.includes(searchLower) ? '' : 'none';
    });
}

// Toggle category value selection
function ds_toggleCategoryValue(element, value, event) {
    // Prevent double-toggle when clicking on the checkbox itself
    if (event && event.target.type === 'checkbox') {
        // Checkbox was clicked directly, let it handle its own state
        element.classList.toggle('selected', event.target.checked);
        return;
    }

    const checkbox = element.querySelector('input[type="checkbox"]');
    if (checkbox) {
        checkbox.checked = !checkbox.checked;
        element.classList.toggle('selected', checkbox.checked);
    }
}

// Search category values via API (for autocomplete mode with >100 values)
async function ds_searchCategoryValues(searchText, columnName) {
    if (!searchText || searchText.length < 2) {
        document.getElementById('dsCategoryAutocompleteDropdown').classList.add('hidden');
        return;
    }

    try {
        const response = await fetch(`/api/models/${modelId}/datasets/search-column-values/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                session_id: ds_schemaBuilderState.sessionId,
                column: columnName,
                search: searchText,
                limit: 20
            })
        });

        const data = await response.json();
        if (data.status === 'success') {
            ds_renderCategoryAutocompleteResults(data.values);
        }
    } catch (error) {
        console.error('Error searching category values:', error);
    }
}

function ds_renderCategoryAutocompleteResults(values) {
    const dropdown = document.getElementById('dsCategoryAutocompleteDropdown');

    if (!values || values.length === 0) {
        dropdown.classList.add('hidden');
        return;
    }

    dropdown.innerHTML = values.map(item => `
        <div class="category-autocomplete-item" onclick="ds_selectAutocompleteValue('${String(item.value).replace(/'/g, "\\'")}')">
            ${item.value} <span class="count">(${item.count})</span>
        </div>
    `).join('');

    dropdown.classList.remove('hidden');
}

function ds_selectAutocompleteValue(value) {
    const tagsContainer = document.getElementById('dsCategorySelectedTags');

    // Check if already selected
    const existingTags = tagsContainer.querySelectorAll('.category-tag');
    for (const tag of existingTags) {
        if (tag.dataset.value === value) return;
    }

    // Add tag
    const tag = document.createElement('span');
    tag.className = 'category-tag';
    tag.dataset.value = value;
    tag.innerHTML = `${value} <i class="fas fa-times" onclick="this.parentElement.remove()"></i>`;
    tagsContainer.appendChild(tag);

    // Clear input and hide dropdown
    document.getElementById('dsCategoryAutocompleteInput').value = '';
    document.getElementById('dsCategoryAutocompleteDropdown').classList.add('hidden');
}

function ds_resetFilterColumnsInputs() {
    document.getElementById('dsFilterColumnSelect').value = '';
    document.getElementById('dsFilterConfigContainer').classList.add('hidden');
}

function ds_renderExistingFilters() {
    const container = document.getElementById('dsExistingFiltersList');
    const section = document.getElementById('dsExistingFiltersSection');

    // Use the correct state based on context
    const filterState = ds_filterColumnsContext === 'customer'
        ? ds_customerFiltersState
        : ds_productFiltersState;

    // Combine all pending filters
    const allFilters = [
        ...filterState.pending.categoryFilters.map(f => ({ ...f, filterCategory: 'category' })),
        ...filterState.pending.numericFilters.map(f => ({ ...f, filterCategory: 'numeric' })),
        ...filterState.pending.dateFilters.map(f => ({ ...f, filterCategory: 'date' }))
    ];

    if (allFilters.length === 0) {
        section.classList.add('hidden');
        return;
    }

    section.classList.remove('hidden');
    container.innerHTML = allFilters.map((filter, index) => {
        let description = '';
        if (filter.filterCategory === 'category') {
            description = `${filter.mode === 'include' ? 'Include' : 'Exclude'}: ${filter.values.length} values`;
        } else if (filter.filterCategory === 'numeric') {
            if (filter.type === 'range') {
                description = `Range: ${filter.min} - ${filter.max}`;
            } else if (filter.type === 'greater_than') {
                description = `> ${filter.value}`;
            } else if (filter.type === 'less_than') {
                description = `< ${filter.value}`;
            } else {
                description = `= ${filter.value}`;
            }
        } else if (filter.filterCategory === 'date') {
            if (filter.type === 'relative') {
                description = filter.relativePeriod?.replace('_', ' ') || 'Last 30 days';
            } else {
                description = `${filter.startDate} to ${filter.endDate}`;
            }
        }

        return `
            <div class="existing-filter-item">
                <div class="existing-filter-info">
                    <div class="existing-filter-column">
                        <span class="existing-filter-column-name">${ds_getColumnDisplayName(filter.column)}</span>
                        <span class="existing-filter-type-badge">${filter.filterCategory}</span>
                    </div>
                    <div class="existing-filter-value">${description}</div>
                </div>
                <div class="existing-filter-actions">
                    <button class="existing-filter-btn delete" onclick="ds_removeFilter('${filter.filterCategory}', ${index})" title="Remove">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

function ds_removeFilter(category, index) {
    if (category === 'category') {
        ds_productFiltersState.pending.categoryFilters.splice(index, 1);
    } else if (category === 'numeric') {
        ds_productFiltersState.pending.numericFilters.splice(index, 1);
    } else if (category === 'date') {
        ds_productFiltersState.pending.dateFilters.splice(index, 1);
    }
    ds_renderExistingFilters();
    ds_updateProductsFilterSummary();
}

function ds_updateNumericFilterInputs() {
    const filterType = document.querySelector('input[name="dsNewNumericType"]:checked')?.value || 'range';
    const minContainer = document.getElementById('dsNewNumericInputs').querySelector('.numeric-filter-input-group:first-child');
    const maxContainer = document.getElementById('dsNewNumericInputs').querySelector('.numeric-filter-input-group:last-child');

    if (filterType === 'range') {
        minContainer.style.display = '';
        maxContainer.style.display = '';
        minContainer.querySelector('label').textContent = 'Min';
        maxContainer.querySelector('label').textContent = 'Max';
    } else if (filterType === 'greater_than') {
        minContainer.style.display = '';
        maxContainer.style.display = 'none';
        minContainer.querySelector('label').textContent = 'Value';
    } else if (filterType === 'less_than') {
        minContainer.style.display = '';
        maxContainer.style.display = 'none';
        minContainer.querySelector('label').textContent = 'Value';
    } else {
        minContainer.style.display = '';
        maxContainer.style.display = 'none';
        minContainer.querySelector('label').textContent = 'Value';
    }
}

function ds_updateDateFilterInputs() {
    const filterType = document.querySelector('input[name="dsNewDateType"]:checked')?.value || 'relative';
    const relativeInputs = document.getElementById('dsNewDateRelativeInputs');
    const rangeInputs = document.getElementById('dsNewDateRangeInputs');

    if (filterType === 'relative') {
        relativeInputs.classList.remove('hidden');
        rangeInputs.classList.add('hidden');
    } else {
        relativeInputs.classList.add('hidden');
        rangeInputs.classList.remove('hidden');
    }
}

function ds_applyFilterColumnsModal() {
    const selectedColumn = document.getElementById('dsFilterColumnSelect').value;

    if (!selectedColumn) {
        ds_closeFilterColumnsModal();
        return;
    }

    // Use the correct state based on context
    const filterState = ds_filterColumnsContext === 'customer'
        ? ds_customerFiltersState
        : ds_productFiltersState;

    // Determine which filter type is active and create the filter
    const categoryConfig = document.getElementById('dsCategoryFilterConfig');
    const numericConfig = document.getElementById('dsNumericFilterConfig');
    const dateConfig = document.getElementById('dsDateFilterConfig');

    if (!categoryConfig.classList.contains('hidden')) {
        // Add category filter
        const mode = document.querySelector('input[name="dsNewCategoryMode"]:checked')?.value || 'include';

        // Collect selected values from checkboxes (list mode) or tags (autocomplete mode)
        const selectedValues = [];

        // Check list mode - get checked checkboxes
        const checkboxes = document.querySelectorAll('#dsNewCategoryValuesList input[type="checkbox"]:checked');
        checkboxes.forEach(cb => {
            selectedValues.push(cb.value);
        });

        // Check autocomplete mode - get selected tags
        const tags = document.querySelectorAll('#dsCategorySelectedTags .category-tag');
        tags.forEach(tag => {
            if (tag.dataset.value) {
                selectedValues.push(tag.dataset.value);
            }
        });

        if (selectedValues.length === 0) {
            alert('Please select at least one value to filter by');
            return;
        }

        filterState.pending.categoryFilters.push({
            column: selectedColumn,
            mode: mode,
            values: selectedValues
        });
    } else if (!numericConfig.classList.contains('hidden')) {
        // Add numeric filter
        const filterType = document.querySelector('input[name="dsNewNumericType"]:checked')?.value || 'range';
        const min = parseFloat(document.getElementById('dsNewNumericMin').value);
        const max = parseFloat(document.getElementById('dsNewNumericMax').value);
        const includeNulls = document.getElementById('dsNewNumericIncludeNulls').checked;

        filterState.pending.numericFilters.push({
            column: selectedColumn,
            type: filterType,
            min: filterType === 'range' ? min : null,
            max: filterType === 'range' ? max : null,
            value: filterType !== 'range' ? min : null,
            includeNulls: includeNulls
        });
    } else if (!dateConfig.classList.contains('hidden')) {
        // Add date filter
        const filterType = document.querySelector('input[name="dsNewDateType"]:checked')?.value || 'relative';
        const relativePeriod = document.getElementById('dsNewDateRelativeOption').value;
        const startDate = document.getElementById('dsNewDateStart').value;
        const endDate = document.getElementById('dsNewDateEnd').value;

        filterState.pending.dateFilters.push({
            column: selectedColumn,
            type: filterType,
            relativePeriod: filterType === 'relative' ? relativePeriod : null,
            startDate: filterType === 'range' ? startDate : null,
            endDate: filterType === 'range' ? endDate : null,
            includeNulls: document.getElementById('dsNewDateIncludeNulls').checked
        });
    }

    // Update the correct summary based on context
    if (ds_filterColumnsContext === 'customer') {
        ds_updateCustomersFilterSummary();
    } else {
        ds_updateProductsFilterSummary();
    }

    ds_closeFilterColumnsModal();
}

// =============================================================================
// FILTER SUMMARY UPDATES
// =============================================================================

function ds_updateProductsFilterSummary() {
    // Count active filters from pending state
    const pending = ds_productFiltersState.pending;
    let filterCount = 0;
    if (pending.topRevenue.enabled) filterCount++;
    filterCount += pending.categoryFilters.length;
    filterCount += pending.numericFilters.length;
    filterCount += pending.dateFilters.length;
    filterCount += pending.aggregationFilters.length;

    // Update summary items
    const summaryItemsEl = document.getElementById('dsProductsFilterSummaryItems');
    if (summaryItemsEl) {
        if (filterCount > 0) {
            summaryItemsEl.innerHTML = `<span class="filter-summary-item">${filterCount} filter(s) configured</span>`;
        } else {
            summaryItemsEl.innerHTML = '<span class="filter-summary-empty">No filters selected</span>';
        }
    }

    // Update refresh button state
    ds_updateProductsRefreshButtonState();
}

function ds_updateCustomersFilterSummary() {
    // Count active filters from pending state
    const pending = ds_customerFiltersState.pending;
    let filterCount = 0;
    if (pending.topRevenue.enabled) filterCount++;
    filterCount += pending.categoryFilters.length;
    filterCount += pending.numericFilters.length;
    filterCount += pending.dateFilters.length;
    filterCount += pending.aggregationFilters.length;

    // Update summary items
    const summaryItemsEl = document.getElementById('dsCustomersFilterSummaryItems');
    if (summaryItemsEl) {
        if (filterCount > 0) {
            summaryItemsEl.innerHTML = `<span class="filter-summary-item">${filterCount} filter(s) configured</span>`;
        } else {
            summaryItemsEl.innerHTML = '<span class="filter-summary-empty">No filters selected</span>';
        }
    }

    // Update refresh button state
    ds_updateCustomersRefreshButtonState();
}

// Update Products Refresh Dataset button state
function ds_updateProductsRefreshButtonState() {
    const refreshBtn = document.getElementById('dsRefreshProductFiltersBtn');
    if (!refreshBtn) return;

    // Enable button if pending state differs from committed state
    const pendingJson = JSON.stringify(ds_productFiltersState.pending);
    const committedJson = JSON.stringify(ds_productFiltersState.committed);
    const hasChanges = pendingJson !== committedJson;

    refreshBtn.disabled = !hasChanges;
    refreshBtn.classList.toggle('filter-button-disabled', !hasChanges);
}

// Update Customers Refresh Dataset button state
function ds_updateCustomersRefreshButtonState() {
    const refreshBtn = document.getElementById('dsRefreshCustomerFiltersBtn');
    if (!refreshBtn) return;

    // Enable button if pending state differs from committed state
    const pendingJson = JSON.stringify(ds_customerFiltersState.pending);
    const committedJson = JSON.stringify(ds_customerFiltersState.committed);
    const hasChanges = pendingJson !== committedJson;

    refreshBtn.disabled = !hasChanges;
    refreshBtn.classList.toggle('filter-button-disabled', !hasChanges);
}

// Refresh Product Filters - commits pending to committed and updates Dataset Summary
function ds_refreshProductFilters() {
    const refreshBtn = document.getElementById('dsRefreshProductFiltersBtn');
    if (!refreshBtn) return;

    const originalHtml = refreshBtn.innerHTML;
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
    refreshBtn.disabled = true;

    // Deep copy pending to committed
    ds_productFiltersState.committed = JSON.parse(JSON.stringify(ds_productFiltersState.pending));

    // Save to wizardData.filters for persistence
    ds_wizardData.filters = ds_wizardData.filters || {};
    ds_wizardData.filters.product_filter = ds_buildProductFilterConfig();

    // Update Dataset Summary
    ds_loadDatasetStats(true);

    // Restore button and update state
    setTimeout(() => {
        refreshBtn.innerHTML = originalHtml;
        ds_updateProductsRefreshButtonState();
        ds_updateProductsFilterStatus();
    }, 300);
}

// Refresh Customer Filters - commits pending to committed and updates Dataset Summary
function ds_refreshCustomerFilters() {
    const refreshBtn = document.getElementById('dsRefreshCustomerFiltersBtn');
    if (!refreshBtn) return;

    const originalHtml = refreshBtn.innerHTML;
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
    refreshBtn.disabled = true;

    // Deep copy pending to committed
    ds_customerFiltersState.committed = JSON.parse(JSON.stringify(ds_customerFiltersState.pending));

    // Save to wizardData.filters for persistence
    ds_wizardData.filters = ds_wizardData.filters || {};
    ds_wizardData.filters.customer_filter = ds_buildCustomerFilterConfig();

    // Update Dataset Summary
    ds_loadDatasetStats(true);

    // Restore button and update state
    setTimeout(() => {
        refreshBtn.innerHTML = originalHtml;
        ds_updateCustomersRefreshButtonState();
        ds_updateCustomersFilterStatus();
    }, 300);
}

// Build product filter config from committed state for saving
function ds_buildProductFilterConfig() {
    const committed = ds_productFiltersState.committed;
    const config = {};

    if (committed.topRevenue.enabled) {
        config.top_revenue = {
            product_column: committed.topRevenue.productColumn,
            revenue_column: committed.topRevenue.revenueColumn,
            percent: committed.topRevenue.thresholdPercent
        };
    }

    if (committed.aggregationFilters.length > 0) {
        config.aggregation_filters = committed.aggregationFilters;
    }

    if (committed.categoryFilters.length > 0) {
        config.category_filters = committed.categoryFilters;
    }

    if (committed.numericFilters.length > 0) {
        config.numeric_filters = committed.numericFilters;
    }

    return Object.keys(config).length > 0 ? config : null;
}

// Build customer filter config from committed state for saving
function ds_buildCustomerFilterConfig() {
    const committed = ds_customerFiltersState.committed;
    const config = {};

    if (committed.topRevenue.enabled) {
        config.top_revenue = {
            customer_column: committed.topRevenue.customerColumn,
            revenue_column: committed.topRevenue.revenueColumn,
            percent: committed.topRevenue.thresholdPercent
        };
    }

    if (committed.aggregationFilters.length > 0) {
        config.aggregation_filters = committed.aggregationFilters;
    }

    if (committed.categoryFilters.length > 0) {
        config.category_filters = committed.categoryFilters;
    }

    if (committed.numericFilters.length > 0) {
        config.numeric_filters = committed.numericFilters;
    }

    return Object.keys(config).length > 0 ? config : null;
}

// Update Dates filter status badge in sub-chapter header
function ds_updateDatesFilterStatus() {
    const statusEl = document.getElementById('dsDatesFilterStatus');
    if (!statusEl) return;

    const datesCommitted = ds_datesFilterState.committed;

    // Only show badge if timestamp column is selected
    if (!datesCommitted.timestampColumn) {
        statusEl.textContent = '';
        return;
    }

    statusEl.textContent = '1 filter applied';
}

// Update Products filter status badge in sub-chapter header
function ds_updateProductsFilterStatus() {
    const statusEl = document.getElementById('dsProductsFilterStatus');
    if (!statusEl) return;

    const committed = ds_productFiltersState.committed;
    let filterCount = 0;

    if (committed.topRevenue.enabled) filterCount++;
    filterCount += committed.aggregationFilters.length;
    filterCount += committed.categoryFilters.length;
    filterCount += committed.numericFilters.length;
    filterCount += committed.dateFilters.length;

    if (filterCount === 0) {
        statusEl.textContent = '';
    } else {
        statusEl.textContent = `${filterCount} filter${filterCount !== 1 ? 's' : ''} applied`;
    }
}

// Update Customers filter status badge in sub-chapter header
function ds_updateCustomersFilterStatus() {
    const statusEl = document.getElementById('dsCustomersFilterStatus');
    if (!statusEl) return;

    const committed = ds_customerFiltersState.committed;
    let filterCount = 0;

    if (committed.topRevenue.enabled) filterCount++;
    filterCount += committed.aggregationFilters.length;
    filterCount += committed.categoryFilters.length;
    filterCount += committed.numericFilters.length;
    filterCount += committed.dateFilters.length;

    if (filterCount === 0) {
        statusEl.textContent = '';
    } else {
        statusEl.textContent = `${filterCount} filter${filterCount !== 1 ? 's' : ''} applied`;
    }
}

// NOTE: ds_setJoinType and ds_removeSelectedJoin are defined in the
// "Step 3: Connection/Join System" section above

// =============================================================================
// DATASET WIZARD - Save Dataset
// =============================================================================

/**
 * Convert joins array format to dict format expected by backend validation.
 * From: [{leftTable, rightTable, leftCol, rightCol, type}, ...]
 * To: {rightTable: {join_key: rightCol, primary_column: leftCol, join_type: type}, ...}
 */
function ds_convertJoinsToConfig(joinsArray) {
    const config = {};
    for (const join of joinsArray) {
        config[join.rightTable] = {
            join_key: join.rightCol,
            primary_column: join.leftCol,
            secondary_column: join.rightCol,
            join_type: join.type
        };
    }
    return config;
}

function ds_saveDataset() {
    ds_collectStepData(4);

    // Build summary snapshot from current Dataset Summary panel data
    // This captures whatever is currently displayed (filtered or unfiltered)
    const summarySnapshot = ds_datasetStatsData ? {
        total_rows: ds_datasetStatsData.summary?.total_rows || 0,
        filters_applied: ds_datasetStatsData.filters_applied || {},
        column_stats: ds_datasetStatsData.column_stats || {},
        snapshot_at: new Date().toISOString()
    } : {};

    // Ensure schema builder data is transferred to wizardData before building payload
    // (This may have been done already in ds_nextStep, but do it again to be safe)
    ds_collectSchemaBuilderData();

    const payload = {
        name: ds_wizardData.name,
        description: ds_wizardData.description,
        primary_table: ds_wizardData.primaryTable,
        secondary_tables: ds_wizardData.secondaryTables,
        join_config: ds_wizardData.joinConfig,
        selected_columns: ds_wizardData.selectedColumns,
        column_aliases: ds_wizardData.columnAliases || {},
        filters: ds_wizardData.filters,
        summary_snapshot: summarySnapshot
    };

    const url = ds_wizardEditMode
        ? `/api/datasets/${ds_wizardEditDatasetId}/update/`
        : `/api/models/${modelId}/datasets/create/`;

    document.getElementById('dsSaveButton').disabled = true;
    document.getElementById('dsSaveButton').querySelector('.btn-neu-inner').innerHTML =
        '<i class="fas fa-spinner fa-spin mr-1"></i>Saving...';

    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'success') {
            ds_showNotification('Dataset saved successfully!', 'success');
            ds_closeWizard();
            ds_loadDatasets();
            fc_loadDatasets();  // Refresh Feature Config dropdown
        } else {
            ds_showNotification(data.message || 'Failed to save dataset', 'error');
        }
    })
    .catch(err => {
        console.error('Error saving dataset:', err);
        ds_showNotification('Failed to save dataset', 'error');
    })
    .finally(() => {
        document.getElementById('dsSaveButton').disabled = false;
        document.getElementById('dsSaveButton').querySelector('.btn-neu-inner').textContent = 'Save';
    });
}

// =============================================================================
// DATASET ACTIONS - View/Edit/Delete
// =============================================================================

function ds_viewDataset(datasetId) {
    ds_currentDatasetId = datasetId;

    fetch(`/api/datasets/${datasetId}/summary/`)
        .then(r => r.json())
        .then(data => {
            if (data.status === 'success') {
                ds_renderDatasetDetail(data.summary);
                document.getElementById('dsDetailModal').classList.remove('hidden');
            }
        })
        .catch(err => console.error('Error loading dataset:', err));
}

function ds_renderDatasetDetail(summary) {
    const content = document.getElementById('dsDetailContent');
    document.getElementById('dsDetailTitle').textContent = summary.name || 'Dataset Details';

    // Build filters applied display from summary_snapshot
    const snapshot = summary.summary_snapshot || {};
    const filtersApplied = snapshot.filters_applied || {};
    const columnStats = snapshot.column_stats || {};
    const joinConfig = summary.join_config || {};
    const columnAliases = summary.column_aliases || {};

    // Helper to get display name for saved dataset
    const getDisplayName = (colName) => {
        if (!columnAliases || Object.keys(columnAliases).length === 0) return colName;
        if (columnAliases[colName]) return columnAliases[colName];
        const underscoreFormat = colName.replace(/\./g, '_');
        if (columnAliases[underscoreFormat]) return columnAliases[underscoreFormat];
        const dotFormat = colName.replace(/_/g, '.');
        if (columnAliases[dotFormat]) return columnAliases[dotFormat];
        return colName;
    };

    // Build join configuration display
    const joinRows = Object.entries(joinConfig).map(([table, config]) => {
        const tableName = table.replace('raw_data.', '');
        const primaryTable = summary.tables?.primary?.replace('raw_data.', '') || 'primary';
        return `
            <div class="flex items-center text-sm py-1">
                <span class="text-gray-900 font-medium">${primaryTable}.${config.join_key}</span>
                <i class="fas fa-arrows-alt-h mx-2 text-gray-400"></i>
                <span class="text-gray-900 font-medium">${tableName}.${config.secondary_column}</span>
                <span class="ml-2 px-2 py-0.5 rounded text-xs bg-gray-200 text-gray-600">${config.join_type || 'LEFT'}</span>
            </div>
        `;
    }).join('');

    // Build detailed filters display
    const filterDetails = [];

    // Dates filter details
    if (filtersApplied.dates?.type === 'rolling') {
        filterDetails.push(`
            <div class="border-l-4 border-blue-400 pl-3 py-2">
                <div class="font-medium text-gray-900"><i class="fas fa-calendar-alt mr-2 text-blue-500"></i>Date Filter</div>
                <div class="text-sm text-gray-600 mt-1">
                    <span class="text-gray-500">Column:</span> <span class="font-medium">${filtersApplied.dates.column || 'N/A'}</span><br>
                    <span class="text-gray-500">Range:</span> Last ${filtersApplied.dates.days} days (rolling window)
                </div>
            </div>
        `);
    } else if (filtersApplied.dates?.type === 'fixed') {
        filterDetails.push(`
            <div class="border-l-4 border-blue-400 pl-3 py-2">
                <div class="font-medium text-gray-900"><i class="fas fa-calendar-alt mr-2 text-blue-500"></i>Date Filter</div>
                <div class="text-sm text-gray-600 mt-1">
                    <span class="text-gray-500">Column:</span> <span class="font-medium">${filtersApplied.dates.column || 'N/A'}</span><br>
                    <span class="text-gray-500">Start Date:</span> ${filtersApplied.dates.start_date}
                </div>
            </div>
        `);
    }

    // Customers filter details
    if (filtersApplied.customers?.type === 'multiple' && filtersApplied.customers.filters?.length > 0) {
        const customerFilterItems = filtersApplied.customers.filters.map(f => {
            if (f.type === 'top_revenue') {
                return `<li>Top <strong>${f.percent}%</strong> customers by revenue</li>`;
            } else if (f.type === 'transaction_count') {
                const desc = f.filter_type === 'greater_than' ? `> ${f.value}` :
                             f.filter_type === 'less_than' ? `< ${f.value}` :
                             `${f.min} - ${f.max}`;
                return `<li>Transaction count ${desc}</li>`;
            } else if (f.type === 'spending') {
                const desc = f.filter_type === 'greater_than' ? `> $${f.value}` :
                             f.filter_type === 'less_than' ? `< $${f.value}` :
                             `$${f.min} - $${f.max}`;
                return `<li>Total spending ${desc}</li>`;
            }
            return `<li>${f.type}</li>`;
        }).join('');
        filterDetails.push(`
            <div class="border-l-4 border-green-400 pl-3 py-2">
                <div class="font-medium text-gray-900"><i class="fas fa-users mr-2 text-green-500"></i>Customer Filters (${filtersApplied.customers.count})</div>
                <ul class="text-sm text-gray-600 mt-1 list-disc list-inside">${customerFilterItems}</ul>
            </div>
        `);
    }

    // Products filter details
    if (filtersApplied.products?.type === 'multiple' && filtersApplied.products.filters?.length > 0) {
        const productFilterItems = filtersApplied.products.filters.map(f => {
            if (f.type === 'top_revenue') {
                return `<li>Top <strong>${f.percent}%</strong> products by revenue</li>`;
            } else if (f.type === 'category') {
                return `<li>${f.column}: ${f.mode} ${f.values?.slice(0, 3).join(', ')}${f.values?.length > 3 ? '...' : ''}</li>`;
            } else if (f.type === 'numeric') {
                const desc = f.filter_type === 'range' ? `${f.min} - ${f.max}` :
                             f.filter_type === 'greater_than' ? `> ${f.value}` :
                             f.filter_type === 'less_than' ? `< ${f.value}` : `= ${f.value}`;
                return `<li>${f.column}: ${desc}</li>`;
            }
            return `<li>${f.type}</li>`;
        }).join('');
        filterDetails.push(`
            <div class="border-l-4 border-purple-400 pl-3 py-2">
                <div class="font-medium text-gray-900"><i class="fas fa-box mr-2 text-purple-500"></i>Product Filters (${filtersApplied.products.count})</div>
                <ul class="text-sm text-gray-600 mt-1 list-disc list-inside">${productFilterItems}</ul>
            </div>
        `);
    }

    // Build column stats table rows
    const columnStatsRows = Object.entries(columnStats).map(([colName, stats]) => {
        return `
            <tr>
                <td class="px-3 py-2 text-sm text-gray-900">${getDisplayName(colName)}</td>
                <td class="px-3 py-2"><span class="inline-block px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-700">${stats.type || 'UNKNOWN'}</span></td>
                <td class="px-3 py-2 text-sm text-gray-600">${ds_formatDetailColumnStats(stats)}</td>
            </tr>
        `;
    }).join('');

    const html = `
        <div class="space-y-4">
            <!-- Info -->
            <div class="flex items-center gap-3">
                <span class="text-sm text-gray-500">Created ${summary.timestamps?.created_at ? new Date(summary.timestamps.created_at).toLocaleDateString() : 'Unknown'}</span>
                ${snapshot.has_snapshot ? `<span class="px-3 py-1 rounded-full text-sm font-bold bg-green-100 text-green-700">${ds_formatNumber(snapshot.total_rows)} rows</span>` : ''}
            </div>

            ${summary.description ? `<p class="text-gray-600">${ds_escapeHtml(summary.description)}</p>` : ''}

            <!-- Tables & Joins -->
            <div class="bg-white rounded-lg p-4 border border-gray-300">
                <h4 class="font-semibold text-gray-900 mb-2"><i class="fas fa-database mr-2 text-gray-500"></i>Tables & Joins</h4>
                <div class="space-y-2">
                    <div class="flex items-center">
                        <span class="text-sm font-medium text-gray-700 w-24">Primary:</span>
                        <span class="text-sm text-gray-900 font-medium">${summary.tables?.primary?.replace('raw_data.', '') || summary.primary_table?.replace('raw_data.', '') || 'Not set'}</span>
                    </div>
                    ${(summary.tables?.secondary?.length > 0 || summary.secondary_tables?.length > 0) ? `
                    <div class="flex items-start">
                        <span class="text-sm font-medium text-gray-700 w-24">Secondary:</span>
                        <span class="text-sm text-gray-900">${(summary.tables?.secondary || summary.secondary_tables || []).map(t => t.replace('raw_data.', '')).join(', ')}</span>
                    </div>
                    ` : ''}
                    ${Object.keys(joinConfig).length > 0 ? `
                    <div class="mt-3 pt-3 border-t border-gray-200">
                        <div class="text-sm font-medium text-gray-700 mb-2">Join Keys:</div>
                        ${joinRows}
                    </div>
                    ` : ''}
                </div>
            </div>

            <!-- Filters Applied (Detailed) -->
            ${filterDetails.length > 0 ? `
            <div class="bg-white rounded-lg p-4 border border-gray-300">
                <h4 class="font-semibold text-gray-900 mb-3"><i class="fas fa-filter mr-2 text-gray-500"></i>Filters Applied</h4>
                <div class="space-y-3">
                    ${filterDetails.join('')}
                </div>
            </div>
            ` : `
            <div class="bg-white rounded-lg p-4 border border-gray-300">
                <h4 class="font-semibold text-gray-900 mb-2"><i class="fas fa-filter mr-2 text-gray-500"></i>Filters Applied</h4>
                <p class="text-sm text-gray-500">No filters applied - using all data</p>
            </div>
            `}

            <!-- Column Statistics -->
            ${snapshot.has_snapshot && Object.keys(columnStats).length > 0 ? `
            <div class="bg-white rounded-lg p-4 border border-gray-300">
                <h4 class="font-semibold text-gray-900 mb-3"><i class="fas fa-chart-bar mr-2 text-gray-500"></i>Column Statistics</h4>
                <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-3 py-2 text-xs font-semibold text-gray-700 uppercase">Column</th>
                                <th class="px-3 py-2 text-xs font-semibold text-gray-700 uppercase">Type</th>
                                <th class="px-3 py-2 text-xs font-semibold text-gray-700 uppercase">Statistics</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            ${columnStatsRows}
                        </tbody>
                    </table>
                </div>
                ${snapshot.snapshot_at ? `
                <div class="mt-3 text-xs text-gray-500">
                    <i class="fas fa-clock mr-1"></i>Snapshot from ${new Date(snapshot.snapshot_at).toLocaleString()}
                </div>
                ` : ''}
            </div>
            ` : ''}

            ${!snapshot.has_snapshot ? `
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <p class="text-sm text-yellow-800">
                    <i class="fas fa-info-circle mr-1"></i>
                    No summary snapshot available. Edit the dataset to generate statistics.
                </p>
            </div>
            ` : ''}
        </div>
    `;

    content.innerHTML = html;
}

function ds_formatDetailColumnStats(stats) {
    if (!stats) return 'N/A';
    const parts = [];
    if (stats.distinct !== undefined) parts.push(`${ds_formatNumber(stats.distinct)} distinct`);
    if (stats.min !== undefined && stats.max !== undefined) parts.push(`range: ${stats.min} - ${stats.max}`);
    if (stats.null_percent !== undefined) parts.push(`${stats.null_percent.toFixed(1)}% null`);
    return parts.join(' | ') || 'N/A';
}

function ds_closeDetailModal() {
    document.getElementById('dsDetailModal').classList.add('hidden');
}

function ds_editDataset(datasetId) {
    ds_openWizard(datasetId);
}

function ds_editDatasetFromDetail() {
    ds_closeDetailModal();
    if (ds_currentDatasetId) {
        ds_openWizard(ds_currentDatasetId);
    }
}

function ds_loadDatasetForEdit(datasetId) {
    fetch(`/api/datasets/${datasetId}/`)
        .then(r => r.json())
        .then(data => {
            if (data.status === 'success') {
                const ds = data.dataset;

                // Populate wizard data - all fields
                ds_wizardData.name = ds.name || '';
                ds_wizardData.description = ds.description || '';
                ds_wizardData.primaryTable = ds.primary_table;
                ds_wizardData.secondaryTables = ds.secondary_tables || [];
                ds_wizardData.joinConfig = ds.join_config || {};
                ds_wizardData.selectedColumns = ds.selected_columns || {};
                ds_wizardData.columnAliases = ds.column_aliases || {};
                ds_wizardData.filters = ds.filters || {};

                // Restore schema builder state for Step 3
                ds_schemaBuilderState.selectedColumns = {...ds_wizardData.selectedColumns};
                ds_schemaBuilderState.columnAliases = {...ds_wizardData.columnAliases};

                // Convert join_config dict to joins array for schema builder
                ds_schemaBuilderState.joins = ds_convertJoinConfigToArray(
                    ds_wizardData.joinConfig,
                    ds_wizardData.primaryTable
                );

                // Update form fields
                document.getElementById('dsDatasetName').value = ds_wizardData.name;
                document.getElementById('dsDatasetDescription').value = ds_wizardData.description;

                // Re-render tables with selections
                ds_renderPrimaryTableList();
                ds_renderSecondaryTableList();

                ds_validateCurrentStep();
            }
        })
        .catch(err => console.error('Error loading dataset:', err));
}

/**
 * Convert join_config dict format (from DB) to joins array format (for schema builder).
 *
 * DB format: { "raw_data.products": { join_key: "x", primary_column: "x", secondary_column: "y", join_type: "LEFT" } }
 * Schema builder format: [{ leftTable, rightTable, leftCol, rightCol, type }]
 */
function ds_convertJoinConfigToArray(joinConfig, primaryTable) {
    if (!joinConfig || Object.keys(joinConfig).length === 0) {
        return [];
    }

    const joins = [];
    for (const [secondaryTable, config] of Object.entries(joinConfig)) {
        joins.push({
            leftTable: primaryTable,
            rightTable: secondaryTable,
            leftCol: config.primary_column || config.join_key,
            rightCol: config.secondary_column || config.join_key,
            type: (config.join_type || 'LEFT').toLowerCase()
        });
    }
    return joins;
}

function ds_deleteDataset(datasetId, name) {
    ds_currentDatasetId = datasetId;
    document.getElementById('dsDeleteDatasetName').textContent = name;
    document.getElementById('dsDeleteModal').classList.remove('hidden');
}

function ds_closeDeleteModal() {
    document.getElementById('dsDeleteModal').classList.add('hidden');
}

function ds_confirmDelete() {
    if (!ds_currentDatasetId) return;

    fetch(`/api/datasets/${ds_currentDatasetId}/delete/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ force: true })
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'success') {
            ds_showNotification('Dataset deleted', 'success');
            ds_closeDeleteModal();
            ds_loadDatasets();
            fc_loadDatasets();  // Refresh Feature Config dropdown
        } else {
            ds_showNotification(data.message || 'Failed to delete', 'error');
        }
    })
    .catch(err => {
        console.error('Error deleting dataset:', err);
        ds_showNotification('Failed to delete dataset', 'error');
    });
}

// =============================================================================
// DATASET - Query Preview
// =============================================================================

function ds_viewGeneratedQuery(datasetId) {
    // Use provided datasetId or fall back to ds_currentDatasetId (from detail modal)
    const id = datasetId || ds_currentDatasetId;
    if (!id) return;

    fetch(`/api/datasets/${id}/query/`)
        .then(r => r.json())
        .then(data => {
            if (data.status === 'success') {
                document.getElementById('dsQueryContent').textContent = data.query || 'No query generated';
                document.getElementById('dsQueryModal').classList.remove('hidden');
            }
        })
        .catch(err => console.error('Error loading query:', err));
}

function ds_closeQueryModal() {
    document.getElementById('dsQueryModal').classList.add('hidden');
}

function ds_copyQuery() {
    const query = document.getElementById('dsQueryContent').textContent;
    navigator.clipboard.writeText(query).then(() => {
        ds_showNotification('Query copied to clipboard', 'success');
    });
}

// =============================================================================
// DATASET - Clone
// =============================================================================

let ds_cloneDatasetId = null;
let ds_cloneDatasetName = null;

function ds_cloneDataset(datasetId, name) {
    ds_cloneDatasetId = datasetId;
    ds_cloneDatasetName = name;

    document.getElementById('dsCloneSourceName').textContent = name;
    document.getElementById('dsCloneName').value = `${name} (Copy)`;

    document.getElementById('dsCloneModal').classList.remove('hidden');

    // Focus the input
    setTimeout(() => {
        document.getElementById('dsCloneName').select();
    }, 100);
}

function ds_closeCloneModal() {
    document.getElementById('dsCloneModal').classList.add('hidden');
    ds_cloneDatasetId = null;
    ds_cloneDatasetName = null;
}

function ds_confirmClone() {
    const newName = document.getElementById('dsCloneName').value.trim();

    if (!newName) {
        ds_showNotification('Please enter a name for the cloned dataset', 'error');
        return;
    }

    if (!ds_cloneDatasetId) {
        ds_showNotification('No dataset selected for cloning', 'error');
        return;
    }

    // Check if clone API exists, otherwise use create with copied data
    fetch(`/api/datasets/${ds_cloneDatasetId}/clone/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ name: newName })
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'success') {
            ds_showNotification('Dataset cloned successfully', 'success');
            ds_closeCloneModal();
            ds_loadDatasets();
            fc_loadDatasets();  // Refresh Feature Config dropdown
        } else {
            ds_showNotification(data.message || 'Failed to clone dataset', 'error');
        }
    })
    .catch(err => {
        console.error('Error cloning dataset:', err);
        ds_showNotification('Failed to clone dataset', 'error');
    });
}

// Clone from Detail modal
function ds_cloneDatasetFromDetail() {
    ds_closeDetailModal();
    if (ds_currentDatasetId) {
        // Find the dataset name from ds_allDatasets (Dataset chapter's array)
        const dataset = ds_allDatasets.find(d => d.id === ds_currentDatasetId);
        const name = dataset?.name || 'Dataset';
        ds_cloneDataset(ds_currentDatasetId, name);
    }
}

// =============================================================================
// DATASET - Compare
// =============================================================================

let ds_compareLeftDataset = null;
let ds_compareRightDataset = null;

// Track which accordion sections are expanded
let ds_compareExpandedSections = {
    basicInfo: false,
    tables: false,
    columns: false,
    filters: false,
    stats: false
};

function ds_openCompareModal() {
    // Populate dropdowns with all datasets
    const leftSelect = document.getElementById('dsCompareLeftSelect');
    const rightSelect = document.getElementById('dsCompareRightSelect');

    // Clear existing options except the placeholder
    leftSelect.innerHTML = '<option value="">Select dataset...</option>';
    rightSelect.innerHTML = '<option value="">Select dataset...</option>';

    // Add all datasets to both dropdowns
    ds_allDatasets.forEach(dataset => {
        const optionLeft = document.createElement('option');
        optionLeft.value = dataset.id;
        optionLeft.textContent = dataset.name;
        leftSelect.appendChild(optionLeft);

        const optionRight = document.createElement('option');
        optionRight.value = dataset.id;
        optionRight.textContent = dataset.name;
        rightSelect.appendChild(optionRight);
    });

    // Reset to placeholder state
    ds_resetCompareColumn('left');
    ds_resetCompareColumn('right');

    // Reset accordion states - collapse all
    ds_compareExpandedSections = {
        basicInfo: false,
        tables: false,
        columns: false,
        filters: false,
        stats: false
    };
    ds_syncCompareAccordionStates();

    // Reset state
    ds_compareLeftDataset = null;
    ds_compareRightDataset = null;

    // Show modal
    document.getElementById('dsCompareModal').classList.remove('hidden');
}

function ds_closeCompareModal() {
    document.getElementById('dsCompareModal').classList.add('hidden');
    ds_compareLeftDataset = null;
    ds_compareRightDataset = null;
}

// Toggle accordion section
function ds_toggleCompareSection(sectionName) {
    ds_compareExpandedSections[sectionName] = !ds_compareExpandedSections[sectionName];
    ds_syncCompareAccordionStates();
}

// Sync accordion visual states with tracked state
function ds_syncCompareAccordionStates() {
    const sections = ['basicInfo', 'tables', 'columns', 'filters', 'stats'];

    sections.forEach(section => {
        const contentId = `dsCompare${section.charAt(0).toUpperCase() + section.slice(1)}Content`;
        const chevronId = `dsCompare${section.charAt(0).toUpperCase() + section.slice(1)}Chevron`;

        const content = document.getElementById(contentId);
        const chevron = document.getElementById(chevronId);

        if (content && chevron) {
            if (ds_compareExpandedSections[section]) {
                content.classList.remove('hidden');
                chevron.classList.add('expanded');
            } else {
                content.classList.add('hidden');
                chevron.classList.remove('expanded');
            }
        }
    });
}

function ds_resetCompareColumn(side) {
    const prefix = side === 'left' ? 'dsCompareLeft' : 'dsCompareRight';

    // Reset BasicInfo
    document.getElementById(`${prefix}BasicInfo`).innerHTML = `
        <div class="ds-compare-placeholder">Select a dataset</div>
    `;

    // Reset Tables
    document.getElementById(`${prefix}Tables`).innerHTML = `
        <div class="ds-compare-placeholder">Select a dataset</div>
    `;

    // Reset Columns
    document.getElementById(`${prefix}Columns`).innerHTML = `
        <div class="ds-compare-placeholder">Select a dataset</div>
    `;

    // Reset Filters - will be re-rendered via ds_renderCompareFilters()
    document.getElementById(`${prefix}Filters`).innerHTML = `
        <div class="ds-compare-placeholder">Select a dataset</div>
    `;

    // Re-render filters for both sides (to handle alignment when one side is reset)
    setTimeout(() => ds_renderCompareFilters(), 0);

    // Reset Stats
    document.getElementById(`${prefix}Stats`).innerHTML = `
        <div class="ds-compare-placeholder">Select a dataset</div>
    `;
}

function ds_onCompareSelectChange(side) {
    const selectId = side === 'left' ? 'dsCompareLeftSelect' : 'dsCompareRightSelect';
    const datasetId = document.getElementById(selectId).value;

    if (!datasetId) {
        // Reset this side
        ds_resetCompareColumn(side);
        if (side === 'left') ds_compareLeftDataset = null;
        else ds_compareRightDataset = null;
        ds_updateCompareStatuses();
        return;
    }

    // Show loading state
    const prefix = side === 'left' ? 'dsCompareLeft' : 'dsCompareRight';
    document.getElementById(`${prefix}BasicInfo`).innerHTML = `
        <div class="ds-compare-placeholder">
            <i class="fas fa-spinner fa-spin mr-2"></i>Loading...
        </div>
    `;

    // Fetch dataset data
    fetch(`/api/datasets/${datasetId}/`)
        .then(r => r.json())
        .then(data => {
            if (data.status === 'success') {
                const dataset = data.dataset;
                if (side === 'left') ds_compareLeftDataset = dataset;
                else ds_compareRightDataset = dataset;
                ds_renderCompareColumn(dataset, side);
                ds_updateCompareStatuses();
            } else {
                document.getElementById(`${prefix}BasicInfo`).innerHTML = `
                    <div class="ds-compare-placeholder" style="color: #ef4444;">
                        Failed to load
                    </div>
                `;
            }
        })
        .catch(err => {
            console.error('Error loading dataset for compare:', err);
            document.getElementById(`${prefix}BasicInfo`).innerHTML = `
                <div class="ds-compare-placeholder" style="color: #ef4444;">
                    Error loading
                </div>
            `;
        });
}

// Update status badges in accordion headers
function ds_updateCompareStatuses() {
    const left = ds_compareLeftDataset;
    const right = ds_compareRightDataset;

    // Basic Info status
    const basicInfoStatus = document.getElementById('dsCompareBasicInfoStatus');
    if (left && right) {
        const diffs = [];
        if (left.name !== right.name) diffs.push('name');
        if ((left.version || 1) !== (right.version || 1)) diffs.push('version');
        basicInfoStatus.textContent = diffs.length > 0 ? `${diffs.length} difference${diffs.length > 1 ? 's' : ''}` : '';
    } else {
        basicInfoStatus.textContent = '';
    }

    // Tables status
    const tablesStatus = document.getElementById('dsCompareTablesStatus');
    if (left && right) {
        const leftTables = 1 + (left.secondary_tables?.length || 0);
        const rightTables = 1 + (right.secondary_tables?.length || 0);
        if (leftTables !== rightTables || left.primary_table !== right.primary_table) {
            tablesStatus.textContent = 'Different';
        } else {
            tablesStatus.textContent = '';
        }
    } else {
        tablesStatus.textContent = '';
    }

    // Columns status
    const columnsStatus = document.getElementById('dsCompareColumnsStatus');
    if (left && right) {
        const leftCount = Object.values(left.selected_columns || {}).flat().length;
        const rightCount = Object.values(right.selected_columns || {}).flat().length;
        if (leftCount !== rightCount) {
            columnsStatus.textContent = `${leftCount} vs ${rightCount}`;
        } else {
            columnsStatus.textContent = '';
        }
    } else {
        columnsStatus.textContent = '';
    }

    // Filters status
    const filtersStatus = document.getElementById('dsCompareFiltersStatus');
    if (left && right) {
        const leftCount = ds_countFiltersFromDataset(left.filters || {});
        const rightCount = ds_countFiltersFromDataset(right.filters || {});
        if (leftCount !== rightCount) {
            filtersStatus.textContent = `${leftCount} vs ${rightCount}`;
        } else if (leftCount > 0) {
            filtersStatus.textContent = `${leftCount} filter${leftCount > 1 ? 's' : ''}`;
        } else {
            filtersStatus.textContent = '';
        }
    } else {
        filtersStatus.textContent = '';
    }

    // Stats status
    const statsStatus = document.getElementById('dsCompareStatsStatus');
    if (left && right) {
        const leftRows = left.summary_snapshot?.total_rows;
        const rightRows = right.summary_snapshot?.total_rows;
        if (leftRows != null && rightRows != null && leftRows !== rightRows) {
            statsStatus.textContent = 'Different';
        } else {
            statsStatus.textContent = '';
        }
    } else {
        statsStatus.textContent = '';
    }
}

// Helper to count active filters from dataset.filters structure
function ds_countFiltersFromDataset(filters) {
    let count = 0;

    // Date filter - stored under filters.history
    const history = filters.history || {};
    if (history.rolling_days || history.start_date) {
        count++;
    }

    // Customer filters
    const customerFilter = filters.customer_filter || {};
    if (customerFilter.top_revenue?.enabled) count++;
    count += (customerFilter.category_filters || []).filter(f => f.column && f.values?.length > 0).length;
    count += (customerFilter.numeric_filters || []).filter(f => f.column).length;
    count += (customerFilter.aggregation_filters || []).filter(f => f.enabled && f.column).length;

    // Product filters
    const productFilter = filters.product_filter || {};
    if (productFilter.top_revenue?.enabled) count++;
    count += (productFilter.category_filters || []).filter(f => f.column && f.values?.length > 0).length;
    count += (productFilter.numeric_filters || []).filter(f => f.column).length;

    return count;
}

// Helper to extract filter details from dataset.filters
function ds_extractFilterDetails(filters) {
    const result = {
        dateFilter: null,
        customerFilters: [],
        productFilters: []
    };

    if (!filters) return result;

    // Date filter - stored under filters.history
    const history = filters.history || {};
    const timestampCol = history.timestamp_column;
    if (history.rolling_days) {
        const colName = timestampCol ? timestampCol.split('.').pop() : '';
        result.dateFilter = `Last ${history.rolling_days} days${colName ? ` (${colName})` : ''}`;
    } else if (history.start_date) {
        const colName = timestampCol ? timestampCol.split('.').pop() : '';
        result.dateFilter = `Since ${history.start_date}${colName ? ` (${colName})` : ''}`;
    }

    // Customer filters
    const customerFilter = filters.customer_filter || {};
    if (customerFilter.top_revenue?.enabled) {
        result.customerFilters.push(`Top ${customerFilter.top_revenue.threshold_percent || 80}% by revenue`);
    }
    (customerFilter.category_filters || []).forEach(cf => {
        if (cf.column && cf.values && cf.values.length > 0) {
            const colName = cf.column.split('.').pop();
            const mode = cf.mode === 'exclude' ? 'NOT IN' : 'IN';
            const valuesStr = cf.values.length <= 3
                ? cf.values.join(', ')
                : `${cf.values.slice(0, 3).join(', ')} +${cf.values.length - 3} more`;
            result.customerFilters.push(`${colName} ${mode} (${valuesStr})`);
        }
    });
    (customerFilter.numeric_filters || []).forEach(nf => {
        if (nf.column) {
            const colName = nf.column.split('.').pop();
            const filterType = nf.filter_type || nf.type || 'range';
            if (filterType === 'range') {
                result.customerFilters.push(`${colName}: ${nf.min || '*'} - ${nf.max || '*'}`);
            } else if (filterType === 'min') {
                result.customerFilters.push(`${colName} >= ${nf.value}`);
            } else if (filterType === 'max') {
                result.customerFilters.push(`${colName} <= ${nf.value}`);
            }
        }
    });
    (customerFilter.aggregation_filters || []).forEach(af => {
        if (af.enabled && af.column) {
            const colName = af.column.split('.').pop();
            result.customerFilters.push(`Min ${af.aggregation || 'count'} ${colName}: ${af.min_value || 0}`);
        }
    });

    // Product filters
    const productFilter = filters.product_filter || {};
    if (productFilter.top_revenue?.enabled) {
        result.productFilters.push(`Top ${productFilter.top_revenue.threshold_percent || 80}% by revenue`);
    }
    (productFilter.category_filters || []).forEach(cf => {
        if (cf.column && cf.values && cf.values.length > 0) {
            const colName = cf.column.split('.').pop();
            const mode = cf.mode === 'exclude' ? 'NOT IN' : 'IN';
            const valuesStr = cf.values.length <= 3
                ? cf.values.join(', ')
                : `${cf.values.slice(0, 3).join(', ')} +${cf.values.length - 3} more`;
            result.productFilters.push(`${colName} ${mode} (${valuesStr})`);
        }
    });
    (productFilter.numeric_filters || []).forEach(nf => {
        if (nf.column) {
            const colName = nf.column.split('.').pop();
            const filterType = nf.filter_type || nf.type || 'range';
            if (filterType === 'range') {
                result.productFilters.push(`${colName}: ${nf.min || '*'} - ${nf.max || '*'}`);
            } else if (filterType === 'min') {
                result.productFilters.push(`${colName} >= ${nf.value}`);
            } else if (filterType === 'max') {
                result.productFilters.push(`${colName} <= ${nf.value}`);
            }
        }
    });

    return result;
}

// Render filters for both sides with aligned rows
function ds_renderCompareFilters() {
    const left = ds_compareLeftDataset;
    const right = ds_compareRightDataset;

    // If neither side has data, show placeholders
    if (!left && !right) {
        document.getElementById('dsCompareLeftFilters').innerHTML = `
            <div class="ds-compare-placeholder">Select a dataset</div>
        `;
        document.getElementById('dsCompareRightFilters').innerHTML = `
            <div class="ds-compare-placeholder">Select a dataset</div>
        `;
        return;
    }

    // Extract filter details for both sides
    const leftDetails = ds_extractFilterDetails(left?.filters);
    const rightDetails = ds_extractFilterDetails(right?.filters);

    // Build aligned HTML for both sides
    let leftHtml = '';
    let rightHtml = '';

    // --- Date Filter (always 1 row each) ---
    leftHtml += `
        <div class="ds-compare-row">
            <span class="ds-compare-label"><i class="fas fa-calendar-alt ${leftDetails.dateFilter ? 'text-blue-500' : 'text-gray-300'} mr-1"></i>Date Filter</span>
            <span class="ds-compare-value ${!leftDetails.dateFilter ? 'text-gray-400' : ''}">${leftDetails.dateFilter || 'None'}</span>
        </div>
    `;
    rightHtml += `
        <div class="ds-compare-row">
            <span class="ds-compare-label"><i class="fas fa-calendar-alt ${rightDetails.dateFilter ? 'text-blue-500' : 'text-gray-300'} mr-1"></i>Date Filter</span>
            <span class="ds-compare-value ${!rightDetails.dateFilter ? 'text-gray-400' : ''}">${rightDetails.dateFilter || 'None'}</span>
        </div>
    `;

    // --- Customer Filters (aligned rows) ---
    const maxCustomerRows = Math.max(leftDetails.customerFilters.length, rightDetails.customerFilters.length);

    // Header row
    leftHtml += `
        <div class="ds-compare-row" style="margin-top: 8px;">
            <span class="ds-compare-label" style="font-weight: 600;"><i class="fas fa-users ${leftDetails.customerFilters.length > 0 ? 'text-green-500' : 'text-gray-300'} mr-1"></i>Customer Filters</span>
            <span class="ds-compare-value ${leftDetails.customerFilters.length === 0 ? 'text-gray-400' : ''}">${leftDetails.customerFilters.length > 0 ? leftDetails.customerFilters.length + ' filter(s)' : 'None'}</span>
        </div>
    `;
    rightHtml += `
        <div class="ds-compare-row" style="margin-top: 8px;">
            <span class="ds-compare-label" style="font-weight: 600;"><i class="fas fa-users ${rightDetails.customerFilters.length > 0 ? 'text-green-500' : 'text-gray-300'} mr-1"></i>Customer Filters</span>
            <span class="ds-compare-value ${rightDetails.customerFilters.length === 0 ? 'text-gray-400' : ''}">${rightDetails.customerFilters.length > 0 ? rightDetails.customerFilters.length + ' filter(s)' : 'None'}</span>
        </div>
    `;

    // Detail rows (padded to align)
    for (let i = 0; i < maxCustomerRows; i++) {
        const leftVal = leftDetails.customerFilters[i] || '';
        const rightVal = rightDetails.customerFilters[i] || '';
        leftHtml += `
            <div class="ds-compare-row">
                <span class="ds-compare-label"></span>
                <span class="ds-compare-value" style="font-size: 12px;">${leftVal ? ds_escapeHtml(leftVal) : '&nbsp;'}</span>
            </div>
        `;
        rightHtml += `
            <div class="ds-compare-row">
                <span class="ds-compare-label"></span>
                <span class="ds-compare-value" style="font-size: 12px;">${rightVal ? ds_escapeHtml(rightVal) : '&nbsp;'}</span>
            </div>
        `;
    }

    // --- Product Filters (aligned rows) ---
    const maxProductRows = Math.max(leftDetails.productFilters.length, rightDetails.productFilters.length);

    // Header row
    leftHtml += `
        <div class="ds-compare-row" style="margin-top: 8px;">
            <span class="ds-compare-label" style="font-weight: 600;"><i class="fas fa-box ${leftDetails.productFilters.length > 0 ? 'text-orange-500' : 'text-gray-300'} mr-1"></i>Product Filters</span>
            <span class="ds-compare-value ${leftDetails.productFilters.length === 0 ? 'text-gray-400' : ''}">${leftDetails.productFilters.length > 0 ? leftDetails.productFilters.length + ' filter(s)' : 'None'}</span>
        </div>
    `;
    rightHtml += `
        <div class="ds-compare-row" style="margin-top: 8px;">
            <span class="ds-compare-label" style="font-weight: 600;"><i class="fas fa-box ${rightDetails.productFilters.length > 0 ? 'text-orange-500' : 'text-gray-300'} mr-1"></i>Product Filters</span>
            <span class="ds-compare-value ${rightDetails.productFilters.length === 0 ? 'text-gray-400' : ''}">${rightDetails.productFilters.length > 0 ? rightDetails.productFilters.length + ' filter(s)' : 'None'}</span>
        </div>
    `;

    // Detail rows (padded to align)
    for (let i = 0; i < maxProductRows; i++) {
        const leftVal = leftDetails.productFilters[i] || '';
        const rightVal = rightDetails.productFilters[i] || '';
        leftHtml += `
            <div class="ds-compare-row">
                <span class="ds-compare-label"></span>
                <span class="ds-compare-value" style="font-size: 12px;">${leftVal ? ds_escapeHtml(leftVal) : '&nbsp;'}</span>
            </div>
        `;
        rightHtml += `
            <div class="ds-compare-row">
                <span class="ds-compare-label"></span>
                <span class="ds-compare-value" style="font-size: 12px;">${rightVal ? ds_escapeHtml(rightVal) : '&nbsp;'}</span>
            </div>
        `;
    }

    // Update DOM - show placeholder for side without data
    if (left) {
        document.getElementById('dsCompareLeftFilters').innerHTML = leftHtml;
    } else {
        document.getElementById('dsCompareLeftFilters').innerHTML = `
            <div class="ds-compare-placeholder">Select a dataset</div>
        `;
    }
    if (right) {
        document.getElementById('dsCompareRightFilters').innerHTML = rightHtml;
    } else {
        document.getElementById('dsCompareRightFilters').innerHTML = `
            <div class="ds-compare-placeholder">Select a dataset</div>
        `;
    }
}

function ds_renderCompareColumn(dataset, side) {
    const prefix = side === 'left' ? 'dsCompareLeft' : 'dsCompareRight';
    const snapshot = dataset.summary_snapshot || {};

    // Render Basic Info
    const createdAt = dataset.created_at ? new Date(dataset.created_at).toLocaleDateString() : 'N/A';
    // Limit description to 65 characters
    let descriptionText = 'N/A';
    if (dataset.description && dataset.description.trim()) {
        descriptionText = dataset.description.length > 65
            ? dataset.description.substring(0, 65) + '...'
            : dataset.description;
    }
    document.getElementById(`${prefix}BasicInfo`).innerHTML = `
        <h4>${ds_escapeHtml(dataset.name)}</h4>
        <div class="ds-compare-row">
            <span class="ds-compare-label">Description</span>
            <span class="ds-compare-value ${descriptionText === 'N/A' ? 'text-gray-400' : ''}">${ds_escapeHtml(descriptionText)}</span>
        </div>
        <div class="ds-compare-row">
            <span class="ds-compare-label">Version</span>
            <span class="ds-compare-value">${dataset.version || 1}</span>
        </div>
        <div class="ds-compare-row">
            <span class="ds-compare-label">Created</span>
            <span class="ds-compare-value">${createdAt}</span>
        </div>
    `;

    // Render Tables & Joins
    const primaryTable = dataset.primary_table ? dataset.primary_table.replace('raw_data.', '') : 'N/A';
    const secondaryTables = dataset.secondary_tables || [];
    const joinConfig = dataset.join_config || {};

    // Build secondary tables rows - each table on its own row for alignment
    let secondaryTablesHtml = '';
    if (secondaryTables.length > 0) {
        secondaryTables.forEach((table, index) => {
            const tableName = table.replace('raw_data.', '');
            const label = index === 0 ? 'Secondary Tables' : '';
            secondaryTablesHtml += `
                <div class="ds-compare-row">
                    <span class="ds-compare-label">${label}</span>
                    <span class="ds-compare-value">${ds_escapeHtml(tableName)}</span>
                </div>
            `;
        });
    } else {
        secondaryTablesHtml = `
            <div class="ds-compare-row">
                <span class="ds-compare-label">Secondary Tables</span>
                <span class="ds-compare-value text-gray-400">None</span>
            </div>
        `;
    }

    // Build joins rows - each join on its own row for alignment
    let joinsHtml = '';
    if (Object.keys(joinConfig).length > 0) {
        const joinEntries = Object.entries(joinConfig);
        joinEntries.forEach(([table, config], index) => {
            const tableName = table.replace('raw_data.', '');
            const label = index === 0 ? 'Joins' : '';
            joinsHtml += `
                <div class="ds-compare-row">
                    <span class="ds-compare-label">${label}</span>
                    <span class="ds-compare-value">${tableName}  ${config.join_key} <span class="text-xs text-gray-400">(${config.join_type || 'LEFT'})</span></span>
                </div>
            `;
        });
    } else {
        joinsHtml = `
            <div class="ds-compare-row">
                <span class="ds-compare-label">Joins</span>
                <span class="ds-compare-value text-gray-400">None</span>
            </div>
        `;
    }

    document.getElementById(`${prefix}Tables`).innerHTML = `
        <div class="ds-compare-row">
            <span class="ds-compare-label">Primary Table</span>
            <span class="ds-compare-value">${ds_escapeHtml(primaryTable)}</span>
        </div>
        ${secondaryTablesHtml}
        ${joinsHtml}
    `;

    // Render Columns - each column on its own row, grouped by table
    const selectedColumns = dataset.selected_columns || {};
    let totalColumns = 0;
    let columnsHtml = '';

    // Sort tables to ensure consistent order (primary table first)
    const tableEntries = Object.entries(selectedColumns).sort((a, b) => {
        // Primary table (matches dataset.primary_table) should come first
        const aIsPrimary = a[0] === dataset.primary_table;
        const bIsPrimary = b[0] === dataset.primary_table;
        if (aIsPrimary) return -1;
        if (bIsPrimary) return 1;
        return a[0].localeCompare(b[0]);
    });

    tableEntries.forEach(([table, columns]) => {
        const tableName = table.replace('raw_data.', '');
        if (columns && columns.length > 0) {
            totalColumns += columns.length;

            // Table header with column count
            columnsHtml += `
                <div class="ds-compare-row" style="margin-top: 8px;">
                    <span class="ds-compare-label" style="font-weight: 600;">${tableName}</span>
                    <span class="ds-compare-value">${columns.length} columns</span>
                </div>
            `;

            // Each column on its own row
            columns.sort().forEach((col, index) => {
                columnsHtml += `
                    <div class="ds-compare-row">
                        <span class="ds-compare-label"></span>
                        <span class="ds-compare-value" style="font-size: 12px;">${ds_escapeHtml(col)}</span>
                    </div>
                `;
            });
        }
    });

    document.getElementById(`${prefix}Columns`).innerHTML = `
        <div class="ds-compare-row">
            <span class="ds-compare-label">Total Columns</span>
            <span class="ds-compare-value">${totalColumns}</span>
        </div>
        ${columnsHtml}
    `;

    // Filters are rendered separately via ds_renderCompareFilters() for alignment
    // Just set a placeholder here, it will be updated after both datasets are loaded
    document.getElementById(`${prefix}Filters`).innerHTML = `
        <div class="ds-compare-placeholder">Loading filters...</div>
    `;

    // Trigger aligned filter rendering if both datasets are loaded
    ds_renderCompareFilters();

    // Render Statistics - use snapshot data from step 4 of wizard
    const totalRows = dataset.snapshot_total_rows || dataset.row_count_estimate;
    const columnStats = dataset.column_stats || {};
    const columnCount = Object.keys(columnStats).length || dataset.snapshot_column_count || Object.values(dataset.selected_columns || {}).flat().length;

    let statsHtml = `
        <div class="ds-compare-row">
            <span class="ds-compare-label">Total Rows</span>
            <span class="ds-compare-value">${totalRows != null ? ds_formatNumber(totalRows) : 'N/A'}</span>
        </div>
        <div class="ds-compare-row">
            <span class="ds-compare-label">Columns</span>
            <span class="ds-compare-value">${columnCount || 'N/A'}</span>
        </div>
    `;

    // Add column statistics if available
    if (Object.keys(columnStats).length > 0) {
        statsHtml += `<div class="ds-compare-row" style="margin-top: 12px; border-top: 1px solid #e5e7eb; padding-top: 8px;">
            <span class="ds-compare-label" style="font-weight: 600;">Column Statistics</span>
            <span class="ds-compare-value"></span>
        </div>`;

        // Sort columns alphabetically
        const sortedCols = Object.keys(columnStats).sort();
        sortedCols.forEach(colKey => {
            const stats = columnStats[colKey];
            const colName = colKey.split('.').pop();
            const colType = stats.type || 'UNKNOWN';

            // Build stats string based on type
            let statsStr = '';
            if (stats.min !== undefined && stats.max !== undefined) {
                // Numeric or date range
                const minVal = stats.type?.includes('TIME') || stats.type === 'DATE'
                    ? stats.min?.split('T')[0] || stats.min
                    : (typeof stats.min === 'number' ? ds_formatNumber(stats.min) : stats.min);
                const maxVal = stats.type?.includes('TIME') || stats.type === 'DATE'
                    ? stats.max?.split('T')[0] || stats.max
                    : (typeof stats.max === 'number' ? ds_formatNumber(stats.max) : stats.max);
                statsStr = `range: ${minVal} - ${maxVal}`;
            }
            if (stats.null_percent !== undefined) {
                statsStr += (statsStr ? ' | ' : '') + `${stats.null_percent}% null`;
            }

            // Type badge color
            let typeBadgeClass = 'bg-gray-100 text-gray-700';
            if (colType.includes('INT') || colType.includes('FLOAT') || colType.includes('NUMERIC')) {
                typeBadgeClass = 'bg-blue-100 text-blue-700';
            } else if (colType.includes('TIME') || colType === 'DATE') {
                typeBadgeClass = 'bg-purple-100 text-purple-700';
            } else if (colType === 'STRING') {
                typeBadgeClass = 'bg-green-100 text-green-700';
            }

            statsHtml += `
                <div class="ds-compare-row">
                    <span class="ds-compare-label" style="font-size: 12px;">${ds_escapeHtml(colName)}</span>
                    <span class="ds-compare-value" style="font-size: 11px;">
                        <span class="px-1.5 py-0.5 rounded text-xs ${typeBadgeClass}" style="font-size: 10px;">${colType}</span>
                        ${statsStr ? `<span class="text-gray-500 ml-1">${statsStr}</span>` : ''}
                    </span>
                </div>
            `;
        });
    }

    document.getElementById(`${prefix}Stats`).innerHTML = statsHtml;
}

// =============================================================================
// DATASET - Notifications
// =============================================================================

function ds_showNotification(message, type = 'info') {
    const modal = document.getElementById('dsNotificationModal');
    const icon = document.getElementById('dsNotificationIcon');
    const title = document.getElementById('dsNotificationTitle');
    const msgEl = document.getElementById('dsNotificationMessage');

    // Set icon and title based on type
    const configs = {
        success: { icon: 'fa-check-circle', color: 'text-green-600', title: 'Success' },
        error: { icon: 'fa-exclamation-circle', color: 'text-red-600', title: 'Error' },
        warning: { icon: 'fa-exclamation-triangle', color: 'text-yellow-600', title: 'Warning' },
        info: { icon: 'fa-info-circle', color: 'text-blue-600', title: 'Info' }
    };

    const config = configs[type] || configs.info;
    icon.className = `fas ${config.icon} ${config.color} text-xl`;
    title.textContent = config.title;
    msgEl.textContent = message;

    modal.classList.remove('hidden');

    // Auto-close after 2 seconds
    setTimeout(() => {
        ds_closeNotification();
    }, 2000);
}

function ds_closeNotification() {
    document.getElementById('dsNotificationModal').classList.add('hidden');
}

// =============================================================================
// CONFIGS DASHBOARD (cfg_ prefix)
// =============================================================================

// Dashboard state
let cfg_state = {
    data: null,
    loading: false,
};

/**
 * Load dashboard statistics and render all components.
 */
function cfg_loadDashboard() {
    cfg_state.loading = true;
    document.getElementById('cfgDashboardLoading').classList.remove('hidden');
    document.getElementById('cfgDashboardEmpty').classList.add('hidden');
    document.getElementById('cfgDashboardContent').classList.add('hidden');

    fetch(`/api/models/${modelId}/configs/dashboard-stats/`)
        .then(r => r.json())
        .then(data => {
            cfg_state.loading = false;
            document.getElementById('cfgDashboardLoading').classList.add('hidden');

            if (data.success) {
                cfg_state.data = data.data;

                // Check if empty
                const hasData = data.data.datasets.total > 0 ||
                               data.data.feature_configs.total > 0 ||
                               data.data.model_configs.total > 0;

                if (!hasData) {
                    document.getElementById('cfgDashboardEmpty').classList.remove('hidden');
                } else {
                    document.getElementById('cfgDashboardContent').classList.remove('hidden');
                    cfg_renderKpiCards(data.data);
                    cfg_renderCoverageMatrix(data.data.coverage_matrix);
                    cfg_renderRelationships(data.data.relationships);
                }
            } else {
                console.error('Dashboard load failed:', data.error);
                document.getElementById('cfgDashboardEmpty').classList.remove('hidden');
            }
        })
        .catch(err => {
            cfg_state.loading = false;
            document.getElementById('cfgDashboardLoading').classList.add('hidden');
            document.getElementById('cfgDashboardEmpty').classList.remove('hidden');
            console.error('Error loading dashboard:', err);
        });
}

/**
 * Render 3 KPI cards for Datasets, Features, and Models.
 */
function cfg_renderKpiCards(stats) {
    const container = document.getElementById('cfgKpiRow');
    const ds = stats.datasets;
    const fc = stats.feature_configs;
    const mc = stats.model_configs;

    container.innerHTML = `
        <!-- Datasets KPI Card -->
        <div class="configs-dashboard-kpi-card" onclick="cfg_scrollToChapter('datasetsChapter')">
            <div class="configs-dashboard-kpi-header">
                <div class="configs-dashboard-kpi-icon datasets">
                    <i class="fas fa-database"></i>
                </div>
                <span class="configs-dashboard-kpi-title">Datasets</span>
            </div>
            <div class="configs-dashboard-kpi-stats">
                <div class="configs-dashboard-kpi-stat">
                    <div class="configs-dashboard-kpi-value">${ds.total}</div>
                    <div class="configs-dashboard-kpi-label">Total</div>
                </div>
                <div class="configs-dashboard-kpi-stat">
                    <div class="configs-dashboard-kpi-value active">${ds.active}</div>
                    <div class="configs-dashboard-kpi-label">Active</div>
                </div>
                <div class="configs-dashboard-kpi-stat">
                    <div class="configs-dashboard-kpi-value unused">${ds.unused}</div>
                    <div class="configs-dashboard-kpi-label">Unused</div>
                </div>
            </div>
            ${cfg_formatComplexityBar(ds.avg_complexity, 'dataset')}
        </div>

        <!-- Features KPI Card -->
        <div class="configs-dashboard-kpi-card" onclick="cfg_scrollToChapter('featuresChapter')">
            <div class="configs-dashboard-kpi-header">
                <div class="configs-dashboard-kpi-icon features">
                    <i class="fas fa-microchip"></i>
                </div>
                <span class="configs-dashboard-kpi-title">Feature Configs</span>
            </div>
            <div class="configs-dashboard-kpi-stats">
                <div class="configs-dashboard-kpi-stat">
                    <div class="configs-dashboard-kpi-value">${fc.total}</div>
                    <div class="configs-dashboard-kpi-label">Total</div>
                </div>
                <div class="configs-dashboard-kpi-stat">
                    <div class="configs-dashboard-kpi-value active">${fc.active}</div>
                    <div class="configs-dashboard-kpi-label">Active</div>
                </div>
                <div class="configs-dashboard-kpi-stat">
                    <div class="configs-dashboard-kpi-value unused">${fc.unused}</div>
                    <div class="configs-dashboard-kpi-label">Unused</div>
                </div>
            </div>
            ${cfg_formatComplexityBar(fc.avg_complexity, 'feature_config')}
        </div>

        <!-- Models KPI Card -->
        <div class="configs-dashboard-kpi-card" onclick="cfg_scrollToChapter('modelStructureChapter')">
            <div class="configs-dashboard-kpi-header">
                <div class="configs-dashboard-kpi-icon models">
                    <i class="fas fa-layer-group"></i>
                </div>
                <span class="configs-dashboard-kpi-title">Model Configs</span>
            </div>
            <div class="configs-dashboard-kpi-stats">
                <div class="configs-dashboard-kpi-stat">
                    <div class="configs-dashboard-kpi-value">${mc.total}</div>
                    <div class="configs-dashboard-kpi-label">Total</div>
                </div>
                <div class="configs-dashboard-kpi-stat">
                    <div class="configs-dashboard-kpi-value active">${mc.used}</div>
                    <div class="configs-dashboard-kpi-label">Used</div>
                </div>
                <div class="configs-dashboard-kpi-stat">
                    <div class="configs-dashboard-kpi-value unused">${mc.unused}</div>
                    <div class="configs-dashboard-kpi-label">Unused</div>
                </div>
            </div>
            ${cfg_formatComplexityBar(mc.avg_complexity, 'model_config')}
        </div>
    `;
}

/**
 * Render coverage matrix heatmap table.
 */
function cfg_renderCoverageMatrix(matrix) {
    const container = document.getElementById('cfgCoverageMatrix');

    // Check if we have data
    if (!matrix.feature_configs.length || !matrix.model_configs.length) {
        container.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <i class="fas fa-table text-2xl mb-2"></i>
                <p>Create FeatureConfigs and ModelConfigs to see the coverage matrix</p>
            </div>
        `;
        return;
    }

    // Build lookup for cells
    const cellLookup = {};
    matrix.cells.forEach(cell => {
        cellLookup[`${cell.feature_config_id}-${cell.model_config_id}`] = cell;
    });

    // Build table HTML
    let html = '<table class="configs-dashboard-matrix">';

    // Header row
    html += '<thead><tr><th class="row-header"></th>';
    matrix.model_configs.forEach(mc => {
        const typeIcon = mc.model_type === 'retrieval' ? 'fa-search' :
                        mc.model_type === 'ranking' ? 'fa-sort-amount-down' : 'fa-random';
        html += `<th title="${mc.name}">${mc.name.substring(0, 12)}${mc.name.length > 12 ? '...' : ''}</th>`;
    });
    html += '</tr></thead>';

    // Body rows
    html += '<tbody>';
    matrix.feature_configs.forEach(fc => {
        html += `<tr>`;
        html += `<th class="row-header" title="${fc.name} (${fc.dataset_name})">${fc.name.substring(0, 15)}${fc.name.length > 15 ? '...' : ''}</th>`;

        matrix.model_configs.forEach(mc => {
            const cell = cellLookup[`${fc.id}-${mc.id}`];
            const isCompatible = cell ? cell.is_compatible : true;

            if (!isCompatible) {
                html += `<td><div class="configs-dashboard-matrix-cell configs-dashboard-matrix-cell-na" title="Incompatible: ${fc.config_type} FeatureConfig with ${mc.model_type} ModelConfig">N/A</div></td>`;
            } else if (cell && cell.count > 0) {
                const heatClass = cfg_getHeatClass(cell.count);
                const recallText = cell.best_recall ? ` | Best: ${(cell.best_recall * 100).toFixed(1)}%` : '';
                html += `<td><div class="configs-dashboard-matrix-cell ${heatClass}" onclick="cfg_openExperimentFilter(${fc.id}, ${mc.id})" title="${cell.count} experiments${recallText}">${cell.count}</div></td>`;
            } else {
                html += `<td><div class="configs-dashboard-matrix-cell configs-dashboard-heat-0" onclick="cfg_openQuickTest(${fc.id}, ${mc.id})" title="No experiments yet - Click to run Quick Test">0</div></td>`;
            }
        });
        html += `</tr>`;
    });
    html += '</tbody></table>';

    container.innerHTML = html;
}

/**
 * Render relationships diagram showing Dataset  FeatureConfig  Experiments flow.
 */
function cfg_renderRelationships(relationships) {
    const container = document.getElementById('cfgRelationshipsDiagram');

    if (!relationships.length) {
        container.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <i class="fas fa-project-diagram text-2xl mb-2"></i>
                <p>Create Datasets to see the configuration flow</p>
            </div>
        `;
        return;
    }

    // Build flow diagram HTML
    let html = '<div class="configs-dashboard-flow-container">';

    // Datasets column
    html += '<div class="configs-dashboard-flow-column">';
    html += '<div class="configs-dashboard-flow-title">Datasets</div>';
    relationships.forEach(rel => {
        const fcCount = rel.feature_configs.length;
        html += `
            <div class="configs-dashboard-node dataset" onclick="cfg_scrollToDataset(${rel.dataset_id})" data-dataset-id="${rel.dataset_id}">
                <div class="configs-dashboard-node-name" title="${rel.dataset_name}">${rel.dataset_name}</div>
                <div class="configs-dashboard-node-meta">${fcCount} Feature Config${fcCount !== 1 ? 's' : ''}</div>
            </div>
        `;
    });
    html += '</div>';

    // Feature Configs column
    html += '<div class="configs-dashboard-flow-column">';
    html += '<div class="configs-dashboard-flow-title">Feature Configs</div>';
    relationships.forEach(rel => {
        rel.feature_configs.forEach(fc => {
            const typeBadge = fc.config_type === 'retrieval' ?
                '<span class="model-type-badge model-type-retrieval"><i class="fas fa-search"></i>Retrieval</span>' :
                '<span class="model-type-badge model-type-ranking"><i class="fas fa-sort-amount-down"></i>Ranking</span>';
            const expBadge = fc.experiment_count > 0 ?
                `<span class="configs-dashboard-node-badge experiments"><i class="fas fa-flask"></i>${fc.completed_count}/${fc.experiment_count}</span>` : '';

            html += `
                <div class="configs-dashboard-node feature-config" onclick="cfg_scrollToFeatureConfig(${fc.id})" data-fc-id="${fc.id}" data-dataset-id="${rel.dataset_id}">
                    <div class="configs-dashboard-node-name" title="${fc.name}">${fc.name}</div>
                    <div class="configs-dashboard-node-meta">${typeBadge}</div>
                    ${expBadge}
                </div>
            `;
        });
    });
    html += '</div>';

    html += '</div>';
    container.innerHTML = html;
}

/**
 * Smooth scroll to a chapter section.
 */
function cfg_scrollToChapter(chapterId) {
    // Map friendly IDs to actual element patterns
    const chapterMap = {
        'datasetsChapter': 'datasetsList',
        'featuresChapter': 'configsList',
        'modelStructureChapter': 'modelConfigsList'
    };

    const targetId = chapterMap[chapterId] || chapterId;
    const target = document.getElementById(targetId);
    if (target) {
        // Scroll to the parent chapter section
        const chapter = target.closest('.bg-white');
        if (chapter) {
            chapter.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }
}

function cfg_scrollToDataset(datasetId) {
    // Scroll to datasets chapter and highlight the dataset
    cfg_scrollToChapter('datasetsChapter');
}

function cfg_scrollToFeatureConfig(fcId) {
    // Scroll to features chapter
    cfg_scrollToChapter('featuresChapter');
}

/**
 * Generate complexity bar HTML.
 */
function cfg_formatComplexityBar(score, type) {
    // Thresholds based on type
    let lowMax, medMax;
    if (type === 'dataset') {
        lowMax = 5;
        medMax = 15;
    } else if (type === 'feature_config') {
        lowMax = 10;
        medMax = 25;
    } else {
        lowMax = 8;
        medMax = 15;
    }

    // Calculate percentages (capped at 100%)
    const total = Math.max(score, medMax * 1.5);
    const lowPct = Math.min((Math.min(score, lowMax) / total) * 100, 100);
    const medPct = score > lowMax ? Math.min(((Math.min(score, medMax) - lowMax) / total) * 100, 100 - lowPct) : 0;
    const highPct = score > medMax ? Math.min(((score - medMax) / total) * 100, 100 - lowPct - medPct) : 0;

    const complexityLabel = score <= lowMax ? 'Low' : score <= medMax ? 'Medium' : 'High';

    return `
        <div class="configs-dashboard-complexity-row">
            <div class="configs-dashboard-complexity-label">
                <span>Avg Complexity</span>
                <span>${score.toFixed(1)} (${complexityLabel})</span>
            </div>
            <div class="configs-dashboard-complexity-bar">
                <div class="configs-dashboard-complexity-segment low" style="width: ${lowPct}%"></div>
                <div class="configs-dashboard-complexity-segment medium" style="width: ${medPct}%"></div>
                <div class="configs-dashboard-complexity-segment high" style="width: ${highPct}%"></div>
            </div>
        </div>
    `;
}

/**
 * Get heat color class based on experiment count.
 */
function cfg_getHeatClass(count) {
    if (count === 0) return 'configs-dashboard-heat-0';
    if (count === 1) return 'configs-dashboard-heat-1';
    if (count <= 3) return 'configs-dashboard-heat-2';
    if (count <= 5) return 'configs-dashboard-heat-3';
    return 'configs-dashboard-heat-4';
}

/**
 * Format relative time ago.
 */
function cfg_formatTimeAgo(dateString) {
    if (!dateString) return 'Never';
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

    if (diffDays === 0) return 'Today';
    if (diffDays === 1) return 'Yesterday';
    if (diffDays < 7) return `${diffDays} days ago`;
    if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
    return `${Math.floor(diffDays / 30)} months ago`;
}

/**
 * Open experiments filtered by FeatureConfig and ModelConfig.
 */
function cfg_openExperimentFilter(fcId, mcId) {
    // Navigate to experiments page with filter
    window.location.href = `/models/${modelId}/experiments/?feature_config=${fcId}&model_config=${mcId}`;
}

/**
 * Open Quick Test wizard with pre-selected configs.
 */
function cfg_openQuickTest(fcId, mcId) {
    // Find the feature config to get required data
    const fc = cfg_state.data?.feature_configs?.items?.find(f => f.id === fcId);
    if (fc) {
        // Store pre-selection in session storage for the wizard
        sessionStorage.setItem('quickTestPreselect', JSON.stringify({
            feature_config_id: fcId,
            model_config_id: mcId
        }));
        // Navigate to experiments page and trigger quick test
        window.location.href = `/models/${modelId}/experiments/`;
    }
}

// =============================================================================
// INITIALIZATION
// =============================================================================

document.addEventListener('DOMContentLoaded', function() {
    cfg_loadDashboard();  // Load Configs Dashboard
    ds_loadDatasets();  // Load datasets chapter
    fc_loadDatasets();  // Load datasets for Feature Config dropdown
    loadConfigs();
    loadModelConfigs();
});

function fc_loadDatasets() {
    fetch(`/api/models/${modelId}/configs/datasets/`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                allDatasets = data.data;
                populateDatasetFilters();
            }
        })
        .catch(err => console.error('Error loading datasets:', err));
}

function loadConfigs() {
    document.getElementById('configsLoading').classList.remove('hidden');
    document.getElementById('configsEmpty').classList.add('hidden');

    const datasetId = document.getElementById('datasetFilter').value;

    let url = `/api/models/${modelId}/feature-configs/?`;
    if (datasetId) url += `dataset_id=${datasetId}&`;

    fetch(url)
        .then(r => r.json())
        .then(data => {
            document.getElementById('configsLoading').classList.add('hidden');
            if (data.success) {
                allConfigs = data.data;
                renderConfigs();
            } else {
                showError(data.error || 'Failed to load configs');
            }
        })
        .catch(err => {
            document.getElementById('configsLoading').classList.add('hidden');
            console.error('Error loading configs:', err);
            showError('Failed to load feature configs');
        });
}

function populateDatasetFilters() {
    const filterSelect = document.getElementById('datasetFilter');
    const wizardSelect = document.getElementById('configDataset');

    // Clear existing options (except first)
    filterSelect.innerHTML = '<option value="">All Datasets</option>';
    wizardSelect.innerHTML = '<option value="">Select a dataset...</option>';

    allDatasets.forEach(ds => {
        const opt1 = document.createElement('option');
        opt1.value = ds.id;
        opt1.textContent = ds.name;
        filterSelect.appendChild(opt1);

        const opt2 = document.createElement('option');
        opt2.value = ds.id;
        opt2.textContent = ds.name;
        wizardSelect.appendChild(opt2);
    });
}

// =============================================================================
// RENDER CONFIGS LIST
// =============================================================================

function renderConfigs() {
    const container = document.getElementById('configsList');
    const emptyState = document.getElementById('configsEmpty');
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();

    // Filter by search
    let filtered = allConfigs;
    if (searchTerm) {
        filtered = allConfigs.filter(c =>
            c.name.toLowerCase().includes(searchTerm) ||
            (c.description && c.description.toLowerCase().includes(searchTerm))
        );
    }

    // Remove old cards
    container.querySelectorAll('.config-card').forEach(el => el.remove());

    if (filtered.length === 0) {
        emptyState.classList.remove('hidden');
        return;
    }

    emptyState.classList.add('hidden');

    filtered.forEach(config => {
        const card = createConfigCard(config);
        container.appendChild(card);
    });
}

function createConfigCard(config) {
    const card = document.createElement('div');
    card.className = 'config-card bg-white border border-gray-200 rounded-lg p-4 hover:border-gray-300';

    // Calculate tensor breakdowns from feature arrays
    const buyerResult = calculateTensorBreakdown(
        config.buyer_model_features || [],
        config.buyer_model_crosses || []
    );
    const productResult = calculateTensorBreakdown(
        config.product_model_features || [],
        config.product_model_crosses || []
    );

    const buyerDim = buyerResult.total || config.buyer_tensor_dim || 0;
    const productDim = productResult.total || config.product_tensor_dim || 0;

    const leakageWarning = config.columns_in_both_models && config.columns_in_both_models.length > 0
        ? `<span class="leakage-warning"><i class="fas fa-exclamation-triangle"></i>${config.columns_in_both_models.length} shared</span>`
        : '';

    // Model type compatibility badge
    // - No target column (retrieval config)  can only be used for Retrieval models
    // - Has target column (ranking config)  can be used for ALL model types
    const hasTargetColumn = config.target_column !== null && config.target_column !== undefined;
    const modelTypeBadge = hasTargetColumn
        ? `<span class="model-type-badge model-type-all" title="Can be used with Retrieval, Ranking, or Hybrid models">
               <i class="fas fa-layer-group"></i> Retrieval / Ranking / Hybrid
           </span>`
        : `<span class="model-type-badge model-type-retrieval" title="Can only be used with Retrieval models (no target column)">
               <i class="fas fa-search"></i> Retrieval
           </span>`;

    const cardId = `config-${config.id}`;

    card.innerHTML = `
        <div class="flex items-start justify-between mb-2">
            <div class="flex items-center gap-2">
                <h3 class="font-semibold text-gray-900">${escapeHtml(config.name)}</h3>
                ${modelTypeBadge}
                ${leakageWarning}
            </div>
            <div class="flex items-center gap-2">
                <button onclick="viewConfig(${config.id})" class="card-action-btn view" title="View feature set">
                    View
                </button>
                <button onclick="editConfig(${config.id})" class="card-action-btn edit" title="Edit feature set">
                    <i class="fas fa-external-link-alt"></i>
                </button>
                <button onclick="deleteConfig(${config.id}, '${escapeHtml(config.name)}')" class="card-action-btn delete" title="Delete feature set">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        <div class="flex items-center gap-3 text-xs text-gray-500 mb-2">
            <span>Dataset: ${escapeHtml(config.dataset_name)}</span>
            <span>Set version: ${config.version}</span>
            <span>Updated ${formatTimeAgo(config.updated_at)}${config.created_by ? ` by ${config.created_by}` : ''}</span>
        </div>
        ${config.description ? `<p class="text-sm text-gray-600 mb-3">${escapeHtml(config.description.length > 80 ? config.description.substring(0, 80) + '...' : config.description)}</p>` : ''}

        <div class="grid grid-cols-2 gap-4 mb-3">
            <div>
                <div class="flex items-center justify-between text-xs mb-1">
                    <span class="text-gray-500">Buyer Tensor</span>
                    <span class="font-semibold text-blue-600">${buyerDim}D</span>
                </div>
                <div id="${cardId}-buyer-bar" class="tensor-breakdown-bar"></div>
                <div class="text-xs text-gray-400 mt-1">${config.buyer_features_count || 0} features, ${config.buyer_crosses_count || 0} crosses</div>
            </div>
            <div>
                <div class="flex items-center justify-between text-xs mb-1">
                    <span class="text-gray-500">Product Tensor</span>
                    <span class="font-semibold text-green-600">${productDim}D</span>
                </div>
                <div id="${cardId}-product-bar" class="tensor-breakdown-bar"></div>
                <div class="text-xs text-gray-400 mt-1">${config.product_features_count || 0} features, ${config.product_crosses_count || 0} crosses</div>
            </div>
        </div>

        <div class="flex items-center gap-2 mt-3 pt-3 border-t border-gray-100">
            <button onclick="cloneConfig(${config.id})" class="btn btn-secondary btn-sm" style="width: 150px;">
                <i class="fas fa-copy"></i>Clone
            </button>
            <button onclick="viewTransformCode(${config.id}, '${escapeHtml(config.name)}')" class="btn btn-secondary btn-sm" style="width: 150px;" title="View generated TFX code">
                <i class="fas fa-code"></i>Code
            </button>
        </div>
    `;

    // Render tensor visualizations after card is in DOM (bars only, no breakdown tags)
    // Use maxTotal for proportional bar widths
    const maxTotal = Math.max(buyerResult.total || 0, productResult.total || 0);

    setTimeout(() => {
        const buyerBar = document.getElementById(`${cardId}-buyer-bar`);
        const productBar = document.getElementById(`${cardId}-product-bar`);

        if (buyerBar && buyerResult.breakdown.length > 0) {
            renderTensorPreview('buyer', buyerResult.total, buyerResult.breakdown, buyerBar, null, maxTotal);
        }
        if (productBar && productResult.breakdown.length > 0) {
            renderTensorPreview('product', productResult.total, productResult.breakdown, productBar, null, maxTotal);
        }
    }, 0);

    return card;
}

// =============================================================================
// WIZARD FUNCTIONS
// =============================================================================

function fc_openWizard(configId = null) {
    editingConfigId = configId;
    currentStep = 1;

    // Reset state
    configState = {
        name: '',
        description: '',
        datasetId: null,
        startFrom: 'blank',
        cloneFromId: null,
        customerIdFeature: null,
        productIdFeature: null,
        buyerFeatures: [],
        productFeatures: [],
        buyerCrosses: [],
        productCrosses: [],
        availableColumns: [],
        sampleRows: [],
        columnOrder: [],
        targetColumn: null  // For ranking models
    };

    // Reset form
    document.getElementById('configName').value = '';
    document.getElementById('configDescription').value = '';
    document.getElementById('configDataset').value = '';
    document.getElementById('datasetInfo').classList.add('hidden');
    selectStartFrom('blank');  // Reset to blank and hide clone selection

    // Reset name validation state
    configNameIsValid = false;
    resetConfigNameValidation();

    // Update UI
    document.getElementById('wizardTitle').textContent = configId ? 'Edit Feature Config' : 'Create Feature Config';
    updateWizardStep();

    // Show modal
    document.getElementById('featureConfigWizardModal').classList.remove('hidden');

    // If editing, load config data
    if (configId) {
        loadConfigForEdit(configId);
    }
}

function fc_fc_closeWizard() {
    document.getElementById('featureConfigWizardModal').classList.add('hidden');
    editingConfigId = null;
}

function loadConfigForEdit(configId) {
    isLoadingConfigForEdit = true;
    updateEditLoadingState();

    fetch(`/api/feature-configs/${configId}/`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const config = data.data;
                document.getElementById('configName').value = config.name;
                document.getElementById('configDescription').value = config.description || '';
                document.getElementById('configDataset').value = config.dataset_id;

                configState.name = config.name;
                configState.description = config.description || '';
                configState.datasetId = config.dataset_id;

                // Extract primary ID features from the features arrays
                // Assume first feature with is_primary_id flag is the primary ID
                const buyerFeatures = config.buyer_model_features || [];
                const productFeatures = config.product_model_features || [];

                // Find and extract primary ID features
                const buyerPrimaryIdx = buyerFeatures.findIndex(f => f.is_primary_id);
                if (buyerPrimaryIdx !== -1) {
                    configState.customerIdFeature = buyerFeatures[buyerPrimaryIdx];
                    configState.buyerFeatures = buyerFeatures.filter((_, idx) => idx !== buyerPrimaryIdx);
                } else {
                    configState.buyerFeatures = buyerFeatures;
                }

                const productPrimaryIdx = productFeatures.findIndex(f => f.is_primary_id);
                if (productPrimaryIdx !== -1) {
                    configState.productIdFeature = productFeatures[productPrimaryIdx];
                    configState.productFeatures = productFeatures.filter((_, idx) => idx !== productPrimaryIdx);
                } else {
                    configState.productFeatures = productFeatures;
                }

                configState.buyerCrosses = config.buyer_model_crosses || [];
                configState.productCrosses = config.product_model_crosses || [];

                // Load target column for ranking configs
                configState.targetColumn = config.target_column || null;

                // Mark name as valid since we're editing an existing config
                configNameIsValid = true;

                onDatasetChange();
            }
        })
        .finally(() => {
            isLoadingConfigForEdit = false;
            updateEditLoadingState();
        });
}

function showWizardLoading(show, text = 'Loading...') {
    const loadingOverlay = document.getElementById('wizardLoadingOverlay');
    const loadingText = document.getElementById('wizardLoadingText');
    const nextBtn = document.getElementById('nextBtn');
    const saveBtn = document.getElementById('saveBtn');

    if (loadingOverlay) {
        loadingOverlay.style.display = show ? 'block' : 'none';
    }
    if (loadingText) {
        loadingText.textContent = text;
    }
    if (nextBtn) {
        nextBtn.disabled = show;
        nextBtn.style.opacity = show ? '0.5' : '1';
    }
    if (saveBtn) {
        saveBtn.disabled = show;
        saveBtn.style.opacity = show ? '0.5' : '1';
    }
}

function updateEditLoadingState() {
    showWizardLoading(isLoadingConfigForEdit, 'Loading config data...');
}

function updateWizardStep() {
    // Update step visibility
    document.getElementById('wizardStep1').classList.toggle('hidden', currentStep !== 1);
    document.getElementById('wizardStep1').classList.toggle('active', currentStep === 1);
    document.getElementById('wizardStep2').classList.toggle('hidden', currentStep !== 2);
    document.getElementById('wizardStep2').classList.toggle('active', currentStep === 2);

    // Update progress pills - use completed/current/future classes
    for (let i = 1; i <= 2; i++) {
        const pill = document.getElementById(`progress${i}`);
        pill.classList.remove('current', 'completed', 'future');
        if (i < currentStep) {
            pill.classList.add('completed');
        } else if (i === currentStep) {
            pill.classList.add('current');
        } else {
            pill.classList.add('future');
        }
    }

    // Update buttons
    document.getElementById('backBtn').classList.toggle('hidden', currentStep === 1);
    document.getElementById('nextBtn').classList.toggle('hidden', currentStep === 2);
    document.getElementById('saveBtn').classList.toggle('hidden', currentStep !== 2);

    // Update step counter
    document.getElementById('currentStep').textContent = currentStep;
}

function fc_fc_nextStep() {
    // Block navigation while loading config data
    if (isLoadingConfigForEdit) {
        return;
    }

    if (currentStep === 1) {
        // Validate step 1
        const name = document.getElementById('configName').value.trim();
        const datasetId = document.getElementById('configDataset').value;

        if (!name) {
            document.getElementById('nameError').textContent = 'Name is required';
            document.getElementById('nameError').classList.remove('hidden');
            document.getElementById('configName').classList.add('border-red-500');
            return;
        }
        if (!datasetId) {
            showError('Please select a dataset');
            return;
        }
        // Check if name validation has been performed and is valid
        if (!configNameIsValid) {
            // Trigger validation if not done yet
            checkConfigNameAvailability();
            // Show error message
            document.getElementById('nameError').textContent = 'Please wait for name validation or choose a different name';
            document.getElementById('nameError').classList.remove('hidden');
            return;
        }

        configState.name = name;
        configState.description = document.getElementById('configDescription').value.trim();
        configState.datasetId = parseInt(datasetId);
        configState.startFrom = document.getElementById('startFromValue').value;

        // Load columns and initialize step 2
        loadColumnsForStep2();

        currentStep = 2;
        updateWizardStep();
    }
}

function fc_fc_prevStep() {
    if (currentStep > 1) {
        currentStep--;
        updateWizardStep();
    }
}

function validateConfigName() {
    document.getElementById('nameError').classList.add('hidden');
}

// Reset Feature Config name validation UI
function resetConfigNameValidation() {
    document.getElementById('configNameStatus').classList.add('hidden');
    document.getElementById('configNameSpinner').classList.add('hidden');
    document.getElementById('configNameValid').classList.add('hidden');
    document.getElementById('configNameInvalid').classList.add('hidden');
    document.getElementById('nameError').classList.add('hidden');
    document.getElementById('nameError').textContent = '';
    document.getElementById('configName').classList.remove('border-red-500', 'border-green-500');
}

// Debounced Feature Config name check
function debounceConfigNameCheck() {
    clearTimeout(configNameCheckTimeout);
    // Reset validation state while typing
    configNameIsValid = false;
    configNameCheckTimeout = setTimeout(() => {
        checkConfigNameAvailability();
    }, 400);
}

// Check Feature Config name availability
function checkConfigNameAvailability() {
    const name = document.getElementById('configName').value.trim();
    const datasetId = document.getElementById('configDataset').value;
    const statusEl = document.getElementById('configNameStatus');
    const spinnerEl = document.getElementById('configNameSpinner');
    const validEl = document.getElementById('configNameValid');
    const invalidEl = document.getElementById('configNameInvalid');
    const errorEl = document.getElementById('nameError');
    const inputEl = document.getElementById('configName');

    // Reset state
    statusEl.classList.add('hidden');
    spinnerEl.classList.add('hidden');
    validEl.classList.add('hidden');
    invalidEl.classList.add('hidden');
    errorEl.classList.add('hidden');
    inputEl.classList.remove('border-red-500', 'border-green-500');

    if (!name) {
        configNameIsValid = false;
        return;
    }

    if (!datasetId) {
        // Can't validate without dataset - mark as pending
        configNameIsValid = false;
        return;
    }

    // Show spinner
    statusEl.classList.remove('hidden');
    spinnerEl.classList.remove('hidden');

    // Build URL with query params
    let url = `/api/feature-configs/check-name/?name=${encodeURIComponent(name)}&dataset_id=${datasetId}`;
    if (editingConfigId) {
        url += `&exclude_id=${editingConfigId}`;
    }

    fetch(url)
        .then(r => r.json())
        .then(data => {
            spinnerEl.classList.add('hidden');

            if (data.success && data.data.available) {
                // Name is available
                configNameIsValid = true;
                validEl.classList.remove('hidden');
                inputEl.classList.add('border-green-500');
            } else {
                // Name is taken
                configNameIsValid = false;
                invalidEl.classList.remove('hidden');
                inputEl.classList.add('border-red-500');
                errorEl.textContent = data.data?.message || 'This name is already taken for this dataset';
                errorEl.classList.remove('hidden');
            }
        })
        .catch(err => {
            console.error('Error checking name:', err);
            spinnerEl.classList.add('hidden');
            configNameIsValid = false;
        });
}

function onDatasetChange() {
    const datasetId = document.getElementById('configDataset').value;
    const datasetInfo = document.getElementById('datasetInfo');

    if (datasetId) {
        const dataset = allDatasets.find(d => d.id == datasetId);
        if (dataset) {
            const rowsText = dataset.total_rows != null
                ? dataset.total_rows.toLocaleString() + ' rows'
                : 'Unknown rows';
            const colsText = dataset.column_count != null
                ? dataset.column_count + ' columns'
                : '? columns';
            document.getElementById('datasetInfoText').textContent = `${rowsText} | ${colsText}`;
            datasetInfo.classList.remove('hidden');
        }
        loadCloneOptions(datasetId);
        // Re-check name availability when dataset changes (name uniqueness is per dataset)
        const name = document.getElementById('configName').value.trim();
        if (name) {
            configNameIsValid = false;
            checkConfigNameAvailability();
        }
    } else {
        datasetInfo.classList.add('hidden');
        // Reset name validation when no dataset selected
        configNameIsValid = false;
        resetConfigNameValidation();
    }
}

function selectStartFrom(value) {
    // Update hidden input value
    document.getElementById('startFromValue').value = value;

    // Toggle active class on buttons
    document.getElementById('startFromBlank').classList.toggle('active', value === 'blank');
    document.getElementById('startFromClone').classList.toggle('active', value === 'clone');

    // Show/hide clone selection dropdown
    document.getElementById('cloneSelection').classList.toggle('hidden', value !== 'clone');
}

// Legacy function for backwards compatibility
function onStartFromChange() {
    const startFrom = document.getElementById('startFromValue').value;
    document.getElementById('cloneSelection').classList.toggle('hidden', startFrom !== 'clone');
}

function loadCloneOptions(datasetId) {
    const select = document.getElementById('cloneFromConfig');
    select.innerHTML = '<option value="">Select a config to clone...</option>';

    allConfigs.filter(c => c.dataset_id == datasetId).forEach(config => {
        const opt = document.createElement('option');
        opt.value = config.id;
        opt.textContent = `${config.name} (${config.buyer_tensor_dim || 0}D + ${config.product_tensor_dim || 0}D)`;
        select.appendChild(opt);
    });
}

// =============================================================================
// STEP 2: FEATURE ASSIGNMENT
// =============================================================================

function showStep2Loading(show) {
    showWizardLoading(show, 'Loading feature data...');
}

function loadColumnsForStep2() {
    const datasetId = configState.datasetId;
    const startFrom = configState.startFrom;

    // Show loading spinner
    showStep2Loading(true);

    // Use new schema-with-sample endpoint for accurate types and sample data
    fetch(`/api/datasets/${datasetId}/schema-with-sample/`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                configState.availableColumns = data.data.columns;
                configState.sampleRows = data.data.sample_rows || [];
                configState.columnOrder = data.data.column_order || [];

                // Handle start from options
                if (startFrom === 'clone') {
                    const cloneFromId = document.getElementById('cloneFromConfig').value;
                    if (cloneFromId) {
                        loadCloneData(cloneFromId);
                    } else {
                        renderStep2();
                        showStep2Loading(false);
                    }
                } else {
                    renderStep2();
                    showStep2Loading(false);
                }
            } else {
                console.error('Failed to load schema:', data.error);
                showError('Failed to load column schema');
                showStep2Loading(false);
            }
        })
        .catch(err => {
            console.error('Error loading schema:', err);
            showError('Error loading column schema');
            showStep2Loading(false);
        });
}

function loadCloneData(configId) {
    fetch(`/api/feature-configs/${configId}/`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const buyerFeatures = data.data.buyer_model_features || [];
                const productFeatures = data.data.product_model_features || [];

                // Find and extract primary ID features
                const buyerPrimaryIdx = buyerFeatures.findIndex(f => f.is_primary_id);
                if (buyerPrimaryIdx !== -1) {
                    configState.customerIdFeature = buyerFeatures[buyerPrimaryIdx];
                    configState.buyerFeatures = buyerFeatures.filter((_, idx) => idx !== buyerPrimaryIdx);
                } else {
                    configState.buyerFeatures = buyerFeatures;
                }

                const productPrimaryIdx = productFeatures.findIndex(f => f.is_primary_id);
                if (productPrimaryIdx !== -1) {
                    configState.productIdFeature = productFeatures[productPrimaryIdx];
                    configState.productFeatures = productFeatures.filter((_, idx) => idx !== productPrimaryIdx);
                } else {
                    configState.productFeatures = productFeatures;
                }

                configState.buyerCrosses = data.data.buyer_model_crosses || [];
                configState.productCrosses = data.data.product_model_crosses || [];
                renderStep2();
                showStep2Loading(false);
            } else {
                showStep2Loading(false);
            }
        })
        .catch(err => {
            console.error('Error loading clone data:', err);
            showStep2Loading(false);
        });
}

function renderStep2() {
    renderAvailableColumns();
    renderSampleTable();
    renderPrimaryIdZone('buyer');
    renderPrimaryIdZone('product');
    renderAssignedFeatures('buyer');
    renderAssignedFeatures('product');
    renderTargetColumn();  // For ranking models
    updateAdditionalFeaturesLockState();
    updateTensorPreview();
    updateSubchapterStatuses();
}

// Render the primary ID zone (Customer ID or Product ID)
function renderPrimaryIdZone(model) {
    const idFeature = model === 'buyer' ? configState.customerIdFeature : configState.productIdFeature;
    const contentContainer = document.getElementById(model === 'buyer' ? 'customerIdContent' : 'productIdContent');
    const idLabel = model === 'buyer' ? 'Customer ID' : 'Product ID';

    if (!idFeature) {
        // Empty state - show drop prompt
        contentContainer.innerHTML = `
            <div class="primary-id-zone-empty">
                <i class="fas fa-arrow-down"></i>
                <span>Drag a column here to set as ${idLabel}</span>
            </div>
        `;
    } else {
        // Assigned state - show the feature card
        const embedDim = idFeature.transforms?.embedding?.embedding_dim || 32;
        // Use display_name (alias) if available
        const displayName = idFeature.display_name || idFeature.column;

        // Get cardinality info for display
        const cardinality = idFeature.stats?.cardinality || idFeature.stats?.unique_count;
        const recommendedDim = cardinality ? getRecommendedEmbedDim(cardinality) : null;
        const cardinalityText = cardinality ? formatCardinality(cardinality) : null;

        // Build cardinality info line
        let cardinalityInfo = '';
        if (cardinalityText) {
            const dimStatus = embedDim === recommendedDim
                ? `<span class="text-green-600"> ${recommendedDim}D recommended</span>`
                : `<span class="text-amber-600">${recommendedDim}D recommended</span>`;
            cardinalityInfo = `
                <div class="text-xs mt-1" style="color: #6b7280;">
                    <i class="fas fa-chart-bar mr-1"></i>${cardinalityText} unique  ${dimStatus}
                </div>
            `;
        }

        contentContainer.innerHTML = `
            <div class="primary-id-assigned">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <div class="font-medium text-sm">${escapeHtml(displayName)}</div>
                        <div class="text-xs text-gray-500">
                            ${idFeature.bq_type || 'STRING'}  Text  Embed: ${embedDim}D
                        </div>
                        ${cardinalityInfo}
                    </div>
                    <div class="flex flex-col gap-1 ml-2">
                        <button type="button" class="feature-config-btn settings" onclick="openPrimaryIdConfig('${model}')" title="Configure embedding">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button type="button" class="feature-config-btn remove" onclick="removePrimaryId('${model}')" title="Remove">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
}

// Update lock state of additional features sections
function updateAdditionalFeaturesLockState() {
    const buyerSection = document.getElementById('buyerAdditionalSection');
    const productSection = document.getElementById('productAdditionalSection');
    const buyerLockedMsg = document.getElementById('buyerLockedMessage');
    const productLockedMsg = document.getElementById('productLockedMessage');

    // Buyer model: unlocked if customerIdFeature is set
    if (configState.customerIdFeature) {
        buyerSection.classList.remove('locked');
        buyerLockedMsg.style.display = 'none';
    } else {
        buyerSection.classList.add('locked');
        buyerLockedMsg.style.display = 'flex';
    }

    // Product model: unlocked if productIdFeature is set
    if (configState.productIdFeature) {
        productSection.classList.remove('locked');
        productLockedMsg.style.display = 'none';
    } else {
        productSection.classList.add('locked');
        productLockedMsg.style.display = 'flex';
    }
}

function toggleModelingSubchapter(name) {
    const content = document.getElementById(`${name}Content`);
    const chevron = document.getElementById(`${name}Chevron`);

    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        chevron.classList.remove('fa-chevron-right');
        chevron.classList.add('fa-chevron-down');
    } else {
        content.classList.add('hidden');
        chevron.classList.remove('fa-chevron-down');
        chevron.classList.add('fa-chevron-right');
    }
}

function updateSubchapterStatuses() {
    // Update Dataset Sample status
    const sampleStatus = document.getElementById('datasetSampleStatus');
    const sampleRows = configState.sampleRows || [];
    if (sampleStatus) {
        sampleStatus.textContent = sampleRows.length > 0 ? `${sampleRows.length} rows` : '';
    }

    // Update Available Columns status
    const columnsStatus = document.getElementById('availableColumnsStatus');
    const totalCols = configState.availableColumns.length;
    const buyerCount = configState.buyerFeatures.length;
    const productCount = configState.productFeatures.length;

    if (columnsStatus) {
        if (buyerCount > 0 || productCount > 0) {
            columnsStatus.textContent = `${buyerCount} buyer, ${productCount} product`;
        } else {
            columnsStatus.textContent = totalCols > 0 ? `${totalCols} columns` : '';
        }
    }
}

function renderAvailableColumns() {
    const container = document.getElementById('availableColumns');
    container.innerHTML = '';

    // Get assigned column names by model (including primary IDs)
    // Include both column (raw name) and display_name (alias) to handle renamed columns
    const buyerCols = new Set();
    configState.buyerFeatures.forEach(f => {
        buyerCols.add(f.column);
        if (f.display_name) buyerCols.add(f.display_name);
    });
    const productCols = new Set();
    configState.productFeatures.forEach(f => {
        productCols.add(f.column);
        if (f.display_name) productCols.add(f.display_name);
    });

    // Add primary ID columns to the sets (both column and display_name)
    if (configState.customerIdFeature) {
        buyerCols.add(configState.customerIdFeature.column);
        if (configState.customerIdFeature.display_name) {
            buyerCols.add(configState.customerIdFeature.display_name);
        }
    }
    if (configState.productIdFeature) {
        productCols.add(configState.productIdFeature.column);
        if (configState.productIdFeature.display_name) {
            productCols.add(configState.productIdFeature.display_name);
        }
    }

    configState.availableColumns.forEach(col => {
        // Check both name and display_name to handle renamed columns
        const inBuyer = buyerCols.has(col.name) || buyerCols.has(col.display_name);
        const inProduct = productCols.has(col.name) || productCols.has(col.display_name);

        const card = document.createElement('div');
        card.className = 'column-card';

        // Add assignment state classes
        if (inBuyer && inProduct) {
            card.classList.add('assigned-both');
        } else if (inBuyer) {
            card.classList.add('assigned-buyer');
        } else if (inProduct) {
            card.classList.add('assigned-product');
        }

        // Only allow dragging if not assigned to both models
        const canDrag = !(inBuyer && inProduct);
        card.draggable = canDrag;
        card.dataset.column = JSON.stringify(col);
        if (canDrag) {
            card.ondragstart = (e) => dragStart(e, col);
            card.ondragend = dragEnd;
        }

        // Simple layout: drag handle | name | BQ type badge
        // Use display_name (alias) if available, fallback to raw name
        const displayName = col.display_name || col.name;
        card.innerHTML = `
            <i class="fas fa-grip-vertical drag-handle"></i>
            <span class="column-name" title="${escapeHtml(displayName)}">${escapeHtml(displayName)}</span>
            <span class="column-bq-type">${formatBqType(col.bq_type || 'STRING')}</span>
        `;

        container.appendChild(card);
    });
}

function formatBqType(bqType) {
    // Format BigQuery types to shorter display names
    const typeMap = {
        'STRING': 'STR',
        'INTEGER': 'INT',
        'INT64': 'INT',
        'FLOAT': 'FLOAT',
        'FLOAT64': 'FLOAT',
        'NUMERIC': 'NUM',
        'BIGNUMERIC': 'NUM',
        'BOOLEAN': 'BOOL',
        'BOOL': 'BOOL',
        'TIMESTAMP': 'TIME',
        'DATETIME': 'TIME',
        'DATE': 'DATE',
        'TIME': 'TIME',
        'BYTES': 'BYTES',
    };
    return typeMap[bqType?.toUpperCase()] || bqType || 'STR';
}

// Data Type System
// Three main data types: numeric, text, temporal
const DATA_TYPES = {
    numeric: { label: 'Numeric', icon: 'hashtag' },
    text: { label: 'Text', icon: 'font' },
    temporal: { label: 'Temporal', icon: 'calendar' }
};

function getDataTypeLabel(dataType) {
    return DATA_TYPES[dataType]?.label || dataType;
}

function getDataTypeFromBqType(bqType) {
    // Map BigQuery type to our data type system
    const type = (bqType || 'STRING').toUpperCase();

    if (['INTEGER', 'INT64', 'FLOAT', 'FLOAT64', 'NUMERIC', 'BIGNUMERIC'].includes(type)) {
        return 'numeric';
    } else if (['TIMESTAMP', 'DATETIME', 'DATE', 'TIME'].includes(type)) {
        return 'temporal';
    } else {
        // STRING, BYTES, etc.
        return 'text';
    }
}

function getTransformOptionsForDataType(dataType) {
    // Return available transforms based on data type
    switch (dataType) {
        case 'numeric':
            return [
                { key: 'normalize', label: 'Normalize', desc: 'Scale to [-1, 1] range', outputDim: 1 },
                { key: 'bucketize', label: 'Bucketize', desc: 'Discretize into buckets + embed', outputDim: 'configurable' }
            ];
        case 'text':
            return [
                { key: 'embedding', label: 'Embedding', desc: 'Learn vector representation', outputDim: 'configurable' }
            ];
        case 'temporal':
            return [
                { key: 'normalize', label: 'Normalize', desc: 'Scale timestamp to [-1, 1]', outputDim: 1 },
                { key: 'cyclical', label: 'Cyclical', desc: 'Extract periodic patterns (month, week, etc.)', outputDim: 'varies' },
                { key: 'bucketize', label: 'Bucketize', desc: 'Discretize into time buckets + embed', outputDim: 'configurable' }
            ];
        default:
            return [];
    }
}

function updateFeatureDataType(model, idx, newDataType) {
    const features = model === 'buyer' ? configState.buyerFeatures : configState.productFeatures;
    if (features[idx]) {
        features[idx].data_type = newDataType;
        // Clear transforms when data type changes - user must reconfigure
        features[idx].transforms = {};
    }
    renderStep2();
}

function getFeatureDisplayInfo(feature) {
    // Returns display string showing data type and transform output
    const dataType = feature.data_type || getDataTypeFromBqType(feature.bq_type);
    const dataTypeLabel = getDataTypeLabel(dataType);
    const transforms = feature.transforms || {};

    // Calculate total output dimension
    let outputParts = [];
    let totalDim = 0;

    if (dataType === 'numeric') {
        if (transforms.normalize?.enabled) {
            outputParts.push('Norm: 1D');
            totalDim += 1;
        }
        if (transforms.bucketize?.enabled) {
            const dim = transforms.bucketize.embedding_dim || 32;
            outputParts.push(`Bucket: ${dim}D`);
            totalDim += dim;
        }
    } else if (dataType === 'text') {
        if (transforms.embedding?.enabled) {
            const dim = transforms.embedding.embedding_dim || 32;
            outputParts.push(`Embed: ${dim}D`);
            totalDim += dim;
        }
    } else if (dataType === 'temporal') {
        if (transforms.normalize?.enabled) {
            outputParts.push('Norm: 1D');
            totalDim += 1;
        }
        if (transforms.cyclical?.enabled) {
            const cyclical = transforms.cyclical;
            let cyclicalDim = 0;
            if (cyclical.yearly || cyclical.annual) cyclicalDim += 2;
            if (cyclical.quarterly) cyclicalDim += 2;
            if (cyclical.monthly) cyclicalDim += 2;
            if (cyclical.weekly) cyclicalDim += 2;
            if (cyclical.daily) cyclicalDim += 2;
            if (cyclicalDim > 0) {
                outputParts.push(`Cyclical: ${cyclicalDim}D`);
                totalDim += cyclicalDim;
            }
        }
        if (transforms.bucketize?.enabled) {
            const dim = transforms.bucketize.embedding_dim || 32;
            outputParts.push(`Bucket: ${dim}D`);
            totalDim += dim;
        }
    }

    const transformStr = outputParts.length > 0
        ? outputParts.join(' + ')
        : 'No transform selected';

    return {
        dataTypeLabel,
        transformStr,
        totalDim,
        hasTransforms: outputParts.length > 0
    };
}

function renderSampleTable() {
    const container = document.getElementById('sampleDataTable');
    const rows = configState.sampleRows || [];
    const columns = configState.columnOrder || [];

    if (rows.length === 0 || columns.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-sm p-4">No sample data available</p>';
        return;
    }

    // Get assignment status for each column (including primary IDs)
    // Include both column (raw name) and display_name (alias) to handle renamed columns
    const buyerCols = new Set();
    configState.buyerFeatures.forEach(f => {
        buyerCols.add(f.column);
        if (f.display_name) buyerCols.add(f.display_name);
    });
    const productCols = new Set();
    configState.productFeatures.forEach(f => {
        productCols.add(f.column);
        if (f.display_name) productCols.add(f.display_name);
    });

    // Add primary ID columns (both column and display_name)
    if (configState.customerIdFeature) {
        buyerCols.add(configState.customerIdFeature.column);
        if (configState.customerIdFeature.display_name) {
            buyerCols.add(configState.customerIdFeature.display_name);
        }
    }
    if (configState.productIdFeature) {
        productCols.add(configState.productIdFeature.column);
        if (configState.productIdFeature.display_name) {
            productCols.add(configState.productIdFeature.display_name);
        }
    }

    let html = `
        <div class="sample-table-wrapper">
            <table class="sample-table">
                <thead>
                    <tr>
                        ${columns.map(col => {
                            let headerClass = '';
                            const inBuyer = buyerCols.has(col);
                            const inProduct = productCols.has(col);

                            if (inBuyer && inProduct) {
                                headerClass = 'col-both';
                            } else if (inBuyer) {
                                headerClass = 'col-buyer';
                            } else if (inProduct) {
                                headerClass = 'col-product';
                            }

                            return `<th class="${headerClass}">${escapeHtml(col)}</th>`;
                        }).join('')}
                    </tr>
                </thead>
                <tbody>
                    ${rows.slice(0, 10).map(row => `
                        <tr>
                            ${columns.map(col => {
                                let cellClass = '';
                                const inBuyer = buyerCols.has(col);
                                const inProduct = productCols.has(col);

                                if (inBuyer && inProduct) {
                                    cellClass = 'col-both';
                                } else if (inBuyer) {
                                    cellClass = 'col-buyer';
                                } else if (inProduct) {
                                    cellClass = 'col-product';
                                }

                                const val = row[col];
                                const displayVal = val === null || val === undefined
                                    ? '<span class="null-value">NULL</span>'
                                    : escapeHtml(String(val));
                                return `<td class="${cellClass}">${displayVal}</td>`;
                            }).join('')}
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;

    container.innerHTML = html;
}

function renderAssignedFeatures(model) {
    const features = model === 'buyer' ? configState.buyerFeatures : configState.productFeatures;
    const crosses = model === 'buyer' ? configState.buyerCrosses : configState.productCrosses;
    const container = document.getElementById(`${model}ModelFeatures`);
    const crossContainer = document.getElementById(`${model}ModelCrosses`);
    const addCrossBtn = document.getElementById(`add${model.charAt(0).toUpperCase() + model.slice(1)}CrossBtn`);

    container.innerHTML = '';
    crossContainer.innerHTML = '';

    // Show/hide cross feature button based on whether there are features
    // (including primary ID feature)
    const hasPrimaryId = model === 'buyer' ? configState.customerIdFeature : configState.productIdFeature;
    const hasFeatures = features.length > 0 || hasPrimaryId;

    if (hasFeatures) {
        addCrossBtn.style.display = 'inline-flex';

        features.forEach((feature, idx) => {
            const el = createAssignedFeatureElement(feature, model, idx);
            container.appendChild(el);
        });
    } else {
        addCrossBtn.style.display = 'none';
    }

    crosses.forEach((cross, idx) => {
        const el = createCrossFeatureElement(cross, model, idx);
        crossContainer.appendChild(el);
    });
}

function createAssignedFeatureElement(feature, model, idx) {
    const div = document.createElement('div');

    // Get display info
    const displayInfo = getFeatureDisplayInfo(feature);
    const bqType = feature.bq_type || 'STRING';

    // Apply warning class to the outer div if no transforms selected
    div.className = displayInfo.hasTransforms ? 'assigned-feature' : 'assigned-feature feature-needs-config';

    // Use display_name (alias) if available
    const displayName = feature.display_name || feature.column;

    // Build cardinality info line for text features with embedding
    let cardinalityInfo = '';
    if (feature.data_type === 'text' && feature.transforms?.embedding?.enabled) {
        const cardinality = feature.stats?.cardinality || feature.stats?.unique_count;
        if (cardinality) {
            const cardinalityText = formatCardinality(cardinality);
            const recommendedDim = getRecommendedEmbedDim(cardinality);
            const currentDim = feature.transforms.embedding.embedding_dim;
            const dimStatus = currentDim === recommendedDim
                ? `<span class="text-green-600"> ${recommendedDim}D recommended</span>`
                : `<span class="text-amber-600">${recommendedDim}D recommended</span>`;
            cardinalityInfo = `
                <div class="text-xs mt-1" style="color: #6b7280;">
                    <i class="fas fa-chart-bar mr-1"></i>${cardinalityText} unique  ${dimStatus}
                </div>
            `;
        }
    }

    div.innerHTML = `
        <div class="flex items-center justify-between">
            <div class="flex-1">
                <div class="font-medium text-sm">${escapeHtml(displayName)}</div>
                <div class="text-xs ${displayInfo.hasTransforms ? 'text-gray-500' : 'text-amber-600'}">
                    ${bqType}  ${displayInfo.dataTypeLabel}  ${displayInfo.transformStr}
                </div>
                ${cardinalityInfo}
            </div>
            <div class="flex flex-col gap-1 ml-2">
                <button type="button" class="feature-config-btn settings ${displayInfo.hasTransforms ? '' : 'needs-attention'}" onclick="openFeatureConfig('${model}', ${idx})" title="Configure transforms">
                    <i class="fas fa-cog"></i>
                </button>
                <button type="button" class="feature-config-btn remove" onclick="removeFeature('${model}', ${idx})" title="Remove">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
        </div>
    `;

    return div;
}

function getCrossFeatureNames(cross) {
    // Handle both old format (array of strings) and new format (array of objects)
    // Use display_name (alias) if available
    if (!cross.features || cross.features.length === 0) return [];
    if (typeof cross.features[0] === 'string') {
        return cross.features;
    }
    return cross.features.map(f => f.display_name || f.column);
}

function getCrossFeatureDetails(cross) {
    // Build detailed description including bucket info for numeric/temporal
    // Use display_name (alias) if available
    if (!cross.features || cross.features.length === 0) return '';
    if (typeof cross.features[0] === 'string') {
        return ''; // Old format, no bucket details
    }

    const details = cross.features
        .filter(f => f.crossing_buckets)
        .map(f => `${f.display_name || f.column}: ${f.crossing_buckets} buckets`);

    return details.length > 0 ? details.join(', ') : '';
}

function createCrossFeatureElement(cross, model, idx) {
    const div = document.createElement('div');
    div.className = 'cross-feature';

    const featureNames = getCrossFeatureNames(cross);
    const bucketDetails = getCrossFeatureDetails(cross);

    div.innerHTML = `
        <div class="flex items-center justify-between">
            <div>
                <div class="font-medium text-sm">${featureNames.join('  ')}</div>
                <div class="text-xs text-gray-500">
                    Hash: ${cross.hash_bucket_size.toLocaleString()}  ${cross.embedding_dim}D
                    ${bucketDetails ? `<br><span class="text-blue-600">${bucketDetails}</span>` : ''}
                </div>
            </div>
            <button type="button" class="feature-config-btn remove" onclick="removeCross('${model}', ${idx})">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;

    return div;
}

function getFeatureDimString(feature) {
    const parts = [];
    if (feature.type === 'string_embedding') {
        parts.push(`Embedding: ${feature.embedding_dim || 32}D`);
    } else if (feature.type === 'numeric') {
        const t = feature.transforms || {};
        if (t.normalize?.enabled) parts.push('Norm: 1D');
        if (t.bucketize?.enabled) parts.push(`Bucket: ${t.bucketize.embedding_dim || 32}D`);
    } else if (feature.type === 'timestamp') {
        const t = feature.transforms || {};
        if (t.normalize?.enabled) parts.push('Norm: 1D');
        const cyclical = t.cyclical || {};
        const cycles = ['yearly', 'annual', 'quarterly', 'monthly', 'weekly', 'daily'].filter(c => cyclical[c]).length;
        if (cycles > 0) parts.push(`Cyclical: ${cycles * 2}D`);
    }
    return parts.join(' + ') || 'Not configured';
}

// =============================================================================
// DRAG AND DROP
// =============================================================================

function dragStart(e, col) {
    e.target.classList.add('dragging');
    e.dataTransfer.setData('text/plain', JSON.stringify(col));
    e.dataTransfer.effectAllowed = 'move';
}

function dragEnd(e) {
    e.target.classList.remove('dragging');
}

function allowDrop(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
}

function dragEnter(e) {
    e.preventDefault();
    e.currentTarget.classList.add('drag-over');
}

function dragLeave(e) {
    e.currentTarget.classList.remove('drag-over');
}

function dropFeature(e, model) {
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');

    // Check if the model is unlocked (primary ID must be set first)
    const isUnlocked = model === 'buyer' ? configState.customerIdFeature : configState.productIdFeature;
    if (!isUnlocked) {
        return; // Can't drop if locked
    }

    const colData = JSON.parse(e.dataTransfer.getData('text/plain'));
    const feature = createDefaultFeature(colData);

    if (model === 'buyer') {
        configState.buyerFeatures.push(feature);
    } else {
        configState.productFeatures.push(feature);
    }

    renderStep2();
}

// =============================================================================
// PRIMARY ID DROP HANDLING
// =============================================================================

function dragEnterPrimaryId(e) {
    e.preventDefault();
    e.currentTarget.classList.add('drag-over');
}

function dragLeavePrimaryId(e) {
    e.currentTarget.classList.remove('drag-over');
}

function allowDropIfUnlocked(e, model) {
    const isUnlocked = model === 'buyer' ? configState.customerIdFeature : configState.productIdFeature;
    if (isUnlocked) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
    }
}

function dragEnterIfUnlocked(e, model) {
    const isUnlocked = model === 'buyer' ? configState.customerIdFeature : configState.productIdFeature;
    if (isUnlocked) {
        e.preventDefault();
        e.currentTarget.classList.add('drag-over');
    }
}

function dropPrimaryId(e, model) {
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');

    const colData = JSON.parse(e.dataTransfer.getData('text/plain'));

    // Create primary ID feature with forced text type and embedding transform
    const cardinality = colData.stats?.cardinality || colData.stats?.unique_count;
    const recommendedDim = getRecommendedEmbedDim(cardinality || 10000);  // Default assumes medium cardinality

    const primaryIdFeature = {
        column: colData.name,
        display_name: colData.display_name || colData.name,  // Preserve alias for UI display
        bq_type: colData.bq_type || colData.type || 'STRING',
        data_type: 'text',  // Force to text regardless of original type
        is_primary_id: true,
        stats: colData.stats || {},
        transforms: {
            embedding: {
                enabled: true,
                embedding_dim: recommendedDim,  // Auto-apply based on cardinality
                vocab_size: 100000
            }
        }
    };

    if (model === 'buyer') {
        configState.customerIdFeature = primaryIdFeature;
    } else {
        configState.productIdFeature = primaryIdFeature;
    }

    renderStep2();
}

function removePrimaryId(model) {
    if (model === 'buyer') {
        configState.customerIdFeature = null;
        // Also clear additional features since the model is now locked
        configState.buyerFeatures = [];
        configState.buyerCrosses = [];
    } else {
        configState.productIdFeature = null;
        // Also clear additional features since the model is now locked
        configState.productFeatures = [];
        configState.productCrosses = [];
    }
    renderStep2();
}

// =============================================================================
// TARGET COLUMN HANDLING (for Ranking models)
// =============================================================================

function dragEnterTarget(e) {
    e.preventDefault();
    e.currentTarget.classList.add('drag-over');
}

function dragLeaveTarget(e) {
    e.currentTarget.classList.remove('drag-over');
}

function dropTargetColumn(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');

    const colData = JSON.parse(e.dataTransfer.getData('text/plain'));
    const colType = (colData.bq_type || colData.type || '').toUpperCase();

    // Validate: must be numeric type
    const numericTypes = ['INTEGER', 'INT64', 'FLOAT', 'FLOAT64', 'NUMERIC', 'BIGNUMERIC', 'DECIMAL'];
    if (!numericTypes.includes(colType)) {
        showError('Target column must be numeric (INTEGER, FLOAT, etc.)');
        return;
    }

    // Set target column with new clip schema
    configState.targetColumn = {
        column: colData.name,
        display_name: colData.display_name || colData.name,
        bq_type: colType,
        transforms: {
            normalize: { enabled: false, range: [0, 1] },
            log_transform: { enabled: false },
            clip_outliers: {
                enabled: false,
                lower: { enabled: false, percentile: 1 },
                upper: { enabled: true, percentile: 99 }
            }
        }
    };

    // Remove target column from buyer/product models if present
    removeTargetColumnFromModels(colData.name, colData.display_name);

    // Update UI
    renderTargetColumn();
    renderStep2();

    showSuccess(`Target column set: ${colData.display_name || colData.name}`);
}

function removeTargetColumnFromModels(column, displayName) {
    // Remove from buyer features
    configState.buyerFeatures = configState.buyerFeatures.filter(
        f => f.column !== column && f.display_name !== displayName
    );

    // Remove from product features
    configState.productFeatures = configState.productFeatures.filter(
        f => f.column !== column && f.display_name !== displayName
    );

    // Check if it was a primary ID
    if (configState.customerIdFeature &&
        (configState.customerIdFeature.column === column || configState.customerIdFeature.display_name === displayName)) {
        configState.customerIdFeature = null;
        configState.buyerFeatures = [];
        configState.buyerCrosses = [];
    }

    if (configState.productIdFeature &&
        (configState.productIdFeature.column === column || configState.productIdFeature.display_name === displayName)) {
        configState.productIdFeature = null;
        configState.productFeatures = [];
        configState.productCrosses = [];
    }
}

function clearTargetColumn() {
    configState.targetColumn = null;
    renderTargetColumn();
}

function renderTargetColumn() {
    const placeholder = document.getElementById('targetColumnPlaceholder');
    const content = document.getElementById('targetColumnContent');
    const config = document.getElementById('targetColumnConfig');

    if (configState.targetColumn) {
        placeholder.style.display = 'none';
        content.style.display = 'block';
        config.style.display = 'block';

        const col = configState.targetColumn;
        content.innerHTML = `
            <div class="target-column-card">
                <div class="column-info">
                    <i class="fas fa-bullseye" style="color: #f59e0b;"></i>
                    <span class="column-name">${col.display_name || col.column}</span>
                    <span class="column-type">${col.bq_type}</span>
                </div>
                <button type="button" class="feature-config-btn remove" onclick="clearTargetColumn()" title="Remove target column">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;

        // Set checkbox states
        const transforms = col.transforms || {};
        document.getElementById('targetNormalize').checked = transforms.normalize?.enabled || false;
        document.getElementById('targetLogTransform').checked = transforms.log_transform?.enabled || false;

        // Handle clip outliers - support both old and new schema
        const clip = transforms.clip_outliers || {};
        const clipEnabled = clip.enabled || false;
        document.getElementById('targetClipOutliers').checked = clipEnabled;

        // Set clip lower/upper options (with backward compatibility)
        if (clip.lower !== undefined) {
            // New schema
            document.getElementById('clipLowerEnabled').checked = clip.lower?.enabled || false;
            document.getElementById('clipLowerPercentile').value = clip.lower?.percentile || 1;
            document.getElementById('clipUpperEnabled').checked = clip.upper?.enabled !== false;
            document.getElementById('clipUpperPercentile').value = clip.upper?.percentile || 99;
        } else {
            // Old schema - convert to new format
            document.getElementById('clipLowerEnabled').checked = false;
            document.getElementById('clipLowerPercentile').value = 1;
            document.getElementById('clipUpperEnabled').checked = clipEnabled;
            document.getElementById('clipUpperPercentile').value = clip.percentile || 99;
        }

        // Show/hide clip options
        document.getElementById('clipOutliersOptions').style.display = clipEnabled ? 'block' : 'none';
    } else {
        placeholder.style.display = 'block';
        content.style.display = 'none';
        config.style.display = 'none';
    }
}

function toggleClipOptions() {
    const clipEnabled = document.getElementById('targetClipOutliers').checked;
    document.getElementById('clipOutliersOptions').style.display = clipEnabled ? 'block' : 'none';
    updateTargetTransforms();
}

function updateTargetTransforms() {
    if (!configState.targetColumn) return;

    const clipEnabled = document.getElementById('targetClipOutliers').checked;

    configState.targetColumn.transforms = {
        normalize: {
            enabled: document.getElementById('targetNormalize').checked,
            range: [0, 1]
        },
        log_transform: {
            enabled: document.getElementById('targetLogTransform').checked
        },
        clip_outliers: {
            enabled: clipEnabled,
            lower: {
                enabled: clipEnabled && document.getElementById('clipLowerEnabled').checked,
                percentile: parseInt(document.getElementById('clipLowerPercentile').value)
            },
            upper: {
                enabled: clipEnabled && document.getElementById('clipUpperEnabled').checked,
                percentile: parseFloat(document.getElementById('clipUpperPercentile').value)
            }
        }
    };
}

function openPrimaryIdConfig(model) {
    const feature = model === 'buyer' ? configState.customerIdFeature : configState.productIdFeature;
    if (!feature) return;

    editingFeature = {...feature, _model: model, _isPrimaryId: true};
    editingFeatureModel = model;

    const idLabel = model === 'buyer' ? 'Customer ID' : 'Product ID';
    document.getElementById('featureModalTitle').textContent = `Configure: ${idLabel}`;
    renderPrimaryIdConfigForm();
    document.getElementById('featureConfigModal').classList.remove('hidden');
}

function renderPrimaryIdConfigForm() {
    const body = document.getElementById('featureModalBody');
    const presetDims = [8, 16, 32, 64, 128, 256];
    // Use display_name (alias) if available
    const displayName = editingFeature.display_name || editingFeature.column;

    // Calculate cardinality-based recommendation
    const cardinality = editingFeature.stats?.cardinality || editingFeature.stats?.unique_count;
    const recommendedDim = cardinality ? getRecommendedEmbedDim(cardinality) : 32;
    const cardinalityText = cardinality ? formatCardinality(cardinality) : null;

    // Use existing value if configured, otherwise use recommendation
    const embedDim = editingFeature.transforms?.embedding?.embedding_dim || recommendedDim;
    const isCustom = !presetDims.includes(embedDim);

    // Determine if this is Customer ID or Product ID for contextual messaging
    const isCustomerId = editingFeature._model === 'buyer';
    const idTypeLabel = isCustomerId ? 'customers' : 'products';

    // Build cardinality recommendation banner
    let cardinalityBannerHtml = '';
    if (cardinalityText) {
        const isRecommended = embedDim === recommendedDim;
        cardinalityBannerHtml = `
            <div class="flex items-center justify-center gap-2 p-3 rounded-lg mb-4 ${isRecommended ? 'bg-green-50 border border-green-200' : 'bg-amber-50 border border-amber-200'}">
                <i class="fas fa-chart-bar ${isRecommended ? 'text-green-600' : 'text-amber-600'}"></i>
                <span class="text-sm ${isRecommended ? 'text-green-700' : 'text-amber-700'}">
                    ${cardinalityText} unique ${idTypeLabel} 
                    ${isRecommended
                        ? `<strong> ${recommendedDim}D recommended</strong>`
                        : `<strong>${recommendedDim}D recommended</strong>`}
                </span>
            </div>
        `;
    }

    body.innerHTML = `
        <div class="mb-4">
            <div class="text-sm text-gray-600 mb-2">
                <strong>Column:</strong> ${escapeHtml(displayName)}
            </div>
            <div class="text-sm text-gray-500">
                Original type: ${editingFeature.bq_type || 'STRING'}  <span class="text-blue-600 font-medium">Text (forced)</span>
            </div>
        </div>

        <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg mb-4">
            <div class="text-sm text-blue-800">
                <i class="fas fa-info-circle mr-2"></i>
                Primary ID columns use text embedding. Other transforms are not available.
            </div>
        </div>

        ${cardinalityBannerHtml}

        <div class="modal-form-group">
            <label class="modal-form-label">Embedding Dimension</label>
            <div class="flex gap-2 flex-wrap items-center justify-center">
                ${presetDims.map(dim => `
                    <button type="button"
                            class="primary-id-dim-btn px-3 py-2 rounded-lg border transition-all ${embedDim === dim && !isCustom
                                ? 'bg-blue-500 text-white border-blue-500'
                                : 'bg-white text-gray-700 border-gray-300 hover:border-blue-400'}
                            ${dim === recommendedDim ? 'ring-2 ring-offset-1 ring-green-400' : ''}"
                            onclick="selectPrimaryIdDim(${dim})"
                            title="${dim === recommendedDim ? 'Recommended based on cardinality' : ''}">
                        ${dim}D${dim === recommendedDim ? ' ' : ''}
                    </button>
                `).join('')}
            </div>
            <div class="flex items-center gap-3 mt-3 justify-center">
                <span class="text-sm text-gray-600">Custom:</span>
                <input type="number"
                       id="customEmbedDimInput"
                       class="form-input text-sm"
                       style="width: 100px;"
                       min="4"
                       max="1024"
                       step="1"
                       value="${isCustom ? embedDim : ''}"
                       placeholder="e.g. 512"
                       onchange="onCustomDimChange(this.value)"
                       oninput="onCustomDimInput(this.value)">
                <span class="text-xs text-gray-500">Range: 4 - 1024</span>
            </div>
        </div>

        <div class="border-t border-gray-200 pt-4 mt-4 space-y-2">
            <div class="flex items-start gap-2 text-xs text-gray-600">
                <i class="fas fa-database text-blue-500 mt-0.5"></i>
                <span><strong>Vocabulary:</strong> Auto-detected from training data</span>
            </div>
            <div class="flex items-start gap-2 text-xs text-gray-600">
                <i class="fas fa-plus-circle text-green-500 mt-0.5"></i>
                <span><strong>+1 OOV:</strong> New ${idTypeLabel} not in training data will use a learned "cold start" embedding</span>
            </div>
        </div>

        <input type="hidden" id="primaryIdEmbedDim" value="${embedDim}">
    `;
}

function selectPrimaryIdDim(dim) {
    document.getElementById('primaryIdEmbedDim').value = dim;

    // Clear custom input when preset is selected
    const customInput = document.getElementById('customEmbedDimInput');
    if (customInput) {
        customInput.value = '';
    }

    // Update button styles
    const buttons = document.querySelectorAll('.primary-id-dim-btn');
    buttons.forEach(btn => {
        const btnDim = parseInt(btn.textContent);
        if (btnDim === dim) {
            btn.className = 'primary-id-dim-btn px-3 py-2 rounded-lg border transition-all bg-blue-500 text-white border-blue-500';
        } else {
            btn.className = 'primary-id-dim-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400';
        }
    });
}

function onCustomDimInput(value) {
    // Live update as user types - deselect preset buttons
    if (value) {
        const buttons = document.querySelectorAll('.primary-id-dim-btn');
        buttons.forEach(btn => {
            btn.className = 'primary-id-dim-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400';
        });
    }
}

function onCustomDimChange(value) {
    // Validate and set the custom dimension
    let dim = parseInt(value);
    if (isNaN(dim) || dim < 4) {
        dim = 4;
        document.getElementById('customEmbedDimInput').value = 4;
    } else if (dim > 1024) {
        dim = 1024;
        document.getElementById('customEmbedDimInput').value = 1024;
    }

    document.getElementById('primaryIdEmbedDim').value = dim;

    // Deselect all preset buttons
    const buttons = document.querySelectorAll('.primary-id-dim-btn');
    buttons.forEach(btn => {
        btn.className = 'primary-id-dim-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400';
    });
}

function applyPrimaryIdConfig() {
    const model = editingFeature._model;
    const newDim = parseInt(document.getElementById('primaryIdEmbedDim').value) || 32;

    if (model === 'buyer' && configState.customerIdFeature) {
        configState.customerIdFeature.transforms.embedding.embedding_dim = newDim;
    } else if (model === 'product' && configState.productIdFeature) {
        configState.productIdFeature.transforms.embedding.embedding_dim = newDim;
    }

    closeFeatureModal();
    renderStep2();
}

// =============================================================================
// TEXT EMBEDDING DIMENSION SELECTION (for context features)
// =============================================================================

function selectTextEmbedDim(dim) {
    document.getElementById('featureEmbedDim').value = dim;

    // Clear custom input when preset is selected
    const customInput = document.getElementById('customTextEmbedDimInput');
    if (customInput) {
        customInput.value = '';
    }

    // Update dimension label
    const dimLabel = document.getElementById('embeddingDimLabel');
    if (dimLabel) {
        dimLabel.textContent = `+${dim}D`;
    }

    // Update button styles
    const buttons = document.querySelectorAll('.text-embed-dim-btn');
    buttons.forEach(btn => {
        const btnDim = parseInt(btn.textContent);
        if (btnDim === dim) {
            btn.className = 'text-embed-dim-btn px-3 py-2 rounded-lg border transition-all bg-blue-500 text-white border-blue-500';
        } else {
            btn.className = 'text-embed-dim-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400';
        }
    });
}

function onCustomTextEmbedDimInput(value) {
    // Live update as user types - deselect preset buttons
    if (value) {
        const buttons = document.querySelectorAll('.text-embed-dim-btn');
        buttons.forEach(btn => {
            btn.className = 'text-embed-dim-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400';
        });
    }
}

function onCustomTextEmbedDimChange(value) {
    // Validate and set the custom dimension
    let dim = parseInt(value);
    if (isNaN(dim) || dim < 4) {
        dim = 4;
        document.getElementById('customTextEmbedDimInput').value = 4;
    } else if (dim > 1024) {
        dim = 1024;
        document.getElementById('customTextEmbedDimInput').value = 1024;
    }

    document.getElementById('featureEmbedDim').value = dim;

    // Update dimension label
    const dimLabel = document.getElementById('embeddingDimLabel');
    if (dimLabel) {
        dimLabel.textContent = `+${dim}D`;
    }

    // Deselect all preset buttons
    const buttons = document.querySelectorAll('.text-embed-dim-btn');
    buttons.forEach(btn => {
        btn.className = 'text-embed-dim-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400';
    });
}

function createDefaultFeature(col) {
    // Create feature with BQ type, but NO transforms applied
    // User must configure transforms via the settings modal
    const bqType = col.bq_type || col.type || 'STRING';
    const dataType = getDataTypeFromBqType(bqType);

    return {
        column: col.name,
        display_name: col.display_name || col.name,  // Preserve alias for UI display
        bq_type: bqType,
        data_type: dataType,  // Numeric, Text, or Temporal
        stats: col.stats || {},
        transforms: {}  // Empty - user must configure
    };
}

function detectCyclicalPeriod(col) {
    const colName = (col.name || '').toLowerCase();
    const min = col.stats?.min;
    const max = col.stats?.max;

    // Try to detect from column name
    if (colName.includes('hour')) return 24;
    if (colName.includes('day_of_week') || colName.includes('weekday')) return 7;
    if (colName.includes('month')) return 12;
    if (colName.includes('day_of_month') || colName.includes('day')) return 31;
    if (colName.includes('quarter')) return 4;

    // Try to detect from value range
    if (min !== undefined && max !== undefined) {
        if (min >= 0 && max <= 23) return 24;
        if (min >= 0 && max <= 6) return 7;
        if (min >= 1 && max <= 12) return 12;
        if (min >= 1 && max <= 31) return 31;
        if (min >= 1 && max <= 4) return 4;
    }

    return 12; // Default to monthly
}

function getRecommendedEmbedDim(cardinality) {
    if (cardinality < 50) return 8;
    if (cardinality < 500) return 16;
    if (cardinality < 5000) return 32;
    if (cardinality < 50000) return 64;
    if (cardinality < 500000) return 96;
    return 128;
}

/**
 * Format cardinality number for display (e.g., 200000  "~200K", 3500000  "~3.5M")
 */
function formatCardinality(num) {
    if (num == null) return null;
    if (num >= 1000000) {
        const millions = num / 1000000;
        return `~${millions >= 10 ? Math.round(millions) : millions.toFixed(1).replace(/\.0$/, '')}M`;
    }
    if (num >= 1000) {
        const thousands = num / 1000;
        return `~${thousands >= 10 ? Math.round(thousands) : thousands.toFixed(1).replace(/\.0$/, '')}K`;
    }
    return `~${num}`;
}

function removeFeature(model, idx) {
    if (model === 'buyer') {
        configState.buyerFeatures.splice(idx, 1);
    } else {
        configState.productFeatures.splice(idx, 1);
    }
    renderStep2();
}

function removeCross(model, idx) {
    if (model === 'buyer') {
        configState.buyerCrosses.splice(idx, 1);
    } else {
        configState.productCrosses.splice(idx, 1);
    }
    renderStep2();
}

// =============================================================================
// TENSOR PREVIEW
// =============================================================================

/**
 * Calculate tensor breakdown from feature arrays
 * @param {Array} features - Array of feature objects
 * @param {Array} crosses - Array of cross feature objects
 * @returns {Object} { total: number, breakdown: Array<{name, dim, is_cross?}> }
 */
function calculateTensorBreakdown(features, crosses) {
    const breakdown = [];
    let total = 0;

    // Process features
    (features || []).forEach(feature => {
        const info = getFeatureDisplayInfo(feature);
        if (info.totalDim > 0) {
            breakdown.push({ name: feature.column, dim: info.totalDim });
            total += info.totalDim;
        }
    });

    // Process cross features
    (crosses || []).forEach(cross => {
        const dim = cross.embedding_dim || 16;
        const featureNames = getCrossFeatureNames(cross);
        const name = featureNames.join('  ');
        breakdown.push({ name: name, dim: dim, is_cross: true });
        total += dim;
    });

    return { total, breakdown };
}

function updateTensorPreview() {
    // Calculate buyer tensor dimensions
    const buyerFeatures = [];
    if (configState.customerIdFeature) {
        buyerFeatures.push(configState.customerIdFeature);
    }
    buyerFeatures.push(...configState.buyerFeatures);
    const buyerResult = calculateTensorBreakdown(buyerFeatures, configState.buyerCrosses);

    // Calculate product tensor dimensions
    const productFeatures = [];
    if (configState.productIdFeature) {
        productFeatures.push(configState.productIdFeature);
    }
    productFeatures.push(...configState.productFeatures);
    const productResult = calculateTensorBreakdown(productFeatures, configState.productCrosses);

    // Render both previews
    renderTensorPreview('buyer', buyerResult.total, buyerResult.breakdown);
    renderTensorPreview('product', productResult.total, productResult.breakdown);
}

/**
 * Render tensor visualization bar and breakdown tags
 * Can be called with either:
 *   - model name (for wizard): renderTensorPreview('buyer', total, breakdown)
 *   - DOM elements directly (for cards): renderTensorPreview('buyer', total, breakdown, barEl, breakdownEl, maxTotal)
 * @param maxTotal - max total across both tensors for proportional bar width
 */
function renderTensorPreview(model, total, breakdown, barContainer = null, breakdownContainer = null, maxTotal = null) {
    // Get containers - either from params or by ID (wizard mode)
    if (!barContainer) {
        document.getElementById(`${model}TensorTotal`).textContent = `${total}D`;
        barContainer = document.getElementById(`${model}TensorBar`);
        breakdownContainer = document.getElementById(`${model}TensorBreakdown`);
    }

    barContainer.innerHTML = '';
    if (breakdownContainer) breakdownContainer.innerHTML = '';

    if (!breakdown || breakdown.length === 0) return;

    // Set bar container width proportionally if maxTotal provided
    if (maxTotal && maxTotal > 0) {
        const widthPercent = (total / maxTotal) * 100;
        barContainer.style.width = `${widthPercent}%`;
    } else {
        barContainer.style.width = '100%';
    }

    const colors = model === 'buyer'
        ? ['#3b82f6', '#60a5fa', '#93c5fd', '#bfdbfe', '#dbeafe']
        : ['#10b981', '#34d399', '#6ee7b7', '#a7f3d0', '#d1fae5'];

    breakdown.forEach((item, idx) => {
        const pct = (item.dim / total) * 100;
        const color = colors[idx % colors.length];

        const segment = document.createElement('div');
        segment.className = 'tensor-breakdown-segment';
        segment.style.width = `${pct}%`;
        segment.style.backgroundColor = color;
        segment.title = `${item.name}: ${item.dim}D`;
        if (pct > 10) {
            segment.textContent = item.dim;
        }
        barContainer.appendChild(segment);

        if (breakdownContainer) {
            const tag = document.createElement('span');
            tag.className = 'tensor-breakdown-item';
            tag.textContent = `${item.name}: ${item.dim}D`;
            breakdownContainer.appendChild(tag);
        }
    });
}

// =============================================================================
// FEATURE CONFIGURATION MODAL
// =============================================================================

function openFeatureConfig(model, idx) {
    editingFeatureModel = model;
    const features = model === 'buyer' ? configState.buyerFeatures : configState.productFeatures;
    editingFeature = {...features[idx], _idx: idx};

    // Use display_name (alias) if available
    const displayName = editingFeature.display_name || editingFeature.column;
    document.getElementById('featureModalTitle').textContent = `Configure: ${displayName}`;
    renderFeatureConfigForm();
    document.getElementById('featureConfigModal').classList.remove('hidden');
}

function closeFeatureModal() {
    document.getElementById('featureConfigModal').classList.add('hidden');
    editingFeature = null;
    editingFeatureModel = null;
}

function renderFeatureConfigForm() {
    const body = document.getElementById('featureModalBody');
    const dataType = editingFeature.data_type || getDataTypeFromBqType(editingFeature.bq_type);
    const t = editingFeature.transforms || {};

    // Build data type selector
    const dataTypeOptions = ['numeric', 'text', 'temporal'].map(dt =>
        `<option value="${dt}" ${dataType === dt ? 'selected' : ''}>${getDataTypeLabel(dt)}</option>`
    ).join('');

    let transformsHtml = '';

    if (dataType === 'numeric') {
        transformsHtml = `
            <div class="transform-option">
                <input type="checkbox" id="featureNormalize" ${t.normalize?.enabled ? 'checked' : ''}>
                <div class="transform-option-content">
                    <div class="transform-option-title">Normalize</div>
                    <div class="transform-option-desc">Scale values to [-1, 1] range</div>
                </div>
                <span class="transform-option-dim">+1D</span>
            </div>
            <div class="transform-option">
                <input type="checkbox" id="featureBucketize" ${t.bucketize?.enabled ? 'checked' : ''}>
                <div class="transform-option-content">
                    <div class="transform-option-title">Bucketize + Embed</div>
                    <div class="transform-option-desc">Discretize into buckets with learned embedding</div>
                    <div class="mt-2">
                        <label class="text-xs text-gray-500">Buckets:</label>
                        <select id="featureBuckets" class="form-select form-select-sm ml-2" style="width: 80px;">
                            ${[10, 50, 100, 200].map(b =>
                                `<option value="${b}" ${(t.bucketize?.buckets || 100) == b ? 'selected' : ''}>${b}</option>`
                            ).join('')}
                        </select>
                        <label class="text-xs text-gray-500 ml-3">Dim:</label>
                        <select id="featureBucketDim" class="form-select form-select-sm ml-2" style="width: 80px;">
                            ${[8, 16, 32, 64].map(d =>
                                `<option value="${d}" ${(t.bucketize?.embedding_dim || 32) == d ? 'selected' : ''}>${d}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
                <span class="transform-option-dim" id="bucketizeDimLabel">+${t.bucketize?.embedding_dim || 32}D</span>
            </div>
        `;
    } else if (dataType === 'text') {
        // Calculate cardinality-based recommendation
        const cardinality = editingFeature.stats?.cardinality || editingFeature.stats?.unique_count;
        const recommendedDim = cardinality ? getRecommendedEmbedDim(cardinality) : 32;

        // Use existing value if configured, otherwise use recommendation (or 32 as fallback)
        const embedDim = t.embedding?.embedding_dim || recommendedDim;
        const presetDims = [8, 16, 32, 64, 128, 256];
        const isCustomDim = !presetDims.includes(embedDim);
        const cardinalityText = cardinality ? formatCardinality(cardinality) : null;

        // Build cardinality info line
        let cardinalityInfoHtml = '';
        if (cardinalityText && recommendedDim) {
            const isRecommended = embedDim === recommendedDim;
            cardinalityInfoHtml = `
                <div class="flex items-center justify-center gap-2 mb-3 p-2 rounded-lg ${isRecommended ? 'bg-green-50 border border-green-200' : 'bg-amber-50 border border-amber-200'}">
                    <i class="fas fa-chart-bar ${isRecommended ? 'text-green-600' : 'text-amber-600'}"></i>
                    <span class="text-sm ${isRecommended ? 'text-green-700' : 'text-amber-700'}">
                        ${cardinalityText} unique values 
                        ${isRecommended
                            ? `<strong> ${recommendedDim}D recommended</strong>`
                            : `<strong>${recommendedDim}D recommended</strong>`}
                    </span>
                </div>
            `;
        }

        transformsHtml = `
            <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg">
                <div class="flex items-center justify-between mb-3">
                    <div>
                        <div class="font-medium text-gray-800">Embedding</div>
                        <div class="text-xs text-gray-500">Learn vector representation for categorical values</div>
                    </div>
                    <span class="text-blue-600 font-medium" id="embeddingDimLabel">+${embedDim}D</span>
                </div>

                ${cardinalityInfoHtml}

                <div class="mb-3">
                    <label class="text-xs text-gray-600 font-medium mb-2 block">Embedding Dimension</label>
                    <div class="flex gap-2 flex-wrap items-center justify-center">
                        ${presetDims.map(dim => `
                            <button type="button"
                                    class="text-embed-dim-btn px-3 py-2 rounded-lg border transition-all ${embedDim === dim && !isCustomDim
                                        ? 'bg-blue-500 text-white border-blue-500'
                                        : 'bg-white text-gray-700 border-gray-300 hover:border-blue-400'}
                                    ${dim === recommendedDim ? 'ring-2 ring-offset-1 ring-green-400' : ''}"
                                    onclick="selectTextEmbedDim(${dim})"
                                    title="${dim === recommendedDim ? 'Recommended based on cardinality' : ''}">
                                ${dim}D${dim === recommendedDim ? ' ' : ''}
                            </button>
                        `).join('')}
                    </div>
                    <div class="flex items-center gap-3 mt-3 justify-center">
                        <span class="text-xs text-gray-600">Custom:</span>
                        <input type="number"
                               id="customTextEmbedDimInput"
                               class="form-input text-sm"
                               style="width: 80px;"
                               min="4"
                               max="1024"
                               step="1"
                               value="${isCustomDim ? embedDim : ''}"
                               placeholder="e.g. 512"
                               onchange="onCustomTextEmbedDimChange(this.value)"
                               oninput="onCustomTextEmbedDimInput(this.value)">
                        <span class="text-xs text-gray-400">4 - 1024</span>
                    </div>
                </div>

                <div class="border-t border-gray-200 pt-3 mt-3 space-y-2">
                    <div class="flex items-start gap-2 text-xs text-gray-600">
                        <i class="fas fa-database text-blue-500 mt-0.5"></i>
                        <span><strong>Vocabulary:</strong> Auto-detected from training data (no manual limit needed)</span>
                    </div>
                    <div class="flex items-start gap-2 text-xs text-gray-600">
                        <i class="fas fa-plus-circle text-green-500 mt-0.5"></i>
                        <span><strong>+1 OOV:</strong> One extra dimension is automatically reserved for new/unknown values</span>
                    </div>
                </div>
            </div>
            <input type="hidden" id="featureEmbedDim" value="${embedDim}">
        `;
    } else if (dataType === 'temporal') {
        const c = t.cyclical || {};
        transformsHtml = `
            <div class="transform-option">
                <input type="checkbox" id="featureNormalize" ${t.normalize?.enabled ? 'checked' : ''}>
                <div class="transform-option-content">
                    <div class="transform-option-title">Normalize</div>
                    <div class="transform-option-desc">Scale timestamp to [-1, 1] range</div>
                </div>
                <span class="transform-option-dim">+1D</span>
            </div>
            <div class="transform-option" style="flex-direction: column; align-items: stretch;">
                <div class="flex items-start gap-2 w-full">
                    <div class="transform-option-content flex-1">
                        <div class="transform-option-title">Cyclical Features</div>
                        <div class="transform-option-desc">Extract periodic patterns using sin/cos encoding</div>
                    </div>
                    <span class="transform-option-dim">varies</span>
                </div>
                <div class="space-y-1 mt-3">
                    <label class="flex items-center gap-2 text-xs">
                        <input type="checkbox" id="cyclicalYearly" ${c.yearly ? 'checked' : ''}>
                        <span>Yearly (month of year)</span>
                        <span class="text-blue-600 ml-auto">+2D</span>
                    </label>
                    <label class="flex items-center gap-2 text-xs">
                        <input type="checkbox" id="cyclicalQuarterly" ${c.quarterly ? 'checked' : ''}>
                        <span>Quarterly (month of quarter)</span>
                        <span class="text-blue-600 ml-auto">+2D</span>
                    </label>
                    <label class="flex items-center gap-2 text-xs">
                        <input type="checkbox" id="cyclicalMonthly" ${c.monthly ? 'checked' : ''}>
                        <span>Monthly (day of month)</span>
                        <span class="text-blue-600 ml-auto">+2D</span>
                    </label>
                    <label class="flex items-center gap-2 text-xs">
                        <input type="checkbox" id="cyclicalWeekly" ${c.weekly ? 'checked' : ''}>
                        <span>Weekly (day of week)</span>
                        <span class="text-blue-600 ml-auto">+2D</span>
                    </label>
                    <label class="flex items-center gap-2 text-xs">
                        <input type="checkbox" id="cyclicalDaily" ${c.daily ? 'checked' : ''}>
                        <span>Daily (hour of day)</span>
                        <span class="text-blue-600 ml-auto">+2D</span>
                    </label>
                </div>
            </div>
            <div class="transform-option">
                <input type="checkbox" id="featureBucketize" ${t.bucketize?.enabled ? 'checked' : ''}>
                <div class="transform-option-content">
                    <div class="transform-option-title">Bucketize + Embed</div>
                    <div class="transform-option-desc">Discretize into time buckets with learned embedding</div>
                    <div class="mt-2">
                        <label class="text-xs text-gray-500">Buckets:</label>
                        <select id="featureBuckets" class="form-select form-select-sm ml-2" style="width: 80px;">
                            ${[10, 50, 100, 200].map(b =>
                                `<option value="${b}" ${(t.bucketize?.buckets || 100) == b ? 'selected' : ''}>${b}</option>`
                            ).join('')}
                        </select>
                        <label class="text-xs text-gray-500 ml-3">Dim:</label>
                        <select id="featureBucketDim" class="form-select form-select-sm ml-2" style="width: 80px;">
                            ${[8, 16, 32, 64].map(d =>
                                `<option value="${d}" ${(t.bucketize?.embedding_dim || 32) == d ? 'selected' : ''}>${d}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
                <span class="transform-option-dim">+${t.bucketize?.embedding_dim || 32}D</span>
            </div>
        `;
    }

    body.innerHTML = `
        <div class="modal-form-group">
            <label class="modal-form-label">Data Type</label>
            <select id="modalDataType" class="form-select w-full" onchange="onModalDataTypeChange(this.value)">
                ${dataTypeOptions}
            </select>
            <p class="modal-form-hint">Original BQ type: ${editingFeature.bq_type || 'STRING'}</p>
        </div>
        <div class="modal-form-group">
            <label class="modal-form-label">Transformations</label>
            <p class="text-xs text-gray-500 mb-2">Select at least one transformation to include this feature in the model</p>
            <div id="transformOptions">
                ${transformsHtml}
            </div>
        </div>
    `;
}

function onModalDataTypeChange(newDataType) {
    // Update the editing feature's data type and re-render the form
    editingFeature.data_type = newDataType;
    editingFeature.transforms = {};  // Clear transforms when type changes
    renderFeatureConfigForm();
}

function applyFeatureConfig() {
    // Check if we're editing a primary ID feature
    if (editingFeature._isPrimaryId) {
        applyPrimaryIdConfig();
        return;
    }

    const features = editingFeatureModel === 'buyer' ? configState.buyerFeatures : configState.productFeatures;
    const idx = editingFeature._idx;
    const dataType = editingFeature.data_type || getDataTypeFromBqType(editingFeature.bq_type);

    // Update the data type
    features[idx].data_type = dataType;

    // Build transforms based on data type
    const transforms = {};

    if (dataType === 'numeric') {
        const normalizeEl = document.getElementById('featureNormalize');
        const bucketizeEl = document.getElementById('featureBucketize');

        if (normalizeEl?.checked) {
            transforms.normalize = { enabled: true, range: [-1, 1] };
        }
        if (bucketizeEl?.checked) {
            transforms.bucketize = {
                enabled: true,
                buckets: parseInt(document.getElementById('featureBuckets').value) || 100,
                embedding_dim: parseInt(document.getElementById('featureBucketDim').value) || 32
            };
        }
    } else if (dataType === 'text') {
        // Text features always use embedding (no checkbox needed)
        // Vocab size is auto-detected from training data, so we don't store it
        transforms.embedding = {
            enabled: true,
            embedding_dim: parseInt(document.getElementById('featureEmbedDim').value) || 32
        };
    } else if (dataType === 'temporal') {
        const normalizeEl = document.getElementById('featureNormalize');
        const bucketizeEl = document.getElementById('featureBucketize');

        if (normalizeEl?.checked) {
            transforms.normalize = { enabled: true, range: [-1, 1] };
        }

        // Check if any cyclical option is selected
        const yearly = document.getElementById('cyclicalYearly')?.checked || false;
        const quarterly = document.getElementById('cyclicalQuarterly')?.checked || false;
        const monthly = document.getElementById('cyclicalMonthly')?.checked || false;
        const weekly = document.getElementById('cyclicalWeekly')?.checked || false;
        const daily = document.getElementById('cyclicalDaily')?.checked || false;

        if (yearly || quarterly || monthly || weekly || daily) {
            transforms.cyclical = {
                enabled: true,
                yearly: yearly,
                quarterly: quarterly,
                monthly: monthly,
                weekly: weekly,
                daily: daily
            };
        }

        if (bucketizeEl?.checked) {
            transforms.bucketize = {
                enabled: true,
                buckets: parseInt(document.getElementById('featureBuckets').value) || 100,
                embedding_dim: parseInt(document.getElementById('featureBucketDim').value) || 32
            };
        }
    }

    features[idx].transforms = transforms;

    closeFeatureModal();
    renderStep2();
}

// =============================================================================
// CROSS FEATURE MODAL
// =============================================================================

function openCrossModal(model) {
    crossFeatureModel = model;

    // Get all features for this model, including the primary ID
    const primaryId = model === 'buyer' ? configState.customerIdFeature : configState.productIdFeature;
    const additionalFeatures = model === 'buyer' ? configState.buyerFeatures : configState.productFeatures;

    // Combine: primary ID first, then additional features
    const allFeatures = primaryId ? [primaryId, ...additionalFeatures] : additionalFeatures;

    const container = document.getElementById('crossFeatureOptions');
    container.innerHTML = '';

    allFeatures.forEach(f => {
        const label = document.createElement('label');
        const isPrimaryId = f.is_primary_id;
        const dataType = f.data_type || getDataTypeFromBqType(f.bq_type);
        const dataTypeLabel = getDataTypeLabel(dataType);

        // Determine badge color based on data type
        let typeBadge = '';
        if (isPrimaryId) {
            typeBadge = '<span class="text-xs bg-amber-100 text-amber-700 px-1 rounded">ID</span>';
        } else if (dataType === 'numeric') {
            typeBadge = '<span class="text-xs bg-blue-100 text-blue-700 px-1 rounded">Numeric</span>';
        } else if (dataType === 'temporal') {
            typeBadge = '<span class="text-xs bg-purple-100 text-purple-700 px-1 rounded">Temporal</span>';
        } else {
            typeBadge = '<span class="text-xs bg-gray-100 text-gray-600 px-1 rounded">Text</span>';
        }

        label.className = 'flex items-center gap-2 p-2 border rounded cursor-pointer hover:bg-gray-50';
        const displayName = f.display_name || f.column;
        label.innerHTML = `
            <input type="checkbox" class="cross-feature-checkbox" value="${f.column}"
                   data-type="${dataType}" data-display-name="${displayName}" onchange="updateCrossPreview()">
            <span class="text-sm flex-1">${displayName}</span>
            ${typeBadge}
        `;
        container.appendChild(label);
    });

    // Reset bucket options
    document.getElementById('crossBucketOptions').classList.add('hidden');
    document.getElementById('crossBucketInputs').innerHTML = '';
    document.getElementById('crossPreview').classList.add('hidden');
    document.getElementById('crossFeatureModal').classList.remove('hidden');
}

function closeCrossModal() {
    document.getElementById('crossFeatureModal').classList.add('hidden');
    crossFeatureModel = null;
}

function updateCrossPreview() {
    const checkedInputs = Array.from(document.querySelectorAll('.cross-feature-checkbox:checked'));
    const checkedDisplayNames = checkedInputs.map(cb => cb.dataset.displayName || cb.value);

    if (checkedDisplayNames.length >= 2) {
        document.getElementById('crossPreviewText').textContent = checkedDisplayNames.join('  ');
        document.getElementById('crossPreview').classList.remove('hidden');
    } else {
        document.getElementById('crossPreview').classList.add('hidden');
    }

    // Check for numeric/temporal features that need bucketization
    const numericTemporalFeatures = checkedInputs.filter(cb => {
        const dataType = cb.dataset.type;
        return dataType === 'numeric' || dataType === 'temporal';
    });

    const bucketOptionsContainer = document.getElementById('crossBucketOptions');
    const bucketInputsContainer = document.getElementById('crossBucketInputs');

    if (numericTemporalFeatures.length > 0) {
        bucketInputsContainer.innerHTML = '';

        numericTemporalFeatures.forEach(cb => {
            const column = cb.value;
            const displayName = cb.dataset.displayName || column;
            const dataType = cb.dataset.type;
            const typeLabel = dataType === 'numeric' ? 'Numeric' : 'Temporal';
            const typeColor = dataType === 'numeric' ? 'blue' : 'purple';

            const div = document.createElement('div');
            div.className = 'flex items-center gap-3 p-3 bg-gray-50 rounded-lg border';
            div.innerHTML = `
                <div class="flex-1">
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-medium">${displayName}</span>
                        <span class="text-xs bg-${typeColor}-100 text-${typeColor}-700 px-1 rounded">${typeLabel}</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">Buckets for crossing (coarse granularity recommended)</div>
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-xs text-gray-600">Buckets:</label>
                    <select class="cross-bucket-select form-select text-sm" data-column="${column}" style="width: 80px;">
                        <option value="5">5</option>
                        <option value="10" selected>10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
            `;
            bucketInputsContainer.appendChild(div);
        });

        bucketOptionsContainer.classList.remove('hidden');
    } else {
        bucketOptionsContainer.classList.add('hidden');
        bucketInputsContainer.innerHTML = '';
    }
}

function addCrossFeature() {
    const checkedInputs = Array.from(document.querySelectorAll('.cross-feature-checkbox:checked'));

    if (checkedInputs.length < 2) {
        showError('Please select at least 2 features');
        return;
    }
    if (checkedInputs.length > 3) {
        showError('Please select at most 3 features');
        return;
    }

    // Build features array with type and bucket info
    const features = checkedInputs.map(cb => {
        const column = cb.value;
        const displayName = cb.dataset.displayName || column;
        const dataType = cb.dataset.type;

        const featureConfig = {
            column: column,
            display_name: displayName,  // Preserve alias for UI display
            type: dataType
        };

        // Add crossing_buckets for numeric/temporal features
        if (dataType === 'numeric' || dataType === 'temporal') {
            const bucketSelect = document.querySelector(`.cross-bucket-select[data-column="${column}"]`);
            if (bucketSelect) {
                featureConfig.crossing_buckets = parseInt(bucketSelect.value);
            }
        }

        return featureConfig;
    });

    const cross = {
        features: features,
        hash_bucket_size: parseInt(document.getElementById('crossHashBuckets').value),
        embedding_dim: parseInt(document.getElementById('crossEmbedDim').value)
    };

    if (crossFeatureModel === 'buyer') {
        configState.buyerCrosses.push(cross);
    } else {
        configState.productCrosses.push(cross);
    }

    closeCrossModal();
    renderStep2();
}

// =============================================================================
// SAVE CONFIG
// =============================================================================

function saveConfig() {
    // Validate: require primary ID features
    if (!configState.customerIdFeature) {
        showError('Customer ID is required. Please drag a column to the Customer ID zone.');
        return;
    }
    if (!configState.productIdFeature) {
        showError('Product ID is required. Please drag a column to the Product ID zone.');
        return;
    }

    // Build feature arrays with primary IDs at the front
    const buyerFeatures = [configState.customerIdFeature, ...configState.buyerFeatures];
    const productFeatures = [configState.productIdFeature, ...configState.productFeatures];

    const payload = {
        name: configState.name,
        description: configState.description,
        dataset_id: configState.datasetId,
        buyer_model_features: buyerFeatures,
        product_model_features: productFeatures,
        buyer_model_crosses: configState.buyerCrosses,
        product_model_crosses: configState.productCrosses,
        target_column: configState.targetColumn  // For ranking models
    };

    const url = editingConfigId
        ? `/api/feature-configs/${editingConfigId}/update/`
        : `/api/models/${modelId}/feature-configs/create/`;
    const method = editingConfigId ? 'PUT' : 'POST';

    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            fc_closeWizard();
            loadConfigs();
            showSuccess(editingConfigId ? 'Feature config updated' : 'Feature config created');
        } else {
            showError(data.error || data.errors?.name || 'Failed to save');
        }
    })
    .catch(err => {
        console.error('Error saving:', err);
        showError('Failed to save feature config');
    });
}

// =============================================================================
// CONFIG ACTIONS
// =============================================================================

function viewConfig(configId) {
    fetch(`/api/feature-configs/${configId}/`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                renderViewModal(data.data);
                document.getElementById('viewConfigModal').classList.remove('hidden');
            }
        });
}

function renderViewModal(config) {
    document.getElementById('viewConfigTitle').textContent = config.name;

    // Calculate tensor breakdowns for detailed view
    const buyerResult = calculateTensorBreakdown(
        config.buyer_model_features || [],
        config.buyer_model_crosses || []
    );
    const productResult = calculateTensorBreakdown(
        config.product_model_features || [],
        config.product_model_crosses || []
    );

    // Build dataset info section
    const datasetInfoHtml = buildDatasetInfoHtml(config.dataset_info, config.dataset_name);

    // Build target column section (for ranking configs)
    let targetColumnHtml = '';
    if (config.target_column && config.config_type === 'ranking') {
        const tc = config.target_column;
        const tcName = tc.display_name || tc.column || '-';
        const tcType = tc.bq_type || 'FLOAT';
        const transforms = tc.transforms || {};

        // Build transforms tags
        let transformsHtml = '';
        if (transforms.normalize && transforms.normalize.enabled) {
            transformsHtml += '<span class="target-transform-tag"><i class="fas fa-compress-arrows-alt"></i> Normalize 0-1</span>';
        }
        if (transforms.log_transform && transforms.log_transform.enabled) {
            transformsHtml += '<span class="target-transform-tag"><i class="fas fa-chart-line"></i> Log transform</span>';
        }
        if (transforms.clip_outliers && transforms.clip_outliers.enabled) {
            const lower = transforms.clip_outliers.lower?.enabled ? transforms.clip_outliers.lower.percentile : null;
            const upper = transforms.clip_outliers.upper?.enabled ? transforms.clip_outliers.upper.percentile : null;
            let clipText = 'Clip';
            if (lower && upper) {
                clipText = `Clip ${lower}%-${upper}%`;
            } else if (lower) {
                clipText = `Clip lower ${lower}%`;
            } else if (upper) {
                clipText = `Clip upper ${upper}%`;
            }
            transformsHtml += `<span class="target-transform-tag"><i class="fas fa-cut"></i> ${clipText}</span>`;
        }

        targetColumnHtml = `
            <div class="target-column-view-card">
                <div class="target-column-view-header">
                    <i class="fas fa-bullseye"></i>
                    <span>Target Column</span>
                    <span class="target-column-view-badge">For Ranking</span>
                </div>
                <div class="target-column-view-content">
                    <span class="target-column-view-name">${tcName}</span>
                    <span class="target-column-view-type">${tcType}</span>
                </div>
                ${transformsHtml ? `<div class="target-column-view-transforms">${transformsHtml}</div>` : ''}
            </div>
        `;
    }

    const body = document.getElementById('viewConfigBody');
    body.innerHTML = `
        <div class="mb-3">
            <div class="text-sm text-gray-500">Dataset: <span class="font-medium text-gray-700">${config.dataset_name}</span></div>
        </div>

        ${datasetInfoHtml}

        ${targetColumnHtml}

        <div class="grid grid-cols-2 gap-4">
            <div class="p-4 bg-blue-50 rounded-lg">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="font-semibold text-blue-800">Buyer Tensor</h4>
                    <span class="font-semibold text-blue-600">${buyerResult.total}D</span>
                </div>
                <div id="viewModal-buyer-bar" class="tensor-breakdown-bar mb-3"></div>
                <div class="space-y-1">
                    ${buyerResult.breakdown.map(item => `
                        <div class="flex items-center justify-between text-sm">
                            <span class="${item.is_cross ? 'text-blue-600 italic' : 'text-blue-700'}">${item.name}</span>
                            <span class="text-blue-500 font-medium">${item.dim}D</span>
                        </div>
                    `).join('')}
                </div>
            </div>
            <div class="p-4 bg-green-50 rounded-lg">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="font-semibold text-green-800">Product Tensor</h4>
                    <span class="font-semibold text-green-600">${productResult.total}D</span>
                </div>
                <div id="viewModal-product-bar" class="tensor-breakdown-bar mb-3"></div>
                <div class="space-y-1">
                    ${productResult.breakdown.map(item => `
                        <div class="flex items-center justify-between text-sm">
                            <span class="${item.is_cross ? 'text-green-600 italic' : 'text-green-700'}">${item.name}</span>
                            <span class="text-green-500 font-medium">${item.dim}D</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;

    // Render tensor bars in view modal with proportional widths
    const maxTotal = Math.max(buyerResult.total || 0, productResult.total || 0);

    setTimeout(() => {
        const buyerBar = document.getElementById('viewModal-buyer-bar');
        const productBar = document.getElementById('viewModal-product-bar');
        if (buyerBar && buyerResult.breakdown.length > 0) {
            renderTensorPreview('buyer', buyerResult.total, buyerResult.breakdown, buyerBar, null, maxTotal);
        }
        if (productBar && productResult.breakdown.length > 0) {
            renderTensorPreview('product', productResult.total, productResult.breakdown, productBar, null, maxTotal);
        }
    }, 0);
}

/**
 * Build HTML for dataset information section in View modal.
 * @param {Object} info - Dataset info from API (dataset_info field)
 * @param {string} datasetName - Name of the dataset
 * @returns {string} HTML string for dataset info section
 */
function buildDatasetInfoHtml(info, datasetName) {
    if (!info || !info.primary_table) {
        return ''; // No dataset info available
    }

    // Build tables line
    const tables = [info.primary_table + ' (primary)'];
    (info.secondary_tables || []).forEach(t => {
        if (t) tables.push(t);
    });
    const tablesLine = tables.join(' &bull; ');

    // Build joins lines
    const joins = info.joins || [];
    const joinsHtml = joins.length > 0
        ? joins.map(j => `<div class="text-gray-700">${j}</div>`).join('')
        : '<span class="text-gray-400 italic">No joins</span>';

    // Build filters badges
    const filterBadges = [];
    if (info.filters?.dates) filterBadges.push(info.filters.dates);
    if (info.filters?.customers) filterBadges.push(info.filters.customers);
    if (info.filters?.products) filterBadges.push(info.filters.products);
    const filtersLine = filterBadges.length > 0
        ? filterBadges.join(' &bull; ')
        : '<span class="text-gray-400 italic">No filters</span>';

    // Row count badge
    const rowsBadge = info.estimated_rows
        ? `${info.estimated_rows.toLocaleString()} rows`
        : '';

    return `
        <div class="mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <div class="flex items-center justify-between mb-3">
                <h4 class="font-semibold text-gray-700">
                    <i class="fas fa-database mr-2 text-gray-400"></i>Dataset Source
                </h4>
                ${rowsBadge ? `<span class="text-sm font-medium text-gray-500 bg-white px-2 py-1 rounded border border-gray-200">${rowsBadge}</span>` : ''}
            </div>
            <div class="space-y-2 text-sm">
                <div class="flex">
                    <span class="text-gray-500 w-16 flex-shrink-0">Tables:</span>
                    <span class="text-gray-700">${tablesLine}</span>
                </div>
                ${joins.length > 0 ? `
                <div class="flex">
                    <span class="text-gray-500 w-16 flex-shrink-0">Joins:</span>
                    <div class="text-gray-700">${joinsHtml}</div>
                </div>
                ` : ''}
                <div class="flex">
                    <span class="text-gray-500 w-16 flex-shrink-0">Filters:</span>
                    <span class="text-gray-700">${filtersLine}</span>
                </div>
            </div>
        </div>
    `;
}

function closeViewModal() {
    document.getElementById('viewConfigModal').classList.add('hidden');
}

// =============================================================================
// COMPARE FEATURE SETS FUNCTIONS (Accordion-based UI)
// =============================================================================

let fc_compareLeftConfig = null;
let fc_compareRightConfig = null;

// Track which accordion sections are expanded
let fc_compareExpandedSections = {
    basicInfo: false,
    source: false,
    buyer: false,
    product: false
};

function fc_openCompareModal() {
    // Populate dropdowns with all feature sets
    const leftSelect = document.getElementById('compareLeftSelect');
    const rightSelect = document.getElementById('compareRightSelect');

    // Clear existing options except the placeholder
    leftSelect.innerHTML = '<option value="">Select feature set...</option>';
    rightSelect.innerHTML = '<option value="">Select feature set...</option>';

    // Add all configs to both dropdowns
    allConfigs.forEach(config => {
        const optionLeft = document.createElement('option');
        optionLeft.value = config.id;
        optionLeft.textContent = config.name;
        leftSelect.appendChild(optionLeft);

        const optionRight = document.createElement('option');
        optionRight.value = config.id;
        optionRight.textContent = config.name;
        rightSelect.appendChild(optionRight);
    });

    // Reset to placeholder state
    fc_resetCompareColumn('left');
    fc_resetCompareColumn('right');

    // Reset accordion states - collapse all
    fc_compareExpandedSections = {
        basicInfo: false,
        source: false,
        buyer: false,
        product: false
    };
    fc_syncCompareAccordionStates();

    // Reset state
    fc_compareLeftConfig = null;
    fc_compareRightConfig = null;

    // Show modal
    document.getElementById('compareModal').classList.remove('hidden');
}

function fc_closeCompareModal() {
    document.getElementById('compareModal').classList.add('hidden');
    fc_compareLeftConfig = null;
    fc_compareRightConfig = null;
}

// Toggle accordion section
function fc_toggleCompareSection(sectionName) {
    fc_compareExpandedSections[sectionName] = !fc_compareExpandedSections[sectionName];
    fc_syncCompareAccordionStates();
}

// Sync accordion visual states with tracked state
function fc_syncCompareAccordionStates() {
    const sections = ['basicInfo', 'source', 'buyer', 'product'];

    sections.forEach(section => {
        const contentId = `fcCompare${section.charAt(0).toUpperCase() + section.slice(1)}Content`;
        const chevronId = `fcCompare${section.charAt(0).toUpperCase() + section.slice(1)}Chevron`;

        const content = document.getElementById(contentId);
        const chevron = document.getElementById(chevronId);

        if (content && chevron) {
            if (fc_compareExpandedSections[section]) {
                content.classList.remove('hidden');
                chevron.classList.add('expanded');
            } else {
                content.classList.add('hidden');
                chevron.classList.remove('expanded');
            }
        }
    });
}

function fc_resetCompareColumn(side) {
    const prefix = side === 'left' ? 'fcCompareLeft' : 'fcCompareRight';

    // Reset BasicInfo
    document.getElementById(`${prefix}BasicInfo`).innerHTML = `
        <div class="ds-compare-placeholder">Select a feature set</div>
    `;

    // Reset Source
    document.getElementById(`${prefix}Source`).innerHTML = `
        <div class="ds-compare-placeholder">Select a feature set</div>
    `;

    // Reset Buyer
    document.getElementById(`${prefix}Buyer`).innerHTML = `
        <div class="ds-compare-placeholder">Select a feature set</div>
    `;

    // Reset Product
    document.getElementById(`${prefix}Product`).innerHTML = `
        <div class="ds-compare-placeholder">Select a feature set</div>
    `;
}

function fc_onCompareSelectChange(side) {
    const selectId = side === 'left' ? 'compareLeftSelect' : 'compareRightSelect';
    const configId = document.getElementById(selectId).value;

    if (!configId) {
        // Reset this side
        fc_resetCompareColumn(side);
        if (side === 'left') fc_compareLeftConfig = null;
        else fc_compareRightConfig = null;
        fc_updateCompareStatuses();
        return;
    }

    // Show loading state
    const prefix = side === 'left' ? 'fcCompareLeft' : 'fcCompareRight';
    document.getElementById(`${prefix}BasicInfo`).innerHTML = `
        <div class="ds-compare-placeholder">
            <i class="fas fa-spinner fa-spin mr-2"></i>Loading...
        </div>
    `;

    // Fetch config data
    fetch(`/api/feature-configs/${configId}/`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const config = data.data;
                if (side === 'left') fc_compareLeftConfig = config;
                else fc_compareRightConfig = config;
                fc_renderCompareColumn(config, side);
                fc_updateCompareStatuses();
            } else {
                document.getElementById(`${prefix}BasicInfo`).innerHTML = `
                    <div class="ds-compare-placeholder" style="color: #ef4444;">
                        Failed to load
                    </div>
                `;
            }
        })
        .catch(err => {
            console.error('Error loading config for compare:', err);
            document.getElementById(`${prefix}BasicInfo`).innerHTML = `
                <div class="ds-compare-placeholder" style="color: #ef4444;">
                    Error loading
                </div>
            `;
        });
}

// Update status badges in accordion headers
function fc_updateCompareStatuses() {
    const left = fc_compareLeftConfig;
    const right = fc_compareRightConfig;

    // Basic Info status
    const basicInfoStatus = document.getElementById('fcCompareBasicInfoStatus');
    if (left && right) {
        const diffs = [];
        if (left.name !== right.name) diffs.push('name');
        if (left.dataset_name !== right.dataset_name) diffs.push('dataset');
        basicInfoStatus.textContent = diffs.length > 0 ? `${diffs.length} difference${diffs.length > 1 ? 's' : ''}` : '';
    } else {
        basicInfoStatus.textContent = '';
    }

    // Source status
    const sourceStatus = document.getElementById('fcCompareSourceStatus');
    if (left && right) {
        const leftInfo = left.dataset_info || {};
        const rightInfo = right.dataset_info || {};
        if (leftInfo.primary_table !== rightInfo.primary_table ||
            leftInfo.estimated_rows !== rightInfo.estimated_rows) {
            sourceStatus.textContent = 'Different';
        } else {
            sourceStatus.textContent = '';
        }
    } else {
        sourceStatus.textContent = '';
    }

    // Buyer Tensor status
    const buyerStatus = document.getElementById('fcCompareBuyerStatus');
    if (left && right) {
        const leftBuyer = calculateTensorBreakdown(
            left.buyer_model_features || [],
            left.buyer_model_crosses || []
        );
        const rightBuyer = calculateTensorBreakdown(
            right.buyer_model_features || [],
            right.buyer_model_crosses || []
        );
        if (leftBuyer.total !== rightBuyer.total) {
            buyerStatus.textContent = `${leftBuyer.total}D vs ${rightBuyer.total}D`;
        } else {
            buyerStatus.textContent = '';
        }
    } else {
        buyerStatus.textContent = '';
    }

    // Product Tensor status
    const productStatus = document.getElementById('fcCompareProductStatus');
    if (left && right) {
        const leftProduct = calculateTensorBreakdown(
            left.product_model_features || [],
            left.product_model_crosses || []
        );
        const rightProduct = calculateTensorBreakdown(
            right.product_model_features || [],
            right.product_model_crosses || []
        );
        if (leftProduct.total !== rightProduct.total) {
            productStatus.textContent = `${leftProduct.total}D vs ${rightProduct.total}D`;
        } else {
            productStatus.textContent = '';
        }
    } else {
        productStatus.textContent = '';
    }
}

function fc_renderCompareColumn(config, side) {
    const prefix = side === 'left' ? 'fcCompareLeft' : 'fcCompareRight';

    // Calculate tensor breakdowns
    const buyerResult = calculateTensorBreakdown(
        config.buyer_model_features || [],
        config.buyer_model_crosses || []
    );
    const productResult = calculateTensorBreakdown(
        config.product_model_features || [],
        config.product_model_crosses || []
    );

    // Build dataset info
    const datasetInfo = config.dataset_info || {};

    // Render BasicInfo
    document.getElementById(`${prefix}BasicInfo`).innerHTML = `
        <h4 class="font-semibold text-gray-900 mb-1">${escapeHtml(config.name)}</h4>
        <div class="text-sm text-gray-500">Dataset: ${escapeHtml(config.dataset_name)}</div>
    `;

    // Render Source
    document.getElementById(`${prefix}Source`).innerHTML = fc_buildCompareSourceHtml(datasetInfo);

    // Render Buyer Tensor (keeping the colored bars)
    document.getElementById(`${prefix}Buyer`).innerHTML = `
        <div class="flex items-center justify-between mb-2">
            <h5 class="font-semibold text-blue-800 text-sm">Buyer Tensor</h5>
            <span class="font-semibold text-blue-600 text-sm">${buyerResult.total}D</span>
        </div>
        <div id="fc-compare-${side}-buyer-bar" class="tensor-breakdown-bar mb-3"></div>
        <div class="space-y-1">
            ${buyerResult.breakdown.map(item => `
                <div class="flex items-center justify-between text-xs">
                    <span class="${item.is_cross ? 'text-blue-600 italic' : 'text-blue-700'}">${item.name}</span>
                    <span class="text-blue-500 font-medium">${item.dim}D</span>
                </div>
            `).join('')}
        </div>
    `;

    // Render Product Tensor (keeping the colored bars)
    document.getElementById(`${prefix}Product`).innerHTML = `
        <div class="flex items-center justify-between mb-2">
            <h5 class="font-semibold text-green-800 text-sm">Product Tensor</h5>
            <span class="font-semibold text-green-600 text-sm">${productResult.total}D</span>
        </div>
        <div id="fc-compare-${side}-product-bar" class="tensor-breakdown-bar mb-3"></div>
        <div class="space-y-1">
            ${productResult.breakdown.map(item => `
                <div class="flex items-center justify-between text-xs">
                    <span class="${item.is_cross ? 'text-green-600 italic' : 'text-green-700'}">${item.name}</span>
                    <span class="text-green-500 font-medium">${item.dim}D</span>
                </div>
            `).join('')}
        </div>
    `;

    // Render tensor bars with proportional widths
    const maxTotal = Math.max(buyerResult.total || 0, productResult.total || 0);

    setTimeout(() => {
        const buyerBar = document.getElementById(`fc-compare-${side}-buyer-bar`);
        const productBar = document.getElementById(`fc-compare-${side}-product-bar`);
        if (buyerBar && buyerResult.breakdown.length > 0) {
            renderTensorPreview('buyer', buyerResult.total, buyerResult.breakdown, buyerBar, null, maxTotal);
        }
        if (productBar && productResult.breakdown.length > 0) {
            renderTensorPreview('product', productResult.total, productResult.breakdown, productBar, null, maxTotal);
        }
    }, 0);
}

/**
 * Build compact source info HTML for Feature Compare modal
 */
function fc_buildCompareSourceHtml(info) {
    if (!info || !info.primary_table) {
        return '<div class="text-sm text-gray-400 italic">No dataset info</div>';
    }

    // Build tables line
    const tables = [info.primary_table];
    (info.secondary_tables || []).forEach(t => {
        if (t) tables.push(t);
    });
    const tablesLine = tables.join(', ');

    // Build filters
    const filterBadges = [];
    if (info.filters?.dates) filterBadges.push(info.filters.dates);
    if (info.filters?.customers) filterBadges.push(info.filters.customers);
    if (info.filters?.products) filterBadges.push(info.filters.products);
    const filtersLine = filterBadges.length > 0
        ? filterBadges.join(' &bull; ')
        : '<span class="text-gray-400 italic">None</span>';

    // Row count
    const rowsBadge = info.estimated_rows
        ? `${info.estimated_rows.toLocaleString()} rows`
        : '';

    return `
        <div class="space-y-2">
            ${rowsBadge ? `<div class="text-sm font-medium text-gray-700">${rowsBadge}</div>` : ''}
            <div class="space-y-1 text-xs">
                <div><span class="text-gray-500">Tables:</span> <span class="text-gray-700">${tablesLine}</span></div>
                <div><span class="text-gray-500">Filters:</span> <span class="text-gray-700">${filtersLine}</span></div>
            </div>
        </div>
    `;
}

// =============================================================================
// CODE VIEWER FUNCTIONS
// =============================================================================

let currentCodeViewerConfigId = null;
let currentCodeData = { transform: '', trainer: '' };

// Transform Code Viewer
function viewTransformCode(configId, configName) {
    currentCodeViewerConfigId = configId;
    document.getElementById('transformCodeConfigName').textContent = configName;

    // Clear previous content
    document.getElementById('transformCode').textContent = 'Loading...';
    document.getElementById('transformLineCount').textContent = '-';
    document.getElementById('transformCodeGeneratedAt').textContent = 'Loading...';

    // Reset validation badge
    updateValidationBadge('transform', 'checking');

    // Show modal
    document.getElementById('transformCodeViewerModal').classList.remove('hidden');

    // Fetch transform code
    fetch(`/api/feature-configs/${configId}/generated-code/?type=transform`)
        .then(r => r.json())
        .then(data => {
            if (data.success && data.data.code) {
                currentCodeData.transform = data.data.code;
                const highlighted = highlightPython(data.data.code);
                document.getElementById('transformCode').innerHTML = highlighted;
                const lineCount = data.data.code.split('\n').length;
                document.getElementById('transformLineCount').textContent = `${lineCount} lines`;
                updateValidationBadge('transform', data.data.is_valid ? 'valid' : 'invalid',
                                      data.data.validation_error, data.data.error_line);
            } else {
                currentCodeData.transform = '';
                document.getElementById('transformCode').innerHTML = '<span class="comment"># No transform code generated yet</span>';
                document.getElementById('transformLineCount').textContent = '0';
                updateValidationBadge('transform', 'valid');
            }

            if (data.data?.generated_at) {
                document.getElementById('transformCodeGeneratedAt').textContent = `Generated ${formatTimeAgo(data.data.generated_at)}`;
            } else {
                document.getElementById('transformCodeGeneratedAt').textContent = 'Not generated';
            }
        })
        .catch(err => {
            console.error('Error fetching transform code:', err);
            document.getElementById('transformCode').innerHTML = '<span class="comment"># Error loading code</span>';
            updateValidationBadge('transform', 'invalid', 'Failed to load code');
        });
}

function closeTransformCodeViewer() {
    document.getElementById('transformCodeViewerModal').classList.add('hidden');
}

function regenerateTransformCode() {
    if (!currentCodeViewerConfigId) return;

    const configName = document.getElementById('transformCodeConfigName').textContent;

    // Show loading state
    document.getElementById('transformCode').textContent = 'Regenerating...';
    updateValidationBadge('transform', 'checking');

    fetch(`/api/feature-configs/${currentCodeViewerConfigId}/regenerate-code/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ type: 'transform' })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            viewTransformCode(currentCodeViewerConfigId, configName);
            showSuccess('Transform code regenerated');
        } else {
            showError(data.error || 'Failed to regenerate code');
        }
    })
    .catch(err => {
        console.error('Error regenerating code:', err);
        showError('Failed to regenerate code');
    });
}

// Trainer Code Viewer
function viewTrainerCode(configId, configName) {
    currentCodeViewerConfigId = configId;
    document.getElementById('trainerCodeConfigName').textContent = configName;

    // Clear previous content
    document.getElementById('trainerCode').textContent = 'Loading...';
    document.getElementById('trainerLineCount').textContent = '-';
    document.getElementById('trainerCodeGeneratedAt').textContent = 'Loading...';

    // Reset validation badge
    updateValidationBadge('trainer', 'checking');

    // Show modal
    document.getElementById('trainerCodeViewerModal').classList.remove('hidden');

    // Fetch trainer code
    fetch(`/api/feature-configs/${configId}/generated-code/?type=trainer`)
        .then(r => r.json())
        .then(data => {
            if (data.success && data.data.code) {
                currentCodeData.trainer = data.data.code;
                const highlighted = highlightPython(data.data.code);
                document.getElementById('trainerCode').innerHTML = highlighted;
                const lineCount = data.data.code.split('\n').length;
                document.getElementById('trainerLineCount').textContent = `${lineCount} lines`;
                updateValidationBadge('trainer', data.data.is_valid ? 'valid' : 'invalid',
                                      data.data.validation_error, data.data.error_line);
            } else {
                currentCodeData.trainer = '';
                document.getElementById('trainerCode').innerHTML = '<span class="comment"># No trainer code generated yet</span>';
                document.getElementById('trainerLineCount').textContent = '0';
                updateValidationBadge('trainer', 'valid');
            }

            if (data.data?.generated_at) {
                document.getElementById('trainerCodeGeneratedAt').textContent = `Generated ${formatTimeAgo(data.data.generated_at)}`;
            } else {
                document.getElementById('trainerCodeGeneratedAt').textContent = 'Not generated';
            }
        })
        .catch(err => {
            console.error('Error fetching trainer code:', err);
            document.getElementById('trainerCode').innerHTML = '<span class="comment"># Error loading code</span>';
            updateValidationBadge('trainer', 'invalid', 'Failed to load code');
        });
}

function closeTrainerCodeViewer() {
    document.getElementById('trainerCodeViewerModal').classList.add('hidden');
}

function regenerateTrainerCode() {
    if (!currentCodeViewerConfigId) return;

    const configName = document.getElementById('trainerCodeConfigName').textContent;

    // Show loading state
    document.getElementById('trainerCode').textContent = 'Regenerating...';
    updateValidationBadge('trainer', 'checking');

    fetch(`/api/feature-configs/${currentCodeViewerConfigId}/regenerate-code/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ type: 'trainer' })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            viewTrainerCode(currentCodeViewerConfigId, configName);
            showSuccess('Trainer code regenerated');
        } else {
            showError(data.error || 'Failed to regenerate code');
        }
    })
    .catch(err => {
        console.error('Error regenerating code:', err);
        showError('Failed to regenerate code');
    });
}

// Trainer Code Selector (for Model Structure chapter)
function openTrainerCodeSelector() {
    // If no configs exist, show message
    if (!allConfigs || allConfigs.length === 0) {
        showError('No feature configs available. Create a feature config first.');
        return;
    }

    // If only one config, open it directly
    if (allConfigs.length === 1) {
        viewTrainerCode(allConfigs[0].id, allConfigs[0].name);
        return;
    }

    // Multiple configs - show selection dropdown
    const configOptions = allConfigs.map(c => `${c.name}`).join('\n');
    const selectedName = prompt(`Select a Feature Config to view Trainer code:\n\n${allConfigs.map((c, i) => `${i + 1}. ${c.name}`).join('\n')}\n\nEnter number:`);

    if (selectedName) {
        const index = parseInt(selectedName) - 1;
        if (index >= 0 && index < allConfigs.length) {
            viewTrainerCode(allConfigs[index].id, allConfigs[index].name);
        } else {
            showError('Invalid selection');
        }
    }
}

function updateValidationBadge(codeType, status, errorMsg = null, errorLine = null) {
    const badge = document.getElementById(`${codeType}ValidationBadge`);
    const errorBanner = document.getElementById(`${codeType}ValidationError`);
    const errorMsgEl = document.getElementById(`${codeType}ErrorMsg`);
    const errorLineEl = document.getElementById(`${codeType}ErrorLine`);

    // Update badge
    badge.classList.remove('valid', 'invalid', 'checking');
    badge.classList.add(status);

    if (status === 'valid') {
        badge.innerHTML = '<i class="fas fa-check-circle"></i> Valid';
        errorBanner.style.display = 'none';
    } else if (status === 'invalid') {
        badge.innerHTML = '<i class="fas fa-exclamation-circle"></i> Error';
        if (errorMsg) {
            errorMsgEl.textContent = errorMsg;
            errorLineEl.textContent = errorLine ? ` (line ${errorLine})` : '';
            errorBanner.style.display = 'flex';
        } else {
            errorBanner.style.display = 'none';
        }
    } else if (status === 'checking') {
        badge.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking';
        errorBanner.style.display = 'none';
    }
}

function highlightPython(code) {
    // Tokenization-based syntax highlighting to avoid regex conflicts
    // First, find all tokens and their positions, then build result

    const tokens = [];

    // Define token patterns (order matters for priority)
    const patterns = [
        // Triple-quoted strings (must come before single-line strings)
        { regex: /"""[\s\S]*?"""|'''[\s\S]*?'''/g, type: 'string' },
        // Comments
        { regex: /#[^\n]*/g, type: 'comment' },
        // Single and double quoted strings
        { regex: /'(?:[^'\\]|\\.)*'|"(?:[^"\\]|\\.)*"/g, type: 'string' },
        // Decorators
        { regex: /@\w+/g, type: 'decorator' },
        // Keywords (word boundaries)
        { regex: /\b(?:def|class|import|from|return|if|else|elif|for|while|try|except|finally|with|as|in|not|and|or|is|None|True|False|lambda|yield|raise|pass|break|continue|global|nonlocal|assert)\b/g, type: 'keyword' },
        // Builtins
        { regex: /\b(?:self|print|len|range|str|int|float|list|dict|tuple|set|type|isinstance|hasattr|getattr|setattr|super|property|staticmethod|classmethod|tf|tft|tfrs|logging|math)\b/g, type: 'builtin' },
        // Function calls and definitions
        { regex: /\b([a-zA-Z_]\w*)\s*(?=\()/g, type: 'function' },
        // Numbers
        { regex: /\b\d+\.?\d*\b/g, type: 'number' },
    ];

    // Find all tokens
    patterns.forEach(p => {
        let match;
        const regex = new RegExp(p.regex.source, 'g');
        while ((match = regex.exec(code)) !== null) {
            tokens.push({
                start: match.index,
                end: match.index + match[0].length,
                text: match[0],
                type: p.type
            });
        }
    });

    // Sort by start position
    tokens.sort((a, b) => a.start - b.start);

    // Remove overlapping tokens (keep first/higher priority)
    const filteredTokens = [];
    let lastEnd = 0;
    for (const token of tokens) {
        if (token.start >= lastEnd) {
            filteredTokens.push(token);
            lastEnd = token.end;
        }
    }

    // Build result
    let result = '';
    let pos = 0;

    for (const token of filteredTokens) {
        // Add unhighlighted text before this token
        if (token.start > pos) {
            result += escapeHtml(code.slice(pos, token.start));
        }
        // Add highlighted token
        result += `<span class="${token.type}">${escapeHtml(token.text)}</span>`;
        pos = token.end;
    }

    // Add remaining text
    if (pos < code.length) {
        result += escapeHtml(code.slice(pos));
    }

    return result;
}

function copyCode(type) {
    const code = currentCodeData[type];
    if (!code) {
        showError('No code to copy');
        return;
    }

    navigator.clipboard.writeText(code).then(() => {
        const btn = document.getElementById(type === 'transform' ? 'copyTransformBtn' : 'copyTrainerBtn');
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
        btn.classList.add('copied');

        setTimeout(() => {
            btn.innerHTML = originalHtml;
            btn.classList.remove('copied');
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy:', err);
        showError('Failed to copy code');
    });
}

function downloadCode(type) {
    const code = currentCodeData[type];
    if (!code) {
        showError('No code to download');
        return;
    }

    const filename = type === 'transform' ? 'preprocessing_fn.py' : 'trainer_module.py';
    const blob = new Blob([code], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function editConfig(configId) {
    fc_openWizard(configId);
}

// Clone modal state
let cloneConfigId = null;

function cloneConfig(configId) {
    const config = allConfigs.find(c => c.id === configId);
    cloneConfigId = configId;

    // Pre-fill with suggested name
    const input = document.getElementById('cloneConfigName');
    input.value = `${config.name} (Copy)`;

    // Show modal
    document.getElementById('cloneConfigModal').classList.remove('hidden');

    // Focus input and select text
    setTimeout(() => {
        input.focus();
        input.select();
    }, 100);
}

function closeCloneModal() {
    document.getElementById('cloneConfigModal').classList.add('hidden');
    cloneConfigId = null;
}

function submitClone() {
    const newName = document.getElementById('cloneConfigName').value.trim();

    if (!newName) {
        showError('Please enter a name for the cloned config');
        return;
    }

    if (!cloneConfigId) {
        showError('No config selected for cloning');
        return;
    }

    fetch(`/api/feature-configs/${cloneConfigId}/clone/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({name: newName})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            closeCloneModal();
            loadConfigs();
            showSuccess('Config cloned successfully');
        } else {
            showError(data.error || 'Failed to clone');
        }
    });
}

function deleteConfig(configId, configName) {
    if (confirm(`Are you sure you want to delete "${configName}"?`)) {
        fetch(`/api/feature-configs/${configId}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrftoken
            }
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                loadConfigs();
                showSuccess('Config deleted');
            } else {
                showError(data.error || 'Failed to delete');
            }
        });
    }
}

// =============================================================================
// UTILITIES
// =============================================================================

function filterConfigs() {
    loadConfigs();
}

function fc_fc_debounceSearch() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        renderConfigs();
    }, 300);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

/**
 * Generate unified model type badge HTML for model configs
 * Uses same style as Features section badges
 */
function generateMcTypeBadge(modelType) {
    switch (modelType) {
        case 'retrieval':
            return `<span class="model-type-badge model-type-retrieval" title="Retrieval model">
                       <i class="fas fa-search"></i> Retrieval
                   </span>`;
        case 'ranking':
            return `<span class="model-type-badge model-type-ranking" title="Ranking model">
                       <i class="fas fa-sort-amount-down"></i> Ranking
                   </span>`;
        case 'multitask':
            return `<span class="model-type-badge model-type-hybrid" title="Hybrid model (Retrieval + Ranking)">
                       <i class="fas fa-layer-group"></i> Retrieval / Ranking
                   </span>`;
        default:
            return `<span class="model-type-badge model-type-retrieval" title="Retrieval model">
                       <i class="fas fa-search"></i> Retrieval
                   </span>`;
    }
}

function formatTimeAgo(isoString) {
    if (!isoString) return 'Unknown';
    const date = new Date(isoString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'just now';
    if (diffMins < 60) return `${diffMins} min ago`;
    if (diffHours < 24) return `${diffHours} hours ago`;
    if (diffDays < 7) return `${diffDays} days ago`;
    return date.toLocaleDateString();
}

function showError(message) {
    alert('Error: ' + message);
}

function showSuccess(message) {
    // Could use a toast notification here
    console.log('Success:', message);
}

// =============================================================================
// MODEL CONFIG FUNCTIONALITY
// =============================================================================

let allModelConfigs = [];
let mcCurrentStep = 1;
let editingModelConfigId = null;
let viewingModelConfig = null;
let presetsData = {};
let mcSearchTimeout = null;
let mcNameCheckTimeout = null;
let mcNameIsValid = false;

// Model Config State
let mcState = {
    modelType: 'retrieval',
    name: '',
    description: '',
    selectedPreset: 'standard',
    buyerTowerLayers: [],
    productTowerLayers: [],
    // Retrieval Algorithm Settings (for retrieval models)
    retrievalAlgorithm: 'brute_force',
    topK: 100,
    scannNumLeaves: 100,
    scannLeavesToSearch: 10,
    // Rating Head Settings (for ranking models)
    ratingHeadLayers: [],
    ratingHeadPreset: 'standard',
    lossFunction: 'mse',
    // Multitask Settings (for multitask models)
    retrievalWeight: 1.0,
    rankingWeight: 1.0,
    // Common settings
    outputEmbeddingDim: 32,
    optimizer: 'adagrad',
    learningRate: 0.1,
    batchSize: 4096
};

// Load Model Configs
function loadModelConfigs() {
    document.getElementById('modelConfigsLoading').classList.remove('hidden');
    document.getElementById('modelConfigsEmpty').classList.add('hidden');
    document.getElementById('modelConfigsNoResults').classList.add('hidden');
    document.getElementById('modelConfigsGrid').classList.add('hidden');
    document.getElementById('mcFilterBar').classList.add('hidden');

    fetch('/api/model-configs/?include_details=true')
        .then(r => r.json())
        .then(data => {
            document.getElementById('modelConfigsLoading').classList.add('hidden');
            if (data.success) {
                allModelConfigs = data.data;
                // Cache for QuickTest dropdown
                window.modelConfigsCache = data.data;
                renderModelConfigs();
            } else {
                console.error('Error loading model configs:', data.error);
            }
        })
        .catch(err => {
            document.getElementById('modelConfigsLoading').classList.add('hidden');
            console.error('Error loading model configs:', err);
        });
}

// Filter Model Configs
function filterModelConfigs() {
    renderModelConfigs();
}

// Debounced search for Model Configs
function debounceMcSearch() {
    clearTimeout(mcSearchTimeout);
    mcSearchTimeout = setTimeout(() => {
        filterModelConfigs();
    }, 300);
}

// Get filtered model configs based on current filter settings
function getFilteredModelConfigs() {
    const typeFilter = document.getElementById('mcModelTypeFilter').value;
    const searchTerm = document.getElementById('mcSearchInput').value.toLowerCase().trim();

    let filtered = allModelConfigs;

    // Apply model type filter
    if (typeFilter) {
        filtered = filtered.filter(mc => mc.model_type === typeFilter);
    }

    // Apply search filter
    if (searchTerm) {
        filtered = filtered.filter(mc =>
            mc.name.toLowerCase().includes(searchTerm) ||
            (mc.description && mc.description.toLowerCase().includes(searchTerm))
        );
    }

    return filtered;
}

// Parse tower summary string (e.g., "1286432") into layer array
function parseTowerSummary(summary) {
    if (!summary || summary === 'Empty') return [];

    // Split by arrow characters ( or ->)
    const units = summary.split(/|->/).map(s => parseInt(s.trim())).filter(n => !isNaN(n));

    // Convert to layer objects
    return units.map(u => ({
        type: 'dense',
        units: u,
        activation: 'relu'
    }));
}

// Render aligned tower layers for model config card (wizard-like style matching Step 2)
// Placeholders are inserted before the output layer to keep output layers aligned at bottom
function renderCardTowerLayers(buyerLayers, productLayers) {
    const maxLen = Math.max(buyerLayers.length, productLayers.length);
    if (maxLen === 0) {
        return {
            buyer: '<div class="text-xs text-gray-400 italic p-2">No layers</div>',
            product: '<div class="text-xs text-gray-400 italic p-2">No layers</div>'
        };
    }

    const renderLayer = (layer, isOutput) => {
        let badge = '';
        let params = '';

        if (layer.type === 'dense') {
            badge = '<span class="card-layer-badge dense">Dense</span>';
            params = `${layer.units} units`;
            if (layer.activation) params += `, ${layer.activation}`;
            if (layer.l2_regularization) params += `, L2=${layer.l2_regularization}`;
            else if (layer.l2_reg) params += `, L2=${layer.l2_reg}`;
        } else if (layer.type === 'dropout') {
            badge = '<span class="card-layer-badge dropout">Dropout</span>';
            params = `rate: ${layer.rate}`;
        } else if (layer.type === 'batch_norm') {
            badge = '<span class="card-layer-badge batch_norm">BatchNorm</span>';
            params = '';
        } else if (layer.type === 'layer_norm') {
            badge = '<span class="card-layer-badge layer_norm">LayerNorm</span>';
            params = layer.epsilon ? `: ${layer.epsilon}` : '';
        }

        // View-only mode: drag handle | badge | params (no action buttons)
        return `
            <div class="card-layer-item${isOutput ? ' output-layer' : ''}">
                <span class="card-drag-handle"><i class="fas fa-grip-vertical"></i></span>
                ${badge}
                <span class="card-layer-params">${params}</span>
            </div>
        `;
    };

    const renderPlaceholder = () => '<div class="card-layer-item empty-placeholder">&nbsp;</div>';

    // Build tower HTML with placeholders inserted before output layer
    const buildTowerHtml = (layers, placeholderCount) => {
        if (layers.length === 0) return '';

        const result = [];
        // All layers except the last (output layer)
        for (let i = 0; i < layers.length - 1; i++) {
            result.push(renderLayer(layers[i], false));
        }
        // Insert placeholders before output layer
        for (let i = 0; i < placeholderCount; i++) {
            result.push(renderPlaceholder());
        }
        // Output layer (last layer)
        result.push(renderLayer(layers[layers.length - 1], true));

        return result.join('');
    };

    const buyerPlaceholders = maxLen - buyerLayers.length;
    const productPlaceholders = maxLen - productLayers.length;

    return {
        buyer: buildTowerHtml(buyerLayers, buyerPlaceholders),
        product: buildTowerHtml(productLayers, productPlaceholders)
    };
}

// Render Tower Stack (vertical layer visualization) - for View modal
function renderTowerStack(layers, tower) {
    if (!layers || layers.length === 0) {
        return '<div class="text-xs text-gray-400 italic p-2">No layers</div>';
    }

    return layers.map((layer, idx) => {
        let typeClass = layer.type || 'dense';
        let layerLabel = '';
        let params = '';

        if (layer.type === 'dense') {
            layerLabel = 'Dense';
            params = `${layer.units}`;
            if (layer.activation) {
                params += `, ${layer.activation}`;
            }
        } else if (layer.type === 'dropout') {
            layerLabel = 'Dropout';
            params = `${(layer.rate * 100).toFixed(0)}%`;
        } else if (layer.type === 'batch_norm') {
            layerLabel = 'BatchNorm';
            params = '';
        } else if (layer.type === 'layer_norm') {
            layerLabel = 'LayerNorm';
            params = layer.epsilon ? `=${layer.epsilon}` : '';
        } else {
            layerLabel = layer.type;
            params = '';
        }

        const isLast = idx === layers.length - 1;
        return `
            <div class="tower-layer ${isLast ? tower : ''}">
                <span class="layer-type ${typeClass}">${layerLabel}</span>
                <span class="layer-params">${params}</span>
            </div>
        `;
    }).join('');
}

// Get compact tower text representation for card display (e.g., "Dense  Dense  Dense")
function getCompactTowerText(layers) {
    if (!layers || layers.length === 0) {
        return '<span class="text-gray-400 italic">No layers</span>';
    }

    const typeLabels = {
        'dense': 'Dense',
        'dropout': 'Drop',
        'batch_norm': 'BN',
        'layer_norm': 'LN'
    };

    return layers.map(layer => {
        const label = typeLabels[layer.type] || layer.type;
        return `<span class="compact-layer-type ${layer.type}">${label}</span>`;
    }).join('<span class="layer-arrow"></span>');
}

// Calculate parameters for a single tower (for layer bar display)
function calculateSingleTowerParams(layers, inputDim = 100) {
    let params = 0;
    let prevDim = inputDim;
    for (const layer of layers) {
        if (layer.type === 'dense') {
            // Dense layer: input_dim * units + units (bias)
            params += prevDim * layer.units + layer.units;
            prevDim = layer.units;
        } else if (layer.type === 'batch_norm') {
            // BatchNorm: 4 params per feature (gamma, beta, moving_mean, moving_var)
            params += prevDim * 4;
        } else if (layer.type === 'layer_norm') {
            // LayerNorm: 2 params per feature (gamma, beta)
            params += prevDim * 2;
        }
        // Dropout has no parameters
    }
    return params;
}

// Format parameter count for display
function formatParamCount(n) {
    if (n >= 1000000) return `${(n / 1000000).toFixed(1)}M`;
    if (n >= 1000) return `${(n / 1000).toFixed(1)}K`;
    return n.toString();
}

// Render layer bar visualization (tensor-bar style for model layers)
// maxTotalUnits: max total units across both towers (for proportional bar width)
function renderLayerBar(tower, layers, container, maxTotalUnits = null) {
    if (!container) return;
    container.innerHTML = '';

    if (!layers || layers.length === 0) {
        container.innerHTML = '<div class="text-gray-400 text-xs italic p-2">No layers</div>';
        return;
    }

    // Calculate total units from dense layers in this tower
    const towerTotal = layers
        .filter(l => l.type === 'dense')
        .reduce((sum, l) => sum + (l.units || 32), 0);

    // Set container width proportional to this tower's total vs max total
    if (maxTotalUnits && maxTotalUnits > 0) {
        const widthPercent = (towerTotal / maxTotalUnits) * 100;
        container.style.width = `${widthPercent}%`;
    }

    // Color palettes for vanishing gradient effect (matching tensor breakdown bars)
    const buyerColors = ['#3b82f6', '#60a5fa', '#93c5fd', '#bfdbfe', '#dbeafe'];
    const productColors = ['#10b981', '#34d399', '#6ee7b7', '#a7f3d0', '#d1fae5'];
    const rankingColors = ['#8b5cf6', '#a78bfa', '#c4b5fd', '#ddd6fe', '#ede9fe'];
    let colors;
    if (tower === 'buyer') colors = buyerColors;
    else if (tower === 'product') colors = productColors;
    else colors = rankingColors;

    // Find last dense layer index (output layer)
    let lastDenseIdx = -1;
    for (let i = layers.length - 1; i >= 0; i--) {
        if (layers[i].type === 'dense') {
            lastDenseIdx = i;
            break;
        }
    }

    // Track dense layer index for color assignment
    let denseLayerIdx = 0;

    layers.forEach((layer, idx) => {
        const segment = document.createElement('div');
        const isOutput = (layer.type === 'dense' && idx === lastDenseIdx);

        if (layer.type === 'dense') {
            const units = layer.units || 32;
            // Use flex-grow proportional to units within this tower
            const flexGrow = units / towerTotal;
            segment.className = `layer-bar-segment dense ${tower}${isOutput ? ' output-layer' : ''}`;
            segment.style.flex = `${flexGrow} 0 0`;
            segment.style.minWidth = '24px';
            // Apply vanishing gradient color from palette
            segment.style.background = colors[denseLayerIdx % colors.length];
            segment.title = `Dense: ${units} units${layer.activation ? ', ' + layer.activation : ''}${isOutput ? ' (Output)' : ''}`;

            // Always show units
            segment.innerHTML = `<span class="layer-units">${units}</span>`;
            denseLayerIdx++;
        } else if (layer.type === 'dropout') {
            segment.className = 'layer-bar-segment dropout';
            segment.style.flex = '0 0 20px';
            segment.title = `Dropout: rate=${layer.rate || 0.2}`;
            segment.innerHTML = '<span class="layer-label-small">D</span>';
        } else if (layer.type === 'batch_norm') {
            segment.className = 'layer-bar-segment batch_norm';
            segment.style.flex = '0 0 24px';
            segment.title = 'Batch Normalization';
            segment.innerHTML = '<span class="layer-label-small">BN</span>';
        } else if (layer.type === 'layer_norm') {
            segment.className = 'layer-bar-segment layer_norm';
            segment.style.flex = '0 0 24px';
            segment.title = `Layer Normalization${layer.epsilon ? ', =' + layer.epsilon : ''}`;
            segment.innerHTML = '<span class="layer-label-small">LN</span>';
        }

        container.appendChild(segment);
    });
}

// Calculate total dense units for a tower
function calculateTotalDenseUnits(layers) {
    return (layers || [])
        .filter(l => l.type === 'dense')
        .reduce((sum, l) => sum + (l.units || 32), 0);
}

// Calculate max total units across both towers (for proportional bar widths)
function calculateMaxTotalUnits(buyerLayers, productLayers) {
    const buyerTotal = calculateTotalDenseUnits(buyerLayers);
    const productTotal = calculateTotalDenseUnits(productLayers);
    return Math.max(buyerTotal, productTotal);
}

// Generate tower visualization HTML for model config cards
// Now accepts featureSetDim as input dimension for accurate parameter calculation
function generateTowerVisualizationHtml(tower, layers, featureSetDim = 100) {
    const params = calculateSingleTowerParams(layers, featureSetDim);
    const formattedParams = formatParamCount(params);
    const containerId = `tower-bar-${tower}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

    // Determine label based on tower type
    let label = 'BUYER';
    if (tower === 'product') label = 'PRODUCT';
    else if (tower === 'ranking') label = 'RANKING';

    return {
        html: `
            <div class="tower-visualization">
                <div class="tower-visualization-header">
                    <span class="tower-visualization-label ${tower}">${label}</span>
                    <span class="tower-params-badge ${tower}">~${formattedParams} params</span>
                </div>
                <div class="layer-bar-container" id="${containerId}"></div>
            </div>
        `,
        containerId: containerId,
        layers: layers,
        tower: tower,
        featureSetDim: featureSetDim
    };
}

// Calculate model parameter summary
function calculateModelSummary(mc) {
    // Estimate parameters based on layer configurations
    // This is a simplified estimation for display purposes
    let totalParams = 0;
    let trainableParams = 0;

    const estimateTowerParams = (layers, inputDim = 100) => {
        let params = 0;
        let prevDim = inputDim;
        for (const layer of layers) {
            if (layer.type === 'dense') {
                // Dense layer: input_dim * units + units (bias)
                params += prevDim * layer.units + layer.units;
                prevDim = layer.units;
            } else if (layer.type === 'batch_norm') {
                // BatchNorm: 4 params per feature (gamma, beta, moving_mean, moving_var)
                params += prevDim * 4;
            } else if (layer.type === 'layer_norm') {
                // LayerNorm: 2 params per feature (gamma, beta)
                params += prevDim * 2;
            }
            // Dropout has no parameters
        }
        return params;
    };

    // Get layers from the full config if available
    const buyerLayers = mc.buyer_tower_layers || [];
    const productLayers = mc.product_tower_layers || [];

    if (buyerLayers.length > 0 || productLayers.length > 0) {
        totalParams = estimateTowerParams(buyerLayers, 100) + estimateTowerParams(productLayers, 50);
        trainableParams = totalParams;
    } else {
        // Fallback: estimate from summary string (e.g., "1286432")
        const estimateFromSummary = (summary, inputDim = 100) => {
            if (!summary || summary === 'Empty') return 0;
            const units = summary.split('').map(n => parseInt(n)).filter(n => !isNaN(n));
            let params = 0;
            let prevDim = inputDim;
            for (const u of units) {
                params += prevDim * u + u;
                prevDim = u;
            }
            return params;
        };
        totalParams = estimateFromSummary(mc.buyer_tower_summary, 100) +
                      estimateFromSummary(mc.product_tower_summary, 50);
        trainableParams = totalParams;
    }

    // Format the number
    const formatParams = (n) => {
        if (n >= 1000000) return `${(n / 1000000).toFixed(1)}M`;
        if (n >= 1000) return `${(n / 1000).toFixed(1)}K`;
        return n.toString();
    };

    return {
        total: formatParams(totalParams),
        trainable: formatParams(trainableParams),
        nonTrainable: '0'
    };
}

// Format time ago for model configs
function formatMcTimeAgo(isoString) {
    if (!isoString) return '';
    const date = new Date(isoString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'just now';
    if (diffMins < 60) return `${diffMins} min ago`;
    if (diffHours < 24) return `${diffHours} hours ago`;
    if (diffDays === 1) return 'yesterday';
    if (diffDays < 30) return `${diffDays} days ago`;
    return date.toLocaleDateString();
}

// Show toast notification
function showMcToast(message, type = 'info') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 text-white text-sm font-medium transition-opacity duration-300`;
    toast.style.backgroundColor = type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#6b7280';
    toast.textContent = message;
    document.body.appendChild(toast);

    // Remove after 3 seconds
    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Render Model Config Cards
function renderModelConfigs() {
    const grid = document.getElementById('modelConfigsGrid');
    const empty = document.getElementById('modelConfigsEmpty');
    const noResults = document.getElementById('modelConfigsNoResults');
    const filterBar = document.getElementById('mcFilterBar');

    // If no configs at all, show empty state and hide filter bar
    if (allModelConfigs.length === 0) {
        empty.classList.remove('hidden');
        noResults.classList.add('hidden');
        grid.classList.add('hidden');
        filterBar.classList.add('hidden');
        return;
    }

    // Show filter bar when there are configs
    filterBar.classList.remove('hidden');

    // Get filtered results
    const filtered = getFilteredModelConfigs();

    // If no results after filtering, show no results state
    if (filtered.length === 0) {
        empty.classList.add('hidden');
        noResults.classList.remove('hidden');
        grid.classList.add('hidden');
        return;
    }

    empty.classList.add('hidden');
    noResults.classList.add('hidden');
    grid.classList.remove('hidden');

    grid.innerHTML = filtered.map(mc => {
        const summary = calculateModelSummary(mc);
        const descTruncated = mc.description && mc.description.length > 80
            ? mc.description.substring(0, 80) + '...'
            : mc.description;

        // Get layers for layer bar visualization
        const buyerLayers = mc.buyer_tower_layers && mc.buyer_tower_layers.length > 0
            ? mc.buyer_tower_layers
            : parseTowerSummary(mc.buyer_tower_summary);

        const productLayers = mc.product_tower_layers && mc.product_tower_layers.length > 0
            ? mc.product_tower_layers
            : parseTowerSummary(mc.product_tower_summary);

        // Get ranking layers if this is a ranking or multitask model
        const rankingLayers = (mc.model_type === 'ranking' || mc.model_type === 'multitask') && mc.rating_head_layers && mc.rating_head_layers.length > 0
            ? mc.rating_head_layers
            : [];

        // Calculate max total units across all towers for proportional bar widths
        const maxTotalUnits = calculateMaxTotalUnits(buyerLayers, productLayers);
        // For ranking model, also consider ranking layers for max units
        const rankingTotalUnits = rankingLayers.length > 0 ? calculateTotalDenseUnits(rankingLayers) : 0;
        const overallMaxUnits = Math.max(maxTotalUnits, rankingTotalUnits);

        // Use same input dimension (100) for both towers for consistent parameter estimation
        // In reality, input dim depends on feature set, but we use 100 as default estimate
        const inputDim = 100;
        // For ranking head, input is concatenated embeddings (output_embedding_dim * 2)
        const rankingInputDim = (mc.output_embedding_dim || 32) * 2;

        // Generate tower visualization with unique IDs
        const buyerViz = generateTowerVisualizationHtml('buyer', buyerLayers, inputDim);
        const productViz = generateTowerVisualizationHtml('product', productLayers, inputDim);
        const rankingViz = rankingLayers.length > 0
            ? generateTowerVisualizationHtml('ranking', rankingLayers, rankingInputDim)
            : null;

        return `
        <div class="model-config-card" onclick="viewModelConfig(${mc.id})"
             data-buyer-bar-id="${buyerViz.containerId}"
             data-product-bar-id="${productViz.containerId}"
             ${rankingViz ? `data-ranking-bar-id="${rankingViz.containerId}"` : ''}
             data-buyer-layers='${JSON.stringify(buyerLayers)}'
             data-product-layers='${JSON.stringify(productLayers)}'
             ${rankingLayers.length > 0 ? `data-ranking-layers='${JSON.stringify(rankingLayers)}'` : ''}
             data-max-total-units="${overallMaxUnits}">
            <!-- Header: Name & Actions -->
            <div class="model-config-card-header">
                <div style="flex: 1; min-width: 0;">
                    <div class="flex items-center gap-2">
                        <div class="model-config-name">${escapeHtml(mc.name)}</div>
                        ${generateMcTypeBadge(mc.model_type)}
                    </div>
                    ${descTruncated ? `<div class="model-config-desc">${escapeHtml(descTruncated)}</div>` : ''}
                    <div class="model-config-meta">Updated ${formatMcTimeAgo(mc.updated_at)}${mc.created_by ? ` by ${mc.created_by}` : ''}</div>
                </div>
                <div class="flex items-center gap-2" onclick="event.stopPropagation()">
                    <div class="model-config-actions">
                        <button class="mc-action-btn view" onclick="viewModelConfig(${mc.id})" title="View">
                            View
                        </button>
                        <button class="mc-action-btn edit" onclick="editModelConfigById(${mc.id})" title="Edit">
                            <i class="fas fa-external-link-alt"></i>
                        </button>
                        <button class="mc-action-btn delete" onclick="deleteModelConfig(${mc.id})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Row 1: Tower Layer Bar Visualizations (Buyer | Product) -->
            <div class="towers-grid">
                ${buyerViz.html}
                ${productViz.html}
            </div>

            <!-- Row 2: For Ranking/Multitask models - Hyperparams | Ranking bar -->
            ${rankingViz ? `
            <div class="ranking-row-grid">
                <!-- Left: Training Params -->
                <div class="training-params-preview ranking-layout">
                    <div class="param-chip">
                        <span class="param-chip-label">Opt:</span>
                        <span class="param-chip-value">${mc.optimizer_display}</span>
                    </div>
                    <div class="param-chip">
                        <span class="param-chip-label">LR:</span>
                        <span class="param-chip-value">${mc.learning_rate}</span>
                    </div>
                    <div class="param-chip">
                        <span class="param-chip-label">Batch:</span>
                        <span class="param-chip-value">${mc.batch_size}</span>
                    </div>
                    <div class="param-chip">
                        <span class="param-chip-label">Loss:</span>
                        <span class="param-chip-value">${mc.loss_function_display || 'MSE'}</span>
                    </div>
                    ${mc.model_type === 'multitask' ? `
                    <div class="param-chip multitask-weights">
                        <span class="param-chip-label">Weights:</span>
                        <span class="param-chip-value">Ret ${mc.retrieval_weight || 1.0} / Rank ${mc.ranking_weight || 1.0}</span>
                    </div>
                    <div class="param-chip">
                        <span class="param-chip-label">Top N:</span>
                        <span class="param-chip-value">${mc.top_k || 100}</span>
                    </div>
                    ` : ''}
                </div>
                <!-- Right: Ranking bar -->
                <div class="ranking-tower-cell">
                    ${rankingViz.html}
                </div>
            </div>
            ` : `
            <!-- For Retrieval models - just hyperparams row -->
            <div class="training-params-preview">
                <div class="param-chip">
                    <span class="param-chip-label">Opt:</span>
                    <span class="param-chip-value">${mc.optimizer_display}</span>
                </div>
                <div class="param-chip">
                    <span class="param-chip-label">LR:</span>
                    <span class="param-chip-value">${mc.learning_rate}</span>
                </div>
                <div class="param-chip">
                    <span class="param-chip-label">Batch:</span>
                    <span class="param-chip-value">${mc.batch_size}</span>
                </div>
                <div class="param-chip">
                    <span class="param-chip-label">Top N:</span>
                    <span class="param-chip-value">${mc.top_k || 100}</span>
                </div>
                <div class="param-chip">
                    <span class="param-chip-label">Algorithm:</span>
                    <span class="param-chip-value">${mc.retrieval_algorithm_display || 'Brute Force'}</span>
                </div>
            </div>
            `}

            <!-- Footer: Clone button (Code is generated at runtime when combined with FeatureConfig) -->
            <div class="flex items-center gap-2 mt-3 pt-3 border-t border-gray-100" onclick="event.stopPropagation()">
                <button onclick="cloneModelConfigById(${mc.id})" class="btn btn-secondary btn-sm" style="width: 150px;" title="Clone this config">
                    <i class="fas fa-copy"></i>Clone
                </button>
            </div>
        </div>
        `;
    }).join('');

    // Render layer bars after HTML is in DOM
    setTimeout(() => {
        document.querySelectorAll('.model-config-card').forEach(card => {
            const buyerBarId = card.dataset.buyerBarId;
            const productBarId = card.dataset.productBarId;
            const rankingBarId = card.dataset.rankingBarId;
            const buyerLayers = JSON.parse(card.dataset.buyerLayers || '[]');
            const productLayers = JSON.parse(card.dataset.productLayers || '[]');
            const rankingLayers = card.dataset.rankingLayers ? JSON.parse(card.dataset.rankingLayers) : [];
            const maxTotalUnits = parseInt(card.dataset.maxTotalUnits) || 416;

            const buyerContainer = document.getElementById(buyerBarId);
            const productContainer = document.getElementById(productBarId);
            const rankingContainer = rankingBarId ? document.getElementById(rankingBarId) : null;

            if (buyerContainer) {
                renderLayerBar('buyer', buyerLayers, buyerContainer, maxTotalUnits);
            }
            if (productContainer) {
                renderLayerBar('product', productLayers, productContainer, maxTotalUnits);
            }
            if (rankingContainer && rankingLayers.length > 0) {
                // Ranking bar: use same maxTotalUnits for proportional width relative to other bars
                renderLayerBar('ranking', rankingLayers, rankingContainer, maxTotalUnits);
            }
        });
    }, 0);
}

// Edit Model Config by ID (opens wizard in edit mode)
function editModelConfigById(id) {
    // Fetch full config and open wizard
    fetch(`/api/model-configs/${id}/`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const mc = data.data;
                editingModelConfigId = mc.id;
                mcCurrentStep = 1;

                // Populate state from config
                mcState.modelType = mc.model_type;
                mcState.name = mc.name;
                mcState.description = mc.description || '';
                mcState.buyerTowerLayers = mc.buyer_tower_layers || [];
                mcState.productTowerLayers = mc.product_tower_layers || [];
                mcState.outputEmbeddingDim = mc.output_embedding_dim || 32;
                mcState.retrievalAlgorithm = mc.retrieval_algorithm || 'brute_force';
                mcState.topK = mc.top_k || 100;
                mcState.scannNumLeaves = mc.scann_num_leaves || 100;
                mcState.scannLeavesToSearch = mc.scann_leaves_to_search || 10;
                mcState.optimizer = mc.optimizer || 'adagrad';
                mcState.learningRate = mc.learning_rate || 0.1;
                mcState.batchSize = mc.batch_size || 4096;
                // Rating head settings (for ranking/multitask models)
                mcState.ratingHeadLayers = mc.rating_head_layers || [];
                mcState.lossFunction = mc.loss_function || 'mse';
                // Multitask settings
                mcState.retrievalWeight = mc.retrieval_weight !== undefined ? mc.retrieval_weight : 1.0;
                mcState.rankingWeight = mc.ranking_weight !== undefined ? mc.ranking_weight : 1.0;

                // Update wizard UI
                document.getElementById('mcName').value = mc.name;
                document.getElementById('mcDescription').value = mc.description || '';
                selectModelType(mc.model_type);
                selectRetrievalAlgorithm(mcState.retrievalAlgorithm);
                document.getElementById('mcTopK').value = mcState.topK;
                document.getElementById('mcScannTopK').value = mcState.topK;
                document.getElementById('mcScannNumLeaves').value = mcState.scannNumLeaves;
                document.getElementById('mcScannLeavesToSearch').value = mcState.scannLeavesToSearch;
                selectOptimizer(mcState.optimizer);
                setLearningRate(mcState.learningRate);
                document.getElementById('mcBatchSize').value = mcState.batchSize;

                // For ranking/multitask models, also select the loss function
                if (mc.model_type === 'ranking' || mc.model_type === 'multitask') {
                    selectLossFunction(mcState.lossFunction);
                }

                // For multitask models, populate weight sliders
                if (mc.model_type === 'multitask') {
                    const retSlider = document.getElementById('mcRetrievalWeight');
                    const rankSlider = document.getElementById('mcRankingWeight');
                    if (retSlider) {
                        retSlider.value = mcState.retrievalWeight;
                        document.getElementById('retrievalWeightValue').textContent = mcState.retrievalWeight.toFixed(1);
                    }
                    if (rankSlider) {
                        rankSlider.value = mcState.rankingWeight;
                        document.getElementById('rankingWeightValue').textContent = mcState.rankingWeight.toFixed(1);
                    }
                    updateMultitaskSummary();
                    updateMultitaskArchDiagram();
                }

                renderTowerLayers();
                updateTowerSummaries();

                // For ranking/multitask models, render the rating head layers
                if ((mc.model_type === 'ranking' || mc.model_type === 'multitask') && mcState.ratingHeadLayers.length > 0) {
                    renderRatingHeadLayers();
                    updateRatingHeadSummary();
                }

                // Mark name as valid since we're editing an existing config
                mcNameIsValid = true;

                document.getElementById('modelConfigWizardTitle').textContent = 'Edit Model Config';
                document.getElementById('modelConfigWizardModal').classList.remove('hidden');
                updateMcStep();
            }
        })
        .catch(err => console.error('Error loading model config for edit:', err));
}

// Open Model Config Wizard
function openModelConfigWizard() {
    editingModelConfigId = null;
    mcCurrentStep = 1;
    resetMcState();
    loadPresets();
    document.getElementById('modelConfigWizardTitle').textContent = 'Create Model Config';
    document.getElementById('modelConfigWizardModal').classList.remove('hidden');
    updateMcStep();
}

// Close Model Config Wizard
function closeModelConfigWizard() {
    document.getElementById('modelConfigWizardModal').classList.add('hidden');
}

// Reset Model Config State
function resetMcState() {
    mcState = {
        modelType: 'retrieval',
        name: '',
        description: '',
        selectedPreset: 'standard',
        buyerTowerLayers: [],
        productTowerLayers: [],
        outputEmbeddingDim: 32,
        // Retrieval Algorithm Settings
        retrievalAlgorithm: 'brute_force',
        topK: 100,
        scannNumLeaves: 100,
        scannLeavesToSearch: 10,
        // Rating Head Settings (for ranking/multitask models)
        ratingHeadLayers: [],
        ratingHeadPreset: 'standard',
        lossFunction: 'mse',
        // Multitask Settings (balanced start as default)
        retrievalWeight: 1.0,
        rankingWeight: 1.0,
        // Training params
        optimizer: 'adagrad',
        learningRate: 0.1,
        batchSize: 4096
    };
    document.getElementById('mcName').value = '';
    document.getElementById('mcDescription').value = '';
    selectModelType('retrieval');
    selectPreset('standard');
    // Reset retrieval algorithm UI
    selectRetrievalAlgorithm('brute_force');
    document.getElementById('mcTopK').value = 100;
    document.getElementById('mcScannTopK').value = 100;
    document.getElementById('mcScannNumLeaves').value = 100;
    document.getElementById('mcScannLeavesToSearch').value = 10;
    // Reset training params UI
    selectOptimizer('adagrad');
    setLearningRate(0.1);
    document.getElementById('mcBatchSize').value = 4096;
    // Reset multitask weight sliders UI
    const retSlider = document.getElementById('mcRetrievalWeight');
    const rankSlider = document.getElementById('mcRankingWeight');
    if (retSlider) {
        retSlider.value = 1.0;
        document.getElementById('retrievalWeightValue').textContent = '1.0';
    }
    if (rankSlider) {
        rankSlider.value = 1.0;
        document.getElementById('rankingWeightValue').textContent = '1.0';
    }
    // Reset name validation state
    mcNameIsValid = false;
    resetMcNameValidation();
}

// Reset Model Config name validation UI
function resetMcNameValidation() {
    document.getElementById('mcNameStatus').classList.add('hidden');
    document.getElementById('mcNameSpinner').classList.add('hidden');
    document.getElementById('mcNameValid').classList.add('hidden');
    document.getElementById('mcNameInvalid').classList.add('hidden');
    document.getElementById('mcNameError').classList.add('hidden');
    document.getElementById('mcNameError').textContent = '';
    document.getElementById('mcName').classList.remove('border-red-500', 'border-green-500');
}

// Debounced Model Config name check
function debounceMcNameCheck() {
    clearTimeout(mcNameCheckTimeout);
    mcNameCheckTimeout = setTimeout(() => {
        checkMcNameAvailability();
    }, 400);
}

// Check Model Config name availability
function checkMcNameAvailability() {
    const name = document.getElementById('mcName').value.trim();
    const statusEl = document.getElementById('mcNameStatus');
    const spinnerEl = document.getElementById('mcNameSpinner');
    const validEl = document.getElementById('mcNameValid');
    const invalidEl = document.getElementById('mcNameInvalid');
    const errorEl = document.getElementById('mcNameError');
    const inputEl = document.getElementById('mcName');

    // Reset state
    statusEl.classList.add('hidden');
    spinnerEl.classList.add('hidden');
    validEl.classList.add('hidden');
    invalidEl.classList.add('hidden');
    errorEl.classList.add('hidden');
    inputEl.classList.remove('border-red-500', 'border-green-500');

    if (!name) {
        mcNameIsValid = false;
        return;
    }

    // Show spinner
    statusEl.classList.remove('hidden');
    spinnerEl.classList.remove('hidden');

    // Build URL with query params
    let url = `/api/model-configs/check-name/?name=${encodeURIComponent(name)}`;
    if (editingModelConfigId) {
        url += `&exclude_id=${editingModelConfigId}`;
    }

    fetch(url)
        .then(r => r.json())
        .then(data => {
            spinnerEl.classList.add('hidden');

            if (data.success && data.data.available) {
                // Name is available
                mcNameIsValid = true;
                validEl.classList.remove('hidden');
                inputEl.classList.add('border-green-500');
            } else {
                // Name is taken
                mcNameIsValid = false;
                invalidEl.classList.remove('hidden');
                inputEl.classList.add('border-red-500');
                errorEl.textContent = data.data?.message || 'This name is already taken';
                errorEl.classList.remove('hidden');
            }
        })
        .catch(err => {
            console.error('Error checking name:', err);
            spinnerEl.classList.add('hidden');
            mcNameIsValid = false;
        });
}

// Load Presets from API
function loadPresets() {
    fetch('/api/model-configs/presets/')
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                presetsData = data.data;
                applyPreset('standard');
            }
        })
        .catch(err => console.error('Error loading presets:', err));
}

// Select Model Type
function selectModelType(type) {
    if (type !== 'retrieval' && type !== 'ranking' && type !== 'multitask') return;

    mcState.modelType = type;
    document.querySelectorAll('.wizard-model-type-option').forEach(opt => {
        opt.classList.toggle('selected', opt.dataset.type === type);
    });

    // Show/hide sections based on model type
    const retrievalSection = document.querySelector('.retrieval-algorithm-section');
    const ratingHeadSection = document.getElementById('ratingHeadSection');
    const multitaskArchSection = document.getElementById('multitaskArchSection');
    const multitaskWeightSection = document.getElementById('multitaskWeightSection');

    if (type === 'retrieval') {
        if (retrievalSection) retrievalSection.classList.remove('hidden');
        if (ratingHeadSection) ratingHeadSection.classList.add('hidden');
        if (multitaskArchSection) multitaskArchSection.classList.add('hidden');
        if (multitaskWeightSection) multitaskWeightSection.classList.add('hidden');
    } else if (type === 'ranking') {
        if (retrievalSection) retrievalSection.classList.add('hidden');
        if (ratingHeadSection) ratingHeadSection.classList.remove('hidden');
        if (multitaskArchSection) multitaskArchSection.classList.add('hidden');
        if (multitaskWeightSection) multitaskWeightSection.classList.add('hidden');
        // Generate rating head from current tower preset if empty
        if (mcState.ratingHeadLayers.length === 0) {
            mcState.ratingHeadLayers = generateRatingHeadFromTower(mcState.buyerTowerLayers);
        }
        renderRatingHeadLayers();
        updateRatingHeadSummary();
    } else if (type === 'multitask') {
        // Multitask shows BOTH retrieval algorithm AND rating head
        if (retrievalSection) retrievalSection.classList.remove('hidden');
        if (ratingHeadSection) ratingHeadSection.classList.remove('hidden');
        if (multitaskArchSection) multitaskArchSection.classList.remove('hidden');
        if (multitaskWeightSection) multitaskWeightSection.classList.remove('hidden');
        // Generate rating head from current tower preset if empty
        if (mcState.ratingHeadLayers.length === 0) {
            mcState.ratingHeadLayers = generateRatingHeadFromTower(mcState.buyerTowerLayers);
        }
        renderRatingHeadLayers();
        updateRatingHeadSummary();
        updateMultitaskArchDiagram();
    }
}

// Select Preset
function selectPreset(preset) {
    mcState.selectedPreset = preset;
    document.querySelectorAll('.preset-option').forEach(opt => {
        opt.classList.toggle('selected', opt.dataset.preset === preset);
    });
    applyPreset(preset);
}

// Apply Preset Configuration
function applyPreset(presetName) {
    const preset = presetsData[presetName];
    if (!preset) return;

    mcState.buyerTowerLayers = JSON.parse(JSON.stringify(preset.buyer_tower_layers || []));
    mcState.productTowerLayers = JSON.parse(JSON.stringify(preset.product_tower_layers || []));
    mcState.outputEmbeddingDim = preset.output_embedding_dim || 32;

    // Generate Rating Head layers from tower preset (for ranking models)
    mcState.ratingHeadLayers = generateRatingHeadFromTower(preset.buyer_tower_layers || []);
    mcState.ratingHeadPreset = presetName;

    renderTowerLayers();
    updateTowerSummaries();

    // If ranking or multitask model is selected, also render rating head
    if (mcState.modelType === 'ranking' || mcState.modelType === 'multitask') {
        renderRatingHeadLayers();
        updateRatingHeadSummary();
    }

    // If multitask, also update the architecture diagram
    if (mcState.modelType === 'multitask') {
        updateMultitaskArchDiagram();
    }
}

// Generate Rating Head layers from tower layers
// Takes tower Dense layers, copies their structure with relu activation,
// and appends a final Dense(1) output layer with linear activation
function generateRatingHeadFromTower(towerLayers) {
    const ratingHeadLayers = [];

    // Extract Dense layers from tower (ignore dropout, batch_norm)
    for (const layer of towerLayers) {
        if (layer.type === 'dense') {
            ratingHeadLayers.push({
                type: 'dense',
                units: layer.units,
                activation: 'relu',
                l2_reg: 0.0  // No regularization by default
            });
        }
    }

    // Append final Dense(1) output layer with linear activation
    ratingHeadLayers.push({
        type: 'dense',
        units: 1,
        activation: null  // Linear activation for scalar output
    });

    return ratingHeadLayers;
}

// Select Optimizer (Step 3)
function selectOptimizer(optimizer) {
    mcState.optimizer = optimizer;

    // Update radio buttons
    document.querySelectorAll('input[name="mcOptimizer"]').forEach(radio => {
        radio.checked = radio.value === optimizer;
    });

    // Update visual selection
    document.querySelectorAll('.optimizer-option').forEach(opt => {
        const radio = opt.querySelector('input[type="radio"]');
        opt.classList.toggle('selected', radio && radio.value === optimizer);
    });

    // Suggest learning rate based on optimizer
    const lrSuggestions = {
        'adagrad': 0.1,
        'adam': 0.001,
        'sgd': 0.01,
        'rmsprop': 0.001,
        'adamw': 0.001,
        'ftrl': 0.1
    };

    if (lrSuggestions[optimizer]) {
        setLearningRate(lrSuggestions[optimizer]);
    }
}

// Select Loss Function (Step 3, for Ranking models)
function selectLossFunction(loss) {
    mcState.lossFunction = loss;

    // Update radio buttons
    document.querySelectorAll('input[name="mcLossFunction"]').forEach(radio => {
        radio.checked = radio.value === loss;
    });

    // Update visual selection
    document.querySelectorAll('.loss-option').forEach(opt => {
        const radio = opt.querySelector('input[type="radio"]');
        opt.classList.toggle('selected', radio && radio.value === loss);
    });

    // Update info text
    const infoTexts = {
        'mse': 'Best for continuous ratings (e.g., 1.0-5.0). Penalizes large prediction errors more heavily.',
        'binary_crossentropy': 'For binary outcomes (like/dislike, click/no-click). Use when rating is 0 or 1.',
        'huber': 'Robust to outliers. Combines MSE for small errors and MAE for large errors. Good when ratings have noise.'
    };

    const infoTextEl = document.getElementById('lossInfoText');
    if (infoTextEl) {
        const pEl = infoTextEl.querySelector('p');
        if (pEl) {
            pEl.textContent = infoTexts[loss] || infoTexts['mse'];
        }
    }
}

// Set Learning Rate (Step 3)
function setLearningRate(value) {
    mcState.learningRate = value;
    document.getElementById('mcLearningRate').value = value;

    // Update preset buttons
    document.querySelectorAll('.lr-preset-btn').forEach(btn => {
        const btnValue = parseFloat(btn.textContent);
        btn.classList.toggle('active', btnValue === value);
    });
}

// Update Retrieval Weight (Multitask)
function updateRetrievalWeight(value) {
    const weight = parseFloat(value);
    mcState.retrievalWeight = weight;
    document.getElementById('retrievalWeightValue').textContent = weight.toFixed(1);
    validateMultitaskWeights();
    updateMultitaskSummary();
}

// Update Ranking Weight (Multitask)
function updateRankingWeight(value) {
    const weight = parseFloat(value);
    mcState.rankingWeight = weight;
    document.getElementById('rankingWeightValue').textContent = weight.toFixed(1);
    validateMultitaskWeights();
    updateMultitaskSummary();
}

// Validate Multitask Weights (at least one > 0)
function validateMultitaskWeights() {
    const warning = document.getElementById('weightValidationWarning');
    if (!warning) return true;

    if (mcState.retrievalWeight === 0 && mcState.rankingWeight === 0) {
        warning.classList.remove('hidden');
        return false;
    } else {
        warning.classList.add('hidden');
        return true;
    }
}

// Update Multitask Summary in Step 3
function updateMultitaskSummary() {
    const summaryWeights = document.getElementById('mcSummaryWeights');
    if (summaryWeights) {
        summaryWeights.textContent = `Ret: ${mcState.retrievalWeight.toFixed(1)} / Rank: ${mcState.rankingWeight.toFixed(1)}`;
    }
}

// Update Multitask Architecture Diagram
function updateMultitaskArchDiagram() {
    // Update tower summaries
    const buyerSummary = getTowerSummary(mcState.buyerTowerLayers);
    const productSummary = getTowerSummary(mcState.productTowerLayers);
    const ratingHeadSummary = getTowerSummary(mcState.ratingHeadLayers);

    const archBuyerSummary = document.getElementById('archBuyerSummary');
    const archProductSummary = document.getElementById('archProductSummary');
    const archRatingHeadSummary = document.getElementById('archRatingHeadSummary');

    if (archBuyerSummary) archBuyerSummary.textContent = buyerSummary;
    if (archProductSummary) archProductSummary.textContent = productSummary;
    if (archRatingHeadSummary) archRatingHeadSummary.textContent = ratingHeadSummary;

    // Update embedding dimensions
    const outputDim = mcState.outputEmbeddingDim || 32;
    const archBuyerDim = document.getElementById('archBuyerDim');
    const archProductDim = document.getElementById('archProductDim');
    const archConcatDim = document.getElementById('archConcatDim');

    if (archBuyerDim) archBuyerDim.textContent = `${outputDim}D`;
    if (archProductDim) archProductDim.textContent = `${outputDim}D`;
    if (archConcatDim) archConcatDim.textContent = `${outputDim * 2}D`;

    // Update loss function
    const archLossFunction = document.getElementById('archLossFunction');
    if (archLossFunction) {
        const lossLabels = { 'mse': 'MSE', 'binary_crossentropy': 'Binary CE', 'huber': 'Huber' };
        archLossFunction.textContent = lossLabels[mcState.lossFunction] || 'MSE';
    }

    // Update weights
    const archRetrievalWeight = document.getElementById('archRetrievalWeight');
    const archRankingWeight = document.getElementById('archRankingWeight');

    if (archRetrievalWeight) archRetrievalWeight.textContent = mcState.retrievalWeight.toFixed(1);
    if (archRankingWeight) archRankingWeight.textContent = mcState.rankingWeight.toFixed(1);
}

// Helper function to get tower summary string
function getTowerSummary(layers) {
    if (!layers || layers.length === 0) return 'Empty';
    const units = layers.filter(l => l.type === 'dense').map(l => l.units);
    return units.join('') || 'Empty';
}

// Get selected optimizer value
function getSelectedOptimizer() {
    const selected = document.querySelector('input[name="mcOptimizer"]:checked');
    return selected ? selected.value : 'adagrad';
}

// Render Tower Layers
function renderTowerLayers() {
    renderLayerList('buyer', mcState.buyerTowerLayers);
    renderLayerList('product', mcState.productTowerLayers);
}

function renderLayerList(tower, layers) {
    const list = document.getElementById(`${tower}LayerList`);
    if (!list) return;

    // Find the last Dense layer index (output embedding layer)
    let lastDenseIdx = -1;
    for (let i = layers.length - 1; i >= 0; i--) {
        if (layers[i].type === 'dense') {
            lastDenseIdx = i;
            break;
        }
    }

    list.innerHTML = layers.map((layer, idx) => {
        let badge = '';
        let params = '';
        const isOutputLayer = (layer.type === 'dense' && idx === lastDenseIdx);

        if (layer.type === 'dense') {
            badge = '<span class="layer-type-badge dense">Dense</span>';
            let regInfo = '';
            if (layer.l2_reg) regInfo = `, L2=${layer.l2_reg}`;
            else if (layer.l1_reg) regInfo = `, L1=${layer.l1_reg}`;
            params = `${layer.units} units, ${layer.activation || 'relu'}${regInfo}`;
        } else if (layer.type === 'dropout') {
            badge = '<span class="layer-type-badge dropout">Dropout</span>';
            params = `rate: ${layer.rate}`;
        } else if (layer.type === 'batch_norm') {
            badge = '<span class="layer-type-badge batch_norm">BatchNorm</span>';
            params = '';
        } else if (layer.type === 'layer_norm') {
            badge = '<span class="layer-type-badge layer_norm">LayerNorm</span>';
            params = layer.epsilon ? `: ${layer.epsilon}` : '';
        }

        // For output layer: use editOutputLayer and no delete button
        const editAction = isOutputLayer
            ? `onclick="editOutputLayer()" title="Edit Output Layer (both towers)"`
            : `onclick="editLayer('${tower}', ${idx})" title="Edit"`;

        const deleteBtn = isOutputLayer
            ? ''
            : `<button class="layer-action-btn delete" onclick="removeLayer('${tower}', ${idx})" title="Delete">
                   <i class="fas fa-trash"></i>
               </button>`;

        // Draggable for all layers except the output layer
        const draggable = isOutputLayer ? 'false' : 'true';
        const dragHandleClass = isOutputLayer ? 'drag-handle disabled' : 'drag-handle';

        return `
            <div class="layer-item${isOutputLayer ? ' output-layer' : ''}"
                 data-index="${idx}"
                 data-tower="${tower}"
                 draggable="${draggable}"
                 ondragstart="layerDragStart(event, '${tower}', ${idx})"
                 ondragend="layerDragEnd(event)"
                 ondragover="layerDragOver(event)"
                 ondrop="layerDrop(event, '${tower}', ${idx})">
                <span class="${dragHandleClass}"><i class="fas fa-grip-vertical"></i></span>
                ${badge}
                <span class="layer-params">${params}</span>
                <div class="layer-actions">
                    <button class="layer-action-btn" ${editAction}>
                        <i class="fas fa-external-link-alt"></i>
                    </button>
                    ${deleteBtn}
                </div>
            </div>
        `;
    }).join('');
}

// Layer Drag and Drop
let layerDragData = null;

function layerDragStart(event, tower, index) {
    // Don't allow dragging the output layer
    let layers;
    if (tower === 'buyer') layers = mcState.buyerTowerLayers;
    else if (tower === 'product') layers = mcState.productTowerLayers;
    else if (tower === 'rating_head') layers = mcState.ratingHeadLayers;

    const lastDenseIdx = getLastDenseLayerIndex(layers);
    if (index === lastDenseIdx) {
        event.preventDefault();
        return;
    }

    layerDragData = { tower, index };
    event.target.classList.add('dragging');
    event.dataTransfer.effectAllowed = 'move';
    event.dataTransfer.setData('text/plain', JSON.stringify({ tower, index }));
}

function layerDragEnd(event) {
    event.target.classList.remove('dragging');
    // Remove all drag-over classes
    document.querySelectorAll('.layer-item.drag-over').forEach(el => {
        el.classList.remove('drag-over');
    });
    layerDragData = null;
}

function layerDragOver(event) {
    event.preventDefault();
    event.dataTransfer.dropEffect = 'move';

    const layerItem = event.target.closest('.layer-item');
    if (layerItem && !layerItem.classList.contains('output-layer')) {
        // Remove drag-over from all other items
        document.querySelectorAll('.layer-item.drag-over').forEach(el => {
            if (el !== layerItem) el.classList.remove('drag-over');
        });
        layerItem.classList.add('drag-over');
    }
}

function layerDrop(event, targetTower, targetIndex) {
    event.preventDefault();

    const layerItem = event.target.closest('.layer-item');
    if (layerItem) {
        layerItem.classList.remove('drag-over');
    }

    if (!layerDragData) return;

    const { tower: sourceTower, index: sourceIndex } = layerDragData;

    // Only allow reordering within the same tower
    if (sourceTower !== targetTower) {
        layerDragData = null;
        return;
    }

    // Get the appropriate layers array
    let layers;
    if (sourceTower === 'buyer') layers = mcState.buyerTowerLayers;
    else if (sourceTower === 'product') layers = mcState.productTowerLayers;
    else if (sourceTower === 'rating_head') layers = mcState.ratingHeadLayers;

    const lastDenseIdx = getLastDenseLayerIndex(layers);

    // Can't drop onto or after the output layer
    if (targetIndex >= lastDenseIdx) {
        targetIndex = lastDenseIdx - 1;
    }

    // Don't do anything if dropped on same position
    if (sourceIndex === targetIndex) {
        layerDragData = null;
        return;
    }

    // Perform the reorder
    const [movedLayer] = layers.splice(sourceIndex, 1);

    // Adjust target index if we removed from before target
    let insertIndex = targetIndex;
    if (sourceIndex < targetIndex) {
        insertIndex = targetIndex - 1;
    }

    // Make sure we don't insert after the output layer
    const newLastDenseIdx = getLastDenseLayerIndex(layers);
    if (insertIndex >= newLastDenseIdx) {
        insertIndex = newLastDenseIdx;
    }

    layers.splice(insertIndex, 0, movedLayer);

    // Update state and re-render based on tower type
    if (sourceTower === 'buyer') {
        mcState.buyerTowerLayers = layers;
        renderTowerLayers();
        updateTowerSummaries();
    } else if (sourceTower === 'product') {
        mcState.productTowerLayers = layers;
        renderTowerLayers();
        updateTowerSummaries();
    } else if (sourceTower === 'rating_head') {
        mcState.ratingHeadLayers = layers;
        renderRatingHeadLayers();
    }

    layerDragData = null;
}

// Update Tower Summaries
function updateTowerSummaries() {
    const buyerSummary = getTowerSummary(mcState.buyerTowerLayers);
    const productSummary = getTowerSummary(mcState.productTowerLayers);

    const buyerEl = document.getElementById('buyerTowerSummary');
    const productEl = document.getElementById('productTowerSummary');

    if (buyerEl) buyerEl.textContent = buyerSummary;
    if (productEl) productEl.textContent = productSummary;

    // Update params summaries
    updateTowerParams('buyer', mcState.buyerTowerLayers);
    updateTowerParams('product', mcState.productTowerLayers);
}

function getTowerSummary(layers) {
    const units = layers.filter(l => l.type === 'dense').map(l => l.units);
    return units.length > 0 ? units.join('') : 'Empty';
}

// Calculate and display tower parameters (Keras-style)
function updateTowerParams(tower, layers) {
    const totalParamsEl = document.getElementById(`${tower}TotalParams`);
    const trainableParamsEl = document.getElementById(`${tower}TrainableParams`);

    if (!totalParamsEl || !trainableParamsEl) return;

    const params = calculateTowerParams(layers);
    totalParamsEl.textContent = formatNumber(params);
    trainableParamsEl.textContent = formatNumber(params);
}

function calculateTowerParams(layers) {
    let totalParams = 0;
    let prevUnits = 100; // Assume input dimension (will be from FeatureConfig in reality)

    for (const layer of layers) {
        if (layer.type === 'dense') {
            // Dense layer: (input_units * output_units) + output_units (bias)
            const units = layer.units || 32;
            totalParams += (prevUnits * units) + units;
            prevUnits = units;
        }
        // Dropout and BatchNorm have 0 trainable params in this context
    }

    return totalParams;
}

function formatNumber(num) {
    if (num >= 1000000) {
        return (num / 1000000).toFixed(2) + 'M';
    } else if (num >= 1000) {
        return num.toLocaleString();
    }
    return num.toString();
}

// Layer Modal (Add/Edit)
function addLayer(tower) {
    openLayerModal(tower, -1, 'add');
}

function editLayer(tower, index) {
    openLayerModal(tower, index, 'edit');
}

function openLayerModal(tower, index, mode) {
    document.getElementById('layerModalTower').value = tower;
    document.getElementById('layerModalIndex').value = index;
    document.getElementById('layerModalMode').value = mode;

    const titleEl = document.getElementById('layerModalTitle');
    const subtitleEl = document.getElementById('layerModalSubtitle');
    const submitBtn = document.getElementById('layerModalSubmitBtn');
    const typeSelect = document.getElementById('layerType');
    let towerName = tower === 'buyer' ? 'Buyer Tower' : (tower === 'product' ? 'Product Tower' : 'Rating Head');

    if (mode === 'edit') {
        titleEl.textContent = 'Edit Layer';
        subtitleEl.textContent = `${towerName} - Layer ${index + 1}`;
        submitBtn.innerHTML = '<span class="btn-neu-inner">Save</span>';

        // Get the layer data
        let layers;
        if (tower === 'buyer') layers = mcState.buyerTowerLayers;
        else if (tower === 'product') layers = mcState.productTowerLayers;
        else if (tower === 'rating_head') layers = mcState.ratingHeadLayers;
        const layer = layers[index];

        // Populate fields from existing layer
        typeSelect.value = layer.type;

        if (layer.type === 'dense') {
            const units = layer.units || 64;
            document.getElementById('layerUnits').value = units;
            updateLayerUnitsButtons(units);
            document.getElementById('layerActivation').value = layer.activation || 'relu';

            // Set regularization
            if (layer.l2_reg) {
                document.getElementById('layerRegType').value = 'l2';
                document.getElementById('layerRegStrength').value = layer.l2_reg;
            } else if (layer.l1_reg) {
                document.getElementById('layerRegType').value = 'l1';
                document.getElementById('layerRegStrength').value = layer.l1_reg;
            } else {
                document.getElementById('layerRegType').value = 'none';
                document.getElementById('layerRegStrength').value = 0.001;
            }
        } else if (layer.type === 'dropout') {
            document.getElementById('layerDropoutRate').value = layer.rate || 0.2;
        } else if (layer.type === 'layer_norm') {
            document.getElementById('layerNormEpsilon').value = layer.epsilon || 1e-6;
        }

        // Disable type change in edit mode
        typeSelect.disabled = true;
    } else {
        titleEl.textContent = 'Add Layer';
        subtitleEl.textContent = `Add to ${towerName}`;
        submitBtn.innerHTML = '<span class="btn-neu-inner">Add Layer</span>';

        // Reset to defaults for add mode
        typeSelect.value = 'dense';
        typeSelect.disabled = false;
        document.getElementById('layerUnits').value = 64;
        document.getElementById('layerUnitsCustom').value = '';
        updateLayerUnitsButtons(64);
        document.getElementById('layerActivation').value = 'relu';
        document.getElementById('layerRegType').value = 'none';
        document.getElementById('layerRegStrength').value = 0.001;
        document.getElementById('layerDropoutRate').value = 0.2;
        document.getElementById('layerNormEpsilon').value = 0.000001;
    }

    updateLayerModalFields();
    updateRegStrengthVisibility();
    document.getElementById('layerModal').classList.remove('hidden');
}

function updateLayerModalFields() {
    const type = document.getElementById('layerType').value;
    document.getElementById('denseFieldsModal').classList.toggle('hidden', type !== 'dense');
    document.getElementById('dropoutFieldsModal').classList.toggle('hidden', type !== 'dropout');
    document.getElementById('batchNormFieldsModal').classList.toggle('hidden', type !== 'batch_norm');
    document.getElementById('layerNormFieldsModal').classList.toggle('hidden', type !== 'layer_norm');
}

function updateRegStrengthVisibility() {
    const regType = document.getElementById('layerRegType').value;
    const strengthGroup = document.getElementById('regStrengthGroup');
    strengthGroup.style.visibility = regType === 'none' ? 'hidden' : 'visible';
}

// Layer Units button selection
function selectLayerUnits(units) {
    document.getElementById('layerUnits').value = units;
    document.getElementById('layerUnitsCustom').value = '';
    updateLayerUnitsButtons(units);
}

function onLayerUnitsCustomInput(value) {
    if (value) {
        const units = parseInt(value);
        if (units >= 8 && units <= 2048) {
            document.getElementById('layerUnits').value = units;
            // Deselect all preset buttons when custom value is entered
            updateLayerUnitsButtons(null);
        }
    }
}

function updateLayerUnitsButtons(selectedUnits) {
    const presetUnits = [32, 64, 128, 256, 512];
    const buttons = document.querySelectorAll('.layer-units-btn');
    const customInput = document.getElementById('layerUnitsCustom');

    buttons.forEach(btn => {
        const btnUnits = parseInt(btn.textContent);
        if (btnUnits === selectedUnits) {
            btn.className = 'layer-units-btn px-3 py-2 rounded-lg border transition-all bg-blue-500 text-white border-blue-500';
        } else {
            btn.className = 'layer-units-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400';
        }
    });

    // If selected units is not a preset, show it in custom input
    if (selectedUnits && !presetUnits.includes(selectedUnits)) {
        customInput.value = selectedUnits;
    } else if (customInput) {
        customInput.value = '';
    }
}

// Retrieval Algorithm Selection
function selectRetrievalAlgorithm(algorithm) {
    mcState.retrievalAlgorithm = algorithm;

    // Update UI - toggle selected class on options
    const options = document.querySelectorAll('.algorithm-option');
    options.forEach(opt => {
        const optAlgorithm = opt.onclick.toString().includes('brute_force') ? 'brute_force' : 'scann';
        if (optAlgorithm === algorithm) {
            opt.classList.add('selected');
        } else {
            opt.classList.remove('selected');
        }
    });

    // Show/hide parameter panels
    const bruteForceParams = document.getElementById('bruteForceParams');
    const scannParams = document.getElementById('scannParams');

    if (algorithm === 'brute_force') {
        bruteForceParams.classList.remove('hidden');
        scannParams.classList.add('hidden');
    } else {
        bruteForceParams.classList.add('hidden');
        scannParams.classList.remove('hidden');
    }
}

// Update retrieval algorithm state from inputs
function updateRetrievalAlgorithmState() {
    if (mcState.retrievalAlgorithm === 'brute_force') {
        mcState.topK = parseInt(document.getElementById('mcTopK').value) || 100;
    } else {
        mcState.topK = parseInt(document.getElementById('mcScannTopK').value) || 100;
        mcState.scannNumLeaves = parseInt(document.getElementById('mcScannNumLeaves').value) || 100;
        mcState.scannLeavesToSearch = parseInt(document.getElementById('mcScannLeavesToSearch').value) || 10;
    }
}

// =============================================================================
// Rating Head Functions (for Ranking models)
// =============================================================================

// Render rating head layers
function renderRatingHeadLayers() {
    const list = document.getElementById('ratingHeadLayerList');
    if (!list) return;

    const layers = mcState.ratingHeadLayers;

    // Find the last Dense layer (output layer - must be Dense(1))
    let lastDenseIdx = -1;
    for (let i = layers.length - 1; i >= 0; i--) {
        if (layers[i].type === 'dense') {
            lastDenseIdx = i;
            break;
        }
    }

    list.innerHTML = layers.map((layer, idx) => {
        let badge = '';
        let params = '';
        const isOutputLayer = (layer.type === 'dense' && idx === lastDenseIdx);

        if (layer.type === 'dense') {
            badge = '<span class="layer-type-badge dense">Dense</span>';
            let regInfo = '';
            if (layer.l2_reg) regInfo = `, L2=${layer.l2_reg}`;
            else if (layer.l1_reg) regInfo = `, L1=${layer.l1_reg}`;
            const activation = layer.activation || 'linear';
            params = `${layer.units} units, ${activation}${regInfo}`;
        } else if (layer.type === 'dropout') {
            badge = '<span class="layer-type-badge dropout">Dropout</span>';
            params = `rate: ${layer.rate}`;
        } else if (layer.type === 'batch_norm') {
            badge = '<span class="layer-type-badge batch_norm">BatchNorm</span>';
            params = '';
        } else if (layer.type === 'layer_norm') {
            badge = '<span class="layer-type-badge layer_norm">LayerNorm</span>';
            params = layer.epsilon ? `: ${layer.epsilon}` : '';
        }

        // Output layer (Dense(1)) cannot be deleted but can be edited
        const deleteBtn = isOutputLayer
            ? ''
            : `<button class="layer-action-btn delete" onclick="removeRatingHeadLayer(${idx})" title="Delete">
                   <i class="fas fa-trash"></i>
               </button>`;

        const outputLabel = isOutputLayer ? '<span class="output-layer-label">Output</span>' : '';

        // Draggable for all layers except the output layer
        const draggable = isOutputLayer ? 'false' : 'true';
        const dragHandleClass = isOutputLayer ? 'drag-handle disabled' : 'drag-handle';

        return `
            <div class="layer-item${isOutputLayer ? ' output-layer' : ''}"
                 data-index="${idx}"
                 data-tower="rating_head"
                 draggable="${draggable}"
                 ondragstart="layerDragStart(event, 'rating_head', ${idx})"
                 ondragend="layerDragEnd(event)"
                 ondragover="layerDragOver(event)"
                 ondrop="layerDrop(event, 'rating_head', ${idx})">
                <span class="${dragHandleClass}"><i class="fas fa-grip-vertical"></i></span>
                ${badge}
                <span class="layer-params">${params}</span>
                ${outputLabel}
                <div class="layer-actions">
                    <button class="layer-action-btn" onclick="editRatingHeadLayer(${idx})" title="Edit">
                        <i class="fas fa-external-link-alt"></i>
                    </button>
                    ${deleteBtn}
                </div>
            </div>
        `;
    }).join('');

    updateRatingHeadSummary();
    updateRatingHeadParams();
}

// Update rating head summary (e.g., "256641")
function updateRatingHeadSummary() {
    const summaryEl = document.getElementById('ratingHeadSummary');
    if (!summaryEl) return;

    const units = mcState.ratingHeadLayers
        .filter(l => l.type === 'dense')
        .map(l => l.units);

    summaryEl.textContent = units.length > 0 ? units.join('') : 'Empty';
}

// Update rating head parameter count estimation
function updateRatingHeadParams() {
    const totalParamsEl = document.getElementById('ratingHeadTotalParams');
    const trainableParamsEl = document.getElementById('ratingHeadTrainableParams');
    if (!totalParamsEl) return;

    // Input is concatenated embeddings from both towers
    let prevDim = mcState.outputEmbeddingDim * 2;
    let totalParams = 0;

    mcState.ratingHeadLayers.forEach(layer => {
        if (layer.type === 'dense') {
            totalParams += prevDim * layer.units + layer.units; // weights + bias
            prevDim = layer.units;
        }
    });

    totalParamsEl.textContent = formatParamCount(totalParams);
    trainableParamsEl.textContent = formatParamCount(totalParams);
}

// Add layer to rating head
function addRatingHeadLayer() {
    openLayerModal('rating_head', -1, 'add');
}

// Edit rating head layer
function editRatingHeadLayer(index) {
    openLayerModal('rating_head', index, 'edit');
}

// Remove rating head layer
function removeRatingHeadLayer(index) {
    mcState.ratingHeadLayers.splice(index, 1);
    renderRatingHeadLayers();
}

// Get rating head summary for display
function getRatingHeadSummary() {
    const units = mcState.ratingHeadLayers
        .filter(l => l.type === 'dense')
        .map(l => l.units);
    return units.length > 0 ? units.join('') : 'None';
}

// Get rating head summary from layers array (for card rendering)
function getRatingHeadSummaryFromLayers(layers) {
    if (!layers || layers.length === 0) return 'None';
    const units = layers
        .filter(l => l.type === 'dense')
        .map(l => l.units);
    return units.length > 0 ? units.join('') : 'None';
}

function closeLayerModal(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('layerModal').classList.add('hidden');
    // Re-enable type select in case it was disabled
    document.getElementById('layerType').disabled = false;
}

function submitLayerModal() {
    const tower = document.getElementById('layerModalTower').value;
    const index = parseInt(document.getElementById('layerModalIndex').value);
    const mode = document.getElementById('layerModalMode').value;
    const type = document.getElementById('layerType').value;

    let layer = { type };

    if (type === 'dense') {
        layer.units = parseInt(document.getElementById('layerUnits').value);
        layer.activation = document.getElementById('layerActivation').value;
        if (layer.activation === 'linear') layer.activation = null;

        const regType = document.getElementById('layerRegType').value;
        if (regType === 'l2') {
            layer.l2_reg = parseFloat(document.getElementById('layerRegStrength').value);
        } else if (regType === 'l1') {
            layer.l1_reg = parseFloat(document.getElementById('layerRegStrength').value);
        }
    } else if (type === 'dropout') {
        layer.rate = parseFloat(document.getElementById('layerDropoutRate').value);
    } else if (type === 'layer_norm') {
        layer.epsilon = parseFloat(document.getElementById('layerNormEpsilon').value) || 1e-6;
    }
    // batch_norm has no additional fields

    let layers;
    if (tower === 'buyer') layers = mcState.buyerTowerLayers;
    else if (tower === 'product') layers = mcState.productTowerLayers;
    else if (tower === 'rating_head') layers = mcState.ratingHeadLayers;

    if (mode === 'edit') {
        // Replace existing layer
        layers[index] = layer;
    } else {
        // Add new layer - insert BEFORE the last Dense layer (output layer)
        const lastDenseIdx = getLastDenseLayerIndex(layers);
        if (lastDenseIdx !== -1) {
            // Insert before the output layer
            layers.splice(lastDenseIdx, 0, layer);
        } else {
            // No output layer exists, just push
            layers.push(layer);
        }
    }

    // Re-render the appropriate tower/section
    if (tower === 'rating_head') {
        renderRatingHeadLayers();
    } else {
        renderTowerLayers();
        updateTowerSummaries();
    }
    closeLayerModal();
}

function removeLayer(tower, index) {
    if (tower === 'buyer') {
        mcState.buyerTowerLayers.splice(index, 1);
    } else {
        mcState.productTowerLayers.splice(index, 1);
    }
    renderTowerLayers();
    updateTowerSummaries();
}

// Output Layer Modal (edits last Dense layer on both towers)
function getLastDenseLayerIndex(layers) {
    for (let i = layers.length - 1; i >= 0; i--) {
        if (layers[i].type === 'dense') return i;
    }
    return -1;
}

function editOutputLayer() {
    // Get the last Dense layer from buyer tower (both should match)
    const buyerIdx = getLastDenseLayerIndex(mcState.buyerTowerLayers);
    if (buyerIdx === -1) {
        alert('No Dense layer found in Buyer tower');
        return;
    }

    const buyerLayer = mcState.buyerTowerLayers[buyerIdx];
    const currentUnits = buyerLayer.units || 32;

    // Populate modal with current values
    document.getElementById('outputLayerUnits').value = currentUnits;
    document.getElementById('outputLayerActivation').value = buyerLayer.activation || 'relu';

    // Update dimension button selection
    updateOutputDimButtons(currentUnits);

    document.getElementById('outputLayerModal').classList.remove('hidden');
}

// Output dimension button selection
function selectOutputDim(dim) {
    document.getElementById('outputLayerUnits').value = dim;
    document.getElementById('outputLayerCustomDim').value = '';
    updateOutputDimButtons(dim);
}

function onOutputCustomDimInput(value) {
    if (value) {
        const dim = parseInt(value);
        if (dim >= 4 && dim <= 1024) {
            document.getElementById('outputLayerUnits').value = dim;
            // Deselect all preset buttons when custom value is entered
            updateOutputDimButtons(null);
        }
    }
}

function updateOutputDimButtons(selectedDim) {
    const presetDims = [8, 16, 32, 64, 128, 256];
    const buttons = document.querySelectorAll('.output-dim-btn');
    const customInput = document.getElementById('outputLayerCustomDim');

    buttons.forEach(btn => {
        const btnDim = parseInt(btn.textContent);
        if (btnDim === selectedDim) {
            btn.className = 'output-dim-btn px-3 py-2 rounded-lg border transition-all bg-blue-500 text-white border-blue-500';
        } else {
            btn.className = 'output-dim-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400';
        }
    });

    // If selected dim is not a preset, show it in custom input
    if (selectedDim && !presetDims.includes(selectedDim)) {
        customInput.value = selectedDim;
    } else {
        customInput.value = '';
    }
}

function closeOutputLayerModal(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('outputLayerModal').classList.add('hidden');
}

function submitOutputLayer() {
    const units = parseInt(document.getElementById('outputLayerUnits').value);
    let activation = document.getElementById('outputLayerActivation').value;
    if (activation === 'linear') activation = null;

    // Update last Dense layer in buyer tower
    const buyerIdx = getLastDenseLayerIndex(mcState.buyerTowerLayers);
    if (buyerIdx !== -1) {
        mcState.buyerTowerLayers[buyerIdx].units = units;
        mcState.buyerTowerLayers[buyerIdx].activation = activation;
    }

    // Update last Dense layer in product tower
    const productIdx = getLastDenseLayerIndex(mcState.productTowerLayers);
    if (productIdx !== -1) {
        mcState.productTowerLayers[productIdx].units = units;
        mcState.productTowerLayers[productIdx].activation = activation;
    }

    // Update state
    mcState.outputEmbeddingDim = units;

    renderTowerLayers();
    updateTowerSummaries();
    closeOutputLayerModal();
}

// Navigation
function mcNextStep() {
    if (mcCurrentStep === 1) {
        const name = document.getElementById('mcName').value.trim();
        if (!name) {
            document.getElementById('mcNameError').textContent = 'Name is required';
            document.getElementById('mcNameError').classList.remove('hidden');
            document.getElementById('mcName').classList.add('border-red-500');
            return;
        }
        // Check if name validation has been performed and is valid
        if (!mcNameIsValid) {
            // Trigger validation if not done yet
            checkMcNameAvailability();
            // Show error message
            document.getElementById('mcNameError').textContent = 'Please wait for name validation or choose a different name';
            document.getElementById('mcNameError').classList.remove('hidden');
            return;
        }
        mcState.name = name;
        mcState.description = document.getElementById('mcDescription').value.trim();
    }

    if (mcCurrentStep < 3) {
        mcCurrentStep++;
        updateMcStep();
    }
}

function mcPrevStep() {
    if (mcCurrentStep > 1) {
        mcCurrentStep--;
        updateMcStep();
    }
}

function updateMcStep() {
    // Update step content visibility (use 'active' class, not 'hidden')
    document.getElementById('mcStep1').classList.toggle('active', mcCurrentStep === 1);
    document.getElementById('mcStep2').classList.toggle('active', mcCurrentStep === 2);
    document.getElementById('mcStep3').classList.toggle('active', mcCurrentStep === 3);

    // Update progress pills
    for (let i = 1; i <= 3; i++) {
        const pill = document.getElementById(`mcProgress${i}`);
        pill.classList.remove('current', 'completed', 'future');
        if (i < mcCurrentStep) {
            pill.classList.add('completed');
        } else if (i === mcCurrentStep) {
            pill.classList.add('current');
        } else {
            pill.classList.add('future');
        }
    }

    // Update step counter
    document.getElementById('mcCurrentStep').textContent = mcCurrentStep;

    // Update buttons
    document.getElementById('mcBtnBack').classList.toggle('hidden', mcCurrentStep === 1);
    document.getElementById('mcBtnNext').classList.toggle('hidden', mcCurrentStep === 3);
    document.getElementById('mcBtnCreate').classList.toggle('hidden', mcCurrentStep !== 3);

    // Update summary on step 3
    if (mcCurrentStep === 3) {
        updateMcSummary();
        // Show/hide loss function panel based on model type (ranking or multitask)
        const lossFunctionPanel = document.getElementById('lossFunctionPanel');
        if (lossFunctionPanel) {
            lossFunctionPanel.classList.toggle('hidden', mcState.modelType !== 'ranking' && mcState.modelType !== 'multitask');
        }
        // Show/hide multitask weight section
        const multitaskWeightSection = document.getElementById('multitaskWeightSection');
        if (multitaskWeightSection) {
            multitaskWeightSection.classList.toggle('hidden', mcState.modelType !== 'multitask');
        }
    }

    // Render layers when entering step 2
    if (mcCurrentStep === 2) {
        renderTowerLayers();
        updateTowerSummaries();
        // Render rating head layers if ranking or multitask model
        if (mcState.modelType === 'ranking' || mcState.modelType === 'multitask') {
            renderRatingHeadLayers();
        }
        // Update multitask architecture diagram if multitask model
        if (mcState.modelType === 'multitask') {
            updateMultitaskArchDiagram();
        }
    }
}

function updateMcSummary() {
    // Set model type display
    const modelTypeLabels = { 'retrieval': 'Retrieval', 'ranking': 'Ranking', 'multitask': 'Multitask' };
    document.getElementById('mcSummaryType').textContent = modelTypeLabels[mcState.modelType] || 'Retrieval';

    document.getElementById('mcSummaryBuyer').textContent = getTowerSummary(mcState.buyerTowerLayers);
    document.getElementById('mcSummaryProduct').textContent = getTowerSummary(mcState.productTowerLayers);
    document.getElementById('mcSummaryOutputDim').textContent = mcState.outputEmbeddingDim || 32;

    // Handle retrieval vs ranking vs multitask specific info
    const retrievalRow = document.getElementById('mcSummaryRetrievalRow');
    const ratingHeadRow = document.getElementById('mcSummaryRatingHeadRow');
    const lossRow = document.getElementById('mcSummaryLossRow');
    const weightsRow = document.getElementById('mcSummaryWeightsRow');

    if (mcState.modelType === 'ranking') {
        // Hide retrieval, show rating head
        if (retrievalRow) retrievalRow.classList.add('hidden');
        if (ratingHeadRow) ratingHeadRow.classList.remove('hidden');
        if (lossRow) lossRow.classList.remove('hidden');
        if (weightsRow) weightsRow.classList.add('hidden');

        // Update rating head summary
        const ratingHeadSummaryEl = document.getElementById('mcSummaryRatingHead');
        if (ratingHeadSummaryEl) {
            ratingHeadSummaryEl.textContent = getRatingHeadSummary();
        }

        // Update loss function summary
        const lossSummaryEl = document.getElementById('mcSummaryLoss');
        if (lossSummaryEl) {
            const lossLabels = { 'mse': 'MSE', 'binary_crossentropy': 'Binary CE', 'huber': 'Huber' };
            lossSummaryEl.textContent = lossLabels[mcState.lossFunction] || 'MSE';
        }
    } else if (mcState.modelType === 'multitask') {
        // Show both retrieval and rating head for multitask
        if (retrievalRow) retrievalRow.classList.remove('hidden');
        if (ratingHeadRow) ratingHeadRow.classList.remove('hidden');
        if (lossRow) lossRow.classList.remove('hidden');
        if (weightsRow) weightsRow.classList.remove('hidden');

        // Update retrieval algorithm state from inputs
        updateRetrievalAlgorithmState();

        // Display retrieval algorithm info
        if (mcState.retrievalAlgorithm === 'brute_force') {
            document.getElementById('mcSummaryRetrieval').textContent = `Brute Force (Top ${mcState.topK})`;
        } else {
            document.getElementById('mcSummaryRetrieval').textContent = `ScaNN (Top ${mcState.topK})`;
        }

        // Update rating head summary
        const ratingHeadSummaryEl = document.getElementById('mcSummaryRatingHead');
        if (ratingHeadSummaryEl) {
            ratingHeadSummaryEl.textContent = getRatingHeadSummary();
        }

        // Update loss function summary
        const lossSummaryEl = document.getElementById('mcSummaryLoss');
        if (lossSummaryEl) {
            const lossLabels = { 'mse': 'MSE', 'binary_crossentropy': 'Binary CE', 'huber': 'Huber' };
            lossSummaryEl.textContent = lossLabels[mcState.lossFunction] || 'MSE';
        }

        // Update weights summary
        updateMultitaskSummary();
    } else {
        // Show retrieval, hide rating head (retrieval mode)
        if (retrievalRow) retrievalRow.classList.remove('hidden');
        if (ratingHeadRow) ratingHeadRow.classList.add('hidden');
        if (lossRow) lossRow.classList.add('hidden');
        if (weightsRow) weightsRow.classList.add('hidden');

        // Update retrieval algorithm state from inputs before summary
        updateRetrievalAlgorithmState();

        // Display retrieval algorithm info
        if (mcState.retrievalAlgorithm === 'brute_force') {
            document.getElementById('mcSummaryRetrieval').textContent = `Brute Force (Top ${mcState.topK})`;
        } else {
            document.getElementById('mcSummaryRetrieval').textContent = `ScaNN (Top ${mcState.topK})`;
        }
    }

    // Estimate params (rough calculation)
    const buyerParams = estimateTowerParams(mcState.buyerTowerLayers);
    const productParams = estimateTowerParams(mcState.productTowerLayers);
    let totalParams = buyerParams + productParams;

    // Add rating head params for ranking/multitask models
    if (mcState.modelType === 'ranking' || mcState.modelType === 'multitask') {
        const ratingHeadParams = estimateRatingHeadParams();
        totalParams += ratingHeadParams;
    }

    document.getElementById('mcSummaryParams').textContent = formatParams(totalParams);
}

function estimateRatingHeadParams() {
    let params = 0;
    let prevDim = (mcState.outputEmbeddingDim || 32) * 2; // Concatenated embeddings
    for (const layer of mcState.ratingHeadLayers) {
        if (layer.type === 'dense') {
            params += prevDim * layer.units + layer.units;
            prevDim = layer.units;
        }
    }
    return params;
}

function estimateTowerParams(layers) {
    let params = 0;
    let prevDim = 100; // Assume input dim
    for (const layer of layers) {
        if (layer.type === 'dense') {
            params += prevDim * layer.units + layer.units;
            prevDim = layer.units;
        }
    }
    return params;
}

function formatParams(num) {
    if (num >= 1000000) return `~${(num / 1000000).toFixed(1)}M`;
    if (num >= 1000) return `~${(num / 1000).toFixed(0)}K`;
    return `~${num}`;
}

// Save Model Config (handles both create and update)
function createModelConfig() {
    // Update retrieval algorithm state from inputs
    updateRetrievalAlgorithmState();

    // Validate multitask weights
    if (mcState.modelType === 'multitask') {
        if (mcState.retrievalWeight === 0 && mcState.rankingWeight === 0) {
            alert('At least one weight must be greater than 0 for multitask models.');
            return;
        }
    }

    const payload = {
        name: mcState.name,
        description: mcState.description,
        model_type: mcState.modelType,
        buyer_tower_layers: mcState.buyerTowerLayers,
        product_tower_layers: mcState.productTowerLayers,
        output_embedding_dim: mcState.outputEmbeddingDim || 32,
        // Retrieval algorithm settings (for retrieval/multitask models)
        retrieval_algorithm: mcState.retrievalAlgorithm,
        top_k: mcState.topK,
        scann_num_leaves: mcState.scannNumLeaves,
        scann_leaves_to_search: mcState.scannLeavesToSearch,
        // Rating head settings (for ranking/multitask models)
        rating_head_layers: mcState.ratingHeadLayers,
        loss_function: mcState.lossFunction,
        // Multitask settings
        retrieval_weight: mcState.retrievalWeight,
        ranking_weight: mcState.rankingWeight,
        // Training params
        optimizer: getSelectedOptimizer(),
        learning_rate: parseFloat(document.getElementById('mcLearningRate').value),
        batch_size: parseInt(document.getElementById('mcBatchSize').value)
    };

    // Determine endpoint based on edit mode
    const isEditing = editingModelConfigId !== null;
    const url = isEditing
        ? `/api/model-configs/${editingModelConfigId}/update/`
        : '/api/model-configs/create/';
    const method = isEditing ? 'PUT' : 'POST';

    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            closeModelConfigWizard();
            loadModelConfigs();
            showToast(isEditing ? 'Model config updated successfully' : 'Model config created successfully', 'success');
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(err => {
        console.error(isEditing ? 'Error updating model config:' : 'Error creating model config:', err);
        alert(isEditing ? 'Error updating model config' : 'Error creating model config');
    });
}

// View Model Config
function viewModelConfig(id) {
    // First try to find in cached list, then fetch full details
    const mcBasic = allModelConfigs.find(c => c.id === id);
    if (!mcBasic) return;

    // Show modal immediately with basic info, then fetch full details
    viewingModelConfig = mcBasic;
    document.getElementById('modelConfigViewModal').classList.remove('hidden');

    // Populate basic info
    document.getElementById('viewMcName').textContent = mcBasic.name;
    document.getElementById('viewMcDesc').textContent = mcBasic.description || 'No description';

    // Update badge with unified style (icon + text)
    const badgeContainer = document.getElementById('viewMcTypeBadge');
    badgeContainer.outerHTML = generateMcTypeBadge(mcBasic.model_type).replace('class="model-type-badge', 'id="viewMcTypeBadge" class="model-type-badge');

    document.getElementById('viewMcUpdatedAt').textContent = formatMcTimeAgo(mcBasic.updated_at);
    if (mcBasic.created_by) {
        document.getElementById('viewMcCreatedBy').textContent = mcBasic.created_by;
        document.getElementById('viewMcCreatedByWrapper').style.display = '';
    } else {
        document.getElementById('viewMcCreatedByWrapper').style.display = 'none';
    }

    // Fetch full details for tower visualization
    fetch(`/api/model-configs/${id}/`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const mc = data.data;
                viewingModelConfig = mc;
                populateViewModal(mc);
            } else {
                // Fallback to basic info
                populateViewModalBasic(mcBasic);
            }
        })
        .catch(err => {
            console.error('Error fetching model config details:', err);
            populateViewModalBasic(mcBasic);
        });
}

// Populate View Modal with full details
function populateViewModal(mc) {
    // Tower stacks - use detailed visualization with aligned layers
    const buyerLayers = mc.buyer_tower_layers || [];
    const productLayers = mc.product_tower_layers || [];
    const towerHtml = renderCardTowerLayers(buyerLayers, productLayers);

    document.getElementById('viewMcBuyerStack').innerHTML = towerHtml.buyer;
    document.getElementById('viewMcProductStack').innerHTML = towerHtml.product;

    // Per-tower parameter summaries
    const buyerParams = calculateSingleTowerParams(buyerLayers);
    const productParams = calculateSingleTowerParams(productLayers);
    document.getElementById('viewMcBuyerTotalParams').textContent = buyerParams.toLocaleString();
    document.getElementById('viewMcBuyerTrainableParams').textContent = buyerParams.toLocaleString();
    document.getElementById('viewMcProductTotalParams').textContent = productParams.toLocaleString();
    document.getElementById('viewMcProductTrainableParams').textContent = productParams.toLocaleString();

    // Combined model summary
    const summary = calculateModelSummary(mc);
    document.getElementById('viewMcTotalParams').textContent = `~${summary.total}`;
    document.getElementById('viewMcTrainableParams').textContent = `~${summary.trainable}`;
    document.getElementById('viewMcNonTrainableParams').textContent = summary.nonTrainable;

    // Training parameters
    document.getElementById('viewMcParams').innerHTML = `
        <div class="param-chip">
            <span class="param-chip-label">Optimizer:</span>
            <span class="param-chip-value">${mc.optimizer_display}</span>
        </div>
        <div class="param-chip">
            <span class="param-chip-label">Learning Rate:</span>
            <span class="param-chip-value">${mc.learning_rate}</span>
        </div>
        <div class="param-chip">
            <span class="param-chip-label">Batch Size:</span>
            <span class="param-chip-value">${mc.batch_size}</span>
        </div>
        <div class="param-chip">
            <span class="param-chip-label">Output Dim:</span>
            <span class="param-chip-value">${mc.output_embedding_dim}D</span>
        </div>
    `;

    // Retrieval algorithm section (for retrieval and multitask models)
    const retrievalSection = document.getElementById('viewMcRetrievalSection');
    if (['retrieval', 'multitask'].includes(mc.model_type)) {
        retrievalSection.classList.remove('hidden');
        document.getElementById('viewMcRetrievalParams').innerHTML = `
            <div class="param-chip retrieval-algo">
                <span class="param-chip-label">Algorithm:</span>
                <span class="param-chip-value">${mc.retrieval_algorithm_display || 'Brute Force'}</span>
            </div>
            <div class="param-chip">
                <span class="param-chip-label">Top-K:</span>
                <span class="param-chip-value">${mc.top_k || 100}</span>
            </div>
            ${mc.retrieval_algorithm === 'scann' ? `
            <div class="param-chip">
                <span class="param-chip-label">Num Leaves:</span>
                <span class="param-chip-value">${mc.scann_num_leaves || 100}</span>
            </div>
            <div class="param-chip">
                <span class="param-chip-label">Leaves to Search:</span>
                <span class="param-chip-value">${mc.scann_leaves_to_search || 10}</span>
            </div>
            ` : ''}
        `;
    } else {
        retrievalSection.classList.add('hidden');
    }

    // Rating Head section (for ranking and multitask models)
    const ratingHeadSection = document.getElementById('viewMcRatingHeadSection');
    if (ratingHeadSection) {
        if (['ranking', 'multitask'].includes(mc.model_type)) {
            ratingHeadSection.classList.remove('hidden');
            const ratingHeadLayers = mc.rating_head_layers || [];
            const ratingHeadSummary = getRatingHeadSummaryFromLayers(ratingHeadLayers);
            const ratingHeadParams = calculateSingleTowerParams(ratingHeadLayers, (mc.output_embedding_dim || 32) * 2);

            document.getElementById('viewMcRatingHeadStack').innerHTML = renderRatingHeadLayersForView(ratingHeadLayers);
            document.getElementById('viewMcRatingHeadTotalParams').textContent = ratingHeadParams.toLocaleString();
            document.getElementById('viewMcRatingHeadTrainableParams').textContent = ratingHeadParams.toLocaleString();

            // Update loss function display
            const lossParams = document.getElementById('viewMcLossParams');
            if (lossParams) {
                lossParams.innerHTML = `
                    <div class="param-chip">
                        <span class="param-chip-label">Loss Function:</span>
                        <span class="param-chip-value">${mc.loss_function_display || 'MSE'}</span>
                    </div>
                `;
            }
        } else {
            ratingHeadSection.classList.add('hidden');
        }
    }

    // Multitask weights section (for multitask models only)
    const multitaskSection = document.getElementById('viewMcMultitaskSection');
    if (multitaskSection) {
        if (mc.model_type === 'multitask') {
            multitaskSection.classList.remove('hidden');
            document.getElementById('viewMcMultitaskParams').innerHTML = `
                <div class="param-chip">
                    <span class="param-chip-label">Retrieval Weight:</span>
                    <span class="param-chip-value">${Math.round((mc.retrieval_weight !== undefined ? mc.retrieval_weight : 1) * 100)}%</span>
                </div>
                <div class="param-chip">
                    <span class="param-chip-label">Ranking Weight:</span>
                    <span class="param-chip-value">${Math.round((mc.ranking_weight !== undefined ? mc.ranking_weight : 1) * 100)}%</span>
                </div>
            `;
        } else {
            multitaskSection.classList.add('hidden');
        }
    }
}

// Helper to render rating head layers for view modal (same style as Buyer/Product towers)
function renderRatingHeadLayersForView(layers) {
    if (!layers || layers.length === 0) {
        return '<div class="text-xs text-gray-400 italic p-2">No layers defined</div>';
    }

    return layers.map((layer, idx) => {
        const isOutput = idx === layers.length - 1 && layer.type === 'dense' && layer.units === 1;
        let badge = '';
        let params = '';

        if (layer.type === 'dense') {
            badge = '<span class="card-layer-badge dense">Dense</span>';
            params = `${layer.units} units`;
            if (layer.activation) params += `, ${layer.activation}`;
            if (layer.l2_reg) params += `, L2=${layer.l2_reg}`;
        } else if (layer.type === 'dropout') {
            badge = '<span class="card-layer-badge dropout">Dropout</span>';
            params = `rate: ${layer.rate}`;
        } else if (layer.type === 'batch_norm') {
            badge = '<span class="card-layer-badge batch_norm">BatchNorm</span>';
            params = '';
        } else if (layer.type === 'layer_norm') {
            badge = '<span class="card-layer-badge layer_norm">LayerNorm</span>';
            params = layer.epsilon ? `: ${layer.epsilon}` : '';
        }

        return `
            <div class="card-layer-item${isOutput ? ' output-layer' : ''}">
                <span class="card-drag-handle"><i class="fas fa-grip-vertical"></i></span>
                ${badge}
                <span class="card-layer-params">${params}</span>
            </div>
        `;
    }).join('');
}

// Populate View Modal with basic info only (fallback)
function populateViewModalBasic(mc) {
    // Tower stacks - parse from summary string, use detailed visualization
    const buyerLayers = parseTowerSummary(mc.buyer_tower_summary);
    const productLayers = parseTowerSummary(mc.product_tower_summary);
    const towerHtml = renderCardTowerLayers(buyerLayers, productLayers);

    document.getElementById('viewMcBuyerStack').innerHTML = towerHtml.buyer;
    document.getElementById('viewMcProductStack').innerHTML = towerHtml.product;

    // Per-tower parameter summaries
    const buyerParams = calculateSingleTowerParams(buyerLayers);
    const productParams = calculateSingleTowerParams(productLayers);
    document.getElementById('viewMcBuyerTotalParams').textContent = buyerParams.toLocaleString();
    document.getElementById('viewMcBuyerTrainableParams').textContent = buyerParams.toLocaleString();
    document.getElementById('viewMcProductTotalParams').textContent = productParams.toLocaleString();
    document.getElementById('viewMcProductTrainableParams').textContent = productParams.toLocaleString();

    // Combined model summary
    const summary = calculateModelSummary(mc);
    document.getElementById('viewMcTotalParams').textContent = `~${summary.total}`;
    document.getElementById('viewMcTrainableParams').textContent = `~${summary.trainable}`;
    document.getElementById('viewMcNonTrainableParams').textContent = summary.nonTrainable;

    // Training parameters
    document.getElementById('viewMcParams').innerHTML = `
        <div class="param-chip">
            <span class="param-chip-label">Optimizer:</span>
            <span class="param-chip-value">${mc.optimizer_display}</span>
        </div>
        <div class="param-chip">
            <span class="param-chip-label">Learning Rate:</span>
            <span class="param-chip-value">${mc.learning_rate}</span>
        </div>
        <div class="param-chip">
            <span class="param-chip-label">Batch Size:</span>
            <span class="param-chip-value">${mc.batch_size}</span>
        </div>
        <div class="param-chip">
            <span class="param-chip-label">Output Dim:</span>
            <span class="param-chip-value">${mc.output_embedding_dim || 32}D</span>
        </div>
    `;

    // Retrieval section (for retrieval and multitask models)
    const retrievalSection = document.getElementById('viewMcRetrievalSection');
    if (['retrieval', 'multitask'].includes(mc.model_type)) {
        retrievalSection.classList.remove('hidden');
        document.getElementById('viewMcRetrievalParams').innerHTML = `
            <div class="param-chip retrieval-algo">
                <span class="param-chip-label">Algorithm:</span>
                <span class="param-chip-value">${mc.retrieval_algorithm_display || 'Brute Force'}</span>
            </div>
            <div class="param-chip">
                <span class="param-chip-label">Top-K:</span>
                <span class="param-chip-value">${mc.top_k || 100}</span>
            </div>
        `;
    } else {
        retrievalSection.classList.add('hidden');
    }

    // Rating Head section (for ranking and multitask models) - hide in basic mode
    const ratingHeadSection = document.getElementById('viewMcRatingHeadSection');
    if (ratingHeadSection) {
        // In basic mode, we don't have detailed layer info, so hide Rating Head
        // The full populateViewModal will handle this when details are loaded
        if (!['ranking', 'multitask'].includes(mc.model_type)) {
            ratingHeadSection.classList.add('hidden');
        }
    }

    // Multitask weights section (for multitask models)
    const multitaskSection = document.getElementById('viewMcMultitaskSection');
    if (multitaskSection) {
        if (mc.model_type === 'multitask') {
            multitaskSection.classList.remove('hidden');
            document.getElementById('viewMcMultitaskParams').innerHTML = `
                <div class="param-chip">
                    <span class="param-chip-label">Retrieval Weight:</span>
                    <span class="param-chip-value">${Math.round((mc.retrieval_weight !== undefined ? mc.retrieval_weight : 1) * 100)}%</span>
                </div>
                <div class="param-chip">
                    <span class="param-chip-label">Ranking Weight:</span>
                    <span class="param-chip-value">${Math.round((mc.ranking_weight !== undefined ? mc.ranking_weight : 1) * 100)}%</span>
                </div>
            `;
        } else {
            multitaskSection.classList.add('hidden');
        }
    }
}

function closeModelConfigViewModal(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('modelConfigViewModal').classList.add('hidden');
    viewingModelConfig = null;
}

// Clone Model Config
function cloneModelConfig() {
    if (!viewingModelConfig) return;
    cloneModelConfigById(viewingModelConfig.id);
    closeModelConfigViewModal();
}

let cloneModelConfigId = null;

function cloneModelConfigById(id) {
    // Find the model config to get its name
    const mc = allModelConfigs.find(c => c.id === id);
    cloneModelConfigId = id;

    const input = document.getElementById('cloneModelConfigName');
    input.value = mc ? `${mc.name} (Copy)` : '';

    document.getElementById('cloneModelConfigModal').classList.remove('hidden');
    input.focus();
    input.select();
}

function closeModelConfigCloneModal() {
    document.getElementById('cloneModelConfigModal').classList.add('hidden');
    cloneModelConfigId = null;
}

function submitModelConfigClone() {
    const newName = document.getElementById('cloneModelConfigName').value.trim();
    if (!newName) {
        alert('Please enter a name for the cloned config');
        return;
    }

    if (!cloneModelConfigId) {
        alert('No model config selected');
        return;
    }

    fetch(`/api/model-configs/${cloneModelConfigId}/clone/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ name: newName })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            closeModelConfigCloneModal();
            loadModelConfigs();
            showToast('Model config cloned successfully', 'success');
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(err => {
        console.error('Error cloning model config:', err);
        alert('Error cloning model config');
    });
}

// =============================================================================
// MODEL CONFIG COMPARE FUNCTIONALITY (Accordion-based UI)
// =============================================================================

let mc_compareLeftConfig = null;
let mc_compareRightConfig = null;

// Track which accordion sections are expanded
let mc_compareExpandedSections = {
    basicInfo: false,
    buyer: false,
    product: false,
    ratingHead: false,
    settings: false
};

function mc_openCompareModal() {
    // Populate dropdowns with all model configs
    const leftSelect = document.getElementById('mcCompareLeftSelect');
    const rightSelect = document.getElementById('mcCompareRightSelect');

    // Clear existing options except placeholder
    leftSelect.innerHTML = '<option value="">Select model config...</option>';
    rightSelect.innerHTML = '<option value="">Select model config...</option>';

    // Add all configs to both dropdowns
    allModelConfigs.forEach(config => {
        const optionLeft = document.createElement('option');
        optionLeft.value = config.id;
        optionLeft.textContent = config.name;
        leftSelect.appendChild(optionLeft);

        const optionRight = document.createElement('option');
        optionRight.value = config.id;
        optionRight.textContent = config.name;
        rightSelect.appendChild(optionRight);
    });

    // Reset to placeholder state
    mc_resetCompareColumn('left');
    mc_resetCompareColumn('right');

    // Reset accordion states - collapse all
    mc_compareExpandedSections = {
        basicInfo: false,
        buyer: false,
        product: false,
        ratingHead: false,
        settings: false
    };
    mc_syncCompareAccordionStates();

    // Reset state
    mc_compareLeftConfig = null;
    mc_compareRightConfig = null;

    // Hide Rating Head section by default
    document.getElementById('mcCompareRatingHeadSection').classList.add('hidden');

    // Show modal
    document.getElementById('compareModelConfigsModal').classList.remove('hidden');
}

function mc_closeCompareModal() {
    document.getElementById('compareModelConfigsModal').classList.add('hidden');
    mc_compareLeftConfig = null;
    mc_compareRightConfig = null;
}

// Toggle accordion section
function mc_toggleCompareSection(sectionName) {
    mc_compareExpandedSections[sectionName] = !mc_compareExpandedSections[sectionName];
    mc_syncCompareAccordionStates();
}

// Sync accordion visual states with tracked state
function mc_syncCompareAccordionStates() {
    const sections = ['basicInfo', 'buyer', 'product', 'ratingHead', 'settings'];

    sections.forEach(section => {
        const contentId = `mcCompare${section.charAt(0).toUpperCase() + section.slice(1)}Content`;
        const chevronId = `mcCompare${section.charAt(0).toUpperCase() + section.slice(1)}Chevron`;

        const content = document.getElementById(contentId);
        const chevron = document.getElementById(chevronId);

        if (content && chevron) {
            if (mc_compareExpandedSections[section]) {
                content.classList.remove('hidden');
                chevron.classList.add('expanded');
            } else {
                content.classList.add('hidden');
                chevron.classList.remove('expanded');
            }
        }
    });
}

function mc_resetCompareColumn(side) {
    const prefix = side === 'left' ? 'mcCompareLeft' : 'mcCompareRight';

    // Reset BasicInfo
    document.getElementById(`${prefix}BasicInfo`).innerHTML = `
        <div class="ds-compare-placeholder">Select a model config</div>
    `;

    // Reset Buyer
    document.getElementById(`${prefix}Buyer`).innerHTML = `
        <div class="ds-compare-placeholder">Select a model config</div>
    `;

    // Reset Product
    document.getElementById(`${prefix}Product`).innerHTML = `
        <div class="ds-compare-placeholder">Select a model config</div>
    `;

    // Reset Rating Head
    document.getElementById(`${prefix}RatingHead`).innerHTML = `
        <div class="ds-compare-placeholder">Select a model config</div>
    `;

    // Reset Settings
    document.getElementById(`${prefix}Settings`).innerHTML = `
        <div class="ds-compare-placeholder">Select a model config</div>
    `;
}

function mc_onCompareSelectChange(side) {
    const selectId = side === 'left' ? 'mcCompareLeftSelect' : 'mcCompareRightSelect';
    const configId = document.getElementById(selectId).value;

    if (!configId) {
        // Reset this side
        mc_resetCompareColumn(side);
        if (side === 'left') mc_compareLeftConfig = null;
        else mc_compareRightConfig = null;
        mc_updateCompareStatuses();
        mc_updateRatingHeadVisibility();
        return;
    }

    // Show loading state
    const prefix = side === 'left' ? 'mcCompareLeft' : 'mcCompareRight';
    document.getElementById(`${prefix}BasicInfo`).innerHTML = `
        <div class="ds-compare-placeholder">
            <i class="fas fa-spinner fa-spin mr-2"></i>Loading...
        </div>
    `;

    // Fetch config data
    fetch(`/api/model-configs/${configId}/`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const config = data.data;
                if (side === 'left') mc_compareLeftConfig = config;
                else mc_compareRightConfig = config;
                mc_renderCompareColumn(config, side);
                mc_updateCompareStatuses();
                mc_updateRatingHeadVisibility();
            } else {
                document.getElementById(`${prefix}BasicInfo`).innerHTML = `
                    <div class="ds-compare-placeholder" style="color: #ef4444;">
                        Failed to load
                    </div>
                `;
            }
        })
        .catch(err => {
            console.error('Error loading model config:', err);
            document.getElementById(`${prefix}BasicInfo`).innerHTML = `
                <div class="ds-compare-placeholder" style="color: #ef4444;">
                    Error loading
                </div>
            `;
        });
}

// Show/hide Rating Head section based on model types
function mc_updateRatingHeadVisibility() {
    const left = mc_compareLeftConfig;
    const right = mc_compareRightConfig;

    const leftHasRatingHead = ['ranking', 'multitask'].includes(left?.model_type);
    const rightHasRatingHead = ['ranking', 'multitask'].includes(right?.model_type);

    const ratingHeadSection = document.getElementById('mcCompareRatingHeadSection');
    if (leftHasRatingHead || rightHasRatingHead) {
        ratingHeadSection.classList.remove('hidden');
    } else {
        ratingHeadSection.classList.add('hidden');
    }
}

// Update status badges in accordion headers
function mc_updateCompareStatuses() {
    const left = mc_compareLeftConfig;
    const right = mc_compareRightConfig;

    // Basic Info status
    const basicInfoStatus = document.getElementById('mcCompareBasicInfoStatus');
    if (left && right) {
        const diffs = [];
        if (left.name !== right.name) diffs.push('name');
        if (left.model_type !== right.model_type) diffs.push('type');
        basicInfoStatus.textContent = diffs.length > 0 ? `${diffs.length} difference${diffs.length > 1 ? 's' : ''}` : '';
    } else {
        basicInfoStatus.textContent = '';
    }

    // Buyer Tower status
    const buyerStatus = document.getElementById('mcCompareBuyerStatus');
    if (left && right) {
        const leftLayers = left.buyer_tower_layers || [];
        const rightLayers = right.buyer_tower_layers || [];
        if (leftLayers.length !== rightLayers.length) {
            buyerStatus.textContent = `${leftLayers.length} vs ${rightLayers.length} layers`;
        } else if (mc_towersAreDifferent(leftLayers, rightLayers)) {
            buyerStatus.textContent = 'Different';
        } else {
            buyerStatus.textContent = '';
        }
    } else {
        buyerStatus.textContent = '';
    }

    // Product Tower status
    const productStatus = document.getElementById('mcCompareProductStatus');
    if (left && right) {
        const leftLayers = left.product_tower_layers || [];
        const rightLayers = right.product_tower_layers || [];
        if (leftLayers.length !== rightLayers.length) {
            productStatus.textContent = `${leftLayers.length} vs ${rightLayers.length} layers`;
        } else if (mc_towersAreDifferent(leftLayers, rightLayers)) {
            productStatus.textContent = 'Different';
        } else {
            productStatus.textContent = '';
        }
    } else {
        productStatus.textContent = '';
    }

    // Rating Head status
    const ratingHeadStatus = document.getElementById('mcCompareRatingHeadStatus');
    const leftHasRatingHead = ['ranking', 'multitask'].includes(left?.model_type);
    const rightHasRatingHead = ['ranking', 'multitask'].includes(right?.model_type);
    if (left && right) {
        if (leftHasRatingHead && rightHasRatingHead) {
            const leftLayers = left.rating_head_layers || [];
            const rightLayers = right.rating_head_layers || [];
            if (leftLayers.length !== rightLayers.length) {
                ratingHeadStatus.textContent = `${leftLayers.length} vs ${rightLayers.length} layers`;
            } else if (mc_towersAreDifferent(leftLayers, rightLayers)) {
                ratingHeadStatus.textContent = 'Different';
            } else {
                ratingHeadStatus.textContent = '';
            }
        } else if (leftHasRatingHead !== rightHasRatingHead) {
            ratingHeadStatus.textContent = 'N/A vs layers';
        } else {
            ratingHeadStatus.textContent = '';
        }
    } else {
        ratingHeadStatus.textContent = '';
    }

    // Settings status
    const settingsStatus = document.getElementById('mcCompareSettingsStatus');
    if (left && right) {
        let diffCount = 0;
        if (left.optimizer !== right.optimizer) diffCount++;
        if (left.learning_rate !== right.learning_rate) diffCount++;
        if (left.batch_size !== right.batch_size) diffCount++;
        if (left.output_embedding_dim !== right.output_embedding_dim) diffCount++;
        settingsStatus.textContent = diffCount > 0 ? `${diffCount} difference${diffCount > 1 ? 's' : ''}` : '';
    } else {
        settingsStatus.textContent = '';
    }
}

// Check if two towers are different
function mc_towersAreDifferent(layers1, layers2) {
    if (layers1.length !== layers2.length) return true;
    for (let i = 0; i < layers1.length; i++) {
        if (mc_layersAreDifferent(layers1[i], layers2[i])) return true;
    }
    return false;
}

// Check if two layers are different
function mc_layersAreDifferent(layer1, layer2) {
    if (!layer1 || !layer2) return true;
    if (layer1.type !== layer2.type) return true;

    if (layer1.type === 'dense') {
        if (layer1.units !== layer2.units) return true;
        if (layer1.activation !== layer2.activation) return true;
        const l2_1 = layer1.l2_regularization || layer1.l2_reg || 0;
        const l2_2 = layer2.l2_regularization || layer2.l2_reg || 0;
        if (l2_1 !== l2_2) return true;
    } else if (layer1.type === 'dropout') {
        if (layer1.rate !== layer2.rate) return true;
    } else if (layer1.type === 'layer_norm') {
        if (layer1.epsilon !== layer2.epsilon) return true;
    }

    return false;
}

function mc_renderCompareColumn(config, side) {
    const prefix = side === 'left' ? 'mcCompareLeft' : 'mcCompareRight';

    // Render BasicInfo
    document.getElementById(`${prefix}BasicInfo`).innerHTML = `
        <div class="flex items-start justify-between">
            <div>
                <h4 class="font-semibold text-gray-900 mb-1">${escapeHtml(config.name)}</h4>
                ${config.description ? `<div class="text-sm text-gray-500 mb-2">${escapeHtml(config.description)}</div>` : ''}
            </div>
            ${mc_generateTypeBadge(config.model_type)}
        </div>
    `;

    // Render Settings
    document.getElementById(`${prefix}Settings`).innerHTML = mc_renderSettingsCard(config);

    // Re-render all tower sections with aligned layers (both sides)
    mc_renderAlignedTowers();
}

// Render all tower sections with aligned layers
function mc_renderAlignedTowers() {
    const left = mc_compareLeftConfig;
    const right = mc_compareRightConfig;

    // Render Buyer Tower (aligned)
    mc_renderAlignedTowerSection(
        'Buyer',
        left?.buyer_tower_layers || [],
        right?.buyer_tower_layers || [],
        'buyer',
        left,
        right
    );

    // Render Product Tower (aligned)
    mc_renderAlignedTowerSection(
        'Product',
        left?.product_tower_layers || [],
        right?.product_tower_layers || [],
        'product',
        left,
        right
    );

    // Render Rating Head (aligned) - only if at least one side has it
    const leftHasRatingHead = ['ranking', 'multitask'].includes(left?.model_type);
    const rightHasRatingHead = ['ranking', 'multitask'].includes(right?.model_type);

    mc_renderAlignedTowerSection(
        'RatingHead',
        leftHasRatingHead ? (left?.rating_head_layers || []) : [],
        rightHasRatingHead ? (right?.rating_head_layers || []) : [],
        'ratingHead',
        left,
        right,
        !leftHasRatingHead,  // leftNA
        !rightHasRatingHead  // rightNA
    );
}

// Render a tower section with aligned layers (both sides together)
function mc_renderAlignedTowerSection(sectionName, leftLayers, rightLayers, towerType, leftConfig, rightConfig, leftNA = false, rightNA = false) {
    const leftCell = document.getElementById(`mcCompareLeft${sectionName}`);
    const rightCell = document.getElementById(`mcCompareRight${sectionName}`);

    if (!leftCell || !rightCell) return;

    const colorScheme = {
        buyer: {
            dashedBorder: 'border-blue-300',
            bg: 'bg-blue-50',
            layerBorder: 'border-blue-200',
            outputBorder: 'border-red-400',
            outputBg: 'bg-blue-100',
            text: 'text-blue-700',
            paramsBg: 'bg-blue-50'
        },
        product: {
            dashedBorder: 'border-green-300',
            bg: 'bg-green-50',
            layerBorder: 'border-green-200',
            outputBorder: 'border-red-400',
            outputBg: 'bg-green-100',
            text: 'text-green-700',
            paramsBg: 'bg-green-50'
        },
        ratingHead: {
            dashedBorder: 'border-purple-300',
            bg: 'bg-purple-50',
            layerBorder: 'border-purple-200',
            outputBorder: 'border-red-400',
            outputBg: 'bg-purple-100',
            text: 'text-purple-700',
            paramsBg: 'bg-purple-50'
        }
    };
    const colors = colorScheme[towerType] || colorScheme.buyer;

    // Handle N/A cases
    if (!leftConfig && !rightConfig) {
        leftCell.innerHTML = '<div class="ds-compare-placeholder">Select a model config</div>';
        rightCell.innerHTML = '<div class="ds-compare-placeholder">Select a model config</div>';
        return;
    }

    // Handle left N/A
    if (leftNA && leftConfig) {
        leftCell.innerHTML = `
            <div class="mc-tower-wrapper">
                <div class="mc-tower-na">N/A for ${leftConfig.model_type || 'retrieval'} model</div>
            </div>
        `;
    } else if (!leftConfig) {
        leftCell.innerHTML = '<div class="ds-compare-placeholder">Select a model config</div>';
    } else {
        // Align layers: output layer at bottom
        const alignedRows = mc_alignLayers(leftLayers, rightLayers);
        const leftParams = mc_calculateTowerParams(leftLayers);

        leftCell.innerHTML = `
            <div class="mc-tower-wrapper">
                <div class="mc-tower-layers">
                    ${alignedRows.map((row, idx) => {
                        const isOutput = idx === alignedRows.length - 1 && row.left;
                        return mc_renderAlignedLayerCell(row.left, isOutput, colors, idx === alignedRows.length - 1);
                    }).join('')}
                </div>
                <div class="mc-tower-params">
                    <div class="mc-param-row"><span class="mc-param-label">Total params:</span><span class="mc-param-value">${leftParams.toLocaleString()}</span></div>
                </div>
            </div>
        `;
    }

    // Handle right N/A
    if (rightNA && rightConfig) {
        rightCell.innerHTML = `
            <div class="mc-tower-wrapper">
                <div class="mc-tower-na">N/A for ${rightConfig.model_type || 'retrieval'} model</div>
            </div>
        `;
    } else if (!rightConfig) {
        rightCell.innerHTML = '<div class="ds-compare-placeholder">Select a model config</div>';
    } else {
        // Align layers: output layer at bottom
        const alignedRows = mc_alignLayers(leftLayers, rightLayers);
        const rightParams = mc_calculateTowerParams(rightLayers);

        rightCell.innerHTML = `
            <div class="mc-tower-wrapper">
                <div class="mc-tower-layers">
                    ${alignedRows.map((row, idx) => {
                        const isOutput = idx === alignedRows.length - 1 && row.right;
                        return mc_renderAlignedLayerCell(row.right, isOutput, colors, idx === alignedRows.length - 1);
                    }).join('')}
                </div>
                <div class="mc-tower-params">
                    <div class="mc-param-row"><span class="mc-param-label">Total params:</span><span class="mc-param-value">${rightParams.toLocaleString()}</span></div>
                </div>
            </div>
        `;
    }
}

// Align two layer arrays with output layers at the bottom
function mc_alignLayers(leftLayers, rightLayers) {
    const result = [];

    if (leftLayers.length === 0 && rightLayers.length === 0) {
        return [{ left: null, right: null }];
    }

    // Separate output layers (last layer) from regular layers
    const leftRegular = leftLayers.length > 0 ? leftLayers.slice(0, -1) : [];
    const leftOutput = leftLayers.length > 0 ? leftLayers[leftLayers.length - 1] : null;
    const rightRegular = rightLayers.length > 0 ? rightLayers.slice(0, -1) : [];
    const rightOutput = rightLayers.length > 0 ? rightLayers[rightLayers.length - 1] : null;

    // Calculate max regular layers
    const maxRegular = Math.max(leftRegular.length, rightRegular.length);

    // Add regular layers with placeholders
    for (let i = 0; i < maxRegular; i++) {
        result.push({
            left: i < leftRegular.length ? leftRegular[i] : null,
            right: i < rightRegular.length ? rightRegular[i] : null
        });
    }

    // Add output layer row (always aligned at bottom)
    if (leftOutput || rightOutput) {
        result.push({
            left: leftOutput,
            right: rightOutput
        });
    }

    return result;
}

// Render a single aligned layer cell
function mc_renderAlignedLayerCell(layer, isOutput, colors, isLastRow) {
    if (!layer) {
        // Empty placeholder to maintain alignment
        return `<div class="mc-layer-card mc-layer-placeholder"></div>`;
    }

    let badge = '';
    let params = '';

    if (layer.type === 'dense') {
        badge = '<span class="mc-layer-badge dense">DENSE</span>';
        params = `${layer.units} units, ${layer.activation || 'relu'}`;
        const l2 = layer.l2_regularization || layer.l2_reg;
        if (l2) params += `, L2=${l2}`;
    } else if (layer.type === 'dropout') {
        badge = '<span class="mc-layer-badge dropout">DROPOUT</span>';
        params = `rate: ${layer.rate}`;
    } else if (layer.type === 'batch_norm') {
        badge = '<span class="mc-layer-badge batch_norm">BATCHNORM</span>';
        params = '';
    } else if (layer.type === 'layer_norm') {
        badge = '<span class="mc-layer-badge layer_norm">LAYERNORM</span>';
        params = layer.epsilon ? `: ${layer.epsilon}` : '';
    }

    const outputClass = isOutput && isLastRow
        ? `mc-layer-output ${colors.outputBg} ${colors.outputBorder}`
        : `${colors.bg} ${colors.layerBorder}`;

    return `
        <div class="mc-layer-card ${outputClass}">
            ${badge}
            <span class="mc-layer-params-text">${params}</span>
        </div>
    `;
}

// Generate model type badge
function mc_generateTypeBadge(modelType) {
    const types = {
        retrieval: { label: 'Retrieval', color: 'bg-blue-100 text-blue-700' },
        ranking: { label: 'Ranking', color: 'bg-purple-100 text-purple-700' },
        multitask: { label: 'Multitask', color: 'bg-orange-100 text-orange-700' }
    };
    const typeInfo = types[modelType] || { label: modelType, color: 'bg-gray-100 text-gray-700' };
    return `<span class="px-2 py-1 rounded text-xs font-medium ${typeInfo.color}">${typeInfo.label}</span>`;
}

// Calculate tower params
function mc_calculateTowerParams(layers) {
    let total = 0;
    let prevUnits = 0;

    layers.forEach(layer => {
        if (layer.type === 'dense') {
            const inputDim = prevUnits || 64; // Default input dim
            total += (inputDim * layer.units) + layer.units;
            prevUnits = layer.units;
        }
    });

    return total;
}

// Render settings card
function mc_renderSettingsCard(config) {
    const settings = [
        { label: 'Optimizer', value: config.optimizer_display || config.optimizer || '-' },
        { label: 'Learning Rate', value: config.learning_rate || '-' },
        { label: 'Batch Size', value: config.batch_size || '-' },
        { label: 'Output Dim', value: config.output_embedding_dim ? `${config.output_embedding_dim}D` : '-' }
    ];

    // Add model-specific settings
    const hasRetrieval = ['retrieval', 'multitask'].includes(config.model_type);
    const hasRanking = ['ranking', 'multitask'].includes(config.model_type);

    if (hasRetrieval) {
        settings.push({ label: 'Algorithm', value: config.retrieval_algorithm_display || config.retrieval_algorithm || 'Brute Force' });
        settings.push({ label: 'Top-K', value: config.top_k || 100 });
    }

    if (hasRanking) {
        settings.push({ label: 'Loss Function', value: config.loss_function_display || config.loss_function || 'MSE' });
    }

    if (config.model_type === 'multitask') {
        const formatWeight = (w) => w != null ? `${Math.round(w * 100)}%` : '-';
        settings.push({ label: 'Retrieval Weight', value: formatWeight(config.retrieval_weight) });
        settings.push({ label: 'Ranking Weight', value: formatWeight(config.ranking_weight) });
    }

    return `
        <div class="space-y-1">
            ${settings.map(s => `
                <div class="flex justify-between text-sm">
                    <span class="text-gray-500">${s.label}</span>
                    <span class="font-medium text-gray-700">${s.value}</span>
                </div>
            `).join('')}
        </div>
    `;
}

// Delete Model Config
function deleteModelConfig(id) {
    if (!confirm('Are you sure you want to delete this model config?')) return;

    fetch(`/api/model-configs/${id}/delete/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            loadModelConfigs();
            showToast('Model config deleted', 'success');
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(err => {
        console.error('Error deleting model config:', err);
        alert('Error deleting model config');
    });
}

// Edit Model Config (opens wizard in edit mode) - from View modal
function editModelConfig() {
    if (!viewingModelConfig) return;
    editModelConfigById(viewingModelConfig.id);
    closeModelConfigViewModal();
}

// Helper: Escape HTML
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Helper: Show Toast (if not already defined)
if (typeof showToast !== 'function') {
    function showToast(message, type) {
        console.log(`[${type}] ${message}`);
    }
}
</script>
{% endblock %}
