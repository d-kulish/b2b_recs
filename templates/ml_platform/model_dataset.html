{% extends 'base_model.html' %}
{% load humanize %}
{% load static %}

{% block title %}{{ model.name }} - Dataset Manager{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/cards.css' %}?v=4">
<link rel="stylesheet" href="{% static 'css/modals.css' %}?v=2">
{% endblock %}

{% block model_content %}
<div class="space-y-6">
    <!-- Dataset Manager Container -->
    <div class="bg-white rounded-xl border border-black shadow-lg p-6">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-gray-900">Dataset Manager</h2>
            <div class="btn-group">
                <button onclick="refreshDatasets()" class="btn btn-secondary btn-sm" style="width: 140px;">
                    <i class="fas fa-sync-alt"></i>Refresh
                </button>
                <button onclick="openWizard()" class="btn btn-primary btn-sm" style="width: 140px;">
                    <i class="fas fa-plus"></i>New Dataset
                </button>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="flex items-center gap-4 mb-4">
            <div class="flex items-center gap-2">
                <label class="text-sm font-medium text-gray-600">Status:</label>
                <select id="statusFilter" onchange="filterDatasets()" class="form-select text-sm" style="width: 120px;">
                    <option value="">All</option>
                    <option value="draft">Draft</option>
                    <option value="active">Active</option>
                </select>
            </div>
            <div class="flex-1">
                <input type="text" id="searchInput" placeholder="Search datasets..."
                       class="form-input w-full text-sm" onkeyup="debounceSearch()">
            </div>
        </div>

        <!-- Datasets List Container -->
        <div id="datasetsList" class="space-y-3" style="min-height: 200px;">
            <!-- Dataset cards will be inserted here by JavaScript -->
            <div class="card-empty-state">
                <p class="card-empty-state-title">No datasets configured</p>
                <p class="card-empty-state-text">Create your first dataset to define training data for your ML models</p>
            </div>
        </div>

        <!-- Pagination -->
        <div id="paginationContainer" class="hidden mt-4 pt-4 border-t border-gray-200">
            <div class="flex items-center justify-between">
                <div id="paginationInfo" class="text-sm text-gray-600"></div>
                <div id="paginationButtons" class="flex items-center gap-2"></div>
            </div>
        </div>
    </div>
</div>

<!-- Dataset Wizard Modal -->
<div id="datasetWizardModal" class="modal-overlay hidden">
    <div class="modal-container modal-container-wizard modal-dataset-wizard">
        <!-- Modal Header -->
        <div class="modal-header-wizard">
            <div class="modal-header-content">
                <div class="modal-header-icon info">
                    <i class="fas fa-table text-lg"></i>
                </div>
                <div class="modal-header-info">
                    <h3 class="modal-header-title" id="wizardTitle">Create Dataset</h3>
                    <p class="modal-step-counter">Step <span id="currentStep">1</span> of 5</p>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="modal-progress-bar">
                <div id="progress1" class="modal-progress-segment active"></div>
                <div id="progress2" class="modal-progress-segment"></div>
                <div id="progress3" class="modal-progress-segment"></div>
                <div id="progress4" class="modal-progress-segment"></div>
                <div id="progress5" class="modal-progress-segment"></div>
            </div>
        </div>

        <!-- Modal Body -->
        <div class="modal-body-wizard">
            <!-- Step 1: Basic Info -->
            <div id="step1" class="wizard-step active">
                <h4 class="wizard-section-title">Basic Information</h4>

                <!-- Dataset Name -->
                <div class="wizard-field-group">
                    <label class="wizard-field-label">Dataset Name <span class="required">*</span></label>
                    <input type="text" id="datasetName" placeholder="e.g., Transactions Q4 2024"
                           class="form-input w-full" oninput="validateDatasetName()">
                    <p id="nameError" class="text-xs text-red-600 mt-1 hidden"></p>
                    <p id="nameSuccess" class="text-xs text-green-600 mt-1 hidden">
                        <i class="fas fa-check-circle mr-1"></i>Name is available
                    </p>
                </div>

                <!-- Description -->
                <div class="wizard-field-group">
                    <label class="wizard-field-label">Description <span class="optional">(optional)</span></label>
                    <textarea id="datasetDescription" placeholder="Describe the purpose of this dataset..."
                              class="form-textarea w-full" rows="3"></textarea>
                </div>

                <div class="wizard-info-box info">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>What is a Dataset?</strong><br>
                        A dataset defines which BigQuery tables, columns, and filters to use for training your ML models.
                    </div>
                </div>
            </div>

            <!-- Step 2: Source Tables -->
            <div id="step2" class="wizard-step">
                <h4 class="wizard-section-title">Select Source Tables</h4>
                <p class="wizard-section-subtitle">Choose tables from your BigQuery raw_data dataset.</p>

                <!-- Primary Table -->
                <div class="wizard-field-group">
                    <label class="wizard-field-label">Primary Table <span class="required">*</span></label>
                    <div class="wizard-list-container">
                        <div id="primaryTableList" class="list-content" style="max-height: 160px;">
                            <p class="text-center text-gray-500 py-4">
                                <i class="fas fa-spinner fa-spin mr-2"></i>Loading tables...
                            </p>
                        </div>
                    </div>
                    <p class="wizard-field-hint">
                        <i class="fas fa-info-circle mr-1"></i>
                        The primary table contains your main transaction/interaction data.
                    </p>
                </div>

                <!-- Secondary Tables -->
                <div class="wizard-field-group">
                    <label class="wizard-field-label">Secondary Tables <span class="optional">(optional)</span></label>
                    <div class="wizard-list-container">
                        <div id="secondaryTableList" class="list-content" style="max-height: 140px;">
                            <p class="text-center text-gray-500 py-4">Select a primary table first</p>
                        </div>
                    </div>
                    <p class="wizard-field-hint">
                        <i class="fas fa-link mr-1"></i>
                        Additional tables to join (e.g., products, customers). You'll configure joins in the next step.
                    </p>
                </div>
            </div>

            <!-- Step 3: Visual Schema Builder -->
            <div id="step3" class="wizard-step">
                <div class="schema-builder-container">
                    <!-- Header with title and auto-detect button -->
                    <div class="schema-builder-header">
                        <div>
                            <h4 class="wizard-section-title" style="margin-bottom: 2px;">Schema Builder</h4>
                            <p class="wizard-section-subtitle" style="margin-bottom: 0;">Connect tables and select columns for your dataset.</p>
                        </div>
                        <button onclick="autoDetectJoins()" class="schema-auto-detect-btn" id="autoDetectBtn">
                            <i class="fas fa-magic"></i> Auto-detect
                        </button>
                    </div>

                    <!-- Table Cards Area -->
                    <div class="schema-cards-area" id="schemaCardsArea">
                        <!-- SVG for connection lines -->
                        <svg class="schema-connections-svg" id="connectionsSvg"></svg>

                        <!-- Table cards container -->
                        <div class="schema-cards-container" id="schemaCardsContainer">
                            <!-- Loading state -->
                            <div class="schema-loading" id="schemaLoading">
                                <i class="fas fa-spinner fa-spin"></i>
                                Loading table samples...
                            </div>
                        </div>
                    </div>

                    <!-- Preview Section -->
                    <div class="schema-preview-section">
                        <!-- Stats bar -->
                        <div class="schema-preview-stats" id="previewStats">
                            <div class="stat-item">
                                <span>Preview:</span>
                                <span class="stat-value" id="previewRowCount">-</span>
                                <span>rows</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value" id="previewColCount">-</span>
                                <span>columns</span>
                            </div>
                            <div class="stat-item" id="previewWarnings" style="display: none;">
                                <i class="fas fa-exclamation-triangle stat-warning"></i>
                                <span class="stat-warning" id="previewWarningText"></span>
                            </div>
                        </div>

                        <!-- Preview table -->
                        <div class="schema-preview-table-container" id="previewTableContainer">
                            <div class="schema-preview-empty" id="previewEmpty">
                                <i class="fas fa-table"></i>
                                Select columns to see a preview of your dataset
                            </div>
                            <table class="schema-preview-table" id="previewTable" style="display: none;">
                                <thead id="previewTableHead"></thead>
                                <tbody id="previewTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Join Popover (hidden by default) -->
                <div class="join-popover hidden" id="joinPopover">
                    <div class="join-popover-header">Join Type</div>
                    <div class="join-popover-option" data-type="left" onclick="setJoinType('left')">
                        <i class="fas fa-check"></i> LEFT JOIN
                    </div>
                    <div class="join-popover-option" data-type="inner" onclick="setJoinType('inner')">
                        <i class="fas fa-check"></i> INNER JOIN
                    </div>
                    <div class="join-popover-option danger" onclick="removeSelectedJoin()">
                        <i class="fas fa-trash"></i> Remove
                    </div>
                </div>
            </div>

            <!-- Step 4: ML Column Mapping -->
            <div id="step4" class="wizard-step">
                <h4 class="wizard-section-title">ML Column Mapping</h4>
                <p class="wizard-section-subtitle">Map your columns to ML concepts for the recommendation model.</p>

                <!-- ML Column Suggestions -->
                <div id="mlSuggestions" class="wizard-info-box success hidden">
                    <i class="fas fa-lightbulb"></i>
                    <div id="mlSuggestionsText">
                        <!-- Will be populated with suggestions -->
                    </div>
                </div>

                <!-- ML Role Mapping -->
                <div class="wizard-field-group">
                    <label class="wizard-field-label">Required Columns</label>
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs font-medium text-gray-600 mb-1 block">User ID Column <span class="required">*</span></label>
                            <select id="userIdColumn" class="form-select w-full text-sm" onchange="validateCurrentStep()">
                                <option value="">Select column...</option>
                            </select>
                            <p class="wizard-field-hint mt-1">
                                <i class="fas fa-user mr-1"></i>
                                Column that uniquely identifies each customer/user.
                            </p>
                        </div>
                        <div>
                            <label class="text-xs font-medium text-gray-600 mb-1 block">Product ID Column <span class="required">*</span></label>
                            <select id="productIdColumn" class="form-select w-full text-sm" onchange="validateCurrentStep()">
                                <option value="">Select column...</option>
                            </select>
                            <p class="wizard-field-hint mt-1">
                                <i class="fas fa-box mr-1"></i>
                                Column that uniquely identifies each product/item.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="wizard-field-group">
                    <label class="wizard-field-label">Optional Columns</label>
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs font-medium text-gray-600 mb-1 block">Revenue Column <span class="optional">(optional)</span></label>
                            <select id="revenueColumn" class="form-select w-full text-sm" onchange="validateCurrentStep()">
                                <option value="">Select column...</option>
                            </select>
                            <p class="wizard-field-hint mt-1">
                                <i class="fas fa-dollar-sign mr-1"></i>
                                Column containing transaction value/amount. Used for weighted recommendations.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 5: Filters & Split -->
            <div id="step5" class="wizard-step">
                <h4 class="wizard-section-title">Filters & Train/Eval Split</h4>
                <p class="wizard-section-subtitle">Configure data filters and how to split data for training.</p>

                <!-- Date Range Filter -->
                <div class="wizard-field-group">
                    <label class="wizard-field-label">Date Range Filter</label>
                    <div class="space-y-2">
                        <label class="wizard-selection-card">
                            <input type="radio" name="dateRangeType" value="rolling" checked onchange="onDateRangeTypeChange()">
                            <div class="card-content">
                                <div class="card-title">Rolling Window</div>
                                <div class="card-description">Last N months of data</div>
                            </div>
                        </label>
                        <label class="wizard-selection-card">
                            <input type="radio" name="dateRangeType" value="fixed" onchange="onDateRangeTypeChange()">
                            <div class="card-content">
                                <div class="card-title">Fixed Date Range</div>
                                <div class="card-description">Specific start and end dates</div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Rolling Window Config -->
                <div id="rollingConfig" class="wizard-field-group">
                    <label class="text-xs font-medium text-gray-600 mb-1 block">Number of Months</label>
                    <select id="rollingMonths" class="form-select w-full text-sm">
                        <option value="3">Last 3 months</option>
                        <option value="6" selected>Last 6 months</option>
                        <option value="12">Last 12 months</option>
                        <option value="24">Last 24 months</option>
                    </select>
                </div>

                <!-- Fixed Date Config -->
                <div id="fixedDateConfig" class="wizard-field-group hidden">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-xs font-medium text-gray-600 mb-1 block">Start Date</label>
                            <input type="date" id="startDate" class="form-input w-full text-sm">
                        </div>
                        <div>
                            <label class="text-xs font-medium text-gray-600 mb-1 block">End Date</label>
                            <input type="date" id="endDate" class="form-input w-full text-sm">
                        </div>
                    </div>
                </div>

                <!-- Advanced Filters (collapsed by default) -->
                <div class="wizard-field-group">
                    <button type="button" onclick="toggleAdvancedFilters()" class="text-sm text-blue-600 hover:text-blue-800 flex items-center">
                        <i id="advancedFiltersIcon" class="fas fa-chevron-right mr-2 transition-transform"></i>
                        Advanced Filters
                    </button>
                    <div id="advancedFilters" class="hidden mt-3 space-y-3">
                        <!-- Top Products Filter -->
                        <div class="flex items-center gap-3">
                            <input type="checkbox" id="enableTopProducts" onchange="toggleTopProductsInput()">
                            <label class="text-sm text-gray-700">Only include top</label>
                            <input type="number" id="topProductsPercent" value="80" min="1" max="100"
                                   class="form-input w-20 text-sm" disabled>
                            <span class="text-sm text-gray-700">% products by revenue</span>
                        </div>
                        <!-- Min Transactions Filter -->
                        <div class="flex items-center gap-3">
                            <input type="checkbox" id="enableMinTransactions" onchange="toggleMinTransactionsInput()">
                            <label class="text-sm text-gray-700">Minimum</label>
                            <input type="number" id="minTransactions" value="2" min="1"
                                   class="form-input w-20 text-sm" disabled>
                            <span class="text-sm text-gray-700">transactions per customer</span>
                        </div>
                    </div>
                </div>

                <!-- Train/Eval Split -->
                <div class="wizard-field-group">
                    <label class="wizard-field-label">Train/Eval Split Strategy</label>
                    <div class="space-y-2">
                        <label class="wizard-selection-card">
                            <input type="radio" name="splitStrategy" value="time_based" checked onchange="onSplitStrategyChange()">
                            <div class="card-content">
                                <div class="card-title">Time-Based Split</div>
                                <div class="card-description">Use last N days for evaluation</div>
                            </div>
                        </label>
                        <label class="wizard-selection-card">
                            <input type="radio" name="splitStrategy" value="random" onchange="onSplitStrategyChange()">
                            <div class="card-content">
                                <div class="card-title">Random Split</div>
                                <div class="card-description">Random percentage for train/eval</div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Time-Based Split Config -->
                <div id="timeBasedConfig" class="wizard-field-group">
                    <label class="text-xs font-medium text-gray-600 mb-1 block">Evaluation Days</label>
                    <select id="evalDays" class="form-select w-full text-sm">
                        <option value="7">Last 7 days for evaluation</option>
                        <option value="14" selected>Last 14 days for evaluation</option>
                        <option value="30">Last 30 days for evaluation</option>
                    </select>
                </div>

                <!-- Random Split Config -->
                <div id="randomSplitConfig" class="wizard-field-group hidden">
                    <label class="text-xs font-medium text-gray-600 mb-1 block">Training Percentage</label>
                    <div class="flex items-center gap-3">
                        <input type="range" id="trainPercent" min="50" max="95" value="80"
                               class="flex-1" oninput="updateTrainPercentLabel()">
                        <span id="trainPercentLabel" class="text-sm font-medium text-gray-700 w-24">80% train</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="modal-footer-wizard">
            <div class="footer-left">
                <button onclick="prevStep()" class="btn btn-secondary hidden" id="prevButton">
                    <i class="fas fa-chevron-left mr-1"></i> Previous
                </button>
                <button onclick="nextStep()" class="btn btn-primary" id="nextButton" disabled>
                    Next <i class="fas fa-chevron-right ml-1"></i>
                </button>
                <button onclick="saveDataset()" class="btn btn-primary hidden" id="saveButton">Create Dataset</button>
            </div>
            <div class="footer-right">
                <button onclick="closeWizard()" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal-overlay hidden">
    <div class="modal-container modal-container-sm">
        <div class="modal-header">
            <div class="modal-header-icon danger">
                <i class="fas fa-trash-alt"></i>
            </div>
            <h3 class="modal-header-title">Delete Dataset</h3>
        </div>
        <div class="modal-body">
            <p>Are you sure you want to delete "<strong id="deleteDatasetName"></strong>"?</p>
            <p class="text-sm text-gray-500 mt-2">This action cannot be undone.</p>
            <div id="deleteWarning" class="hidden mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                <p class="text-sm text-yellow-800">
                    <i class="fas fa-exclamation-triangle mr-1"></i>
                    This dataset has version history and may have been used in training.
                </p>
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="closeDeleteModal()" class="btn btn-secondary">Cancel</button>
            <button onclick="confirmDelete()" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
        </div>
    </div>
</div>

<!-- Dataset Detail Modal -->
<div id="detailModal" class="modal-overlay hidden">
    <div class="modal-container modal-container-lg">
        <div class="modal-header">
            <div class="modal-header-icon info">
                <i class="fas fa-table"></i>
            </div>
            <h3 class="modal-header-title" id="detailModalTitle">Dataset Details</h3>
        </div>
        <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
            <div id="detailContent">
                <p class="text-center text-gray-500 py-8">
                    <i class="fas fa-spinner fa-spin mr-2"></i>Loading...
                </p>
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="closeDetailModal()" class="btn btn-secondary">Close</button>
            <button onclick="viewGeneratedQuery()" class="btn btn-secondary">
                <i class="fas fa-code mr-1"></i>View SQL
            </button>
            <button onclick="editDatasetFromDetail()" class="btn btn-primary">
                <i class="fas fa-edit mr-1"></i>Edit
            </button>
        </div>
    </div>
</div>

<!-- Query Preview Modal -->
<div id="queryModal" class="modal-overlay hidden">
    <div class="modal-container modal-container-lg">
        <div class="modal-header">
            <div class="modal-header-icon info">
                <i class="fas fa-code"></i>
            </div>
            <h3 class="modal-header-title">Generated SQL Query</h3>
        </div>
        <div class="modal-body">
            <div class="mb-3 flex gap-2">
                <button onclick="showQuery('full')" class="btn btn-sm btn-secondary query-tab active" data-tab="full">Full Query</button>
                <button onclick="showQuery('train')" class="btn btn-sm btn-secondary query-tab" data-tab="train">Train Query</button>
                <button onclick="showQuery('eval')" class="btn btn-sm btn-secondary query-tab" data-tab="eval">Eval Query</button>
            </div>
            <pre id="queryContent" class="bg-gray-900 text-green-400 p-4 rounded-lg text-sm overflow-x-auto" style="max-height: 400px;"></pre>
            <div id="queryValidation" class="mt-3 text-sm"></div>
        </div>
        <div class="modal-footer">
            <button onclick="closeQueryModal()" class="btn btn-secondary">Close</button>
            <button onclick="copyQuery()" class="btn btn-primary">
                <i class="fas fa-copy mr-1"></i>Copy SQL
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// ============================================================================
// GLOBAL STATE
// ============================================================================
const modelId = {{ model.id }};
const csrftoken = document.querySelector('[name=csrfmiddleware-token]')?.value || '{{ csrf_token }}';

let currentWizardStep = 1;
let wizardEditMode = false;
let wizardEditDatasetId = null;
let searchTimeout = null;

// Wizard data state
let wizardData = {
    name: '',
    description: '',
    primaryTable: null,
    secondaryTables: [],
    joinConfig: {},
    selectedColumns: {},
    columnMapping: {},
    filters: {},
    splitConfig: {}
};

// Cached data
let availableTables = [];
let tableSchemas = {};
let currentDatasetId = null;
let currentQueries = {};

// Schema Builder State
let schemaBuilderState = {
    sessionId: null,
    tables: {},           // table metadata from load-samples
    selectedColumns: {},  // table -> [columns]
    joins: [],            // [{leftTable, leftCol, rightTable, rightCol, type}]
    connectMode: null,    // {table, column} when awaiting second click
    previewData: null,    // cached preview response
    selectedJoinIndex: null // for join popover
};

// Debounce timer for preview updates
let previewDebounceTimer = null;
const PREVIEW_DEBOUNCE_MS = 300;

// ============================================================================
// PAGE INITIALIZATION
// ============================================================================
document.addEventListener('DOMContentLoaded', function() {
    loadDatasets();
});

// ============================================================================
// DATASET LIST FUNCTIONS
// ============================================================================
function loadDatasets(page = 1) {
    const status = document.getElementById('statusFilter').value;
    const search = document.getElementById('searchInput').value;

    let url = `/api/models/${modelId}/datasets/?page=${page}&per_page=10`;
    if (status) url += `&status=${status}`;
    if (search) url += `&search=${encodeURIComponent(search)}`;

    fetch(url, {
        headers: { 'X-CSRFToken': csrftoken }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            renderDatasetsList(data.datasets);
            renderPagination(data.pagination);
        } else {
            showNotification(data.message || 'Failed to load datasets', 'error');
        }
    })
    .catch(error => {
        console.error('Error loading datasets:', error);
        showNotification('Failed to load datasets', 'error');
    });
}

function renderDatasetsList(datasets) {
    const container = document.getElementById('datasetsList');

    if (!datasets || datasets.length === 0) {
        container.innerHTML = `
            <div class="card-empty-state">
                <p class="card-empty-state-title">No datasets found</p>
                <p class="card-empty-state-text">Create your first dataset to define training data for your ML models</p>
            </div>
        `;
        return;
    }

    container.innerHTML = datasets.map(ds => `
        <div class="card">
            <div class="card-container-5col">
                <!-- Column 1: Dataset Info -->
                <div class="card-content">
                    <div class="card-header">
                        <span class="status-dot ${ds.status === 'active' ? 'green' : 'gray'}"></span>
                        <h4 class="card-title">${escapeHtml(ds.name)}</h4>
                    </div>
                    <div class="card-body">
                        <span class="card-value"><span class="card-label">Primary:</span> ${ds.primary_table ? ds.primary_table.replace('raw_data.', '') : 'Not set'}</span>
                        ${ds.description ? `<span class="card-value text-gray-500 text-xs truncate">${escapeHtml(ds.description.substring(0, 50))}${ds.description.length > 50 ? '...' : ''}</span>` : ''}
                    </div>
                </div>

                <!-- Column 2: Tables & Status -->
                <div class="card-meta-column">
                    <span class="card-label">Tables:</span>
                    <span class="card-schedule-info">${ds.table_count} table${ds.table_count !== 1 ? 's' : ''}</span>
                    <span class="card-label">Status:</span>
                    <span class="card-schedule-info">
                        <span class="px-2 py-0.5 rounded text-xs font-medium ${ds.status === 'active' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'}">
                            ${ds.status.charAt(0).toUpperCase() + ds.status.slice(1)}
                        </span>
                    </span>
                </div>

                <!-- Column 3: Estimates -->
                <div class="card-meta-column">
                    <span class="card-label">Est. Rows:</span>
                    <span class="card-schedule-info">${ds.row_count_estimate ? formatNumber(ds.row_count_estimate) : '—'}</span>
                    <span class="card-label">Users/Products:</span>
                    <span class="card-schedule-info">${ds.unique_users_estimate ? formatNumber(ds.unique_users_estimate) : '—'} / ${ds.unique_products_estimate ? formatNumber(ds.unique_products_estimate) : '—'}</span>
                </div>

                <!-- Column 4: Actions - Analyze & Activate -->
                <div class="card-run-actions">
                    <button onclick="analyzeDataset(${ds.id})" class="card-action-btn run" title="Analyze dataset">
                        <i class="fas fa-chart-bar"></i>
                    </button>
                    ${ds.status === 'draft' ? `
                    <button onclick="activateDataset(${ds.id})" class="card-action-btn resume-large" title="Activate dataset">
                        <i class="fas fa-check-circle"></i>
                    </button>
                    ` : ''}
                </div>

                <!-- Column 5: Edit & Delete -->
                <div class="card-actions">
                    <button onclick="viewDataset(${ds.id})" class="card-action-btn edit" title="View details">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button onclick="editDataset(${ds.id})" class="card-action-btn edit" title="Edit dataset">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteDataset(${ds.id}, '${escapeHtml(ds.name)}')" class="card-action-btn delete" title="Delete dataset">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

function renderPagination(pagination) {
    const container = document.getElementById('paginationContainer');
    const infoEl = document.getElementById('paginationInfo');
    const buttonsEl = document.getElementById('paginationButtons');

    if (pagination.total_pages <= 1) {
        container.classList.add('hidden');
        return;
    }

    container.classList.remove('hidden');

    const start = (pagination.page - 1) * pagination.per_page + 1;
    const end = Math.min(pagination.page * pagination.per_page, pagination.total);
    infoEl.textContent = `Showing ${start}-${end} of ${pagination.total} datasets`;

    let buttons = '';
    if (pagination.has_previous) {
        buttons += `<button onclick="loadDatasets(${pagination.page - 1})" class="btn btn-secondary btn-sm">Previous</button>`;
    }

    for (let i = 1; i <= pagination.total_pages; i++) {
        if (i === pagination.page) {
            buttons += `<button class="btn btn-primary btn-sm">${i}</button>`;
        } else if (i === 1 || i === pagination.total_pages || Math.abs(i - pagination.page) <= 1) {
            buttons += `<button onclick="loadDatasets(${i})" class="btn btn-secondary btn-sm">${i}</button>`;
        } else if (Math.abs(i - pagination.page) === 2) {
            buttons += `<span class="px-2 text-gray-500">...</span>`;
        }
    }

    if (pagination.has_next) {
        buttons += `<button onclick="loadDatasets(${pagination.page + 1})" class="btn btn-secondary btn-sm">Next</button>`;
    }

    buttonsEl.innerHTML = buttons;
}

function refreshDatasets() {
    loadDatasets();
    showNotification('Datasets refreshed', 'success');
}

function filterDatasets() {
    loadDatasets();
}

function debounceSearch() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => loadDatasets(), 300);
}

// ============================================================================
// WIZARD FUNCTIONS
// ============================================================================
function openWizard(datasetId = null) {
    wizardEditMode = !!datasetId;
    wizardEditDatasetId = datasetId;

    // Reset wizard state
    currentWizardStep = 1;
    wizardData = {
        name: '',
        description: '',
        primaryTable: null,
        secondaryTables: [],
        joinConfig: {},
        selectedColumns: {},
        columnMapping: {},
        filters: {},
        splitConfig: {}
    };

    // Update UI
    document.getElementById('wizardTitle').textContent = wizardEditMode ? 'Edit Dataset' : 'Create Dataset';
    document.getElementById('saveButton').textContent = wizardEditMode ? 'Save Changes' : 'Create Dataset';

    // Reset form fields
    document.getElementById('datasetName').value = '';
    document.getElementById('datasetDescription').value = '';
    document.getElementById('nameError').classList.add('hidden');
    document.getElementById('nameSuccess').classList.add('hidden');

    // Show modal
    document.getElementById('datasetWizardModal').classList.remove('hidden');

    // Load tables
    loadBqTables();

    // If editing, load dataset data
    if (wizardEditMode) {
        loadDatasetForEdit(datasetId);
    }

    showStep(1);
}

function closeWizard() {
    document.getElementById('datasetWizardModal').classList.add('hidden');
    resetWizard();
}

function resetWizard() {
    currentWizardStep = 1;
    wizardEditMode = false;
    wizardEditDatasetId = null;
    wizardData = {
        name: '',
        description: '',
        primaryTable: null,
        secondaryTables: [],
        joinConfig: {},
        selectedColumns: {},
        columnMapping: {},
        filters: {},
        splitConfig: {}
    };

    // Reset schema builder state
    schemaBuilderState = {
        sessionId: null,
        tables: {},
        selectedColumns: {},
        joins: [],
        connectMode: null,
        previewData: null,
        selectedJoinIndex: null
    };

    // Reset card positions
    cardPositions = {};
}

function showStep(step) {
    // Hide all steps
    document.querySelectorAll('.wizard-step').forEach(s => s.classList.remove('active'));

    // Show target step
    document.getElementById(`step${step}`).classList.add('active');

    // Update step counter
    document.getElementById('currentStep').textContent = step;

    // Update progress bar
    for (let i = 1; i <= 5; i++) {
        const segment = document.getElementById(`progress${i}`);
        segment.classList.remove('active', 'completed');
        if (i < step) {
            segment.classList.add('completed');
        } else if (i === step) {
            segment.classList.add('active');
        }
    }

    // Update navigation buttons
    updateNavigationButtons(step);

    currentWizardStep = step;
}

function updateNavigationButtons(step) {
    const prevBtn = document.getElementById('prevButton');
    const nextBtn = document.getElementById('nextButton');
    const saveBtn = document.getElementById('saveButton');

    // Previous button
    if (step > 1) {
        prevBtn.classList.remove('hidden');
    } else {
        prevBtn.classList.add('hidden');
    }

    // Next/Save buttons
    if (step === 5) {
        nextBtn.classList.add('hidden');
        saveBtn.classList.remove('hidden');
    } else {
        nextBtn.classList.remove('hidden');
        saveBtn.classList.add('hidden');
    }

    // Enable/disable next based on validation
    validateCurrentStep();
}

function validateCurrentStep() {
    const nextBtn = document.getElementById('nextButton');
    const saveBtn = document.getElementById('saveButton');
    let isValid = false;

    switch (currentWizardStep) {
        case 1:
            const name = document.getElementById('datasetName').value.trim();
            isValid = name.length > 0;
            break;
        case 2:
            isValid = wizardData.primaryTable !== null;
            break;
        case 3:
            // At least one column must be selected (schema builder)
            const hasSelectedColumns = Object.values(schemaBuilderState.selectedColumns)
                .some(cols => cols && cols.length > 0);
            isValid = hasSelectedColumns;
            break;
        case 4:
            // At least user_id and product_id should be mapped
            const userId = document.getElementById('userIdColumn')?.value;
            const productId = document.getElementById('productIdColumn')?.value;
            isValid = userId && productId;
            break;
        case 5:
            isValid = true; // Filters are optional
            break;
    }

    nextBtn.disabled = !isValid;
    saveBtn.disabled = !isValid;
}

function nextStep() {
    if (currentWizardStep >= 5) return;

    // Collect data from current step
    collectStepData(currentWizardStep);

    // Perform step-specific actions
    if (currentWizardStep === 1) {
        // Moving to step 2 - tables should already be loaded
    } else if (currentWizardStep === 2) {
        // Moving to step 3 - load schema builder with samples
        loadSchemaBuilder();
    } else if (currentWizardStep === 3) {
        // Moving to step 4 - collect columns and joins, populate ML column dropdowns
        collectSchemaBuilderData();
        populateMlColumnDropdowns();
    } else if (currentWizardStep === 4) {
        // Moving to step 5 - nothing special needed
    }

    showStep(currentWizardStep + 1);
}

function prevStep() {
    if (currentWizardStep <= 1) return;
    collectStepData(currentWizardStep);
    showStep(currentWizardStep - 1);
}

function collectStepData(step) {
    switch (step) {
        case 1:
            wizardData.name = document.getElementById('datasetName').value.trim();
            wizardData.description = document.getElementById('datasetDescription').value.trim();
            break;
        case 2:
            // Primary and secondary tables already tracked via selection
            break;
        case 3:
            // Schema builder data is collected via collectSchemaBuilderData()
            break;
        case 4:
            // Column mapping - extract just the column name from table.column format
            const extractColumnName = (value) => {
                if (!value) return null;
                // Value is in format "table.column", extract just the column part
                const parts = value.split('.');
                return parts.length > 1 ? parts[parts.length - 1] : value;
            };
            wizardData.columnMapping = {
                user_id: extractColumnName(document.getElementById('userIdColumn')?.value),
                product_id: extractColumnName(document.getElementById('productIdColumn')?.value),
                revenue: extractColumnName(document.getElementById('revenueColumn')?.value)
            };
            // Remove null values
            Object.keys(wizardData.columnMapping).forEach(key => {
                if (!wizardData.columnMapping[key]) delete wizardData.columnMapping[key];
            });
            break;
        case 5:
            // Date range filter
            const dateRangeType = document.querySelector('input[name="dateRangeType"]:checked')?.value;
            if (dateRangeType === 'rolling') {
                wizardData.filters.date_range = {
                    type: 'rolling',
                    months: parseInt(document.getElementById('rollingMonths').value)
                };
            } else if (dateRangeType === 'fixed') {
                wizardData.filters.date_range = {
                    type: 'fixed',
                    start: document.getElementById('startDate').value,
                    end: document.getElementById('endDate').value
                };
            }

            // Product filter
            if (document.getElementById('enableTopProducts')?.checked) {
                wizardData.filters.product_filter = {
                    type: 'top_revenue_percent',
                    value: parseInt(document.getElementById('topProductsPercent').value)
                };
            }

            // Customer filter
            if (document.getElementById('enableMinTransactions')?.checked) {
                wizardData.filters.customer_filter = {
                    type: 'min_transactions',
                    value: parseInt(document.getElementById('minTransactions').value)
                };
            }

            // Split config
            const splitStrategy = document.querySelector('input[name="splitStrategy"]:checked')?.value;
            if (splitStrategy === 'time_based') {
                wizardData.splitConfig = {
                    strategy: 'time_based',
                    eval_days: parseInt(document.getElementById('evalDays').value)
                };
            } else if (splitStrategy === 'random') {
                wizardData.splitConfig = {
                    strategy: 'random',
                    train_percent: parseInt(document.getElementById('trainPercent').value)
                };
            }
            break;
    }
}

// ============================================================================
// STEP 1: NAME VALIDATION
// ============================================================================
let nameCheckTimeout = null;

function validateDatasetName() {
    const name = document.getElementById('datasetName').value.trim();
    const errorEl = document.getElementById('nameError');
    const successEl = document.getElementById('nameSuccess');

    errorEl.classList.add('hidden');
    successEl.classList.add('hidden');

    if (!name) {
        validateCurrentStep();
        return;
    }

    // Debounce the API call
    clearTimeout(nameCheckTimeout);
    nameCheckTimeout = setTimeout(() => {
        fetch(`/api/models/${modelId}/datasets/check-name/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                name: name,
                exclude_id: wizardEditDatasetId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.available) {
                successEl.classList.remove('hidden');
            } else {
                errorEl.textContent = data.message || 'Name already exists';
                errorEl.classList.remove('hidden');
            }
            validateCurrentStep();
        })
        .catch(error => {
            console.error('Error checking name:', error);
        });
    }, 300);

    validateCurrentStep();
}

// ============================================================================
// STEP 2: TABLE SELECTION
// ============================================================================
function loadBqTables() {
    fetch(`/api/models/${modelId}/bq-tables/`, {
        headers: { 'X-CSRFToken': csrftoken }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            availableTables = data.tables;
            renderPrimaryTableList();
        } else {
            showNotification(data.message || 'Failed to load tables', 'error');
        }
    })
    .catch(error => {
        console.error('Error loading tables:', error);
        document.getElementById('primaryTableList').innerHTML = `
            <p class="text-center text-red-500 py-4">
                <i class="fas fa-exclamation-circle mr-2"></i>Failed to load tables
            </p>
        `;
    });
}

function renderPrimaryTableList() {
    const container = document.getElementById('primaryTableList');

    if (!availableTables || availableTables.length === 0) {
        container.innerHTML = `
            <p class="text-center text-gray-500 py-4">
                No tables found in raw_data dataset.<br>
                <span class="text-sm">Run an ETL job first to populate data.</span>
            </p>
        `;
        return;
    }

    container.innerHTML = availableTables.map(table => `
        <label class="wizard-selection-card mb-2 ${wizardData.primaryTable === table.full_name ? 'selected' : ''}">
            <input type="radio" name="primaryTable" value="${table.full_name}"
                   ${wizardData.primaryTable === table.full_name ? 'checked' : ''}
                   onchange="onPrimaryTableSelect('${table.full_name}')">
            <div class="card-content">
                <div class="card-title">${table.table_id}</div>
                <div class="card-description">
                    ${formatNumber(table.row_count)} rows | ${table.column_count} columns | ${formatBytes(table.size_bytes)}
                </div>
            </div>
        </label>
    `).join('');
}

function onPrimaryTableSelect(tableName) {
    wizardData.primaryTable = tableName;

    // Update selection styling
    document.querySelectorAll('#primaryTableList .wizard-selection-card').forEach(card => {
        card.classList.remove('selected');
    });
    document.querySelector(`#primaryTableList input[value="${tableName}"]`)?.closest('.wizard-selection-card')?.classList.add('selected');

    // Update secondary tables list
    renderSecondaryTableList();

    // Load schema for primary table
    loadTableSchema(tableName);

    validateCurrentStep();
}

function renderSecondaryTableList() {
    const container = document.getElementById('secondaryTableList');

    const otherTables = availableTables.filter(t => t.full_name !== wizardData.primaryTable);

    if (otherTables.length === 0) {
        container.innerHTML = `<p class="text-center text-gray-500 py-4">No additional tables available</p>`;
        return;
    }

    container.innerHTML = otherTables.map(table => `
        <label class="wizard-selection-card mb-2 ${wizardData.secondaryTables.includes(table.full_name) ? 'selected' : ''}">
            <input type="checkbox" value="${table.full_name}"
                   ${wizardData.secondaryTables.includes(table.full_name) ? 'checked' : ''}
                   onchange="onSecondaryTableToggle('${table.full_name}', this.checked)">
            <div class="card-content">
                <div class="card-title">${table.table_id}</div>
                <div class="card-description">
                    ${formatNumber(table.row_count)} rows | ${table.column_count} columns
                </div>
            </div>
        </label>
    `).join('');
}

function onSecondaryTableToggle(tableName, isChecked) {
    if (isChecked) {
        if (!wizardData.secondaryTables.includes(tableName)) {
            wizardData.secondaryTables.push(tableName);
            loadTableSchema(tableName);
        }
    } else {
        wizardData.secondaryTables = wizardData.secondaryTables.filter(t => t !== tableName);
        delete wizardData.joinConfig[tableName];
    }

    // Update selection styling
    const card = document.querySelector(`#secondaryTableList input[value="${tableName}"]`)?.closest('.wizard-selection-card');
    if (card) {
        card.classList.toggle('selected', isChecked);
    }

    // Show/hide join config section
    const joinSection = document.getElementById('joinConfigSection');
    if (wizardData.secondaryTables.length > 0) {
        joinSection.classList.remove('hidden');
        renderJoinConfig();
    } else {
        joinSection.classList.add('hidden');
    }
}

function renderJoinConfig() {
    const container = document.getElementById('joinConfigList');

    container.innerHTML = wizardData.secondaryTables.map(tableName => {
        const shortName = tableName.replace('raw_data.', '');
        const config = wizardData.joinConfig[tableName] || {};
        const primarySchema = tableSchemas[wizardData.primaryTable] || [];
        const secondarySchema = tableSchemas[tableName] || [];

        return `
            <div class="p-3 border border-gray-200 rounded-lg bg-gray-50">
                <div class="font-medium text-sm mb-2">${shortName}</div>
                <div class="grid grid-cols-3 gap-2">
                    <div>
                        <label class="text-xs text-gray-600">Primary Key</label>
                        <select class="form-select w-full text-xs" onchange="updateJoinConfig('${tableName}', 'primary_key', this.value)">
                            <option value="">Select...</option>
                            ${primarySchema.map(col => `<option value="${col.name}" ${config.primary_key === col.name ? 'selected' : ''}>${col.name}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-gray-600">Join Key</label>
                        <select class="form-select w-full text-xs" onchange="updateJoinConfig('${tableName}', 'join_key', this.value)">
                            <option value="">Select...</option>
                            ${secondarySchema.map(col => `<option value="${col.name}" ${config.join_key === col.name ? 'selected' : ''}>${col.name}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-gray-600">Join Type</label>
                        <select class="form-select w-full text-xs" onchange="updateJoinConfig('${tableName}', 'join_type', this.value)">
                            <option value="LEFT" ${config.join_type === 'LEFT' ? 'selected' : ''}>LEFT JOIN</option>
                            <option value="INNER" ${config.join_type === 'INNER' ? 'selected' : ''}>INNER JOIN</option>
                        </select>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function updateJoinConfig(tableName, field, value) {
    if (!wizardData.joinConfig[tableName]) {
        wizardData.joinConfig[tableName] = { join_type: 'LEFT' };
    }
    wizardData.joinConfig[tableName][field] = value;
}

function detectJoins() {
    const tables = [wizardData.primaryTable, ...wizardData.secondaryTables];

    fetch(`/api/models/${modelId}/detect-joins/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ tables: tables })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success' && data.detected_joins) {
            // Apply detected joins
            data.detected_joins.forEach(join => {
                if (wizardData.secondaryTables.includes(join.table2)) {
                    wizardData.joinConfig[join.table2] = {
                        primary_key: join.column1,
                        join_key: join.column2,
                        join_type: 'LEFT'
                    };
                }
            });
            renderJoinConfig();
            showNotification('Joins detected successfully', 'success');
        } else {
            showNotification('No obvious joins detected. Please configure manually.', 'warning');
        }
    })
    .catch(error => {
        console.error('Error detecting joins:', error);
        showNotification('Failed to detect joins', 'error');
    });
}

function loadTableSchema(tableName) {
    if (tableSchemas[tableName]) return; // Already loaded

    fetch(`/api/models/${modelId}/bq-tables/${encodeURIComponent(tableName.replace('raw_data.', ''))}/schema/`, {
        headers: { 'X-CSRFToken': csrftoken }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            tableSchemas[tableName] = data.schema;
            // Re-render join config if needed
            if (wizardData.secondaryTables.length > 0) {
                renderJoinConfig();
            }
        }
    })
    .catch(error => {
        console.error('Error loading schema:', error);
    });
}

// ============================================================================
// STEP 3: VISUAL SCHEMA BUILDER
// ============================================================================

function loadSchemaBuilder() {
    const allTables = [wizardData.primaryTable, ...wizardData.secondaryTables].filter(Boolean);

    if (allTables.length === 0) {
        document.getElementById('schemaLoading').innerHTML = 'No tables selected. Go back to Step 2.';
        return;
    }

    // Show loading state
    document.getElementById('schemaLoading').style.display = 'flex';
    document.getElementById('schemaCardsContainer').innerHTML = `
        <div class="schema-loading" id="schemaLoading">
            <i class="fas fa-spinner fa-spin"></i>
            Loading table samples...
        </div>
    `;

    // Reset schema builder state
    schemaBuilderState = {
        sessionId: null,
        tables: {},
        selectedColumns: {},
        joins: [],
        connectMode: null,
        previewData: null,
        selectedJoinIndex: null
    };

    // Load samples from backend
    fetch(`/api/models/${modelId}/datasets/load-samples/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ tables: allTables })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            schemaBuilderState.sessionId = data.session_id;
            schemaBuilderState.tables = data.tables;

            // Initialize selected columns (all by default)
            Object.keys(data.tables).forEach(table => {
                const columns = data.tables[table].columns || [];
                schemaBuilderState.selectedColumns[table] = columns.map(c => c.name);
            });

            // Render table cards
            renderTableCards();

            // Auto-detect joins if multiple tables
            if (allTables.length > 1) {
                autoDetectJoins();
            } else {
                // Single table - just refresh preview
                refreshPreview();
            }
        } else {
            document.getElementById('schemaCardsContainer').innerHTML = `
                <div class="schema-preview-empty">
                    <i class="fas fa-exclamation-triangle"></i>
                    Error loading samples: ${data.message}
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error loading schema builder:', error);
        document.getElementById('schemaCardsContainer').innerHTML = `
            <div class="schema-preview-empty">
                <i class="fas fa-exclamation-triangle"></i>
                Failed to load table samples
            </div>
        `;
    });
}

// Store card positions
let cardPositions = {};

function renderTableCards() {
    const container = document.getElementById('schemaCardsContainer');
    const allTables = [wizardData.primaryTable, ...wizardData.secondaryTables].filter(Boolean);

    let html = '';

    allTables.forEach((table, index) => {
        const tableData = schemaBuilderState.tables[table] || {};
        const columns = tableData.columns || [];
        const isPrimary = index === 0;
        const shortName = table.replace('raw_data.', '');
        const selectedCols = schemaBuilderState.selectedColumns[table] || [];
        const showLimit = 10;
        const hasMore = columns.length > showLimit;

        html += `
            <div class="schema-table-card ${isPrimary ? 'primary' : ''}" data-table="${table}" id="card_${shortName}">
                <div class="schema-card-header" onmousedown="startDrag(event, '${table}')">
                    <div class="schema-card-title">
                        <i class="fas fa-table"></i>
                        ${shortName}
                    </div>
                    <span class="schema-card-badge ${isPrimary ? 'primary' : 'secondary'}">
                        ${isPrimary ? 'Primary' : 'Secondary'}
                    </span>
                </div>
                <div class="schema-column-list ${hasMore ? 'collapsed' : ''}" id="columnList_${shortName}">
                    ${columns.slice(0, showLimit).map(col => renderColumnItem(table, col, selectedCols, isPrimary)).join('')}
                </div>
                ${hasMore ? `
                    <div class="schema-column-expander" id="expander_${shortName}" onclick="toggleColumnExpander('${table}', '${shortName}')">
                        Show ${columns.length - showLimit} more...
                    </div>
                ` : ''}
            </div>
        `;
    });

    container.innerHTML = html;

    // Position cards: primary in center, secondary around it
    positionCardsInitially(allTables);

    // Setup drag handlers
    setupDragHandlers();

    // Update connection lines after a short delay to ensure cards are positioned
    setTimeout(updateConnectionLines, 50);
}

function positionCardsInitially(allTables) {
    const container = document.getElementById('schemaCardsContainer');
    const containerRect = container.getBoundingClientRect();

    // Use fixed dimensions based on CSS if container not yet sized
    const containerWidth = Math.max(containerRect.width, 900);
    const containerHeight = Math.max(containerRect.height, 300);

    const cardWidth = 220;
    const cardHeight = 220; // Approximate card height

    // Calculate positions for all tables first
    const numTables = allTables.length;

    allTables.forEach((table, index) => {
        const shortName = table.replace('raw_data.', '');
        const card = document.getElementById(`card_${shortName}`);
        if (!card) return;

        let x, y;

        // Check if we have saved positions
        if (cardPositions[table]) {
            x = cardPositions[table].x;
            y = cardPositions[table].y;
        } else if (index === 0) {
            // Primary table: center of container
            x = (containerWidth - cardWidth) / 2;
            y = (containerHeight - cardHeight) / 2;
        } else {
            // Secondary tables: position to the left and right of primary
            const numSecondary = numTables - 1;

            if (numSecondary === 1) {
                // Single secondary: place to the right
                x = (containerWidth / 2) + cardWidth / 2 + 80;
                y = (containerHeight - cardHeight) / 2;
            } else if (numSecondary === 2) {
                // Two secondaries: one left, one right
                if (index === 1) {
                    x = (containerWidth / 2) - cardWidth - 80;
                    y = (containerHeight - cardHeight) / 2;
                } else {
                    x = (containerWidth / 2) + cardWidth / 2 + 80;
                    y = (containerHeight - cardHeight) / 2;
                }
            } else {
                // Multiple secondaries: distribute around the primary
                const angle = ((index - 1) / numSecondary) * Math.PI * 2 - Math.PI / 2;
                const radiusX = containerWidth * 0.35;
                const radiusY = containerHeight * 0.30;

                const centerX = containerWidth / 2;
                const centerY = containerHeight / 2;

                x = centerX + Math.cos(angle) * radiusX - cardWidth / 2;
                y = centerY + Math.sin(angle) * radiusY - cardHeight / 2;
            }

            // Keep within bounds
            x = Math.max(10, Math.min(x, containerWidth - cardWidth - 10));
            y = Math.max(10, Math.min(y, containerHeight - cardHeight - 10));
        }

        card.style.left = x + 'px';
        card.style.top = y + 'px';

        // Save position
        cardPositions[table] = { x, y };
    });
}

// Drag state
let dragState = {
    isDragging: false,
    table: null,
    startX: 0,
    startY: 0,
    cardStartX: 0,
    cardStartY: 0
};

function setupDragHandlers() {
    document.addEventListener('mousemove', onDragMove);
    document.addEventListener('mouseup', onDragEnd);
}

function startDrag(event, table) {
    // Don't start drag if clicking on checkbox or other interactive elements
    if (event.target.tagName === 'INPUT' || event.target.closest('.schema-connection-dot')) {
        return;
    }

    event.preventDefault();

    const shortName = table.replace('raw_data.', '');
    const card = document.getElementById(`card_${shortName}`);
    if (!card) return;

    dragState = {
        isDragging: true,
        table: table,
        startX: event.clientX,
        startY: event.clientY,
        cardStartX: parseInt(card.style.left) || 0,
        cardStartY: parseInt(card.style.top) || 0
    };

    card.classList.add('dragging');
}

function onDragMove(event) {
    if (!dragState.isDragging) return;

    const shortName = dragState.table.replace('raw_data.', '');
    const card = document.getElementById(`card_${shortName}`);
    if (!card) return;

    const container = document.getElementById('schemaCardsContainer');
    const containerRect = container.getBoundingClientRect();

    const deltaX = event.clientX - dragState.startX;
    const deltaY = event.clientY - dragState.startY;

    let newX = dragState.cardStartX + deltaX;
    let newY = dragState.cardStartY + deltaY;

    // Keep within container bounds
    const cardRect = card.getBoundingClientRect();
    const maxX = containerRect.width - cardRect.width;
    const maxY = containerRect.height - cardRect.height;

    newX = Math.max(0, Math.min(newX, maxX));
    newY = Math.max(0, Math.min(newY, maxY));

    card.style.left = newX + 'px';
    card.style.top = newY + 'px';

    // Save position
    cardPositions[dragState.table] = { x: newX, y: newY };

    // Update connection lines while dragging
    updateConnectionLines();
}

function onDragEnd(event) {
    if (!dragState.isDragging) return;

    const shortName = dragState.table.replace('raw_data.', '');
    const card = document.getElementById(`card_${shortName}`);
    if (card) {
        card.classList.remove('dragging');
    }

    dragState.isDragging = false;
    dragState.table = null;

    // Final update of connection lines
    updateConnectionLines();
}

function renderColumnItem(table, col, selectedCols, isPrimary) {
    const shortTable = table.replace('raw_data.', '');
    const isSelected = selectedCols.includes(col.name);

    // Determine if column could be a join key based on schema flag OR naming patterns
    const colLower = col.name.toLowerCase();
    const keyPatterns = ['_id', 'id_', '_key', 'key_', '_code', 'code_'];
    const isJoinKey = col.is_potential_join_key ||
                      keyPatterns.some(p => colLower.includes(p)) ||
                      colLower === 'id';

    const isConnected = schemaBuilderState.joins.some(j =>
        (j.leftCol === col.name && wizardData.primaryTable === table) ||
        (j.rightCol === col.name && j.rightTable === table)
    );

    return `
        <div class="schema-column-item ${isConnected ? 'connected' : ''}" data-table="${table}" data-column="${col.name}">
            <input type="checkbox" ${isSelected ? 'checked' : ''}
                   onchange="onColumnCheckChange('${table}', '${col.name}', this.checked)">
            <span class="schema-column-name">${col.name}</span>
            <span class="schema-column-type">${col.type?.substring(0, 3)?.toLowerCase() || ''}</span>
            ${isJoinKey ? `
                <div class="schema-connection-dot ${isConnected ? 'connected' : ''}"
                     data-table="${table}" data-column="${col.name}"
                     onclick="onConnectionDotClick('${table}', '${col.name}')"></div>
            ` : ''}
        </div>
    `;
}

function toggleColumnExpander(table, shortName) {
    const columnList = document.getElementById(`columnList_${shortName}`);
    const expander = document.getElementById(`expander_${shortName}`);
    const tableData = schemaBuilderState.tables[table] || {};
    const columns = tableData.columns || [];
    const selectedCols = schemaBuilderState.selectedColumns[table] || [];
    const isPrimary = table === wizardData.primaryTable;

    if (columnList.classList.contains('collapsed')) {
        // Expand - show all columns
        columnList.classList.remove('collapsed');
        columnList.innerHTML = columns.map(col => renderColumnItem(table, col, selectedCols, isPrimary)).join('');
        expander.textContent = 'Show less';
    } else {
        // Collapse - show first 10
        columnList.classList.add('collapsed');
        columnList.innerHTML = columns.slice(0, 10).map(col => renderColumnItem(table, col, selectedCols, isPrimary)).join('');
        expander.textContent = `Show ${columns.length - 10} more...`;
    }

    updateConnectionLines();
}

function onColumnCheckChange(table, column, isChecked) {
    if (!schemaBuilderState.selectedColumns[table]) {
        schemaBuilderState.selectedColumns[table] = [];
    }

    if (isChecked) {
        if (!schemaBuilderState.selectedColumns[table].includes(column)) {
            schemaBuilderState.selectedColumns[table].push(column);
        }
    } else {
        schemaBuilderState.selectedColumns[table] = schemaBuilderState.selectedColumns[table].filter(c => c !== column);
    }

    validateCurrentStep();
    debouncedRefreshPreview();
}

// Connection dot click handling
function onConnectionDotClick(table, column) {
    const connectMode = schemaBuilderState.connectMode;

    if (!connectMode) {
        // Start connect mode
        schemaBuilderState.connectMode = { table, column };

        // Highlight source dot
        document.querySelectorAll('.schema-connection-dot').forEach(dot => {
            if (dot.dataset.table === table && dot.dataset.column === column) {
                dot.classList.add('connect-mode');
            } else if (dot.dataset.table !== table) {
                // Highlight valid targets (different table)
                dot.classList.add('connect-mode-target');
            }
        });
    } else {
        // Complete or cancel connection
        if (connectMode.table === table && connectMode.column === column) {
            // Clicked same dot - cancel
            exitConnectMode();
        } else if (connectMode.table !== table) {
            // Valid target - create join
            createJoin(connectMode.table, connectMode.column, table, column);
            exitConnectMode();
        }
        // If same table but different column - ignore
    }
}

function exitConnectMode() {
    schemaBuilderState.connectMode = null;
    document.querySelectorAll('.schema-connection-dot').forEach(dot => {
        dot.classList.remove('connect-mode', 'connect-mode-target');
    });
}

function createJoin(leftTable, leftCol, rightTable, rightCol) {
    // Ensure primary table is always on the left
    if (leftTable !== wizardData.primaryTable && rightTable === wizardData.primaryTable) {
        [leftTable, leftCol, rightTable, rightCol] = [rightTable, rightCol, leftTable, leftCol];
    }

    // Check if join already exists
    const existingIndex = schemaBuilderState.joins.findIndex(j =>
        j.rightTable === rightTable
    );

    if (existingIndex >= 0) {
        // Update existing join
        schemaBuilderState.joins[existingIndex] = {
            leftTable,
            leftCol,
            rightTable,
            rightCol,
            type: 'left'
        };
    } else {
        // Add new join
        schemaBuilderState.joins.push({
            leftTable,
            leftCol,
            rightTable,
            rightCol,
            type: 'left'
        });
    }

    renderTableCards();
    refreshPreview();
}

function removeJoin(index) {
    schemaBuilderState.joins.splice(index, 1);
    renderTableCards();
    refreshPreview();
    hideJoinPopover();
}

function setJoinType(type) {
    if (schemaBuilderState.selectedJoinIndex !== null) {
        schemaBuilderState.joins[schemaBuilderState.selectedJoinIndex].type = type;
        refreshPreview();
        hideJoinPopover();
    }
}

function removeSelectedJoin() {
    if (schemaBuilderState.selectedJoinIndex !== null) {
        removeJoin(schemaBuilderState.selectedJoinIndex);
    }
}

function showJoinPopover(index, x, y) {
    schemaBuilderState.selectedJoinIndex = index;
    const popover = document.getElementById('joinPopover');
    const join = schemaBuilderState.joins[index];

    // Update active state for join type options
    popover.querySelectorAll('.join-popover-option[data-type]').forEach(opt => {
        opt.classList.toggle('active', opt.dataset.type === join.type);
    });

    popover.style.left = x + 'px';
    popover.style.top = y + 'px';
    popover.classList.remove('hidden');
}

function hideJoinPopover() {
    schemaBuilderState.selectedJoinIndex = null;
    document.getElementById('joinPopover').classList.add('hidden');
}

// Color palette for connection lines
const JOIN_COLORS = [
    '#2563eb', // Blue
    '#16a34a', // Green
    '#dc2626', // Red
    '#9333ea', // Purple
    '#ea580c', // Orange
    '#0891b2', // Cyan
    '#c026d3', // Fuchsia
    '#ca8a04', // Yellow
];

function updateConnectionLines() {
    const svg = document.getElementById('connectionsSvg');
    const cardsArea = document.getElementById('schemaCardsArea');

    // Clear existing lines
    svg.innerHTML = '';

    // Draw lines for each join
    schemaBuilderState.joins.forEach((join, index) => {
        // Get the card elements (not just the dots)
        const leftCard = document.querySelector(`.schema-table-card[data-table="${join.leftTable}"]`);
        const rightCard = document.querySelector(`.schema-table-card[data-table="${join.rightTable}"]`);

        if (leftCard && rightCard) {
            const areaRect = cardsArea.getBoundingClientRect();
            const leftCardRect = leftCard.getBoundingClientRect();
            const rightCardRect = rightCard.getBoundingClientRect();

            // Calculate the best connection points between the two cards
            const connection = calculateBestConnectionPoints(leftCardRect, rightCardRect, areaRect, cardsArea);

            // Get color for this join
            const color = JOIN_COLORS[index % JOIN_COLORS.length];

            // Create a curved path for better visibility
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            const d = createCurvedPath(connection.x1, connection.y1, connection.x2, connection.y2);
            path.setAttribute('d', d);
            path.setAttribute('class', 'join-line');
            path.setAttribute('stroke', color);
            path.setAttribute('fill', 'none');
            path.style.pointerEvents = 'stroke';
            path.onclick = (e) => {
                e.stopPropagation();
                showJoinPopover(index, e.clientX - areaRect.left, e.clientY - areaRect.top);
            };

            svg.appendChild(path);

            // Add small circles at connection points for visual clarity
            const circle1 = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle1.setAttribute('cx', connection.x1);
            circle1.setAttribute('cy', connection.y1);
            circle1.setAttribute('r', 4);
            circle1.setAttribute('fill', color);
            svg.appendChild(circle1);

            const circle2 = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle2.setAttribute('cx', connection.x2);
            circle2.setAttribute('cy', connection.y2);
            circle2.setAttribute('r', 4);
            circle2.setAttribute('fill', color);
            svg.appendChild(circle2);
        }
    });
}

function calculateBestConnectionPoints(rect1, rect2, areaRect, cardsArea) {
    // Calculate centers of each card
    const center1 = {
        x: rect1.left + rect1.width / 2,
        y: rect1.top + rect1.height / 2
    };
    const center2 = {
        x: rect2.left + rect2.width / 2,
        y: rect2.top + rect2.height / 2
    };

    // Determine which edges to connect based on relative positions
    let x1, y1, x2, y2;

    // Horizontal distance vs vertical distance
    const dx = center2.x - center1.x;
    const dy = center2.y - center1.y;

    if (Math.abs(dx) > Math.abs(dy)) {
        // Cards are more horizontal - connect left/right edges
        if (dx > 0) {
            // Card 2 is to the right of Card 1
            x1 = rect1.right;
            y1 = center1.y;
            x2 = rect2.left;
            y2 = center2.y;
        } else {
            // Card 2 is to the left of Card 1
            x1 = rect1.left;
            y1 = center1.y;
            x2 = rect2.right;
            y2 = center2.y;
        }
    } else {
        // Cards are more vertical - connect top/bottom edges
        if (dy > 0) {
            // Card 2 is below Card 1
            x1 = center1.x;
            y1 = rect1.bottom;
            x2 = center2.x;
            y2 = rect2.top;
        } else {
            // Card 2 is above Card 1
            x1 = center1.x;
            y1 = rect1.top;
            x2 = center2.x;
            y2 = rect2.bottom;
        }
    }

    // Convert to SVG coordinates (relative to cards area)
    return {
        x1: x1 - areaRect.left + cardsArea.scrollLeft,
        y1: y1 - areaRect.top + cardsArea.scrollTop,
        x2: x2 - areaRect.left + cardsArea.scrollLeft,
        y2: y2 - areaRect.top + cardsArea.scrollTop
    };
}

function createCurvedPath(x1, y1, x2, y2) {
    // Create a smooth bezier curve between the two points
    const midX = (x1 + x2) / 2;
    const midY = (y1 + y2) / 2;

    // Calculate control points for a smooth curve
    const dx = x2 - x1;
    const dy = y2 - y1;

    // Curve amount based on distance
    const curveAmount = Math.min(Math.abs(dx), Math.abs(dy)) * 0.3;

    let cx1, cy1, cx2, cy2;

    if (Math.abs(dx) > Math.abs(dy)) {
        // Horizontal connection - curve vertically
        cx1 = x1 + dx * 0.3;
        cy1 = y1;
        cx2 = x2 - dx * 0.3;
        cy2 = y2;
    } else {
        // Vertical connection - curve horizontally
        cx1 = x1;
        cy1 = y1 + dy * 0.3;
        cx2 = x2;
        cy2 = y2 - dy * 0.3;
    }

    return `M ${x1} ${y1} C ${cx1} ${cy1}, ${cx2} ${cy2}, ${x2} ${y2}`;
}

function autoDetectJoins() {
    if (!schemaBuilderState.sessionId) return;

    fetch(`/api/models/${modelId}/datasets/detect-joins-preview/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ session_id: schemaBuilderState.sessionId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success' && data.suggested_joins) {
            // Clear existing joins and apply suggestions
            schemaBuilderState.joins = data.suggested_joins.map(j => ({
                leftTable: j.left_table,
                leftCol: j.left_col,
                rightTable: j.right_table,
                rightCol: j.right_col,
                type: 'left'
            }));

            renderTableCards();
            refreshPreview();
        }
    })
    .catch(error => {
        console.error('Error auto-detecting joins:', error);
    });
}

function debouncedRefreshPreview() {
    if (previewDebounceTimer) {
        clearTimeout(previewDebounceTimer);
    }
    previewDebounceTimer = setTimeout(refreshPreview, PREVIEW_DEBOUNCE_MS);
}

function refreshPreview() {
    if (!schemaBuilderState.sessionId) return;

    const joins = schemaBuilderState.joins.map(j => ({
        table: j.rightTable,
        left_col: j.leftCol,
        right_col: j.rightCol,
        type: j.type
    }));

    fetch(`/api/models/${modelId}/datasets/preview/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
            session_id: schemaBuilderState.sessionId,
            primary_table: wizardData.primaryTable,
            joins: joins,
            selected_columns: schemaBuilderState.selectedColumns
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            schemaBuilderState.previewData = data;
            renderPreview(data);
        } else {
            renderPreviewError(data.message);
        }
    })
    .catch(error => {
        console.error('Error generating preview:', error);
        renderPreviewError('Failed to generate preview');
    });
}

function renderPreview(data) {
    // Update stats
    document.getElementById('previewRowCount').textContent = data.stats?.total_rows || 0;
    document.getElementById('previewColCount').textContent = data.column_order?.length || 0;

    // Show warnings if any
    const warningsEl = document.getElementById('previewWarnings');
    const warningTextEl = document.getElementById('previewWarningText');
    if (data.stats?.warnings?.length > 0) {
        warningsEl.style.display = 'flex';
        warningTextEl.textContent = data.stats.warnings[0];
    } else if (Object.keys(data.stats?.null_counts || {}).length > 0) {
        const nullCounts = data.stats.null_counts;
        const firstNull = Object.entries(nullCounts)[0];
        warningsEl.style.display = 'flex';
        warningTextEl.textContent = `${firstNull[1]} nulls in ${firstNull[0]}`;
    } else {
        warningsEl.style.display = 'none';
    }

    // Render table
    const table = document.getElementById('previewTable');
    const thead = document.getElementById('previewTableHead');
    const tbody = document.getElementById('previewTableBody');
    const empty = document.getElementById('previewEmpty');

    if (!data.preview_rows || data.preview_rows.length === 0) {
        table.style.display = 'none';
        empty.style.display = 'block';
        return;
    }

    table.style.display = 'table';
    empty.style.display = 'none';

    // Headers
    thead.innerHTML = '<tr>' + (data.column_order || []).map(col =>
        `<th>${col}</th>`
    ).join('') + '</tr>';

    // Rows
    tbody.innerHTML = data.preview_rows.map(row => {
        return '<tr>' + (data.column_order || []).map(col => {
            const val = row[col];
            if (val === null || val === undefined) {
                return `<td class="null-value">NULL</td>`;
            }
            return `<td title="${val}">${val}</td>`;
        }).join('') + '</tr>';
    }).join('');

    validateCurrentStep();
}

function renderPreviewError(message) {
    document.getElementById('previewRowCount').textContent = '-';
    document.getElementById('previewColCount').textContent = '-';
    document.getElementById('previewWarnings').style.display = 'none';
    document.getElementById('previewTable').style.display = 'none';
    document.getElementById('previewEmpty').style.display = 'block';
    document.getElementById('previewEmpty').innerHTML = `
        <i class="fas fa-exclamation-triangle"></i>
        ${message || 'Failed to generate preview'}
    `;
}

function collectSchemaBuilderData() {
    // Transfer schema builder state to wizard data
    wizardData.selectedColumns = { ...schemaBuilderState.selectedColumns };

    // Convert joins to the format expected by the backend
    wizardData.joinConfig = {};
    schemaBuilderState.joins.forEach(join => {
        wizardData.joinConfig[join.rightTable] = {
            join_key: join.leftCol,
            secondary_column: join.rightCol,
            join_type: join.type
        };
    });
}

function populateMlColumnDropdowns() {
    const allColumns = [];

    Object.entries(schemaBuilderState.selectedColumns).forEach(([table, cols]) => {
        const shortTable = table.replace('raw_data.', '');
        cols.forEach(col => {
            allColumns.push({ table: shortTable, column: col, fullName: `${shortTable}.${col}` });
        });
    });

    ['userIdColumn', 'productIdColumn', 'revenueColumn'].forEach(selectId => {
        const select = document.getElementById(selectId);
        if (!select) return;

        const currentValue = select.value;
        select.innerHTML = '<option value="">Select column...</option>' +
            allColumns.map(c => `<option value="${c.fullName}" ${currentValue === c.fullName ? 'selected' : ''}>${c.fullName}</option>`).join('');
    });

    // Auto-suggest ML columns
    suggestMLColumns();
}

function suggestMLColumns() {
    const tables = [wizardData.primaryTable, ...wizardData.secondaryTables].filter(Boolean);

    fetch(`/api/models/${modelId}/suggest-columns/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ tables: tables })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success' && data.suggestions) {
            const suggestionsBox = document.getElementById('mlSuggestions');
            const suggestionsText = document.getElementById('mlSuggestionsText');

            let suggestionsList = [];

            const buildColumnValue = (suggestion) => {
                if (!suggestion) return null;
                const table = suggestion.table?.replace('raw_data.', '') || '';
                const column = suggestion.suggested_column || '';
                return table && column ? `${table}.${column}` : null;
            };

            if (data.suggestions.user_id) {
                const value = buildColumnValue(data.suggestions.user_id);
                if (value) {
                    suggestionsList.push(`User ID: ${value}`);
                    const select = document.getElementById('userIdColumn');
                    if (select && !select.value) select.value = value;
                }
            }
            if (data.suggestions.product_id) {
                const value = buildColumnValue(data.suggestions.product_id);
                if (value) {
                    suggestionsList.push(`Product ID: ${value}`);
                    const select = document.getElementById('productIdColumn');
                    if (select && !select.value) select.value = value;
                }
            }
            if (data.suggestions.revenue) {
                const value = buildColumnValue(data.suggestions.revenue);
                if (value) {
                    suggestionsList.push(`Revenue: ${value}`);
                    const select = document.getElementById('revenueColumn');
                    if (select && !select.value) select.value = value;
                }
            }

            if (suggestionsList.length > 0) {
                suggestionsText.innerHTML = `<strong>Auto-detected columns:</strong> ${suggestionsList.join(' | ')}`;
                suggestionsBox.classList.remove('hidden');
            }

            validateCurrentStep();
        }
    })
    .catch(error => {
        console.error('Error suggesting columns:', error);
    });
}

function getTypeAbbrev(type) {
    const abbrevs = {
        'STRING': 'str',
        'INTEGER': 'int',
        'INT64': 'int',
        'FLOAT': 'flt',
        'FLOAT64': 'flt',
        'BOOLEAN': 'bool',
        'TIMESTAMP': 'ts',
        'DATE': 'date',
        'DATETIME': 'dt'
    };
    return abbrevs[type?.toUpperCase()] || type?.substring(0, 3)?.toLowerCase() || '';
}

// Close join popover when clicking outside
document.addEventListener('click', function(e) {
    const popover = document.getElementById('joinPopover');
    if (popover && !popover.contains(e.target) && !e.target.classList.contains('join-line')) {
        hideJoinPopover();
    }
});

// ============================================================================
// STEP 5: FILTERS & SPLIT
// ============================================================================
function onDateRangeTypeChange() {
    const type = document.querySelector('input[name="dateRangeType"]:checked')?.value;
    document.getElementById('rollingConfig').classList.toggle('hidden', type !== 'rolling');
    document.getElementById('fixedDateConfig').classList.toggle('hidden', type !== 'fixed');
}

function onSplitStrategyChange() {
    const strategy = document.querySelector('input[name="splitStrategy"]:checked')?.value;
    document.getElementById('timeBasedConfig').classList.toggle('hidden', strategy !== 'time_based');
    document.getElementById('randomSplitConfig').classList.toggle('hidden', strategy !== 'random');
}

function updateTrainPercentLabel() {
    const value = document.getElementById('trainPercent').value;
    document.getElementById('trainPercentLabel').textContent = `${value}% train`;
}

function toggleAdvancedFilters() {
    const section = document.getElementById('advancedFilters');
    const icon = document.getElementById('advancedFiltersIcon');
    section.classList.toggle('hidden');
    icon.style.transform = section.classList.contains('hidden') ? '' : 'rotate(90deg)';
}

function toggleTopProductsInput() {
    const checkbox = document.getElementById('enableTopProducts');
    document.getElementById('topProductsPercent').disabled = !checkbox.checked;
}

function toggleMinTransactionsInput() {
    const checkbox = document.getElementById('enableMinTransactions');
    document.getElementById('minTransactions').disabled = !checkbox.checked;
}

// ============================================================================
// SAVE DATASET
// ============================================================================
function saveDataset() {
    // Collect all data from current step
    collectStepData(currentWizardStep);

    // Build payload
    const payload = {
        name: wizardData.name,
        description: wizardData.description,
        primary_table: wizardData.primaryTable,
        secondary_tables: wizardData.secondaryTables,
        join_config: wizardData.joinConfig,
        selected_columns: wizardData.selectedColumns,
        column_mapping: wizardData.columnMapping,
        filters: wizardData.filters,
        split_config: wizardData.splitConfig
    };

    const url = wizardEditMode
        ? `/api/datasets/${wizardEditDatasetId}/update/`
        : `/api/models/${modelId}/datasets/create/`;

    document.getElementById('saveButton').disabled = true;
    document.getElementById('saveButton').innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Saving...';

    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification(wizardEditMode ? 'Dataset updated successfully' : 'Dataset created successfully', 'success');
            closeWizard();
            loadDatasets();
        } else {
            showNotification(data.message || 'Failed to save dataset', 'error');
            if (data.errors) {
                console.error('Validation errors:', data.errors);
            }
        }
    })
    .catch(error => {
        console.error('Error saving dataset:', error);
        showNotification('Failed to save dataset', 'error');
    })
    .finally(() => {
        document.getElementById('saveButton').disabled = false;
        document.getElementById('saveButton').textContent = wizardEditMode ? 'Save Changes' : 'Create Dataset';
    });
}

// ============================================================================
// DATASET ACTIONS
// ============================================================================
function viewDataset(datasetId) {
    currentDatasetId = datasetId;
    document.getElementById('detailModal').classList.remove('hidden');
    document.getElementById('detailContent').innerHTML = '<p class="text-center text-gray-500 py-8"><i class="fas fa-spinner fa-spin mr-2"></i>Loading...</p>';

    fetch(`/api/datasets/${datasetId}/summary/`, {
        headers: { 'X-CSRFToken': csrftoken }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            renderDatasetDetail(data.summary);
        } else {
            document.getElementById('detailContent').innerHTML = `<p class="text-center text-red-500 py-8">${data.message || 'Failed to load details'}</p>`;
        }
    })
    .catch(error => {
        console.error('Error loading dataset:', error);
        document.getElementById('detailContent').innerHTML = '<p class="text-center text-red-500 py-8">Failed to load details</p>';
    });
}

function renderDatasetDetail(summary) {
    document.getElementById('detailModalTitle').textContent = summary.name;

    const html = `
        <div class="space-y-4">
            <!-- Status & Info -->
            <div class="flex items-center gap-3">
                <span class="px-3 py-1 rounded-full text-sm font-medium ${summary.status === 'active' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'}">
                    ${summary.status.charAt(0).toUpperCase() + summary.status.slice(1)}
                </span>
                <span class="text-sm text-gray-500">Created ${new Date(summary.timestamps.created_at).toLocaleDateString()}</span>
            </div>

            ${summary.description ? `<p class="text-gray-600">${escapeHtml(summary.description)}</p>` : ''}

            <!-- Tables -->
            <div class="bg-gray-50 rounded-lg p-4">
                <h4 class="font-semibold text-gray-900 mb-2">Tables (${summary.tables.total_count})</h4>
                <div class="space-y-1">
                    <div class="flex items-center">
                        <span class="text-sm font-medium text-gray-700 w-24">Primary:</span>
                        <span class="text-sm text-gray-900">${summary.tables.primary?.replace('raw_data.', '') || 'Not set'}</span>
                    </div>
                    ${summary.tables.secondary.length > 0 ? `
                    <div class="flex items-start">
                        <span class="text-sm font-medium text-gray-700 w-24">Secondary:</span>
                        <span class="text-sm text-gray-900">${summary.tables.secondary.map(t => t.replace('raw_data.', '')).join(', ')}</span>
                    </div>
                    ` : ''}
                </div>
            </div>

            <!-- Column Mapping -->
            <div class="bg-gray-50 rounded-lg p-4">
                <h4 class="font-semibold text-gray-900 mb-2">ML Column Mapping</h4>
                <div class="grid grid-cols-2 gap-2 text-sm">
                    ${Object.entries(summary.columns.mapping || {}).map(([role, col]) => `
                        <div><span class="font-medium text-gray-700">${role}:</span> <span class="text-gray-900">${col}</span></div>
                    `).join('')}
                </div>
                <div class="mt-2 text-sm text-gray-500">${summary.columns.total_selected} columns selected</div>
            </div>

            <!-- Filters -->
            <div class="bg-gray-50 rounded-lg p-4">
                <h4 class="font-semibold text-gray-900 mb-2">Filters</h4>
                <ul class="list-disc list-inside text-sm text-gray-700">
                    ${summary.filters.summary.map(f => `<li>${f}</li>`).join('')}
                </ul>
            </div>

            <!-- Split -->
            <div class="bg-gray-50 rounded-lg p-4">
                <h4 class="font-semibold text-gray-900 mb-2">Train/Eval Split</h4>
                <p class="text-sm text-gray-700">${summary.split.summary}</p>
            </div>

            <!-- Cached Analysis -->
            ${summary.cached_analysis.has_analysis ? `
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h4 class="font-semibold text-blue-900 mb-2">Analysis Results</h4>
                <div class="grid grid-cols-3 gap-4 text-sm">
                    <div>
                        <div class="text-blue-700 font-medium">Rows</div>
                        <div class="text-blue-900 text-lg font-bold">${formatNumber(summary.cached_analysis.row_count)}</div>
                    </div>
                    <div>
                        <div class="text-blue-700 font-medium">Unique Users</div>
                        <div class="text-blue-900 text-lg font-bold">${formatNumber(summary.cached_analysis.unique_users)}</div>
                    </div>
                    <div>
                        <div class="text-blue-700 font-medium">Unique Products</div>
                        <div class="text-blue-900 text-lg font-bold">${formatNumber(summary.cached_analysis.unique_products)}</div>
                    </div>
                </div>
                ${summary.cached_analysis.date_range_start ? `
                <div class="mt-2 text-sm text-blue-700">
                    Date range: ${summary.cached_analysis.date_range_start} to ${summary.cached_analysis.date_range_end}
                </div>
                ` : ''}
            </div>
            ` : `
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <p class="text-sm text-yellow-800">
                    <i class="fas fa-info-circle mr-1"></i>
                    No analysis data yet. Click "Analyze" on the dataset card to run analysis.
                </p>
            </div>
            `}
        </div>
    `;

    document.getElementById('detailContent').innerHTML = html;
}

function editDataset(datasetId) {
    // Load dataset and open wizard in edit mode
    fetch(`/api/datasets/${datasetId}/`, {
        headers: { 'X-CSRFToken': csrftoken }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            openWizard(datasetId);
            loadDatasetForEdit(datasetId);
        } else {
            showNotification(data.message || 'Failed to load dataset', 'error');
        }
    })
    .catch(error => {
        console.error('Error loading dataset:', error);
        showNotification('Failed to load dataset', 'error');
    });
}

function loadDatasetForEdit(datasetId) {
    fetch(`/api/datasets/${datasetId}/`, {
        headers: { 'X-CSRFToken': csrftoken }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            const ds = data.dataset;

            // Populate wizard data
            wizardData.name = ds.name;
            wizardData.description = ds.description || '';
            wizardData.primaryTable = ds.primary_table;
            wizardData.secondaryTables = ds.secondary_tables || [];
            wizardData.joinConfig = ds.join_config || {};
            wizardData.selectedColumns = ds.selected_columns || {};
            wizardData.columnMapping = ds.column_mapping || {};
            wizardData.filters = ds.filters || {};
            wizardData.splitConfig = ds.split_config || {};

            // Update form fields
            document.getElementById('datasetName').value = ds.name;
            document.getElementById('datasetDescription').value = ds.description || '';

            // Update table selections
            renderPrimaryTableList();
            renderSecondaryTableList();

            validateCurrentStep();
        }
    })
    .catch(error => {
        console.error('Error loading dataset for edit:', error);
    });
}

function editDatasetFromDetail() {
    closeDetailModal();
    editDataset(currentDatasetId);
}

function deleteDataset(datasetId, name) {
    document.getElementById('deleteDatasetName').textContent = name;
    document.getElementById('deleteModal').classList.remove('hidden');
    document.getElementById('deleteModal').dataset.datasetId = datasetId;
    document.getElementById('deleteWarning').classList.add('hidden');
}

function closeDeleteModal() {
    document.getElementById('deleteModal').classList.add('hidden');
}

function confirmDelete() {
    const datasetId = document.getElementById('deleteModal').dataset.datasetId;

    document.getElementById('confirmDeleteBtn').disabled = true;
    document.getElementById('confirmDeleteBtn').innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Deleting...';

    fetch(`/api/datasets/${datasetId}/delete/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ force: true })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification('Dataset deleted successfully', 'success');
            closeDeleteModal();
            loadDatasets();
        } else {
            showNotification(data.message || 'Failed to delete dataset', 'error');
        }
    })
    .catch(error => {
        console.error('Error deleting dataset:', error);
        showNotification('Failed to delete dataset', 'error');
    })
    .finally(() => {
        document.getElementById('confirmDeleteBtn').disabled = false;
        document.getElementById('confirmDeleteBtn').textContent = 'Delete';
    });
}

function analyzeDataset(datasetId) {
    showNotification('Analyzing dataset...', 'info');

    fetch(`/api/datasets/${datasetId}/analyze/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification('Analysis complete', 'success');
            loadDatasets(); // Refresh to show new stats

            // If detail modal is open, refresh it
            if (!document.getElementById('detailModal').classList.contains('hidden') && currentDatasetId === datasetId) {
                viewDataset(datasetId);
            }
        } else {
            showNotification(data.message || 'Analysis failed', 'error');
        }
    })
    .catch(error => {
        console.error('Error analyzing dataset:', error);
        showNotification('Analysis failed', 'error');
    });
}

function activateDataset(datasetId) {
    fetch(`/api/datasets/${datasetId}/activate/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification('Dataset activated', 'success');
            loadDatasets();
        } else {
            showNotification(data.message || 'Failed to activate dataset', 'error');
        }
    })
    .catch(error => {
        console.error('Error activating dataset:', error);
        showNotification('Failed to activate dataset', 'error');
    });
}

// ============================================================================
// QUERY PREVIEW
// ============================================================================
function viewGeneratedQuery() {
    if (!currentDatasetId) return;

    document.getElementById('queryModal').classList.remove('hidden');
    document.getElementById('queryContent').textContent = 'Loading...';

    // Load all queries
    Promise.all([
        fetch(`/api/datasets/${currentDatasetId}/query/`, { headers: { 'X-CSRFToken': csrftoken } }).then(r => r.json()),
        fetch(`/api/datasets/${currentDatasetId}/query/split/`, { headers: { 'X-CSRFToken': csrftoken } }).then(r => r.json())
    ])
    .then(([fullData, splitData]) => {
        currentQueries = {
            full: fullData.status === 'success' ? fullData.query : 'Error loading query',
            train: splitData.status === 'success' ? splitData.queries.train.query : 'Error loading query',
            eval: splitData.status === 'success' ? splitData.queries.eval.query : 'Error loading query'
        };

        showQuery('full');

        if (fullData.validation) {
            const validation = fullData.validation;
            document.getElementById('queryValidation').innerHTML = `
                <div class="flex items-center gap-4">
                    <span class="text-gray-600"><i class="fas fa-database mr-1"></i>${formatBytes(validation.total_bytes_processed || 0)} processed</span>
                    <span class="text-gray-600"><i class="fas fa-dollar-sign mr-1"></i>Est. $${(validation.estimated_cost_usd || 0).toFixed(4)}</span>
                    ${validation.is_valid ? '<span class="text-green-600"><i class="fas fa-check-circle mr-1"></i>Valid</span>' : '<span class="text-red-600"><i class="fas fa-times-circle mr-1"></i>Invalid</span>'}
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error loading queries:', error);
        document.getElementById('queryContent').textContent = 'Error loading query';
    });
}

function showQuery(type) {
    document.getElementById('queryContent').textContent = currentQueries[type] || 'No query available';

    // Update tab styling
    document.querySelectorAll('.query-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === type);
        tab.classList.toggle('btn-primary', tab.dataset.tab === type);
        tab.classList.toggle('btn-secondary', tab.dataset.tab !== type);
    });
}

function copyQuery() {
    const query = document.getElementById('queryContent').textContent;
    navigator.clipboard.writeText(query).then(() => {
        showNotification('Query copied to clipboard', 'success');
    }).catch(() => {
        showNotification('Failed to copy query', 'error');
    });
}

function closeQueryModal() {
    document.getElementById('queryModal').classList.add('hidden');
}

function closeDetailModal() {
    document.getElementById('detailModal').classList.add('hidden');
}

// ============================================================================
// UTILITY FUNCTIONS
// ============================================================================
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full`;

    const colors = {
        success: 'bg-green-500 text-white',
        error: 'bg-red-500 text-white',
        warning: 'bg-yellow-500 text-white',
        info: 'bg-blue-500 text-white'
    };

    notification.classList.add(...colors[type].split(' '));
    notification.innerHTML = `
        <div class="flex items-center">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} mr-2"></i>
            <span>${escapeHtml(message)}</span>
        </div>
    `;

    document.body.appendChild(notification);

    // Animate in
    setTimeout(() => notification.classList.remove('translate-x-full'), 10);

    // Remove after delay
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatNumber(num) {
    if (!num) return '0';
    if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
    if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
    return num.toLocaleString();
}

function formatBytes(bytes) {
    if (!bytes) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}
</script>
{% endblock %}
