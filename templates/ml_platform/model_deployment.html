{% extends 'base_model.html' %}
{% load static %}

{% block title %}{{ model.name }} - Deployment{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/cards.css' %}">
<link rel="stylesheet" href="{% static 'css/endpoints_table.css' %}?v=2">
<link rel="stylesheet" href="{% static 'css/modals.css' %}?v=2">
<link rel="stylesheet" href="{% static 'css/exp_view_modal.css' %}?v=2">
<link rel="stylesheet" href="{% static 'css/deploy_wizard.css' %}?v=1">
{% endblock %}

{% block model_content %}
<!-- CHAPTER: SERVING ENDPOINTS -->
<div id="endpointsChapter" class="bg-white rounded-xl border border-black shadow-lg p-6">
    <!-- Header with Icon -->
    <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-3">
            <div class="chapter-icon" style="background: linear-gradient(135deg, #6366f1 0%, #818cf8 100%);">
                <i class="fas fa-rocket text-white text-lg"></i>
            </div>
            <h2 class="text-lg font-bold text-gray-900">Serving Endpoints</h2>
        </div>
    </div>

    <!-- KPI Summary Row -->
    <div id="endpointsKpiSummary" class="endpoints-kpi-row">
        <!-- Populated by JavaScript -->
        <div class="endpoints-loading">
            <i class="fas fa-spinner fa-spin"></i>
            <span class="endpoints-loading-text">Loading...</span>
        </div>
    </div>

    <!-- Filter Bar -->
    <div id="endpointsFilterBar" class="endpoints-filter-bar">
        <!-- Populated by JavaScript -->
    </div>

    <!-- Endpoints Table -->
    <div id="endpointsTable">
        <!-- Populated by JavaScript -->
    </div>

    <!-- Empty State (hidden by default) -->
    <div id="endpointsEmptyState" class="endpoints-empty-state" style="display: none;">
        <div class="empty-icon"><i class="fas fa-server"></i></div>
        <h3>No Deployed Endpoints</h3>
        <p>Deploy models from the Training page to create serving endpoints.</p>
    </div>
</div>
<!-- End Chapter: Serving Endpoints -->

<!-- =============================================================================
     EXPERIMENT VIEW MODAL (Reusable modal for endpoint/model/training run details)
     ============================================================================ -->
{% include 'includes/_exp_view_modal.html' %}

<!-- =============================================================================
     DEPLOY WIZARD MODAL (Cloud Run deployment with presets)
     ============================================================================ -->
{% include 'includes/_deploy_wizard.html' %}

<!-- =============================================================================
     CONFIRMATION MODAL (Reusable styled confirmation dialog)
     ============================================================================ -->
<div id="confirmModal" class="modal-overlay hidden">
    <div class="modal-container modal-container-sm">
        <div class="modal-header">
            <div id="confirmModalIcon" class="modal-header-icon warning">
                <i class="fas fa-exclamation-triangle text-xl"></i>
            </div>
            <h3 id="confirmModalTitle" class="modal-header-title">Confirm Action</h3>
        </div>
        <div class="modal-body">
            <p id="confirmModalMessage">Are you sure you want to proceed?</p>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button id="confirmModalConfirmBtn" class="btn-neu btn-neu-action btn-neu-cancel">
                    <span class="btn-neu-inner">Confirm</span>
                </button>
                <button id="confirmModalCancelBtn" class="btn-neu btn-neu-action btn-neu-secondary">
                    <span class="btn-neu-inner">Cancel</span>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js for Versions tab charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'js/exp_view_modal.js' %}?v=2"></script>

<!-- TrainingCards shim for styled confirmation modals (required by DeployWizard) -->
<script>
/**
 * Lightweight TrainingCards shim providing showConfirmModal functionality.
 * This allows DeployWizard to show styled modals instead of browser alerts.
 */
const TrainingCards = (function() {
    'use strict';

    let autoCloseTimer = null;

    function hideConfirmModal() {
        const modal = document.getElementById('confirmModal');
        if (modal) modal.classList.add('hidden');
        if (autoCloseTimer) {
            clearTimeout(autoCloseTimer);
            autoCloseTimer = null;
        }
    }

    /**
     * Show a styled confirmation modal
     * @param {Object} options - Modal options
     * @param {string} options.title - Modal title
     * @param {string} options.message - Modal message (can include HTML)
     * @param {string} options.confirmText - Confirm button text
     * @param {string} options.cancelText - Cancel button text
     * @param {string} options.type - Modal type: 'warning', 'danger', 'info', 'success'
     * @param {boolean} options.hideCancel - Hide the cancel button (for notifications)
     * @param {number} options.autoClose - Auto-close modal after N milliseconds
     * @param {Function} options.onConfirm - Callback when confirmed
     * @param {Function} options.onCancel - Callback when cancelled
     */
    function showConfirmModal(options) {
        const modal = document.getElementById('confirmModal');
        const icon = document.getElementById('confirmModalIcon');
        const title = document.getElementById('confirmModalTitle');
        const message = document.getElementById('confirmModalMessage');
        const confirmBtn = document.getElementById('confirmModalConfirmBtn');
        const cancelBtn = document.getElementById('confirmModalCancelBtn');

        if (!modal) return;

        // Set content
        title.textContent = options.title || 'Confirm Action';
        message.innerHTML = options.message || 'Are you sure you want to proceed?';

        // Update button text
        const confirmInner = confirmBtn.querySelector('.btn-neu-inner');
        const cancelInner = cancelBtn.querySelector('.btn-neu-inner');
        if (confirmInner) confirmInner.textContent = options.confirmText || 'Confirm';
        if (cancelInner) cancelInner.textContent = options.cancelText || 'Cancel';

        // Set icon and button styling based on type
        const type = options.type || 'warning';
        icon.className = `modal-header-icon ${type}`;
        const iconElement = icon.querySelector('i');
        const baseClasses = 'btn-neu btn-neu-action';

        if (type === 'danger') {
            iconElement.className = 'fas fa-trash-alt text-xl';
            confirmBtn.className = `${baseClasses} btn-neu-cancel`;
        } else if (type === 'warning') {
            iconElement.className = 'fas fa-exclamation-circle text-xl';
            confirmBtn.className = `${baseClasses} btn-neu-warning`;
        } else if (type === 'info') {
            iconElement.className = 'fas fa-info-circle text-xl';
            confirmBtn.className = `${baseClasses} btn-neu-nav-wide`;
        } else if (type === 'success') {
            iconElement.className = 'fas fa-check-circle text-xl';
            confirmBtn.className = `${baseClasses} btn-neu-save`;
        }

        // Hide/show cancel button
        cancelBtn.style.display = options.hideCancel ? 'none' : '';

        // Remove old event listeners by cloning
        const newConfirmBtn = confirmBtn.cloneNode(true);
        const newCancelBtn = cancelBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

        // Add new event listeners
        newConfirmBtn.addEventListener('click', () => {
            hideConfirmModal();
            if (options.onConfirm) options.onConfirm();
        });

        newCancelBtn.addEventListener('click', () => {
            hideConfirmModal();
            if (options.onCancel) options.onCancel();
        });

        // Show modal
        modal.classList.remove('hidden');

        // Auto-close if specified
        if (options.autoClose) {
            autoCloseTimer = setTimeout(() => {
                hideConfirmModal();
            }, options.autoClose);
        }
    }

    return {
        showConfirmModal: showConfirmModal,
        hideConfirmModal: hideConfirmModal
    };
})();
</script>

<script src="{% static 'js/deploy_wizard.js' %}?v=1"></script>
<script src="{% static 'js/endpoints_table.js' %}?v=5"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Configure DeployWizard to refresh endpoints table and modal on success
    if (typeof DeployWizard !== 'undefined') {
        DeployWizard.configure({
            onSuccess: function(result) {
                // Refresh the endpoints table
                if (typeof EndpointsTable !== 'undefined') {
                    EndpointsTable.refresh();
                }
                // Refresh the endpoint view modal if open
                if (typeof ExpViewModal !== 'undefined' && ExpViewModal.getCurrentEndpoint) {
                    const endpoint = ExpViewModal.getCurrentEndpoint();
                    if (endpoint && endpoint.id) {
                        // Clear cache and reload versions
                        ExpViewModal.openForEndpoint(endpoint.id);
                    }
                }
            }
        });
    }

    // Initialize Endpoints Table
    EndpointsTable.init({
        containerId: '#endpointsChapter',
        kpiContainerId: '#endpointsKpiSummary',
        filterBarId: '#endpointsFilterBar',
        tableContainerId: '#endpointsTable',
        emptyStateId: '#endpointsEmptyState',
        // GCP configuration
        region: 'europe-central2',
        project: 'b2b-recs'
    });
    EndpointsTable.load();
});
</script>
{% endblock %}
