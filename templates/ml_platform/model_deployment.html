{% extends 'base_model.html' %}
{% load static %}

{% block title %}{{ model.name }} - Deployment{% endblock %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/cards.css' %}">
<link rel="stylesheet" href="{% static 'css/endpoints_table.css' %}?v=4">
<link rel="stylesheet" href="{% static 'css/modals.css' %}?v=2">
<link rel="stylesheet" href="{% static 'css/exp_view_modal.css' %}?v=10">
<link rel="stylesheet" href="{% static 'css/deploy_wizard.css' %}?v=1">
<link rel="stylesheet" href="{% static 'css/integrate_modal.css' %}?v=1">
<link rel="stylesheet" href="{% static 'css/model_dashboard.css' %}?v=17">
<link rel="stylesheet" href="{% static 'css/endpoints_dashboard.css' %}?v=1">
{% endblock %}

{% block model_content %}
<!-- CHAPTER: ENDPOINTS DASHBOARD -->
<div id="endpointsDashboardChapter" class="chapter-container" data-chapter="endpoints-dashboard">
    <div class="chapter-header" onclick="toggleChapter(this)">
        <div class="chapter-header-top">
            <div class="chapter-title-wrapper">
                <div class="chapter-icon endpoints">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="chapter-title-text">
                    <span class="chapter-title">Endpoints Dashboard</span>
                    <span class="chapter-subtitle">Monitor performance and traffic metrics</span>
                </div>
            </div>
            <div class="chapter-toggle">
                <i class="fas fa-chevron-right"></i>
            </div>
        </div>
        <div class="chapter-divider"></div>
        <!-- KPI Row â€” always visible -->
        <div id="dashboardKpiSummary" class="dashboard-kpi-row"></div>
    </div>
    <div class="chapter-content">
        <div class="chapter-content-inner">
            <div class="chapter-divider" style="margin-top: 0;"></div>
            <!-- Charts Grid -->
            <div id="dashboardChartsGrid" class="dashboard-charts-grid"></div>
            <!-- Tables Section -->
            <div id="dashboardTablesSection" class="dashboard-tables-section"></div>
            <!-- Prometheus Section -->
            <div id="dashboardPrometheusSection" class="dashboard-prometheus-section"></div>
        </div>
    </div>
</div>
<!-- End Chapter: Endpoints Dashboard -->

<!-- CHAPTER: SERVING ENDPOINTS -->
<div id="endpointsChapter" class="bg-white rounded-xl border border-black shadow-lg p-6 mt-6">
    <!-- Header with Icon -->
    <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-3">
            <div class="chapter-icon" style="background: linear-gradient(135deg, #6366f1 0%, #818cf8 100%);">
                <i class="fas fa-rocket text-white"></i>
            </div>
            <div class="chapter-title-text">
                <span class="chapter-title">Serving Endpoints</span>
                <span class="chapter-subtitle">Manage deployed models and versions</span>
            </div>
        </div>
    </div>

    <!-- KPI Summary Row -->
    <div id="endpointsKpiSummary" class="endpoints-kpi-row">
        <!-- Populated by JavaScript -->
        <div class="endpoints-loading">
            <i class="fas fa-spinner fa-spin"></i>
            <span class="endpoints-loading-text">Loading...</span>
        </div>
    </div>

    <!-- Filter Bar -->
    <div id="endpointsFilterBar" class="endpoints-filter-bar">
        <!-- Populated by JavaScript -->
    </div>

    <!-- Endpoints Table -->
    <div id="endpointsTable">
        <!-- Populated by JavaScript -->
    </div>

    <!-- Empty State (hidden by default) -->
    <div id="endpointsEmptyState" class="endpoints-empty-state" style="display: none;">
        <div class="empty-icon"><i class="fas fa-server"></i></div>
        <h3>No Deployed Endpoints</h3>
        <p>Deploy models from the Training page to create serving endpoints.</p>
    </div>
</div>
<!-- End Chapter: Serving Endpoints -->

<!-- =============================================================================
     EXPERIMENT VIEW MODAL (Reusable modal for endpoint/model/training run details)
     ============================================================================ -->
{% include 'includes/_exp_view_modal.html' %}

<!-- =============================================================================
     DEPLOY WIZARD MODAL (Cloud Run deployment with presets)
     ============================================================================ -->
{% include 'includes/_deploy_wizard.html' %}

<!-- =============================================================================
     INTEGRATE MODAL (Endpoint testing and code examples)
     ============================================================================ -->
{% include 'includes/_integrate_modal.html' %}

<!-- =============================================================================
     CONFIRMATION MODAL (Reusable styled confirmation dialog)
     ============================================================================ -->
<div id="confirmModal" class="modal-overlay hidden">
    <div class="modal-container" style="max-width: 28rem;">
        <div class="modal-header">
            <div id="confirmModalIcon" class="modal-header-icon warning">
                <i class="fas fa-exclamation-triangle text-xl"></i>
            </div>
            <h3 id="confirmModalTitle" class="modal-header-title">Confirm Action</h3>
        </div>
        <div class="modal-body">
            <p id="confirmModalMessage">Are you sure you want to proceed?</p>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button id="confirmModalConfirmBtn" class="btn-neu btn-neu-action btn-neu-save">
                    <span class="btn-neu-inner">Ok</span>
                </button>
                <button id="confirmModalCancelBtn" class="btn-neu btn-neu-action btn-neu-cancel">
                    <span class="btn-neu-inner">Cancel</span>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<!-- Chart.js for Versions tab charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'js/exp_view_modal.js' %}?v=10"></script>

<!-- TrainingCards shim for styled confirmation modals (required by DeployWizard) -->
<script>
/**
 * Lightweight TrainingCards shim providing showConfirmModal functionality.
 * This allows DeployWizard to show styled modals instead of browser alerts.
 */
const TrainingCards = (function() {
    'use strict';

    let autoCloseTimer = null;

    function hideConfirmModal() {
        const modal = document.getElementById('confirmModal');
        if (modal) modal.classList.add('hidden');
        if (autoCloseTimer) {
            clearTimeout(autoCloseTimer);
            autoCloseTimer = null;
        }
    }

    /**
     * Show a styled confirmation modal
     * @param {Object} options - Modal options
     * @param {string} options.title - Modal title
     * @param {string} options.message - Modal message (can include HTML)
     * @param {string} options.confirmText - Confirm button text
     * @param {string} options.cancelText - Cancel button text
     * @param {string} options.type - Modal type: 'warning', 'danger', 'info', 'success'
     * @param {boolean} options.hideCancel - Hide the cancel button (for notifications)
     * @param {number} options.autoClose - Auto-close modal after N milliseconds
     * @param {Function} options.onConfirm - Callback when confirmed
     * @param {Function} options.onCancel - Callback when cancelled
     */
    function showConfirmModal(options) {
        const modal = document.getElementById('confirmModal');
        const icon = document.getElementById('confirmModalIcon');
        const title = document.getElementById('confirmModalTitle');
        const message = document.getElementById('confirmModalMessage');
        const confirmBtn = document.getElementById('confirmModalConfirmBtn');
        const cancelBtn = document.getElementById('confirmModalCancelBtn');

        if (!modal) return;

        // Set content
        title.textContent = options.title || 'Confirm Action';
        message.innerHTML = options.message || 'Are you sure you want to proceed?';

        // Update button text
        const confirmInner = confirmBtn.querySelector('.btn-neu-inner');
        const cancelInner = cancelBtn.querySelector('.btn-neu-inner');
        if (confirmInner) confirmInner.textContent = options.confirmText || 'Ok';
        if (cancelInner) cancelInner.textContent = options.cancelText || 'Cancel';

        // Set icon and button styling based on type
        const type = options.type || 'warning';
        icon.className = `modal-header-icon ${type}`;
        const iconElement = icon.querySelector('i');
        const baseClasses = 'btn-neu btn-neu-action';

        // Determine confirm button class (custom class takes precedence)
        let confirmButtonClass = options.confirmButtonClass;
        if (!confirmButtonClass) {
            if (type === 'danger') {
                iconElement.className = 'fas fa-trash-alt text-xl';
                confirmButtonClass = 'btn-neu-cancel';
            } else if (type === 'warning') {
                iconElement.className = 'fas fa-exclamation-circle text-xl';
                confirmButtonClass = 'btn-neu-warning';
            } else if (type === 'info') {
                iconElement.className = 'fas fa-info-circle text-xl';
                confirmButtonClass = 'btn-neu-nav-wide';
            } else if (type === 'success') {
                iconElement.className = 'fas fa-check-circle text-xl';
                confirmButtonClass = 'btn-neu-save';
            }
        } else {
            // Set icon based on type even when custom button class is provided
            if (type === 'danger') {
                iconElement.className = 'fas fa-trash-alt text-xl';
            } else if (type === 'warning') {
                iconElement.className = 'fas fa-exclamation-circle text-xl';
            } else if (type === 'info') {
                iconElement.className = 'fas fa-info-circle text-xl';
            } else if (type === 'success') {
                iconElement.className = 'fas fa-check-circle text-xl';
            }
        }
        confirmBtn.className = `${baseClasses} ${confirmButtonClass}`;

        // Set cancel button class (default: btn-neu-cancel for red)
        cancelBtn.className = `${baseClasses} ${options.cancelButtonClass || 'btn-neu-cancel'}`;

        // Hide/show cancel button
        cancelBtn.style.display = options.hideCancel ? 'none' : '';

        // Remove old event listeners by cloning
        const newConfirmBtn = confirmBtn.cloneNode(true);
        const newCancelBtn = cancelBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

        // Add new event listeners
        newConfirmBtn.addEventListener('click', () => {
            hideConfirmModal();
            if (options.onConfirm) options.onConfirm();
        });

        newCancelBtn.addEventListener('click', () => {
            hideConfirmModal();
            if (options.onCancel) options.onCancel();
        });

        // Show modal
        modal.classList.remove('hidden');

        // Auto-close if specified
        if (options.autoClose) {
            autoCloseTimer = setTimeout(() => {
                hideConfirmModal();
            }, options.autoClose);
        }
    }

    return {
        showConfirmModal: showConfirmModal,
        hideConfirmModal: hideConfirmModal
    };
})();
</script>

<script src="{% static 'js/deploy_wizard.js' %}?v=1"></script>
<script src="{% static 'js/integrate_modal.js' %}?v=1"></script>
<script src="{% static 'js/endpoints_table.js' %}?v=7"></script>
<script src="{% static 'js/endpoints_dashboard.js' %}?v=2"></script>
<script>
function toggleChapter(header) {
    const container = header.closest('.chapter-container');
    container.classList.toggle('open');
}

document.addEventListener('DOMContentLoaded', function() {
    // Configure DeployWizard to refresh endpoints table and modal on success
    // Configure modules with modelId for cross-tab safety
    if (typeof ExpViewModal !== 'undefined') {
        ExpViewModal.configure({ modelId: {{ model.id }} });
    }
    if (typeof IntegrateModal !== 'undefined') {
        IntegrateModal.configure({ modelId: {{ model.id }} });
    }

    if (typeof DeployWizard !== 'undefined') {
        DeployWizard.configure({
            modelId: {{ model.id }},
            onSuccess: function(result) {
                // Refresh the endpoints table
                if (typeof EndpointsTable !== 'undefined') {
                    EndpointsTable.refresh();
                }
                // Refresh the endpoint view modal if open
                if (typeof ExpViewModal !== 'undefined' && ExpViewModal.getCurrentEndpoint) {
                    const endpoint = ExpViewModal.getCurrentEndpoint();
                    if (endpoint && endpoint.id) {
                        // Clear cache and reload versions
                        ExpViewModal.openForEndpoint(endpoint.id);
                    }
                }
            }
        });
    }

    // Initialize Endpoints Table
    EndpointsTable.init({
        containerId: '#endpointsChapter',
        kpiContainerId: '#endpointsKpiSummary',
        filterBarId: '#endpointsFilterBar',
        tableContainerId: '#endpointsTable',
        emptyStateId: '#endpointsEmptyState',
        modelId: {{ model.id }},
        // GCP configuration
        region: 'europe-central2',
        project: 'b2b-recs'
    });
    EndpointsTable.load();

    // Initialize Endpoints Dashboard
    EndpointsDashboard.init({
        containerId: '#endpointsDashboardChapter',
        kpiContainerId: '#dashboardKpiSummary',
        chartsContainerId: '#dashboardChartsGrid',
        tablesContainerId: '#dashboardTablesSection',
        prometheusContainerId: '#dashboardPrometheusSection',
        modelId: {{ model.id }}
    });
    EndpointsDashboard.load();
});
</script>
{% endblock %}
