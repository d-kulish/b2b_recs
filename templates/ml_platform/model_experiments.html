{% extends 'base_model.html' %}
{% load humanize %}
{% load static %}

{% block title %}{{ model.name }} - Experiments{% endblock %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/model_dashboard.css' %}?v=1">
<link rel="stylesheet" href="{% static 'css/cards.css' %}?v=4">
<link rel="stylesheet" href="{% static 'css/modals.css' %}?v=2">
<link rel="stylesheet" href="{% static 'css/pipeline_dag.css' %}?v=1">
<link rel="stylesheet" href="{% static 'css/exp_view_modal.css' %}?v=3">
<style>
    /* =========================================================================
       Chapter Section Styles (overrides for experiments page)
       ========================================================================= */
    .chapter-empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 48px 24px;
        color: #9ca3af;
        text-align: center;
    }
    .chapter-empty-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
    }
    .chapter-empty-text {
        font-size: 14px;
        max-width: 300px;
    }

    /* =========================================================================
       Filter Bar Styles
       ========================================================================= */
    .exp-filter-bar {
        display: flex;
        align-items: flex-end;
        gap: 16px;
        margin-bottom: 16px;
        flex-wrap: wrap;
    }
    .exp-filter-group {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    .exp-filter-label {
        font-size: 11px;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    .exp-filter-select {
        padding: 6px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        font-size: 13px;
        background: white;
        min-width: 130px;
    }
    .exp-filter-select:focus {
        outline: none;
        border-color: #f59e0b;
        box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.1);
    }
    .exp-search-input {
        flex: 1;
        min-width: 200px;
        padding: 6px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        font-size: 13px;
        background: white;
    }
    .exp-search-input:focus {
        outline: none;
        border-color: #f59e0b;
        box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.1);
    }
    .exp-search-input::placeholder {
        color: #9ca3af;
    }

    /* =========================================================================
       Experiment Card Styles
       ========================================================================= */
    .exp-cards-container {
        max-height: 360px;
        overflow-y: auto;
        margin-bottom: 16px;
    }
    .exp-card {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        margin-bottom: 10px;
        background: white;
        transition: all 0.2s ease;
        cursor: pointer;
    }
    .exp-card:hover {
        border-color: #d1d5db;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    .exp-card:last-child {
        margin-bottom: 0;
    }
    .exp-card-status {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        flex-shrink: 0;
    }
    .exp-card-status.running {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        color: #2563eb;
    }
    .exp-card-status.completed {
        background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
        color: #16a34a;
    }
    .exp-card-status.failed {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        color: #dc2626;
    }
    .exp-card-status.cancelled {
        background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        color: #6b7280;
    }
    .exp-card-status.submitting {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        color: #2563eb;
    }
    .exp-card-info {
        flex: 1;
        min-width: 0;
    }
    .exp-card-name {
        font-weight: 600;
        font-size: 15px;
        color: #111827;
        margin-bottom: 4px;
    }
    .exp-card-custom-name {
        font-weight: 400;
        color: #6b7280;
    }
    .exp-card-configs {
        font-size: 13px;
        color: #4b5563;
        margin-bottom: 2px;
    }
    .exp-card-meta {
        font-size: 12px;
        color: #9ca3af;
    }
    .exp-card-metric {
        text-align: right;
        flex-shrink: 0;
    }
    .exp-card-metric-value {
        font-size: 18px;
        font-weight: 700;
        color: #111827;
    }
    .exp-card-metric-label {
        font-size: 11px;
        color: #6b7280;
        text-transform: uppercase;
    }
    .exp-card-progress {
        text-align: right;
        flex-shrink: 0;
        min-width: 80px;
    }
    .exp-card-progress-bar {
        height: 6px;
        width: 80px;
        background: #e5e7eb;
        border-radius: 3px;
        overflow: hidden;
        margin-bottom: 4px;
    }
    .exp-card-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #3b82f6, #60a5fa);
        border-radius: 3px;
        transition: width 0.3s ease;
    }
    .exp-card-progress-text {
        font-size: 12px;
        color: #6b7280;
    }

    /* =========================================================================
       Stage Progress Bar (for running/submitting experiments)
       Styled like tensor-breakdown-bar from model_configs.html
       ========================================================================= */
    .exp-card-stages {
        width: 100%;
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #f3f4f6;
    }
    .exp-stages-bar {
        display: flex;
        height: 24px;
        border-radius: 6px;
        overflow: hidden;
        background: #e5e7eb;
    }
    .exp-stage-segment {
        flex: 1;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: 500;
        color: white;
        text-transform: uppercase;
        letter-spacing: 0.02em;
        white-space: nowrap;
        overflow: hidden;
        transition: background-color 0.3s ease;
    }
    /* Completed segments get gradient colors via inline styles */
    .exp-stage-segment.running {
        background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 50%, #3b82f6 100%);
        background-size: 200% 100%;
        animation: stage-pulse 1.5s ease-in-out infinite;
    }
    .exp-stage-segment.failed {
        background: #ef4444;
    }
    .exp-stage-segment.pending {
        background: #d1d5db;
        color: #6b7280;
    }
    .exp-stage-segment.cancelled {
        background: #f59e0b;
        color: white;
    }
    @keyframes stage-pulse {
        0%, 100% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
    }

    /* Experiment card - column layout */
    .exp-card-new {
        display: flex;
        flex-direction: column;
        padding: 16px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        margin-bottom: 8px;
        transition: all 0.15s ease;
        cursor: pointer;
    }
    .exp-card-new:hover {
        border-color: #d1d5db;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    .exp-card-new:last-child {
        margin-bottom: 0;
    }
    .exp-card-columns {
        display: flex;
        align-items: flex-start;
        gap: 16px;
        margin-bottom: 8px;
    }
    /* Column 1: Experiment Info (30%) */
    .exp-card-col-info {
        width: 30%;
        min-width: 0;
        display: flex;
        align-items: flex-start;
        gap: 12px;
    }
    .exp-compare-label {
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        padding: 4px;
    }
    .exp-compare-checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: #f59e0b;
    }
    .exp-card-info-text {
        flex: 1;
        min-width: 0;
    }
    .exp-card-name {
        font-weight: 600;
        font-size: 15px;
        color: #111827;
        margin-bottom: 2px;
    }
    .exp-card-custom-name {
        font-weight: 400;
        color: #6b7280;
    }
    .exp-card-exp-name {
        font-size: 13px;
        color: #374151;
        margin-bottom: 2px;
    }
    .exp-card-description {
        font-size: 12px;
        color: #9ca3af;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .exp-card-times {
        display: flex;
        gap: 12px;
        font-size: 11px;
        color: #9ca3af;
        margin-top: 4px;
    }
    .exp-card-times span {
        color: #6b7280;
    }
    /* Column 2: Config Info (20%) */
    .exp-card-col-config {
        width: 20%;
        min-width: 0;
    }
    .exp-card-config-item {
        font-size: 12px;
        font-weight: 400;
        color: #374151;
        margin-bottom: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .exp-card-config-label {
        font-weight: 600;
        color: #6b7280;
    }
    /* Model type badge (unified style matching model_configs.html) */
    .exp-card-type-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 500;
        white-space: nowrap;
    }
    .exp-card-type-badge i {
        font-size: 9px;
    }
    .exp-card-type-badge.retrieval {
        background: #dbeafe;
        color: #1e40af;
        border: 1px solid #bfdbfe;
    }
    .exp-card-type-badge.ranking {
        background: #fef3c7;
        color: #92400e;
        border: 1px solid #fde68a;
    }
    .exp-card-type-badge.multitask {
        background: linear-gradient(135deg, #dbeafe 0%, #f3e8ff 100%);
        color: #6b21a8;
        border: 1px solid #e9d5ff;
    }
    /* Column 3: Training Params / Metrics (30%) */
    .exp-card-col-params {
        width: 30%;
        min-width: 0;
        font-size: 12px;
        color: #9ca3af;
        display: flex;
        align-items: center;
    }
    /* Metrics row within Column 3 */
    .exp-card-metrics-row {
        display: flex;
        gap: 8px;
        width: 100%;
    }
    .exp-card-metric {
        text-align: center;
        flex: 1;
        padding: 6px 4px;
        background: #ffffff;
        border: 1px solid #1f2937;
        border-radius: 6px;
    }
    .exp-card-metric-label {
        font-size: 10px;
        color: #1f2937;
        font-weight: 500;
        margin-bottom: 2px;
    }
    .exp-card-metric-value {
        font-size: 13px;
        font-weight: 600;
        color: #1f2937;
    }
    .exp-card-metric-value.empty {
        color: #9ca3af;
    }
    /* Multitask metrics display - two rows of metrics */
    .exp-card-metrics-multitask {
        display: flex;
        flex-direction: column;
        gap: 6px;
        width: 100%;
    }
    .exp-card-metrics-section {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    .exp-card-metrics-section-label {
        font-size: 9px;
        color: #6b7280;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: flex;
        align-items: center;
        gap: 4px;
    }
    .exp-card-metrics-section-label i {
        font-size: 8px;
    }
    .exp-card-metrics-multitask .exp-card-metrics-row {
        gap: 4px;
    }
    .exp-card-metrics-multitask .exp-card-metric {
        padding: 4px 2px;
    }
    .exp-card-metrics-multitask .exp-card-metric-label {
        font-size: 9px;
    }
    .exp-card-metrics-multitask .exp-card-metric-value {
        font-size: 11px;
    }
    /* Column 4: Actions (20%) */
    .exp-card-col-actions {
        width: 20%;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: flex-end;
        gap: 6px;
    }
    .exp-card-actions-row {
        display: flex;
        flex-direction: row;
        gap: 6px;
        justify-content: flex-end;
    }
    /* Legacy support */
    .exp-card-header {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .exp-card-body {
        flex: 1;
        min-width: 0;
    }

    /* =========================================================================
       Wizard Modal Styles (extending modals.css)
       ========================================================================= */

    /* Config Preview Panels */
    .config-preview-panel {
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 16px;
        margin-top: 12px;
        background: #f9fafb;
    }
    .config-preview-panel.feature {
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        border-color: #bae6fd;
    }
    .config-preview-panel.model {
        background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
        border-color: #e9d5ff;
    }
    .config-preview-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
    }
    .config-preview-name {
        font-weight: 600;
        font-size: 15px;
        color: #111827;
    }
    .config-preview-empty {
        text-align: center;
        padding: 24px;
        color: #9ca3af;
        font-size: 13px;
    }

    /* Model Type Selector (Wizard Step 1) - Modern Compact Design */
    .wizard-model-type-selector {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
    }
    .wizard-model-type-option {
        padding: 8px 10px;
        border: 1.5px solid #e5e7eb;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.15s ease;
        display: flex;
        align-items: center;
        gap: 10px;
        background: #fafafa;
    }
    .wizard-model-type-option:hover:not(.disabled) {
        border-color: #f59e0b;
        background: #fffbeb;
    }
    .wizard-model-type-option.selected {
        border-color: #f59e0b;
        background: #fef3c7;
        box-shadow: 0 0 0 1px #f59e0b inset;
    }
    .wizard-model-type-option.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .wizard-model-type-icon {
        width: 32px;
        height: 32px;
        min-width: 32px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        flex-shrink: 0;
    }
    .wizard-model-type-icon.retrieval {
        background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
        color: white;
    }
    .wizard-model-type-icon.ranking {
        background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
        color: white;
    }
    .wizard-model-type-icon.multitask {
        background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
        color: white;
    }
    .wizard-model-type-content {
        flex: 1;
        text-align: left;
        min-width: 0;
    }
    .wizard-model-type-name {
        font-weight: 600;
        color: #111827;
        font-size: 13px;
        line-height: 1.2;
    }
    .wizard-model-type-desc {
        font-size: 10px;
        color: #6b7280;
        line-height: 1.2;
        margin-top: 1px;
    }

    /* Target Column Card (for Ranking configs in wizard) */
    .target-column-card {
        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        border: 1.5px solid #fbbf24;
        border-radius: 10px;
        padding: 12px 14px;
    }
    .target-column-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
        font-size: 13px;
        font-weight: 600;
        color: #b45309;
    }
    .target-column-header i {
        color: #f59e0b;
    }
    .target-column-badge {
        background: #fbbf24;
        color: white;
        font-size: 10px;
        font-weight: 600;
        padding: 2px 8px;
        border-radius: 10px;
        margin-left: auto;
    }
    .target-column-content {
        display: flex;
        align-items: center;
        gap: 10px;
        background: white;
        border: 1px solid #fcd34d;
        border-radius: 8px;
        padding: 8px 12px;
    }
    .target-column-name {
        font-weight: 600;
        color: #92400e;
        font-size: 14px;
    }
    .target-column-type {
        background: #fef3c7;
        color: #b45309;
        font-size: 11px;
        font-weight: 500;
        padding: 2px 8px;
        border-radius: 4px;
        text-transform: uppercase;
    }
    .target-column-transforms {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 10px;
    }
    .target-transform-tag {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        background: white;
        border: 1px solid #fcd34d;
        color: #92400e;
        font-size: 11px;
        padding: 3px 8px;
        border-radius: 6px;
    }
    .target-transform-tag i {
        font-size: 10px;
        color: #f59e0b;
    }

    /* Target Column Card (for Overview tab - ranking models) */
    .target-column-view-card {
        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        border: 1.5px solid #fbbf24;
        border-radius: 10px;
        padding: 12px 14px;
        margin-bottom: 16px;
    }
    .target-column-view-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
        font-size: 13px;
        font-weight: 600;
        color: #b45309;
    }
    .target-column-view-header i {
        color: #f59e0b;
    }
    .target-column-view-badge {
        background: #fbbf24;
        color: white;
        font-size: 10px;
        font-weight: 600;
        padding: 2px 8px;
        border-radius: 10px;
        margin-left: auto;
    }
    .target-column-view-content {
        display: flex;
        align-items: center;
        gap: 10px;
        background: white;
        border: 1px solid #fcd34d;
        border-radius: 8px;
        padding: 8px 12px;
    }
    .target-column-view-name {
        font-weight: 600;
        color: #92400e;
        font-size: 14px;
    }
    .target-column-view-type {
        background: #fef3c7;
        color: #b45309;
        font-size: 11px;
        font-weight: 500;
        padding: 2px 8px;
        border-radius: 4px;
        text-transform: uppercase;
    }
    .target-column-view-transforms {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 10px;
    }

    /* Tensor Preview in Wizard */
    .tensor-preview-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }
    .tensor-preview-item {
        padding: 12px;
        background: white;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
    }
    .tensor-preview-item.buyer {
        border-left: 3px solid #3b82f6;
    }
    .tensor-preview-item.product {
        border-left: 3px solid #10b981;
    }
    .tensor-preview-title {
        font-size: 12px;
        font-weight: 600;
        color: #6b7280;
        margin-bottom: 8px;
        text-transform: uppercase;
    }
    .tensor-preview-dim {
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 8px;
    }
    .tensor-preview-dim.buyer { color: #3b82f6; }
    .tensor-preview-dim.product { color: #10b981; }
    .tensor-preview-features {
        font-size: 12px;
        color: #6b7280;
        max-height: 80px;
        overflow-y: auto;
    }
    .tensor-preview-features div {
        padding: 2px 0;
    }

    /* Tensor Breakdown Bar */
    .tensor-breakdown-bar {
        display: flex;
        height: 24px;
        border-radius: 6px;
        overflow: hidden;
        background: #e5e7eb;
        margin-bottom: 8px;
    }
    .tensor-breakdown-segment {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: 500;
        color: white;
        transition: width 0.3s ease;
        overflow: hidden;
        white-space: nowrap;
    }

    /* Tower Preview in Wizard - Rich Visualization */
    .tower-visual {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }
    .tower-visual-aligned .tower-stack {
        display: flex;
        flex-direction: column;
    }
    .tower-visual-aligned .tower-column {
        display: flex;
        flex-direction: column;
    }
    .tower-visual-aligned .tower-stack {
        flex: 1;
    }
    .tower-column {
        min-width: 0;
    }
    .tower-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 6px;
    }
    .tower-label {
        font-size: 10px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #6b7280;
    }
    .tower-stack {
        display: flex;
        flex-direction: column;
        gap: 8px;
        border-radius: 10px;
        padding: 12px;
        border: 2px dashed;
    }
    .tower-stack.buyer {
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        border-color: #3b82f6;
    }
    .tower-stack.product {
        background: linear-gradient(135deg, #f0fdf4 0%, #d1fae5 100%);
        border-color: #10b981;
    }
    .tower-stack.ranking {
        background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
        border-color: #8b5cf6;
    }
    .card-layer-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 12px;
        background: white;
        border-radius: 8px;
        border: 1px solid rgba(0, 0, 0, 0.08);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
    }
    .tower-stack.buyer .card-layer-item {
        border-color: rgba(59, 130, 246, 0.2);
    }
    .tower-stack.product .card-layer-item {
        border-color: rgba(16, 185, 129, 0.2);
    }
    .tower-stack.ranking .card-layer-item {
        border-color: rgba(139, 92, 246, 0.2);
    }

    /* Rating Head Section (for Ranking models in wizard) */
    .wizard-rating-head-section {
        margin-top: 16px;
        padding: 14px;
        background: linear-gradient(135deg, #fdf4ff 0%, #fae8ff 100%);
        border: 2px dashed #d946ef;
        border-radius: 12px;
    }
    .wizard-rating-head-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 12px;
    }
    .wizard-rating-head-icon {
        width: 28px;
        height: 28px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #d946ef 0%, #a855f7 100%);
        color: white;
        font-size: 12px;
    }
    .wizard-rating-head-title {
        font-size: 13px;
        font-weight: 600;
        color: #86198f;
    }
    .wizard-rating-head-summary {
        margin-left: auto;
        font-size: 12px;
        font-weight: 600;
        color: #a855f7;
    }
    .wizard-rating-head-layers {
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid #f0abfc;
        border-radius: 8px;
        padding: 8px;
    }
    .wizard-rating-head-layers .card-layer-item {
        border-color: rgba(217, 70, 239, 0.2);
    }
    .wizard-rating-head-params {
        display: flex;
        gap: 16px;
        margin-top: 10px;
        font-size: 11px;
        color: #86198f;
    }
    .wizard-rating-head-params span {
        color: #a855f7;
        font-weight: 600;
    }

    .card-layer-item.output-layer {
        border: 2px solid #f87171 !important;
    }
    .card-layer-item.empty-placeholder {
        background: transparent;
        border: 1px dashed rgba(0, 0, 0, 0.1);
        visibility: hidden;
    }
    .card-layer-item .card-drag-handle {
        color: #c4c4c4;
        font-size: 12px;
    }
    .card-layer-badge {
        display: inline-flex;
        align-items: center;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        flex-shrink: 0;
    }
    .card-layer-badge.dense {
        background: #e5e7eb;
        color: #374151;
    }
    .card-layer-badge.dropout {
        background: #fef3c7;
        color: #92400e;
    }
    .card-layer-badge.batch_norm {
        background: #d1fae5;
        color: #065f46;
    }
    .card-layer-badge.layer_norm {
        background: #e0e7ff;
        color: #3730a3;
    }
    .card-layer-params {
        flex: 1;
        font-size: 12px;
        color: #4b5563;
    }
    .tower-params-summary {
        margin: 8px 0 0 0;
        padding: 10px 12px;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 8px;
        border-top: 2px solid rgba(0, 0, 0, 0.1);
        font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
        font-size: 11px;
    }
    .tower-params-summary .params-row {
        display: flex;
        justify-content: space-between;
        color: #6b7280;
    }
    .tower-params-summary .params-row span:last-child {
        font-weight: 600;
        color: #374151;
    }

    /* Training Params Preview */
    .training-params-preview {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
    }
    .param-chip {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        background: #f3f4f6;
        border-radius: 6px;
        font-size: 12px;
    }
    .param-chip-label {
        color: #6b7280;
    }
    .param-chip-value {
        font-weight: 600;
        color: #374151;
    }
    .param-chip.retrieval-algo {
        background: #f5f3ff;
        border: 1px solid #e9d5ff;
    }
    .param-chip.retrieval-algo .param-chip-value {
        color: #7c3aed;
    }

    /* Sample Percent Buttons */
    .sample-btn {
        padding: 4px 10px;
        font-size: 12px;
        font-weight: 500;
        border: 1px solid #fcd34d;
        background: white;
        color: #92400e;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.15s ease;
    }
    .sample-btn:hover {
        background: #fef3c7;
        border-color: #f59e0b;
    }
    .sample-btn.active {
        background: #f59e0b;
        border-color: #d97706;
        color: white;
    }

    /* Training Params in Wizard Step 2 */
    .training-params-section {
        background: #fef3c7;
        border: 1px solid #fcd34d;
        border-radius: 10px;
        padding: 16px;
        margin-bottom: 16px;
    }
    .training-params-section h4 {
        font-size: 14px;
        font-weight: 600;
        color: #92400e;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .training-params-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }
    .training-param-group label {
        display: block;
        font-size: 12px;
        color: #92400e;
        margin-bottom: 4px;
    }
    .training-param-group select,
    .training-param-group input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #fcd34d;
        border-radius: 6px;
        font-size: 13px;
        background: white;
    }
    .training-param-group select:focus,
    .training-param-group input:focus {
        outline: none;
        border-color: #f59e0b;
        box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2);
    }

    /* Training Parameter Buttons (blue theme) */
    .param-btn {
        padding: 6px 8px;
        font-size: 12px;
        font-weight: 500;
        border: 1px solid #93c5fd;
        background: white;
        color: #1e40af;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.15s ease;
        flex: 1;
        text-align: center;
    }
    .param-btn:hover {
        background: #dbeafe;
        border-color: #3b82f6;
    }
    .param-btn.active {
        background: #3b82f6;
        border-color: #2563eb;
        color: white;
    }
    .param-input {
        flex: 1;
        padding: 6px 8px;
        font-size: 12px;
        border: 1px solid #93c5fd;
        border-radius: 4px;
        text-align: center;
        background: white;
    }
    .param-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }

    /* Hardware Selection Section */
    .hardware-section {
        background: linear-gradient(135deg, #fdf4ff 0%, #faf5ff 100%);
        border: 1px solid #e9d5ff;
        border-radius: 10px;
        padding: 16px 20px;
        margin-bottom: 16px;
    }
    .hardware-section h4 {
        font-size: 13px;
        font-weight: 600;
        color: #7c3aed;
        margin: 0 0 4px 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .hardware-recommendation {
        font-size: 11px;
        color: #9333ea;
        margin-bottom: 12px;
    }
    .hardware-recommendation strong {
        color: #7c3aed;
    }
    .hardware-options {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    .hardware-card {
        flex: 1;
        min-width: 120px;
        max-width: 160px;
        background: white;
        border: 2px solid #e9d5ff;
        border-radius: 8px;
        padding: 10px;
        cursor: pointer;
        transition: all 0.15s ease;
        position: relative;
    }
    .hardware-card:hover:not(.disabled) {
        border-color: #c084fc;
        box-shadow: 0 2px 8px rgba(147, 51, 234, 0.15);
    }
    .hardware-card.selected {
        border-color: #9333ea;
        background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
    }
    .hardware-card.selected::after {
        content: '\f00c';
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
        position: absolute;
        top: 8px;
        right: 8px;
        color: #9333ea;
        font-size: 12px;
    }
    .hardware-card.recommended::before {
        content: '\f005';
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
        position: absolute;
        top: 8px;
        left: 8px;
        color: #f59e0b;
        font-size: 10px;
    }
    .hardware-card.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: #f9fafb;
    }
    .hardware-card-title {
        font-size: 13px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 2px;
    }
    .hardware-card-type {
        font-size: 10px;
        color: #6b7280;
        font-family: monospace;
        margin-bottom: 6px;
    }
    .hardware-card-specs {
        font-size: 11px;
        color: #4b5563;
        line-height: 1.4;
    }
    .hardware-card-lock {
        position: absolute;
        top: 8px;
        right: 8px;
        color: #9ca3af;
        font-size: 12px;
    }

    /* Summary Section - Modern Card Layout */
    .exp-summary-section {
        background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
        border: 1px solid #a7f3d0;
        border-radius: 10px;
        padding: 16px 20px;
    }
    .exp-summary-title {
        font-size: 12px;
        font-weight: 600;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .exp-summary-title i {
        color: #6366f1;
    }
    .exp-summary-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px 24px;
    }
    .exp-summary-item {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    .exp-summary-label {
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        color: #94a3b8;
    }
    .exp-summary-value {
        font-size: 13px;
        font-weight: 600;
        color: #1e293b;
    }
    .exp-summary-value.accent {
        color: #6366f1;
    }
    .exp-summary-params {
        grid-column: span 4;
        display: flex;
        gap: 20px;
        padding-top: 12px;
        border-top: 1px solid #f1f5f9;
        margin-top: 4px;
    }
    .exp-summary-param {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background: #f8fafc;
        border-radius: 6px;
    }
    .exp-summary-param-label {
        font-size: 11px;
        color: #64748b;
    }
    .exp-summary-param-value {
        font-size: 12px;
        font-weight: 600;
        color: #334155;
    }

    /* =========================================================================
       Progress Modal Styles
       ========================================================================= */
    .quicktest-progress-bar {
        height: 24px;
        background: #e5e7eb;
        border-radius: 12px;
        overflow: hidden;
        position: relative;
    }
    .quicktest-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #3b82f6, #60a5fa);
        border-radius: 12px;
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .quicktest-progress-fill.animated {
        background: linear-gradient(90deg, #3b82f6, #60a5fa, #3b82f6);
        background-size: 200% 100%;
        animation: progress-shimmer 2s linear infinite;
    }
    @keyframes progress-shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
    .quicktest-progress-text {
        color: white;
        font-size: 12px;
        font-weight: 600;
    }
    .quicktest-stage {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        border-radius: 8px;
        margin-bottom: 8px;
        background: #f9fafb;
    }
    .quicktest-stage.completed { background: #ecfdf5; }
    .quicktest-stage.running { background: #eff6ff; }
    .quicktest-stage.failed { background: #fef2f2; }
    .quicktest-stage-icon {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
    }
    .quicktest-stage-icon.completed { color: #10b981; }
    .quicktest-stage-icon.running { color: #3b82f6; }
    .quicktest-stage-icon.failed { color: #ef4444; }
    .quicktest-stage-icon.pending { color: #9ca3af; }
    .quicktest-stage-name {
        flex: 1;
        font-weight: 500;
        color: #374151;
    }
    .quicktest-stage-duration {
        font-size: 12px;
        color: #6b7280;
    }

    /* Results Modal Metrics */
    .quicktest-metric {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #e5e7eb;
    }
    .quicktest-metric:last-child { border-bottom: none; }
    .quicktest-metric-label { color: #6b7280; }
    .quicktest-metric-value {
        font-weight: 600;
        color: #111827;
    }
    /* =========================================================================
       Toast Notification Styles
       ========================================================================= */
    .toast-container {
        position: fixed;
        top: 24px;
        right: 24px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 12px;
        pointer-events: none;
    }
    .toast {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15), 0 2px 10px rgba(0, 0, 0, 0.1);
        pointer-events: auto;
        animation: toastSlideIn 0.3s ease-out;
        max-width: 400px;
        border-left: 4px solid;
    }
    .toast.success {
        border-left-color: #10b981;
    }
    .toast.error {
        border-left-color: #ef4444;
    }
    .toast-icon {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    .toast.success .toast-icon {
        background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
        color: white;
    }
    .toast.error .toast-icon {
        background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
        color: white;
    }
    .toast-content {
        flex: 1;
        min-width: 0;
    }
    .toast-title {
        font-size: 14px;
        font-weight: 600;
        color: #111827;
        margin-bottom: 2px;
    }
    .toast-message {
        font-size: 13px;
        color: #6b7280;
        line-height: 1.4;
    }
    .toast-close {
        width: 28px;
        height: 28px;
        border-radius: 6px;
        border: none;
        background: transparent;
        color: #9ca3af;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: all 0.15s ease;
    }
    .toast-close:hover {
        background: #f3f4f6;
        color: #374151;
    }
    @keyframes toastSlideIn {
        from {
            opacity: 0;
            transform: translateX(100%);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    @keyframes toastSlideOut {
        from {
            opacity: 1;
            transform: translateX(0);
        }
        to {
            opacity: 0;
            transform: translateX(100%);
        }
    }
    .toast.hiding {
        animation: toastSlideOut 0.2s ease-in forwards;
    }

    /* =========================================================================
       Experiments Dashboard Chapter Styles
       ========================================================================= */
    .chapter-icon.dashboard {
        background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
    }
    .chapter-subtitle {
        font-size: 13px;
        color: #6b7280;
        margin-top: 2px;
    }

    /* Dashboard KPI Row - styled like accuracy metrics */
    .dashboard-kpi-row {
        display: flex;
        gap: 8px;
        margin-bottom: 24px;
    }
    .dashboard-kpi {
        flex: 1 1 0;
        min-width: 0;
        text-align: center;
        padding: 10px 6px;
        background: #ffffff;
        border: 1px solid #1f2937;
        border-radius: 6px;
        box-sizing: border-box;
    }
    .dashboard-kpi-label {
        font-size: 10px;
        color: #1f2937;
        font-weight: 500;
        margin-bottom: 4px;
        text-transform: uppercase;
    }
    .dashboard-kpi-value {
        font-size: 16px;
        font-weight: 600;
        color: #1f2937;
    }
    .dashboard-kpi-value.highlight {
        color: #10b981;
    }
    .dashboard-kpi-value.empty {
        color: #9ca3af;
    }
    @media (max-width: 768px) {
        .dashboard-kpi-row {
            flex-wrap: wrap;
        }
        .dashboard-kpi {
            flex: 1 1 calc(33.333% - 6px);
        }
    }

    /* Dashboard KPI + Trend Row (40% KPIs / 60% Chart) */
    .dashboard-kpi-trend-row {
        display: flex;
        gap: 16px;
        margin-bottom: 0;
    }
    .dashboard-kpi-trend-row .dashboard-model-sections {
        flex: 0 0 40%;
        max-width: 40%;
    }
    .dashboard-kpi-trend-row .dashboard-trend-panel {
        flex: 0 0 59%;
        max-width: 59%;
    }
    /* Dashboard Model Type Sections - Vertical KPI columns */
    .dashboard-model-sections {
        display: flex;
        gap: 8px;
    }
    .dashboard-model-section {
        flex: 1;
        background: white;
        border: 1px solid #1f2937;
        border-radius: 8px;
        padding: 10px;
        display: flex;
        flex-direction: column;
    }
    .dashboard-model-header {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 8px;
        padding-bottom: 6px;
        border-bottom: 1px solid #e5e7eb;
    }
    .dashboard-model-icon {
        width: 20px;
        height: 20px;
        border-radius: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        color: white;
    }
    .dashboard-model-icon.retrieval {
        background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
    }
    .dashboard-model-icon.ranking {
        background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
    }
    .dashboard-model-icon.hybrid {
        background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
    }
    .dashboard-model-title {
        font-size: 11px;
        font-weight: 600;
        color: #374151;
        text-transform: uppercase;
        letter-spacing: 0.03em;
    }
    /* Vertical KPI Stack */
    .dashboard-kpi-stack {
        display: flex;
        flex-direction: column;
        gap: 4px;
        flex: 1;
    }
    .dashboard-kpi-compact {
        text-align: center;
        padding: 5px 4px;
        background: white;
        border: 1px solid #1f2937;
        border-radius: 6px;
    }
    .dashboard-kpi-compact .dashboard-kpi-label {
        font-size: 8px;
        margin-bottom: 1px;
    }
    .dashboard-kpi-compact .dashboard-kpi-value {
        font-size: 11px;
    }
    /* Model type color themes for values */
    .dashboard-model-section.retrieval .dashboard-kpi-value.highlight {
        color: #8b5cf6;
    }
    .dashboard-model-section.ranking .dashboard-kpi-value.highlight {
        color: #f59e0b;
    }
    .dashboard-model-section.hybrid .dashboard-kpi-value.highlight {
        color: #ec4899;
    }
    /* Model section selection states */
    .dashboard-model-section {
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .dashboard-model-section:hover:not(.selected) {
        border-color: #9ca3af;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    .dashboard-model-section.retrieval.selected {
        border-color: #8b5cf6;
        box-shadow: 0 0 0 2px #8b5cf6, 0 0 20px rgba(139, 92, 246, 0.35);
    }
    .dashboard-model-section.ranking.selected {
        border-color: #f59e0b;
        box-shadow: 0 0 0 2px #f59e0b, 0 0 20px rgba(245, 158, 11, 0.35);
    }
    .dashboard-model-section.hybrid.selected {
        border-color: #ec4899;
        box-shadow: 0 0 0 2px #ec4899, 0 0 20px rgba(236, 72, 153, 0.35);
    }
    /* Trend Panel styling */
    .dashboard-trend-panel {
        background: white;
        border: 1px solid #1f2937;
        border-radius: 8px;
        padding: 12px 16px 12px 12px;
    }
    .dashboard-trend-panel .dashboard-section-header {
        margin-bottom: 8px;
        padding-bottom: 6px;
    }
    @media (max-width: 1100px) {
        .dashboard-kpi-trend-row {
            flex-direction: column;
        }
        .dashboard-kpi-trend-row .dashboard-model-sections,
        .dashboard-kpi-trend-row .dashboard-trend-panel {
            flex: 1 1 auto;
            max-width: 100%;
        }
    }
    @media (max-width: 600px) {
        .dashboard-model-sections {
            flex-direction: column;
        }
    }

    /* Dashboard Section */
    .dashboard-section {
        margin-bottom: 24px;
    }
    .dashboard-section:last-child {
        margin-bottom: 0;
    }
    .dashboard-section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 1px solid #e5e7eb;
    }
    .dashboard-section-title {
        font-size: 14px;
        font-weight: 600;
        color: #374151;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .dashboard-section-controls {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .dashboard-select {
        padding: 4px 8px;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        font-size: 12px;
        background: white;
    }
    .dashboard-select:focus {
        outline: none;
        border-color: #3b82f6;
    }

    /* Training Heatmaps */
    .training-heatmaps-container {
        display: flex;
        gap: 24px;
    }
    .training-heatmap-panel {
        min-width: 0;
    }
    .training-heatmap-panel:first-child {
        flex: 6;  /* 60% for Loss heatmap */
    }
    .training-heatmap-panel:last-child {
        flex: 4;  /* 40% for Recall heatmap */
    }
    .training-heatmap-title {
        font-size: 13px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 12px;
        text-align: center;
    }
    .training-heatmap-grid {
        min-height: 280px;
    }
    .training-heatmap-grid svg {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    .training-heatmap-legend {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-top: 8px;
        font-size: 10px;
        color: #6b7280;
    }
    .legend-label {
        font-weight: 500;
    }
    .legend-gradient {
        width: 100px;
        height: 10px;
        border-radius: 2px;
    }
    .loss-gradient {
        background: linear-gradient(to right, #10b981, #fbbf24, #ef4444);
    }
    .recall-gradient {
        background: linear-gradient(to right, #ef4444, #fbbf24, #10b981);
    }
    .training-heatmaps-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 300px;
        color: #9ca3af;
        text-align: center;
    }
    .training-heatmaps-empty i {
        font-size: 48px;
        margin-bottom: 12px;
        opacity: 0.5;
    }

    /* Dashboard Loading State */
    .dashboard-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 48px;
        color: #9ca3af;
    }
    .dashboard-loading i {
        margin-right: 8px;
    }

    /* Dashboard Table Styles */
    .dashboard-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
    }
    .dashboard-table th {
        text-align: left;
        padding: 10px 12px;
        font-weight: 600;
        color: #374151;
        background: #f9fafb;
        border-bottom: 2px solid #e5e7eb;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .dashboard-table td {
        padding: 10px 12px;
        border-bottom: 1px solid #f3f4f6;
        color: #4b5563;
    }
    .dashboard-table tr:hover {
        background: #f9fafb;
    }
    .dashboard-table tr:last-child td {
        border-bottom: none;
    }
    .dashboard-table .rank-cell {
        font-weight: 700;
        color: #6b7280;
    }
    .dashboard-table .rank-1 {
        color: #f59e0b;
    }
    .dashboard-table .rank-2 {
        color: #9ca3af;
    }
    .dashboard-table .rank-3 {
        color: #b45309;
    }
    .dashboard-table .metric-best {
        color: #10b981;
        font-weight: 600;
    }

    /* Dashboard Empty Section */
    .dashboard-empty-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 32px;
        color: #9ca3af;
        text-align: center;
    }
    .dashboard-empty-section i {
        font-size: 32px;
        margin-bottom: 12px;
        opacity: 0.5;
    }
    .dashboard-empty-section p {
        font-size: 13px;
    }

    /* Hyperparameter Grid - Enhanced with TPE Analysis */
    .hyperparam-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    .hyperparam-meta {
        display: flex;
        align-items: center;
        gap: 16px;
        font-size: 12px;
        color: #6b7280;
        padding: 8px 12px;
        background: #f3f4f6;
        border-radius: 6px;
    }
    .hyperparam-meta-item {
        display: flex;
        align-items: center;
        gap: 4px;
    }
    .hyperparam-meta-value {
        font-weight: 600;
        color: #374151;
    }
    .hyperparam-category {
        margin-bottom: 8px;
    }
    .hyperparam-category-title {
        font-size: 13px;
        font-weight: 600;
        color: #374151;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 8px 0;
        border-bottom: 2px solid #e5e7eb;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .hyperparam-category-title i {
        color: #6b7280;
        font-size: 12px;
    }
    .hyperparam-category-title.training { border-color: #3b82f6; }
    .hyperparam-category-title.model { border-color: #8b5cf6; }
    .hyperparam-category-title.features { border-color: #10b981; }
    .hyperparam-category-title.dataset { border-color: #f59e0b; }
    .hyperparam-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
    }
    .hyperparam-card {
        background: #ffffff;
        border: 1px solid #1f2937;
        border-radius: 8px;
        padding: 10px;
    }
    .hyperparam-card-title {
        font-size: 11px;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 6px;
    }
    .hyperparam-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 4px 0;
        border-bottom: 1px solid #e5e7eb;
        font-size: 12px;
    }
    .hyperparam-item:last-child {
        border-bottom: none;
    }
    .hyperparam-value {
        font-weight: 600;
        color: #374151;
        max-width: 80px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .hyperparam-metrics {
        display: flex;
        align-items: center;
        gap: 4px;
    }
    .hyperparam-tpe {
        font-weight: 600;
        font-size: 11px;
        padding: 2px 5px;
        border-radius: 4px;
        background: #dbeafe;
        color: #1d4ed8;
    }
    .hyperparam-tpe.best {
        background: #dcfce7;
        color: #166534;
    }
    .hyperparam-recall {
        color: #10b981;
        font-weight: 500;
        font-size: 11px;
    }
    .hyperparam-count {
        font-size: 10px;
        color: #9ca3af;
    }
    .hyperparam-item.best {
        background: #ecfdf5;
        margin: 0 -8px;
        padding: 4px 8px;
        border-radius: 4px;
        border-bottom: none;
    }
    .hyperparam-item.low-confidence {
        opacity: 0.6;
    }
    .hyperparam-item.low-confidence .hyperparam-value::before {
        content: '';
        margin-right: 4px;
        color: #9ca3af;
    }
    .confidence-indicator {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 4px;
    }
    .confidence-high { background: #10b981; }
    .confidence-medium { background: #f59e0b; }
    .confidence-low { background: #d1d5db; }
    .hyperparam-legend {
        display: flex;
        gap: 16px;
        font-size: 11px;
        color: #6b7280;
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #e5e7eb;
    }
    .hyperparam-legend-item {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    /* MODEL ARCHITECTURE & FEATURES - Special 2-row layout for Buyer/Product comparison */
    .hyperparam-model-section {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    .hyperparam-model-row {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr;
        gap: 12px;
    }
    .hyperparam-model-row.ranking-tower-row {
        border-top: 1px dashed #e5e7eb;
        padding-top: 12px;
        margin-top: 4px;
    }
    .hyperparam-card-placeholder {
        /* Empty placeholder to maintain 3-column grid */
    }
    .hyperparam-features-row {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 12px;
    }
    .hyperparam-features-detail-row {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 12px;
    }
    /* DATASET section - single row with 4 tablets */
    .hyperparam-dataset-row {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
    }
    .hyperparam-dataset-row .hyperparam-value {
        max-width: 180px;
    }
    .hyperparam-model-row-label {
        font-size: 10px;
        font-weight: 600;
        color: #8b5cf6;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
    }
    .hyperparam-card-wide {
        background: #ffffff;
        border: 1px solid #1f2937;
        border-radius: 8px;
        padding: 10px;
    }
    .hyperparam-card-wide .hyperparam-value {
        max-width: 160px;
    }

    /* Suggestions Grid */
    .suggestions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 12px;
    }
    .suggestion-card {
        background: #fffbeb;
        border: 1px solid #fbbf24;
        border-radius: 8px;
        padding: 14px;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    .suggestion-card.variation {
        background: #eff6ff;
        border-color: #3b82f6;
    }
    .suggestion-header {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .suggestion-icon {
        width: 28px;
        height: 28px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        color: white;
        background: #f59e0b;
        flex-shrink: 0;
    }
    .suggestion-card.variation .suggestion-icon {
        background: #3b82f6;
    }
    .suggestion-title {
        font-weight: 600;
        font-size: 14px;
        color: #374151;
    }
    .suggestion-description {
        font-size: 12px;
        color: #6b7280;
        line-height: 1.4;
    }
    .suggestion-action {
        margin-top: auto;
    }
    .suggestion-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        font-size: 12px;
        font-weight: 500;
        color: white;
        background: #f59e0b;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.15s ease;
    }
    .suggestion-btn:hover {
        background: #d97706;
    }
    .suggestion-card.variation .suggestion-btn {
        background: #3b82f6;
    }
    .suggestion-card.variation .suggestion-btn:hover {
        background: #2563eb;
    }
</style>
{% endblock %}

{% block model_content %}
<!-- Toast Notification Container -->
<div id="toastContainer" class="toast-container"></div>

<div class="space-y-6">

    <!-- =========================================================================
         Experiments Dashboard Chapter
         ========================================================================= -->
    <div class="chapter-container" id="experimentsDashboard" data-chapter="dashboard">
        <div class="chapter-header" onclick="toggleChapter(this)">
            <div class="chapter-header-top">
                <div class="chapter-title-wrapper">
                    <div class="chapter-icon dashboard">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <div class="chapter-title-text">
                        <span class="chapter-title">Experiments Dashboard</span>
                        <span class="chapter-subtitle">Analyze and compare experiment results</span>
                    </div>
                </div>
                <div class="chapter-toggle">
                    <i class="fas fa-chevron-right"></i>
                </div>
            </div>
            <div class="chapter-divider"></div>

            <!-- Loading State  always visible in header -->
            <div id="dashboardLoading" class="dashboard-loading" onclick="event.stopPropagation()">
                <i class="fas fa-spinner fa-spin"></i>
                <span>Loading dashboard...</span>
            </div>

            <!-- KPI + Trend Row  always visible in header -->
            <div id="dashboardContent" class="hidden" onclick="event.stopPropagation()">
                <div class="dashboard-kpi-trend-row">
                    <!-- Model Type KPI Sections -->
                    <div class="dashboard-model-sections">
                        <!-- Retrieval Section -->
                        <div id="dashboardRetrievalSection" class="dashboard-model-section retrieval selected" onclick="selectDashboardModelType('retrieval')">
                            <div class="dashboard-model-header">
                                <div class="dashboard-model-icon retrieval">
                                    <i class="fas fa-search"></i>
                                </div>
                                <span class="dashboard-model-title">Retrieval</span>
                            </div>
                            <div class="dashboard-kpi-stack">
                                <div class="dashboard-kpi-compact">
                                    <div class="dashboard-kpi-label">Experiments</div>
                                    <div class="dashboard-kpi-value" id="dashboardRetrievalCount">0</div>
                                </div>
                                <div class="dashboard-kpi-compact">
                                    <div class="dashboard-kpi-label">R@5</div>
                                    <div class="dashboard-kpi-value highlight" id="dashboardRetrievalR5">-</div>
                                </div>
                                <div class="dashboard-kpi-compact">
                                    <div class="dashboard-kpi-label">R@10</div>
                                    <div class="dashboard-kpi-value highlight" id="dashboardRetrievalR10">-</div>
                                </div>
                                <div class="dashboard-kpi-compact">
                                    <div class="dashboard-kpi-label">R@50</div>
                                    <div class="dashboard-kpi-value highlight" id="dashboardRetrievalR50">-</div>
                                </div>
                                <div class="dashboard-kpi-compact">
                                    <div class="dashboard-kpi-label">R@100</div>
                                    <div class="dashboard-kpi-value highlight" id="dashboardRetrievalR100">-</div>
                                </div>
                            </div>
                        </div>

                        <!-- Ranking Section -->
                        <div id="dashboardRankingSection" class="dashboard-model-section ranking" onclick="selectDashboardModelType('ranking')">
                            <div class="dashboard-model-header">
                                <div class="dashboard-model-icon ranking">
                                    <i class="fas fa-sort-amount-down"></i>
                                </div>
                                <span class="dashboard-model-title">Ranking</span>
                            </div>
                            <div class="dashboard-kpi-stack">
                                <div class="dashboard-kpi-compact">
                                    <div class="dashboard-kpi-label">Experiments</div>
                                    <div class="dashboard-kpi-value" id="dashboardRankingCount">0</div>
                                </div>
                                <div class="dashboard-kpi-compact">
                                    <div class="dashboard-kpi-label">RMSE</div>
                                    <div class="dashboard-kpi-value highlight" id="dashboardRankingRMSE">-</div>
                                </div>
                                <div class="dashboard-kpi-compact">
                                    <div class="dashboard-kpi-label">Test RMSE</div>
                                    <div class="dashboard-kpi-value highlight" id="dashboardRankingTestRMSE">-</div>
                                </div>
                                <div class="dashboard-kpi-compact">
                                    <div class="dashboard-kpi-label">MAE</div>
                                    <div class="dashboard-kpi-value highlight" id="dashboardRankingMAE">-</div>
                                </div>
                                <div class="dashboard-kpi-compact">
                                    <div class="dashboard-kpi-label">Test MAE</div>
                                    <div class="dashboard-kpi-value highlight" id="dashboardRankingTestMAE">-</div>
                                </div>
                            </div>
                        </div>

                        <!-- Hybrid Section -->
                        <div id="dashboardHybridSection" class="dashboard-model-section hybrid" onclick="selectDashboardModelType('hybrid')">
                            <div class="dashboard-model-header">
                                <div class="dashboard-model-icon hybrid">
                                    <i class="fas fa-layer-group"></i>
                                </div>
                                <span class="dashboard-model-title">Hybrid</span>
                            </div>
                            <div class="dashboard-kpi-stack">
                                <div class="dashboard-kpi-compact">
                                    <div class="dashboard-kpi-label">Experiments</div>
                                    <div class="dashboard-kpi-value" id="dashboardHybridCount">0</div>
                                </div>
                                <div class="dashboard-kpi-compact">
                                    <div class="dashboard-kpi-label">RMSE</div>
                                    <div class="dashboard-kpi-value highlight" id="dashboardHybridRMSE">-</div>
                                </div>
                                <div class="dashboard-kpi-compact">
                                    <div class="dashboard-kpi-label">Test RMSE</div>
                                    <div class="dashboard-kpi-value highlight" id="dashboardHybridTestRMSE">-</div>
                                </div>
                                <div class="dashboard-kpi-compact">
                                    <div class="dashboard-kpi-label">R@50</div>
                                    <div class="dashboard-kpi-value highlight" id="dashboardHybridR50">-</div>
                                </div>
                                <div class="dashboard-kpi-compact">
                                    <div class="dashboard-kpi-label">R@100</div>
                                    <div class="dashboard-kpi-value highlight" id="dashboardHybridR100">-</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Metrics Trend Panel -->
                    <div class="dashboard-trend-panel">
                        <div class="dashboard-section-header">
                            <span class="dashboard-section-title">Metrics Trend</span>
                            <span class="text-xs text-gray-400">Best Recall metrics over time</span>
                        </div>
                        <div id="trendChartContainer" style="height: 200px; position: relative; padding-right: 8px;">
                            <canvas id="trendChartCanvas"></canvas>
                            <div id="trendChartEmpty" class="dashboard-empty-section hidden">
                                <i class="fas fa-chart-line"></i>
                                <p>Not enough data for trend analysis</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Empty State (no completed experiments)  always visible in header -->
            <div id="dashboardEmpty" class="chapter-empty-state hidden" onclick="event.stopPropagation()">
                <i class="fas fa-chart-pie chapter-empty-icon"></i>
                <p class="chapter-empty-text">No completed experiments yet</p>
                <p class="text-sm text-gray-400 mt-2">Run some experiments to see analytics</p>
            </div>
        </div>
        <div class="chapter-content">
            <div class="chapter-content-inner">
                <div class="chapter-divider" style="margin-top: 0;"></div>

            <!-- Top Configurations Section -->
            <div class="dashboard-section">
                <div class="dashboard-section-header">
                    <span class="dashboard-section-title" id="topConfigsTitle">Top Configurations</span>
                    <span class="text-xs text-gray-400" id="topConfigsSubtitle">Best performing experiment configurations</span>
                </div>
                <div id="topConfigsContainer">
                    <table class="dashboard-table">
                        <thead id="topConfigsHead">
                            <tr>
                                <th style="width: 40px;">#</th>
                                <th style="text-align: center;">Experiment</th>
                                <th>Dataset</th>
                                <th>Feature</th>
                                <th>Model</th>
                                <th style="text-align: center;">LR</th>
                                <th style="text-align: center;">Batch</th>
                                <th style="text-align: center;">Epochs</th>
                                <th style="text-align: center;">R@100</th>
                                <th style="text-align: center;">Loss</th>
                            </tr>
                        </thead>
                        <tbody id="topConfigsBody">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Hyperparameter Analysis Section - TPE-based -->
            <div class="dashboard-section">
                <div class="dashboard-section-header">
                    <span class="dashboard-section-title">Hyperparameter Insights</span>
                    <span class="text-xs text-gray-400">TPE-based analysis  Higher score = better association with top 30% results</span>
                </div>
                <div id="hyperparamContainer" class="hyperparam-container">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Training Heatmaps Section -->
            <div class="dashboard-section">
                <div class="dashboard-section-header">
                    <span class="dashboard-section-title">Training Analysis</span>
                    <span class="text-xs text-gray-400">Top 10 experiments by Recall@100</span>
                </div>
                <div class="training-heatmaps-container">
                    <!-- Epoch Heatmap (60%) - Loss for retrieval, RMSE for ranking -->
                    <div class="training-heatmap-panel">
                        <div id="epochHeatmapTitle" class="training-heatmap-title">Validation Loss by Epoch</div>
                        <div id="lossHeatmap" class="training-heatmap-grid"></div>
                        <div class="training-heatmap-legend">
                            <span class="legend-label">Low</span>
                            <div id="epochGradient" class="legend-gradient loss-gradient"></div>
                            <span class="legend-label">High</span>
                        </div>
                    </div>
                    <!-- Final Metrics Heatmap (40%) - Recall for retrieval, RMSE/MAE for ranking -->
                    <div class="training-heatmap-panel">
                        <div id="metricsHeatmapTitle" class="training-heatmap-title">Final Recall Metrics</div>
                        <div id="recallHeatmap" class="training-heatmap-grid"></div>
                        <div class="training-heatmap-legend">
                            <span class="legend-label">Low</span>
                            <div id="metricsGradient" class="legend-gradient recall-gradient"></div>
                            <span class="legend-label">High</span>
                        </div>
                    </div>
                </div>
                <div id="trainingHeatmapsEmpty" class="training-heatmaps-empty hidden">
                    <i class="fas fa-th"></i>
                    <p>No completed experiments with training data</p>
                </div>
            </div>

            <!-- Dataset Comparison Section -->
            <div class="dashboard-section">
                <div class="dashboard-section-header">
                    <span class="dashboard-section-title">Dataset Performance</span>
                    <span id="datasetComparisonSubtitle" class="text-xs text-gray-400">Compare results across different datasets</span>
                </div>
                <div id="datasetComparisonContainer">
                    <table class="dashboard-table">
                        <thead id="datasetComparisonHead">
                            <tr>
                                <th>Dataset</th>
                                <th style="text-align: center;">Experiments</th>
                                <th id="datasetMetric1" style="text-align: right;">Best R@100</th>
                                <th id="datasetMetric2" style="text-align: right;">Avg R@100</th>
                                <th id="datasetMetric3" style="text-align: right;">Avg Loss</th>
                            </tr>
                        </thead>
                        <tbody id="datasetComparisonBody">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                    <div id="datasetComparisonEmpty" class="dashboard-empty-section hidden">
                        <i class="fas fa-database"></i>
                        <p>No dataset comparison data available</p>
                    </div>
                </div>
            </div>

            <!-- Experiment Suggestions Section -->
            <div class="dashboard-section">
                <div class="dashboard-section-header">
                    <span class="dashboard-section-title">Suggested Next Experiments</span>
                    <span class="text-xs text-gray-400">Recommendations based on gaps in your experiment coverage</span>
                </div>
                <div id="suggestionsContainer" class="suggestions-grid">
                    <!-- Populated by JavaScript -->
                </div>
                <div id="suggestionsEmpty" class="dashboard-empty-section hidden">
                    <i class="fas fa-lightbulb"></i>
                    <p>No suggestions available yet</p>
                </div>
            </div>
            </div>
        </div>
    </div>

    <!-- Quick Test Chapter (non-collapsible) -->
    <div class="chapter-container" data-chapter="quick-test">
        <div class="chapter-header" style="cursor: default;">
            <div class="chapter-header-top">
                <div class="chapter-title-wrapper">
                    <div class="chapter-icon quick-test">
                        <i class="fas fa-bolt"></i>
                    </div>
                    <div class="chapter-title-text">
                        <span class="chapter-title">Quick Test</span>
                        <span class="chapter-subtitle">Run and manage configuration experiments</span>
                    </div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button onclick="exp_openCompareModal()" class="btn btn-secondary btn-sm" id="compareBtn" style="width: 150px;">
                        <i class="fas fa-columns mr-1"></i>Compare
                    </button>
                    <button onclick="openNewExpWizard()" class="btn btn-primary btn-sm" style="width: 150px;">
                        <i class="fas fa-plus mr-1"></i>New Exp
                    </button>
                </div>
            </div>
            <div class="chapter-divider" style="margin-bottom: 0;"></div>
        </div>
        <div class="chapter-content-inner">

            <!-- Filter Bar -->
            <div id="expFilterBar" class="exp-filter-bar hidden">
                <div class="exp-filter-group">
                    <label class="exp-filter-label">Exp status</label>
                    <select id="expStatusFilter" class="exp-filter-select" onchange="filterExperiments()">
                        <option value="">All</option>
                        <option value="running">Running</option>
                        <option value="completed">Completed</option>
                        <option value="failed">Failed</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="exp-filter-group">
                    <label class="exp-filter-label">Model type</label>
                    <select id="expModelTypeFilter" class="exp-filter-select" onchange="filterExperiments()">
                        <option value="">All</option>
                        <option value="retrieval">Retrieval</option>
                        <option value="ranking">Ranking</option>
                        <option value="multitask">Hybrid</option>
                    </select>
                </div>
                <div class="exp-filter-group">
                    <label class="exp-filter-label">Dataset config</label>
                    <select id="expDatasetFilter" class="exp-filter-select" onchange="filterExperiments()">
                        <option value="">All Datasets</option>
                    </select>
                </div>
                <div class="exp-filter-group">
                    <label class="exp-filter-label">Features config</label>
                    <select id="expFeatureFilter" class="exp-filter-select" onchange="filterExperiments()">
                        <option value="">All Features</option>
                    </select>
                </div>
                <div class="exp-filter-group">
                    <label class="exp-filter-label">Model config</label>
                    <select id="expModelFilter" class="exp-filter-select" onchange="filterExperiments()">
                        <option value="">All Models</option>
                    </select>
                </div>
                <input type="text" id="expSearchInput" class="exp-search-input"
                       placeholder="Search experiments..." onkeyup="debounceExpSearch()">
            </div>

            <!-- Content Area -->
            <div id="quickTestContent">
                <!-- Loading state -->
                <div id="expLoading" class="flex items-center justify-center py-8">
                    <i class="fas fa-spinner fa-spin text-xl text-gray-400 mr-3"></i>
                    <span class="text-gray-500">Loading experiments...</span>
                </div>

                <!-- Empty state (no experiments) -->
                <div id="expEmpty" class="chapter-empty-state hidden">
                    <i class="fas fa-flask chapter-empty-icon"></i>
                    <p class="chapter-empty-text">No experiments yet</p>
                    <p class="text-sm text-gray-400 mt-2">Run your first experiment to test feature and model configurations</p>
                    <button onclick="openNewExpWizard()" class="btn btn-primary btn-sm mt-4">
                        <i class="fas fa-plus mr-1"></i>New Experiment
                    </button>
                </div>

                <!-- No configs state -->
                <div id="expNoConfigs" class="chapter-empty-state hidden">
                    <i class="fas fa-exclamation-circle chapter-empty-icon"></i>
                    <p class="chapter-empty-text">No configurations available</p>
                    <p class="text-sm text-gray-400 mt-2">Create feature and model configs on the Configs page first</p>
                    <a href="{% url 'model_configs' model.id %}" class="btn btn-primary btn-sm mt-4">
                        <i class="fas fa-arrow-left mr-1"></i>Go to Configs
                    </a>
                </div>

                <!-- Experiments List -->
                <div id="expList" class="hidden">
                    <div id="expCardsContainer" class="exp-cards-container">
                        <!-- Experiment cards rendered here by JavaScript -->
                    </div>

                    <!-- Pagination -->
                    <div id="expPagination" class="hidden mt-4 pt-4 border-t border-gray-200">
                        <div class="flex items-center justify-between">
                            <div id="expPaginationInfo" class="text-sm text-gray-600"></div>
                            <div id="expPaginationButtons" class="flex items-center gap-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- ============================================================================
     NEW EXPERIMENT WIZARD MODAL
     ============================================================================ -->
<div id="newExpWizardModal" class="modal-overlay hidden">
    <div class="modal-container modal-container-wizard" style="max-width: 1000px;">
        <!-- Modal Header -->
        <div class="modal-header-wizard">
            <div class="modal-header-content">
                <div class="modal-header-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);">
                    <i class="fas fa-flask text-lg text-white"></i>
                </div>
                <div class="modal-header-info">
                    <h3 class="modal-header-title">New Experiment</h3>
                    <p class="modal-step-counter">Step <span id="wizardCurrentStep">1</span> of 2</p>
                </div>
            </div>
            <div class="progress-bar-pills">
                <div id="wizardProgress1" class="progress-step-pill current">Select Configs</div>
                <div id="wizardProgress2" class="progress-step-pill future">Training Params</div>
            </div>
        </div>

        <!-- Modal Body -->
        <div id="wizardModalBody" class="modal-body-wizard" style="max-height: calc(90vh - 200px); overflow-y: auto;">
            <!-- Step 1: Select Configurations -->
            <div id="wizardStep1" class="wizard-step active">
                <!-- Model Type Selection (first, right after progress bar) -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Model Type</label>
                    <div class="wizard-model-type-selector">
                        <div class="wizard-model-type-option selected" data-type="retrieval" onclick="selectExpModelType('retrieval')">
                            <div class="wizard-model-type-icon retrieval">
                                <i class="fas fa-search"></i>
                            </div>
                            <div class="wizard-model-type-content">
                                <div class="wizard-model-type-name">Retrieval</div>
                                <div class="wizard-model-type-desc">Two-tower for candidate retrieval</div>
                            </div>
                        </div>
                        <div class="wizard-model-type-option" data-type="ranking" onclick="selectExpModelType('ranking')">
                            <div class="wizard-model-type-icon ranking">
                                <i class="fas fa-sort-amount-down"></i>
                            </div>
                            <div class="wizard-model-type-content">
                                <div class="wizard-model-type-name">Ranking</div>
                                <div class="wizard-model-type-desc">Score and rank candidates</div>
                            </div>
                        </div>
                        <div class="wizard-model-type-option" data-type="multitask" onclick="selectExpModelType('multitask')">
                            <div class="wizard-model-type-icon multitask">
                                <i class="fas fa-project-diagram"></i>
                            </div>
                            <div class="wizard-model-type-content">
                                <div class="wizard-model-type-name">Multitask</div>
                                <div class="wizard-model-type-desc">Combined retrieval + ranking</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Experiment Metadata -->
                <div class="mb-4">
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Experiment Name <span class="text-gray-400 font-normal">(optional)</span></label>
                        <input type="text" id="wizardExpName" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500" placeholder="e.g., Baseline with new features">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description <span class="text-gray-400 font-normal">(optional)</span></label>
                        <textarea id="wizardExpDescription" rows="2" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 resize-none" placeholder="Describe the purpose of this experiment..."></textarea>
                    </div>
                </div>

                <!-- Feature Config Selection -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Feature Config</label>
                    <select id="wizardFeatureSelect" class="w-64 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500" onchange="onWizardFeatureChange()">
                        <option value="">-- Select Feature Config --</option>
                    </select>
                </div>

                <!-- Feature Config Preview -->
                <div id="wizardFeaturePreview" class="config-preview-panel feature hidden">
                    <!-- Loading indicator -->
                    <div id="wizardFeatureLoading" class="text-center py-4 hidden">
                        <i class="fas fa-spinner fa-spin text-blue-500 text-xl"></i>
                        <p class="text-sm text-gray-500 mt-2">Loading feature config details...</p>
                    </div>
                    <!-- Content container -->
                    <div id="wizardFeatureContent">
                        <div class="mb-3">
                            <div class="text-sm text-gray-500">Dataset: <span class="font-medium text-gray-700" id="wizardFeatureDataset">-</span></div>
                        </div>
                        <!-- Dataset Source Info -->
                        <div id="wizardDatasetInfo"></div>
                        <!-- Target Column (for Ranking configs) -->
                        <div id="wizardTargetColumnSection" class="hidden mb-4">
                            <div class="target-column-card">
                                <div class="target-column-header">
                                    <i class="fas fa-bullseye"></i>
                                    <span>Target Column</span>
                                    <span class="target-column-badge">For Ranking</span>
                                </div>
                                <div class="target-column-content">
                                    <span class="target-column-name" id="wizardTargetColumnName">-</span>
                                    <span class="target-column-type" id="wizardTargetColumnType">-</span>
                                </div>
                                <div class="target-column-transforms" id="wizardTargetTransforms"></div>
                            </div>
                        </div>
                        <!-- Tensor Breakdown Grid -->
                        <div class="grid grid-cols-2 gap-4">
                            <div class="p-4 bg-blue-50 rounded-lg">
                                <div class="flex items-center justify-between mb-3">
                                    <h4 class="font-semibold text-blue-800">Buyer Tensor</h4>
                                    <span class="font-semibold text-blue-600" id="wizardBuyerDim">0D</span>
                                </div>
                                <div id="wizardBuyerBar" class="tensor-breakdown-bar mb-3"></div>
                                <div id="wizardBuyerFeatures" class="space-y-1">
                                    <!-- Features listed here -->
                                </div>
                            </div>
                            <div class="p-4 bg-green-50 rounded-lg">
                                <div class="flex items-center justify-between mb-3">
                                    <h4 class="font-semibold text-green-800">Product Tensor</h4>
                                    <span class="font-semibold text-green-600" id="wizardProductDim">0D</span>
                                </div>
                                <div id="wizardProductBar" class="tensor-breakdown-bar mb-3"></div>
                                <div id="wizardProductFeatures" class="space-y-1">
                                    <!-- Features listed here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="wizardFeatureEmpty" class="config-preview-panel feature">
                    <div class="config-preview-empty">
                        <i class="fas fa-cube text-2xl mb-2"></i>
                        <p>Select a Feature Config to see details</p>
                    </div>
                </div>

                <!-- Model Config Selection -->
                <div class="mb-4 mt-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Model Config</label>
                    <select id="wizardModelSelect" class="w-64 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500" onchange="onWizardModelChange()">
                        <option value="">-- Select Model Config --</option>
                    </select>
                </div>

                <!-- Model Config Preview -->
                <div id="wizardModelPreview" class="config-preview-panel model hidden">
                    <!-- Loading indicator -->
                    <div id="wizardModelLoading" class="text-center py-4 hidden">
                        <i class="fas fa-spinner fa-spin text-purple-500 text-xl"></i>
                        <p class="text-sm text-gray-500 mt-2">Loading model config details...</p>
                    </div>
                    <!-- Content container -->
                    <div id="wizardModelContent">
                        <!-- Tower Architecture -->
                        <div class="mb-3">
                            <div class="tower-visual tower-visual-aligned">
                                <div class="tower-column">
                                    <div class="tower-header">
                                        <span class="tower-label">Buyer Tower</span>
                                    </div>
                                    <div id="wizardBuyerStack" class="tower-stack buyer">
                                        <!-- Layers will be inserted here -->
                                    </div>
                                    <div class="tower-params-summary" id="wizardBuyerParamsSummary">
                                        <div class="params-row"><span>Total params:</span><span id="wizardBuyerTotalParams">0</span></div>
                                        <div class="params-row"><span>Trainable params:</span><span id="wizardBuyerTrainableParams">0</span></div>
                                        <div class="params-row"><span>Non-trainable params:</span><span>0</span></div>
                                    </div>
                                </div>
                                <div class="tower-column">
                                    <div class="tower-header">
                                        <span class="tower-label">Product Tower</span>
                                    </div>
                                    <div id="wizardProductStack" class="tower-stack product">
                                        <!-- Layers will be inserted here -->
                                    </div>
                                    <div class="tower-params-summary" id="wizardProductParamsSummary">
                                        <div class="params-row"><span>Total params:</span><span id="wizardProductTotalParams">0</span></div>
                                        <div class="params-row"><span>Trainable params:</span><span id="wizardProductTrainableParams">0</span></div>
                                        <div class="params-row"><span>Non-trainable params:</span><span>0</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Rating Head (for Ranking/Multitask models) -->
                        <div id="wizardRatingHeadSection" class="wizard-rating-head-section hidden">
                            <div class="wizard-rating-head-header">
                                <div class="wizard-rating-head-icon">
                                    <i class="fas fa-star"></i>
                                </div>
                                <div class="wizard-rating-head-title">Rating Head</div>
                                <div class="wizard-rating-head-summary" id="wizardRatingHeadSummary">-</div>
                            </div>
                            <div class="wizard-rating-head-layers" id="wizardRatingHeadLayers">
                                <!-- Layers will be inserted here -->
                            </div>
                            <div class="wizard-rating-head-params">
                                <div>Total params: <span id="wizardRatingHeadParams">0</span></div>
                            </div>
                        </div>

                        <!-- Training Parameters -->
                        <div class="mb-2">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Training Parameters</h4>
                            <div class="training-params-preview" id="wizardModelParams">
                                <!-- Will be populated dynamically -->
                            </div>
                        </div>

                        <!-- Retrieval Algorithm (for retrieval/multitask models) -->
                        <div id="wizardRetrievalSection" class="hidden">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Retrieval Algorithm</h4>
                            <div class="training-params-preview" id="wizardRetrievalParams">
                                <!-- Will be populated dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
                <div id="wizardModelEmpty" class="config-preview-panel model">
                    <div class="config-preview-empty">
                        <i class="fas fa-layer-group text-2xl mb-2"></i>
                        <p>Select a Model Config to see details</p>
                    </div>
                </div>
            </div>

            <!-- Step 2: Training Parameters -->
            <div id="wizardStep2" class="wizard-step">
                <!-- Data Sampling - Full width proportional layout -->
                <div class="p-3 bg-amber-50 border border-amber-200 rounded-lg mb-4">
                    <div class="flex items-center gap-3">
                        <div class="flex items-center gap-2 flex-shrink-0">
                            <i class="fas fa-database text-amber-600"></i>
                            <span class="text-sm font-medium text-amber-800">Sample:</span>
                        </div>
                        <div class="flex-1 flex items-center gap-2" style="max-width: 480px;">
                            <button type="button" class="sample-btn flex-1" data-value="5" onclick="setSamplePercent(5)">5%</button>
                            <button type="button" class="sample-btn flex-1" data-value="10" onclick="setSamplePercent(10)">10%</button>
                            <button type="button" class="sample-btn flex-1" data-value="25" onclick="setSamplePercent(25)">25%</button>
                            <button type="button" class="sample-btn flex-1 active" data-value="100" onclick="setSamplePercent(100)">100%</button>
                            <span class="text-gray-400 text-sm px-1">or</span>
                            <input type="number" id="wizardSamplePercentInput" class="sample-input flex-1 px-2 py-1 text-sm border border-amber-300 rounded text-center" value="100" min="1" max="100" onchange="onSampleInputChange()">
                            <span class="text-sm text-gray-500">%</span>
                        </div>
                        <div class="flex items-center gap-1 ml-auto flex-shrink-0" style="min-width: 140px; justify-content: flex-end;">
                            <span class="text-amber-700 font-semibold" id="wizardExampleCountValue">--</span>
                            <span class="text-sm text-gray-500">examples</span>
                        </div>
                    </div>
                </div>

                <!-- Split Strategy -->
                <div class="training-params-section" style="background: #f5f3ff; border-color: #c4b5fd;">
                    <h4 style="color: #6d28d9;"><i class="fas fa-random"></i> Split Strategy</h4>
                    <!-- Main row: Strategy + conditional options -->
                    <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
                        <select id="wizardSplitStrategy" onchange="onWizardSplitChange()" style="border-color: #c4b5fd; padding: 8px 12px; border-radius: 6px; font-size: 13px; min-width: 160px;">
                            <option value="random">Random (fastest)</option>
                            <option value="time_holdout">Time Holdout</option>
                            <option value="strict_time">Strict Temporal</option>
                        </select>
                        <!-- Random split info -->
                        <div id="wizardRandomInfo" style="display: flex; align-items: center; gap: 6px;">
                            <span style="color: #7c3aed; font-size: 12px;"><i class="fas fa-info-circle mr-1"></i>Train 80% / Eval 15% / Test 5%</span>
                        </div>
                        <!-- Date column (inline, shown for time-based) -->
                        <div id="wizardDateColumnSection" style="display: none; align-items: center; gap: 8px;">
                            <span style="color: #6d28d9; font-size: 12px; white-space: nowrap;">on</span>
                            <select id="wizardDateColumn" style="border-color: #c4b5fd; padding: 8px 12px; border-radius: 6px; font-size: 13px; min-width: 200px;">
                                <option value="">Select date column...</option>
                            </select>
                        </div>
                        <!-- Holdout days (inline, shown for time_holdout) -->
                        <div id="wizardTimeOptions" style="display: none; align-items: center; gap: 6px;">
                            <span style="color: #6d28d9; font-size: 12px;">test: last</span>
                            <input type="number" id="wizardHoldoutDays" value="1" min="1" max="30" style="border-color: #c4b5fd; width: 60px; padding: 6px 8px; border-radius: 6px; font-size: 13px; text-align: center;">
                            <span style="color: #6d28d9; font-size: 12px;">days, rest: 80/20</span>
                        </div>
                    </div>
                    <!-- Rolling window (second row, shown for strict_time) -->
                    <div id="wizardRollingWindowSection" style="display: none; margin-top: 10px; width: 100%;">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; width: 100%;">
                            <div style="background: white; padding: 8px 12px; border-radius: 6px; border: 1px solid #ede9fe; display: flex; align-items: center; justify-content: space-between;">
                                <span style="color: #9ca3af; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px;">Train</span>
                                <div style="display: flex; align-items: baseline; gap: 3px;">
                                    <input type="number" id="wizardTrainDays" value="60" min="7" max="365" style="border: none; width: 40px; font-size: 16px; background: transparent; font-weight: 600; color: #6d28d9; padding: 0; text-align: right;">
                                    <span style="color: #9ca3af; font-size: 11px;">days</span>
                                </div>
                            </div>
                            <div style="background: white; padding: 8px 12px; border-radius: 6px; border: 1px solid #ede9fe; display: flex; align-items: center; justify-content: space-between;">
                                <span style="color: #9ca3af; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px;">Validation</span>
                                <div style="display: flex; align-items: baseline; gap: 3px;">
                                    <input type="number" id="wizardValDays" value="7" min="1" max="30" style="border: none; width: 28px; font-size: 16px; background: transparent; font-weight: 600; color: #6d28d9; padding: 0; text-align: right;">
                                    <span style="color: #9ca3af; font-size: 11px;">days</span>
                                </div>
                            </div>
                            <div style="background: white; padding: 8px 12px; border-radius: 6px; border: 1px solid #ede9fe; display: flex; align-items: center; justify-content: space-between;">
                                <span style="color: #9ca3af; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px;">Test</span>
                                <div style="display: flex; align-items: baseline; gap: 3px;">
                                    <input type="number" id="wizardTestDays" value="7" min="1" max="30" style="border: none; width: 28px; font-size: 16px; background: transparent; font-weight: 600; color: #6d28d9; padding: 0; text-align: right;">
                                    <span style="color: #9ca3af; font-size: 11px;">days</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Training Parameters -->
                <div class="training-params-section" style="background: #eff6ff; border-color: #93c5fd;">
                    <h4 style="color: #1e40af;"><i class="fas fa-sliders-h"></i> Training Parameters</h4>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <!-- Epochs -->
                        <div>
                            <label style="color: #1e40af; font-size: 12px; display: block; margin-bottom: 6px;">Epochs</label>
                            <div class="flex items-center gap-2">
                                <button type="button" class="param-btn" data-param="epochs" data-value="5" onclick="setParam('epochs', 5)">5</button>
                                <button type="button" class="param-btn" data-param="epochs" data-value="10" onclick="setParam('epochs', 10)">10</button>
                                <button type="button" class="param-btn active" data-param="epochs" data-value="25" onclick="setParam('epochs', 25)">25</button>
                                <button type="button" class="param-btn" data-param="epochs" data-value="50" onclick="setParam('epochs', 50)">50</button>
                                <button type="button" class="param-btn" data-param="epochs" data-value="100" onclick="setParam('epochs', 100)">100</button>
                                <span class="text-gray-400 text-sm px-1">or</span>
                                <input type="number" id="wizardEpochs" class="param-input" value="25" min="1" max="500" onchange="onParamInputChange('epochs')">
                            </div>
                        </div>
                        <!-- Batch Size -->
                        <div>
                            <label style="color: #1e40af; font-size: 12px; display: block; margin-bottom: 6px;">Batch Size</label>
                            <div class="flex items-center gap-2">
                                <button type="button" class="param-btn active" data-param="batchSize" data-value="1024" onclick="setParam('batchSize', 1024)">1024</button>
                                <button type="button" class="param-btn" data-param="batchSize" data-value="2048" onclick="setParam('batchSize', 2048)">2048</button>
                                <button type="button" class="param-btn" data-param="batchSize" data-value="4096" onclick="setParam('batchSize', 4096)">4096</button>
                                <button type="button" class="param-btn" data-param="batchSize" data-value="8192" onclick="setParam('batchSize', 8192)">8192</button>
                                <span class="text-gray-400 text-sm px-1">or</span>
                                <input type="number" id="wizardBatchSize" class="param-input" value="1024" min="128" max="65536" step="128" onchange="onParamInputChange('batchSize')">
                            </div>
                        </div>
                        <!-- Learning Rate -->
                        <div>
                            <label style="color: #1e40af; font-size: 12px; display: block; margin-bottom: 6px;">Learning Rate</label>
                            <div class="flex items-center gap-2">
                                <button type="button" class="param-btn" data-param="learningRate" data-value="0.001" onclick="setParam('learningRate', 0.001)">0.001</button>
                                <button type="button" class="param-btn active" data-param="learningRate" data-value="0.01" onclick="setParam('learningRate', 0.01)">0.01</button>
                                <button type="button" class="param-btn" data-param="learningRate" data-value="0.05" onclick="setParam('learningRate', 0.05)">0.05</button>
                                <button type="button" class="param-btn" data-param="learningRate" data-value="0.1" onclick="setParam('learningRate', 0.1)">0.1</button>
                                <span class="text-gray-400 text-sm px-1">or</span>
                                <input type="number" id="wizardLearningRate" class="param-input" value="0.01" min="0.0001" max="1.0" step="0.001" onchange="onParamInputChange('learningRate')">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Rating Column (for Ranking models) - displays target from Feature Config -->
                <div id="wizardRatingSection" class="training-params-section hidden" style="background: #faf5ff; border-color: #d8b4fe;">
                    <h4 style="color: #7c3aed;"><i class="fas fa-star"></i> Rating Column</h4>
                    <p class="text-sm text-purple-600 mb-3">Target column defined in the selected Feature Config.</p>
                    <div class="target-column-card" style="background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%); border-color: #d8b4fe;">
                        <div class="target-column-content" style="border-color: #e9d5ff;">
                            <span class="target-column-name" id="step2TargetColumnName" style="color: #7c3aed;">-</span>
                            <span class="target-column-type" id="step2TargetColumnType" style="background: #f3e8ff; color: #7c3aed;">-</span>
                        </div>
                        <div class="target-column-transforms" id="step2TargetTransforms"></div>
                    </div>
                </div>

                <!-- Hardware Selection -->
                <div class="hardware-section">
                    <h4><i class="fas fa-microchip"></i> Hardware Configuration</h4>
                    <div class="hardware-recommendation" id="hardwareRecommendation">
                        Recommended: <strong>Small</strong> based on dataset size
                    </div>
                    <input type="hidden" id="wizardMachineType" value="e2-standard-4">
                    <input type="hidden" id="wizardGpuConfig" value="">
                    <div class="hardware-options">
                        <div class="hardware-card selected recommended" data-machine="e2-standard-4" onclick="selectHardware('e2-standard-4')">
                            <div class="hardware-card-title">Small</div>
                            <div class="hardware-card-type">e2-standard-4</div>
                            <div class="hardware-card-specs">4 vCPU<br>16 GB RAM</div>
                        </div>
                        <div class="hardware-card" data-machine="e2-standard-8" onclick="selectHardware('e2-standard-8')">
                            <div class="hardware-card-title">Medium</div>
                            <div class="hardware-card-type">e2-standard-8</div>
                            <div class="hardware-card-specs">8 vCPU<br>32 GB RAM</div>
                        </div>
                        <div class="hardware-card" data-machine="e2-standard-16" onclick="selectHardware('e2-standard-16')">
                            <div class="hardware-card-title">Large</div>
                            <div class="hardware-card-type">e2-standard-16</div>
                            <div class="hardware-card-specs">16 vCPU<br>64 GB RAM</div>
                        </div>
                        <div class="hardware-card" data-machine="gpu-t4" onclick="selectHardware('gpu-t4')">
                            <div class="hardware-card-title">GPU T4</div>
                            <div class="hardware-card-type">n1-standard-4 + T4</div>
                            <div class="hardware-card-specs">4 vCPU, 15 GB RAM<br>T4 16 GB GPU</div>
                        </div>
                        <div class="hardware-card disabled" title="GPU acceleration coming soon">
                            <div class="hardware-card-lock"><i class="fas fa-lock"></i></div>
                            <div class="hardware-card-title">GPU V100</div>
                            <div class="hardware-card-type">n1-standard-8 + V100</div>
                            <div class="hardware-card-specs">8 vCPU, 30 GB RAM<br>V100 16 GB GPU</div>
                        </div>
                    </div>
                </div>

                <!-- Summary -->
                <div class="exp-summary-section">
                    <div class="exp-summary-title">
                        <i class="fas fa-clipboard-check"></i>
                        Experiment Summary
                    </div>
                    <div class="exp-summary-grid">
                        <div class="exp-summary-item">
                            <span class="exp-summary-label">Model Type</span>
                            <span class="exp-summary-value accent" id="wizardSummaryModelType">Retrieval</span>
                        </div>
                        <div class="exp-summary-item">
                            <span class="exp-summary-label">Feature Config</span>
                            <span class="exp-summary-value accent" id="wizardSummaryFeature">-</span>
                        </div>
                        <div class="exp-summary-item">
                            <span class="exp-summary-label">Model Config</span>
                            <span class="exp-summary-value accent" id="wizardSummaryModel">-</span>
                        </div>
                        <div class="exp-summary-item">
                            <span class="exp-summary-label">Data Sample</span>
                            <span class="exp-summary-value" id="wizardSummarySample">100%</span>
                        </div>
                        <div class="exp-summary-item">
                            <span class="exp-summary-label">Split Strategy</span>
                            <span class="exp-summary-value" id="wizardSummarySplit">Random</span>
                        </div>
                        <div class="exp-summary-params">
                            <div class="exp-summary-param">
                                <span class="exp-summary-param-label">Epochs</span>
                                <span class="exp-summary-param-value" id="wizardSummaryEpochs">25</span>
                            </div>
                            <div class="exp-summary-param">
                                <span class="exp-summary-param-label">Batch Size</span>
                                <span class="exp-summary-param-value" id="wizardSummaryBatch">1024</span>
                            </div>
                            <div class="exp-summary-param">
                                <span class="exp-summary-param-label">Learning Rate</span>
                                <span class="exp-summary-param-value" id="wizardSummaryLR">0.01</span>
                            </div>
                            <div class="exp-summary-param" style="background: #faf5ff; border: 1px solid #e9d5ff;">
                                <span class="exp-summary-param-label" style="color: #7c3aed;">Hardware</span>
                                <span class="exp-summary-param-value" id="wizardSummaryHardware" style="color: #7c3aed;">Small</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="modal-footer-wizard-neu">
            <div class="footer-left">
                <button type="button" id="wizardBackBtn" class="btn-neu btn-neu-nav hidden" onclick="wizardBack()">
                    <span class="btn-neu-inner"><i class="fas fa-chevron-left"></i></span>
                </button>
                <button type="button" id="wizardNextBtn" class="btn-neu btn-neu-nav" onclick="wizardNext()">
                    <span class="btn-neu-inner"><i class="fas fa-chevron-right"></i></span>
                </button>
            </div>
            <div class="footer-right">
                <button type="button" id="wizardRunBtn" class="btn-neu btn-neu-action btn-neu-save hidden" onclick="submitExperiment()">
                    <span class="btn-neu-inner">Run</span>
                </button>
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeNewExpWizard()">
                    <span class="btn-neu-inner">Cancel</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ============================================================================
     EXPERIMENT COMPARE MODAL (Accordion-style dropdown comparison)
     ============================================================================ -->
<div id="expCompareModal" class="modal-overlay hidden" onclick="exp_closeCompareModal(event)">
    <div class="modal-container" style="max-width: 1000px;" onclick="event.stopPropagation()">
        <!-- Header -->
        <div class="modal-header">
            <div class="modal-header-icon info">
                <i class="fas fa-columns"></i>
            </div>
            <h3 class="modal-header-title">Compare Experiments</h3>
        </div>

        <!-- Body -->
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <!-- Dropdown Row -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Left Experiment</label>
                    <select id="expCompareLeftSelect" onchange="exp_onCompareSelectChange('left')"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select experiment...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Right Experiment</label>
                    <select id="expCompareRightSelect" onchange="exp_onCompareSelectChange('right')"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select experiment...</option>
                    </select>
                </div>
            </div>

            <!-- Accordion Sections -->
            <div id="expCompareAccordions" class="ds-compare-accordions">
                <!-- Section 1: Results & Metrics -->
                <div class="filter-subchapter ds-compare-section" id="expCompareResultsSection">
                    <div class="subchapter-header-tablet" onclick="exp_toggleCompareSection('results')">
                        <span class="subchapter-title"><i class="fas fa-chart-bar mr-2 text-green-500"></i>Results & Metrics</span>
                        <span class="subchapter-filter-status" id="expCompareResultsStatus"></span>
                        <i id="expCompareResultsChevron" class="fas fa-chevron-right subchapter-chevron"></i>
                    </div>
                    <div id="expCompareResultsContent" class="subchapter-content-outside hidden">
                        <div class="ds-compare-grid">
                            <div id="expCompareLeftResults" class="ds-compare-cell">
                                <div class="ds-compare-placeholder">Select an experiment</div>
                            </div>
                            <div id="expCompareRightResults" class="ds-compare-cell">
                                <div class="ds-compare-placeholder">Select an experiment</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 2: Dataset Configuration -->
                <div class="filter-subchapter ds-compare-section" id="expCompareDatasetSection">
                    <div class="subchapter-header-tablet" onclick="exp_toggleCompareSection('dataset')">
                        <span class="subchapter-title"><i class="fas fa-database mr-2 text-purple-500"></i>Dataset Configuration</span>
                        <span class="subchapter-filter-status" id="expCompareDatasetStatus"></span>
                        <i id="expCompareDatasetChevron" class="fas fa-chevron-right subchapter-chevron"></i>
                    </div>
                    <div id="expCompareDatasetContent" class="subchapter-content-outside hidden">
                        <div class="ds-compare-grid">
                            <div id="expCompareLeftDataset" class="ds-compare-cell">
                                <div class="ds-compare-placeholder">Select an experiment</div>
                            </div>
                            <div id="expCompareRightDataset" class="ds-compare-cell">
                                <div class="ds-compare-placeholder">Select an experiment</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 3: Feature Configuration -->
                <div class="filter-subchapter ds-compare-section" id="expCompareFeaturesSection">
                    <div class="subchapter-header-tablet" onclick="exp_toggleCompareSection('features')">
                        <span class="subchapter-title"><i class="fas fa-cogs mr-2 text-blue-500"></i>Feature Configuration</span>
                        <span class="subchapter-filter-status" id="expCompareFeaturesStatus"></span>
                        <i id="expCompareFeaturesChevron" class="fas fa-chevron-right subchapter-chevron"></i>
                    </div>
                    <div id="expCompareFeaturesContent" class="subchapter-content-outside hidden">
                        <div class="ds-compare-grid">
                            <div id="expCompareLeftFeatures" class="ds-compare-cell">
                                <div class="ds-compare-placeholder">Select an experiment</div>
                            </div>
                            <div id="expCompareRightFeatures" class="ds-compare-cell">
                                <div class="ds-compare-placeholder">Select an experiment</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 4: Model Configuration -->
                <div class="filter-subchapter ds-compare-section" id="expCompareModelSection">
                    <div class="subchapter-header-tablet" onclick="exp_toggleCompareSection('model')">
                        <span class="subchapter-title"><i class="fas fa-brain mr-2 text-pink-500"></i>Model Configuration</span>
                        <span class="subchapter-filter-status" id="expCompareModelStatus"></span>
                        <i id="expCompareModelChevron" class="fas fa-chevron-right subchapter-chevron"></i>
                    </div>
                    <div id="expCompareModelContent" class="subchapter-content-outside hidden">
                        <div class="ds-compare-grid">
                            <div id="expCompareLeftModel" class="ds-compare-cell">
                                <div class="ds-compare-placeholder">Select an experiment</div>
                            </div>
                            <div id="expCompareRightModel" class="ds-compare-cell">
                                <div class="ds-compare-placeholder">Select an experiment</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 5: Training Parameters -->
                <div class="filter-subchapter ds-compare-section" id="expCompareTrainingSection">
                    <div class="subchapter-header-tablet" onclick="exp_toggleCompareSection('training')">
                        <span class="subchapter-title"><i class="fas fa-running mr-2 text-orange-500"></i>Training Parameters</span>
                        <span class="subchapter-filter-status" id="expCompareTrainingStatus"></span>
                        <i id="expCompareTrainingChevron" class="fas fa-chevron-right subchapter-chevron"></i>
                    </div>
                    <div id="expCompareTrainingContent" class="subchapter-content-outside hidden">
                        <div class="ds-compare-grid">
                            <div id="expCompareLeftTraining" class="ds-compare-cell">
                                <div class="ds-compare-placeholder">Select an experiment</div>
                            </div>
                            <div id="expCompareRightTraining" class="ds-compare-cell">
                                <div class="ds-compare-placeholder">Select an experiment</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 6: Sampling Configuration -->
                <div class="filter-subchapter ds-compare-section" id="expCompareSamplingSection">
                    <div class="subchapter-header-tablet" onclick="exp_toggleCompareSection('sampling')">
                        <span class="subchapter-title"><i class="fas fa-filter mr-2 text-teal-500"></i>Sampling Configuration</span>
                        <span class="subchapter-filter-status" id="expCompareSamplingStatus"></span>
                        <i id="expCompareSamplingChevron" class="fas fa-chevron-right subchapter-chevron"></i>
                    </div>
                    <div id="expCompareSamplingContent" class="subchapter-content-outside hidden">
                        <div class="ds-compare-grid">
                            <div id="expCompareLeftSampling" class="ds-compare-cell">
                                <div class="ds-compare-placeholder">Select an experiment</div>
                            </div>
                            <div id="expCompareRightSampling" class="ds-compare-cell">
                                <div class="ds-compare-placeholder">Select an experiment</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="exp_closeCompareModal()">
                    <span class="btn-neu-inner">Close</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- =============================================================================
     CONFIRMATION MODAL (Reusable styled confirmation dialog)
     ============================================================================ -->
<div id="confirmModal" class="modal-overlay hidden">
    <div class="modal-container" style="max-width: 28rem;">
        <div class="modal-header">
            <div id="confirmModalIcon" class="modal-header-icon warning">
                <i class="fas fa-exclamation-triangle text-xl"></i>
            </div>
            <h3 id="confirmModalTitle" class="modal-header-title">Confirm Action</h3>
        </div>
        <div class="modal-body">
            <p id="confirmModalMessage">Are you sure you want to proceed?</p>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button id="confirmModalConfirmBtn" class="btn-neu btn-neu-action btn-neu-save">
                    <span class="btn-neu-inner">Ok</span>
                </button>
                <button id="confirmModalCancelBtn" class="btn-neu btn-neu-action btn-neu-cancel">
                    <span class="btn-neu-inner">Cancel</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Experiment View Modal (Reusable Component) -->
{% include 'includes/_exp_view_modal.html' %}

{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
// =============================================================================
// CHAPTER TOGGLE
// =============================================================================
function toggleChapter(header) {
    const container = header.closest('.chapter-container');
    container.classList.toggle('open');
}

// =============================================================================
// STATE & CONSTANTS
// =============================================================================
const modelId = {{ model.id }};

function appendModelEndpointId(url) {
    if (!modelId) return url;
    const sep = url.includes('?') ? '&' : '?';
    return `${url}${sep}model_endpoint_id=${modelId}`;
}

// Data
let allFeatureConfigs = [];
let allModelConfigs = [];
let experiments = [];
let pagination = { page: 1, page_size: 10, total_count: 0, total_pages: 1 };

// Wizard state
let wizardStep = 1;
let selectedModelType = 'retrieval';  // Default to retrieval
let selectedFeatureConfig = null;
let selectedModelConfig = null;
let datasetEstimatedRows = null;  // Estimated rows from selected feature config's dataset
let datasetDateDays = null;  // Number of days in dataset for split strategy calculations

// Misc
let searchDebounceTimer = null;

// Data type constants
const DATA_TYPES = {
    numeric: { label: 'Numeric', icon: 'hashtag' },
    text: { label: 'Text', icon: 'font' },
    temporal: { label: 'Temporal', icon: 'calendar' }
};

// =============================================================================
// CONFIRMATION MODAL FUNCTIONS
// =============================================================================

/**
 * Show confirmation modal with custom title, message, and callbacks
 * @param {Object} options - Modal configuration
 * @param {string} options.title - Modal title
 * @param {string} options.message - Modal message (HTML supported)
 * @param {string} options.confirmText - Text for confirm button (default: "Confirm")
 * @param {string} options.cancelText - Text for cancel button (default: "Cancel")
 * @param {string} options.type - Modal type: 'danger', 'warning', 'info', 'success' (default: 'warning')
 * @param {string} options.confirmButtonClass - Custom class for confirm button (overrides type-based class)
 * @param {string} options.cancelButtonClass - Custom class for cancel button (e.g., 'btn-neu-cancel' for red)
 * @param {Function} options.onConfirm - Callback when confirmed
 * @param {Function} options.onCancel - Callback when cancelled (optional)
 */
function showConfirmModal(options) {
    const modal = document.getElementById('confirmModal');
    const icon = document.getElementById('confirmModalIcon');
    const title = document.getElementById('confirmModalTitle');
    const message = document.getElementById('confirmModalMessage');
    const confirmBtn = document.getElementById('confirmModalConfirmBtn');
    const cancelBtn = document.getElementById('confirmModalCancelBtn');

    // Set content
    title.textContent = options.title || 'Confirm Action';
    message.innerHTML = options.message || 'Are you sure you want to proceed?';

    // Update inner span text for neumorphic buttons
    const confirmInner = confirmBtn.querySelector('.btn-neu-inner');
    const cancelInner = cancelBtn.querySelector('.btn-neu-inner');
    if (confirmInner) confirmInner.textContent = options.confirmText || 'Confirm';
    if (cancelInner) cancelInner.textContent = options.cancelText || 'Cancel';

    // Set icon and button type
    const type = options.type || 'warning';
    icon.className = `modal-header-icon ${type}`;

    // Update icon based on type
    const iconElement = icon.querySelector('i');
    const baseClasses = 'btn-neu btn-neu-action';

    // Determine confirm button class (custom class takes precedence)
    let confirmButtonClass = options.confirmButtonClass;
    if (!confirmButtonClass) {
        if (type === 'danger') {
            iconElement.className = 'fas fa-exclamation-triangle text-xl';
            confirmButtonClass = 'btn-neu-cancel';
        } else if (type === 'warning') {
            iconElement.className = 'fas fa-exclamation-circle text-xl';
            confirmButtonClass = 'btn-neu-warning';
        } else if (type === 'info') {
            iconElement.className = 'fas fa-info-circle text-xl';
            confirmButtonClass = 'btn-neu-nav-wide';
        } else if (type === 'success') {
            iconElement.className = 'fas fa-check-circle text-xl';
            confirmButtonClass = 'btn-neu-save';
        }
    } else {
        // Set icon based on type even when custom button class is provided
        if (type === 'danger') {
            iconElement.className = 'fas fa-exclamation-triangle text-xl';
        } else if (type === 'warning') {
            iconElement.className = 'fas fa-exclamation-circle text-xl';
        } else if (type === 'info') {
            iconElement.className = 'fas fa-info-circle text-xl';
        } else if (type === 'success') {
            iconElement.className = 'fas fa-check-circle text-xl';
        }
    }
    confirmBtn.className = `${baseClasses} ${confirmButtonClass}`;

    // Set cancel button class (default: btn-neu-secondary for grey)
    cancelBtn.className = `${baseClasses} ${options.cancelButtonClass || 'btn-neu-secondary'}`;

    // Hide cancel button if requested (for notification modals)
    if (options.hideCancel) {
        cancelBtn.style.display = 'none';
    } else {
        cancelBtn.style.display = '';
    }

    // Remove old event listeners by cloning
    const newConfirmBtn = confirmBtn.cloneNode(true);
    const newCancelBtn = cancelBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

    // Add new event listeners
    newConfirmBtn.addEventListener('click', () => {
        hideConfirmModal();
        if (options.onConfirm) options.onConfirm();
    });

    newCancelBtn.addEventListener('click', () => {
        hideConfirmModal();
        if (options.onCancel) options.onCancel();
    });

    // Show modal
    modal.classList.remove('hidden');

    // Close on overlay click
    modal.addEventListener('click', function overlayClick(e) {
        if (e.target === modal) {
            hideConfirmModal();
            if (options.onCancel) options.onCancel();
            modal.removeEventListener('click', overlayClick);
        }
    });

    // Close on ESC key
    function escapeHandler(e) {
        if (e.key === 'Escape') {
            hideConfirmModal();
            if (options.onCancel) options.onCancel();
            document.removeEventListener('keydown', escapeHandler);
        }
    }
    document.addEventListener('keydown', escapeHandler);

    // Auto-close after specified time if requested
    if (options.autoClose && options.autoClose > 0) {
        if (window._confirmModalAutoCloseTimer) {
            clearTimeout(window._confirmModalAutoCloseTimer);
        }
        window._confirmModalAutoCloseTimer = setTimeout(() => {
            hideConfirmModal();
            if (options.onConfirm) options.onConfirm();
        }, options.autoClose);
    }
}

function hideConfirmModal() {
    const modal = document.getElementById('confirmModal');
    modal.classList.add('hidden');
    // Clear any auto-close timer
    if (window._confirmModalAutoCloseTimer) {
        clearTimeout(window._confirmModalAutoCloseTimer);
        window._confirmModalAutoCloseTimer = null;
    }
}

// =============================================================================
// FEATURE CONFIG HELPER FUNCTIONS
// =============================================================================

function getDataTypeLabel(dataType) {
    return DATA_TYPES[dataType]?.label || dataType;
}

function getDataTypeFromBqType(bqType) {
    const type = (bqType || 'STRING').toUpperCase();
    if (['INTEGER', 'INT64', 'FLOAT', 'FLOAT64', 'NUMERIC', 'BIGNUMERIC'].includes(type)) {
        return 'numeric';
    } else if (['TIMESTAMP', 'DATETIME', 'DATE', 'TIME'].includes(type)) {
        return 'temporal';
    } else {
        return 'text';
    }
}

function getFeatureDisplayInfo(feature) {
    const dataType = feature.data_type || getDataTypeFromBqType(feature.bq_type);
    const transforms = feature.transforms || {};
    let outputParts = [];
    let totalDim = 0;

    if (dataType === 'numeric') {
        if (transforms.normalize?.enabled) {
            outputParts.push('Norm: 1D');
            totalDim += 1;
        }
        if (transforms.bucketize?.enabled) {
            const dim = transforms.bucketize.embedding_dim || 32;
            outputParts.push(`Bucket: ${dim}D`);
            totalDim += dim;
        }
    } else if (dataType === 'text') {
        if (transforms.embedding?.enabled) {
            const dim = transforms.embedding.embedding_dim || 32;
            outputParts.push(`Embed: ${dim}D`);
            totalDim += dim;
        }
    } else if (dataType === 'temporal') {
        if (transforms.normalize?.enabled) {
            outputParts.push('Norm: 1D');
            totalDim += 1;
        }
        if (transforms.cyclical?.enabled) {
            const cyclical = transforms.cyclical;
            let cyclicalDim = 0;
            if (cyclical.yearly || cyclical.annual) cyclicalDim += 2;
            if (cyclical.quarterly) cyclicalDim += 2;
            if (cyclical.monthly) cyclicalDim += 2;
            if (cyclical.weekly) cyclicalDim += 2;
            if (cyclical.daily) cyclicalDim += 2;
            if (cyclicalDim > 0) {
                outputParts.push(`Cyclical: ${cyclicalDim}D`);
                totalDim += cyclicalDim;
            }
        }
        if (transforms.bucketize?.enabled) {
            const dim = transforms.bucketize.embedding_dim || 32;
            outputParts.push(`Bucket: ${dim}D`);
            totalDim += dim;
        }
    }

    return {
        dataTypeLabel: getDataTypeLabel(dataType),
        transformStr: outputParts.length > 0 ? outputParts.join(' + ') : 'No transform',
        totalDim,
        hasTransforms: outputParts.length > 0
    };
}

function getCrossFeatureNames(cross) {
    // Use display_name (alias) if available
    if (!cross.features || cross.features.length === 0) return [];
    if (typeof cross.features[0] === 'string') {
        return cross.features;
    }
    return cross.features.map(f => f.display_name || f.column);
}

function calculateTensorBreakdown(features, crosses) {
    const breakdown = [];
    let total = 0;

    (features || []).forEach(feature => {
        const info = getFeatureDisplayInfo(feature);
        if (info.totalDim > 0) {
            // Use display_name (alias) if available
            breakdown.push({ name: feature.display_name || feature.column, dim: info.totalDim });
            total += info.totalDim;
        }
    });

    (crosses || []).forEach(cross => {
        const dim = cross.embedding_dim || 16;
        const featureNames = getCrossFeatureNames(cross);
        const name = featureNames.join('  ');
        breakdown.push({ name: name, dim: dim, is_cross: true });
        total += dim;
    });

    return { total, breakdown };
}

function buildDatasetInfoHtml(info, datasetName) {
    if (!info || !info.primary_table) {
        return '';
    }

    const tables = [info.primary_table + ' (primary)'];
    (info.secondary_tables || []).forEach(t => {
        if (t) tables.push(t);
    });
    const tablesLine = tables.join(' &bull; ');

    const filterBadges = [];
    if (info.filters?.dates) filterBadges.push(info.filters.dates);
    if (info.filters?.customers) filterBadges.push(info.filters.customers);
    if (info.filters?.products) filterBadges.push(info.filters.products);
    const filtersLine = filterBadges.length > 0
        ? filterBadges.join(' &bull; ')
        : '<span class="text-gray-400 italic">No filters</span>';

    const rowsBadge = info.estimated_rows
        ? `${info.estimated_rows.toLocaleString()} rows`
        : '';

    return `
        <div class="mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <div class="flex items-center justify-between mb-3">
                <h4 class="font-semibold text-gray-700">
                    <i class="fas fa-database mr-2 text-gray-400"></i>Dataset Source
                </h4>
                ${rowsBadge ? `<span class="text-sm font-medium text-gray-500 bg-white px-2 py-1 rounded border border-gray-200">${rowsBadge}</span>` : ''}
            </div>
            <div class="space-y-2 text-sm">
                <div class="flex">
                    <span class="text-gray-500 w-16 flex-shrink-0">Tables:</span>
                    <span class="text-gray-700">${tablesLine}</span>
                </div>
                <div class="flex">
                    <span class="text-gray-500 w-16 flex-shrink-0">Filters:</span>
                    <span class="text-gray-700">${filtersLine}</span>
                </div>
            </div>
        </div>
    `;
}

function renderWizardTensorPreview(model, total, breakdown, barContainer, maxTotal = null) {
    barContainer.innerHTML = '';
    if (!breakdown || breakdown.length === 0) return;

    if (maxTotal && maxTotal > 0) {
        const widthPercent = (total / maxTotal) * 100;
        barContainer.style.width = `${widthPercent}%`;
    } else {
        barContainer.style.width = '100%';
    }

    const colors = model === 'buyer'
        ? ['#3b82f6', '#60a5fa', '#93c5fd', '#bfdbfe', '#dbeafe']
        : ['#10b981', '#34d399', '#6ee7b7', '#a7f3d0', '#d1fae5'];

    breakdown.forEach((item, idx) => {
        const pct = (item.dim / total) * 100;
        const color = colors[idx % colors.length];

        const segment = document.createElement('div');
        segment.className = 'tensor-breakdown-segment';
        segment.style.width = `${pct}%`;
        segment.style.backgroundColor = color;
        segment.title = `${item.name}: ${item.dim}D`;
        if (pct > 10) {
            segment.textContent = item.dim;
        }
        barContainer.appendChild(segment);
    });
}

// =============================================================================
// MODEL CONFIG HELPER FUNCTIONS
// =============================================================================

function renderCardTowerLayers(buyerLayers, productLayers) {
    const maxLen = Math.max(buyerLayers.length, productLayers.length);
    if (maxLen === 0) {
        return {
            buyer: '<div class="text-xs text-gray-400 italic p-2">No layers</div>',
            product: '<div class="text-xs text-gray-400 italic p-2">No layers</div>'
        };
    }

    const renderLayer = (layer, isOutput) => {
        let badge = '';
        let params = '';

        if (layer.type === 'dense') {
            badge = '<span class="card-layer-badge dense">Dense</span>';
            params = `${layer.units} units`;
            if (layer.activation) params += `, ${layer.activation}`;
            if (layer.l2_regularization) params += `, L2=${layer.l2_regularization}`;
            else if (layer.l2_reg) params += `, L2=${layer.l2_reg}`;
        } else if (layer.type === 'dropout') {
            badge = '<span class="card-layer-badge dropout">Dropout</span>';
            params = `rate: ${layer.rate}`;
        } else if (layer.type === 'batch_norm') {
            badge = '<span class="card-layer-badge batch_norm">BatchNorm</span>';
            params = '';
        } else if (layer.type === 'layer_norm') {
            badge = '<span class="card-layer-badge layer_norm">LayerNorm</span>';
            params = layer.epsilon ? `: ${layer.epsilon}` : '';
        }

        return `
            <div class="card-layer-item${isOutput ? ' output-layer' : ''}">
                <span class="card-drag-handle"><i class="fas fa-grip-vertical"></i></span>
                ${badge}
                <span class="card-layer-params">${params}</span>
            </div>
        `;
    };

    const renderPlaceholder = () => '<div class="card-layer-item empty-placeholder">&nbsp;</div>';

    const buildTowerHtml = (layers, placeholderCount) => {
        if (layers.length === 0) return '';

        const result = [];
        for (let i = 0; i < layers.length - 1; i++) {
            result.push(renderLayer(layers[i], false));
        }
        for (let i = 0; i < placeholderCount; i++) {
            result.push(renderPlaceholder());
        }
        result.push(renderLayer(layers[layers.length - 1], true));

        return result.join('');
    };

    const buyerPlaceholders = maxLen - buyerLayers.length;
    const productPlaceholders = maxLen - productLayers.length;

    return {
        buyer: buildTowerHtml(buyerLayers, buyerPlaceholders),
        product: buildTowerHtml(productLayers, productPlaceholders)
    };
}

function calculateSingleTowerParams(layers, inputDim = 100) {
    let params = 0;
    let prevDim = inputDim;
    for (const layer of layers) {
        if (layer.type === 'dense') {
            params += prevDim * layer.units + layer.units;
            prevDim = layer.units;
        } else if (layer.type === 'batch_norm') {
            params += prevDim * 4;
        } else if (layer.type === 'layer_norm') {
            params += prevDim * 2;
        }
    }
    return params;
}

// =============================================================================
// INITIALIZATION
// =============================================================================
document.addEventListener('DOMContentLoaded', function() {
    loadInitialData();
    loadExperimentsDashboard();

    // Configure the reusable ExpViewModal module
    ExpViewModal.configure({
        modelId: modelId,
        showTabs: ['overview', 'pipeline', 'data', 'training'],
        onUpdate: function(exp) {
            // Refresh dashboard sections when experiment status changes
            loadTopConfigurations();
            loadRecentExperiments();
        }
    });
});

async function loadInitialData() {
    try {
        // Load Feature Configs, Model Configs, and Experiments in parallel
        const [fcResponse, mcResponse, expResponse] = await Promise.all([
            fetch(appendModelEndpointId(`/api/models/${modelId}/feature-configs/`)),
            fetch(appendModelEndpointId(`/api/models/${modelId}/model-configs/`)),
            fetch(appendModelEndpointId('/api/quick-tests/?page=1&page_size=10'))
        ]);

        const fcData = await fcResponse.json();
        const mcData = await mcResponse.json();
        const expData = await expResponse.json();

        if (fcData.success) {
            // Filter out test/draft configs (names starting with 'test_' or 'old_')
            // but keep all configs that have transform code generated
            allFeatureConfigs = fcData.data.filter(c => {
                if (!c.has_transform_code) return false;
                const name = (c.name || '').toLowerCase();
                // Exclude test/draft configs by name pattern
                if (name.startsWith('test_') || name.startsWith('old_')) return false;
                return true;
            });
        }
        if (mcData.success) {
            allModelConfigs = mcData.data;
        }

        // Hide loading
        document.getElementById('expLoading').classList.add('hidden');

        // Check if we have configs
        if (allFeatureConfigs.length === 0 || allModelConfigs.length === 0) {
            document.getElementById('expNoConfigs').classList.remove('hidden');
            return;
        }

        // Populate filter dropdowns
        populateFilterDropdowns();

        // Show experiments or empty state
        if (expData.success) {
            experiments = expData.quick_tests;
            pagination = expData.pagination;

            if (experiments.length === 0) {
                document.getElementById('expEmpty').classList.remove('hidden');
            } else {
                document.getElementById('expFilterBar').classList.remove('hidden');
                document.getElementById('expList').classList.remove('hidden');
                renderExperiments();
                startBackgroundPolling();
            }
        } else {
            // API failed (e.g., no model endpoint) - show empty state
            console.warn('Experiments API error:', expData.error);
            document.getElementById('expEmpty').classList.remove('hidden');
        }

    } catch (error) {
        console.error('Failed to load initial data:', error);
        document.getElementById('expLoading').classList.add('hidden');
        showError('Failed to load data: ' + error.message);
    }
}

function populateFilterDropdowns() {
    // Dataset filter - extract unique datasets from feature configs
    const datasetFilter = document.getElementById('expDatasetFilter');
    const uniqueDatasets = new Map();
    allFeatureConfigs.forEach(fc => {
        if (fc.dataset_id && fc.dataset_name && !uniqueDatasets.has(fc.dataset_id)) {
            uniqueDatasets.set(fc.dataset_id, fc.dataset_name);
        }
    });
    uniqueDatasets.forEach((name, id) => {
        const option = document.createElement('option');
        option.value = id;
        option.textContent = name;
        datasetFilter.appendChild(option);
    });

    // Feature Config filter
    const featureFilter = document.getElementById('expFeatureFilter');
    allFeatureConfigs.forEach(fc => {
        const option = document.createElement('option');
        option.value = fc.id;
        option.textContent = fc.name;
        featureFilter.appendChild(option);
    });

    // Model Config filter
    const modelFilter = document.getElementById('expModelFilter');
    allModelConfigs.forEach(mc => {
        const option = document.createElement('option');
        option.value = mc.id;
        option.textContent = mc.name;
        modelFilter.appendChild(option);
    });
}

// =============================================================================
// EXPERIMENTS LIST
// =============================================================================
function renderExperiments() {
    const container = document.getElementById('expCardsContainer');

    if (experiments.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <i class="fas fa-search text-2xl mb-2"></i>
                <p>No experiments match your filters</p>
            </div>
        `;
        document.getElementById('expPagination').classList.add('hidden');
        return;
    }

    container.innerHTML = experiments.map(exp => renderExpCard(exp)).join('');
    renderPagination();
}

function renderMetricsRow(exp) {
    const formatRecall = v => v != null ? (v * 100).toFixed(1) + '%' : '--';
    const formatRMSE = v => v != null ? v.toFixed(2) : '--';

    // Check model type
    const configType = exp.feature_config_type;

    let metrics;
    if (configType === 'multitask') {
        // Multitask: Show BOTH retrieval and ranking metrics in two rows
        const retrievalMetrics = [
            { label: 'R@5', value: exp.recall_at_5, format: formatRecall },
            { label: 'R@10', value: exp.recall_at_10, format: formatRecall },
            { label: 'R@50', value: exp.recall_at_50, format: formatRecall },
            { label: 'R@100', value: exp.recall_at_100, format: formatRecall }
        ];
        const rankingMetrics = [
            { label: 'RMSE', value: exp.rmse, format: formatRMSE },
            { label: 'Test RMSE', value: exp.test_rmse, format: formatRMSE },
            { label: 'MAE', value: exp.mae, format: formatRMSE },
            { label: 'Test MAE', value: exp.test_mae, format: formatRMSE }
        ];

        return `
            <div class="exp-card-metrics-multitask">
                <div class="exp-card-metrics-section">
                    <div class="exp-card-metrics-section-label"><i class="fas fa-search"></i> Retrieval</div>
                    <div class="exp-card-metrics-row">
                        ${retrievalMetrics.map(m => `
                            <div class="exp-card-metric">
                                <div class="exp-card-metric-label">${m.label}</div>
                                <div class="exp-card-metric-value ${m.value == null ? 'empty' : ''}">${m.format(m.value)}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="exp-card-metrics-section">
                    <div class="exp-card-metrics-section-label"><i class="fas fa-star"></i> Ranking</div>
                    <div class="exp-card-metrics-row">
                        ${rankingMetrics.map(m => `
                            <div class="exp-card-metric">
                                <div class="exp-card-metric-label">${m.label}</div>
                                <div class="exp-card-metric-value ${m.value == null ? 'empty' : ''}">${m.format(m.value)}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
    } else if (configType === 'ranking') {
        // Ranking model metrics - RMSE/MAE (lower is better)
        // Group by metric type: RMSEs together, MAEs together
        metrics = [
            { label: 'RMSE', value: exp.rmse, format: formatRMSE },
            { label: 'Test RMSE', value: exp.test_rmse, format: formatRMSE },
            { label: 'MAE', value: exp.mae, format: formatRMSE },
            { label: 'Test MAE', value: exp.test_mae, format: formatRMSE }
        ];
    } else {
        // Retrieval model metrics - Recall@K (higher is better)
        metrics = [
            { label: 'R@5', value: exp.recall_at_5, format: formatRecall },
            { label: 'R@10', value: exp.recall_at_10, format: formatRecall },
            { label: 'R@50', value: exp.recall_at_50, format: formatRecall },
            { label: 'R@100', value: exp.recall_at_100, format: formatRecall }
        ];
    }

    return `
        <div class="exp-card-metrics-row">
            ${metrics.map(m => `
                <div class="exp-card-metric">
                    <div class="exp-card-metric-label">${m.label}</div>
                    <div class="exp-card-metric-value ${m.value == null ? 'empty' : ''}">${m.format(m.value)}</div>
                </div>
            `).join('')}
        </div>
    `;
}

/**
 * Generate unified model type badge HTML for experiment cards
 * Uses same style as model_configs.html badges
 */
function generateExpTypeBadge(modelType) {
    const type = (modelType || '').toLowerCase();
    switch (type) {
        case 'retrieval':
            return `<span class="exp-card-type-badge retrieval" title="Retrieval model">
                       <i class="fas fa-search"></i> Retrieval
                   </span>`;
        case 'ranking':
            return `<span class="exp-card-type-badge ranking" title="Ranking model">
                       <i class="fas fa-sort-amount-down"></i> Ranking
                   </span>`;
        case 'multitask':
            return `<span class="exp-card-type-badge multitask" title="Hybrid model (Retrieval + Ranking)">
                       <i class="fas fa-layer-group"></i> Retrieval / Ranking
                   </span>`;
        default:
            return `<span class="exp-card-type-badge retrieval" title="Retrieval model">
                       <i class="fas fa-search"></i> Retrieval
                   </span>`;
    }
}

function renderExpCard(exp) {
    const statusIcons = {
        'submitting': 'fa-spinner fa-spin',
        'running': 'fa-spinner fa-spin',
        'completed': 'fa-check',
        'failed': 'fa-times',
        'cancelled': 'fa-ban'
    };

    const statusClass = exp.status === 'submitting' ? 'submitting' : exp.status;
    const icon = statusIcons[exp.status] || 'fa-clock';

    // Build the progress bar
    const stagesHtml = renderStagesBar(exp.stage_details || getDefaultStages(), exp.status);

    // Truncate description to 50 chars
    const descTruncated = exp.experiment_description
        ? (exp.experiment_description.length > 50
            ? exp.experiment_description.substring(0, 50) + '...'
            : exp.experiment_description)
        : '';

    // Format Start and End times
    const formatDateTime = (isoStr) => {
        if (!isoStr) return '-';
        const d = new Date(isoStr);
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' +
               d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    };
    const startTime = formatDateTime(exp.started_at || exp.created_at);
    const endTime = exp.completed_at ? formatDateTime(exp.completed_at) : '-';

    // Show Cancel button - active only for running/submitting experiments
    const isRunning = exp.status === 'running' || exp.status === 'submitting';
    const isTerminal = ['completed', 'failed', 'cancelled'].includes(exp.status);
    const viewBtn = `<button class="card-action-btn view" onclick="viewExpFromCard(event, ${exp.id})">View</button>`;
    const cancelBtn = `<button class="card-action-btn cancel" onclick="cancelExpFromCard(event, ${exp.id})" ${isRunning ? '' : 'disabled'}>Cancel</button>`;
    // Rerun button - enabled only for terminal states
    const rerunBtn = `<button class="card-action-btn rerun" onclick="rerunExpFromCard(event, ${exp.id})" title="Re-run with same configuration" ${isTerminal ? '' : 'disabled'}>Rerun</button>`;
    // Delete button - disabled for running/submitting experiments (must cancel first)
    const canDelete = !isRunning;
    const deleteBtn = `<button class="card-action-btn icon-only delete" onclick="deleteExpFromCard(event, ${exp.id})" title="Delete experiment" ${canDelete ? '' : 'disabled'}><i class="fas fa-trash"></i></button>`;

    return `
        <div class="exp-card-new" onclick="openExpDetails(${exp.id})" data-exp-id="${exp.id}">
            <div class="exp-card-columns">
                <!-- Column 1: Experiment Info (30%) -->
                <div class="exp-card-col-info">
                    <div class="exp-card-status ${statusClass}">
                        <i class="fas ${icon}"></i>
                    </div>
                    <div class="exp-card-info-text">
                        <div class="exp-card-name">${exp.display_name}</div>
                        ${exp.experiment_name ? `<div class="exp-card-exp-name">${exp.experiment_name}</div>` : ''}
                        ${descTruncated ? `<div class="exp-card-description" title="${exp.experiment_description}">${descTruncated}</div>` : ''}
                        <div class="exp-card-times">
                            <div>Start: <span>${startTime}</span></div>
                            <div>End: <span>${endTime}</span></div>
                        </div>
                    </div>
                </div>
                <!-- Column 2: Config Info (20%) -->
                <div class="exp-card-col-config">
                    <div class="exp-card-config-item"><span class="exp-card-config-label">Dataset:</span> ${exp.dataset_name || '-'}</div>
                    <div class="exp-card-config-item"><span class="exp-card-config-label">Features:</span> ${exp.feature_config_name || '-'}</div>
                    <div class="exp-card-config-item"><span class="exp-card-config-label">Model:</span> ${exp.model_config_name || '-'}</div>
                    <div class="exp-card-config-item">${generateExpTypeBadge(exp.model_type)}</div>
                </div>
                <!-- Column 3: Accuracy Metrics (30%) -->
                <div class="exp-card-col-params">
                    ${renderMetricsRow(exp)}
                </div>
                <!-- Column 4: Actions (20%) - 2-column grid layout like training cards -->
                <div class="ml-card-col-actions">
                    <div class="ml-card-actions-grid">
                        ${rerunBtn}
                        ${viewBtn}
                        ${cancelBtn}
                        <div class="card-action-btn-group">
                            ${deleteBtn}
                        </div>
                    </div>
                </div>
            </div>
            ${stagesHtml}
        </div>
    `;
}

function renderStagesBar(stages, expStatus) {
    // Render the 6-stage progress bar (tensor-breakdown-bar style)
    // Green gradient palette for completed stages - saturated enough for white text
    const completedColors = ['#059669', '#10b981', '#22c55e', '#34d399', '#4ade80', '#6ee7b7'];

    const stagesHtml = stages.map((stage, idx) => {
        let status = stage.status || 'pending';
        // If experiment is in a terminal state, override any stale 'running' stages
        if (status === 'running' && expStatus === 'cancelled') {
            status = 'cancelled';
        } else if (status === 'running' && expStatus === 'failed') {
            status = 'failed';
        }
        // Apply gradient color for completed stages based on position
        const style = status === 'completed' ? `style="background: ${completedColors[idx % completedColors.length]}"` : '';
        return `<div class="exp-stage-segment ${status}" ${style} title="${stage.name}">${stage.name}</div>`;
    }).join('');

    return `
        <div class="exp-card-stages">
            <div class="exp-stages-bar">
                ${stagesHtml}
            </div>
        </div>
    `;
}

function renderPagination() {
    const container = document.getElementById('expPagination');
    if (pagination.total_pages <= 1) {
        container.classList.add('hidden');
        return;
    }

    container.classList.remove('hidden');

    const start = (pagination.page - 1) * pagination.page_size + 1;
    const end = Math.min(pagination.page * pagination.page_size, pagination.total_count);

    document.getElementById('expPaginationInfo').textContent = `Showing ${start}-${end} of ${pagination.total_count}`;

    const buttonsContainer = document.getElementById('expPaginationButtons');
    let buttonsHtml = '';

    // Previous button (hidden when on first page)
    if (pagination.has_prev) {
        buttonsHtml += `<button onclick="goToPage(${pagination.page - 1})" class="btn btn-secondary btn-xs">Previous</button>`;
    }

    // Page numbers with ellipsis
    const totalPages = pagination.total_pages;
    if (totalPages <= 4) {
        for (let i = 1; i <= totalPages; i++) {
            buttonsHtml += expPageButton(i);
        }
    } else {
        buttonsHtml += expPageButton(1);
        if (pagination.page > 3) {
            buttonsHtml += `<span class="px-1 text-gray-400">...</span>`;
        }
        const s = Math.max(2, pagination.page - 1);
        const e = Math.min(totalPages - 1, pagination.page + 1);
        for (let i = s; i <= e; i++) {
            buttonsHtml += expPageButton(i);
        }
        if (pagination.page < totalPages - 2) {
            buttonsHtml += `<span class="px-1 text-gray-400">...</span>`;
        }
        buttonsHtml += expPageButton(totalPages);
    }

    // Next button (hidden when on last page)
    if (pagination.has_next) {
        buttonsHtml += `<button onclick="goToPage(${pagination.page + 1})" class="btn btn-secondary btn-xs">Next</button>`;
    }

    buttonsContainer.innerHTML = buttonsHtml;
}

function expPageButton(pageNum) {
    if (pageNum === pagination.page) {
        return `<button class="btn btn-primary btn-xs" style="background-color: #6b7280; color: #fff; border-color: #6b7280;">${pageNum}</button>`;
    }
    return `<button onclick="goToPage(${pageNum})" class="btn btn-secondary btn-xs">${pageNum}</button>`;
}

async function goToPage(page) {
    if (page < 1 || page > pagination.total_pages) return;
    await loadExperiments(page);
}

async function loadExperiments(page = 1) {
    const status = document.getElementById('expStatusFilter').value;
    const modelType = document.getElementById('expModelTypeFilter').value;
    const datasetId = document.getElementById('expDatasetFilter').value;
    const featureConfigId = document.getElementById('expFeatureFilter').value;
    const modelConfigId = document.getElementById('expModelFilter').value;
    const search = document.getElementById('expSearchInput').value.trim();

    let url = `/api/quick-tests/?page=${page}&page_size=${pagination.page_size}`;
    if (status) url += `&status=${status}`;
    if (modelType) url += `&model_type=${modelType}`;
    if (datasetId) url += `&dataset_id=${datasetId}`;
    if (featureConfigId) url += `&feature_config_id=${featureConfigId}`;
    if (modelConfigId) url += `&model_config_id=${modelConfigId}`;
    if (search) url += `&search=${encodeURIComponent(search)}`;

    try {
        const response = await fetch(appendModelEndpointId(url));
        const data = await response.json();

        if (data.success) {
            experiments = data.quick_tests;
            pagination = data.pagination;
            renderExperiments();
        }
    } catch (error) {
        console.error('Error loading experiments:', error);
    }
}

function filterExperiments() {
    loadExperiments(1);
}

function debounceExpSearch() {
    clearTimeout(searchDebounceTimer);
    searchDebounceTimer = setTimeout(() => filterExperiments(), 300);
}

// =============================================================================
// WIZARD MODAL
// =============================================================================
function openNewExpWizard() {
    // Reset wizard state
    wizardStep = 1;
    selectedModelType = 'retrieval';  // Default to retrieval
    selectedFeatureConfig = null;
    selectedModelConfig = null;

    // Reset model type selector UI
    document.querySelectorAll('.wizard-model-type-option').forEach(btn => {
        btn.classList.toggle('selected', btn.dataset.type === 'retrieval');
    });

    // Populate dropdowns (filtered by model type)
    populateWizardDropdowns();

    // Reset UI
    updateWizardUI();
    document.getElementById('wizardExpName').value = '';
    document.getElementById('wizardExpDescription').value = '';
    document.getElementById('wizardFeatureSelect').value = '';
    document.getElementById('wizardModelSelect').value = '';
    document.getElementById('wizardFeaturePreview').classList.add('hidden');
    document.getElementById('wizardFeatureEmpty').classList.remove('hidden');
    document.getElementById('wizardModelPreview').classList.add('hidden');
    document.getElementById('wizardModelEmpty').classList.remove('hidden');

    // Reset training params
    document.getElementById('wizardSplitStrategy').value = 'random';
    document.getElementById('wizardSamplePercentInput').value = '100';
    document.querySelectorAll('.sample-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.value === '100');
    });
    // Reset training parameters with button states
    setParam('epochs', 25);
    setParam('batchSize', 1024);
    setParam('learningRate', 0.01);
    // Reset split strategy UI (use style.display for inline-styled elements)
    document.getElementById('wizardRandomInfo').style.display = 'flex';
    document.getElementById('wizardTimeOptions').style.display = 'none';
    document.getElementById('wizardDateColumnSection').style.display = 'none';
    document.getElementById('wizardRollingWindowSection').style.display = 'none';
    document.getElementById('wizardRatingSection').classList.add('hidden');
    // Reset rolling window values
    document.getElementById('wizardTrainDays').value = '60';
    document.getElementById('wizardValDays').value = '7';
    document.getElementById('wizardTestDays').value = '7';

    // Reset example count
    datasetEstimatedRows = null;
    document.getElementById('wizardExampleCountValue').textContent = '--';

    document.getElementById('newExpWizardModal').classList.remove('hidden');
}

function closeNewExpWizard() {
    document.getElementById('newExpWizardModal').classList.add('hidden');
}

function selectExpModelType(type) {
    /**
     * Handle model type selection in the experiment wizard.
     * Updates state, UI, and filters both dropdowns.
     */
    if (selectedModelType === type) return;  // No change

    selectedModelType = type;

    // Update button UI
    document.querySelectorAll('.wizard-model-type-option').forEach(btn => {
        btn.classList.toggle('selected', btn.dataset.type === type);
    });

    // Clear current selections
    selectedFeatureConfig = null;
    selectedModelConfig = null;

    // Reset preview panels
    document.getElementById('wizardFeaturePreview').classList.add('hidden');
    document.getElementById('wizardFeatureEmpty').classList.remove('hidden');
    document.getElementById('wizardModelPreview').classList.add('hidden');
    document.getElementById('wizardModelEmpty').classList.remove('hidden');

    // Hide config type info badge
    hideConfigTypeInfo();

    // Re-populate dropdowns with filtered configs
    populateWizardDropdowns();

    // Update summary
    updateWizardSummary();
}

function populateWizardDropdowns() {
    /**
     * Populate Feature Config and Model Config dropdowns.
     * Filters based on selectedModelType:
     * - Retrieval: Feature configs with config_type='retrieval' (no target column)
     * - Ranking/Multitask: Feature configs with config_type='ranking' (has target column)
     */

    // Feature Config dropdown - filtered by model type
    const fcSelect = document.getElementById('wizardFeatureSelect');
    fcSelect.innerHTML = '<option value="">-- Select Feature Config --</option>';

    // Filter feature configs based on selected model type
    const compatibleFCs = filterFeatureConfigsByModelType(allFeatureConfigs, selectedModelType);

    // Group filtered configs by dataset
    const byDataset = {};
    compatibleFCs.forEach(fc => {
        const dsName = fc.dataset_name || 'Unknown Dataset';
        if (!byDataset[dsName]) byDataset[dsName] = [];
        byDataset[dsName].push(fc);
    });

    Object.entries(byDataset).forEach(([dsName, configs]) => {
        const optgroup = document.createElement('optgroup');
        optgroup.label = dsName;
        configs.forEach(fc => {
            const option = document.createElement('option');
            option.value = fc.id;
            option.textContent = fc.name;
            optgroup.appendChild(option);
        });
        fcSelect.appendChild(optgroup);
    });

    // Show message if no compatible feature configs
    if (compatibleFCs.length === 0) {
        const option = document.createElement('option');
        option.value = '';
        option.disabled = true;
        const configType = selectedModelType === 'retrieval' ? 'retrieval' : 'ranking';
        option.textContent = `No ${configType} feature configs available`;
        fcSelect.appendChild(option);
    }

    // Model Config dropdown - filtered by model type
    const mcSelect = document.getElementById('wizardModelSelect');
    mcSelect.innerHTML = '<option value="">-- Select Model Config --</option>';

    const compatibleMCs = allModelConfigs.filter(mc => mc.model_type === selectedModelType);

    compatibleMCs.forEach(mc => {
        const option = document.createElement('option');
        option.value = mc.id;
        option.textContent = mc.name;
        mcSelect.appendChild(option);
    });

    // Show message if no compatible model configs
    if (compatibleMCs.length === 0) {
        const option = document.createElement('option');
        option.value = '';
        option.disabled = true;
        option.textContent = `No ${selectedModelType} model configs available`;
        mcSelect.appendChild(option);
    }
}

function filterFeatureConfigsByModelType(configs, modelType) {
    /**
     * Filter feature configs based on selected model type.
     * - Retrieval: needs config_type='retrieval' (no target column)
     * - Ranking/Multitask: needs config_type='ranking' (has target column)
     */
    if (modelType === 'retrieval') {
        return configs.filter(fc => {
            const fcType = fc.config_type || 'retrieval';
            return fcType === 'retrieval';
        });
    } else {
        // Ranking and Multitask both need feature configs with target column
        return configs.filter(fc => {
            const fcType = fc.config_type || 'retrieval';
            return fcType === 'ranking';
        });
    }
}

function onWizardFeatureChange() {
    const fcId = parseInt(document.getElementById('wizardFeatureSelect').value);
    selectedFeatureConfig = allFeatureConfigs.find(fc => fc.id === fcId) || null;

    // Note: Model configs are already filtered by model type in populateWizardDropdowns()
    // No need to re-filter here since model type is selected first

    // Show target column info for ranking/multitask configs
    if (selectedFeatureConfig && (selectedModelType === 'ranking' || selectedModelType === 'multitask')) {
        const targetName = selectedFeatureConfig.target_column_name || selectedFeatureConfig.target_column?.display_name;
        if (targetName) {
            showConfigTypeInfo('ranking', targetName);
        }
    } else {
        hideConfigTypeInfo();
    }

    if (selectedFeatureConfig) {
        // Show preview panel with loading state
        document.getElementById('wizardFeatureEmpty').classList.add('hidden');
        document.getElementById('wizardFeaturePreview').classList.remove('hidden');
        document.getElementById('wizardFeatureLoading').classList.remove('hidden');
        document.getElementById('wizardFeatureContent').classList.add('hidden');

        // Fetch full feature config details
        fetch(appendModelEndpointId(`/api/feature-configs/${fcId}/`))
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    renderWizardFeaturePreview(data.data);
                }
            })
            .catch(err => {
                console.error('Error loading feature config:', err);
            })
            .finally(() => {
                document.getElementById('wizardFeatureLoading').classList.add('hidden');
                document.getElementById('wizardFeatureContent').classList.remove('hidden');
            });

        // Load date columns for time-based split
        loadWizardDateColumns(selectedFeatureConfig.dataset_id);
    } else {
        document.getElementById('wizardFeaturePreview').classList.add('hidden');
        document.getElementById('wizardFeatureEmpty').classList.remove('hidden');
    }

    updateWizardSummary();
}

function showConfigTypeInfo(configType, targetColumnName) {
    /**
     * Show info message about config type compatibility.
     */
    let infoEl = document.getElementById('configTypeInfo');
    if (!infoEl) {
        // Create info element if it doesn't exist
        infoEl = document.createElement('div');
        infoEl.id = 'configTypeInfo';
        infoEl.className = 'mt-2 p-2 rounded-lg text-sm';
        const mcSelect = document.getElementById('wizardModelSelect');
        mcSelect.parentNode.insertBefore(infoEl, mcSelect.nextSibling);
    }

    if (configType === 'ranking') {
        infoEl.className = 'mt-2 p-2 rounded-lg text-sm bg-amber-50 border border-amber-200 text-amber-800';
        infoEl.innerHTML = `
            <i class="fas fa-bullseye mr-1"></i>
            <strong>Ranking Config Selected</strong><br>
            <span class="text-xs">Target: ${targetColumnName}  Only Ranking model configs shown</span>
        `;
    }
    infoEl.classList.remove('hidden');
}

function hideConfigTypeInfo() {
    const infoEl = document.getElementById('configTypeInfo');
    if (infoEl) {
        infoEl.classList.add('hidden');
    }
}

function renderWizardFeaturePreview(config) {
    // Update dataset name
    document.getElementById('wizardFeatureDataset').textContent = config.dataset_name || '-';

    // Build and insert dataset info HTML
    const datasetInfoHtml = buildDatasetInfoHtml(config.dataset_info, config.dataset_name);
    document.getElementById('wizardDatasetInfo').innerHTML = datasetInfoHtml;

    // Render Target Column section (for ranking configs)
    const targetSection = document.getElementById('wizardTargetColumnSection');
    if (config.target_column && (selectedModelType === 'ranking' || selectedModelType === 'multitask')) {
        const tc = config.target_column;
        document.getElementById('wizardTargetColumnName').textContent = tc.display_name || tc.column || '-';
        document.getElementById('wizardTargetColumnType').textContent = tc.bq_type || 'FLOAT';

        // Build transforms tags
        const transforms = tc.transforms || {};
        let transformsHtml = '';
        if (transforms.normalize) {
            transformsHtml += '<span class="target-transform-tag"><i class="fas fa-compress-arrows-alt"></i> Normalize 0-1</span>';
        }
        if (transforms.log_transform) {
            transformsHtml += '<span class="target-transform-tag"><i class="fas fa-chart-line"></i> Log transform</span>';
        }
        if (transforms.clip_outliers) {
            const lower = transforms.clip_lower_percentile || 1;
            const upper = transforms.clip_upper_percentile || 99;
            transformsHtml += `<span class="target-transform-tag"><i class="fas fa-cut"></i> Clip ${lower}%-${upper}%</span>`;
        }
        document.getElementById('wizardTargetTransforms').innerHTML = transformsHtml;
        targetSection.classList.remove('hidden');
    } else {
        targetSection.classList.add('hidden');
    }

    // Calculate tensor breakdowns
    const buyerResult = calculateTensorBreakdown(
        config.buyer_model_features || [],
        config.buyer_model_crosses || []
    );
    const productResult = calculateTensorBreakdown(
        config.product_model_features || [],
        config.product_model_crosses || []
    );

    // Update tensor dimensions
    document.getElementById('wizardBuyerDim').textContent = `${buyerResult.total}D`;
    document.getElementById('wizardProductDim').textContent = `${productResult.total}D`;

    // Render feature lists
    const buyerFeaturesHtml = buyerResult.breakdown.map(item => `
        <div class="flex items-center justify-between text-sm">
            <span class="${item.is_cross ? 'text-blue-600 italic' : 'text-blue-700'}">${item.name}</span>
            <span class="text-blue-500 font-medium">${item.dim}D</span>
        </div>
    `).join('');
    document.getElementById('wizardBuyerFeatures').innerHTML = buyerFeaturesHtml || '<div class="text-sm text-gray-400">No features</div>';

    const productFeaturesHtml = productResult.breakdown.map(item => `
        <div class="flex items-center justify-between text-sm">
            <span class="${item.is_cross ? 'text-green-600 italic' : 'text-green-700'}">${item.name}</span>
            <span class="text-green-500 font-medium">${item.dim}D</span>
        </div>
    `).join('');
    document.getElementById('wizardProductFeatures').innerHTML = productFeaturesHtml || '<div class="text-sm text-gray-400">No features</div>';

    // Render tensor bars with proportional widths
    const maxTotal = Math.max(buyerResult.total || 0, productResult.total || 0);

    setTimeout(() => {
        const buyerBar = document.getElementById('wizardBuyerBar');
        const productBar = document.getElementById('wizardProductBar');
        if (buyerBar && buyerResult.breakdown.length > 0) {
            renderWizardTensorPreview('buyer', buyerResult.total, buyerResult.breakdown, buyerBar, maxTotal);
        }
        if (productBar && productResult.breakdown.length > 0) {
            renderWizardTensorPreview('product', productResult.total, productResult.breakdown, productBar, maxTotal);
        }
    }, 0);

    // Store estimated rows for example count calculation
    datasetEstimatedRows = config.dataset_info?.estimated_rows || null;
    // Store date days for split strategy calculations
    datasetDateDays = config.dataset_info?.date_days || null;
    updateExampleCount();
    updateHardwareRecommendation();
}

/**
 * Render target column info in Step 2 (Training Parameters) for ranking models.
 * This displays the target column defined in the Feature Config (read-only).
 */
function renderStep2TargetColumn(targetColumn) {
    if (!targetColumn) return;

    // Update column name and type
    document.getElementById('step2TargetColumnName').textContent = targetColumn.display_name || targetColumn.column || '-';
    document.getElementById('step2TargetColumnType').textContent = targetColumn.bq_type || 'FLOAT';

    // Build transforms tags (matching Step 1 styling but with purple theme)
    const transforms = targetColumn.transforms || {};
    let transformsHtml = '';

    if (transforms.clip_outliers) {
        const clipConfig = transforms.clip_outliers;
        const lower = clipConfig.lower?.enabled ? clipConfig.lower.percentile : null;
        const upper = clipConfig.upper?.enabled ? clipConfig.upper.percentile : null;
        if (lower && upper) {
            transformsHtml += `<span class="target-transform-tag" style="background: #f3e8ff; color: #7c3aed;"><i class="fas fa-cut"></i> Clip ${lower}%-${upper}%</span>`;
        } else if (upper) {
            transformsHtml += `<span class="target-transform-tag" style="background: #f3e8ff; color: #7c3aed;"><i class="fas fa-cut"></i> Clip upper ${upper}%</span>`;
        } else if (lower) {
            transformsHtml += `<span class="target-transform-tag" style="background: #f3e8ff; color: #7c3aed;"><i class="fas fa-cut"></i> Clip lower ${lower}%</span>`;
        }
    }

    if (transforms.log_transform?.enabled) {
        transformsHtml += '<span class="target-transform-tag" style="background: #f3e8ff; color: #7c3aed;"><i class="fas fa-chart-line"></i> Log transform</span>';
    }

    if (transforms.normalize?.enabled) {
        transformsHtml += '<span class="target-transform-tag" style="background: #f3e8ff; color: #7c3aed;"><i class="fas fa-compress-arrows-alt"></i> Normalize 0-1</span>';
    }

    document.getElementById('step2TargetTransforms').innerHTML = transformsHtml;
}

function updateExampleCount() {
    const samplePercent = parseInt(document.getElementById('wizardSamplePercentInput').value) || 100;
    const countEl = document.getElementById('wizardExampleCountValue');

    if (datasetEstimatedRows && datasetEstimatedRows > 0) {
        const estimatedExamples = Math.round(datasetEstimatedRows * samplePercent / 100);
        countEl.textContent = `~${estimatedExamples.toLocaleString()}`;
    } else {
        countEl.textContent = '--';
    }
}

function setSamplePercent(value) {
    // Update input
    document.getElementById('wizardSamplePercentInput').value = value;

    // Update button states
    document.querySelectorAll('.sample-btn').forEach(btn => {
        btn.classList.toggle('active', parseInt(btn.dataset.value) === value);
    });

    updateExampleCount();
    updateWizardSummary();
}

function onSampleInputChange() {
    let value = parseInt(document.getElementById('wizardSamplePercentInput').value) || 100;

    // Clamp to valid range
    value = Math.max(1, Math.min(100, value));
    document.getElementById('wizardSamplePercentInput').value = value;

    // Update button states (deactivate all if custom value)
    const presetValues = [5, 10, 25, 100];
    document.querySelectorAll('.sample-btn').forEach(btn => {
        btn.classList.toggle('active', parseInt(btn.dataset.value) === value && presetValues.includes(value));
    });

    updateExampleCount();
    updateWizardSummary();
}

// Training parameter button handlers
const paramInputMap = {
    epochs: 'wizardEpochs',
    batchSize: 'wizardBatchSize',
    learningRate: 'wizardLearningRate'
};

const paramPresets = {
    epochs: [5, 10, 25, 50, 100],
    batchSize: [1024, 2048, 4096, 8192],
    learningRate: [0.001, 0.01, 0.05, 0.1]
};

function setParam(param, value) {
    // Update input
    const inputId = paramInputMap[param];
    document.getElementById(inputId).value = value;

    // Update button states
    document.querySelectorAll(`.param-btn[data-param="${param}"]`).forEach(btn => {
        const btnValue = parseFloat(btn.dataset.value);
        btn.classList.toggle('active', btnValue === value);
    });

    // Update summary
    updateWizardSummary();
}

// Hardware selection functions
const hardwareTiers = {
    'e2-standard-4': { name: 'Small', vcpu: 4, ram: 16 },
    'e2-standard-8': { name: 'Medium', vcpu: 8, ram: 32 },
    'e2-standard-16': { name: 'Large', vcpu: 16, ram: 64 },
    'gpu-t4': { name: 'GPU T4', vcpu: 4, ram: 15, gpu: 'T4 16GB' },
};

function selectHardware(machineType) {
    if (machineType === 'gpu-t4') {
        // GPU T4: Dataflow workers use e2-standard-4, Trainer uses n1-standard-4 + T4
        document.getElementById('wizardMachineType').value = 'e2-standard-4';
        document.getElementById('wizardGpuConfig').value = JSON.stringify({
            gpu_type: 'NVIDIA_TESLA_T4',
            gpu_count: 1,
            machine_type: 'n1-standard-4'
        });
    } else {
        // CPU cards: use selected machine type, clear GPU config
        document.getElementById('wizardMachineType').value = machineType;
        document.getElementById('wizardGpuConfig').value = '';
    }

    // Update card selection states
    document.querySelectorAll('.hardware-card').forEach(card => {
        card.classList.toggle('selected', card.dataset.machine === machineType);
    });

    // Update summary
    updateWizardSummary();
}

function updateHardwareRecommendation() {
    // Get dataset row count and model params
    const rowCount = datasetEstimatedRows || 0;
    const modelParams = selectedModelConfig ? (
        (selectedModelConfig.buyer_tensor_dim || 0) + (selectedModelConfig.product_tensor_dim || 0)
    ) : 0;

    // Determine recommendation
    let recommended = 'e2-standard-4';
    let reason = 'dataset size';

    if (rowCount > 500000 || modelParams > 5000000) {
        recommended = 'e2-standard-16';
        reason = rowCount > 500000 ? 'large dataset (>500K rows)' : 'complex model (>5M params)';
    } else if (rowCount > 100000 || modelParams > 1000000) {
        recommended = 'e2-standard-8';
        reason = rowCount > 100000 ? 'medium dataset (>100K rows)' : 'model complexity';
    }

    // Update recommendation text
    const tier = hardwareTiers[recommended];
    document.getElementById('hardwareRecommendation').innerHTML =
        `Recommended: <strong>${tier.name}</strong> based on ${reason}`;

    // Update recommended badge on cards
    document.querySelectorAll('.hardware-card').forEach(card => {
        card.classList.toggle('recommended', card.dataset.machine === recommended);
    });

    // Auto-select if nothing selected yet or if this is initial load
    const currentSelection = document.getElementById('wizardMachineType').value;
    if (!currentSelection || currentSelection === 'e2-standard-4') {
        selectHardware(recommended);
    }
}

function onParamInputChange(param) {
    const inputId = paramInputMap[param];
    const input = document.getElementById(inputId);
    let value = parseFloat(input.value);

    // Handle NaN
    if (isNaN(value)) {
        value = param === 'learningRate' ? 0.01 : (param === 'epochs' ? 25 : 1024);
        input.value = value;
    }

    // Update button states (deactivate all if custom value)
    const presets = paramPresets[param];
    document.querySelectorAll(`.param-btn[data-param="${param}"]`).forEach(btn => {
        const btnValue = parseFloat(btn.dataset.value);
        btn.classList.toggle('active', btnValue === value && presets.includes(value));
    });

    updateWizardSummary();
}

function onWizardModelChange() {
    const mcId = parseInt(document.getElementById('wizardModelSelect').value);
    selectedModelConfig = allModelConfigs.find(mc => mc.id === mcId) || null;

    if (selectedModelConfig) {
        // Show preview panel with loading state
        document.getElementById('wizardModelEmpty').classList.add('hidden');
        document.getElementById('wizardModelPreview').classList.remove('hidden');
        document.getElementById('wizardModelLoading').classList.remove('hidden');
        document.getElementById('wizardModelContent').classList.add('hidden');

        // Fetch full model config details
        fetch(appendModelEndpointId(`/api/model-configs/${mcId}/`))
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    renderWizardModelPreview(data.data);
                }
            })
            .catch(err => {
                console.error('Error loading model config:', err);
            })
            .finally(() => {
                document.getElementById('wizardModelLoading').classList.add('hidden');
                document.getElementById('wizardModelContent').classList.remove('hidden');
            });

        // Update training params from model config and sync button states
        setParam('learningRate', selectedModelConfig.learning_rate);
        setParam('batchSize', selectedModelConfig.batch_size);
        // Epochs not in model config, keep default

        // Show rating column section for ranking models - display target from Feature Config
        if (selectedModelConfig.model_type === 'ranking' || selectedModelConfig.model_type === 'multitask') {
            document.getElementById('wizardRatingSection').classList.remove('hidden');
            if (selectedFeatureConfig && selectedFeatureConfig.target_column) {
                renderStep2TargetColumn(selectedFeatureConfig.target_column);
            }
        } else {
            document.getElementById('wizardRatingSection').classList.add('hidden');
        }
    } else {
        document.getElementById('wizardModelPreview').classList.add('hidden');
        document.getElementById('wizardModelEmpty').classList.remove('hidden');
    }

    updateWizardSummary();
    updateHardwareRecommendation();
}

function renderWizardModelPreview(mc) {
    // Tower stacks - use detailed visualization with aligned layers
    const buyerLayers = mc.buyer_tower_layers || [];
    const productLayers = mc.product_tower_layers || [];
    const towerHtml = renderCardTowerLayers(buyerLayers, productLayers);

    document.getElementById('wizardBuyerStack').innerHTML = towerHtml.buyer;
    document.getElementById('wizardProductStack').innerHTML = towerHtml.product;

    // Per-tower parameter summaries
    const buyerParams = calculateSingleTowerParams(buyerLayers);
    const productParams = calculateSingleTowerParams(productLayers);
    document.getElementById('wizardBuyerTotalParams').textContent = buyerParams.toLocaleString();
    document.getElementById('wizardBuyerTrainableParams').textContent = buyerParams.toLocaleString();
    document.getElementById('wizardProductTotalParams').textContent = productParams.toLocaleString();
    document.getElementById('wizardProductTrainableParams').textContent = productParams.toLocaleString();

    // Rating Head section (for ranking and multitask models)
    const ratingHeadSection = document.getElementById('wizardRatingHeadSection');
    if (['ranking', 'multitask'].includes(mc.model_type) && mc.rating_head_layers && mc.rating_head_layers.length > 0) {
        ratingHeadSection.classList.remove('hidden');

        // Render rating head layers
        const ratingHeadLayersHtml = renderWizardRatingHeadLayers(mc.rating_head_layers);
        document.getElementById('wizardRatingHeadLayers').innerHTML = ratingHeadLayersHtml;

        // Calculate and display summary (e.g., "12864321")
        const summary = mc.rating_head_layers
            .filter(l => l.type === 'dense')
            .map(l => l.units)
            .join('');
        document.getElementById('wizardRatingHeadSummary').textContent = summary || '-';

        // Calculate rating head params (input is output_embedding_dim * 2)
        const outputDim = mc.output_embedding_dim || 32;
        const ratingHeadParams = calculateRatingHeadParams(mc.rating_head_layers, outputDim * 2);
        document.getElementById('wizardRatingHeadParams').textContent = ratingHeadParams.toLocaleString();
    } else {
        ratingHeadSection.classList.add('hidden');
    }

    // Training parameters
    document.getElementById('wizardModelParams').innerHTML = `
        <div class="param-chip">
            <span class="param-chip-label">Optimizer:</span>
            <span class="param-chip-value">${mc.optimizer_display || mc.optimizer}</span>
        </div>
        <div class="param-chip">
            <span class="param-chip-label">Learning Rate:</span>
            <span class="param-chip-value">${mc.learning_rate}</span>
        </div>
        <div class="param-chip">
            <span class="param-chip-label">Batch Size:</span>
            <span class="param-chip-value">${mc.batch_size}</span>
        </div>
        ${mc.model_type === 'ranking' ? `
        <div class="param-chip">
            <span class="param-chip-label">Output:</span>
            <span class="param-chip-value">1D (scalar)</span>
        </div>
        ` : `
        <div class="param-chip">
            <span class="param-chip-label">Output Dim:</span>
            <span class="param-chip-value">${mc.output_embedding_dim || 32}D</span>
        </div>
        `}
    `;

    // Retrieval algorithm section (for retrieval and multitask models)
    const retrievalSection = document.getElementById('wizardRetrievalSection');
    if (['retrieval', 'multitask'].includes(mc.model_type)) {
        retrievalSection.classList.remove('hidden');
        document.getElementById('wizardRetrievalParams').innerHTML = `
            <div class="param-chip retrieval-algo">
                <span class="param-chip-label">Algorithm:</span>
                <span class="param-chip-value">${mc.retrieval_algorithm_display || 'Brute Force'}</span>
            </div>
            <div class="param-chip">
                <span class="param-chip-label">Top-K:</span>
                <span class="param-chip-value">${mc.top_k || 100}</span>
            </div>
            ${mc.retrieval_algorithm === 'scann' ? `
            <div class="param-chip">
                <span class="param-chip-label">Num Leaves:</span>
                <span class="param-chip-value">${mc.scann_num_leaves || 100}</span>
            </div>
            <div class="param-chip">
                <span class="param-chip-label">Leaves to Search:</span>
                <span class="param-chip-value">${mc.scann_leaves_to_search || 10}</span>
            </div>
            ` : ''}
        `;
    } else {
        retrievalSection.classList.add('hidden');
    }
}

function renderWizardRatingHeadLayers(layers) {
    /**
     * Render rating head layers for the wizard preview.
     * Uses same card-layer-item styling as tower layers.
     */
    if (!layers || layers.length === 0) {
        return '<div class="text-xs text-gray-400 italic p-2">No layers defined</div>';
    }

    return layers.map((layer, idx) => {
        const isOutput = idx === layers.length - 1 && layer.type === 'dense' && layer.units === 1;
        let badge = '';
        let params = '';

        if (layer.type === 'dense') {
            badge = '<span class="card-layer-badge dense">Dense</span>';
            params = `${layer.units} units`;
            if (layer.activation) params += `, ${layer.activation}`;
            if (layer.l2_reg) params += `, L2=${layer.l2_reg}`;
            else if (layer.l2_regularization) params += `, L2=${layer.l2_regularization}`;
        } else if (layer.type === 'dropout') {
            badge = '<span class="card-layer-badge dropout">Dropout</span>';
            params = `rate: ${layer.rate}`;
        } else if (layer.type === 'batch_norm') {
            badge = '<span class="card-layer-badge batch_norm">BatchNorm</span>';
            params = '';
        } else if (layer.type === 'layer_norm') {
            badge = '<span class="card-layer-badge layer_norm">LayerNorm</span>';
            params = layer.epsilon ? `: ${layer.epsilon}` : '';
        }

        return `
            <div class="card-layer-item${isOutput ? ' output-layer' : ''}">
                <span class="card-drag-handle"><i class="fas fa-grip-vertical"></i></span>
                ${badge}
                <span class="card-layer-params">${params}</span>
            </div>
        `;
    }).join('');
}

function calculateRatingHeadParams(layers, inputDim) {
    /**
     * Calculate total parameters for rating head layers.
     * Input dimension is output_embedding_dim * 2 (concatenated embeddings).
     */
    let prevDim = inputDim;
    let totalParams = 0;

    layers.forEach(layer => {
        if (layer.type === 'dense') {
            totalParams += prevDim * layer.units + layer.units; // weights + bias
            prevDim = layer.units;
        }
    });

    return totalParams;
}

function onWizardSplitChange() {
    const strategy = document.getElementById('wizardSplitStrategy').value;
    const isTimeBased = strategy === 'time_holdout' || strategy === 'strict_time';
    const isStrictTime = strategy === 'strict_time';
    const isTimeHoldout = strategy === 'time_holdout';
    const isRandom = strategy === 'random';

    // Random info - only for random
    document.getElementById('wizardRandomInfo').style.display = isRandom ? 'flex' : 'none';

    // Date column - required for both time-based strategies
    document.getElementById('wizardDateColumnSection').style.display = isTimeBased ? 'flex' : 'none';

    // Holdout days - only for time_holdout
    document.getElementById('wizardTimeOptions').style.display = isTimeHoldout ? 'flex' : 'none';

    // Rolling window - only for strict_time
    document.getElementById('wizardRollingWindowSection').style.display = isStrictTime ? 'block' : 'none';

    // Set dynamic defaults for strict temporal split based on dataset date range
    if (isStrictTime && datasetDateDays && datasetDateDays > 0) {
        // Split ratios: Train 80%, Validation 15%, Test 5%
        const trainDays = Math.max(1, Math.floor(datasetDateDays * 0.80));
        const valDays = Math.max(1, Math.floor(datasetDateDays * 0.15));
        const testDays = Math.max(1, datasetDateDays - trainDays - valDays);

        document.getElementById('wizardTrainDays').value = trainDays;
        document.getElementById('wizardValDays').value = valDays;
        document.getElementById('wizardTestDays').value = testDays;
    }

    updateWizardSummary();
}

async function loadWizardDateColumns(datasetId) {
    if (!datasetId) return;

    try {
        const response = await fetch(appendModelEndpointId(`/api/datasets/${datasetId}/date-columns/`));
        const data = await response.json();

        const select = document.getElementById('wizardDateColumn');
        select.innerHTML = '<option value="">Select date column...</option>';

        if (data.success && data.date_columns) {
            let primaryColumn = null;
            data.date_columns.forEach(col => {
                const option = document.createElement('option');
                option.value = col.name;
                // Use display_name (alias) if available, fallback to name
                const displayName = col.display_name || col.name;
                // Show (recommended) for primary date column from dataset config
                const label = col.primary
                    ? `${displayName} (${col.type}) - recommended`
                    : `${displayName} (${col.type})`;
                option.textContent = label;
                select.appendChild(option);

                // Track primary for auto-selection
                if (col.primary) {
                    primaryColumn = col.name;
                }
            });

            // Auto-select the primary date column if available
            if (primaryColumn) {
                select.value = primaryColumn;
            }
        }
    } catch (error) {
        console.error('Error loading date columns:', error);
    }
}

function updateWizardUI() {
    // Update step indicators
    document.getElementById('wizardCurrentStep').textContent = wizardStep;

    // Update progress pills - matches model_configs.html pattern
    document.getElementById('wizardProgress1').className = 'progress-step-pill ' +
        (wizardStep === 1 ? 'current' : 'completed');
    document.getElementById('wizardProgress2').className = 'progress-step-pill ' +
        (wizardStep === 2 ? 'current' : 'future');

    // Show/hide steps
    document.getElementById('wizardStep1').classList.toggle('active', wizardStep === 1);
    document.getElementById('wizardStep2').classList.toggle('active', wizardStep === 2);

    // Show/hide navigation buttons
    document.getElementById('wizardBackBtn').classList.toggle('hidden', wizardStep === 1);
    document.getElementById('wizardNextBtn').classList.toggle('hidden', wizardStep === 2);

    // Show/hide action buttons
    document.getElementById('wizardRunBtn').classList.toggle('hidden', wizardStep !== 2);

    // Scroll modal body to top when changing steps
    const modalBody = document.getElementById('wizardModalBody');
    if (modalBody) {
        modalBody.scrollTop = 0;
    }
}

function updateWizardSummary() {
    // Model type
    const modelTypeLabels = {
        'retrieval': 'Retrieval',
        'ranking': 'Ranking',
        'multitask': 'Multitask'
    };
    document.getElementById('wizardSummaryModelType').textContent =
        modelTypeLabels[selectedModelType] || 'Retrieval';

    // Config names
    document.getElementById('wizardSummaryFeature').textContent =
        selectedFeatureConfig ? selectedFeatureConfig.name : '-';
    document.getElementById('wizardSummaryModel').textContent =
        selectedModelConfig ? selectedModelConfig.name : '-';

    // Data settings
    const samplePercent = document.getElementById('wizardSamplePercentInput').value || '100';
    document.getElementById('wizardSummarySample').textContent = samplePercent + '%';

    // Split strategy
    const splitStrategy = document.getElementById('wizardSplitStrategy').value;
    const splitLabels = {
        'random': 'Random 80/15/5',
        'time_holdout': 'Time Holdout',
        'strict_time': 'Strict Temporal'
    };
    document.getElementById('wizardSummarySplit').textContent = splitLabels[splitStrategy] || splitStrategy;

    // Training parameters
    document.getElementById('wizardSummaryEpochs').textContent =
        document.getElementById('wizardEpochs').value || '25';
    document.getElementById('wizardSummaryBatch').textContent =
        document.getElementById('wizardBatchSize').value || '1024';
    document.getElementById('wizardSummaryLR').textContent =
        document.getElementById('wizardLearningRate').value || '0.01';

    // Hardware - check if GPU is selected
    const gpuConfigVal = document.getElementById('wizardGpuConfig').value;
    if (gpuConfigVal) {
        document.getElementById('wizardSummaryHardware').textContent = 'GPU T4';
    } else {
        const machineType = document.getElementById('wizardMachineType').value || 'e2-standard-4';
        const tier = hardwareTiers[machineType];
        document.getElementById('wizardSummaryHardware').textContent = tier ? tier.name : 'Small';
    }
}

function wizardNext() {
    if (wizardStep === 1) {
        // Validate step 1
        if (!selectedFeatureConfig) {
            showError('Please select a Feature Config');
            return;
        }
        if (!selectedModelConfig) {
            showError('Please select a Model Config');
            return;
        }

        wizardStep = 2;
        updateWizardUI();
    }
}

function wizardBack() {
    if (wizardStep === 2) {
        wizardStep = 1;
        updateWizardUI();
    }
}

async function submitExperiment() {
    // Validate
    if (!selectedFeatureConfig || !selectedModelConfig) {
        showError('Please select both Feature Config and Model Config');
        return;
    }

    const splitStrategy = document.getElementById('wizardSplitStrategy').value;
    const dateColumn = document.getElementById('wizardDateColumn').value;

    if ((splitStrategy === 'time_holdout' || splitStrategy === 'strict_time') && !dateColumn) {
        showError('Please select a date column for time-based split');
        return;
    }

    // Build payload
    const payload = {
        model_config_id: selectedModelConfig.id,
        split_strategy: splitStrategy,
        data_sample_percent: parseInt(document.getElementById('wizardSamplePercentInput').value) || 100,
        holdout_days: parseInt(document.getElementById('wizardHoldoutDays').value) || 1,
        date_column: dateColumn,
        epochs: parseInt(document.getElementById('wizardEpochs').value),
        batch_size: parseInt(document.getElementById('wizardBatchSize').value),
        learning_rate: parseFloat(document.getElementById('wizardLearningRate').value),
        // Rolling window parameters for strict_time
        train_days: parseInt(document.getElementById('wizardTrainDays').value) || 60,
        val_days: parseInt(document.getElementById('wizardValDays').value) || 7,
        test_days: parseInt(document.getElementById('wizardTestDays').value) || 7,
        // Hardware configuration
        machine_type: document.getElementById('wizardMachineType').value || 'e2-standard-4',
        gpu_config: document.getElementById('wizardGpuConfig').value
            ? JSON.parse(document.getElementById('wizardGpuConfig').value) : {},
        // Experiment metadata (optional)
        experiment_name: document.getElementById('wizardExpName').value.trim(),
        experiment_description: document.getElementById('wizardExpDescription').value.trim()
    };

    // Add rating column for ranking models (auto-populate from Feature Config's target column)
    if (selectedModelConfig.model_type === 'ranking' || selectedModelConfig.model_type === 'multitask') {
        const tc = selectedFeatureConfig?.target_column;
        payload.rating_column = tc?.display_name || tc?.column || '';
    }

    // Disable run button and show spinner
    const runBtn = document.getElementById('wizardRunBtn');
    runBtn.disabled = true;
    runBtn.querySelector('.btn-neu-inner').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

    try {
        const response = await fetch(appendModelEndpointId(`/api/feature-configs/${selectedFeatureConfig.id}/quick-test/`), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(payload)
        });

        const data = await response.json();

        if (data.success) {
            // Close wizard
            closeNewExpWizard();

            // Refresh experiments list
            await loadExperiments(1);

            // Show experiments list if it was hidden
            document.getElementById('expEmpty').classList.add('hidden');
            document.getElementById('expFilterBar').classList.remove('hidden');
            document.getElementById('expList').classList.remove('hidden');

            // Start polling
            startBackgroundPolling();
        } else {
            showError(data.error || 'Failed to submit experiment');
        }
    } catch (error) {
        console.error('Error submitting experiment:', error);
        showError('Failed to submit experiment: ' + error.message);
    } finally {
        runBtn.disabled = false;
        runBtn.querySelector('.btn-neu-inner').innerHTML = 'Run';
    }
}

// =============================================================================
// EXPERIMENT DETAILS & VIEW MODAL
// =============================================================================
// Now using the reusable ExpViewModal module

async function openExpDetails(expId) {
    // Delegate to the reusable ExpViewModal module
    ExpViewModal.open(expId);
}

// =============================================================================
// BACKGROUND POLLING
// =============================================================================
function startBackgroundPolling() {
    // Poll for running experiments every 30 seconds
    setInterval(async () => {
        const hasRunning = experiments.some(e => e.status === 'running' || e.status === 'submitting');
        if (hasRunning) {
            await loadExperiments(pagination.page);
        }
    }, 30000);
}

function updateExpCard(exp) {
    // Find and update the card in the DOM
    const card = document.querySelector(`[data-exp-id="${exp.id}"]`);
    if (card) {
        card.outerHTML = renderExpCard(exp);
    }
}

// View from experiment card
function viewExpFromCard(event, expId) {
    event.stopPropagation(); // Prevent card click
    openExpDetails(expId);
}

// Cancel from experiment card
function cancelExpFromCard(event, expId) {
    event.stopPropagation(); // Prevent card click

    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;

    showConfirmModal({
        title: 'Cancel Experiment',
        message: 'Are you sure you want to cancel this experiment?<br><span class="text-sm text-gray-500 mt-2 block">This will stop the Vertex AI pipeline.</span>',
        confirmText: 'Confirm',
        cancelText: 'Cancel',
        type: 'warning',
        confirmButtonClass: 'btn-neu-save',
        cancelButtonClass: 'btn-neu-cancel',
        onConfirm: async () => {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const response = await fetch(appendModelEndpointId(`/api/quick-tests/${expId}/cancel/`), {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                });

                const data = await response.json();

                if (data.success) {
                    await loadExperiments(pagination.page);
                    showSuccess('Experiment cancelled');
                } else {
                    showError(data.error || 'Failed to cancel experiment');
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                }
            } catch (error) {
                showError('Failed to cancel: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        }
    });
}

function deleteExpFromCard(event, expId) {
    event.stopPropagation(); // Prevent card click

    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;

    showConfirmModal({
        title: 'Delete Experiment',
        message: 'Are you sure you want to delete this experiment?<br><span class="text-sm text-gray-500 mt-2 block">This will permanently delete the experiment and its artifacts. This action cannot be undone.</span>',
        confirmText: 'Ok',
        cancelText: 'Cancel',
        type: 'danger',
        confirmButtonClass: 'btn-neu-save',
        cancelButtonClass: 'btn-neu-cancel',
        onConfirm: async () => {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const response = await fetch(appendModelEndpointId(`/api/quick-tests/${expId}/delete/`), {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                });

                const data = await response.json();

                if (data.success) {
                    await loadExperiments(pagination.page);
                } else {
                    showError(data.error || 'Failed to delete experiment');
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                }
            } catch (error) {
                showError('Failed to delete: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        }
    });
}

function rerunExpFromCard(event, expId) {
    event.stopPropagation(); // Prevent card click

    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;

    showConfirmModal({
        title: 'Re-run Experiment',
        message: 'Create a new experiment with the same configuration?',
        confirmText: 'Ok',
        cancelText: 'Cancel',
        type: 'info',
        confirmButtonClass: 'btn-neu-save',
        cancelButtonClass: 'btn-neu-cancel',
        onConfirm: async () => {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const response = await fetch(appendModelEndpointId(`/api/quick-tests/${expId}/rerun/`), {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess(data.message || 'Re-run created');
                    await loadExperiments(1); // Go to first page to see the new experiment
                    startBackgroundPolling();
                } else {
                    showError(data.error || 'Failed to re-run experiment');
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                }
            } catch (error) {
                showError('Failed to re-run: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        }
    });
}

// =============================================================================
// EXPERIMENT COMPARE MODAL (Accordion-style dropdown comparison)
// =============================================================================
let exp_compareLeftExp = null;
let exp_compareRightExp = null;
let exp_compareExpandedSections = {
    results: false,
    dataset: false,
    features: false,
    model: false,
    training: false,
    sampling: false
};
let exp_selectableExperiments = [];

// Open the compare modal
async function exp_openCompareModal() {
    const modal = document.getElementById('expCompareModal');
    const leftSelect = document.getElementById('expCompareLeftSelect');
    const rightSelect = document.getElementById('expCompareRightSelect');

    // Reset state
    exp_compareLeftExp = null;
    exp_compareRightExp = null;

    // Collapse all accordions
    Object.keys(exp_compareExpandedSections).forEach(k => {
        exp_compareExpandedSections[k] = false;
    });
    exp_syncCompareAccordionStates();

    // Reset dropdowns
    leftSelect.innerHTML = '<option value="">Select experiment...</option>';
    rightSelect.innerHTML = '<option value="">Select experiment...</option>';

    // Reset all columns to placeholder
    exp_resetCompareColumn('left');
    exp_resetCompareColumn('right');

    // Clear status badges
    exp_updateCompareStatuses();

    // Show modal
    modal.classList.remove('hidden');

    // Fetch selectable experiments
    try {
        const response = await fetch(appendModelEndpointId('/api/experiments/selectable/'));
        const data = await response.json();

        if (data.success) {
            exp_selectableExperiments = data.experiments || [];
            exp_populateDropdowns();
        } else {
            showError(data.error || 'Failed to load experiments');
        }
    } catch (error) {
        console.error('Error loading selectable experiments:', error);
        showError('Error loading experiments');
    }
}

// Close the compare modal
function exp_closeCompareModal(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('expCompareModal').classList.add('hidden');
    exp_compareLeftExp = null;
    exp_compareRightExp = null;
}

// Populate dropdowns with selectable experiments
function exp_populateDropdowns() {
    const leftSelect = document.getElementById('expCompareLeftSelect');
    const rightSelect = document.getElementById('expCompareRightSelect');

    // Clear and add default option
    leftSelect.innerHTML = '<option value="">Select experiment...</option>';
    rightSelect.innerHTML = '<option value="">Select experiment...</option>';

    // Add experiment options
    exp_selectableExperiments.forEach(exp => {
        const displayText = exp.experiment_name
            ? `${exp.display_name} - ${exp.experiment_name}`
            : exp.display_name;

        const leftOpt = document.createElement('option');
        leftOpt.value = exp.id;
        leftOpt.textContent = displayText;
        leftSelect.appendChild(leftOpt);

        const rightOpt = document.createElement('option');
        rightOpt.value = exp.id;
        rightOpt.textContent = displayText;
        rightSelect.appendChild(rightOpt);
    });
}

// Handle dropdown selection change
function exp_onCompareSelectChange(side) {
    const selectId = side === 'left' ? 'expCompareLeftSelect' : 'expCompareRightSelect';
    const expId = document.getElementById(selectId).value;

    if (!expId) {
        // Reset this side
        exp_resetCompareColumn(side);
        if (side === 'left') exp_compareLeftExp = null;
        else exp_compareRightExp = null;
        exp_updateCompareStatuses();
        return;
    }

    // Get both selected IDs
    const leftId = document.getElementById('expCompareLeftSelect').value;
    const rightId = document.getElementById('expCompareRightSelect').value;

    // Only fetch comparison data when both experiments are selected
    if (!leftId || !rightId) {
        // Show waiting state for the selected side
        const prefix = side === 'left' ? 'expCompareLeft' : 'expCompareRight';
        const waitingHtml = '<div class="ds-compare-placeholder">Select another experiment to compare</div>';
        document.getElementById(`${prefix}Results`).innerHTML = waitingHtml;
        document.getElementById(`${prefix}Dataset`).innerHTML = waitingHtml;
        document.getElementById(`${prefix}Features`).innerHTML = waitingHtml;
        document.getElementById(`${prefix}Model`).innerHTML = waitingHtml;
        document.getElementById(`${prefix}Training`).innerHTML = waitingHtml;
        document.getElementById(`${prefix}Sampling`).innerHTML = waitingHtml;
        return;
    }

    // Show loading state for both columns
    exp_showColumnLoading('left');
    exp_showColumnLoading('right');

    // Fetch comparison data for both experiments
    fetch(appendModelEndpointId('/api/experiments/compare/'), {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ quick_test_ids: [leftId, rightId].map(Number) })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            // Find and store the experiment data
            data.comparison.experiments.forEach(exp => {
                if (String(exp.id) === leftId) {
                    exp_compareLeftExp = exp;
                    exp_renderCompareColumn(exp, 'left');
                }
                if (String(exp.id) === rightId) {
                    exp_compareRightExp = exp;
                    exp_renderCompareColumn(exp, 'right');
                }
            });
            exp_updateCompareStatuses();
        } else {
            showError(data.error || 'Failed to load comparison data');
            exp_resetCompareColumn('left');
            exp_resetCompareColumn('right');
        }
    })
    .catch(err => {
        console.error('Error loading comparison:', err);
        showError('Error loading comparison data');
        exp_resetCompareColumn('left');
        exp_resetCompareColumn('right');
    });
}

// Toggle accordion section
function exp_toggleCompareSection(sectionName) {
    exp_compareExpandedSections[sectionName] = !exp_compareExpandedSections[sectionName];
    exp_syncCompareAccordionStates();
}

// Sync accordion visual states with tracked state
function exp_syncCompareAccordionStates() {
    const sections = ['results', 'dataset', 'features', 'model', 'training', 'sampling'];
    const sectionIdMap = {
        results: 'Results',
        dataset: 'Dataset',
        features: 'Features',
        model: 'Model',
        training: 'Training',
        sampling: 'Sampling'
    };

    sections.forEach(section => {
        const contentId = `expCompare${sectionIdMap[section]}Content`;
        const chevronId = `expCompare${sectionIdMap[section]}Chevron`;

        const content = document.getElementById(contentId);
        const chevron = document.getElementById(chevronId);

        if (content && chevron) {
            if (exp_compareExpandedSections[section]) {
                content.classList.remove('hidden');
                chevron.classList.add('expanded');
            } else {
                content.classList.add('hidden');
                chevron.classList.remove('expanded');
            }
        }
    });
}

// Reset a compare column to placeholder state
function exp_resetCompareColumn(side) {
    const prefix = side === 'left' ? 'expCompareLeft' : 'expCompareRight';
    const placeholder = '<div class="ds-compare-placeholder">Select an experiment</div>';

    document.getElementById(`${prefix}Results`).innerHTML = placeholder;
    document.getElementById(`${prefix}Dataset`).innerHTML = placeholder;
    document.getElementById(`${prefix}Features`).innerHTML = placeholder;
    document.getElementById(`${prefix}Model`).innerHTML = placeholder;
    document.getElementById(`${prefix}Training`).innerHTML = placeholder;
    document.getElementById(`${prefix}Sampling`).innerHTML = placeholder;
}

// Show loading state in a column
function exp_showColumnLoading(side) {
    const prefix = side === 'left' ? 'expCompareLeft' : 'expCompareRight';
    const loading = '<div class="ds-compare-placeholder"><i class="fas fa-spinner fa-spin mr-2"></i>Loading...</div>';

    document.getElementById(`${prefix}Results`).innerHTML = loading;
    document.getElementById(`${prefix}Dataset`).innerHTML = loading;
    document.getElementById(`${prefix}Features`).innerHTML = loading;
    document.getElementById(`${prefix}Model`).innerHTML = loading;
    document.getElementById(`${prefix}Training`).innerHTML = loading;
    document.getElementById(`${prefix}Sampling`).innerHTML = loading;
}

// Render an experiment's data into a column
function exp_renderCompareColumn(exp, side) {
    const prefix = side === 'left' ? 'expCompareLeft' : 'expCompareRight';

    document.getElementById(`${prefix}Results`).innerHTML = exp_renderResultsCell(exp);
    document.getElementById(`${prefix}Dataset`).innerHTML = exp_renderDatasetCell(exp);
    document.getElementById(`${prefix}Features`).innerHTML = exp_renderFeaturesCell(exp);
    document.getElementById(`${prefix}Model`).innerHTML = exp_renderModelCell(exp);
    document.getElementById(`${prefix}Training`).innerHTML = exp_renderTrainingCell(exp);
    document.getElementById(`${prefix}Sampling`).innerHTML = exp_renderSamplingCell(exp);
}

// Helper: Create a compare row
function exp_createCompareRow(label, value) {
    return `
        <div class="ds-compare-row">
            <span class="ds-compare-label">${label}</span>
            <span class="ds-compare-value">${value}</span>
        </div>
    `;
}

// Helper: Format metric value
function exp_formatMetric(value, decimals = 2) {
    if (value === null || value === undefined) return '';
    if (typeof value === 'number') {
        // If it's a recall value (0-1), convert to percentage
        if (value <= 1 && value >= 0) {
            return (value * 100).toFixed(decimals) + '%';
        }
        return value.toFixed(decimals);
    }
    return value;
}

// Helper: Format duration
function exp_formatDuration(seconds) {
    if (!seconds && seconds !== 0) return '';
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

// Helper: Create status badge
function exp_createStatusBadge(status) {
    const colors = {
        completed: 'background: #d1fae5; color: #065f46;',
        failed: 'background: #fee2e2; color: #991b1b;',
        running: 'background: #dbeafe; color: #1e40af;',
        cancelled: 'background: #e5e7eb; color: #6b7280;',
        pending: 'background: #fef3c7; color: #92400e;'
    };
    const style = colors[status] || colors.pending;
    return `<span style="display: inline-block; padding: 2px 8px; border-radius: 9999px; font-size: 11px; font-weight: 500; ${style}">${status}</span>`;
}

// Render Results & Metrics cell
function exp_renderResultsCell(exp) {
    if (!exp) {
        return '<div class="ds-compare-placeholder">No data available</div>';
    }

    const rows = [];
    const r = exp.results || {};

    // Header with experiment name
    let html = `<h4>${escapeHtml(exp.display_name)}</h4>`;
    if (exp.experiment_name) {
        html += `<div class="ds-compare-description">${escapeHtml(exp.experiment_name)}</div>`;
    }

    // Status
    rows.push(exp_createCompareRow('Status', exp_createStatusBadge(exp.status)));

    // Recall metrics
    if (r.recall_at_100 !== null && r.recall_at_100 !== undefined) {
        rows.push(exp_createCompareRow('Recall@100', exp_formatMetric(r.recall_at_100)));
    }
    if (r.recall_at_50 !== null && r.recall_at_50 !== undefined) {
        rows.push(exp_createCompareRow('Recall@50', exp_formatMetric(r.recall_at_50)));
    }
    if (r.recall_at_10 !== null && r.recall_at_10 !== undefined) {
        rows.push(exp_createCompareRow('Recall@10', exp_formatMetric(r.recall_at_10)));
    }

    // Loss
    if (r.loss !== null && r.loss !== undefined) {
        rows.push(exp_createCompareRow('Loss', typeof r.loss === 'number' ? r.loss.toFixed(2) : r.loss));
    }

    // Duration
    if (r.duration_seconds) {
        rows.push(exp_createCompareRow('Duration', exp_formatDuration(r.duration_seconds)));
    }

    return html + rows.join('');
}

// Render Dataset Configuration cell
function exp_renderDatasetCell(exp) {
    if (!exp || !exp.dataset) {
        return '<div class="ds-compare-placeholder">No dataset info</div>';
    }

    const d = exp.dataset;
    const rows = [];

    let html = `<h4>${escapeHtml(d.name || 'Dataset')}</h4>`;

    if (d.primary_table) {
        rows.push(exp_createCompareRow('Primary Table', escapeHtml(d.primary_table)));
    }
    if (d.row_count !== null && d.row_count !== undefined) {
        rows.push(exp_createCompareRow('Rows', d.row_count.toLocaleString()));
    }
    if (d.unique_users !== null && d.unique_users !== undefined) {
        rows.push(exp_createCompareRow('Unique Users', d.unique_users.toLocaleString()));
    }
    if (d.unique_products !== null && d.unique_products !== undefined) {
        rows.push(exp_createCompareRow('Unique Products', d.unique_products.toLocaleString()));
    }

    return html + (rows.length > 0 ? rows.join('') : '<div class="ds-compare-meta">No additional details</div>');
}

// Render Feature Configuration cell
function exp_renderFeaturesCell(exp) {
    if (!exp || !exp.feature_config) {
        return '<div class="ds-compare-placeholder">No feature config</div>';
    }

    const f = exp.feature_config;
    const rows = [];

    let html = `<h4>${escapeHtml(f.name || 'Feature Config')}</h4>`;

    if (f.version) {
        rows.push(exp_createCompareRow('Version', f.version));
    }

    // Buyer features
    const buyerFeatures = f.buyer_features || `${f.buyer_features_count || 0} features`;
    rows.push(exp_createCompareRow('Buyer Features', escapeHtml(String(buyerFeatures))));

    if (f.buyer_tensor_dim !== null && f.buyer_tensor_dim !== undefined) {
        rows.push(exp_createCompareRow('Buyer Tensor Dim', f.buyer_tensor_dim));
    }

    if (f.buyer_crosses) {
        rows.push(exp_createCompareRow('Buyer Crosses', escapeHtml(String(f.buyer_crosses))));
    }

    // Product features
    const productFeatures = f.product_features || `${f.product_features_count || 0} features`;
    rows.push(exp_createCompareRow('Product Features', escapeHtml(String(productFeatures))));

    if (f.product_tensor_dim !== null && f.product_tensor_dim !== undefined) {
        rows.push(exp_createCompareRow('Product Tensor Dim', f.product_tensor_dim));
    }

    if (f.product_crosses) {
        rows.push(exp_createCompareRow('Product Crosses', escapeHtml(String(f.product_crosses))));
    }

    return html + rows.join('');
}

// Render Model Configuration cell
function exp_renderModelCell(exp) {
    if (!exp || !exp.model_config) {
        return '<div class="ds-compare-placeholder">No model config</div>';
    }

    const m = exp.model_config;
    const rows = [];

    let html = `<h4>${escapeHtml(m.name || 'Model Config')}</h4>`;

    if (m.model_type) {
        rows.push(exp_createCompareRow('Model Type', m.model_type));
    }
    if (m.optimizer) {
        rows.push(exp_createCompareRow('Optimizer', m.optimizer));
    }

    // Output dimension
    const outputDim = m.model_type === 'ranking'
        ? '1D (scalar)'
        : `${m.output_embedding_dim || 32}D`;
    rows.push(exp_createCompareRow('Output Dim', outputDim));

    if (m.tower_layers) {
        rows.push(exp_createCompareRow('Tower Layers', escapeHtml(String(m.tower_layers))));
    }

    return html + rows.join('');
}

// Render Training Parameters cell
function exp_renderTrainingCell(exp) {
    if (!exp || !exp.training) {
        return '<div class="ds-compare-placeholder">No training params</div>';
    }

    const t = exp.training;
    const rows = [];

    let html = '<h4>Training Parameters</h4>';

    if (t.epochs !== null && t.epochs !== undefined) {
        rows.push(exp_createCompareRow('Epochs', t.epochs));
    }
    if (t.batch_size !== null && t.batch_size !== undefined) {
        rows.push(exp_createCompareRow('Batch Size', t.batch_size.toLocaleString()));
    }
    if (t.learning_rate !== null && t.learning_rate !== undefined) {
        const lr = typeof t.learning_rate === 'number' ? t.learning_rate.toExponential(2) : t.learning_rate;
        rows.push(exp_createCompareRow('Learning Rate', lr));
    }
    if (t.machine_type) {
        rows.push(exp_createCompareRow('Machine Type', t.machine_type));
    }
    if (t.gpu_config && t.gpu_config.gpu_type) {
        const gpuLabel = t.gpu_config.gpu_type.replace('NVIDIA_TESLA_', '') + ' x' + (t.gpu_config.gpu_count || 1);
        rows.push(exp_createCompareRow('GPU', gpuLabel));
    }

    return html + (rows.length > 0 ? rows.join('') : '<div class="ds-compare-meta">No training details</div>');
}

// Render Sampling Configuration cell
function exp_renderSamplingCell(exp) {
    if (!exp || !exp.sampling) {
        return '<div class="ds-compare-placeholder">No sampling config</div>';
    }

    const s = exp.sampling;
    const rows = [];

    let html = '<h4>Sampling Configuration</h4>';

    if (s.data_sample_percent !== null && s.data_sample_percent !== undefined) {
        rows.push(exp_createCompareRow('Sample %', s.data_sample_percent + '%'));
    }
    if (s.split_strategy) {
        rows.push(exp_createCompareRow('Split Strategy', s.split_strategy.replace(/_/g, ' ')));
    }
    if (s.holdout_days !== null && s.holdout_days !== undefined) {
        rows.push(exp_createCompareRow('Holdout Days', s.holdout_days));
    }
    if (s.date_column) {
        rows.push(exp_createCompareRow('Date Column', escapeHtml(s.date_column)));
    }

    return html + (rows.length > 0 ? rows.join('') : '<div class="ds-compare-meta">No sampling details</div>');
}

// Update status badges in accordion headers
function exp_updateCompareStatuses() {
    const left = exp_compareLeftExp;
    const right = exp_compareRightExp;

    // Results status
    const resultsStatus = document.getElementById('expCompareResultsStatus');
    if (left && right) {
        let diffs = 0;
        const lr = left.results || {};
        const rr = right.results || {};
        if (lr.recall_at_100 !== rr.recall_at_100) diffs++;
        if (lr.recall_at_50 !== rr.recall_at_50) diffs++;
        if (lr.recall_at_10 !== rr.recall_at_10) diffs++;
        if (lr.loss !== rr.loss) diffs++;
        if (left.status !== right.status) diffs++;
        resultsStatus.textContent = diffs > 0 ? `${diffs} diff${diffs > 1 ? 's' : ''}` : '';
    } else {
        resultsStatus.textContent = '';
    }

    // Dataset status
    const datasetStatus = document.getElementById('expCompareDatasetStatus');
    if (left && right && left.dataset && right.dataset) {
        const ld = left.dataset;
        const rd = right.dataset;
        let diffs = 0;
        if (ld.name !== rd.name) diffs++;
        if (ld.row_count !== rd.row_count) diffs++;
        if (ld.unique_users !== rd.unique_users) diffs++;
        if (ld.unique_products !== rd.unique_products) diffs++;
        datasetStatus.textContent = diffs > 0 ? `${diffs} diff${diffs > 1 ? 's' : ''}` : '';
    } else {
        datasetStatus.textContent = '';
    }

    // Features status
    const featuresStatus = document.getElementById('expCompareFeaturesStatus');
    if (left && right && left.feature_config && right.feature_config) {
        const lf = left.feature_config;
        const rf = right.feature_config;
        let diffs = 0;
        if (lf.name !== rf.name) diffs++;
        if (lf.buyer_tensor_dim !== rf.buyer_tensor_dim) diffs++;
        if (lf.product_tensor_dim !== rf.product_tensor_dim) diffs++;
        featuresStatus.textContent = diffs > 0 ? `${diffs} diff${diffs > 1 ? 's' : ''}` : '';
    } else {
        featuresStatus.textContent = '';
    }

    // Model status
    const modelStatus = document.getElementById('expCompareModelStatus');
    if (left && right && left.model_config && right.model_config) {
        const lm = left.model_config;
        const rm = right.model_config;
        let diffs = 0;
        if (lm.name !== rm.name) diffs++;
        if (lm.model_type !== rm.model_type) diffs++;
        if (lm.optimizer !== rm.optimizer) diffs++;
        if (lm.output_embedding_dim !== rm.output_embedding_dim) diffs++;
        modelStatus.textContent = diffs > 0 ? `${diffs} diff${diffs > 1 ? 's' : ''}` : '';
    } else {
        modelStatus.textContent = '';
    }

    // Training status
    const trainingStatus = document.getElementById('expCompareTrainingStatus');
    if (left && right && left.training && right.training) {
        const lt = left.training;
        const rt = right.training;
        let diffs = 0;
        if (lt.epochs !== rt.epochs) diffs++;
        if (lt.batch_size !== rt.batch_size) diffs++;
        if (lt.learning_rate !== rt.learning_rate) diffs++;
        if (lt.machine_type !== rt.machine_type) diffs++;
        if (JSON.stringify(lt.gpu_config || {}) !== JSON.stringify(rt.gpu_config || {})) diffs++;
        trainingStatus.textContent = diffs > 0 ? `${diffs} diff${diffs > 1 ? 's' : ''}` : '';
    } else {
        trainingStatus.textContent = '';
    }

    // Sampling status
    const samplingStatus = document.getElementById('expCompareSamplingStatus');
    if (left && right && left.sampling && right.sampling) {
        const ls = left.sampling;
        const rs = right.sampling;
        let diffs = 0;
        if (ls.data_sample_percent !== rs.data_sample_percent) diffs++;
        if (ls.split_strategy !== rs.split_strategy) diffs++;
        if (ls.holdout_days !== rs.holdout_days) diffs++;
        if (ls.date_column !== rs.date_column) diffs++;
        samplingStatus.textContent = diffs > 0 ? `${diffs} diff${diffs > 1 ? 's' : ''}` : '';
    } else {
        samplingStatus.textContent = '';
    }
}

// =============================================================================
// UTILITIES
// =============================================================================
function formatDuration(seconds) {
    if (!seconds && seconds !== 0) return '0:00';
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatTimeAgo(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'just now';
    if (diffMins < 60) return `${diffMins} min ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    return date.toLocaleDateString();
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showToast(type, title, message) {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;

    const icon = type === 'success' ? 'fa-check' : 'fa-exclamation-triangle';

    toast.innerHTML = `
        <div class="toast-icon">
            <i class="fas ${icon}"></i>
        </div>
        <div class="toast-content">
            <div class="toast-title">${title}</div>
            <div class="toast-message">${message}</div>
        </div>
        <button class="toast-close" onclick="closeToast(this)">
            <i class="fas fa-times"></i>
        </button>
    `;

    container.appendChild(toast);

    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (toast.parentNode) {
            toast.classList.add('hiding');
            setTimeout(() => toast.remove(), 200);
        }
    }, 5000);
}

function closeToast(btn) {
    const toast = btn.closest('.toast');
    toast.classList.add('hiding');
    setTimeout(() => toast.remove(), 200);
}

function showError(message) {
    showConfirmModal({
        title: 'Error',
        message: message,
        type: 'danger',
        confirmText: 'Close',
        hideCancel: true,
        onConfirm: () => {}
    });
}

function showSuccess(message) {
    showConfirmModal({
        title: 'Success',
        message: message,
        type: 'success',
        confirmText: 'Close',
        hideCancel: true,
        autoClose: 4000,
        onConfirm: () => {}
    });
}

// =============================================================================
// EXPERIMENTS DASHBOARD
// =============================================================================
let trendChart = null;
let datasetChart = null;

function formatDuration(minutes) {
    if (minutes === null || minutes === undefined) return '-';
    if (minutes < 60) {
        return Math.round(minutes) + 'm';
    } else {
        const hours = Math.floor(minutes / 60);
        const mins = Math.round(minutes % 60);
        return hours + 'h ' + mins + 'm';
    }
}

// =============================================================================
// DASHBOARD MODEL TYPE SELECTION
// =============================================================================

// State variable for selected model type (default: retrieval)
let selectedDashboardModelType = 'retrieval';

function selectDashboardModelType(modelType) {
    /**
     * Handle model type selection in the dashboard.
     * Updates visual selection and reloads chart/table/insights for the selected type.
     */
    if (selectedDashboardModelType === modelType) return;

    selectedDashboardModelType = modelType;

    // Update visual selection
    const sections = document.querySelectorAll('.dashboard-model-section');
    sections.forEach(section => section.classList.remove('selected'));

    const sectionId = {
        'retrieval': 'dashboardRetrievalSection',
        'ranking': 'dashboardRankingSection',
        'hybrid': 'dashboardHybridSection'
    }[modelType];

    const selectedSection = document.getElementById(sectionId);
    if (selectedSection) {
        selectedSection.classList.add('selected');
    }

    // Reload chart, table, hyperparameter insights, training heatmaps, and dataset comparison for the selected model type
    loadMetricsTrend(modelType);
    loadTopConfigurations(modelType);
    loadHyperparameterAnalysis(modelType);
    loadTrainingHeatmaps(modelType);
    loadDatasetComparison(modelType);
}

function renderModelTypeKPIs(stats) {
    /**
     * Render KPI sections for each model type (Retrieval, Ranking, Hybrid).
     * All sections are always visible - shows 0 for count and "-" for metrics when empty.
     */
    const formatRecall = (v) => v !== null && v !== undefined ? (v * 100).toFixed(1) + '%' : '-';
    const formatAccuracy = (v) => v !== null && v !== undefined ? v.toFixed(2) : '-';

    // Retrieval Section - always visible
    const retrieval = stats.retrieval || {};
    document.getElementById('dashboardRetrievalCount').textContent = retrieval.count || 0;
    document.getElementById('dashboardRetrievalR5').textContent = formatRecall(retrieval.best_r5);
    document.getElementById('dashboardRetrievalR10').textContent = formatRecall(retrieval.best_r10);
    document.getElementById('dashboardRetrievalR50').textContent = formatRecall(retrieval.best_r50);
    document.getElementById('dashboardRetrievalR100').textContent = formatRecall(retrieval.best_r100);

    // Ranking Section - always visible
    const ranking = stats.ranking || {};
    document.getElementById('dashboardRankingCount').textContent = ranking.count || 0;
    document.getElementById('dashboardRankingRMSE').textContent = formatAccuracy(ranking.best_rmse);
    document.getElementById('dashboardRankingTestRMSE').textContent = formatAccuracy(ranking.best_test_rmse);
    document.getElementById('dashboardRankingMAE').textContent = formatAccuracy(ranking.best_mae);
    document.getElementById('dashboardRankingTestMAE').textContent = formatAccuracy(ranking.best_test_mae);

    // Hybrid Section - always visible
    const hybrid = stats.hybrid || {};
    document.getElementById('dashboardHybridCount').textContent = hybrid.count || 0;
    document.getElementById('dashboardHybridR50').textContent = formatRecall(hybrid.best_r50);
    document.getElementById('dashboardHybridR100').textContent = formatRecall(hybrid.best_r100);
    document.getElementById('dashboardHybridRMSE').textContent = formatAccuracy(hybrid.best_rmse);
    document.getElementById('dashboardHybridTestRMSE').textContent = formatAccuracy(hybrid.best_test_rmse);
}

async function loadExperimentsDashboard() {
    const loadingEl = document.getElementById('dashboardLoading');
    const contentEl = document.getElementById('dashboardContent');
    const emptyEl = document.getElementById('dashboardEmpty');

    try {
        // Load dashboard stats first
        const statsResponse = await fetch(appendModelEndpointId('/api/experiments/dashboard-stats/'));
        const statsData = await statsResponse.json();

        if (!statsData.success) {
            console.warn('Dashboard stats error:', statsData.error);
            loadingEl.classList.add('hidden');
            emptyEl.classList.remove('hidden');
            return;
        }

        const stats = statsData.stats;

        // Check if we have any experiments
        if (stats.total === 0) {
            loadingEl.classList.add('hidden');
            emptyEl.classList.remove('hidden');
            return;
        }

        // Render Model Type KPI Sections
        renderModelTypeKPIs(stats);

        // Show content, hide loading
        loadingEl.classList.add('hidden');
        contentEl.classList.remove('hidden');

        // Load all dashboard sections in parallel
        await Promise.all([
            loadMetricsTrend(),
            loadTopConfigurations(),
            loadHyperparameterAnalysis(),
            loadTrainingHeatmaps(),
            loadDatasetComparison(),
            loadSuggestions()
        ]);

    } catch (error) {
        console.error('Failed to load dashboard:', error);
        loadingEl.classList.add('hidden');
        emptyEl.classList.remove('hidden');
    }
}

// =============================================================================
// TRAINING HEATMAPS (D3.js)
// =============================================================================

async function loadTrainingHeatmaps(modelType = null) {
    const epochContainer = document.getElementById('lossHeatmap');
    const metricsContainer = document.getElementById('recallHeatmap');
    const emptyEl = document.getElementById('trainingHeatmapsEmpty');
    const heatmapsContainer = document.querySelector('.training-heatmaps-container');

    // Update section header, titles, and gradients based on model type
    const activeModelType = modelType || selectedDashboardModelType;
    const sectionHeader = document.querySelector('.dashboard-section:has(.training-heatmaps-container) .dashboard-section-header');
    const epochTitle = document.getElementById('epochHeatmapTitle');
    const metricsTitle = document.getElementById('metricsHeatmapTitle');
    const metricsGradient = document.getElementById('metricsGradient');

    if (activeModelType === 'ranking') {
        if (sectionHeader) {
            sectionHeader.querySelector('.text-xs').textContent = 'Top 10 experiments by Test RMSE (lowest)';
        }
        // Use "Validation Loss" for both - this is MSE for ranking models
        if (epochTitle) epochTitle.textContent = 'Validation Loss by Epoch';
        if (metricsTitle) metricsTitle.textContent = 'Final Ranking Metrics';
        // For ranking, both heatmaps use loss-gradient (green to red, lower is better)
        if (metricsGradient) {
            metricsGradient.classList.remove('recall-gradient');
            metricsGradient.classList.add('loss-gradient');
        }
    } else if (activeModelType === 'hybrid') {
        if (sectionHeader) {
            sectionHeader.querySelector('.text-xs').textContent = 'Top 10 experiments by R@100 (highest)';
        }
        if (epochTitle) epochTitle.textContent = 'Validation Loss by Epoch';
        if (metricsTitle) metricsTitle.textContent = 'Final Metrics (Retrieval + Ranking)';
        // For hybrid, use recall-gradient for the metrics (higher recall = better)
        if (metricsGradient) {
            metricsGradient.classList.remove('loss-gradient');
            metricsGradient.classList.add('recall-gradient');
        }
    } else {
        if (sectionHeader) {
            sectionHeader.querySelector('.text-xs').textContent = 'Top 10 experiments by Recall@100';
        }
        if (epochTitle) epochTitle.textContent = 'Validation Loss by Epoch';
        if (metricsTitle) metricsTitle.textContent = 'Final Recall Metrics';
        // For retrieval, metrics heatmap uses recall-gradient (red to green, higher is better)
        if (metricsGradient) {
            metricsGradient.classList.remove('loss-gradient');
            metricsGradient.classList.add('recall-gradient');
        }
    }

    try {
        const response = await fetch(appendModelEndpointId(`/api/experiments/training-heatmaps/?model_type=${activeModelType}`));
        const data = await response.json();

        if (!data.success || !data.experiments || data.experiments.length === 0) {
            heatmapsContainer.style.display = 'none';
            emptyEl.classList.remove('hidden');
            return;
        }

        // Check if we have data for each heatmap
        const hasEpochData = data.experiments.some(exp => exp.epoch_values && exp.epoch_values.length > 0);
        const hasMetricsData = data.experiments.some(exp =>
            exp.final_metrics && Object.values(exp.final_metrics).some(v => v !== null && v > 0)
        );

        // If neither heatmap has data, show empty state
        if (!hasEpochData && !hasMetricsData) {
            heatmapsContainer.style.display = 'none';
            emptyEl.classList.remove('hidden');
            return;
        }

        heatmapsContainer.style.display = 'flex';
        emptyEl.classList.add('hidden');

        // Render epoch heatmap (Validation Loss for both model types)
        if (hasEpochData) {
            renderEpochHeatmapD3(epochContainer, data, activeModelType);
        } else {
            epochContainer.innerHTML = `<div class="text-center text-gray-400 py-8"><i class="fas fa-clock mr-2"></i>No loss history cached yet</div>`;
        }

        // Render final metrics heatmap
        if (hasMetricsData) {
            renderFinalMetricsHeatmapD3(metricsContainer, data, activeModelType);
        } else {
            const metricLabel = activeModelType === 'ranking' ? 'ranking' : 'recall';
            metricsContainer.innerHTML = `<div class="text-center text-gray-400 py-8"><i class="fas fa-chart-bar mr-2"></i>No ${metricLabel} metrics available</div>`;
        }

    } catch (error) {
        console.error('Failed to load training heatmaps:', error);
        heatmapsContainer.style.display = 'none';
        emptyEl.classList.remove('hidden');
    }
}

function renderEpochHeatmapD3(container, data, modelType) {
    // Clear previous content
    d3.select(container).selectAll('*').remove();

    const experiments = data.experiments;
    if (!experiments.length) return;

    // Get all unique epochs across experiments
    const allEpochs = [...new Set(experiments.flatMap(exp => exp.epochs))].sort((a, b) => a - b);
    const valueRange = data.epoch_range || data.loss_range;

    // Dimensions - responsive to container width
    const margin = { top: 5, right: 10, bottom: 30, left: 70 };
    const cellHeight = 24;
    const containerWidth = container.getBoundingClientRect().width || 500;
    const width = Math.max(containerWidth, margin.left + allEpochs.length * 40 + margin.right);
    const height = margin.top + experiments.length * cellHeight + margin.bottom;

    // Create SVG
    const svg = d3.select(container)
        .append('svg')
        .attr('width', width)
        .attr('height', height);

    // Color scale: Green (low/good) -> Yellow -> Red (high/bad)
    // For both loss and RMSE, lower is better
    const colorScale = d3.scaleSequential()
        .domain([valueRange.min, valueRange.max])
        .interpolator(t => d3.interpolateRgb('#10b981', '#ef4444')(t));

    // X axis (epochs)
    const xScale = d3.scaleBand()
        .domain(allEpochs)
        .range([margin.left, width - margin.right])
        .padding(0.05);

    // Y axis (experiments)
    const yScale = d3.scaleBand()
        .domain(experiments.map(e => e.label))
        .range([margin.top, height - margin.bottom])
        .padding(0.05);

    // Draw cells
    experiments.forEach(exp => {
        const values = exp.epoch_values || exp.val_loss || [];
        allEpochs.forEach((epoch, epochIdx) => {
            const valIdx = exp.epochs.indexOf(epoch);
            const val = valIdx >= 0 ? values[valIdx] : null;

            const cell = svg.append('g');

            cell.append('rect')
                .attr('x', xScale(epoch))
                .attr('y', yScale(exp.label))
                .attr('width', xScale.bandwidth())
                .attr('height', yScale.bandwidth())
                .attr('fill', val !== null ? colorScale(val) : '#e5e7eb')
                .attr('rx', 2);

            if (val !== null) {
                // Format: 2 decimals for ranking (small MSE values), integers for retrieval (validation loss)
                const displayVal = modelType === 'ranking' ? val.toFixed(2) : val;
                cell.append('text')
                    .attr('x', xScale(epoch) + xScale.bandwidth() / 2)
                    .attr('y', yScale(exp.label) + yScale.bandwidth() / 2)
                    .attr('text-anchor', 'middle')
                    .attr('dominant-baseline', 'middle')
                    .attr('font-size', modelType === 'ranking' ? '9px' : '10px')
                    .attr('font-weight', '500')
                    .attr('fill', val > (valueRange.max + valueRange.min) / 2 ? '#fff' : '#1f2937')
                    .text(displayVal);
            }
        });
    });

    // X axis labels
    svg.append('g')
        .attr('transform', `translate(0, ${height - margin.bottom + 5})`)
        .selectAll('text')
        .data(allEpochs)
        .enter()
        .append('text')
        .attr('x', d => xScale(d) + xScale.bandwidth() / 2)
        .attr('y', 12)
        .attr('text-anchor', 'middle')
        .attr('font-size', '10px')
        .attr('fill', '#6b7280')
        .text(d => d);

    // X axis title
    svg.append('text')
        .attr('x', (width + margin.left - margin.right) / 2)
        .attr('y', height - 2)
        .attr('text-anchor', 'middle')
        .attr('font-size', '11px')
        .attr('fill', '#374151')
        .attr('font-weight', '500')
        .text('Epoch');

    // Y axis labels
    svg.append('g')
        .selectAll('text')
        .data(experiments)
        .enter()
        .append('text')
        .attr('x', margin.left - 5)
        .attr('y', d => yScale(d.label) + yScale.bandwidth() / 2)
        .attr('text-anchor', 'end')
        .attr('dominant-baseline', 'middle')
        .attr('font-size', '11px')
        .attr('fill', '#374151')
        .text(d => d.label);
}

function renderLossHeatmapD3(container, data) {
    // Legacy function - delegate to new unified function
    renderEpochHeatmapD3(container, data, 'retrieval');
}

function renderFinalMetricsHeatmapD3(container, data, modelType) {
    // Clear previous content
    d3.select(container).selectAll('*').remove();

    const experiments = data.experiments;
    if (!experiments.length) return;

    // Metrics differ by model type
    let metrics;
    if (modelType === 'ranking') {
        metrics = ['RMSE', 'Test RMSE', 'MAE', 'Test MAE'];
    } else if (modelType === 'hybrid') {
        // Hybrid: show both retrieval and ranking metrics
        metrics = ['R@5', 'R@10', 'R@50', 'R@100', 'RMSE', 'Test RMSE', 'MAE', 'Test MAE'];
    } else {
        metrics = ['R@5', 'R@10', 'R@50', 'R@100'];
    }

    // For hybrid, need to know which metrics are "lower is better"
    const lowerIsBetterMetrics = ['RMSE', 'Test RMSE', 'MAE', 'Test MAE'];

    // Calculate min/max per column for per-column normalization
    // This ensures RMSE and MAE are colored relative to their own ranges
    const columnRanges = {};
    metrics.forEach(metric => {
        const values = experiments
            .map(exp => (exp.final_metrics || exp.final_recalls || {})[metric])
            .filter(v => v !== null && v !== undefined && v > 0);
        if (values.length > 0) {
            columnRanges[metric] = {
                min: Math.min(...values),
                max: Math.max(...values)
            };
        } else {
            columnRanges[metric] = { min: 0, max: 1 };
        }
    });

    // Dimensions - responsive to container width
    const margin = { top: 5, right: 10, bottom: 30, left: 70 };
    const cellHeight = 24;
    const containerWidth = container.getBoundingClientRect().width || 300;
    // Wider cells for ranking metrics (longer labels), narrower for hybrid (more metrics)
    let cellWidth;
    if (modelType === 'hybrid') {
        cellWidth = 50;  // Narrower to fit 8 metrics
    } else if (modelType === 'ranking') {
        cellWidth = 60;
    } else {
        cellWidth = 45;
    }
    const width = Math.max(containerWidth, margin.left + metrics.length * cellWidth + margin.right);
    const height = margin.top + experiments.length * cellHeight + margin.bottom;

    // Create SVG
    const svg = d3.select(container)
        .append('svg')
        .attr('width', width)
        .attr('height', height);

    // Create color scale function per column
    // - Retrieval (recall): Red (low) -> Green (high) - higher is better
    // - Ranking (RMSE/MAE): Green (low) -> Red (high) - lower is better
    // - Hybrid: use metric type to determine direction
    const getColorScale = (metric) => {
        const range = columnRanges[metric];
        const isLowerBetter = modelType === 'ranking' || (modelType === 'hybrid' && lowerIsBetterMetrics.includes(metric));
        return d3.scaleSequential()
            .domain([range.min, range.max])
            .interpolator(isLowerBetter
                ? (t => d3.interpolateRgb('#10b981', '#ef4444')(t))  // Green to Red (lower is better)
                : (t => d3.interpolateRgb('#ef4444', '#10b981')(t))  // Red to Green (higher is better)
            );
    };

    // X axis (metrics)
    const xScale = d3.scaleBand()
        .domain(metrics)
        .range([margin.left, width - margin.right])
        .padding(0.05);

    // Y axis (experiments)
    const yScale = d3.scaleBand()
        .domain(experiments.map(e => e.label))
        .range([margin.top, height - margin.bottom])
        .padding(0.05);

    // Draw cells
    experiments.forEach(exp => {
        const metricsData = exp.final_metrics || exp.final_recalls || {};
        metrics.forEach(metric => {
            const val = metricsData[metric];
            const colorScale = getColorScale(metric);
            const range = columnRanges[metric];

            const cell = svg.append('g');

            cell.append('rect')
                .attr('x', xScale(metric))
                .attr('y', yScale(exp.label))
                .attr('width', xScale.bandwidth())
                .attr('height', yScale.bandwidth())
                .attr('fill', val !== null && val > 0 ? colorScale(val) : '#e5e7eb')
                .attr('rx', 2);

            if (val !== null) {
                // Format value based on metric type
                const isLowerBetter = modelType === 'ranking' || (modelType === 'hybrid' && lowerIsBetterMetrics.includes(metric));
                let displayVal;
                if (isLowerBetter) {
                    displayVal = val.toFixed(2);
                } else {
                    displayVal = val + '%';
                }

                // Determine text color based on metric direction and value (per-column midpoint)
                const midpoint = (range.max + range.min) / 2;
                let textColor;
                if (isLowerBetter) {
                    // Lower values are green (good), higher are red
                    textColor = val < midpoint ? '#1f2937' : '#fff';
                } else {
                    // Higher values are green (good)
                    textColor = val > midpoint ? '#fff' : '#1f2937';
                }

                // Use smaller font for hybrid and ranking (more metrics to display)
                const fontSize = modelType === 'hybrid' ? '7px' : (modelType === 'ranking' ? '8px' : '10px');

                cell.append('text')
                    .attr('x', xScale(metric) + xScale.bandwidth() / 2)
                    .attr('y', yScale(exp.label) + yScale.bandwidth() / 2)
                    .attr('text-anchor', 'middle')
                    .attr('dominant-baseline', 'middle')
                    .attr('font-size', fontSize)
                    .attr('font-weight', '500')
                    .attr('fill', textColor)
                    .text(displayVal);
            }
        });
    });

    // X axis labels
    const labelFontSize = modelType === 'hybrid' ? '7px' : (modelType === 'ranking' ? '8px' : '10px');
    svg.append('g')
        .attr('transform', `translate(0, ${height - margin.bottom + 5})`)
        .selectAll('text')
        .data(metrics)
        .enter()
        .append('text')
        .attr('x', d => xScale(d) + xScale.bandwidth() / 2)
        .attr('y', 12)
        .attr('text-anchor', 'middle')
        .attr('font-size', labelFontSize)
        .attr('fill', '#6b7280')
        .text(d => d);

    // Y axis labels
    svg.append('g')
        .selectAll('text')
        .data(experiments)
        .enter()
        .append('text')
        .attr('x', margin.left - 5)
        .attr('y', d => yScale(d.label) + yScale.bandwidth() / 2)
        .attr('text-anchor', 'end')
        .attr('dominant-baseline', 'middle')
        .attr('font-size', '11px')
        .attr('fill', '#374151')
        .text(d => d.label);
}

function renderRecallHeatmapD3(container, data) {
    // Legacy function - delegate to new unified function
    renderFinalMetricsHeatmapD3(container, data, 'retrieval');
}

// =============================================================================
// NEW DASHBOARD SECTIONS
// =============================================================================

async function loadMetricsTrend(modelType = null) {
    const canvas = document.getElementById('trendChartCanvas');
    const emptyEl = document.getElementById('trendChartEmpty');
    const headerTitle = document.querySelector('.dashboard-trend-panel .dashboard-section-title');
    const headerSubtitle = document.querySelector('.dashboard-trend-panel .text-xs');

    // Use provided modelType or fall back to selected state
    const activeModelType = modelType || selectedDashboardModelType;

    // Update header based on model type
    const headerConfig = {
        'retrieval': { title: 'Metrics Trend', subtitle: 'Best Recall metrics over time' },
        'ranking': { title: 'Metrics Trend', subtitle: 'Best RMSE/MAE metrics over time (lower is better)' },
        'hybrid': { title: 'Metrics Trend', subtitle: 'Hybrid model metrics over time' }
    };
    const config = headerConfig[activeModelType] || headerConfig['retrieval'];
    if (headerTitle) headerTitle.textContent = config.title;
    if (headerSubtitle) headerSubtitle.textContent = config.subtitle;

    // Destroy existing chart
    if (trendChart) {
        trendChart.destroy();
        trendChart = null;
    }

    try {
        const response = await fetch(appendModelEndpointId(`/api/experiments/metrics-trend/?model_type=${activeModelType}`));
        const data = await response.json();

        if (!data.success || !data.trend || data.trend.length < 2) {
            canvas.style.display = 'none';
            emptyEl.innerHTML = '<i class="fas fa-chart-line"></i><p>Not enough data for trend analysis</p>';
            emptyEl.classList.remove('hidden');
            return;
        }

        canvas.style.display = 'block';
        emptyEl.classList.add('hidden');

        const ctx = canvas.getContext('2d');

        // Build datasets based on model type
        let datasets;
        let chartOptions;
        if (activeModelType === 'ranking') {
            // Ranking: RMSE, Test RMSE, MAE, Test MAE (lower is better)
            // Use area fill with origin for visual consistency with retrieval
            datasets = [
                {
                    label: 'Best RMSE',
                    data: data.trend.map(d => d.best_rmse),
                    borderColor: '#f59e0b',
                    backgroundColor: 'rgba(245, 158, 11, 0.25)',
                    fill: 'origin',
                    tension: 0.3,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    borderWidth: 2
                },
                {
                    label: 'Best Test RMSE',
                    data: data.trend.map(d => d.best_test_rmse),
                    borderColor: '#d97706',
                    backgroundColor: 'rgba(217, 119, 6, 0.2)',
                    fill: 'origin',
                    tension: 0.3,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    borderWidth: 2
                },
                {
                    label: 'Best MAE',
                    data: data.trend.map(d => d.best_mae),
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.25)',
                    fill: 'origin',
                    tension: 0.3,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    borderWidth: 2
                },
                {
                    label: 'Best Test MAE',
                    data: data.trend.map(d => d.best_test_mae),
                    borderColor: '#059669',
                    backgroundColor: 'rgba(5, 150, 105, 0.2)',
                    fill: 'origin',
                    tension: 0.3,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    borderWidth: 2
                }
            ];
        } else if (activeModelType === 'retrieval') {
            // Retrieval: R@5, R@10, R@50, R@100 (higher is better)
            // Cascade area chart: each metric fills down to the next one
            datasets = [
                {
                    label: 'Best R@100',
                    data: data.trend.map(d => d.best_r100),
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.4)',
                    fill: '+1',  // Fill down to R@50
                    tension: 0.3,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    borderWidth: 2
                },
                {
                    label: 'Best R@50',
                    data: data.trend.map(d => d.best_r50),
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.4)',
                    fill: '+1',  // Fill down to R@10
                    tension: 0.3,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    borderWidth: 2
                },
                {
                    label: 'Best R@10',
                    data: data.trend.map(d => d.best_r10),
                    borderColor: '#f59e0b',
                    backgroundColor: 'rgba(245, 158, 11, 0.4)',
                    fill: '+1',  // Fill down to R@5
                    tension: 0.3,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    borderWidth: 2
                },
                {
                    label: 'Best R@5',
                    data: data.trend.map(d => d.best_r5),
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.4)',
                    fill: 'origin',  // Fill down to X-axis
                    tension: 0.3,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    borderWidth: 2
                }
            ];
        } else {
            // Hybrid: Dual Y-axis - Recall metrics (left) and RMSE/MAE metrics (right)
            datasets = [
                // Retrieval metrics (left Y-axis) - cascading area fills
                {
                    label: 'R@100',
                    data: data.trend.map(d => d.best_r100),
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.35)',
                    fill: '+1',
                    tension: 0.3,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    borderWidth: 2,
                    yAxisID: 'y'
                },
                {
                    label: 'R@50',
                    data: data.trend.map(d => d.best_r50),
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.35)',
                    fill: '+1',
                    tension: 0.3,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    borderWidth: 2,
                    yAxisID: 'y'
                },
                {
                    label: 'R@10',
                    data: data.trend.map(d => d.best_r10),
                    borderColor: '#8b5cf6',
                    backgroundColor: 'rgba(139, 92, 246, 0.35)',
                    fill: 'origin',
                    tension: 0.3,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    borderWidth: 2,
                    yAxisID: 'y'
                },
                // Ranking metrics (right Y-axis) - area fills
                {
                    label: 'RMSE',
                    data: data.trend.map(d => d.best_rmse),
                    borderColor: '#f59e0b',
                    backgroundColor: 'rgba(245, 158, 11, 0.2)',
                    fill: 'origin',
                    tension: 0.3,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    borderWidth: 2,
                    borderDash: [5, 5],
                    yAxisID: 'y1'
                },
                {
                    label: 'Test RMSE',
                    data: data.trend.map(d => d.best_test_rmse),
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.15)',
                    fill: 'origin',
                    tension: 0.3,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    borderWidth: 2,
                    borderDash: [5, 5],
                    yAxisID: 'y1'
                }
            ];
        }

        // Build chart options based on model type
        const baseOptions = {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                padding: { right: 10 }
            },
            plugins: {
                legend: {
                    position: 'top',
                    align: 'end',
                    labels: { boxWidth: 12, font: { size: 11 } }
                },
                tooltip: {
                    callbacks: {
                        label: (context) => {
                            const label = context.dataset.label || '';
                            const val = context.parsed.y;
                            if (val == null) return label;
                            const isRecall = activeModelType === 'retrieval' ||
                                (activeModelType === 'hybrid' && context.dataset.yAxisID !== 'y1');
                            const formatted = isRecall ? (val * 100).toFixed(1) + '%' : val.toFixed(2);
                            return `${label}: ${formatted}`;
                        },
                        afterLabel: (context) => {
                            const idx = context.dataIndex;
                            return `Experiments: ${data.trend[idx].experiment_count}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: { display: false },
                    ticks: { font: { size: 10 }, maxTicksLimit: 10 }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    beginAtZero: false,
                    grid: { color: 'rgba(0,0,0,0.05)' },
                    ticks: {
                        font: { size: 10 },
                        callback: (value) => activeModelType === 'ranking'
                            ? value.toFixed(2)
                            : (value * 100).toFixed(0) + '%'
                    },
                    title: activeModelType === 'hybrid' ? {
                        display: true,
                        text: 'Recall',
                        font: { size: 10 }
                    } : undefined
                }
            }
        };

        // Add right Y-axis for hybrid models
        if (activeModelType === 'hybrid') {
            baseOptions.scales.y1 = {
                type: 'linear',
                display: true,
                position: 'right',
                beginAtZero: false,
                grid: { drawOnChartArea: false },
                ticks: {
                    font: { size: 10 },
                    callback: (value) => value.toFixed(2)
                },
                title: {
                    display: true,
                    text: 'RMSE',
                    font: { size: 10 }
                }
            };
        }

        trendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.trend.map(d => d.date),
                datasets: datasets
            },
            options: baseOptions
        });

    } catch (error) {
        console.error('Failed to load metrics trend:', error);
        canvas.style.display = 'none';
        emptyEl.innerHTML = '<i class="fas fa-chart-line"></i><p>Not enough data for trend analysis</p>';
        emptyEl.classList.remove('hidden');
    }
}

async function loadTopConfigurations(modelType = null) {
    const thead = document.getElementById('topConfigsHead');
    const tbody = document.getElementById('topConfigsBody');
    const titleEl = document.getElementById('topConfigsTitle');
    const subtitleEl = document.getElementById('topConfigsSubtitle');

    // Use provided modelType or fall back to selected state
    const activeModelType = modelType || selectedDashboardModelType;

    // Update header based on model type
    const headerConfig = {
        'retrieval': {
            title: 'Top Configurations',
            subtitle: 'Best performing retrieval experiments (by R@100)'
        },
        'ranking': {
            title: 'Top Configurations',
            subtitle: 'Best performing ranking experiments (by Test RMSE, lower is better)'
        },
        'hybrid': {
            title: 'Top Configurations',
            subtitle: 'Best performing hybrid experiments'
        }
    };
    const config = headerConfig[activeModelType] || headerConfig['retrieval'];
    if (titleEl) titleEl.textContent = config.title;
    if (subtitleEl) subtitleEl.textContent = config.subtitle;

    // Update table header based on model type
    if (activeModelType === 'ranking') {
        thead.innerHTML = `
            <tr>
                <th style="width: 40px;">#</th>
                <th style="text-align: center;">Experiment</th>
                <th>Dataset</th>
                <th>Feature</th>
                <th>Model</th>
                <th style="text-align: center;">LR</th>
                <th style="text-align: center;">Batch</th>
                <th style="text-align: center;">Epochs</th>
                <th style="text-align: center;">Test RMSE</th>
                <th style="text-align: center;">Test MAE</th>
            </tr>
        `;
    } else if (activeModelType === 'hybrid') {
        thead.innerHTML = `
            <tr>
                <th style="width: 40px;">#</th>
                <th style="text-align: center;">Experiment</th>
                <th>Dataset</th>
                <th>Feature</th>
                <th>Model</th>
                <th style="text-align: center;">LR</th>
                <th style="text-align: center;">R@100</th>
                <th style="text-align: center;">R@50</th>
                <th style="text-align: center;">Test RMSE</th>
                <th style="text-align: center;">Test MAE</th>
            </tr>
        `;
    } else {
        thead.innerHTML = `
            <tr>
                <th style="width: 40px;">#</th>
                <th style="text-align: center;">Experiment</th>
                <th>Dataset</th>
                <th>Feature</th>
                <th>Model</th>
                <th style="text-align: center;">LR</th>
                <th style="text-align: center;">Batch</th>
                <th style="text-align: center;">Epochs</th>
                <th style="text-align: center;">R@100</th>
                <th style="text-align: center;">Loss</th>
            </tr>
        `;
    }

    try {
        const response = await fetch(appendModelEndpointId(`/api/experiments/top-configurations/?limit=5&model_type=${activeModelType}`));
        const data = await response.json();

        if (!data.success || !data.configurations || data.configurations.length === 0) {
            const modelLabel = activeModelType === 'hybrid' ? 'hybrid' : (activeModelType === 'ranking' ? 'ranking' : 'retrieval');
            tbody.innerHTML = `
                <tr>
                    <td colspan="10" class="text-center text-gray-400 py-4">
                        No completed ${modelLabel} experiments yet
                    </td>
                </tr>
            `;
            return;
        }

        if (activeModelType === 'ranking') {
            // Ranking: sort by test_rmse (lower is better)
            const bestMetric = data.configurations[0]?.test_rmse;

            tbody.innerHTML = data.configurations.map((cfg, index) => {
                const rankClass = index < 3 ? `rank-${index + 1}` : '';
                const isBest = cfg.test_rmse === bestMetric;

                return `
                    <tr onclick="openExpDetails(${cfg.experiment_id})" style="cursor: pointer;" title="Click to view details">
                        <td class="rank-cell ${rankClass}">${cfg.rank}</td>
                        <td style="text-align: center;">${cfg.display_name || 'Exp #' + cfg.experiment_number}</td>
                        <td>${cfg.dataset || '-'}</td>
                        <td>${cfg.feature_config || '-'}</td>
                        <td>${cfg.model_config || '-'}</td>
                        <td style="text-align: center;">${cfg.learning_rate}</td>
                        <td style="text-align: center;">${cfg.batch_size}</td>
                        <td style="text-align: center;">${cfg.epochs}</td>
                        <td style="text-align: center;" class="${isBest ? 'metric-best' : ''}">
                            ${cfg.test_rmse !== null ? cfg.test_rmse.toFixed(2) : '-'}
                        </td>
                        <td style="text-align: center;">
                            ${cfg.test_mae !== null ? cfg.test_mae.toFixed(2) : '-'}
                        </td>
                    </tr>
                `;
            }).join('');
        } else if (activeModelType === 'hybrid') {
            // Hybrid: sort by recall_at_100 (higher is better), show both retrieval and ranking metrics
            const bestRecall = data.configurations[0]?.recall_at_100;

            tbody.innerHTML = data.configurations.map((cfg, index) => {
                const rankClass = index < 3 ? `rank-${index + 1}` : '';
                const isBest = cfg.recall_at_100 === bestRecall;

                return `
                    <tr onclick="openExpDetails(${cfg.experiment_id})" style="cursor: pointer;" title="Click to view details">
                        <td class="rank-cell ${rankClass}">${cfg.rank}</td>
                        <td style="text-align: center;">${cfg.display_name || 'Exp #' + cfg.experiment_number}</td>
                        <td>${cfg.dataset || '-'}</td>
                        <td>${cfg.feature_config || '-'}</td>
                        <td>${cfg.model_config || '-'}</td>
                        <td style="text-align: center;">${cfg.learning_rate}</td>
                        <td style="text-align: center;" class="${isBest ? 'metric-best' : ''}">
                            ${cfg.recall_at_100 != null ? (cfg.recall_at_100 * 100).toFixed(1) + '%' : '-'}
                        </td>
                        <td style="text-align: center;">
                            ${cfg.recall_at_50 != null ? (cfg.recall_at_50 * 100).toFixed(1) + '%' : '-'}
                        </td>
                        <td style="text-align: center;">
                            ${cfg.test_rmse != null ? cfg.test_rmse.toFixed(2) : '-'}
                        </td>
                        <td style="text-align: center;">
                            ${cfg.test_mae != null ? cfg.test_mae.toFixed(2) : '-'}
                        </td>
                    </tr>
                `;
            }).join('');
        } else {
            // Retrieval: sort by recall_at_100 (higher is better)
            const bestRecall = data.configurations[0]?.recall_at_100;

            tbody.innerHTML = data.configurations.map((cfg, index) => {
                const rankClass = index < 3 ? `rank-${index + 1}` : '';
                const isBest = cfg.recall_at_100 === bestRecall;

                return `
                    <tr onclick="openExpDetails(${cfg.experiment_id})" style="cursor: pointer;" title="Click to view details">
                        <td class="rank-cell ${rankClass}">${cfg.rank}</td>
                        <td style="text-align: center;">${cfg.display_name || 'Exp #' + cfg.experiment_number}</td>
                        <td>${cfg.dataset || '-'}</td>
                        <td>${cfg.feature_config || '-'}</td>
                        <td>${cfg.model_config || '-'}</td>
                        <td style="text-align: center;">${cfg.learning_rate}</td>
                        <td style="text-align: center;">${cfg.batch_size}</td>
                        <td style="text-align: center;">${cfg.epochs}</td>
                        <td style="text-align: center;" class="${isBest ? 'metric-best' : ''}">
                            ${cfg.recall_at_100 !== null ? (cfg.recall_at_100 * 100).toFixed(1) + '%' : '-'}
                        </td>
                        <td style="text-align: center;">
                            ${cfg.loss !== null ? cfg.loss.toFixed(1) : '-'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

    } catch (error) {
        console.error('Failed to load top configurations:', error);
        tbody.innerHTML = `
            <tr>
                <td colspan="10" class="text-center text-red-400 py-4">
                    Failed to load configurations
                </td>
            </tr>
        `;
    }
}

async function loadHyperparameterAnalysis(modelType = null) {
    const container = document.getElementById('hyperparamContainer');
    const sectionSubtitle = document.querySelector('#hyperparamContainer').closest('.dashboard-section').querySelector('.text-xs');

    // Use provided modelType or fall back to selected state
    const activeModelType = modelType || selectedDashboardModelType;

    // Update subtitle based on model type
    const subtitleConfig = {
        'retrieval': 'TPE-based analysis  Higher score = better association with top 30% results (by R@100)',
        'ranking': 'TPE-based analysis  Higher score = better association with top 30% results (by Test RMSE)',
        'hybrid': 'TPE-based analysis  Higher score = better association with top 30% results (by R@100)'
    };
    if (sectionSubtitle) {
        sectionSubtitle.textContent = subtitleConfig[activeModelType] || subtitleConfig['retrieval'];
    }

    try {
        const response = await fetch(appendModelEndpointId(`/api/experiments/hyperparameter-analysis/?model_type=${activeModelType}`));
        const data = await response.json();

        if (!data.success || !data.analysis) {
            const modelLabel = activeModelType === 'hybrid' ? 'hybrid' : (activeModelType === 'ranking' ? 'ranking' : 'retrieval');
            container.innerHTML = `<div class="dashboard-empty-section"><i class="fas fa-cogs"></i><p>No ${modelLabel} hyperparameter data available</p></div>`;
            return;
        }

        const analysis = data.analysis;

        // Check if we have any data
        const hasData = ['training', 'model', 'features', 'dataset'].some(
            cat => analysis[cat] && analysis[cat].length > 0
        );

        if (!hasData) {
            const modelLabel = activeModelType === 'hybrid' ? 'hybrid' : (activeModelType === 'ranking' ? 'ranking' : 'retrieval');
            container.innerHTML = `<div class="dashboard-empty-section"><i class="fas fa-cogs"></i><p>No ${modelLabel} hyperparameter data available</p></div>`;
            return;
        }

        // Category configuration
        const categories = [
            { key: 'training', label: 'Training', icon: 'fa-graduation-cap' },
            { key: 'model', label: 'Model Architecture', icon: 'fa-network-wired' },
            { key: 'features', label: 'Features', icon: 'fa-layer-group' },
            { key: 'dataset', label: 'Dataset', icon: 'fa-database' }
        ];

        // Determine metric label based on model type
        // For hybrid, we use R@100 as the primary metric (same as retrieval)
        const metricLabel = activeModelType === 'ranking' ? 'Test RMSE' : 'R@100';
        const thresholdLabel = activeModelType === 'ranking'
            ? (analysis.good_threshold ? analysis.good_threshold.toFixed(2) : '-')
            : (analysis.good_threshold ? (analysis.good_threshold * 100).toFixed(1) + '%' : '-');

        // Build meta info section
        let html = `
            <div class="hyperparam-meta">
                <div class="hyperparam-meta-item">
                    <span>Experiments:</span>
                    <span class="hyperparam-meta-value">${analysis.total_experiments || 0}</span>
                </div>
                <div class="hyperparam-meta-item">
                    <span>Good threshold (top 30%):</span>
                    <span class="hyperparam-meta-value">${thresholdLabel}</span>
                </div>
                <div class="hyperparam-meta-item">
                    <span>Good experiments:</span>
                    <span class="hyperparam-meta-value">${analysis.good_experiments || 0}</span>
                </div>
            </div>
        `;

        // Helper function to render a standard hyperparam card
        function renderHyperparamCard(param, isWide = false) {
            if (!param || !param.values || param.values.length === 0) return '';

            const topValues = param.values.slice(0, 4);
            const cardClass = isWide ? 'hyperparam-card-wide' : 'hyperparam-card';

            return `
                <div class="${cardClass}">
                    <div class="hyperparam-card-title">${param.param}</div>
                    ${topValues.map((item, idx) => {
                        const isBest = idx === 0;
                        const isLowConf = item.confidence === 'low';
                        const classes = [
                            'hyperparam-item',
                            isBest ? 'best' : '',
                            isLowConf ? 'low-confidence' : ''
                        ].filter(Boolean).join(' ');

                        return `
                            <div class="${classes}" title="TPE Score: ${item.tpe_score}, Avg Recall: ${(item.avg_recall * 100).toFixed(1)}%, Count: ${item.count}">
                                <span class="hyperparam-value">${item.value}</span>
                                <span class="hyperparam-metrics">
                                    <span class="hyperparam-tpe ${isBest ? 'best' : ''}">${item.tpe_score.toFixed(1)}</span>
                                    <span class="hyperparam-count">(${item.count})</span>
                                </span>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Helper function to find a param by field name
        function findParam(params, field) {
            return params.find(p => p.field === field);
        }

        // Helper function to render feature detail card
        function renderFeatureDetailCard(title, features) {
            if (!features || features.length === 0) {
                return `
                    <div class="hyperparam-card">
                        <div class="hyperparam-card-title">${title}</div>
                        <div class="hyperparam-item" style="color: #9ca3af; font-style: italic;">
                            No data available
                        </div>
                    </div>
                `;
            }

            return `
                <div class="hyperparam-card">
                    <div class="hyperparam-card-title">${title}</div>
                    ${features.map((item, idx) => {
                        const isBest = idx === 0;
                        const isLowConf = item.confidence === 'low';
                        const classes = [
                            'hyperparam-item',
                            isBest ? 'best' : '',
                            isLowConf ? 'low-confidence' : ''
                        ].filter(Boolean).join(' ');

                        return `
                            <div class="${classes}" title="TPE Score: ${item.tpe_score}, Avg Recall: ${(item.avg_recall * 100).toFixed(1)}%, Count: ${item.count}">
                                <span class="hyperparam-value" style="max-width: 140px;">${item.value}</span>
                                <span class="hyperparam-metrics">
                                    <span class="hyperparam-tpe ${isBest ? 'best' : ''}">${item.tpe_score.toFixed(1)}</span>
                                    <span class="hyperparam-count">(${item.count})</span>
                                </span>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Helper function to render filter detail card (for Dataset section)
        function renderFilterDetailCard(title, filters, isSize = false) {
            if (!filters || filters.length === 0) {
                return `
                    <div class="hyperparam-card">
                        <div class="hyperparam-card-title">${title}</div>
                        <div class="hyperparam-item" style="color: #9ca3af; font-style: italic;">
                            No data
                        </div>
                    </div>
                `;
            }

            // Format value - for size, format as "107K" or "782K"
            const formatValue = (val) => {
                if (isSize && typeof val === 'number') {
                    if (val >= 1000000) return `${(val / 1000000).toFixed(1)}M`;
                    if (val >= 1000) return `${(val / 1000).toFixed(0)}K`;
                    return val.toString();
                }
                return val;
            };

            return `
                <div class="hyperparam-card">
                    <div class="hyperparam-card-title">${title}</div>
                    ${filters.map((item, idx) => {
                        const isBest = idx === 0;
                        const isLowConf = item.confidence === 'low';
                        const classes = [
                            'hyperparam-item',
                            isBest ? 'best' : '',
                            isLowConf ? 'low-confidence' : ''
                        ].filter(Boolean).join(' ');

                        const displayValue = isSize ? formatValue(item.raw_value || item.value) : item.value;

                        return `
                            <div class="${classes}" title="TPE Score: ${item.tpe_score}, Avg Recall: ${(item.avg_recall * 100).toFixed(1)}%, Count: ${item.count}">
                                <span class="hyperparam-value">${displayValue}</span>
                                <span class="hyperparam-metrics">
                                    <span class="hyperparam-tpe ${isBest ? 'best' : ''}">${item.tpe_score.toFixed(1)}</span>
                                    <span class="hyperparam-count">(${item.count})</span>
                                </span>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Build each category section
        for (const category of categories) {
            const params = analysis[category.key];

            // For dataset, also check filter_details
            if (category.key === 'dataset') {
                const filterDetails = analysis.filter_details || {};
                const hasFilters = (filterDetails.date_filters?.length > 0) ||
                                   (filterDetails.customer_filters?.length > 0) ||
                                   (filterDetails.product_filters?.length > 0);
                if ((!params || params.length === 0) && !hasFilters) continue;
            } else {
                if (!params || params.length === 0) continue;
            }

            html += `
                <div class="hyperparam-category">
                    <div class="hyperparam-category-title ${category.key}">
                        <i class="fas ${category.icon}"></i>
                        ${category.label}
                    </div>
            `;

            // Special handling for MODEL ARCHITECTURE - 2 or 3 row layout
            if (category.key === 'model') {
                // Get params by field name (exclude activation fields)
                const buyerTower = findParam(params, 'buyer_tower_structure');
                const buyerL2 = findParam(params, 'buyer_l2_category');
                const buyerParams = findParam(params, 'buyer_total_params');
                const productTower = findParam(params, 'product_tower_structure');
                const productL2 = findParam(params, 'product_l2_category');
                const productParams = findParam(params, 'product_total_params');
                // Ranking tower fields (only available for ranking models)
                const rankingTower = findParam(params, 'ranking_tower_structure');
                const rankingParams = findParam(params, 'ranking_total_params');

                html += `
                    <div class="hyperparam-model-section">
                        <!-- Buyer Tower Row -->
                        <div class="hyperparam-model-row">
                            ${renderHyperparamCard(buyerTower, true)}
                            ${renderHyperparamCard(buyerL2, false)}
                            ${renderHyperparamCard(buyerParams, false)}
                        </div>
                        <!-- Product Tower Row -->
                        <div class="hyperparam-model-row">
                            ${renderHyperparamCard(productTower, true)}
                            ${renderHyperparamCard(productL2, false)}
                            ${renderHyperparamCard(productParams, false)}
                        </div>
                `;

                // Add Ranking Tower row for ranking and hybrid models
                if ((activeModelType === 'ranking' || activeModelType === 'hybrid') && (rankingTower || rankingParams)) {
                    html += `
                        <!-- Ranking Tower Row -->
                        <div class="hyperparam-model-row ranking-tower-row">
                            ${renderHyperparamCard(rankingTower, true)}
                            <div class="hyperparam-card-placeholder"></div>
                            ${renderHyperparamCard(rankingParams, false)}
                        </div>
                    `;
                }

                html += `</div>`;
            } else if (category.key === 'features') {
                // Special handling for FEATURES - 2 row layout (Buyer/Product)
                const buyerTensorDim = findParam(params, 'buyer_tensor_dim');
                const buyerFeatures = findParam(params, 'buyer_feature_count');
                const buyerCrosses = findParam(params, 'buyer_cross_count');
                const productTensorDim = findParam(params, 'product_tensor_dim');
                const productFeatures = findParam(params, 'product_feature_count');
                const productCrosses = findParam(params, 'product_cross_count');

                // Get feature details from analysis
                const featureDetails = analysis.feature_details || {};

                html += `
                    <div class="hyperparam-model-section">
                        <!-- Buyer Features Row 1: Summary cards -->
                        <div class="hyperparam-features-row">
                            ${renderHyperparamCard(buyerTensorDim, false)}
                            ${renderHyperparamCard(buyerFeatures, false)}
                            ${renderHyperparamCard(buyerCrosses, false)}
                        </div>
                        <!-- Buyer Features Row 2: Detail cards -->
                        <div class="hyperparam-features-detail-row">
                            ${renderFeatureDetailCard('Buyer Feature Details', featureDetails.buyer || [])}
                            ${renderFeatureDetailCard('Buyer Cross Details', featureDetails.buyer_crosses || [])}
                        </div>
                        <!-- Product Features Row 1: Summary cards -->
                        <div class="hyperparam-features-row">
                            ${renderHyperparamCard(productTensorDim, false)}
                            ${renderHyperparamCard(productFeatures, false)}
                            ${renderHyperparamCard(productCrosses, false)}
                        </div>
                        <!-- Product Features Row 2: Detail cards -->
                        <div class="hyperparam-features-detail-row">
                            ${renderFeatureDetailCard('Product Feature Details', featureDetails.product || [])}
                            ${renderFeatureDetailCard('Product Cross Details', featureDetails.product_crosses || [])}
                        </div>
                    </div>
                `;
            } else if (category.key === 'dataset') {
                // Special handling for DATASET - single row with 4 tablets
                const filterDetails = analysis.filter_details || {};

                html += `
                    <div class="hyperparam-dataset-row">
                        ${renderFilterDetailCard('Dataset Size', params && params.length > 0 ? params[0].values.slice(0, 5) : [], true)}
                        ${renderFilterDetailCard('Dates', (filterDetails.date_filters || []).slice(0, 5))}
                        ${renderFilterDetailCard('Customer Filters', (filterDetails.customer_filters || []).slice(0, 5))}
                        ${renderFilterDetailCard('Product Filters', (filterDetails.product_filters || []).slice(0, 5))}
                    </div>
                `;
            } else {
                // Standard grid layout for other categories
                html += `<div class="hyperparam-grid">`;

                for (const param of params) {
                    html += renderHyperparamCard(param, false);
                }

                html += `</div>`;
            }

            html += `</div>`;
        }

        // Add legend
        html += `
            <div class="hyperparam-legend">
                <div class="hyperparam-legend-item">
                    <span class="hyperparam-tpe best">2.3</span>
                    <span>= TPE Score (higher = better)</span>
                </div>
                <div class="hyperparam-legend-item">
                    <span class="hyperparam-count">(5)</span>
                    <span>= experiment count</span>
                </div>
                <div class="hyperparam-legend-item">
                    <span style="opacity: 0.6;"> faded</span>
                    <span>= low confidence (&lt;3 experiments)</span>
                </div>
            </div>
        `;

        container.innerHTML = html;

    } catch (error) {
        console.error('Failed to load hyperparameter analysis:', error);
        container.innerHTML = '<div class="dashboard-empty-section text-red-400"><i class="fas fa-exclamation-triangle"></i><p>Failed to load analysis</p></div>';
    }
}

async function loadSuggestions() {
    const container = document.getElementById('suggestionsContainer');
    const emptyEl = document.getElementById('suggestionsEmpty');

    try {
        const response = await fetch(appendModelEndpointId('/api/experiments/suggestions/'));
        const data = await response.json();

        if (!data.success || !data.suggestions || data.suggestions.length === 0) {
            container.innerHTML = '';
            emptyEl.classList.remove('hidden');
            return;
        }

        emptyEl.classList.add('hidden');

        container.innerHTML = data.suggestions.map(suggestion => {
            const isVariation = suggestion.type === 'hyperparameter_variation';
            const cardClass = isVariation ? 'suggestion-card variation' : 'suggestion-card';
            const icon = isVariation ? 'fa-sliders-h' : 'fa-flask';

            // Build the onclick handler for running the experiment
            let onclickHandler = '';
            if (suggestion.feature_config_id && suggestion.model_config_id) {
                const params = suggestion.suggested_params || {};
                onclickHandler = `openWizardWithSuggestion(${suggestion.feature_config_id}, ${suggestion.model_config_id}, ${JSON.stringify(params).replace(/"/g, '&quot;')})`;
            }

            return `
                <div class="${cardClass}">
                    <div class="suggestion-header">
                        <div class="suggestion-icon">
                            <i class="fas ${icon}"></i>
                        </div>
                        <span class="suggestion-title">${suggestion.title}</span>
                    </div>
                    <p class="suggestion-description">${suggestion.description}</p>
                    ${onclickHandler ? `
                        <div class="suggestion-action">
                            <button class="suggestion-btn" onclick="${onclickHandler}">
                                <i class="fas fa-play"></i>
                                Run Experiment
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
        }).join('');

    } catch (error) {
        console.error('Failed to load suggestions:', error);
        container.innerHTML = '';
        emptyEl.classList.remove('hidden');
    }
}

async function loadDatasetComparison(modelType = null) {
    const tbody = document.getElementById('datasetComparisonBody');
    const thead = document.getElementById('datasetComparisonHead');
    const emptyEl = document.getElementById('datasetComparisonEmpty');
    const subtitle = document.getElementById('datasetComparisonSubtitle');

    const activeModelType = modelType || selectedDashboardModelType;

    // Update headers based on model type (dynamically rebuild thead for different column counts)
    if (activeModelType === 'ranking') {
        if (subtitle) subtitle.textContent = 'Compare ranking results across different datasets';
        thead.innerHTML = `
            <tr>
                <th>Dataset</th>
                <th style="text-align: center;">Experiments</th>
                <th style="text-align: right;">Best RMSE</th>
                <th style="text-align: right;">Avg RMSE</th>
                <th style="text-align: right;">Avg Loss</th>
            </tr>
        `;
    } else if (activeModelType === 'hybrid') {
        if (subtitle) subtitle.textContent = 'Compare hybrid model results across different datasets';
        thead.innerHTML = `
            <tr>
                <th>Dataset</th>
                <th style="text-align: center;">Experiments</th>
                <th style="text-align: right;">Best R@100</th>
                <th style="text-align: right;">Avg R@100</th>
                <th style="text-align: right;">Best RMSE</th>
                <th style="text-align: right;">Avg RMSE</th>
            </tr>
        `;
    } else {
        if (subtitle) subtitle.textContent = 'Compare results across different datasets';
        thead.innerHTML = `
            <tr>
                <th>Dataset</th>
                <th style="text-align: center;">Experiments</th>
                <th style="text-align: right;">Best R@100</th>
                <th style="text-align: right;">Avg R@100</th>
                <th style="text-align: right;">Avg Loss</th>
            </tr>
        `;
    }

    try {
        const response = await fetch(appendModelEndpointId(`/api/experiments/dataset-comparison/?model_type=${activeModelType}`));
        const data = await response.json();

        if (!data.success || !data.datasets || data.datasets.length === 0) {
            tbody.parentElement.style.display = 'none';
            emptyEl.innerHTML = '<i class="fas fa-database"></i><p>No dataset comparison data available</p>';
            emptyEl.classList.remove('hidden');
            return;
        }

        tbody.parentElement.style.display = 'table';
        emptyEl.classList.add('hidden');

        if (activeModelType === 'ranking') {
            // For ranking: lower RMSE is better
            const bestRmse = Math.min(...data.datasets.map(d => d.best_rmse || Infinity));

            tbody.innerHTML = data.datasets.map(ds => {
                const isBest = ds.best_rmse === bestRmse;
                return `
                    <tr>
                        <td><strong>${ds.name}</strong></td>
                        <td style="text-align: center;">${ds.experiment_count}</td>
                        <td style="text-align: right;" class="${isBest ? 'metric-best' : ''}">
                            ${ds.best_rmse !== null ? ds.best_rmse.toFixed(2) : '-'}
                        </td>
                        <td style="text-align: right;">
                            ${ds.avg_rmse !== null ? ds.avg_rmse.toFixed(2) : '-'}
                        </td>
                        <td style="text-align: right;">
                            ${ds.avg_loss !== null ? ds.avg_loss.toFixed(2) : '-'}
                        </td>
                    </tr>
                `;
            }).join('');
        } else if (activeModelType === 'hybrid') {
            // For hybrid: higher recall is better (primary), also show RMSE
            const bestRecall = Math.max(...data.datasets.map(d => d.best_recall || 0));

            tbody.innerHTML = data.datasets.map(ds => {
                const isBest = ds.best_recall === bestRecall;
                return `
                    <tr>
                        <td><strong>${ds.name}</strong></td>
                        <td style="text-align: center;">${ds.experiment_count}</td>
                        <td style="text-align: right;" class="${isBest ? 'metric-best' : ''}">
                            ${ds.best_recall !== null ? (ds.best_recall * 100).toFixed(1) + '%' : '-'}
                        </td>
                        <td style="text-align: right;">
                            ${ds.avg_recall !== null ? (ds.avg_recall * 100).toFixed(1) + '%' : '-'}
                        </td>
                        <td style="text-align: right;">
                            ${ds.best_rmse !== null ? ds.best_rmse.toFixed(2) : '-'}
                        </td>
                        <td style="text-align: right;">
                            ${ds.avg_rmse !== null ? ds.avg_rmse.toFixed(2) : '-'}
                        </td>
                    </tr>
                `;
            }).join('');
        } else {
            // For retrieval: higher recall is better
            const bestRecall = Math.max(...data.datasets.map(d => d.best_recall || 0));

            tbody.innerHTML = data.datasets.map(ds => {
                const isBest = ds.best_recall === bestRecall;
                return `
                    <tr>
                        <td><strong>${ds.name}</strong></td>
                        <td style="text-align: center;">${ds.experiment_count}</td>
                        <td style="text-align: right;" class="${isBest ? 'metric-best' : ''}">
                            ${ds.best_recall !== null ? (ds.best_recall * 100).toFixed(1) + '%' : '-'}
                        </td>
                        <td style="text-align: right;">
                            ${ds.avg_recall !== null ? (ds.avg_recall * 100).toFixed(1) + '%' : '-'}
                        </td>
                        <td style="text-align: right;">
                            ${ds.avg_loss !== null ? ds.avg_loss.toFixed(2) : '-'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

    } catch (error) {
        console.error('Failed to load dataset comparison:', error);
        tbody.parentElement.style.display = 'none';
        emptyEl.classList.remove('hidden');
    }
}

// Function to open wizard with pre-filled suggestion params
function openWizardWithSuggestion(featureConfigId, modelConfigId, suggestedParams) {
    // Open the wizard modal
    openNewExpWizard();

    // Wait for the modal to load, then set the values
    setTimeout(() => {
        // Set feature config
        const fcSelect = document.getElementById('wizardFeatureConfigSelect');
        if (fcSelect) {
            fcSelect.value = featureConfigId;
            fcSelect.dispatchEvent(new Event('change'));
        }

        // Set model config
        const mcSelect = document.getElementById('wizardModelConfigSelect');
        if (mcSelect) {
            mcSelect.value = modelConfigId;
            mcSelect.dispatchEvent(new Event('change'));
        }

        // Apply suggested params after a small delay to let model config load its defaults
        setTimeout(() => {
            if (suggestedParams.learning_rate !== undefined) {
                const lrInput = document.getElementById('wizardLearningRate');
                if (lrInput) lrInput.value = suggestedParams.learning_rate;
            }
            if (suggestedParams.batch_size !== undefined) {
                const bsSelect = document.getElementById('wizardBatchSize');
                if (bsSelect) bsSelect.value = suggestedParams.batch_size;
            }
            if (suggestedParams.epochs !== undefined) {
                const epochsSelect = document.getElementById('wizardEpochs');
                if (epochsSelect) epochsSelect.value = suggestedParams.epochs;
            }
            if (suggestedParams.data_sample_percent !== undefined) {
                const sampleSelect = document.getElementById('wizardDataSample');
                if (sampleSelect) sampleSelect.value = suggestedParams.data_sample_percent;
            }
        }, 300);
    }, 100);
}
</script>

<!-- Chart.js for training curves visualization -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- Chart.js datalabels plugin for showing values on bars -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

<!-- D3.js for ridgeline histogram -->
<script src="https://d3js.org/d3.v7.min.js"></script>

<!-- Pipeline DAG Visualization (extracted component) -->
<script src="{% static 'js/pipeline_dag.js' %}?v=2"></script>

<!-- Reusable Experiment View Modal Module -->
<script src="{% static 'js/exp_view_modal.js' %}?v=3"></script>
{% endblock %}
