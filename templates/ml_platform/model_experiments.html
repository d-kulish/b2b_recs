{% extends 'base_model.html' %}
{% load humanize %}
{% load static %}

{% block title %}{{ model.name }} - Experiments{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/cards.css' %}?v=4">
<link rel="stylesheet" href="{% static 'css/modals.css' %}?v=2">
<link rel="stylesheet" href="{% static 'css/pipeline_dag.css' %}?v=1">
<style>
    /* =========================================================================
       Chapter Section Styles
       ========================================================================= */
    .chapter-section {
        background: white;
        border: 1px solid black;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        padding: 24px;
        margin-bottom: 20px;
    }
    .chapter-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
    }
    .chapter-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        color: white;
    }
    .chapter-icon.quick-test {
        background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
    }
    .chapter-title {
        font-size: 20px;
        font-weight: 700;
        color: #111827;
    }
    .chapter-empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 48px 24px;
        color: #9ca3af;
        text-align: center;
    }
    .chapter-empty-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
    }
    .chapter-empty-text {
        font-size: 14px;
        max-width: 300px;
    }

    /* =========================================================================
       Filter Bar Styles
       ========================================================================= */
    .exp-filter-bar {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 16px;
        flex-wrap: wrap;
    }
    .exp-filter-group {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .exp-filter-label {
        font-size: 13px;
        font-weight: 500;
        color: #6b7280;
    }
    .exp-filter-select {
        padding: 6px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        font-size: 13px;
        background: white;
        min-width: 140px;
    }
    .exp-filter-select:focus {
        outline: none;
        border-color: #f59e0b;
        box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.1);
    }
    .exp-search-input {
        flex: 1;
        min-width: 200px;
        padding: 6px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        font-size: 13px;
        background: white;
    }
    .exp-search-input:focus {
        outline: none;
        border-color: #f59e0b;
        box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.1);
    }
    .exp-search-input::placeholder {
        color: #9ca3af;
    }

    /* =========================================================================
       Experiment Card Styles
       ========================================================================= */
    .exp-cards-container {
        max-height: 360px;
        overflow-y: auto;
        margin-bottom: 16px;
    }
    .exp-card {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        margin-bottom: 10px;
        background: white;
        transition: all 0.2s ease;
        cursor: pointer;
    }
    .exp-card:hover {
        border-color: #d1d5db;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    .exp-card:last-child {
        margin-bottom: 0;
    }
    .exp-card-status {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        flex-shrink: 0;
    }
    .exp-card-status.running {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        color: #2563eb;
    }
    .exp-card-status.completed {
        background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
        color: #16a34a;
    }
    .exp-card-status.failed {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        color: #dc2626;
    }
    .exp-card-status.cancelled {
        background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        color: #6b7280;
    }
    .exp-card-status.submitting {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        color: #2563eb;
    }
    .exp-card-info {
        flex: 1;
        min-width: 0;
    }
    .exp-card-name {
        font-weight: 600;
        font-size: 15px;
        color: #111827;
        margin-bottom: 4px;
    }
    .exp-card-custom-name {
        font-weight: 400;
        color: #6b7280;
    }
    .exp-card-configs {
        font-size: 13px;
        color: #4b5563;
        margin-bottom: 2px;
    }
    .exp-card-meta {
        font-size: 12px;
        color: #9ca3af;
    }
    .exp-card-metric {
        text-align: right;
        flex-shrink: 0;
    }
    .exp-card-metric-value {
        font-size: 18px;
        font-weight: 700;
        color: #111827;
    }
    .exp-card-metric-label {
        font-size: 11px;
        color: #6b7280;
        text-transform: uppercase;
    }
    .exp-card-progress {
        text-align: right;
        flex-shrink: 0;
        min-width: 80px;
    }
    .exp-card-progress-bar {
        height: 6px;
        width: 80px;
        background: #e5e7eb;
        border-radius: 3px;
        overflow: hidden;
        margin-bottom: 4px;
    }
    .exp-card-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #3b82f6, #60a5fa);
        border-radius: 3px;
        transition: width 0.3s ease;
    }
    .exp-card-progress-text {
        font-size: 12px;
        color: #6b7280;
    }

    /* =========================================================================
       Stage Progress Bar (for running/submitting experiments)
       Styled like tensor-breakdown-bar from model_configs.html
       ========================================================================= */
    .exp-card-stages {
        width: 100%;
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #f3f4f6;
    }
    .exp-stages-bar {
        display: flex;
        height: 24px;
        border-radius: 6px;
        overflow: hidden;
        background: #e5e7eb;
    }
    .exp-stage-segment {
        flex: 1;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: 500;
        color: white;
        text-transform: uppercase;
        letter-spacing: 0.02em;
        white-space: nowrap;
        overflow: hidden;
        transition: background-color 0.3s ease;
    }
    /* Completed segments get gradient colors via inline styles */
    .exp-stage-segment.running {
        background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 50%, #3b82f6 100%);
        background-size: 200% 100%;
        animation: stage-pulse 1.5s ease-in-out infinite;
    }
    .exp-stage-segment.failed {
        background: #ef4444;
    }
    .exp-stage-segment.pending {
        background: #d1d5db;
        color: #6b7280;
    }
    @keyframes stage-pulse {
        0%, 100% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
    }

    /* Experiment card - column layout */
    .exp-card-new {
        display: flex;
        flex-direction: column;
        padding: 16px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        margin-bottom: 8px;
        transition: all 0.15s ease;
        cursor: pointer;
    }
    .exp-card-new:hover {
        border-color: #d1d5db;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    .exp-card-new:last-child {
        margin-bottom: 0;
    }
    .exp-card-columns {
        display: flex;
        align-items: flex-start;
        gap: 16px;
        margin-bottom: 8px;
    }
    /* Column 1: Experiment Info (30%) */
    .exp-card-col-info {
        width: 30%;
        min-width: 0;
        display: flex;
        align-items: flex-start;
        gap: 12px;
    }
    .exp-compare-label {
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        padding: 4px;
    }
    .exp-compare-checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: #f59e0b;
    }
    .exp-card-info-text {
        flex: 1;
        min-width: 0;
    }
    .exp-card-name {
        font-weight: 600;
        font-size: 15px;
        color: #111827;
        margin-bottom: 2px;
    }
    .exp-card-custom-name {
        font-weight: 400;
        color: #6b7280;
    }
    .exp-card-exp-name {
        font-size: 13px;
        color: #374151;
        margin-bottom: 2px;
    }
    .exp-card-description {
        font-size: 12px;
        color: #9ca3af;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .exp-card-times {
        display: flex;
        gap: 12px;
        font-size: 11px;
        color: #9ca3af;
        margin-top: 4px;
    }
    .exp-card-times span {
        color: #6b7280;
    }
    /* Column 2: Config Info (20%) */
    .exp-card-col-config {
        width: 20%;
        min-width: 0;
    }
    .exp-card-config-item {
        font-size: 12px;
        font-weight: 400;
        color: #374151;
        margin-bottom: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .exp-card-config-label {
        font-weight: 600;
        color: #6b7280;
    }
    /* Column 3: Training Params / Metrics (30%) */
    .exp-card-col-params {
        width: 30%;
        min-width: 0;
        font-size: 12px;
        color: #9ca3af;
        display: flex;
        align-items: center;
    }
    /* Metrics row within Column 3 */
    .exp-card-metrics-row {
        display: flex;
        gap: 8px;
        width: 100%;
    }
    .exp-card-metric {
        text-align: center;
        flex: 1;
        padding: 6px 4px;
        background: #ffffff;
        border: 1px solid #1f2937;
        border-radius: 6px;
    }
    .exp-card-metric-label {
        font-size: 10px;
        color: #1f2937;
        font-weight: 500;
        margin-bottom: 2px;
    }
    .exp-card-metric-value {
        font-size: 13px;
        font-weight: 600;
        color: #1f2937;
    }
    .exp-card-metric-value.empty {
        color: #9ca3af;
    }
    /* Column 4: Actions (20%) */
    .exp-card-col-actions {
        width: 20%;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: flex-end;
        gap: 6px;
    }
    .exp-card-actions-row {
        display: flex;
        flex-direction: row;
        gap: 6px;
        justify-content: flex-end;
    }
    /* Legacy support */
    .exp-card-header {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .exp-card-body {
        flex: 1;
        min-width: 0;
    }

    /* =========================================================================
       Pagination Styles
       ========================================================================= */
    .exp-pagination {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding-top: 12px;
        border-top: 1px solid #e5e7eb;
    }
    .exp-pagination-info {
        font-size: 13px;
        color: #6b7280;
    }
    .exp-pagination-buttons {
        display: flex;
        gap: 4px;
    }
    .exp-pagination-btn {
        padding: 6px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        font-size: 13px;
        background: white;
        color: #374151;
        cursor: pointer;
        transition: all 0.15s ease;
    }
    .exp-pagination-btn:hover:not(:disabled) {
        border-color: #d1d5db;
        background: #f9fafb;
    }
    .exp-pagination-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .exp-pagination-btn.active {
        background: #2563eb;
        border-color: #2563eb;
        color: white;
    }

    /* =========================================================================
       Wizard Modal Styles (extending modals.css)
       ========================================================================= */

    /* Config Preview Panels */
    .config-preview-panel {
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 16px;
        margin-top: 12px;
        background: #f9fafb;
    }
    .config-preview-panel.feature {
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        border-color: #bae6fd;
    }
    .config-preview-panel.model {
        background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
        border-color: #e9d5ff;
    }
    .config-preview-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
    }
    .config-preview-name {
        font-weight: 600;
        font-size: 15px;
        color: #111827;
    }
    .config-preview-empty {
        text-align: center;
        padding: 24px;
        color: #9ca3af;
        font-size: 13px;
    }

    /* Tensor Preview in Wizard */
    .tensor-preview-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }
    .tensor-preview-item {
        padding: 12px;
        background: white;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
    }
    .tensor-preview-item.buyer {
        border-left: 3px solid #3b82f6;
    }
    .tensor-preview-item.product {
        border-left: 3px solid #10b981;
    }
    .tensor-preview-title {
        font-size: 12px;
        font-weight: 600;
        color: #6b7280;
        margin-bottom: 8px;
        text-transform: uppercase;
    }
    .tensor-preview-dim {
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 8px;
    }
    .tensor-preview-dim.buyer { color: #3b82f6; }
    .tensor-preview-dim.product { color: #10b981; }
    .tensor-preview-features {
        font-size: 12px;
        color: #6b7280;
        max-height: 80px;
        overflow-y: auto;
    }
    .tensor-preview-features div {
        padding: 2px 0;
    }

    /* Tensor Breakdown Bar */
    .tensor-breakdown-bar {
        display: flex;
        height: 24px;
        border-radius: 6px;
        overflow: hidden;
        background: #e5e7eb;
        margin-bottom: 8px;
    }
    .tensor-breakdown-segment {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: 500;
        color: white;
        transition: width 0.3s ease;
        overflow: hidden;
        white-space: nowrap;
    }

    /* Tower Preview in Wizard - Rich Visualization */
    .tower-visual {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }
    .tower-visual-aligned .tower-stack {
        display: flex;
        flex-direction: column;
    }
    .tower-visual-aligned .tower-column {
        display: flex;
        flex-direction: column;
    }
    .tower-visual-aligned .tower-stack {
        flex: 1;
    }
    .tower-column {
        min-width: 0;
    }
    .tower-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 6px;
    }
    .tower-label {
        font-size: 10px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #6b7280;
    }
    .tower-stack {
        display: flex;
        flex-direction: column;
        gap: 8px;
        border-radius: 10px;
        padding: 12px;
        border: 2px dashed;
    }
    .tower-stack.buyer {
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        border-color: #3b82f6;
    }
    .tower-stack.product {
        background: linear-gradient(135deg, #f0fdf4 0%, #d1fae5 100%);
        border-color: #10b981;
    }
    .tower-stack.ranking {
        background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
        border-color: #8b5cf6;
    }
    .card-layer-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 12px;
        background: white;
        border-radius: 8px;
        border: 1px solid rgba(0, 0, 0, 0.08);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
    }
    .tower-stack.buyer .card-layer-item {
        border-color: rgba(59, 130, 246, 0.2);
    }
    .tower-stack.product .card-layer-item {
        border-color: rgba(16, 185, 129, 0.2);
    }
    .tower-stack.ranking .card-layer-item {
        border-color: rgba(139, 92, 246, 0.2);
    }
    .card-layer-item.output-layer {
        border: 2px solid #f87171 !important;
    }
    .card-layer-item.empty-placeholder {
        background: transparent;
        border: 1px dashed rgba(0, 0, 0, 0.1);
        visibility: hidden;
    }
    .card-layer-item .card-drag-handle {
        color: #c4c4c4;
        font-size: 12px;
    }
    .card-layer-badge {
        display: inline-flex;
        align-items: center;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        flex-shrink: 0;
    }
    .card-layer-badge.dense {
        background: #e5e7eb;
        color: #374151;
    }
    .card-layer-badge.dropout {
        background: #fef3c7;
        color: #92400e;
    }
    .card-layer-badge.batch_norm {
        background: #d1fae5;
        color: #065f46;
    }
    .card-layer-badge.layer_norm {
        background: #e0e7ff;
        color: #3730a3;
    }
    .card-layer-params {
        flex: 1;
        font-size: 12px;
        color: #4b5563;
    }
    .tower-params-summary {
        margin: 8px 0 0 0;
        padding: 10px 12px;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 8px;
        border-top: 2px solid rgba(0, 0, 0, 0.1);
        font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
        font-size: 11px;
    }
    .tower-params-summary .params-row {
        display: flex;
        justify-content: space-between;
        color: #6b7280;
    }
    .tower-params-summary .params-row span:last-child {
        font-weight: 600;
        color: #374151;
    }

    /* Training Params Preview */
    .training-params-preview {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
    }
    .param-chip {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        background: #f3f4f6;
        border-radius: 6px;
        font-size: 12px;
    }
    .param-chip-label {
        color: #6b7280;
    }
    .param-chip-value {
        font-weight: 600;
        color: #374151;
    }
    .param-chip.retrieval-algo {
        background: #f5f3ff;
        border: 1px solid #e9d5ff;
    }
    .param-chip.retrieval-algo .param-chip-value {
        color: #7c3aed;
    }

    /* Sample Percent Buttons */
    .sample-btn {
        padding: 4px 10px;
        font-size: 12px;
        font-weight: 500;
        border: 1px solid #fcd34d;
        background: white;
        color: #92400e;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.15s ease;
    }
    .sample-btn:hover {
        background: #fef3c7;
        border-color: #f59e0b;
    }
    .sample-btn.active {
        background: #f59e0b;
        border-color: #d97706;
        color: white;
    }

    /* Training Params in Wizard Step 2 */
    .training-params-section {
        background: #fef3c7;
        border: 1px solid #fcd34d;
        border-radius: 10px;
        padding: 16px;
        margin-bottom: 16px;
    }
    .training-params-section h4 {
        font-size: 14px;
        font-weight: 600;
        color: #92400e;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .training-params-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }
    .training-param-group label {
        display: block;
        font-size: 12px;
        color: #92400e;
        margin-bottom: 4px;
    }
    .training-param-group select,
    .training-param-group input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #fcd34d;
        border-radius: 6px;
        font-size: 13px;
        background: white;
    }
    .training-param-group select:focus,
    .training-param-group input:focus {
        outline: none;
        border-color: #f59e0b;
        box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2);
    }

    /* Training Parameter Buttons (blue theme) */
    .param-btn {
        padding: 6px 8px;
        font-size: 12px;
        font-weight: 500;
        border: 1px solid #93c5fd;
        background: white;
        color: #1e40af;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.15s ease;
        flex: 1;
        text-align: center;
    }
    .param-btn:hover {
        background: #dbeafe;
        border-color: #3b82f6;
    }
    .param-btn.active {
        background: #3b82f6;
        border-color: #2563eb;
        color: white;
    }
    .param-input {
        flex: 1;
        padding: 6px 8px;
        font-size: 12px;
        border: 1px solid #93c5fd;
        border-radius: 4px;
        text-align: center;
        background: white;
    }
    .param-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }

    /* Hardware Selection Section */
    .hardware-section {
        background: linear-gradient(135deg, #fdf4ff 0%, #faf5ff 100%);
        border: 1px solid #e9d5ff;
        border-radius: 10px;
        padding: 16px 20px;
        margin-bottom: 16px;
    }
    .hardware-section h4 {
        font-size: 13px;
        font-weight: 600;
        color: #7c3aed;
        margin: 0 0 4px 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .hardware-recommendation {
        font-size: 11px;
        color: #9333ea;
        margin-bottom: 12px;
    }
    .hardware-recommendation strong {
        color: #7c3aed;
    }
    .hardware-options {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    .hardware-card {
        flex: 1;
        min-width: 120px;
        max-width: 160px;
        background: white;
        border: 2px solid #e9d5ff;
        border-radius: 8px;
        padding: 10px;
        cursor: pointer;
        transition: all 0.15s ease;
        position: relative;
    }
    .hardware-card:hover:not(.disabled) {
        border-color: #c084fc;
        box-shadow: 0 2px 8px rgba(147, 51, 234, 0.15);
    }
    .hardware-card.selected {
        border-color: #9333ea;
        background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
    }
    .hardware-card.selected::after {
        content: '\f00c';
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
        position: absolute;
        top: 8px;
        right: 8px;
        color: #9333ea;
        font-size: 12px;
    }
    .hardware-card.recommended::before {
        content: '\f005';
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
        position: absolute;
        top: 8px;
        left: 8px;
        color: #f59e0b;
        font-size: 10px;
    }
    .hardware-card.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: #f9fafb;
    }
    .hardware-card-title {
        font-size: 13px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 2px;
    }
    .hardware-card-type {
        font-size: 10px;
        color: #6b7280;
        font-family: monospace;
        margin-bottom: 6px;
    }
    .hardware-card-specs {
        font-size: 11px;
        color: #4b5563;
        line-height: 1.4;
    }
    .hardware-card-lock {
        position: absolute;
        top: 8px;
        right: 8px;
        color: #9ca3af;
        font-size: 12px;
    }

    /* Summary Section - Modern Card Layout */
    .exp-summary-section {
        background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
        border: 1px solid #a7f3d0;
        border-radius: 10px;
        padding: 16px 20px;
    }
    .exp-summary-title {
        font-size: 12px;
        font-weight: 600;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .exp-summary-title i {
        color: #6366f1;
    }
    .exp-summary-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px 24px;
    }
    .exp-summary-item {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    .exp-summary-label {
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        color: #94a3b8;
    }
    .exp-summary-value {
        font-size: 13px;
        font-weight: 600;
        color: #1e293b;
    }
    .exp-summary-value.accent {
        color: #6366f1;
    }
    .exp-summary-params {
        grid-column: span 4;
        display: flex;
        gap: 20px;
        padding-top: 12px;
        border-top: 1px solid #f1f5f9;
        margin-top: 4px;
    }
    .exp-summary-param {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background: #f8fafc;
        border-radius: 6px;
    }
    .exp-summary-param-label {
        font-size: 11px;
        color: #64748b;
    }
    .exp-summary-param-value {
        font-size: 12px;
        font-weight: 600;
        color: #334155;
    }

    /* =========================================================================
       Progress Modal Styles
       ========================================================================= */
    .quicktest-progress-bar {
        height: 24px;
        background: #e5e7eb;
        border-radius: 12px;
        overflow: hidden;
        position: relative;
    }
    .quicktest-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #3b82f6, #60a5fa);
        border-radius: 12px;
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .quicktest-progress-fill.animated {
        background: linear-gradient(90deg, #3b82f6, #60a5fa, #3b82f6);
        background-size: 200% 100%;
        animation: progress-shimmer 2s linear infinite;
    }
    @keyframes progress-shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
    .quicktest-progress-text {
        color: white;
        font-size: 12px;
        font-weight: 600;
    }
    .quicktest-stage {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        border-radius: 8px;
        margin-bottom: 8px;
        background: #f9fafb;
    }
    .quicktest-stage.completed { background: #ecfdf5; }
    .quicktest-stage.running { background: #eff6ff; }
    .quicktest-stage.failed { background: #fef2f2; }
    .quicktest-stage-icon {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
    }
    .quicktest-stage-icon.completed { color: #10b981; }
    .quicktest-stage-icon.running { color: #3b82f6; }
    .quicktest-stage-icon.failed { color: #ef4444; }
    .quicktest-stage-icon.pending { color: #9ca3af; }
    .quicktest-stage-name {
        flex: 1;
        font-weight: 500;
        color: #374151;
    }
    .quicktest-stage-duration {
        font-size: 12px;
        color: #6b7280;
    }

    /* Results Modal Metrics */
    .quicktest-metric {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #e5e7eb;
    }
    .quicktest-metric:last-child { border-bottom: none; }
    .quicktest-metric-label { color: #6b7280; }
    .quicktest-metric-value {
        font-weight: 600;
        color: #111827;
    }

    /* =========================================================================
       Experiment View Modal Styles (Tabbed Design)
       ========================================================================= */
    .exp-view-modal {
        width: 780px;
        max-width: 780px;
        height: 600px;
    }

    /* Header - Vertex Pipelines Style - 3 Column Layout */
    .exp-view-header {
        display: flex;
        align-items: stretch;
        gap: 0;
        padding: 0;
        border-radius: 12px 12px 0 0;
        background: white;
        overflow: hidden;
        min-height: 110px; /* Unified header height */
    }
    /* Column 1: Experiment Number (20%, centered) */
    .exp-view-header-number {
        width: 20%;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 16px;
    }
    .exp-view-title {
        font-size: 18px;
        font-weight: 700;
        color: #111827;
        margin: 0;
    }
    /* Column 2: Name, Description, Times (60%, left-aligned) */
    .exp-view-header-info {
        width: 60%;
        padding: 16px 24px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .exp-view-exp-name {
        font-size: 15px;
        font-weight: 600;
        color: #374151;
        margin: 0 0 4px;
    }
    .exp-view-description {
        font-size: 13px;
        color: #9ca3af;
        margin: 0 0 8px;
        /* Limit to 2 lines with ellipsis */
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        line-height: 1.4;
    }
    .exp-view-times {
        display: flex;
        gap: 24px;
        font-size: 13px;
        color: #9ca3af;
    }
    .exp-view-times span {
        color: #374151;
        font-weight: 500;
    }
    /* Column 3: Status Panel (20%, centered) */
    .exp-view-status-panel {
        width: 20%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .exp-view-status-panel.running {
        background: #dbeafe;
    }
    .exp-view-status-panel.submitting {
        background: #dbeafe;
    }
    .exp-view-status-panel.completed {
        background: #d1fae5;
    }
    .exp-view-status-panel.failed {
        background: #fee2e2;
    }
    .exp-view-status-panel.cancelled {
        background: #e5e7eb;
    }
    .exp-view-status-panel.pending {
        background: #e5e7eb;
    }
    /* Status Icon - Solid filled circle with white icon */
    .exp-view-status-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        flex-shrink: 0;
        color: white;
        font-weight: 600;
    }
    .exp-view-status-icon.running {
        background: #2563eb;
    }
    .exp-view-status-icon.submitting {
        background: #2563eb;
    }
    .exp-view-status-icon.completed {
        background: #16a34a;
    }
    .exp-view-status-icon.failed {
        background: #dc2626;
    }
    .exp-view-status-icon.cancelled {
        background: #6b7280;
    }
    .exp-view-status-icon.pending {
        background: #9ca3af;
    }

    /* Tabs - Pill Button Style (matching ETL page) */
    .exp-view-tabs {
        display: flex;
        gap: 8px;
        padding: 16px 24px;
        background: white;
        border-bottom: 1px solid #e5e7eb;
    }
    .exp-view-tab {
        flex: 1;
        padding: 10px 16px;
        font-size: 13px;
        font-weight: 600;
        color: #374151;
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.15s ease;
        text-align: center;
    }
    .exp-view-tab:hover {
        background: #f9fafb;
    }
    .exp-view-tab.active {
        background: #eff6ff;
        border-color: #2563eb;
        color: #1d4ed8;
    }

    /* Tab Content */
    .exp-view-body {
        overflow-y: auto;
        overflow-x: hidden;
        flex: 1;
        padding: 0;
    }
    .exp-view-tab-content {
        display: none;
        padding: 20px 24px;
    }
    .exp-view-tab-content.active {
        display: block;
    }

    /* Section Groups */
    .exp-view-section-group {
        margin-bottom: 24px;
    }
    .exp-view-section-group:last-child {
        margin-bottom: 0;
    }
    .exp-view-group-title {
        font-size: 11px;
        font-weight: 600;
        color: #9ca3af;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin: 0 0 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .exp-view-config-badges {
        display: flex;
        gap: 8px;
    }
    .exp-view-config-badge {
        font-size: 10px;
        font-weight: 500;
        padding: 2px 8px;
        border-radius: 4px;
        text-transform: none;
        letter-spacing: normal;
    }
    .exp-view-config-badge.feature {
        background: #dbeafe;
        color: #1d4ed8;
    }
    .exp-view-config-badge.model {
        background: #f3e8ff;
        color: #7c3aed;
    }
    .exp-view-loading {
        text-align: center;
        padding: 12px;
        color: #9ca3af;
        font-size: 12px;
    }
    .exp-view-dataset-details {
        font-size: 12px;
    }
    .exp-view-ds-section {
        margin-bottom: 12px;
    }
    .exp-view-ds-section:last-child {
        margin-bottom: 0;
    }
    .exp-view-ds-title {
        font-size: 12px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 6px;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .exp-view-ds-title i {
        color: #6b7280;
    }
    .exp-view-ds-grid {
        display: grid;
        grid-template-columns: 70px 1fr;
        gap: 2px 8px;
        font-size: 12px;
    }
    .exp-view-ds-grid .label {
        color: #9ca3af;
    }
    .exp-view-ds-grid .value {
        color: #374151;
    }
    .exp-view-ds-join {
        margin-top: 6px;
        padding-top: 6px;
        border-top: 1px solid #e5e7eb;
        font-size: 11px;
        color: #6b7280;
    }
    .exp-view-ds-join-row {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-top: 2px;
    }
    .exp-view-ds-join-row .key {
        color: #374151;
        font-weight: 500;
    }
    .exp-view-ds-join-row .badge {
        background: #e5e7eb;
        color: #6b7280;
        padding: 1px 6px;
        border-radius: 3px;
        font-size: 10px;
    }
    .exp-view-ds-filter {
        padding: 6px 0 6px 10px;
        border-left: 3px solid #e5e7eb;
        margin-bottom: 8px;
    }
    .exp-view-ds-filter:last-child {
        margin-bottom: 0;
    }
    .exp-view-ds-filter.date { border-left-color: #3b82f6; }
    .exp-view-ds-filter.customer { border-left-color: #22c55e; }
    .exp-view-ds-filter.product { border-left-color: #a855f7; }
    .exp-view-ds-filter-title {
        font-size: 12px;
        font-weight: 500;
        color: #374151;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .exp-view-ds-filter-title i.fa-calendar-alt { color: #3b82f6; }
    .exp-view-ds-filter-title i.fa-users { color: #22c55e; }
    .exp-view-ds-filter-title i.fa-box { color: #a855f7; }
    .exp-view-ds-filter-detail {
        font-size: 11px;
        color: #6b7280;
        margin-top: 2px;
    }
    .exp-view-ds-no-filters {
        font-size: 11px;
        color: #9ca3af;
    }

    /* Clean Rows Layout */
    .exp-view-rows {
        display: flex;
        flex-direction: column;
        gap: 0;
    }
    .exp-view-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #f3f4f6;
    }
    .exp-view-row:last-child {
        border-bottom: none;
    }
    .exp-view-row-label {
        font-size: 13px;
        color: #6b7280;
    }
    .exp-view-row-value {
        font-size: 13px;
        font-weight: 500;
        color: #111827;
    }

    /* Results Summary (Overview tab) - moved to top */
    .exp-view-results-summary {
        margin-bottom: 24px;
        padding-bottom: 20px;
        border-bottom: 1px solid #e5e7eb;
    }
    .exp-view-metrics-row {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
    }
    .exp-view-metric-card {
        text-align: center;
        padding: 12px 8px;
        background: #ffffff;
        border: 1px solid #1f2937;
        border-radius: 8px;
    }
    .exp-view-metric-card-label {
        font-size: 11px;
        color: #1f2937;
        font-weight: 500;
        margin-bottom: 4px;
    }
    .exp-view-metric-card-value {
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
    }

    /* Features Config (Tensor Visualization) */
    .exp-view-features-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }
    .exp-view-tensor-panel {
        padding: 16px;
        border-radius: 10px;
    }
    .exp-view-tensor-panel.buyer {
        background: #eff6ff;
    }
    .exp-view-tensor-panel.product {
        background: #ecfdf5;
    }
    .exp-view-tensor-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
    }
    .exp-view-tensor-title {
        font-size: 14px;
        font-weight: 600;
    }
    .exp-view-tensor-title.buyer {
        color: #1d4ed8;
    }
    .exp-view-tensor-title.product {
        color: #059669;
    }
    .exp-view-tensor-total {
        font-size: 14px;
        font-weight: 600;
    }
    .exp-view-tensor-total.buyer {
        color: #3b82f6;
    }
    .exp-view-tensor-total.product {
        color: #10b981;
    }
    .exp-view-tensor-bar {
        display: flex;
        height: 20px;
        border-radius: 5px;
        overflow: hidden;
        background: #e5e7eb;
        margin-bottom: 10px;
    }
    .exp-view-tensor-segment {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: 500;
        color: white;
        transition: width 0.3s ease;
        overflow: hidden;
        white-space: nowrap;
    }
    .exp-view-tensor-features {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    .exp-view-tensor-feature-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 12px;
    }
    .exp-view-tensor-feature-name {
        color: #374151;
    }
    .exp-view-tensor-feature-name.cross {
        font-style: italic;
    }
    .exp-view-tensor-feature-name.buyer {
        color: #1d4ed8;
    }
    .exp-view-tensor-feature-name.product {
        color: #059669;
    }
    .exp-view-tensor-feature-dim {
        font-weight: 500;
    }
    .exp-view-tensor-feature-dim.buyer {
        color: #3b82f6;
    }
    .exp-view-tensor-feature-dim.product {
        color: #10b981;
    }

    /* Model Config (Tower Architecture Visualization) */
    .exp-view-model-type-badge {
        display: inline-flex;
        align-items: center;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 16px;
    }
    .exp-view-model-type-badge.retrieval {
        background: #dbeafe;
        color: #1d4ed8;
    }
    .exp-view-model-type-badge.ranking {
        background: #fef3c7;
        color: #92400e;
    }
    .exp-view-model-type-badge.multitask {
        background: #f3e8ff;
        color: #7c3aed;
    }
    .exp-view-tower-section-title {
        font-size: 13px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 12px;
    }
    .exp-view-towers-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        margin-bottom: 16px;
    }
    .exp-view-tower-column {
        min-width: 0;
    }
    .exp-view-tower-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
    }
    .exp-view-tower-label {
        font-size: 10px;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .exp-view-tower-stack {
        display: flex;
        flex-direction: column;
        gap: 6px;
        border-radius: 10px;
        padding: 10px;
        border: 2px dashed;
        min-height: 80px;
    }
    .exp-view-tower-stack.buyer {
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        border-color: #3b82f6;
    }
    .exp-view-tower-stack.product {
        background: linear-gradient(135deg, #f0fdf4 0%, #d1fae5 100%);
        border-color: #10b981;
    }
    .exp-view-tower-stack.ranking {
        background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
        border-color: #8b5cf6;
    }
    .exp-view-layer-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 10px;
        background: white;
        border-radius: 6px;
        border: 1px solid rgba(0, 0, 0, 0.08);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
    }
    .exp-view-tower-stack.buyer .exp-view-layer-item {
        border-color: rgba(59, 130, 246, 0.2);
    }
    .exp-view-tower-stack.product .exp-view-layer-item {
        border-color: rgba(16, 185, 129, 0.2);
    }
    .exp-view-tower-stack.ranking .exp-view-layer-item {
        border-color: rgba(139, 92, 246, 0.2);
    }
    .exp-view-layer-item.output-layer {
        border: 2px solid #f87171;
    }
    .exp-view-layer-drag {
        color: #c4c4c4;
        font-size: 11px;
    }
    .exp-view-layer-badge {
        display: inline-flex;
        align-items: center;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 9px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        flex-shrink: 0;
    }
    .exp-view-layer-badge.dense {
        background: #e5e7eb;
        color: #374151;
    }
    .exp-view-layer-badge.dropout {
        background: #fef3c7;
        color: #92400e;
    }
    .exp-view-layer-badge.batch_norm,
    .exp-view-layer-badge.layer_norm {
        background: #f3e8ff;
        color: #7c3aed;
    }
    .exp-view-layer-params {
        font-size: 11px;
        color: #4b5563;
    }
    .exp-view-tower-params {
        margin-top: 8px;
        padding: 8px 10px;
        border-radius: 6px;
        border: 2px dashed;
        font-size: 11px;
        font-family: 'SF Mono', Monaco, monospace;
    }
    .exp-view-tower-params.buyer {
        border-color: #93c5fd;
        background: #eff6ff;
    }
    .exp-view-tower-params.product {
        border-color: #6ee7b7;
        background: #ecfdf5;
    }
    .exp-view-tower-params.ranking {
        border-color: #c4b5fd;
        background: #f5f3ff;
    }
    .exp-view-tower-params-row {
        display: flex;
        justify-content: space-between;
        padding: 2px 0;
    }
    .exp-view-tower-params-row span:first-child {
        color: #6b7280;
    }
    .exp-view-tower-params-row span:last-child {
        font-weight: 500;
        color: #374151;
    }
    .exp-view-training-params {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 16px;
    }
    .exp-view-param-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        font-size: 12px;
    }
    .exp-view-param-chip-label {
        color: #6b7280;
    }
    .exp-view-param-chip-value {
        font-weight: 600;
        color: #111827;
    }
    .exp-view-rating-head-section {
        margin-top: 16px;
    }
    .exp-view-rating-head-title {
        font-size: 13px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
    }
    .exp-view-rating-head-label {
        font-size: 10px;
        font-weight: 600;
        color: #8b5cf6;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
    }
    .exp-view-rating-tower-wrapper {
        max-width: 280px;
    }

    /* Pipeline Tab Styles */
    .exp-view-progress-section {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
    }
    .exp-view-progress-bar-container {
        flex: 1;
        height: 8px;
        background: #e5e7eb;
        border-radius: 4px;
        overflow: hidden;
    }
    .exp-view-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%);
        border-radius: 4px;
        transition: width 0.3s ease;
    }
    .exp-view-progress-text {
        font-size: 13px;
        font-weight: 600;
        color: #374151;
        min-width: 40px;
    }

    /* Pipeline DAG styles moved to static/css/pipeline_dag.css */

    /* Component Detail Panel */
    .exp-view-component-detail {
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        margin-bottom: 16px;
        overflow: hidden;
    }
    .exp-view-component-header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        background: #f9fafb;
        border-bottom: 1px solid #e5e7eb;
    }
    .exp-view-component-name {
        font-size: 14px;
        font-weight: 600;
        color: #111827;
    }
    .exp-view-component-status {
        font-size: 11px;
        padding: 3px 8px;
        border-radius: 4px;
        font-weight: 500;
    }
    .exp-view-component-status.completed {
        background: #dcfce7;
        color: #166534;
    }
    .exp-view-component-status.running {
        background: #dbeafe;
        color: #1e40af;
    }
    .exp-view-component-status.failed {
        background: #fee2e2;
        color: #991b1b;
    }
    .exp-view-component-status.pending {
        background: #f3f4f6;
        color: #6b7280;
    }
    .exp-view-component-duration {
        margin-left: auto;
        font-size: 12px;
        color: #6b7280;
    }
    .exp-view-component-duration i {
        margin-right: 4px;
    }
    .exp-view-logs-section {
        padding: 12px 16px;
    }
    .exp-view-logs-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 10px;
    }
    .exp-view-logs-header span {
        font-size: 12px;
        font-weight: 600;
        color: #374151;
    }
    .exp-view-refresh-btn {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        background: #f3f4f6;
        border: 1px solid #e5e7eb;
        border-radius: 5px;
        font-size: 11px;
        color: #374151;
        cursor: pointer;
        transition: all 0.15s ease;
    }
    .exp-view-refresh-btn:hover {
        background: #e5e7eb;
    }
    .exp-view-refresh-btn.loading i {
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    .exp-view-logs-container {
        background: #1e1e1e;
        border-radius: 6px;
        padding: 12px;
        max-height: 200px;
        overflow-y: auto;
        font-family: 'SF Mono', Monaco, 'Courier New', monospace;
        font-size: 11px;
        line-height: 1.5;
    }
    .exp-view-logs-container::-webkit-scrollbar {
        width: 6px;
    }
    .exp-view-logs-container::-webkit-scrollbar-thumb {
        background: #4b5563;
        border-radius: 3px;
    }
    .exp-view-log-entry {
        display: flex;
        gap: 8px;
        margin-bottom: 4px;
    }
    .exp-view-log-entry:last-child {
        margin-bottom: 0;
    }
    .exp-view-log-time {
        color: #6b7280;
        flex-shrink: 0;
    }
    .exp-view-log-severity {
        flex-shrink: 0;
        min-width: 50px;
    }
    .exp-view-log-severity.INFO { color: #60a5fa; }
    .exp-view-log-severity.WARNING { color: #fbbf24; }
    .exp-view-log-severity.ERROR { color: #f87171; }
    .exp-view-log-severity.DEBUG { color: #9ca3af; }
    .exp-view-log-message {
        color: #e5e7eb;
        word-break: break-word;
    }
    .exp-view-logs-empty {
        color: #6b7280;
        text-align: center;
        padding: 20px;
    }
    .exp-view-logs-error {
        color: #f87171;
        padding: 8px;
    }

    /* Error Box */
    .exp-view-error-box {
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 10px;
        padding: 16px;
        margin-top: 8px;
    }
    .exp-view-error-box .exp-view-error-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
    }
    .exp-view-error-box .exp-view-error-header i {
        color: #dc2626;
        font-size: 18px;
    }
    .exp-view-error-box .exp-view-error-header span {
        font-size: 14px;
        font-weight: 600;
        color: #991b1b;
    }
    .exp-view-error-suggestion {
        font-size: 13px;
        color: #b91c1c;
        margin: 0 0 12px;
        padding-left: 28px;
        line-height: 1.5;
    }
    .exp-view-error-details {
        border-top: 1px solid #fecaca;
        padding-top: 12px;
    }
    .exp-view-error-toggle {
        display: flex;
        align-items: center;
        gap: 8px;
        background: none;
        border: none;
        color: #991b1b;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        padding: 0;
    }
    .exp-view-error-toggle:hover {
        color: #7f1d1d;
    }
    .exp-view-error-toggle i {
        font-size: 10px;
        transition: transform 0.2s ease;
    }
    .exp-view-error-toggle i.expanded {
        transform: rotate(180deg);
    }
    .exp-view-error-content {
        margin-top: 12px;
    }
    .exp-view-error-content pre {
        background: #fff5f5;
        border: 1px solid #fecaca;
        border-radius: 6px;
        padding: 12px;
        font-size: 11px;
        font-family: 'SF Mono', Monaco, 'Courier New', monospace;
        color: #991b1b;
        overflow-x: auto;
        white-space: pre-wrap;
        word-break: break-word;
        max-height: 200px;
        overflow-y: auto;
        margin: 0;
    }

    /* Loading State - Full tab centering */
    .exp-view-tab-content > .exp-view-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 300px;
        height: 100%;
        padding: 48px 24px;
        color: #6b7280;
        gap: 12px;
    }
    .exp-view-tab-content > .exp-view-loading.hidden {
        display: none !important;
    }
    .exp-view-tab-content > .exp-view-loading i {
        font-size: 28px;
        color: #3b82f6;
    }
    .exp-view-tab-content > .exp-view-loading span {
        font-size: 14px;
    }

    /* Data Message */
    .exp-view-data-message {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 48px 24px;
        color: #9ca3af;
        gap: 8px;
        text-align: center;
    }
    .exp-view-data-message i {
        font-size: 24px;
    }
    .exp-view-data-message span {
        font-size: 13px;
    }

    /* Chart Placeholder */
    .exp-view-chart-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 48px 24px;
        background: #f9fafb;
        border: 1px dashed #d1d5db;
        border-radius: 8px;
        color: #9ca3af;
        text-align: center;
    }
    .exp-view-chart-placeholder i {
        font-size: 32px;
        margin-bottom: 12px;
    }
    .exp-view-chart-placeholder p {
        font-size: 13px;
        margin: 0;
        max-width: 280px;
    }

    /* Training Charts */
    .training-charts-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
    }
    @media (max-width: 768px) {
        .training-charts-container {
            grid-template-columns: 1fr;
        }
    }
    .training-chart-wrapper {
        background: #ffffff;
        border: 1px solid #000000;
        border-radius: 8px;
        padding: 8px;
    }
    .training-chart-title {
        font-size: 13px;
        font-weight: 600;
        color: #374151;
        margin: 0 0 4px 0;
    }
    .training-chart-wrapper canvas {
        max-height: 170px;
    }
    /* Override for weight histogram - ridgeline chart container */
    #trainingWeightHistogramChart {
        position: relative;
        height: 250px;
        min-height: 250px;
        width: 100%;
    }
    #trainingWeightHistogramChart canvas {
        display: block;
        max-height: none !important;
    }

    /* Final Metrics Table */
    .final-metrics-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
    }
    .final-metrics-table th {
        text-align: left;
        padding: 8px 12px;
        font-size: 11px;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-bottom: 2px solid #e5e7eb;
    }
    .final-metrics-table th:not(:first-child) {
        text-align: right;
    }
    .final-metrics-table td {
        padding: 10px 12px;
        border-bottom: 1px solid #f3f4f6;
    }
    .final-metrics-table td:first-child {
        font-weight: 500;
        color: #374151;
    }
    .final-metrics-table td:not(:first-child) {
        text-align: right;
        font-family: 'SF Mono', Monaco, 'Courier New', monospace;
        font-size: 13px;
    }
    .final-metrics-table .val-train {
        color: #1d4ed8;
    }
    .final-metrics-table .val-val {
        color: #047857;
    }
    .final-metrics-table .val-test {
        color: #b45309;
        font-weight: 600;
    }
    .final-metrics-table tr:last-child td {
        border-bottom: none;
    }

    /* Weight Stats Controls */
    .weight-stats-controls {
        margin-bottom: 8px;
    }
    .weight-stats-select {
        padding: 4px 8px;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        font-size: 12px;
        background: white;
        cursor: pointer;
        width: 130px;
        min-width: 130px;
    }
    .weight-stats-select:focus {
        outline: none;
        border-color: #3b82f6;
    }

    /* Comparison Table */
    .compare-table-wrapper {
        overflow-x: auto;
    }
    .compare-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
        table-layout: fixed;
    }
    .compare-table th,
    .compare-table td {
        padding: 10px 12px;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
        word-wrap: break-word;
    }
    .compare-table th {
        background: #f9fafb;
        font-weight: 600;
        color: #374151;
    }
    .compare-table th:first-child,
    .compare-table td:first-child {
        width: 40%;
    }
    .compare-table td:first-child {
        background: white;
        font-weight: 500;
        color: #6b7280;
    }
    .compare-table tbody tr:hover td {
        background: #f9fafb;
    }
    .compare-table tbody tr:hover td:first-child {
        background: #f3f4f6;
    }
    .compare-value-best {
        color: #10b981;
        font-weight: 600;
    }
    .compare-value-worst {
        color: #ef4444;
    }
    .compare-exp-header {
        min-width: 120px;
        text-align: center;
    }
    .compare-exp-name {
        font-weight: 600;
        color: #111827;
    }
    .compare-exp-subtext {
        font-size: 11px;
        color: #9ca3af;
        font-weight: normal;
    }

    /* Comparison Selection List */
    .compare-select-row {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        border-bottom: 1px solid rgba(0,0,0,0.08);
        cursor: pointer;
        transition: background-color 0.15s ease;
    }
    .compare-select-row:nth-child(odd) {
        border-right: 1px solid rgba(0,0,0,0.08);
    }
    .compare-select-row:nth-last-child(-n+2) {
        border-bottom: none;
    }
    /* Status-based row backgrounds */
    .compare-select-row.status-completed {
        background: #ecfdf5;
    }
    .compare-select-row.status-completed:hover {
        background: #d1fae5;
    }
    .compare-select-row.status-completed.selected {
        background: #a7f3d0;
    }
    .compare-select-row.status-failed {
        background: #fef2f2;
    }
    .compare-select-row.status-failed:hover {
        background: #fee2e2;
    }
    .compare-select-row.status-failed.selected {
        background: #fecaca;
    }
    .compare-select-row.status-cancelled {
        background: #f9fafb;
    }
    .compare-select-row.status-cancelled:hover {
        background: #f3f4f6;
    }
    .compare-select-row.status-cancelled.selected {
        background: #e5e7eb;
    }
    .compare-select-row.status-running {
        background: #eff6ff;
    }
    .compare-select-row.status-running:hover {
        background: #dbeafe;
    }
    .compare-select-row.status-running.selected {
        background: #bfdbfe;
    }
    .compare-select-row.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .compare-select-checkbox {
        width: 18px;
        height: 18px;
        margin-right: 12px;
        accent-color: #f59e0b;
        cursor: pointer;
    }
    .compare-select-info-col {
        flex: 1;
        min-width: 0;
    }
    .compare-select-exp-num {
        font-weight: 600;
        font-size: 14px;
        color: #111827;
    }
    .compare-select-exp-name {
        font-size: 13px;
        color: #374151;
        margin-left: 8px;
    }
    .compare-select-desc {
        font-size: 12px;
        color: #9ca3af;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-top: 2px;
    }
    .compare-select-status {
        font-size: 12px;
        font-weight: 600;
        text-transform: capitalize;
        min-width: 70px;
        text-align: right;
    }
    .compare-select-status.completed {
        color: #059669;
    }
    .compare-select-status.failed {
        color: #dc2626;
    }
    .compare-select-status.cancelled {
        color: #6b7280;
    }
    .compare-select-status.running {
        color: #2563eb;
    }
    .compare-select-metric {
        font-size: 14px;
        font-weight: 600;
        color: #059669;
        min-width: 60px;
        text-align: right;
    }
    .compare-select-metric.na {
        color: #9ca3af;
        font-weight: normal;
    }

    /* Comparison Table Enhancements */
    .compare-table-unified {
        border-collapse: collapse;
        width: 100%;
    }
    .compare-table-unified th,
    .compare-table-unified td {
        border: 1px solid #e5e7eb;
    }
    /* Main section headers (white background, larger text) */
    .compare-main-section-header {
        background: #ffffff !important;
    }
    .compare-main-section-header td {
        padding: 16px 12px !important;
        background: #ffffff !important;
        font-weight: 700;
        font-size: 14px;
        color: #374151;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-left: none !important;
        border-right: none !important;
    }
    /* Subsection headers (gray background) */
    .compare-section-header {
        background: #f3f4f6 !important;
        font-weight: 700;
        text-transform: uppercase;
        font-size: 11px;
        letter-spacing: 0.05em;
        color: #6b7280;
    }
    .compare-section-header td {
        padding: 8px 12px !important;
        background: #f3f4f6 !important;
    }
    .compare-indicator {
        display: inline-block;
        margin-left: 6px;
        font-size: 11px;
    }
    .compare-indicator.identical {
        color: #9ca3af;
    }
    .compare-indicator.different {
        color: #f59e0b;
    }
    .compare-value-best {
        color: #10b981;
        font-weight: 600;
    }
    .compare-value-best::after {
        content: ' ';
        font-size: 10px;
    }
    .compare-value-na {
        color: #9ca3af;
        font-style: italic;
    }
    .compare-row-identical td {
        background: #f0fdf4 !important;
    }
    .compare-row-different td:not(:first-child) {
        background: #fffbeb !important;
    }

    /* Statistics Table */
    .exp-view-stats-summary {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
        margin-bottom: 16px;
    }
    .exp-view-stat-box {
        background: #f9fafb;
        border-radius: 8px;
        padding: 12px;
        text-align: center;
        min-width: 0;
    }
    .exp-view-stat-box-value {
        font-size: 20px;
        font-weight: 600;
        color: #111827;
    }
    .exp-view-stat-box-label {
        font-size: 11px;
        color: #6b7280;
        margin-top: 2px;
    }
    .exp-view-features-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
    }
    .exp-view-features-table th {
        text-align: left;
        padding: 8px 12px;
        background: #f9fafb;
        font-weight: 600;
        color: #374151;
        border-bottom: 1px solid #e5e7eb;
    }
    .exp-view-features-table td {
        padding: 8px 12px;
        border-bottom: 1px solid #f3f4f6;
        color: #374151;
    }
    .exp-view-features-table tr:last-child td {
        border-bottom: none;
    }
    .exp-view-features-table .type-tag {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 500;
    }
    .exp-view-features-table .type-tag.numeric {
        background: #dbeafe;
        color: #1d4ed8;
    }
    .exp-view-features-table .type-tag.categorical {
        background: #f3e8ff;
        color: #7c3aed;
    }
    .exp-view-features-table .type-tag.unknown {
        background: #f3f4f6;
        color: #6b7280;
    }

    /* =========================================================================
       TFDV Rich Statistics Styles
       ========================================================================= */
    .exp-view-group-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }
    .exp-view-group-header .exp-view-group-title {
        margin-bottom: 0;
    }
    .exp-view-tfdv-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background: #4f46e5;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
    }
    .exp-view-tfdv-btn:hover {
        background: #4338ca;
    }
    .exp-view-feature-count {
        font-size: 12px;
        color: #6b7280;
        font-weight: normal;
        margin-left: 8px;
    }

    /* TFDV Table Styles */
    .tfdv-table-container {
        overflow-x: auto;
        margin-top: 12px;
    }
    .tfdv-features-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
    }
    .tfdv-features-table th {
        text-align: left;
        padding: 8px 10px;
        background: #f8fafc;
        border-bottom: 2px solid #e2e8f0;
        font-weight: 600;
        color: #475569;
        white-space: nowrap;
    }
    .tfdv-features-table td {
        padding: 8px 10px;
        border-bottom: 1px solid #e2e8f0;
        vertical-align: middle;
    }
    .tfdv-features-table tr:hover {
        background: #f8fafc;
    }
    .tfdv-features-table .feature-name {
        font-weight: 500;
        color: #1e293b;
        max-width: 150px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .tfdv-features-table .top-values-cell {
        max-width: 180px;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .tfdv-features-table .top-value {
        background: #f1f5f9;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 11px;
    }
    .tfdv-features-table .no-data {
        color: #9ca3af;
    }

    /* Mini Histogram (vertical bars) */
    .mini-histogram {
        display: flex;
        align-items: flex-end;
        gap: 1px;
        height: 24px;
        min-width: 60px;
    }
    .mini-bar {
        width: 5px;
        background: #60a5fa;
        border-radius: 1px 1px 0 0;
        transition: background 0.2s;
    }
    .mini-bar:hover {
        background: #3b82f6;
    }

    /* Mini Horizontal Bar Chart */
    .mini-hbar-chart {
        display: flex;
        flex-direction: column;
        gap: 2px;
        min-width: 60px;
    }
    .mini-hbar {
        height: 4px;
        background: #a78bfa;
        border-radius: 2px;
        transition: background 0.2s;
    }
    .mini-hbar:hover {
        background: #8b5cf6;
    }

    /* =========================================================================
       Toast Notification Styles
       ========================================================================= */
    .toast-container {
        position: fixed;
        top: 24px;
        right: 24px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 12px;
        pointer-events: none;
    }
    .toast {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15), 0 2px 10px rgba(0, 0, 0, 0.1);
        pointer-events: auto;
        animation: toastSlideIn 0.3s ease-out;
        max-width: 400px;
        border-left: 4px solid;
    }
    .toast.success {
        border-left-color: #10b981;
    }
    .toast.error {
        border-left-color: #ef4444;
    }
    .toast-icon {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    .toast.success .toast-icon {
        background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
        color: white;
    }
    .toast.error .toast-icon {
        background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
        color: white;
    }
    .toast-content {
        flex: 1;
        min-width: 0;
    }
    .toast-title {
        font-size: 14px;
        font-weight: 600;
        color: #111827;
        margin-bottom: 2px;
    }
    .toast-message {
        font-size: 13px;
        color: #6b7280;
        line-height: 1.4;
    }
    .toast-close {
        width: 28px;
        height: 28px;
        border-radius: 6px;
        border: none;
        background: transparent;
        color: #9ca3af;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: all 0.15s ease;
    }
    .toast-close:hover {
        background: #f3f4f6;
        color: #374151;
    }
    @keyframes toastSlideIn {
        from {
            opacity: 0;
            transform: translateX(100%);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    @keyframes toastSlideOut {
        from {
            opacity: 1;
            transform: translateX(0);
        }
        to {
            opacity: 0;
            transform: translateX(100%);
        }
    }
    .toast.hiding {
        animation: toastSlideOut 0.2s ease-in forwards;
    }

    /* =========================================================================
       Experiments Dashboard Chapter Styles
       ========================================================================= */
    .chapter-icon.dashboard {
        background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
    }
    .chapter-subtitle {
        font-size: 13px;
        color: #6b7280;
        margin-top: 2px;
    }

    /* Dashboard Summary Cards */
    .dashboard-summary {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
        margin-bottom: 24px;
    }
    @media (max-width: 768px) {
        .dashboard-summary {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    .dashboard-card {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 16px;
        text-align: center;
    }
    .dashboard-card-value {
        font-size: 28px;
        font-weight: 700;
        color: #111827;
        line-height: 1.2;
    }
    .dashboard-card-value.highlight {
        color: #10b981;
    }
    .dashboard-card-label {
        font-size: 12px;
        color: #6b7280;
        margin-top: 4px;
        font-weight: 500;
    }

    /* Dashboard Section */
    .dashboard-section {
        margin-bottom: 24px;
    }
    .dashboard-section:last-child {
        margin-bottom: 0;
    }
    .dashboard-section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 1px solid #e5e7eb;
    }
    .dashboard-section-title {
        font-size: 14px;
        font-weight: 600;
        color: #374151;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .dashboard-section-controls {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .dashboard-select {
        padding: 4px 8px;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        font-size: 12px;
        background: white;
    }
    .dashboard-select:focus {
        outline: none;
        border-color: #3b82f6;
    }

    /* Leaderboard Table */
    .leaderboard-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
    }
    .leaderboard-table th,
    .leaderboard-table td {
        padding: 10px 12px;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
    }
    .leaderboard-table th {
        background: #f9fafb;
        font-weight: 600;
        color: #374151;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .leaderboard-table tbody tr {
        cursor: pointer;
        transition: background 0.15s ease;
    }
    .leaderboard-table tbody tr:hover {
        background: #f3f4f6;
    }
    .leaderboard-rank {
        width: 40px;
        text-align: center;
        font-weight: 600;
        color: #6b7280;
    }
    .leaderboard-rank-1 {
        color: #f59e0b;
    }
    .leaderboard-rank-2 {
        color: #9ca3af;
    }
    .leaderboard-rank-3 {
        color: #b45309;
    }
    .leaderboard-exp-name {
        font-weight: 500;
        color: #111827;
    }
    .leaderboard-config {
        color: #6b7280;
        font-size: 12px;
    }
    .leaderboard-metric {
        font-weight: 600;
        color: #111827;
    }
    .leaderboard-metric.best {
        color: #10b981;
    }
    .leaderboard-empty {
        text-align: center;
        padding: 32px;
        color: #9ca3af;
    }

    /* Heatmap Container */
    .heatmap-container {
        position: relative;
        min-height: 300px;
    }
    .heatmap-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 300px;
        color: #9ca3af;
        text-align: center;
    }
    .heatmap-empty i {
        font-size: 48px;
        margin-bottom: 12px;
        opacity: 0.5;
    }
    .heatmap-legend {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 16px;
        margin-top: 12px;
        font-size: 11px;
        color: #6b7280;
    }
    .heatmap-legend-item {
        display: flex;
        align-items: center;
        gap: 4px;
    }
    .heatmap-legend-color {
        width: 16px;
        height: 12px;
        border-radius: 2px;
    }

    /* Dashboard Loading State */
    .dashboard-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 48px;
        color: #9ca3af;
    }
    .dashboard-loading i {
        margin-right: 8px;
    }
</style>
{% endblock %}

{% block model_content %}
<!-- Toast Notification Container -->
<div id="toastContainer" class="toast-container"></div>

<div class="space-y-6">

    <!-- Quick Test Chapter -->
    <div class="chapter-section">
        <div class="chapter-header">
            <div class="chapter-icon quick-test">
                <i class="fas fa-bolt"></i>
            </div>
            <h2 class="chapter-title">Quick Test</h2>
            <div class="ml-auto" style="display: flex; gap: 8px;">
                <button onclick="openCompareSelectModal()" class="btn btn-secondary btn-sm" id="compareBtn" style="width: 150px;">
                    <i class="fas fa-columns mr-1"></i>Compare
                </button>
                <button onclick="openNewExpWizard()" class="btn btn-primary btn-sm" style="width: 150px;">
                    <i class="fas fa-plus mr-1"></i>New Exp
                </button>
            </div>
        </div>

        <!-- Filter Bar -->
        <div id="expFilterBar" class="exp-filter-bar hidden">
            <div class="exp-filter-group">
                <label class="exp-filter-label">Status:</label>
                <select id="expStatusFilter" class="exp-filter-select" onchange="filterExperiments()">
                    <option value="">All</option>
                    <option value="running">Running</option>
                    <option value="completed">Completed</option>
                    <option value="failed">Failed</option>
                    <option value="cancelled">Cancelled</option>
                </select>
            </div>
            <div class="exp-filter-group">
                <label class="exp-filter-label">Feature:</label>
                <select id="expFeatureFilter" class="exp-filter-select" onchange="filterExperiments()">
                    <option value="">All Features</option>
                </select>
            </div>
            <div class="exp-filter-group">
                <label class="exp-filter-label">Model:</label>
                <select id="expModelFilter" class="exp-filter-select" onchange="filterExperiments()">
                    <option value="">All Models</option>
                </select>
            </div>
            <input type="text" id="expSearchInput" class="exp-search-input"
                   placeholder="Search experiments..." onkeyup="debounceExpSearch()">
        </div>

        <!-- Content Area -->
        <div id="quickTestContent">
            <!-- Loading state -->
            <div id="expLoading" class="flex items-center justify-center py-8">
                <i class="fas fa-spinner fa-spin text-xl text-gray-400 mr-3"></i>
                <span class="text-gray-500">Loading experiments...</span>
            </div>

            <!-- Empty state (no experiments) -->
            <div id="expEmpty" class="chapter-empty-state hidden">
                <i class="fas fa-flask chapter-empty-icon"></i>
                <p class="chapter-empty-text">No experiments yet</p>
                <p class="text-sm text-gray-400 mt-2">Run your first experiment to test feature and model configurations</p>
                <button onclick="openNewExpWizard()" class="btn btn-primary btn-sm mt-4">
                    <i class="fas fa-plus mr-1"></i>New Experiment
                </button>
            </div>

            <!-- No configs state -->
            <div id="expNoConfigs" class="chapter-empty-state hidden">
                <i class="fas fa-exclamation-circle chapter-empty-icon"></i>
                <p class="chapter-empty-text">No configurations available</p>
                <p class="text-sm text-gray-400 mt-2">Create feature and model configs on the Configs page first</p>
                <a href="{% url 'model_configs' model.id %}" class="btn btn-primary btn-sm mt-4">
                    <i class="fas fa-arrow-left mr-1"></i>Go to Configs
                </a>
            </div>

            <!-- Experiments List -->
            <div id="expList" class="hidden">
                <div id="expCardsContainer" class="exp-cards-container">
                    <!-- Experiment cards rendered here by JavaScript -->
                </div>

                <!-- Pagination -->
                <div id="expPagination" class="exp-pagination hidden">
                    <div class="exp-pagination-info">
                        Showing <span id="expShowingStart">1</span>-<span id="expShowingEnd">10</span> of <span id="expTotalCount">0</span>
                    </div>
                    <div class="exp-pagination-buttons" id="expPaginationButtons">
                        <!-- Pagination buttons rendered by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- =========================================================================
         Experiments Dashboard Chapter
         ========================================================================= -->
    <div class="chapter-section" id="experimentsDashboard">
        <div class="chapter-header">
            <div class="chapter-icon dashboard">
                <i class="fas fa-chart-bar"></i>
            </div>
            <div>
                <h2 class="chapter-title">Experiments Dashboard</h2>
                <p class="chapter-subtitle">Analyze and compare experiment results</p>
            </div>
        </div>

        <!-- Loading State -->
        <div id="dashboardLoading" class="dashboard-loading">
            <i class="fas fa-spinner fa-spin"></i>
            <span>Loading dashboard...</span>
        </div>

        <!-- Dashboard Content (hidden until loaded) -->
        <div id="dashboardContent" class="hidden">
            <!-- Summary Cards -->
            <div class="dashboard-summary">
                <div class="dashboard-card">
                    <div class="dashboard-card-value" id="dashboardTotalExp">-</div>
                    <div class="dashboard-card-label">Total Experiments</div>
                </div>
                <div class="dashboard-card">
                    <div class="dashboard-card-value" id="dashboardCompleted">-</div>
                    <div class="dashboard-card-label">Completed</div>
                </div>
                <div class="dashboard-card">
                    <div class="dashboard-card-value highlight" id="dashboardBestRecall">-</div>
                    <div class="dashboard-card-label">Best Recall@100</div>
                </div>
                <div class="dashboard-card">
                    <div class="dashboard-card-value" id="dashboardAvgRecall">-</div>
                    <div class="dashboard-card-label">Avg Recall@100</div>
                </div>
            </div>

            <!-- Leaderboard Section -->
            <div class="dashboard-section">
                <div class="dashboard-section-header">
                    <span class="dashboard-section-title">Leaderboard</span>
                    <div class="dashboard-section-controls">
                        <label class="text-xs text-gray-500 mr-1">Sort by:</label>
                        <select id="leaderboardMetricSelect" class="dashboard-select" onchange="loadLeaderboard()">
                            <option value="recall_at_100">Recall@100</option>
                            <option value="recall_at_50">Recall@50</option>
                            <option value="recall_at_10">Recall@10</option>
                            <option value="loss">Loss (lowest)</option>
                        </select>
                    </div>
                </div>
                <div id="leaderboardContainer">
                    <table class="leaderboard-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;">#</th>
                                <th>Experiment</th>
                                <th>Feature Config</th>
                                <th>Model Config</th>
                                <th style="text-align: right;">Recall@100</th>
                                <th style="text-align: right;">Recall@50</th>
                                <th style="text-align: right;">Loss</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboardBody">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Heatmap Section -->
            <div class="dashboard-section">
                <div class="dashboard-section-header">
                    <span class="dashboard-section-title">Configuration Heatmap</span>
                    <div class="dashboard-section-controls">
                        <label class="text-xs text-gray-500 mr-1">Metric:</label>
                        <select id="heatmapMetricSelect" class="dashboard-select" onchange="loadHeatmap()">
                            <option value="recall_at_100">Recall@100</option>
                            <option value="recall_at_50">Recall@50</option>
                            <option value="recall_at_10">Recall@10</option>
                        </select>
                    </div>
                </div>
                <div class="heatmap-container" id="heatmapContainer">
                    <canvas id="heatmapCanvas"></canvas>
                </div>
                <div class="heatmap-legend" id="heatmapLegend">
                    <div class="heatmap-legend-item">
                        <div class="heatmap-legend-color" style="background: #10b981;"></div>
                        <span>High</span>
                    </div>
                    <div class="heatmap-legend-item">
                        <div class="heatmap-legend-color" style="background: #fbbf24;"></div>
                        <span>Medium</span>
                    </div>
                    <div class="heatmap-legend-item">
                        <div class="heatmap-legend-color" style="background: #ef4444;"></div>
                        <span>Low</span>
                    </div>
                    <div class="heatmap-legend-item">
                        <div class="heatmap-legend-color" style="background: #e5e7eb;"></div>
                        <span>No data</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Empty State (no completed experiments) -->
        <div id="dashboardEmpty" class="chapter-empty-state hidden">
            <i class="fas fa-chart-pie chapter-empty-icon"></i>
            <p class="chapter-empty-text">No completed experiments yet</p>
            <p class="text-sm text-gray-400 mt-2">Run some experiments to see analytics</p>
        </div>
    </div>

</div>

<!-- ============================================================================
     NEW EXPERIMENT WIZARD MODAL
     ============================================================================ -->
<div id="newExpWizardModal" class="modal-overlay hidden">
    <div class="modal-container modal-container-wizard" style="max-width: 800px;">
        <!-- Modal Header -->
        <div class="modal-header-wizard">
            <div class="modal-header-content">
                <div class="modal-header-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);">
                    <i class="fas fa-flask text-lg text-white"></i>
                </div>
                <div class="modal-header-info">
                    <h3 class="modal-header-title">New Experiment</h3>
                    <p class="modal-step-counter">Step <span id="wizardCurrentStep">1</span> of 2</p>
                </div>
            </div>
            <div class="progress-bar-pills">
                <div id="wizardProgress1" class="progress-step-pill current">Select Configs</div>
                <div id="wizardProgress2" class="progress-step-pill future">Training Params</div>
            </div>
        </div>

        <!-- Modal Body -->
        <div id="wizardModalBody" class="modal-body-wizard" style="max-height: calc(90vh - 200px); overflow-y: auto;">
            <!-- Step 1: Select Configurations -->
            <div id="wizardStep1" class="wizard-step active">
                <!-- Experiment Metadata -->
                <div class="mb-6 pb-6 border-b border-gray-200">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Experiment Name <span class="text-gray-400 font-normal">(optional)</span></label>
                        <input type="text" id="wizardExpName" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500" placeholder="e.g., Baseline with new features">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description <span class="text-gray-400 font-normal">(optional)</span></label>
                        <textarea id="wizardExpDescription" rows="3" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 resize-y" placeholder="Describe the purpose of this experiment..."></textarea>
                    </div>
                </div>

                <!-- Feature Config Selection -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Feature Config</label>
                    <select id="wizardFeatureSelect" class="w-64 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500" onchange="onWizardFeatureChange()">
                        <option value="">-- Select Feature Config --</option>
                    </select>
                </div>

                <!-- Feature Config Preview -->
                <div id="wizardFeaturePreview" class="config-preview-panel feature hidden">
                    <!-- Loading indicator -->
                    <div id="wizardFeatureLoading" class="text-center py-4 hidden">
                        <i class="fas fa-spinner fa-spin text-blue-500 text-xl"></i>
                        <p class="text-sm text-gray-500 mt-2">Loading feature config details...</p>
                    </div>
                    <!-- Content container -->
                    <div id="wizardFeatureContent">
                        <div class="mb-3">
                            <div class="text-sm text-gray-500">Dataset: <span class="font-medium text-gray-700" id="wizardFeatureDataset">-</span></div>
                        </div>
                        <!-- Dataset Source Info -->
                        <div id="wizardDatasetInfo"></div>
                        <!-- Tensor Breakdown Grid -->
                        <div class="grid grid-cols-2 gap-4">
                            <div class="p-4 bg-blue-50 rounded-lg">
                                <div class="flex items-center justify-between mb-3">
                                    <h4 class="font-semibold text-blue-800">Buyer Tensor</h4>
                                    <span class="font-semibold text-blue-600" id="wizardBuyerDim">0D</span>
                                </div>
                                <div id="wizardBuyerBar" class="tensor-breakdown-bar mb-3"></div>
                                <div id="wizardBuyerFeatures" class="space-y-1">
                                    <!-- Features listed here -->
                                </div>
                            </div>
                            <div class="p-4 bg-green-50 rounded-lg">
                                <div class="flex items-center justify-between mb-3">
                                    <h4 class="font-semibold text-green-800">Product Tensor</h4>
                                    <span class="font-semibold text-green-600" id="wizardProductDim">0D</span>
                                </div>
                                <div id="wizardProductBar" class="tensor-breakdown-bar mb-3"></div>
                                <div id="wizardProductFeatures" class="space-y-1">
                                    <!-- Features listed here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="wizardFeatureEmpty" class="config-preview-panel feature">
                    <div class="config-preview-empty">
                        <i class="fas fa-cube text-2xl mb-2"></i>
                        <p>Select a Feature Config to see details</p>
                    </div>
                </div>

                <!-- Model Config Selection -->
                <div class="mb-4 mt-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Model Config</label>
                    <select id="wizardModelSelect" class="w-64 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500" onchange="onWizardModelChange()">
                        <option value="">-- Select Model Config --</option>
                    </select>
                </div>

                <!-- Model Config Preview -->
                <div id="wizardModelPreview" class="config-preview-panel model hidden">
                    <!-- Loading indicator -->
                    <div id="wizardModelLoading" class="text-center py-4 hidden">
                        <i class="fas fa-spinner fa-spin text-purple-500 text-xl"></i>
                        <p class="text-sm text-gray-500 mt-2">Loading model config details...</p>
                    </div>
                    <!-- Content container -->
                    <div id="wizardModelContent">
                        <!-- Tower Architecture -->
                        <div class="mb-3">
                            <div class="tower-visual tower-visual-aligned">
                                <div class="tower-column">
                                    <div class="tower-header">
                                        <span class="tower-label">Buyer Tower</span>
                                    </div>
                                    <div id="wizardBuyerStack" class="tower-stack buyer">
                                        <!-- Layers will be inserted here -->
                                    </div>
                                    <div class="tower-params-summary" id="wizardBuyerParamsSummary">
                                        <div class="params-row"><span>Total params:</span><span id="wizardBuyerTotalParams">0</span></div>
                                        <div class="params-row"><span>Trainable params:</span><span id="wizardBuyerTrainableParams">0</span></div>
                                        <div class="params-row"><span>Non-trainable params:</span><span>0</span></div>
                                    </div>
                                </div>
                                <div class="tower-column">
                                    <div class="tower-header">
                                        <span class="tower-label">Product Tower</span>
                                    </div>
                                    <div id="wizardProductStack" class="tower-stack product">
                                        <!-- Layers will be inserted here -->
                                    </div>
                                    <div class="tower-params-summary" id="wizardProductParamsSummary">
                                        <div class="params-row"><span>Total params:</span><span id="wizardProductTotalParams">0</span></div>
                                        <div class="params-row"><span>Trainable params:</span><span id="wizardProductTrainableParams">0</span></div>
                                        <div class="params-row"><span>Non-trainable params:</span><span>0</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Training Parameters -->
                        <div class="mb-2">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Training Parameters</h4>
                            <div class="training-params-preview" id="wizardModelParams">
                                <!-- Will be populated dynamically -->
                            </div>
                        </div>

                        <!-- Retrieval Algorithm (for retrieval/multitask models) -->
                        <div id="wizardRetrievalSection" class="hidden">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Retrieval Algorithm</h4>
                            <div class="training-params-preview" id="wizardRetrievalParams">
                                <!-- Will be populated dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
                <div id="wizardModelEmpty" class="config-preview-panel model">
                    <div class="config-preview-empty">
                        <i class="fas fa-layer-group text-2xl mb-2"></i>
                        <p>Select a Model Config to see details</p>
                    </div>
                </div>
            </div>

            <!-- Step 2: Training Parameters -->
            <div id="wizardStep2" class="wizard-step">
                <!-- Data Sampling - Full width proportional layout -->
                <div class="p-3 bg-amber-50 border border-amber-200 rounded-lg mb-4">
                    <div class="flex items-center gap-3">
                        <div class="flex items-center gap-2 flex-shrink-0">
                            <i class="fas fa-database text-amber-600"></i>
                            <span class="text-sm font-medium text-amber-800">Sample:</span>
                        </div>
                        <div class="flex-1 flex items-center gap-2" style="max-width: 480px;">
                            <button type="button" class="sample-btn flex-1" data-value="5" onclick="setSamplePercent(5)">5%</button>
                            <button type="button" class="sample-btn flex-1" data-value="10" onclick="setSamplePercent(10)">10%</button>
                            <button type="button" class="sample-btn flex-1" data-value="25" onclick="setSamplePercent(25)">25%</button>
                            <button type="button" class="sample-btn flex-1 active" data-value="100" onclick="setSamplePercent(100)">100%</button>
                            <span class="text-gray-400 text-sm px-1">or</span>
                            <input type="number" id="wizardSamplePercentInput" class="sample-input flex-1 px-2 py-1 text-sm border border-amber-300 rounded text-center" value="100" min="1" max="100" onchange="onSampleInputChange()">
                            <span class="text-sm text-gray-500">%</span>
                        </div>
                        <div class="flex items-center gap-1 ml-auto flex-shrink-0" style="min-width: 140px; justify-content: flex-end;">
                            <span class="text-amber-700 font-semibold" id="wizardExampleCountValue">--</span>
                            <span class="text-sm text-gray-500">examples</span>
                        </div>
                    </div>
                </div>

                <!-- Split Strategy -->
                <div class="training-params-section" style="background: #f5f3ff; border-color: #c4b5fd;">
                    <h4 style="color: #6d28d9;"><i class="fas fa-random"></i> Split Strategy</h4>
                    <!-- Main row: Strategy + conditional options -->
                    <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
                        <select id="wizardSplitStrategy" onchange="onWizardSplitChange()" style="border-color: #c4b5fd; padding: 8px 12px; border-radius: 6px; font-size: 13px; min-width: 160px;">
                            <option value="random">Random (fastest)</option>
                            <option value="time_holdout">Time Holdout</option>
                            <option value="strict_time">Strict Temporal</option>
                        </select>
                        <!-- Random split info -->
                        <div id="wizardRandomInfo" style="display: flex; align-items: center; gap: 6px;">
                            <span style="color: #7c3aed; font-size: 12px;"><i class="fas fa-info-circle mr-1"></i>Train 80% / Eval 15% / Test 5%</span>
                        </div>
                        <!-- Date column (inline, shown for time-based) -->
                        <div id="wizardDateColumnSection" style="display: none; align-items: center; gap: 8px;">
                            <span style="color: #6d28d9; font-size: 12px; white-space: nowrap;">on</span>
                            <select id="wizardDateColumn" style="border-color: #c4b5fd; padding: 8px 12px; border-radius: 6px; font-size: 13px; min-width: 200px;">
                                <option value="">Select date column...</option>
                            </select>
                        </div>
                        <!-- Holdout days (inline, shown for time_holdout) -->
                        <div id="wizardTimeOptions" style="display: none; align-items: center; gap: 6px;">
                            <span style="color: #6d28d9; font-size: 12px;">test: last</span>
                            <input type="number" id="wizardHoldoutDays" value="1" min="1" max="30" style="border-color: #c4b5fd; width: 60px; padding: 6px 8px; border-radius: 6px; font-size: 13px; text-align: center;">
                            <span style="color: #6d28d9; font-size: 12px;">days, rest: 80/20</span>
                        </div>
                    </div>
                    <!-- Rolling window (second row, shown for strict_time) -->
                    <div id="wizardRollingWindowSection" style="display: none; margin-top: 10px; width: 100%;">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; width: 100%;">
                            <div style="background: white; padding: 8px 12px; border-radius: 6px; border: 1px solid #ede9fe; display: flex; align-items: center; justify-content: space-between;">
                                <span style="color: #9ca3af; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px;">Train</span>
                                <div style="display: flex; align-items: baseline; gap: 3px;">
                                    <input type="number" id="wizardTrainDays" value="60" min="7" max="365" style="border: none; width: 40px; font-size: 16px; background: transparent; font-weight: 600; color: #6d28d9; padding: 0; text-align: right;">
                                    <span style="color: #9ca3af; font-size: 11px;">days</span>
                                </div>
                            </div>
                            <div style="background: white; padding: 8px 12px; border-radius: 6px; border: 1px solid #ede9fe; display: flex; align-items: center; justify-content: space-between;">
                                <span style="color: #9ca3af; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px;">Validation</span>
                                <div style="display: flex; align-items: baseline; gap: 3px;">
                                    <input type="number" id="wizardValDays" value="7" min="1" max="30" style="border: none; width: 28px; font-size: 16px; background: transparent; font-weight: 600; color: #6d28d9; padding: 0; text-align: right;">
                                    <span style="color: #9ca3af; font-size: 11px;">days</span>
                                </div>
                            </div>
                            <div style="background: white; padding: 8px 12px; border-radius: 6px; border: 1px solid #ede9fe; display: flex; align-items: center; justify-content: space-between;">
                                <span style="color: #9ca3af; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px;">Test</span>
                                <div style="display: flex; align-items: baseline; gap: 3px;">
                                    <input type="number" id="wizardTestDays" value="7" min="1" max="30" style="border: none; width: 28px; font-size: 16px; background: transparent; font-weight: 600; color: #6d28d9; padding: 0; text-align: right;">
                                    <span style="color: #9ca3af; font-size: 11px;">days</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Training Parameters -->
                <div class="training-params-section" style="background: #eff6ff; border-color: #93c5fd;">
                    <h4 style="color: #1e40af;"><i class="fas fa-sliders-h"></i> Training Parameters</h4>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <!-- Epochs -->
                        <div>
                            <label style="color: #1e40af; font-size: 12px; display: block; margin-bottom: 6px;">Epochs</label>
                            <div class="flex items-center gap-2">
                                <button type="button" class="param-btn" data-param="epochs" data-value="5" onclick="setParam('epochs', 5)">5</button>
                                <button type="button" class="param-btn" data-param="epochs" data-value="10" onclick="setParam('epochs', 10)">10</button>
                                <button type="button" class="param-btn active" data-param="epochs" data-value="25" onclick="setParam('epochs', 25)">25</button>
                                <button type="button" class="param-btn" data-param="epochs" data-value="50" onclick="setParam('epochs', 50)">50</button>
                                <button type="button" class="param-btn" data-param="epochs" data-value="100" onclick="setParam('epochs', 100)">100</button>
                                <span class="text-gray-400 text-sm px-1">or</span>
                                <input type="number" id="wizardEpochs" class="param-input" value="25" min="1" max="500" onchange="onParamInputChange('epochs')">
                            </div>
                        </div>
                        <!-- Batch Size -->
                        <div>
                            <label style="color: #1e40af; font-size: 12px; display: block; margin-bottom: 6px;">Batch Size</label>
                            <div class="flex items-center gap-2">
                                <button type="button" class="param-btn active" data-param="batchSize" data-value="1024" onclick="setParam('batchSize', 1024)">1024</button>
                                <button type="button" class="param-btn" data-param="batchSize" data-value="2048" onclick="setParam('batchSize', 2048)">2048</button>
                                <button type="button" class="param-btn" data-param="batchSize" data-value="4096" onclick="setParam('batchSize', 4096)">4096</button>
                                <button type="button" class="param-btn" data-param="batchSize" data-value="8192" onclick="setParam('batchSize', 8192)">8192</button>
                                <span class="text-gray-400 text-sm px-1">or</span>
                                <input type="number" id="wizardBatchSize" class="param-input" value="1024" min="128" max="65536" step="128" onchange="onParamInputChange('batchSize')">
                            </div>
                        </div>
                        <!-- Learning Rate -->
                        <div>
                            <label style="color: #1e40af; font-size: 12px; display: block; margin-bottom: 6px;">Learning Rate</label>
                            <div class="flex items-center gap-2">
                                <button type="button" class="param-btn" data-param="learningRate" data-value="0.001" onclick="setParam('learningRate', 0.001)">0.001</button>
                                <button type="button" class="param-btn active" data-param="learningRate" data-value="0.01" onclick="setParam('learningRate', 0.01)">0.01</button>
                                <button type="button" class="param-btn" data-param="learningRate" data-value="0.05" onclick="setParam('learningRate', 0.05)">0.05</button>
                                <button type="button" class="param-btn" data-param="learningRate" data-value="0.1" onclick="setParam('learningRate', 0.1)">0.1</button>
                                <span class="text-gray-400 text-sm px-1">or</span>
                                <input type="number" id="wizardLearningRate" class="param-input" value="0.01" min="0.0001" max="1.0" step="0.001" onchange="onParamInputChange('learningRate')">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Rating Column (for Ranking models) -->
                <div id="wizardRatingSection" class="training-params-section hidden" style="background: #faf5ff; border-color: #d8b4fe;">
                    <h4 style="color: #7c3aed;"><i class="fas fa-star"></i> Rating Column</h4>
                    <p class="text-sm text-purple-600 mb-3">Ranking models require a numeric column containing ratings/scores.</p>
                    <div class="training-param-group">
                        <select id="wizardRatingColumn" style="border-color: #d8b4fe;">
                            <option value="">Select rating column...</option>
                        </select>
                    </div>
                </div>

                <!-- Hardware Selection -->
                <div class="hardware-section">
                    <h4><i class="fas fa-microchip"></i> Hardware Configuration</h4>
                    <div class="hardware-recommendation" id="hardwareRecommendation">
                        Recommended: <strong>Small</strong> based on dataset size
                    </div>
                    <input type="hidden" id="wizardMachineType" value="n1-standard-4">
                    <div class="hardware-options">
                        <div class="hardware-card selected recommended" data-machine="n1-standard-4" onclick="selectHardware('n1-standard-4')">
                            <div class="hardware-card-title">Small</div>
                            <div class="hardware-card-type">n1-standard-4</div>
                            <div class="hardware-card-specs">4 vCPU<br>15 GB RAM</div>
                        </div>
                        <div class="hardware-card" data-machine="n1-standard-8" onclick="selectHardware('n1-standard-8')">
                            <div class="hardware-card-title">Medium</div>
                            <div class="hardware-card-type">n1-standard-8</div>
                            <div class="hardware-card-specs">8 vCPU<br>30 GB RAM</div>
                        </div>
                        <div class="hardware-card" data-machine="n1-standard-16" onclick="selectHardware('n1-standard-16')">
                            <div class="hardware-card-title">Large</div>
                            <div class="hardware-card-type">n1-standard-16</div>
                            <div class="hardware-card-specs">16 vCPU<br>60 GB RAM</div>
                        </div>
                        <div class="hardware-card disabled" title="GPU acceleration coming soon">
                            <div class="hardware-card-lock"><i class="fas fa-lock"></i></div>
                            <div class="hardware-card-title">GPU T4</div>
                            <div class="hardware-card-type">n1-standard-4 + T4</div>
                            <div class="hardware-card-specs">4 vCPU, 15 GB RAM<br>16 GB GPU</div>
                        </div>
                        <div class="hardware-card disabled" title="GPU acceleration coming soon">
                            <div class="hardware-card-lock"><i class="fas fa-lock"></i></div>
                            <div class="hardware-card-title">GPU V100</div>
                            <div class="hardware-card-type">n1-standard-8 + V100</div>
                            <div class="hardware-card-specs">8 vCPU, 30 GB RAM<br>16 GB GPU</div>
                        </div>
                    </div>
                </div>

                <!-- Summary -->
                <div class="exp-summary-section">
                    <div class="exp-summary-title">
                        <i class="fas fa-clipboard-check"></i>
                        Experiment Summary
                    </div>
                    <div class="exp-summary-grid">
                        <div class="exp-summary-item">
                            <span class="exp-summary-label">Feature Config</span>
                            <span class="exp-summary-value accent" id="wizardSummaryFeature">-</span>
                        </div>
                        <div class="exp-summary-item">
                            <span class="exp-summary-label">Model Config</span>
                            <span class="exp-summary-value accent" id="wizardSummaryModel">-</span>
                        </div>
                        <div class="exp-summary-item">
                            <span class="exp-summary-label">Data Sample</span>
                            <span class="exp-summary-value" id="wizardSummarySample">100%</span>
                        </div>
                        <div class="exp-summary-item">
                            <span class="exp-summary-label">Split Strategy</span>
                            <span class="exp-summary-value" id="wizardSummarySplit">Random</span>
                        </div>
                        <div class="exp-summary-params">
                            <div class="exp-summary-param">
                                <span class="exp-summary-param-label">Epochs</span>
                                <span class="exp-summary-param-value" id="wizardSummaryEpochs">25</span>
                            </div>
                            <div class="exp-summary-param">
                                <span class="exp-summary-param-label">Batch Size</span>
                                <span class="exp-summary-param-value" id="wizardSummaryBatch">1024</span>
                            </div>
                            <div class="exp-summary-param">
                                <span class="exp-summary-param-label">Learning Rate</span>
                                <span class="exp-summary-param-value" id="wizardSummaryLR">0.01</span>
                            </div>
                            <div class="exp-summary-param" style="background: #faf5ff; border: 1px solid #e9d5ff;">
                                <span class="exp-summary-param-label" style="color: #7c3aed;">Hardware</span>
                                <span class="exp-summary-param-value" id="wizardSummaryHardware" style="color: #7c3aed;">Small</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="modal-footer-wizard-neu">
            <div class="footer-left">
                <button type="button" id="wizardBackBtn" class="btn-neu btn-neu-nav hidden" onclick="wizardBack()">
                    <span class="btn-neu-inner"><i class="fas fa-chevron-left"></i></span>
                </button>
                <button type="button" id="wizardNextBtn" class="btn-neu btn-neu-nav" onclick="wizardNext()">
                    <span class="btn-neu-inner"><i class="fas fa-chevron-right"></i></span>
                </button>
            </div>
            <div class="footer-right">
                <button type="button" id="wizardRunBtn" class="btn-neu btn-neu-action btn-neu-save hidden" onclick="submitExperiment()">
                    <span class="btn-neu-inner">Run</span>
                </button>
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeNewExpWizard()">
                    <span class="btn-neu-inner">Cancel</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ============================================================================
     COMPARE SELECTION MODAL (Select experiments to compare)
     ============================================================================ -->
<div id="compareSelectModal" class="modal-overlay hidden" onclick="closeCompareSelectModal(event)">
    <div class="modal-container" style="max-width: 900px;" onclick="event.stopPropagation()">
        <div class="modal-header">
            <div class="modal-header-icon info">
                <i class="fas fa-check-square"></i>
            </div>
            <h3 class="modal-header-title">Select Experiments to Compare</h3>
        </div>
        <div class="modal-body" style="padding: 16px 24px;">
            <!-- Selection info -->
            <div class="compare-select-info" style="margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;">
                <span class="text-sm text-gray-500">Select 2-4 experiments to compare</span>
                <span id="compareSelectCount" class="text-sm font-medium" style="color: #f59e0b;">0 selected</span>
            </div>

            <!-- Loading State -->
            <div id="compareSelectLoading" class="exp-view-loading">
                <i class="fas fa-spinner fa-spin"></i>
                <span>Loading experiments...</span>
            </div>

            <!-- Empty State -->
            <div id="compareSelectEmpty" class="chapter-empty-state hidden" style="padding: 32px;">
                <i class="fas fa-flask chapter-empty-icon"></i>
                <p class="chapter-empty-text">No experiments available for comparison</p>
                <p class="text-sm text-gray-400 mt-2">Run some experiments first, then come back to compare them.</p>
            </div>

            <!-- Experiment List (2-column grid) -->
            <div id="compareSelectList" class="compare-select-list hidden" style="max-height: 324px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 0;">
                <!-- Rows added dynamically -->
            </div>

            <!-- Pagination Controls -->
            <div id="compareSelectPagination" class="hidden" style="display: flex; flex-direction: column; gap: 12px; margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div id="compareSelectPageInfo" class="text-sm text-gray-600">
                        Showing 1-20 of 0 experiments
                    </div>
                    <div id="compareSelectPageControls" style="display: flex; align-items: center; gap: 8px;">
                        <!-- Pagination buttons added dynamically -->
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-secondary" onclick="clearCompareSelection()" style="min-width: 100px;">
                    <span class="btn-neu-inner">Clear All</span>
                </button>
                <button type="button" id="compareSelectBtn" class="btn-neu btn-neu-action btn-neu-save" onclick="proceedToCompare()" disabled style="min-width: 100px;">
                    <span class="btn-neu-inner">Compare</span>
                </button>
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeCompareSelectModal()" style="min-width: 100px;">
                    <span class="btn-neu-inner">Cancel</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ============================================================================
     COMPARE MODAL (Experiment Comparison)
     ============================================================================ -->
<div id="compareModal" class="modal-overlay hidden" onclick="closeCompareModal(event)">
    <div class="modal-container" style="max-width: 900px;" onclick="event.stopPropagation()">
        <div class="modal-header">
            <div class="modal-header-icon info">
                <i class="fas fa-columns"></i>
            </div>
            <h3 class="modal-header-title">Compare Experiments</h3>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <!-- Loading State -->
            <div id="compareLoading" class="exp-view-loading hidden">
                <i class="fas fa-spinner fa-spin"></i>
                <span>Loading comparison data...</span>
            </div>

            <!-- Empty State (no experiments selected) -->
            <div id="compareEmpty" class="chapter-empty-state">
                <i class="fas fa-check-square chapter-empty-icon"></i>
                <p class="chapter-empty-text">Select experiments to compare</p>
                <p class="text-sm text-gray-400 mt-2">Use the checkboxes on experiment cards to select 2-4 experiments for comparison</p>
            </div>

            <!-- Comparison Content -->
            <div id="compareContent" class="hidden">
                <!-- Unified Comparison Table -->
                <div class="compare-table-wrapper">
                    <table id="compareUnifiedTable" class="compare-table compare-table-unified">
                        <thead>
                            <tr id="compareUnifiedHeader">
                                <th></th>
                                <!-- Experiment columns added dynamically -->
                            </tr>
                        </thead>
                        <tbody id="compareUnifiedBody">
                            <!-- All rows added dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left">
                <span id="compareSelectedCount" class="text-sm text-gray-500">0 experiments selected</span>
            </div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeCompareModal()">
                    <span class="btn-neu-inner">Close</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- =============================================================================
     CONFIRMATION MODAL (Reusable styled confirmation dialog)
     ============================================================================ -->
<div id="confirmModal" class="modal-overlay hidden">
    <div class="modal-container modal-container-sm">
        <div class="modal-header">
            <div id="confirmModalIcon" class="modal-header-icon warning">
                <i class="fas fa-exclamation-triangle text-xl"></i>
            </div>
            <h3 id="confirmModalTitle" class="modal-header-title">Confirm Action</h3>
        </div>
        <div class="modal-body">
            <p id="confirmModalMessage">Are you sure you want to proceed?</p>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button id="confirmModalConfirmBtn" class="btn-neu btn-neu-action btn-neu-cancel">
                    <span class="btn-neu-inner">Confirm</span>
                </button>
                <button id="confirmModalCancelBtn" class="btn-neu btn-neu-action btn-neu-secondary">
                    <span class="btn-neu-inner">Cancel</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ============================================================================
     EXPERIMENT VIEW MODAL (Tabbed design with lazy-loaded artifacts)
     ============================================================================ -->
<div id="expViewModal" class="modal-overlay hidden" onclick="closeExpViewModal(event)">
    <div class="modal-container exp-view-modal" onclick="event.stopPropagation()">
        <!-- Header - Vertex Pipelines Style - 3 Column Layout -->
        <div class="modal-header exp-view-header" id="expViewHeader">
            <!-- Column 1: Experiment Number (20%, centered) -->
            <div class="exp-view-header-number">
                <h3 class="exp-view-title" id="expViewTitle">Exp #1</h3>
            </div>
            <!-- Column 2: Name, Description, Times (60%, left-aligned) -->
            <div class="exp-view-header-info">
                <div class="exp-view-exp-name" id="expViewExpName"></div>
                <div class="exp-view-description" id="expViewDescription"></div>
                <div class="exp-view-times">
                    <div>Start: <span id="expViewStartTime">-</span></div>
                    <div>End: <span id="expViewEndTime">-</span></div>
                </div>
            </div>
            <!-- Column 3: Status Panel (20%, centered) -->
            <div class="exp-view-status-panel" id="expViewStatusPanel">
                <div class="exp-view-status-icon" id="expViewStatusIcon">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="exp-view-tabs">
            <button class="exp-view-tab active" data-tab="overview" onclick="switchExpViewTab('overview')">
                Overview
            </button>
            <button class="exp-view-tab" data-tab="pipeline" onclick="switchExpViewTab('pipeline')">
                Pipeline
            </button>
            <button class="exp-view-tab" data-tab="data" onclick="switchExpViewTab('data')">
                Data Insights
            </button>
            <button class="exp-view-tab" data-tab="training" onclick="switchExpViewTab('training')">
                Training
            </button>
        </div>

        <!-- Tab Content -->
        <div class="modal-body exp-view-body">
            <!-- Overview Tab -->
            <div id="expViewTabOverview" class="exp-view-tab-content active">
                <!-- Results Summary (at top for completed experiments) -->
                <div id="expViewResultsSummary" class="exp-view-results-summary hidden">
                    <h4 class="exp-view-group-title">Results</h4>
                    <div class="exp-view-metrics-row" id="expViewMetricsSummary">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- Dataset Section -->
                <div class="exp-view-section-group">
                    <h4 class="exp-view-group-title">
                        <span><i class="fas fa-layer-group" style="margin-right:6px;"></i>DATASET: <span id="expViewDatasetName" style="color:#374151;">-</span></span>
                    </h4>
                    <div id="expViewDatasetDetails" class="exp-view-dataset-details">
                        <div class="exp-view-loading"><i class="fas fa-spinner fa-spin"></i> Loading...</div>
                    </div>
                </div>

                <!-- Features Config Section -->
                <div class="exp-view-section-group">
                    <h4 class="exp-view-group-title">
                        <span>Features config: <span id="expViewFeaturesConfigName" style="color:#374151;">-</span></span>
                    </h4>
                    <div id="expViewFeaturesConfigContent">
                        <div class="exp-view-loading"><i class="fas fa-spinner fa-spin"></i> Loading...</div>
                    </div>
                </div>

                <!-- Model Config Section -->
                <div class="exp-view-section-group">
                    <h4 class="exp-view-group-title">
                        <span>Model config: <span id="expViewModelConfigName" style="color:#374151;">-</span></span>
                    </h4>
                    <div id="expViewModelConfigContent">
                        <div class="exp-view-loading"><i class="fas fa-spinner fa-spin"></i> Loading...</div>
                    </div>
                </div>

                <div class="exp-view-section-group">
                    <h4 class="exp-view-group-title">Sampling</h4>
                    <div id="expViewSamplingChips" class="exp-view-training-params">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <div class="exp-view-section-group">
                    <h4 class="exp-view-group-title">Training Parameters</h4>
                    <div id="expViewTrainingParamsChips" class="exp-view-training-params">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Pipeline Tab -->
            <div id="expViewTabPipeline" class="exp-view-tab-content">
                <!-- Progress Bar (for running experiments) -->
                <div id="expViewProgressSection" class="exp-view-progress-section" style="display: none;">
                    <div class="exp-view-progress-bar-container">
                        <div class="exp-view-progress-bar" id="expViewProgressBar" style="width: 0%"></div>
                    </div>
                    <span class="exp-view-progress-text" id="expViewProgressText">0%</span>
                </div>

                {% include 'includes/_pipeline_dag.html' %}

                <!-- Component Detail Panel (shown on node click) -->
                <div id="expViewComponentDetail" class="exp-view-component-detail hidden">
                    <div class="exp-view-component-header">
                        <span class="exp-view-component-name" id="expViewComponentName">Component</span>
                        <span class="exp-view-component-status" id="expViewComponentStatus">pending</span>
                        <span class="exp-view-component-duration" id="expViewComponentDuration">
                            <i class="fas fa-clock"></i>
                            <span id="expViewComponentDurationText">-</span>
                        </span>
                    </div>
                    <div class="exp-view-logs-section">
                        <div class="exp-view-logs-header">
                            <span>Recent Logs</span>
                            <button class="exp-view-refresh-btn" id="expViewRefreshLogsBtn" onclick="refreshComponentLogs()">
                                <i class="fas fa-sync-alt"></i>
                                Refresh
                            </button>
                        </div>
                        <div class="exp-view-logs-container" id="expViewLogsContainer">
                            <div class="exp-view-logs-empty">Click a component to view logs</div>
                        </div>
                    </div>
                </div>

                <!-- Error Section (for failed experiments) -->
                <div id="expViewErrorSection" class="exp-view-error-box hidden">
                    <div class="exp-view-error-header">
                        <i class="fas fa-exclamation-circle"></i>
                        <span id="expViewErrorTitle">Pipeline Failed</span>
                    </div>
                    <p class="exp-view-error-suggestion" id="expViewErrorSuggestion"></p>
                    <div class="exp-view-error-details">
                        <button class="exp-view-error-toggle" onclick="toggleErrorDetails()">
                            <span id="expViewErrorToggleText">Show Error Details</span>
                            <i class="fas fa-chevron-down" id="expViewErrorToggleIcon"></i>
                        </button>
                        <div id="expViewErrorDetails" class="exp-view-error-content hidden">
                            <pre id="expViewErrorMessage"></pre>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Insights Tab (lazy-loaded) -->
            <div id="expViewTabData" class="exp-view-tab-content">
                <div id="expViewDataLoading" class="exp-view-loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>Loading data insights...</span>
                </div>
                <div id="expViewDataContent" class="hidden">
                    <!-- Statistics Summary Section -->
                    <div class="exp-view-section-group">
                        <div class="exp-view-group-header">
                            <h4 class="exp-view-group-title">Dataset Statistics</h4>
                            <a id="expViewTfdvBtn" class="exp-view-tfdv-btn hidden" href="#" target="_blank">
                                <i class="fas fa-external-link-alt"></i> Open Full Report
                            </a>
                        </div>
                        <div id="expViewStatsContent">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Numeric Features Section -->
                    <div id="expViewNumericSection" class="exp-view-section-group hidden">
                        <h4 class="exp-view-group-title">
                            <span>Numeric Features</span>
                            <span id="expViewNumericCount" class="exp-view-feature-count"></span>
                        </h4>
                        <div id="expViewNumericContent">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Categorical Features Section -->
                    <div id="expViewCategoricalSection" class="exp-view-section-group hidden">
                        <h4 class="exp-view-group-title">
                            <span>Categorical Features</span>
                            <span id="expViewCategoricalCount" class="exp-view-feature-count"></span>
                        </h4>
                        <div id="expViewCategoricalContent">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Schema Section -->
                    <div class="exp-view-section-group">
                        <h4 class="exp-view-group-title">Schema</h4>
                        <div id="expViewSchemaContent">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </div>
                <div id="expViewDataError" class="exp-view-data-message hidden">
                    <i class="fas fa-info-circle"></i>
                    <span id="expViewDataErrorMessage">Data insights not available</span>
                </div>
            </div>

            <!-- Training Tab (lazy-loaded) -->
            <div id="expViewTabTraining" class="exp-view-tab-content">
                <div id="expViewTrainingLoading" class="exp-view-loading hidden">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>Loading training data...</span>
                </div>

                <!-- Training Curves - Placeholder (shown when no MLflow data) -->
                <div id="expViewTrainingPlaceholder" class="exp-view-section-group">
                    <h4 class="exp-view-group-title">Training Progress</h4>
                    <div class="exp-view-chart-placeholder">
                        <i class="fas fa-chart-line"></i>
                        <p id="expViewTrainingMessage">Loading training data...</p>
                    </div>
                </div>

                <!-- Training Curves - Charts (shown when MLflow data available) -->
                <div id="expViewTrainingCharts" class="exp-view-section-group hidden">
                    <h4 class="exp-view-group-title">Training Progress</h4>
                    <div class="training-charts-container">
                        <div class="training-chart-wrapper">
                            <h5 class="training-chart-title">Loss</h5>
                            <canvas id="trainingLossChart" height="170"></canvas>
                        </div>
                        <div class="training-chart-wrapper">
                            <h5 class="training-chart-title">Recall Metrics</h5>
                            <canvas id="trainingMetricsChart" height="170"></canvas>
                        </div>
                    </div>
                    <!-- Second row: Combined Weight Analysis (Norm + Distribution) -->
                    <div class="training-chart-wrapper" style="margin-top: 16px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                            <h5 class="training-chart-title" style="margin: 0;">Weight Analysis</h5>
                            <select id="weightAnalysisTower" class="weight-stats-select" onchange="updateWeightAnalysisCharts()">
                                <option value="query">Query Tower</option>
                                <option value="candidate">Candidate Tower</option>
                            </select>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <h6 style="font-size: 12px; font-weight: 500; color: #6b7280; margin: 0 0 4px 0;">Weight Norm (L1/L2)</h6>
                                <canvas id="trainingGradientChart" height="150"></canvas>
                            </div>
                            <div>
                                <h6 style="font-size: 12px; font-weight: 500; color: #6b7280; margin: 0 0 4px 0;">Weight Distribution</h6>
                                <canvas id="trainingWeightStatsChart" height="150"></canvas>
                            </div>
                        </div>
                    </div>
                    <!-- Third row: Distribution Histogram (TensorBoard-style ridgeline) - Weights or Gradients -->
                    <div class="training-charts-container" style="margin-top: 16px;">
                        <div class="training-chart-wrapper" style="grid-column: span 2;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                                <h5 id="histogramChartTitle" class="training-chart-title" style="margin: 0;">Weight Distribution Histogram</h5>
                                <div style="display: flex; gap: 8px;">
                                    <select id="histogramDataType" class="weight-stats-select" onchange="updateWeightHistogramChart()">
                                        <option value="weights">Weights</option>
                                        <option value="gradients">Gradients</option>
                                    </select>
                                    <select id="weightHistogramTower" class="weight-stats-select" onchange="updateWeightHistogramChart()">
                                        <option value="query">Query Tower</option>
                                        <option value="candidate">Candidate Tower</option>
                                    </select>
                                </div>
                            </div>
                            <div id="trainingWeightHistogramChart" style="width: 100%;"></div>
                        </div>
                    </div>
                </div>

                <!-- Final Metrics -->
                <div id="expViewFinalMetrics" class="exp-view-section-group hidden">
                    <h4 class="exp-view-group-title">Final Metrics</h4>
                    <div class="exp-view-rows" id="expViewMetricsRows">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- Vocabulary Stats -->
                <div id="expViewVocabSection" class="exp-view-section-group hidden">
                    <h4 class="exp-view-group-title">Vocabularies</h4>
                    <div class="exp-view-rows" id="expViewVocabRows">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeExpViewModal()">
                    <span class="btn-neu-inner">Close</span>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// =============================================================================
// STATE & CONSTANTS
// =============================================================================
const modelId = {{ model.id }};

// Data
let allFeatureConfigs = [];
let allModelConfigs = [];
let experiments = [];
let pagination = { page: 1, page_size: 10, total_count: 0, total_pages: 1 };

// Wizard state
let wizardStep = 1;
let selectedFeatureConfig = null;
let selectedModelConfig = null;
let datasetEstimatedRows = null;  // Estimated rows from selected feature config's dataset
let datasetDateDays = null;  // Number of days in dataset for split strategy calculations

// Misc
let searchDebounceTimer = null;

// Data type constants
const DATA_TYPES = {
    numeric: { label: 'Numeric', icon: 'hashtag' },
    text: { label: 'Text', icon: 'font' },
    temporal: { label: 'Temporal', icon: 'calendar' }
};

// =============================================================================
// CONFIRMATION MODAL FUNCTIONS
// =============================================================================

/**
 * Show confirmation modal with custom title, message, and callbacks
 * @param {Object} options - Modal configuration
 * @param {string} options.title - Modal title
 * @param {string} options.message - Modal message (HTML supported)
 * @param {string} options.confirmText - Text for confirm button (default: "Confirm")
 * @param {string} options.cancelText - Text for cancel button (default: "Cancel")
 * @param {string} options.type - Modal type: 'danger', 'warning', 'info', 'success' (default: 'warning')
 * @param {string} options.confirmButtonClass - Custom class for confirm button (overrides type-based class)
 * @param {string} options.cancelButtonClass - Custom class for cancel button (e.g., 'btn-neu-cancel' for red)
 * @param {Function} options.onConfirm - Callback when confirmed
 * @param {Function} options.onCancel - Callback when cancelled (optional)
 */
function showConfirmModal(options) {
    const modal = document.getElementById('confirmModal');
    const icon = document.getElementById('confirmModalIcon');
    const title = document.getElementById('confirmModalTitle');
    const message = document.getElementById('confirmModalMessage');
    const confirmBtn = document.getElementById('confirmModalConfirmBtn');
    const cancelBtn = document.getElementById('confirmModalCancelBtn');

    // Set content
    title.textContent = options.title || 'Confirm Action';
    message.innerHTML = options.message || 'Are you sure you want to proceed?';

    // Update inner span text for neumorphic buttons
    const confirmInner = confirmBtn.querySelector('.btn-neu-inner');
    const cancelInner = cancelBtn.querySelector('.btn-neu-inner');
    if (confirmInner) confirmInner.textContent = options.confirmText || 'Confirm';
    if (cancelInner) cancelInner.textContent = options.cancelText || 'Cancel';

    // Set icon and button type
    const type = options.type || 'warning';
    icon.className = `modal-header-icon ${type}`;

    // Update icon based on type
    const iconElement = icon.querySelector('i');
    const baseClasses = 'btn-neu btn-neu-action';

    // Determine confirm button class (custom class takes precedence)
    let confirmButtonClass = options.confirmButtonClass;
    if (!confirmButtonClass) {
        if (type === 'danger') {
            iconElement.className = 'fas fa-exclamation-triangle text-xl';
            confirmButtonClass = 'btn-neu-cancel';
        } else if (type === 'warning') {
            iconElement.className = 'fas fa-exclamation-circle text-xl';
            confirmButtonClass = 'btn-neu-warning';
        } else if (type === 'info') {
            iconElement.className = 'fas fa-info-circle text-xl';
            confirmButtonClass = 'btn-neu-nav-wide';
        } else if (type === 'success') {
            iconElement.className = 'fas fa-check-circle text-xl';
            confirmButtonClass = 'btn-neu-save';
        }
    } else {
        // Set icon based on type even when custom button class is provided
        if (type === 'danger') {
            iconElement.className = 'fas fa-exclamation-triangle text-xl';
        } else if (type === 'warning') {
            iconElement.className = 'fas fa-exclamation-circle text-xl';
        } else if (type === 'info') {
            iconElement.className = 'fas fa-info-circle text-xl';
        } else if (type === 'success') {
            iconElement.className = 'fas fa-check-circle text-xl';
        }
    }
    confirmBtn.className = `${baseClasses} ${confirmButtonClass}`;

    // Set cancel button class (default: btn-neu-secondary for grey)
    cancelBtn.className = `${baseClasses} ${options.cancelButtonClass || 'btn-neu-secondary'}`;

    // Remove old event listeners by cloning
    const newConfirmBtn = confirmBtn.cloneNode(true);
    const newCancelBtn = cancelBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

    // Add new event listeners
    newConfirmBtn.addEventListener('click', () => {
        hideConfirmModal();
        if (options.onConfirm) options.onConfirm();
    });

    newCancelBtn.addEventListener('click', () => {
        hideConfirmModal();
        if (options.onCancel) options.onCancel();
    });

    // Show modal
    modal.classList.remove('hidden');

    // Close on overlay click
    modal.addEventListener('click', function overlayClick(e) {
        if (e.target === modal) {
            hideConfirmModal();
            if (options.onCancel) options.onCancel();
            modal.removeEventListener('click', overlayClick);
        }
    });

    // Close on ESC key
    function escapeHandler(e) {
        if (e.key === 'Escape') {
            hideConfirmModal();
            if (options.onCancel) options.onCancel();
            document.removeEventListener('keydown', escapeHandler);
        }
    }
    document.addEventListener('keydown', escapeHandler);
}

function hideConfirmModal() {
    const modal = document.getElementById('confirmModal');
    modal.classList.add('hidden');
}

// =============================================================================
// FEATURE CONFIG HELPER FUNCTIONS
// =============================================================================

function getDataTypeLabel(dataType) {
    return DATA_TYPES[dataType]?.label || dataType;
}

function getDataTypeFromBqType(bqType) {
    const type = (bqType || 'STRING').toUpperCase();
    if (['INTEGER', 'INT64', 'FLOAT', 'FLOAT64', 'NUMERIC', 'BIGNUMERIC'].includes(type)) {
        return 'numeric';
    } else if (['TIMESTAMP', 'DATETIME', 'DATE', 'TIME'].includes(type)) {
        return 'temporal';
    } else {
        return 'text';
    }
}

function getFeatureDisplayInfo(feature) {
    const dataType = feature.data_type || getDataTypeFromBqType(feature.bq_type);
    const transforms = feature.transforms || {};
    let outputParts = [];
    let totalDim = 0;

    if (dataType === 'numeric') {
        if (transforms.normalize?.enabled) {
            outputParts.push('Norm: 1D');
            totalDim += 1;
        }
        if (transforms.bucketize?.enabled) {
            const dim = transforms.bucketize.embedding_dim || 32;
            outputParts.push(`Bucket: ${dim}D`);
            totalDim += dim;
        }
    } else if (dataType === 'text') {
        if (transforms.embedding?.enabled) {
            const dim = transforms.embedding.embedding_dim || 32;
            outputParts.push(`Embed: ${dim}D`);
            totalDim += dim;
        }
    } else if (dataType === 'temporal') {
        if (transforms.normalize?.enabled) {
            outputParts.push('Norm: 1D');
            totalDim += 1;
        }
        if (transforms.cyclical?.enabled) {
            const cyclical = transforms.cyclical;
            let cyclicalDim = 0;
            if (cyclical.yearly || cyclical.annual) cyclicalDim += 2;
            if (cyclical.quarterly) cyclicalDim += 2;
            if (cyclical.monthly) cyclicalDim += 2;
            if (cyclical.weekly) cyclicalDim += 2;
            if (cyclical.daily) cyclicalDim += 2;
            if (cyclicalDim > 0) {
                outputParts.push(`Cyclical: ${cyclicalDim}D`);
                totalDim += cyclicalDim;
            }
        }
        if (transforms.bucketize?.enabled) {
            const dim = transforms.bucketize.embedding_dim || 32;
            outputParts.push(`Bucket: ${dim}D`);
            totalDim += dim;
        }
    }

    return {
        dataTypeLabel: getDataTypeLabel(dataType),
        transformStr: outputParts.length > 0 ? outputParts.join(' + ') : 'No transform',
        totalDim,
        hasTransforms: outputParts.length > 0
    };
}

function getCrossFeatureNames(cross) {
    // Use display_name (alias) if available
    if (!cross.features || cross.features.length === 0) return [];
    if (typeof cross.features[0] === 'string') {
        return cross.features;
    }
    return cross.features.map(f => f.display_name || f.column);
}

function calculateTensorBreakdown(features, crosses) {
    const breakdown = [];
    let total = 0;

    (features || []).forEach(feature => {
        const info = getFeatureDisplayInfo(feature);
        if (info.totalDim > 0) {
            // Use display_name (alias) if available
            breakdown.push({ name: feature.display_name || feature.column, dim: info.totalDim });
            total += info.totalDim;
        }
    });

    (crosses || []).forEach(cross => {
        const dim = cross.embedding_dim || 16;
        const featureNames = getCrossFeatureNames(cross);
        const name = featureNames.join('  ');
        breakdown.push({ name: name, dim: dim, is_cross: true });
        total += dim;
    });

    return { total, breakdown };
}

function buildDatasetInfoHtml(info, datasetName) {
    if (!info || !info.primary_table) {
        return '';
    }

    const tables = [info.primary_table + ' (primary)'];
    (info.secondary_tables || []).forEach(t => {
        if (t) tables.push(t);
    });
    const tablesLine = tables.join(' &bull; ');

    const filterBadges = [];
    if (info.filters?.dates) filterBadges.push(info.filters.dates);
    if (info.filters?.customers) filterBadges.push(info.filters.customers);
    if (info.filters?.products) filterBadges.push(info.filters.products);
    const filtersLine = filterBadges.length > 0
        ? filterBadges.join(' &bull; ')
        : '<span class="text-gray-400 italic">No filters</span>';

    const rowsBadge = info.estimated_rows
        ? `${info.estimated_rows.toLocaleString()} rows`
        : '';

    return `
        <div class="mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <div class="flex items-center justify-between mb-3">
                <h4 class="font-semibold text-gray-700">
                    <i class="fas fa-database mr-2 text-gray-400"></i>Dataset Source
                </h4>
                ${rowsBadge ? `<span class="text-sm font-medium text-gray-500 bg-white px-2 py-1 rounded border border-gray-200">${rowsBadge}</span>` : ''}
            </div>
            <div class="space-y-2 text-sm">
                <div class="flex">
                    <span class="text-gray-500 w-16 flex-shrink-0">Tables:</span>
                    <span class="text-gray-700">${tablesLine}</span>
                </div>
                <div class="flex">
                    <span class="text-gray-500 w-16 flex-shrink-0">Filters:</span>
                    <span class="text-gray-700">${filtersLine}</span>
                </div>
            </div>
        </div>
    `;
}

function renderWizardTensorPreview(model, total, breakdown, barContainer, maxTotal = null) {
    barContainer.innerHTML = '';
    if (!breakdown || breakdown.length === 0) return;

    if (maxTotal && maxTotal > 0) {
        const widthPercent = (total / maxTotal) * 100;
        barContainer.style.width = `${widthPercent}%`;
    } else {
        barContainer.style.width = '100%';
    }

    const colors = model === 'buyer'
        ? ['#3b82f6', '#60a5fa', '#93c5fd', '#bfdbfe', '#dbeafe']
        : ['#10b981', '#34d399', '#6ee7b7', '#a7f3d0', '#d1fae5'];

    breakdown.forEach((item, idx) => {
        const pct = (item.dim / total) * 100;
        const color = colors[idx % colors.length];

        const segment = document.createElement('div');
        segment.className = 'tensor-breakdown-segment';
        segment.style.width = `${pct}%`;
        segment.style.backgroundColor = color;
        segment.title = `${item.name}: ${item.dim}D`;
        if (pct > 10) {
            segment.textContent = item.dim;
        }
        barContainer.appendChild(segment);
    });
}

// =============================================================================
// MODEL CONFIG HELPER FUNCTIONS
// =============================================================================

function renderCardTowerLayers(buyerLayers, productLayers) {
    const maxLen = Math.max(buyerLayers.length, productLayers.length);
    if (maxLen === 0) {
        return {
            buyer: '<div class="text-xs text-gray-400 italic p-2">No layers</div>',
            product: '<div class="text-xs text-gray-400 italic p-2">No layers</div>'
        };
    }

    const renderLayer = (layer, isOutput) => {
        let badge = '';
        let params = '';

        if (layer.type === 'dense') {
            badge = '<span class="card-layer-badge dense">Dense</span>';
            params = `${layer.units} units`;
            if (layer.activation) params += `, ${layer.activation}`;
            if (layer.l2_regularization) params += `, L2=${layer.l2_regularization}`;
            else if (layer.l2_reg) params += `, L2=${layer.l2_reg}`;
        } else if (layer.type === 'dropout') {
            badge = '<span class="card-layer-badge dropout">Dropout</span>';
            params = `rate: ${layer.rate}`;
        } else if (layer.type === 'batch_norm') {
            badge = '<span class="card-layer-badge batch_norm">BatchNorm</span>';
            params = '';
        } else if (layer.type === 'layer_norm') {
            badge = '<span class="card-layer-badge layer_norm">LayerNorm</span>';
            params = layer.epsilon ? `: ${layer.epsilon}` : '';
        }

        return `
            <div class="card-layer-item${isOutput ? ' output-layer' : ''}">
                <span class="card-drag-handle"><i class="fas fa-grip-vertical"></i></span>
                ${badge}
                <span class="card-layer-params">${params}</span>
            </div>
        `;
    };

    const renderPlaceholder = () => '<div class="card-layer-item empty-placeholder">&nbsp;</div>';

    const buildTowerHtml = (layers, placeholderCount) => {
        if (layers.length === 0) return '';

        const result = [];
        for (let i = 0; i < layers.length - 1; i++) {
            result.push(renderLayer(layers[i], false));
        }
        for (let i = 0; i < placeholderCount; i++) {
            result.push(renderPlaceholder());
        }
        result.push(renderLayer(layers[layers.length - 1], true));

        return result.join('');
    };

    const buyerPlaceholders = maxLen - buyerLayers.length;
    const productPlaceholders = maxLen - productLayers.length;

    return {
        buyer: buildTowerHtml(buyerLayers, buyerPlaceholders),
        product: buildTowerHtml(productLayers, productPlaceholders)
    };
}

function calculateSingleTowerParams(layers, inputDim = 100) {
    let params = 0;
    let prevDim = inputDim;
    for (const layer of layers) {
        if (layer.type === 'dense') {
            params += prevDim * layer.units + layer.units;
            prevDim = layer.units;
        } else if (layer.type === 'batch_norm') {
            params += prevDim * 4;
        } else if (layer.type === 'layer_norm') {
            params += prevDim * 2;
        }
    }
    return params;
}

// =============================================================================
// INITIALIZATION
// =============================================================================
document.addEventListener('DOMContentLoaded', function() {
    loadInitialData();
    loadExperimentsDashboard();
});

async function loadInitialData() {
    try {
        // Load Feature Configs, Model Configs, and Experiments in parallel
        const [fcResponse, mcResponse, expResponse] = await Promise.all([
            fetch(`/api/models/${modelId}/feature-configs/`),
            fetch('/api/model-configs/'),
            fetch('/api/quick-tests/?page=1&page_size=10')
        ]);

        const fcData = await fcResponse.json();
        const mcData = await mcResponse.json();
        const expData = await expResponse.json();

        if (fcData.success) {
            // Filter out test/draft configs (names starting with 'test_' or 'old_')
            // but keep all configs that have transform code generated
            allFeatureConfigs = fcData.data.filter(c => {
                if (!c.has_transform_code) return false;
                const name = (c.name || '').toLowerCase();
                // Exclude test/draft configs by name pattern
                if (name.startsWith('test_') || name.startsWith('old_')) return false;
                return true;
            });
        }
        if (mcData.success) {
            allModelConfigs = mcData.data;
        }

        // Hide loading
        document.getElementById('expLoading').classList.add('hidden');

        // Check if we have configs
        if (allFeatureConfigs.length === 0 || allModelConfigs.length === 0) {
            document.getElementById('expNoConfigs').classList.remove('hidden');
            return;
        }

        // Populate filter dropdowns
        populateFilterDropdowns();

        // Show experiments or empty state
        if (expData.success) {
            experiments = expData.quick_tests;
            pagination = expData.pagination;

            if (experiments.length === 0) {
                document.getElementById('expEmpty').classList.remove('hidden');
            } else {
                document.getElementById('expFilterBar').classList.remove('hidden');
                document.getElementById('expList').classList.remove('hidden');
                renderExperiments();
                startBackgroundPolling();
            }
        } else {
            // API failed (e.g., no model endpoint) - show empty state
            console.warn('Experiments API error:', expData.error);
            document.getElementById('expEmpty').classList.remove('hidden');
        }

    } catch (error) {
        console.error('Failed to load initial data:', error);
        document.getElementById('expLoading').classList.add('hidden');
        showError('Failed to load data: ' + error.message);
    }
}

function populateFilterDropdowns() {
    // Feature Config filter
    const featureFilter = document.getElementById('expFeatureFilter');
    allFeatureConfigs.forEach(fc => {
        const option = document.createElement('option');
        option.value = fc.id;
        option.textContent = fc.name;
        featureFilter.appendChild(option);
    });

    // Model Config filter
    const modelFilter = document.getElementById('expModelFilter');
    allModelConfigs.forEach(mc => {
        const option = document.createElement('option');
        option.value = mc.id;
        option.textContent = mc.name;
        modelFilter.appendChild(option);
    });
}

// =============================================================================
// EXPERIMENTS LIST
// =============================================================================
function renderExperiments() {
    const container = document.getElementById('expCardsContainer');

    if (experiments.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <i class="fas fa-search text-2xl mb-2"></i>
                <p>No experiments match your filters</p>
            </div>
        `;
        document.getElementById('expPagination').classList.add('hidden');
        return;
    }

    container.innerHTML = experiments.map(exp => renderExpCard(exp)).join('');
    renderPagination();
}

function renderMetricsRow(exp) {
    const formatRecall = v => v != null ? (v * 100).toFixed(1) + '%' : '--';
    const metrics = [
        { label: 'R@5', value: exp.recall_at_5 },
        { label: 'R@10', value: exp.recall_at_10 },
        { label: 'R@50', value: exp.recall_at_50 },
        { label: 'R@100', value: exp.recall_at_100 }
    ];

    return `
        <div class="exp-card-metrics-row">
            ${metrics.map(m => `
                <div class="exp-card-metric">
                    <div class="exp-card-metric-label">${m.label}</div>
                    <div class="exp-card-metric-value ${m.value == null ? 'empty' : ''}">${formatRecall(m.value)}</div>
                </div>
            `).join('')}
        </div>
    `;
}

function renderExpCard(exp) {
    const statusIcons = {
        'submitting': 'fa-spinner fa-spin',
        'running': 'fa-spinner fa-spin',
        'completed': 'fa-check',
        'failed': 'fa-times',
        'cancelled': 'fa-ban'
    };

    const statusClass = exp.status === 'submitting' ? 'submitting' : exp.status;
    const icon = statusIcons[exp.status] || 'fa-clock';

    // Build the progress bar
    const stagesHtml = renderStagesBar(exp.stage_details || getDefaultStages());

    // Truncate description to 50 chars
    const descTruncated = exp.experiment_description
        ? (exp.experiment_description.length > 50
            ? exp.experiment_description.substring(0, 50) + '...'
            : exp.experiment_description)
        : '';

    // Format Start and End times
    const formatDateTime = (isoStr) => {
        if (!isoStr) return '-';
        const d = new Date(isoStr);
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' +
               d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    };
    const startTime = formatDateTime(exp.started_at || exp.created_at);
    const endTime = exp.completed_at ? formatDateTime(exp.completed_at) : '-';

    // Show Cancel button - active only for running/submitting experiments
    const isRunning = exp.status === 'running' || exp.status === 'submitting';
    const viewBtn = `<button class="card-action-btn view" onclick="viewExpFromCard(event, ${exp.id})">View</button>`;
    const cancelBtn = `<button class="card-action-btn cancel" onclick="cancelExpFromCard(event, ${exp.id})" ${isRunning ? '' : 'disabled'}>Cancel</button>`;
    // Delete button - disabled for running/submitting experiments (must cancel first)
    const canDelete = !isRunning;
    const deleteBtn = `<button class="card-action-btn delete" onclick="deleteExpFromCard(event, ${exp.id})" title="Delete experiment" ${canDelete ? '' : 'disabled'}><i class="fas fa-trash"></i></button>`;

    return `
        <div class="exp-card-new" onclick="openExpDetails(${exp.id})" data-exp-id="${exp.id}">
            <div class="exp-card-columns">
                <!-- Column 1: Experiment Info (30%) -->
                <div class="exp-card-col-info">
                    <div class="exp-card-status ${statusClass}">
                        <i class="fas ${icon}"></i>
                    </div>
                    <div class="exp-card-info-text">
                        <div class="exp-card-name">${exp.display_name}</div>
                        ${exp.experiment_name ? `<div class="exp-card-exp-name">${exp.experiment_name}</div>` : ''}
                        ${descTruncated ? `<div class="exp-card-description" title="${exp.experiment_description}">${descTruncated}</div>` : ''}
                        <div class="exp-card-times">
                            <div>Start: <span>${startTime}</span></div>
                            <div>End: <span>${endTime}</span></div>
                        </div>
                    </div>
                </div>
                <!-- Column 2: Config Info (20%) -->
                <div class="exp-card-col-config">
                    <div class="exp-card-config-item"><span class="exp-card-config-label">Dataset:</span> ${exp.dataset_name || '-'}</div>
                    <div class="exp-card-config-item"><span class="exp-card-config-label">Features:</span> ${exp.feature_config_name || '-'}</div>
                    <div class="exp-card-config-item"><span class="exp-card-config-label">Model:</span> ${exp.model_config_name || '-'}</div>
                    <div class="exp-card-config-item"><span class="exp-card-config-label">Type:</span> ${exp.model_type || '-'}</div>
                </div>
                <!-- Column 3: Accuracy Metrics (30%) -->
                <div class="exp-card-col-params">
                    ${renderMetricsRow(exp)}
                </div>
                <!-- Column 4: Actions (20%) -->
                <div class="exp-card-col-actions">
                    <div class="exp-card-actions-row">
                        ${viewBtn}
                        ${cancelBtn}
                    </div>
                    <div class="exp-card-actions-row">
                        ${deleteBtn}
                    </div>
                </div>
            </div>
            ${stagesHtml}
        </div>
    `;
}

function renderStagesBar(stages) {
    // Render the 6-stage progress bar (tensor-breakdown-bar style)
    // Green gradient palette for completed stages - saturated enough for white text
    const completedColors = ['#059669', '#10b981', '#22c55e', '#34d399', '#4ade80', '#6ee7b7'];

    const stagesHtml = stages.map((stage, idx) => {
        const status = stage.status || 'pending';
        // Apply gradient color for completed stages based on position
        const style = status === 'completed' ? `style="background: ${completedColors[idx % completedColors.length]}"` : '';
        return `<div class="exp-stage-segment ${status}" ${style} title="${stage.name}">${stage.name}</div>`;
    }).join('');

    return `
        <div class="exp-card-stages">
            <div class="exp-stages-bar">
                ${stagesHtml}
            </div>
        </div>
    `;
}

function renderPagination() {
    if (pagination.total_pages <= 1) {
        document.getElementById('expPagination').classList.add('hidden');
        return;
    }

    document.getElementById('expPagination').classList.remove('hidden');

    const start = (pagination.page - 1) * pagination.page_size + 1;
    const end = Math.min(pagination.page * pagination.page_size, pagination.total_count);

    document.getElementById('expShowingStart').textContent = start;
    document.getElementById('expShowingEnd').textContent = end;
    document.getElementById('expTotalCount').textContent = pagination.total_count;

    // Generate page buttons
    const buttonsContainer = document.getElementById('expPaginationButtons');
    let buttonsHtml = '';

    // Previous button
    buttonsHtml += `
        <button class="exp-pagination-btn" onclick="goToPage(${pagination.page - 1})" ${!pagination.has_prev ? 'disabled' : ''}>
            Previous
        </button>
    `;

    // Page numbers (show max 5)
    const maxButtons = 5;
    let startPage = Math.max(1, pagination.page - Math.floor(maxButtons / 2));
    let endPage = Math.min(pagination.total_pages, startPage + maxButtons - 1);
    startPage = Math.max(1, endPage - maxButtons + 1);

    for (let i = startPage; i <= endPage; i++) {
        buttonsHtml += `
            <button class="exp-pagination-btn ${i === pagination.page ? 'active' : ''}" onclick="goToPage(${i})">
                ${i}
            </button>
        `;
    }

    // Next button
    buttonsHtml += `
        <button class="exp-pagination-btn" onclick="goToPage(${pagination.page + 1})" ${!pagination.has_next ? 'disabled' : ''}>
            Next
        </button>
    `;

    buttonsContainer.innerHTML = buttonsHtml;
}

async function goToPage(page) {
    if (page < 1 || page > pagination.total_pages) return;
    await loadExperiments(page);
}

async function loadExperiments(page = 1) {
    const status = document.getElementById('expStatusFilter').value;
    const featureConfigId = document.getElementById('expFeatureFilter').value;
    const modelConfigId = document.getElementById('expModelFilter').value;
    const search = document.getElementById('expSearchInput').value.trim();

    let url = `/api/quick-tests/?page=${page}&page_size=${pagination.page_size}`;
    if (status) url += `&status=${status}`;
    if (featureConfigId) url += `&feature_config_id=${featureConfigId}`;
    if (modelConfigId) url += `&model_config_id=${modelConfigId}`;
    if (search) url += `&search=${encodeURIComponent(search)}`;

    try {
        const response = await fetch(url);
        const data = await response.json();

        if (data.success) {
            experiments = data.quick_tests;
            pagination = data.pagination;
            renderExperiments();
        }
    } catch (error) {
        console.error('Error loading experiments:', error);
    }
}

function filterExperiments() {
    loadExperiments(1);
}

function debounceExpSearch() {
    clearTimeout(searchDebounceTimer);
    searchDebounceTimer = setTimeout(() => filterExperiments(), 300);
}

// =============================================================================
// WIZARD MODAL
// =============================================================================
function openNewExpWizard() {
    // Reset wizard state
    wizardStep = 1;
    selectedFeatureConfig = null;
    selectedModelConfig = null;

    // Populate dropdowns
    populateWizardDropdowns();

    // Reset UI
    updateWizardUI();
    document.getElementById('wizardExpName').value = '';
    document.getElementById('wizardExpDescription').value = '';
    document.getElementById('wizardFeatureSelect').value = '';
    document.getElementById('wizardModelSelect').value = '';
    document.getElementById('wizardFeaturePreview').classList.add('hidden');
    document.getElementById('wizardFeatureEmpty').classList.remove('hidden');
    document.getElementById('wizardModelPreview').classList.add('hidden');
    document.getElementById('wizardModelEmpty').classList.remove('hidden');

    // Reset training params
    document.getElementById('wizardSplitStrategy').value = 'random';
    document.getElementById('wizardSamplePercentInput').value = '100';
    document.querySelectorAll('.sample-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.value === '100');
    });
    // Reset training parameters with button states
    setParam('epochs', 25);
    setParam('batchSize', 1024);
    setParam('learningRate', 0.01);
    // Reset split strategy UI (use style.display for inline-styled elements)
    document.getElementById('wizardRandomInfo').style.display = 'flex';
    document.getElementById('wizardTimeOptions').style.display = 'none';
    document.getElementById('wizardDateColumnSection').style.display = 'none';
    document.getElementById('wizardRollingWindowSection').style.display = 'none';
    document.getElementById('wizardRatingSection').classList.add('hidden');
    // Reset rolling window values
    document.getElementById('wizardTrainDays').value = '60';
    document.getElementById('wizardValDays').value = '7';
    document.getElementById('wizardTestDays').value = '7';

    // Reset example count
    datasetEstimatedRows = null;
    document.getElementById('wizardExampleCountValue').textContent = '--';

    document.getElementById('newExpWizardModal').classList.remove('hidden');
}

function closeNewExpWizard() {
    document.getElementById('newExpWizardModal').classList.add('hidden');
}

function populateWizardDropdowns() {
    // Feature Config dropdown
    const fcSelect = document.getElementById('wizardFeatureSelect');
    fcSelect.innerHTML = '<option value="">-- Select Feature Config --</option>';

    // Group by dataset
    const byDataset = {};
    allFeatureConfigs.forEach(fc => {
        const dsName = fc.dataset_name || 'Unknown Dataset';
        if (!byDataset[dsName]) byDataset[dsName] = [];
        byDataset[dsName].push(fc);
    });

    Object.entries(byDataset).forEach(([dsName, configs]) => {
        const optgroup = document.createElement('optgroup');
        optgroup.label = dsName;
        configs.forEach(fc => {
            const option = document.createElement('option');
            option.value = fc.id;
            option.textContent = fc.name;
            optgroup.appendChild(option);
        });
        fcSelect.appendChild(optgroup);
    });

    // Model Config dropdown
    const mcSelect = document.getElementById('wizardModelSelect');
    mcSelect.innerHTML = '<option value="">-- Select Model Config --</option>';

    allModelConfigs.forEach(mc => {
        const option = document.createElement('option');
        option.value = mc.id;
        option.textContent = mc.name;
        mcSelect.appendChild(option);
    });
}

function onWizardFeatureChange() {
    const fcId = parseInt(document.getElementById('wizardFeatureSelect').value);
    selectedFeatureConfig = allFeatureConfigs.find(fc => fc.id === fcId) || null;

    if (selectedFeatureConfig) {
        // Show preview panel with loading state
        document.getElementById('wizardFeatureEmpty').classList.add('hidden');
        document.getElementById('wizardFeaturePreview').classList.remove('hidden');
        document.getElementById('wizardFeatureLoading').classList.remove('hidden');
        document.getElementById('wizardFeatureContent').classList.add('hidden');

        // Fetch full feature config details
        fetch(`/api/feature-configs/${fcId}/`)
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    renderWizardFeaturePreview(data.data);
                }
            })
            .catch(err => {
                console.error('Error loading feature config:', err);
            })
            .finally(() => {
                document.getElementById('wizardFeatureLoading').classList.add('hidden');
                document.getElementById('wizardFeatureContent').classList.remove('hidden');
            });

        // Load date columns for time-based split
        loadWizardDateColumns(selectedFeatureConfig.dataset_id);
    } else {
        document.getElementById('wizardFeaturePreview').classList.add('hidden');
        document.getElementById('wizardFeatureEmpty').classList.remove('hidden');
    }

    updateWizardSummary();
}

function renderWizardFeaturePreview(config) {
    // Update dataset name
    document.getElementById('wizardFeatureDataset').textContent = config.dataset_name || '-';

    // Build and insert dataset info HTML
    const datasetInfoHtml = buildDatasetInfoHtml(config.dataset_info, config.dataset_name);
    document.getElementById('wizardDatasetInfo').innerHTML = datasetInfoHtml;

    // Calculate tensor breakdowns
    const buyerResult = calculateTensorBreakdown(
        config.buyer_model_features || [],
        config.buyer_model_crosses || []
    );
    const productResult = calculateTensorBreakdown(
        config.product_model_features || [],
        config.product_model_crosses || []
    );

    // Update tensor dimensions
    document.getElementById('wizardBuyerDim').textContent = `${buyerResult.total}D`;
    document.getElementById('wizardProductDim').textContent = `${productResult.total}D`;

    // Render feature lists
    const buyerFeaturesHtml = buyerResult.breakdown.map(item => `
        <div class="flex items-center justify-between text-sm">
            <span class="${item.is_cross ? 'text-blue-600 italic' : 'text-blue-700'}">${item.name}</span>
            <span class="text-blue-500 font-medium">${item.dim}D</span>
        </div>
    `).join('');
    document.getElementById('wizardBuyerFeatures').innerHTML = buyerFeaturesHtml || '<div class="text-sm text-gray-400">No features</div>';

    const productFeaturesHtml = productResult.breakdown.map(item => `
        <div class="flex items-center justify-between text-sm">
            <span class="${item.is_cross ? 'text-green-600 italic' : 'text-green-700'}">${item.name}</span>
            <span class="text-green-500 font-medium">${item.dim}D</span>
        </div>
    `).join('');
    document.getElementById('wizardProductFeatures').innerHTML = productFeaturesHtml || '<div class="text-sm text-gray-400">No features</div>';

    // Render tensor bars with proportional widths
    const maxTotal = Math.max(buyerResult.total || 0, productResult.total || 0);

    setTimeout(() => {
        const buyerBar = document.getElementById('wizardBuyerBar');
        const productBar = document.getElementById('wizardProductBar');
        if (buyerBar && buyerResult.breakdown.length > 0) {
            renderWizardTensorPreview('buyer', buyerResult.total, buyerResult.breakdown, buyerBar, maxTotal);
        }
        if (productBar && productResult.breakdown.length > 0) {
            renderWizardTensorPreview('product', productResult.total, productResult.breakdown, productBar, maxTotal);
        }
    }, 0);

    // Store estimated rows for example count calculation
    datasetEstimatedRows = config.dataset_info?.estimated_rows || null;
    // Store date days for split strategy calculations
    datasetDateDays = config.dataset_info?.date_days || null;
    updateExampleCount();
    updateHardwareRecommendation();
}

function updateExampleCount() {
    const samplePercent = parseInt(document.getElementById('wizardSamplePercentInput').value) || 100;
    const countEl = document.getElementById('wizardExampleCountValue');

    if (datasetEstimatedRows && datasetEstimatedRows > 0) {
        const estimatedExamples = Math.round(datasetEstimatedRows * samplePercent / 100);
        countEl.textContent = `~${estimatedExamples.toLocaleString()}`;
    } else {
        countEl.textContent = '--';
    }
}

function setSamplePercent(value) {
    // Update input
    document.getElementById('wizardSamplePercentInput').value = value;

    // Update button states
    document.querySelectorAll('.sample-btn').forEach(btn => {
        btn.classList.toggle('active', parseInt(btn.dataset.value) === value);
    });

    updateExampleCount();
    updateWizardSummary();
}

function onSampleInputChange() {
    let value = parseInt(document.getElementById('wizardSamplePercentInput').value) || 100;

    // Clamp to valid range
    value = Math.max(1, Math.min(100, value));
    document.getElementById('wizardSamplePercentInput').value = value;

    // Update button states (deactivate all if custom value)
    const presetValues = [5, 10, 25, 100];
    document.querySelectorAll('.sample-btn').forEach(btn => {
        btn.classList.toggle('active', parseInt(btn.dataset.value) === value && presetValues.includes(value));
    });

    updateExampleCount();
    updateWizardSummary();
}

// Training parameter button handlers
const paramInputMap = {
    epochs: 'wizardEpochs',
    batchSize: 'wizardBatchSize',
    learningRate: 'wizardLearningRate'
};

const paramPresets = {
    epochs: [5, 10, 25, 50, 100],
    batchSize: [1024, 2048, 4096, 8192],
    learningRate: [0.001, 0.01, 0.05, 0.1]
};

function setParam(param, value) {
    // Update input
    const inputId = paramInputMap[param];
    document.getElementById(inputId).value = value;

    // Update button states
    document.querySelectorAll(`.param-btn[data-param="${param}"]`).forEach(btn => {
        const btnValue = parseFloat(btn.dataset.value);
        btn.classList.toggle('active', btnValue === value);
    });

    // Update summary
    updateWizardSummary();
}

// Hardware selection functions
const hardwareTiers = {
    'n1-standard-4': { name: 'Small', vcpu: 4, ram: 15 },
    'n1-standard-8': { name: 'Medium', vcpu: 8, ram: 30 },
    'n1-standard-16': { name: 'Large', vcpu: 16, ram: 60 },
};

function selectHardware(machineType) {
    // Update hidden input
    document.getElementById('wizardMachineType').value = machineType;

    // Update card selection states
    document.querySelectorAll('.hardware-card').forEach(card => {
        card.classList.toggle('selected', card.dataset.machine === machineType);
    });

    // Update summary
    updateWizardSummary();
}

function updateHardwareRecommendation() {
    // Get dataset row count and model params
    const rowCount = datasetEstimatedRows || 0;
    const modelParams = selectedModelConfig ? (
        (selectedModelConfig.buyer_tensor_dim || 0) + (selectedModelConfig.product_tensor_dim || 0)
    ) : 0;

    // Determine recommendation
    let recommended = 'n1-standard-4';
    let reason = 'dataset size';

    if (rowCount > 500000 || modelParams > 5000000) {
        recommended = 'n1-standard-16';
        reason = rowCount > 500000 ? 'large dataset (>500K rows)' : 'complex model (>5M params)';
    } else if (rowCount > 100000 || modelParams > 1000000) {
        recommended = 'n1-standard-8';
        reason = rowCount > 100000 ? 'medium dataset (>100K rows)' : 'model complexity';
    }

    // Update recommendation text
    const tier = hardwareTiers[recommended];
    document.getElementById('hardwareRecommendation').innerHTML =
        `Recommended: <strong>${tier.name}</strong> based on ${reason}`;

    // Update recommended badge on cards
    document.querySelectorAll('.hardware-card').forEach(card => {
        card.classList.toggle('recommended', card.dataset.machine === recommended);
    });

    // Auto-select if nothing selected yet or if this is initial load
    const currentSelection = document.getElementById('wizardMachineType').value;
    if (!currentSelection || currentSelection === 'n1-standard-4') {
        selectHardware(recommended);
    }
}

function onParamInputChange(param) {
    const inputId = paramInputMap[param];
    const input = document.getElementById(inputId);
    let value = parseFloat(input.value);

    // Handle NaN
    if (isNaN(value)) {
        value = param === 'learningRate' ? 0.01 : (param === 'epochs' ? 25 : 1024);
        input.value = value;
    }

    // Update button states (deactivate all if custom value)
    const presets = paramPresets[param];
    document.querySelectorAll(`.param-btn[data-param="${param}"]`).forEach(btn => {
        const btnValue = parseFloat(btn.dataset.value);
        btn.classList.toggle('active', btnValue === value && presets.includes(value));
    });

    updateWizardSummary();
}

function onWizardModelChange() {
    const mcId = parseInt(document.getElementById('wizardModelSelect').value);
    selectedModelConfig = allModelConfigs.find(mc => mc.id === mcId) || null;

    if (selectedModelConfig) {
        // Show preview panel with loading state
        document.getElementById('wizardModelEmpty').classList.add('hidden');
        document.getElementById('wizardModelPreview').classList.remove('hidden');
        document.getElementById('wizardModelLoading').classList.remove('hidden');
        document.getElementById('wizardModelContent').classList.add('hidden');

        // Fetch full model config details
        fetch(`/api/model-configs/${mcId}/`)
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    renderWizardModelPreview(data.data);
                }
            })
            .catch(err => {
                console.error('Error loading model config:', err);
            })
            .finally(() => {
                document.getElementById('wizardModelLoading').classList.add('hidden');
                document.getElementById('wizardModelContent').classList.remove('hidden');
            });

        // Update training params from model config and sync button states
        setParam('learningRate', selectedModelConfig.learning_rate);
        setParam('batchSize', selectedModelConfig.batch_size);
        // Epochs not in model config, keep default

        // Show rating column section for ranking models
        if (selectedModelConfig.model_type === 'ranking' || selectedModelConfig.model_type === 'multitask') {
            document.getElementById('wizardRatingSection').classList.remove('hidden');
            if (selectedFeatureConfig) {
                loadWizardRatingColumns(selectedFeatureConfig.dataset_id);
            }
        } else {
            document.getElementById('wizardRatingSection').classList.add('hidden');
        }
    } else {
        document.getElementById('wizardModelPreview').classList.add('hidden');
        document.getElementById('wizardModelEmpty').classList.remove('hidden');
    }

    updateWizardSummary();
    updateHardwareRecommendation();
}

function renderWizardModelPreview(mc) {
    // Tower stacks - use detailed visualization with aligned layers
    const buyerLayers = mc.buyer_tower_layers || [];
    const productLayers = mc.product_tower_layers || [];
    const towerHtml = renderCardTowerLayers(buyerLayers, productLayers);

    document.getElementById('wizardBuyerStack').innerHTML = towerHtml.buyer;
    document.getElementById('wizardProductStack').innerHTML = towerHtml.product;

    // Per-tower parameter summaries
    const buyerParams = calculateSingleTowerParams(buyerLayers);
    const productParams = calculateSingleTowerParams(productLayers);
    document.getElementById('wizardBuyerTotalParams').textContent = buyerParams.toLocaleString();
    document.getElementById('wizardBuyerTrainableParams').textContent = buyerParams.toLocaleString();
    document.getElementById('wizardProductTotalParams').textContent = productParams.toLocaleString();
    document.getElementById('wizardProductTrainableParams').textContent = productParams.toLocaleString();

    // Training parameters
    document.getElementById('wizardModelParams').innerHTML = `
        <div class="param-chip">
            <span class="param-chip-label">Optimizer:</span>
            <span class="param-chip-value">${mc.optimizer_display || mc.optimizer}</span>
        </div>
        <div class="param-chip">
            <span class="param-chip-label">Learning Rate:</span>
            <span class="param-chip-value">${mc.learning_rate}</span>
        </div>
        <div class="param-chip">
            <span class="param-chip-label">Batch Size:</span>
            <span class="param-chip-value">${mc.batch_size}</span>
        </div>
        <div class="param-chip">
            <span class="param-chip-label">Output Dim:</span>
            <span class="param-chip-value">${mc.output_embedding_dim || 32}D</span>
        </div>
    `;

    // Retrieval algorithm section (for retrieval and multitask models)
    const retrievalSection = document.getElementById('wizardRetrievalSection');
    if (['retrieval', 'multitask'].includes(mc.model_type)) {
        retrievalSection.classList.remove('hidden');
        document.getElementById('wizardRetrievalParams').innerHTML = `
            <div class="param-chip retrieval-algo">
                <span class="param-chip-label">Algorithm:</span>
                <span class="param-chip-value">${mc.retrieval_algorithm_display || 'Brute Force'}</span>
            </div>
            <div class="param-chip">
                <span class="param-chip-label">Top-K:</span>
                <span class="param-chip-value">${mc.top_k || 100}</span>
            </div>
            ${mc.retrieval_algorithm === 'scann' ? `
            <div class="param-chip">
                <span class="param-chip-label">Num Leaves:</span>
                <span class="param-chip-value">${mc.scann_num_leaves || 100}</span>
            </div>
            <div class="param-chip">
                <span class="param-chip-label">Leaves to Search:</span>
                <span class="param-chip-value">${mc.scann_leaves_to_search || 10}</span>
            </div>
            ` : ''}
        `;
    } else {
        retrievalSection.classList.add('hidden');
    }
}

function onWizardSplitChange() {
    const strategy = document.getElementById('wizardSplitStrategy').value;
    const isTimeBased = strategy === 'time_holdout' || strategy === 'strict_time';
    const isStrictTime = strategy === 'strict_time';
    const isTimeHoldout = strategy === 'time_holdout';
    const isRandom = strategy === 'random';

    // Random info - only for random
    document.getElementById('wizardRandomInfo').style.display = isRandom ? 'flex' : 'none';

    // Date column - required for both time-based strategies
    document.getElementById('wizardDateColumnSection').style.display = isTimeBased ? 'flex' : 'none';

    // Holdout days - only for time_holdout
    document.getElementById('wizardTimeOptions').style.display = isTimeHoldout ? 'flex' : 'none';

    // Rolling window - only for strict_time
    document.getElementById('wizardRollingWindowSection').style.display = isStrictTime ? 'block' : 'none';

    // Set dynamic defaults for strict temporal split based on dataset date range
    if (isStrictTime && datasetDateDays && datasetDateDays > 0) {
        // Split ratios: Train 80%, Validation 15%, Test 5%
        const trainDays = Math.max(1, Math.floor(datasetDateDays * 0.80));
        const valDays = Math.max(1, Math.floor(datasetDateDays * 0.15));
        const testDays = Math.max(1, datasetDateDays - trainDays - valDays);

        document.getElementById('wizardTrainDays').value = trainDays;
        document.getElementById('wizardValDays').value = valDays;
        document.getElementById('wizardTestDays').value = testDays;
    }

    updateWizardSummary();
}

async function loadWizardDateColumns(datasetId) {
    if (!datasetId) return;

    try {
        const response = await fetch(`/api/datasets/${datasetId}/date-columns/`);
        const data = await response.json();

        const select = document.getElementById('wizardDateColumn');
        select.innerHTML = '<option value="">Select date column...</option>';

        if (data.success && data.date_columns) {
            let primaryColumn = null;
            data.date_columns.forEach(col => {
                const option = document.createElement('option');
                option.value = col.name;
                // Use display_name (alias) if available, fallback to name
                const displayName = col.display_name || col.name;
                // Show (recommended) for primary date column from dataset config
                const label = col.primary
                    ? `${displayName} (${col.type}) - recommended`
                    : `${displayName} (${col.type})`;
                option.textContent = label;
                select.appendChild(option);

                // Track primary for auto-selection
                if (col.primary) {
                    primaryColumn = col.name;
                }
            });

            // Auto-select the primary date column if available
            if (primaryColumn) {
                select.value = primaryColumn;
            }
        }
    } catch (error) {
        console.error('Error loading date columns:', error);
    }
}

async function loadWizardRatingColumns(datasetId) {
    if (!datasetId) return;

    try {
        const response = await fetch(`/api/datasets/${datasetId}/columns/`);
        const data = await response.json();

        const select = document.getElementById('wizardRatingColumn');
        select.innerHTML = '<option value="">Select rating column...</option>';

        if (data.success && data.data && data.data.columns) {
            const numericCols = data.data.columns.filter(col =>
                col.dtype.includes('int') || col.dtype.includes('float')
            );
            numericCols.forEach(col => {
                const option = document.createElement('option');
                option.value = col.name;
                // Use display_name (alias) if available, fallback to name
                const displayName = col.display_name || col.name;
                option.textContent = `${displayName} (${col.dtype})`;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error loading rating columns:', error);
    }
}

function updateWizardUI() {
    // Update step indicators
    document.getElementById('wizardCurrentStep').textContent = wizardStep;

    // Update progress pills - matches model_configs.html pattern
    document.getElementById('wizardProgress1').className = 'progress-step-pill ' +
        (wizardStep === 1 ? 'current' : 'completed');
    document.getElementById('wizardProgress2').className = 'progress-step-pill ' +
        (wizardStep === 2 ? 'current' : 'future');

    // Show/hide steps
    document.getElementById('wizardStep1').classList.toggle('active', wizardStep === 1);
    document.getElementById('wizardStep2').classList.toggle('active', wizardStep === 2);

    // Show/hide navigation buttons
    document.getElementById('wizardBackBtn').classList.toggle('hidden', wizardStep === 1);
    document.getElementById('wizardNextBtn').classList.toggle('hidden', wizardStep === 2);

    // Show/hide action buttons
    document.getElementById('wizardRunBtn').classList.toggle('hidden', wizardStep !== 2);

    // Scroll modal body to top when changing steps
    const modalBody = document.getElementById('wizardModalBody');
    if (modalBody) {
        modalBody.scrollTop = 0;
    }
}

function updateWizardSummary() {
    // Config names
    document.getElementById('wizardSummaryFeature').textContent =
        selectedFeatureConfig ? selectedFeatureConfig.name : '-';
    document.getElementById('wizardSummaryModel').textContent =
        selectedModelConfig ? selectedModelConfig.name : '-';

    // Data settings
    const samplePercent = document.getElementById('wizardSamplePercentInput').value || '100';
    document.getElementById('wizardSummarySample').textContent = samplePercent + '%';

    // Split strategy
    const splitStrategy = document.getElementById('wizardSplitStrategy').value;
    const splitLabels = {
        'random': 'Random 80/15/5',
        'time_holdout': 'Time Holdout',
        'strict_time': 'Strict Temporal'
    };
    document.getElementById('wizardSummarySplit').textContent = splitLabels[splitStrategy] || splitStrategy;

    // Training parameters
    document.getElementById('wizardSummaryEpochs').textContent =
        document.getElementById('wizardEpochs').value || '25';
    document.getElementById('wizardSummaryBatch').textContent =
        document.getElementById('wizardBatchSize').value || '1024';
    document.getElementById('wizardSummaryLR').textContent =
        document.getElementById('wizardLearningRate').value || '0.01';

    // Hardware
    const machineType = document.getElementById('wizardMachineType').value || 'n1-standard-4';
    const tier = hardwareTiers[machineType];
    document.getElementById('wizardSummaryHardware').textContent = tier ? tier.name : 'Small';
}

function wizardNext() {
    if (wizardStep === 1) {
        // Validate step 1
        if (!selectedFeatureConfig) {
            showError('Please select a Feature Config');
            return;
        }
        if (!selectedModelConfig) {
            showError('Please select a Model Config');
            return;
        }

        wizardStep = 2;
        updateWizardUI();
    }
}

function wizardBack() {
    if (wizardStep === 2) {
        wizardStep = 1;
        updateWizardUI();
    }
}

async function submitExperiment() {
    // Validate
    if (!selectedFeatureConfig || !selectedModelConfig) {
        showError('Please select both Feature Config and Model Config');
        return;
    }

    const splitStrategy = document.getElementById('wizardSplitStrategy').value;
    const dateColumn = document.getElementById('wizardDateColumn').value;

    if ((splitStrategy === 'time_holdout' || splitStrategy === 'strict_time') && !dateColumn) {
        showError('Please select a date column for time-based split');
        return;
    }

    // Build payload
    const payload = {
        model_config_id: selectedModelConfig.id,
        split_strategy: splitStrategy,
        data_sample_percent: parseInt(document.getElementById('wizardSamplePercentInput').value) || 100,
        holdout_days: parseInt(document.getElementById('wizardHoldoutDays').value) || 1,
        date_column: dateColumn,
        epochs: parseInt(document.getElementById('wizardEpochs').value),
        batch_size: parseInt(document.getElementById('wizardBatchSize').value),
        learning_rate: parseFloat(document.getElementById('wizardLearningRate').value),
        // Rolling window parameters for strict_time
        train_days: parseInt(document.getElementById('wizardTrainDays').value) || 60,
        val_days: parseInt(document.getElementById('wizardValDays').value) || 7,
        test_days: parseInt(document.getElementById('wizardTestDays').value) || 7,
        // Hardware configuration
        machine_type: document.getElementById('wizardMachineType').value || 'n1-standard-4',
        // Experiment metadata (optional)
        experiment_name: document.getElementById('wizardExpName').value.trim(),
        experiment_description: document.getElementById('wizardExpDescription').value.trim()
    };

    // Add rating column for ranking models
    if (selectedModelConfig.model_type === 'ranking' || selectedModelConfig.model_type === 'multitask') {
        payload.rating_column = document.getElementById('wizardRatingColumn').value;
    }

    // Disable run button and show spinner
    const runBtn = document.getElementById('wizardRunBtn');
    runBtn.disabled = true;
    runBtn.querySelector('.btn-neu-inner').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

    try {
        const response = await fetch(`/api/feature-configs/${selectedFeatureConfig.id}/quick-test/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(payload)
        });

        const data = await response.json();

        if (data.success) {
            // Close wizard
            closeNewExpWizard();

            // Refresh experiments list
            await loadExperiments(1);

            // Show experiments list if it was hidden
            document.getElementById('expEmpty').classList.add('hidden');
            document.getElementById('expFilterBar').classList.remove('hidden');
            document.getElementById('expList').classList.remove('hidden');

            // Start polling
            startBackgroundPolling();
        } else {
            showError(data.error || 'Failed to submit experiment');
        }
    } catch (error) {
        console.error('Error submitting experiment:', error);
        showError('Failed to submit experiment: ' + error.message);
    } finally {
        runBtn.disabled = false;
        runBtn.querySelector('.btn-neu-inner').innerHTML = 'Run';
    }
}

// =============================================================================
// EXPERIMENT DETAILS & VIEW MODAL
// =============================================================================
let viewModalExpId = null;
let viewModalPollInterval = null;

async function openExpDetails(expId) {
    try {
        const response = await fetch(`/api/quick-tests/${expId}/`);
        const data = await response.json();

        if (!data.success) {
            showError(data.error || 'Failed to load experiment details');
            return;
        }

        const exp = data.quick_test;
        openExpViewModal(exp);
    } catch (error) {
        console.error('Error loading experiment details:', error);
        showError('Failed to load experiment details');
    }
}

// =============================================================================
// VIEW MODAL - TABBED DESIGN
// =============================================================================

// State for lazy-loaded tab data
let viewModalDataCache = {
    statistics: null,
    schema: null,
    errorDetails: null,
    trainingHistory: null
};
let currentViewTab = 'overview';

function openExpViewModal(exp) {
    viewModalExpId = exp.id;

    // Reset state
    viewModalDataCache = { statistics: null, schema: null, errorDetails: null, trainingHistory: null };
    currentViewTab = 'overview';

    // Reset tabs to default
    document.querySelectorAll('.exp-view-tab').forEach(t => t.classList.remove('active'));
    document.querySelector('.exp-view-tab[data-tab="overview"]').classList.add('active');
    document.querySelectorAll('.exp-view-tab-content').forEach(c => c.classList.remove('active'));
    document.getElementById('expViewTabOverview').classList.add('active');

    // Populate modal
    populateExpViewModal(exp);
    document.getElementById('expViewModal').classList.remove('hidden');

    // Preload Data Insights in background (warms up Cloud Run service)
    // This runs silently so data is ready when user clicks the Data Insights tab
    preloadDataInsights();

    // Preload training history for completed experiments to show accurate recall metrics
    if (exp.status === 'completed') {
        preloadTrainingHistory();
    }

    // Start polling if experiment is running
    if (exp.status === 'running' || exp.status === 'submitting') {
        startViewModalPolling(exp.id);
    }
}

function closeExpViewModal(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('expViewModal').classList.add('hidden');
    stopViewModalPolling();
    viewModalExpId = null;
    viewModalDataCache = { statistics: null, schema: null, errorDetails: null, trainingHistory: null };
    resetDagState();
}

function loadDatasetDetailsForExp(datasetId) {
    const container = document.getElementById('expViewDatasetDetails');
    container.innerHTML = '<div class="exp-view-loading"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';

    fetch(`/api/datasets/${datasetId}/summary/`, {
        headers: { 'X-CSRFToken': getCookie('csrftoken') }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status !== 'success') {
            container.innerHTML = '<div class="exp-view-no-filters">Failed to load dataset details</div>';
            return;
        }
        renderDatasetDetailsForExp(data.summary);
    })
    .catch(error => {
        console.error('Error loading dataset details:', error);
        container.innerHTML = '<div class="exp-view-no-filters">Failed to load dataset details</div>';
    });
}

function renderDatasetDetailsForExp(summary) {
    const container = document.getElementById('expViewDatasetDetails');
    const snapshot = summary.summary_snapshot || {};
    const filtersApplied = snapshot.filters_applied || {};
    const joinConfig = summary.join_config || {};

    let html = '';

    // Tables & Joins section
    const primaryTable = summary.tables.primary?.replace('raw_data.', '') || '-';
    html += `<div class="exp-view-ds-section">
        <div class="exp-view-ds-title"><i class="fas fa-database"></i>Tables & Joins</div>
        <div class="exp-view-ds-grid">
            <span class="label">Primary:</span>
            <span class="value">${primaryTable}</span>`;

    if (summary.tables.secondary?.length > 0) {
        html += `<span class="label">Secondary:</span>
            <span class="value">${summary.tables.secondary.map(t => t.replace('raw_data.', '')).join(', ')}</span>`;
    }
    html += `</div>`;

    // Join keys
    if (Object.keys(joinConfig).length > 0) {
        html += `<div class="exp-view-ds-join"><span>Join Keys:</span>`;
        for (const [table, config] of Object.entries(joinConfig)) {
            const tableName = table.replace('raw_data.', '');
            html += `<div class="exp-view-ds-join-row">
                <span class="key">${primaryTable}.${config.join_key}</span>
                <i class="fas fa-arrows-alt-h" style="color:#9ca3af;font-size:10px;"></i>
                <span class="key">${tableName}.${config.secondary_column}</span>
                <span class="badge">${config.join_type || 'left'}</span>
            </div>`;
        }
        html += `</div>`;
    }
    html += `</div>`;

    // Filters Applied section
    html += `<div class="exp-view-ds-section">
        <div class="exp-view-ds-title"><i class="fas fa-filter"></i>Filters Applied</div>`;

    let hasFilters = false;

    // Date filter
    if (filtersApplied.dates?.type === 'rolling') {
        hasFilters = true;
        html += `<div class="exp-view-ds-filter date">
            <div class="exp-view-ds-filter-title"><i class="fas fa-calendar-alt"></i>Date Filter</div>
            <div class="exp-view-ds-filter-detail">Column: <strong>${filtersApplied.dates.column || 'N/A'}</strong></div>
            <div class="exp-view-ds-filter-detail">Range: Last ${filtersApplied.dates.days} days (rolling window)</div>
        </div>`;
    } else if (filtersApplied.dates?.type === 'fixed') {
        hasFilters = true;
        html += `<div class="exp-view-ds-filter date">
            <div class="exp-view-ds-filter-title"><i class="fas fa-calendar-alt"></i>Date Filter</div>
            <div class="exp-view-ds-filter-detail">Column: <strong>${filtersApplied.dates.column || 'N/A'}</strong></div>
            <div class="exp-view-ds-filter-detail">Start: ${filtersApplied.dates.start_date}</div>
        </div>`;
    }

    // Customer filters
    if (filtersApplied.customers?.type === 'multiple' && filtersApplied.customers.filters?.length > 0) {
        hasFilters = true;
        const count = filtersApplied.customers.count || filtersApplied.customers.filters.length;
        let items = filtersApplied.customers.filters.map(f => {
            if (f.type === 'top_revenue') {
                return `<div class="exp-view-ds-filter-detail"> Top <strong>${f.percent}%</strong> customers by revenue</div>
                    <div class="exp-view-ds-filter-detail" style="margin-left:10px;font-size:10px;">Customer: ${f.customer_column || 'N/A'}, Revenue: ${f.revenue_column || 'N/A'}</div>`;
            }
            if (f.type === 'category') return `<div class="exp-view-ds-filter-detail"> ${f.column}: ${f.values?.slice(0,3).join(', ')}${f.values?.length > 3 ? '...' : ''}</div>`;
            return `<div class="exp-view-ds-filter-detail"> ${f.type}</div>`;
        }).join('');
        html += `<div class="exp-view-ds-filter customer">
            <div class="exp-view-ds-filter-title"><i class="fas fa-users"></i>Customer Filters (${count})</div>
            ${items}
        </div>`;
    }

    // Product filters
    if (filtersApplied.products?.type === 'multiple' && filtersApplied.products.filters?.length > 0) {
        hasFilters = true;
        const count = filtersApplied.products.count || filtersApplied.products.filters.length;
        let items = filtersApplied.products.filters.map(f => {
            if (f.type === 'top_revenue') {
                return `<div class="exp-view-ds-filter-detail"> Top <strong>${f.percent}%</strong> products by revenue</div>
                    <div class="exp-view-ds-filter-detail" style="margin-left:10px;font-size:10px;">Product: ${f.product_column || 'N/A'}, Revenue: ${f.revenue_column || 'N/A'}</div>`;
            }
            if (f.type === 'category') return `<div class="exp-view-ds-filter-detail"> ${f.column}: ${f.values?.slice(0,3).join(', ')}${f.values?.length > 3 ? '...' : ''}</div>`;
            return `<div class="exp-view-ds-filter-detail"> ${f.type}</div>`;
        }).join('');
        html += `<div class="exp-view-ds-filter product">
            <div class="exp-view-ds-filter-title"><i class="fas fa-box"></i>Product Filters (${count})</div>
            ${items}
        </div>`;
    }

    if (!hasFilters) {
        html += `<div class="exp-view-ds-no-filters">No filters applied - using all data</div>`;
    }

    html += `</div>`;

    container.innerHTML = html;
}

// =============================================================================
// FEATURES CONFIG VISUALIZATION (for View Modal)
// =============================================================================

function loadFeaturesConfigForExp(featureConfigId) {
    const container = document.getElementById('expViewFeaturesConfigContent');
    container.innerHTML = '<div class="exp-view-loading"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';

    fetch(`/api/feature-configs/${featureConfigId}/`, {
        headers: { 'X-CSRFToken': getCookie('csrftoken') }
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            container.innerHTML = '<div class="exp-view-no-filters">Failed to load features config</div>';
            return;
        }
        renderFeaturesConfigForExp(data.data);
    })
    .catch(error => {
        console.error('Error loading features config:', error);
        container.innerHTML = '<div class="exp-view-no-filters">Failed to load features config</div>';
    });
}

function renderFeaturesConfigForExp(config) {
    const container = document.getElementById('expViewFeaturesConfigContent');

    // Calculate tensor breakdowns
    const buyerResult = calculateExpTensorBreakdown(
        config.buyer_model_features || [],
        config.buyer_model_crosses || []
    );
    const productResult = calculateExpTensorBreakdown(
        config.product_model_features || [],
        config.product_model_crosses || []
    );

    const maxTotal = Math.max(buyerResult.total || 0, productResult.total || 0);

    // Build HTML
    let html = '<div class="exp-view-features-grid">';

    // Buyer Tensor Panel
    html += `
        <div class="exp-view-tensor-panel buyer">
            <div class="exp-view-tensor-header">
                <span class="exp-view-tensor-title buyer">Buyer Tensor</span>
                <span class="exp-view-tensor-total buyer">${buyerResult.total}D</span>
            </div>
            <div id="expViewBuyerBar" class="exp-view-tensor-bar"></div>
            <div class="exp-view-tensor-features">
                ${buyerResult.breakdown.map(item => `
                    <div class="exp-view-tensor-feature-row">
                        <span class="exp-view-tensor-feature-name buyer ${item.is_cross ? 'cross' : ''}">${item.name}</span>
                        <span class="exp-view-tensor-feature-dim buyer">${item.dim}D</span>
                    </div>
                `).join('')}
            </div>
        </div>`;

    // Product Tensor Panel
    html += `
        <div class="exp-view-tensor-panel product">
            <div class="exp-view-tensor-header">
                <span class="exp-view-tensor-title product">Product Tensor</span>
                <span class="exp-view-tensor-total product">${productResult.total}D</span>
            </div>
            <div id="expViewProductBar" class="exp-view-tensor-bar"></div>
            <div class="exp-view-tensor-features">
                ${productResult.breakdown.map(item => `
                    <div class="exp-view-tensor-feature-row">
                        <span class="exp-view-tensor-feature-name product ${item.is_cross ? 'cross' : ''}">${item.name}</span>
                        <span class="exp-view-tensor-feature-dim product">${item.dim}D</span>
                    </div>
                `).join('')}
            </div>
        </div>`;

    html += '</div>';
    container.innerHTML = html;

    // Render tensor bars after DOM update
    setTimeout(() => {
        renderExpTensorBar('buyer', buyerResult.total, buyerResult.breakdown, maxTotal);
        renderExpTensorBar('product', productResult.total, productResult.breakdown, maxTotal);
    }, 0);
}

function calculateExpTensorBreakdown(features, crosses) {
    const breakdown = [];
    let total = 0;

    // Process features
    (features || []).forEach(feature => {
        const dim = getExpFeatureDimension(feature);
        if (dim > 0) {
            // Use display_name (alias) if available
            breakdown.push({ name: feature.display_name || feature.column, dim: dim });
            total += dim;
        }
    });

    // Process cross features
    (crosses || []).forEach(cross => {
        const dim = cross.embedding_dim || 16;
        const featureNames = getExpCrossFeatureNames(cross);
        const name = featureNames.join('  ');
        breakdown.push({ name: name, dim: dim, is_cross: true });
        total += dim;
    });

    return { total, breakdown };
}

function getExpFeatureDimension(feature) {
    const dataType = feature.data_type || getExpDataTypeFromBqType(feature.bq_type);
    const transforms = feature.transforms || {};
    let totalDim = 0;

    if (dataType === 'numeric') {
        if (transforms.normalize?.enabled) totalDim += 1;
        if (transforms.bucketize?.enabled) totalDim += (transforms.bucketize.embedding_dim || 32);
    } else if (dataType === 'text') {
        if (transforms.embedding?.enabled) totalDim += (transforms.embedding.embedding_dim || 32);
    } else if (dataType === 'temporal') {
        if (transforms.normalize?.enabled) totalDim += 1;
        if (transforms.cyclical?.enabled) {
            const c = transforms.cyclical;
            if (c.yearly || c.annual) totalDim += 2;
            if (c.quarterly) totalDim += 2;
            if (c.monthly) totalDim += 2;
            if (c.weekly) totalDim += 2;
            if (c.daily) totalDim += 2;
        }
    }

    return totalDim;
}

function getExpDataTypeFromBqType(bqType) {
    const type = (bqType || 'STRING').toUpperCase();
    if (['INTEGER', 'INT64', 'FLOAT', 'FLOAT64', 'NUMERIC', 'BIGNUMERIC'].includes(type)) {
        return 'numeric';
    } else if (['TIMESTAMP', 'DATETIME', 'DATE', 'TIME'].includes(type)) {
        return 'temporal';
    }
    return 'text';
}

function getExpCrossFeatureNames(cross) {
    // Use display_name (alias) if available
    if (!cross.features || cross.features.length === 0) return [];
    if (typeof cross.features[0] === 'string') return cross.features;
    return cross.features.map(f => f.display_name || f.column);
}

function renderExpTensorBar(model, total, breakdown, maxTotal) {
    const barId = model === 'buyer' ? 'expViewBuyerBar' : 'expViewProductBar';
    const bar = document.getElementById(barId);
    if (!bar) return;

    bar.innerHTML = '';
    if (!breakdown || breakdown.length === 0) return;

    // Set bar width proportionally
    if (maxTotal && maxTotal > 0) {
        bar.style.width = `${(total / maxTotal) * 100}%`;
    }

    const colors = model === 'buyer'
        ? ['#3b82f6', '#60a5fa', '#93c5fd', '#bfdbfe', '#dbeafe']
        : ['#10b981', '#34d399', '#6ee7b7', '#a7f3d0', '#d1fae5'];

    breakdown.forEach((item, idx) => {
        const pct = (item.dim / total) * 100;
        const color = colors[idx % colors.length];

        const segment = document.createElement('div');
        segment.className = 'exp-view-tensor-segment';
        segment.style.width = `${pct}%`;
        segment.style.backgroundColor = color;
        segment.title = `${item.name}: ${item.dim}D`;
        if (pct > 10) {
            segment.textContent = item.dim;
        }
        bar.appendChild(segment);
    });
}

// =============================================================================
// MODEL CONFIG VISUALIZATION (for View Modal)
// =============================================================================

function loadModelConfigForExp(modelConfigId) {
    const container = document.getElementById('expViewModelConfigContent');
    container.innerHTML = '<div class="exp-view-loading"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';

    fetch(`/api/model-configs/${modelConfigId}/`, {
        headers: { 'X-CSRFToken': getCookie('csrftoken') }
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            container.innerHTML = '<div class="exp-view-no-filters">Failed to load model config</div>';
            return;
        }
        renderModelConfigForExp(data.data);
    })
    .catch(error => {
        console.error('Error loading model config:', error);
        container.innerHTML = '<div class="exp-view-no-filters">Failed to load model config</div>';
    });
}

function renderModelConfigForExp(mc) {
    const container = document.getElementById('expViewModelConfigContent');

    // Model type badge
    const modelTypeLabels = {
        'retrieval': 'Retrieval',
        'ranking': 'Ranking',
        'multitask': 'Multitask'
    };
    const modelTypeLabel = modelTypeLabels[mc.model_type] || mc.model_type;

    // Build tower layers HTML
    const buyerLayers = mc.buyer_tower_layers || [];
    const productLayers = mc.product_tower_layers || [];
    const buyerParams = calculateExpTowerParams(buyerLayers);
    const productParams = calculateExpTowerParams(productLayers);

    let html = `
        <span class="exp-view-model-type-badge ${mc.model_type}">${modelTypeLabel}</span>

        <div class="exp-view-tower-section-title">Tower Architecture</div>
        <div class="exp-view-towers-grid">
            <div class="exp-view-tower-column">
                <div class="exp-view-tower-header">
                    <span class="exp-view-tower-label">BUYER TOWER</span>
                </div>
                <div class="exp-view-tower-stack buyer">
                    ${renderExpTowerLayers(buyerLayers)}
                </div>
                <div class="exp-view-tower-params buyer">
                    <div class="exp-view-tower-params-row"><span>Total params:</span><span>${buyerParams.toLocaleString()}</span></div>
                    <div class="exp-view-tower-params-row"><span>Trainable params:</span><span>${buyerParams.toLocaleString()}</span></div>
                    <div class="exp-view-tower-params-row"><span>Non-trainable params:</span><span>0</span></div>
                </div>
            </div>
            <div class="exp-view-tower-column">
                <div class="exp-view-tower-header">
                    <span class="exp-view-tower-label">PRODUCT TOWER</span>
                </div>
                <div class="exp-view-tower-stack product">
                    ${renderExpTowerLayers(productLayers)}
                </div>
                <div class="exp-view-tower-params product">
                    <div class="exp-view-tower-params-row"><span>Total params:</span><span>${productParams.toLocaleString()}</span></div>
                    <div class="exp-view-tower-params-row"><span>Trainable params:</span><span>${productParams.toLocaleString()}</span></div>
                    <div class="exp-view-tower-params-row"><span>Non-trainable params:</span><span>0</span></div>
                </div>
            </div>
        </div>`;

    // Rating Head section (for ranking and multitask models)
    if (['ranking', 'multitask'].includes(mc.model_type)) {
        const ratingHeadLayers = mc.rating_head_layers || [];
        const ratingHeadParams = calculateExpTowerParams(ratingHeadLayers, (mc.output_embedding_dim || 32) * 2);

        html += `
        <div class="exp-view-rating-head-section">
            <div class="exp-view-rating-head-title">Rating Head</div>
            <div class="exp-view-rating-head-label">RANKING TOWER</div>
            <div class="exp-view-rating-tower-wrapper">
                <div class="exp-view-tower-stack ranking">
                    ${renderExpTowerLayers(ratingHeadLayers)}
                </div>
                <div class="exp-view-tower-params ranking">
                    <div class="exp-view-tower-params-row"><span>Total params:</span><span>${ratingHeadParams.toLocaleString()}</span></div>
                    <div class="exp-view-tower-params-row"><span>Trainable params:</span><span>${ratingHeadParams.toLocaleString()}</span></div>
                    <div class="exp-view-tower-params-row"><span>Non-trainable params:</span><span>0</span></div>
                </div>
            </div>
        </div>`;
    }

    container.innerHTML = html;

    // Update Optimizer in Training Parameters section (from model config)
    const optimizerEl = document.getElementById('expViewOptimizerValue');
    if (optimizerEl) {
        optimizerEl.textContent = mc.optimizer_display || mc.optimizer || 'Adagrad';
    }
}

function renderExpTowerLayers(layers) {
    if (!layers || layers.length === 0) {
        return '<div class="text-xs text-gray-400 italic p-2">No layers</div>';
    }

    return layers.map((layer, idx) => {
        const isOutput = idx === layers.length - 1;
        let badge = '';
        let params = '';

        if (layer.type === 'dense') {
            badge = '<span class="exp-view-layer-badge dense">DENSE</span>';
            params = `${layer.units} units`;
            if (layer.activation) params += `, ${layer.activation}`;
            if (layer.l2_regularization) params += `, L2=${layer.l2_regularization}`;
            else if (layer.l2_reg) params += `, L2=${layer.l2_reg}`;
        } else if (layer.type === 'dropout') {
            badge = '<span class="exp-view-layer-badge dropout">DROPOUT</span>';
            params = `rate: ${layer.rate}`;
        } else if (layer.type === 'batch_norm') {
            badge = '<span class="exp-view-layer-badge batch_norm">BATCHNORM</span>';
            params = '';
        } else if (layer.type === 'layer_norm') {
            badge = '<span class="exp-view-layer-badge layer_norm">LAYERNORM</span>';
            params = layer.epsilon ? `: ${layer.epsilon}` : '';
        }

        return `
            <div class="exp-view-layer-item${isOutput ? ' output-layer' : ''}">
                <span class="exp-view-layer-drag"><i class="fas fa-grip-vertical"></i></span>
                ${badge}
                <span class="exp-view-layer-params">${params}</span>
            </div>
        `;
    }).join('');
}

function calculateExpTowerParams(layers, inputDim = 128) {
    // Approximate parameter calculation for tower
    if (!layers || layers.length === 0) return 0;

    let total = 0;
    let prevDim = inputDim;

    layers.forEach(layer => {
        if (layer.type === 'dense') {
            // Dense layer: input_dim * units + units (bias)
            total += prevDim * layer.units + layer.units;
            prevDim = layer.units;
        }
        // Dropout and norm layers don't add trainable parameters
    });

    return total;
}

// =============================================================================
// SAMPLING CHIPS (for View Modal)
// =============================================================================

function renderSamplingChips(exp) {
    const container = document.getElementById('expViewSamplingChips');
    if (!container) return;

    const splitLabels = {
        'random': 'Random 80/15/5',
        'time_holdout': 'Time Holdout',
        'strict_time': 'Strict Temporal'
    };

    let html = `
        <div class="exp-view-param-chip">
            <span class="exp-view-param-chip-label">Sample:</span>
            <span class="exp-view-param-chip-value">${exp.data_sample_percent || 100}%</span>
        </div>
        <div class="exp-view-param-chip">
            <span class="exp-view-param-chip-label">Split Strategy:</span>
            <span class="exp-view-param-chip-value">${splitLabels[exp.split_strategy] || exp.split_strategy}</span>
        </div>
    `;

    // Add Date Column chip for temporal strategies
    if (exp.split_strategy !== 'random' && exp.date_column) {
        html += `
        <div class="exp-view-param-chip">
            <span class="exp-view-param-chip-label">Date Column:</span>
            <span class="exp-view-param-chip-value">${exp.date_column}</span>
        </div>
        `;
    }

    // Add Holdout Days chip for time_holdout strategy
    if (exp.split_strategy === 'time_holdout') {
        html += `
        <div class="exp-view-param-chip">
            <span class="exp-view-param-chip-label">Test (last N days):</span>
            <span class="exp-view-param-chip-value">${exp.holdout_days || 1} days</span>
        </div>
        `;
    }

    container.innerHTML = html;
}

// =============================================================================
// TRAINING PARAMETERS CHIPS (for View Modal - actual pipeline values)
// =============================================================================

function renderTrainingParamsChips(exp) {
    const container = document.getElementById('expViewTrainingParamsChips');
    if (!container) return;

    // Hardware specifications mapping
    const hardwareSpecs = {
        'n1-standard-4': { name: 'Small', cpu: '4 vCPUs', memory: '15 GB' },
        'n1-standard-8': { name: 'Medium', cpu: '8 vCPUs', memory: '30 GB' },
        'n1-standard-16': { name: 'Large', cpu: '16 vCPUs', memory: '60 GB' },
        'n1-highmem-4': { name: 'High Memory', cpu: '4 vCPUs', memory: '26 GB' },
        'n1-highmem-8': { name: 'High Memory', cpu: '8 vCPUs', memory: '52 GB' }
    };

    const machineType = exp.machine_type || 'n1-standard-4';
    const hwSpec = hardwareSpecs[machineType] || { name: 'Custom', cpu: '-', memory: '-' };
    const hardwareDisplay = `${hwSpec.cpu}, ${hwSpec.memory}`;

    let html = `
        <div class="exp-view-param-chip" id="expViewOptimizerChip">
            <span class="exp-view-param-chip-label">Optimizer:</span>
            <span class="exp-view-param-chip-value" id="expViewOptimizerValue">-</span>
        </div>
        <div class="exp-view-param-chip">
            <span class="exp-view-param-chip-label">Epochs:</span>
            <span class="exp-view-param-chip-value">${exp.epochs || '-'}</span>
        </div>
        <div class="exp-view-param-chip">
            <span class="exp-view-param-chip-label">Batch Size:</span>
            <span class="exp-view-param-chip-value">${exp.batch_size?.toLocaleString() || '-'}</span>
        </div>
        <div class="exp-view-param-chip">
            <span class="exp-view-param-chip-label">Learning Rate:</span>
            <span class="exp-view-param-chip-value">${exp.learning_rate || '-'}</span>
        </div>
        <div class="exp-view-param-chip">
            <span class="exp-view-param-chip-label">Hardware:</span>
            <span class="exp-view-param-chip-value">${hardwareDisplay}</span>
        </div>
    `;

    container.innerHTML = html;
}

function switchExpViewTab(tabName) {
    currentViewTab = tabName;

    // Update tab buttons
    document.querySelectorAll('.exp-view-tab').forEach(t => t.classList.remove('active'));
    document.querySelector(`.exp-view-tab[data-tab="${tabName}"]`).classList.add('active');

    // Update tab content
    document.querySelectorAll('.exp-view-tab-content').forEach(c => c.classList.remove('active'));
    const tabContent = document.getElementById(`expViewTab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
    if (tabContent) tabContent.classList.add('active');

    // Load lazy data for data/training tabs
    if (tabName === 'data') {
        loadDataInsights();
    }
    if (tabName === 'training') {
        if (viewModalDataCache.trainingHistory) {
            // Cache exists (from preload) - render charts directly
            renderCachedTrainingHistory();
        } else {
            // Cache miss - fetch from API
            loadTrainingHistory();
        }
    }
    if (tabName === 'pipeline' && !viewModalDataCache.errorDetails) {
        loadErrorDetails();
    }
}

function populateExpViewModal(exp) {
    // Store current exp for tab data loading
    window.currentViewExp = exp;

    // Status panel (right side colored stripe) - Vertex Pipelines style
    const statusPanel = document.getElementById('expViewStatusPanel');
    statusPanel.className = `exp-view-status-panel ${exp.status}`;

    // Status icon (circular icon inside status panel)
    const statusIcon = document.getElementById('expViewStatusIcon');
    const statusIcons = {
        'submitting': 'fa-spinner fa-spin',
        'running': 'fa-spinner fa-spin',
        'completed': 'fa-check',
        'failed': 'fa-exclamation',
        'cancelled': 'fa-ban',
        'pending': 'fa-clock'
    };
    statusIcon.className = `exp-view-status-icon ${exp.status}`;
    statusIcon.innerHTML = `<i class="fas ${statusIcons[exp.status] || 'fa-circle'}"></i>`;

    // Title (Exp #N)
    document.getElementById('expViewTitle').textContent = exp.display_name;

    // Experiment name
    const expNameEl = document.getElementById('expViewExpName');
    expNameEl.textContent = exp.experiment_name || '';
    expNameEl.style.display = exp.experiment_name ? '' : 'none';

    // Description
    const descEl = document.getElementById('expViewDescription');
    descEl.textContent = exp.experiment_description || '';
    descEl.style.display = exp.experiment_description ? '' : 'none';

    // Start/End times
    const formatDateTime = (isoStr) => {
        if (!isoStr) return '-';
        const d = new Date(isoStr);
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' +
               d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    };
    document.getElementById('expViewStartTime').textContent = formatDateTime(exp.started_at || exp.created_at);
    document.getElementById('expViewEndTime').textContent = exp.completed_at ? formatDateTime(exp.completed_at) : '-';

    // Overview Tab - Dataset section
    document.getElementById('expViewDatasetName').textContent = exp.dataset_name || 'Dataset';

    // Load dataset details
    if (exp.dataset_id) {
        loadDatasetDetailsForExp(exp.dataset_id);
    } else {
        document.getElementById('expViewDatasetDetails').innerHTML = '<div class="exp-view-no-filters">No dataset configured</div>';
    }

    // Load features config details
    document.getElementById('expViewFeaturesConfigName').textContent = exp.feature_config_name || '-';
    if (exp.feature_config_id) {
        loadFeaturesConfigForExp(exp.feature_config_id);
    } else {
        document.getElementById('expViewFeaturesConfigContent').innerHTML = '<div class="exp-view-no-filters">No features config</div>';
    }

    // Load model config details
    document.getElementById('expViewModelConfigName').textContent = exp.model_config_name || '-';
    if (exp.model_config_id) {
        loadModelConfigForExp(exp.model_config_id);
    } else {
        document.getElementById('expViewModelConfigContent').innerHTML = '<div class="exp-view-no-filters">No model config</div>';
    }

    // Sampling (chip format)
    renderSamplingChips(exp);

    // Training Parameters (chip format)
    renderTrainingParamsChips(exp);

    // Results Summary (overview tab)
    const resultsSummary = document.getElementById('expViewResultsSummary');
    if (exp.status === 'completed' && exp.metrics) {
        resultsSummary.classList.remove('hidden');
        renderMetricsSummary(exp.metrics);
    } else {
        resultsSummary.classList.add('hidden');
    }

    // Pipeline Tab
    const isRunning = exp.status === 'running' || exp.status === 'submitting';
    document.getElementById('expViewProgressSection').style.display = isRunning ? 'flex' : 'none';
    if (isRunning) {
        const percent = exp.progress_percent || 0;
        document.getElementById('expViewProgressBar').style.width = `${percent}%`;
        document.getElementById('expViewProgressText').textContent = `${percent}%`;
    }
    renderPipelineStages(exp.stage_details || getDefaultStages());

    // Error section (pipeline tab) - show basic error immediately
    const errorSection = document.getElementById('expViewErrorSection');
    if (exp.status === 'failed') {
        errorSection.classList.remove('hidden');
        document.getElementById('expViewErrorTitle').textContent = 'Pipeline Failed';
        document.getElementById('expViewErrorSuggestion').textContent = '';
        document.getElementById('expViewErrorMessage').textContent = exp.error_message || 'No error details available';
        // Load detailed error when pipeline tab is visible
        if (currentViewTab === 'pipeline') {
            loadErrorDetails();
        }
    } else {
        errorSection.classList.add('hidden');
    }

    // Training Tab - Final Metrics (populated by MLflow data via renderFinalMetricsTable)
    // Keep hidden until MLflow data loads
    document.getElementById('expViewFinalMetrics').classList.add('hidden');

    // Training Tab - Vocabulary
    const vocabSection = document.getElementById('expViewVocabSection');
    if (exp.vocabulary_stats && Object.keys(exp.vocabulary_stats).length > 0) {
        vocabSection.classList.remove('hidden');
        renderVocabRows(exp.vocabulary_stats);
    } else {
        vocabSection.classList.add('hidden');
    }
}

function renderMetricsSummary(metrics, useTestPrefix = false) {
    const container = document.getElementById('expViewMetricsSummary');
    const formatRecall = v => v != null ? (v * 100).toFixed(2) + '%' : 'N/A';

    // Support both 'recall_at_*' (from exp.metrics) and 'test_recall_at_*' (from final_metrics)
    const prefix = useTestPrefix ? 'test_' : '';
    const items = [
        { label: 'Recall@5', value: metrics[prefix + 'recall_at_5'], format: formatRecall },
        { label: 'Recall@10', value: metrics[prefix + 'recall_at_10'], format: formatRecall },
        { label: 'Recall@50', value: metrics[prefix + 'recall_at_50'], format: formatRecall },
        { label: 'Recall@100', value: metrics[prefix + 'recall_at_100'], format: formatRecall }
    ];
    container.innerHTML = items.map(item => `
        <div class="exp-view-metric-card">
            <div class="exp-view-metric-card-label">${item.label}</div>
            <div class="exp-view-metric-card-value">${item.format(item.value)}</div>
        </div>
    `).join('');
}

// =========================================================================
// Pipeline DAG Visualization - Moved to static/js/pipeline_dag.js
// =========================================================================
// All Pipeline DAG functions are now loaded from the external file:
// - renderPipelineStages(stages)
// - selectDagComponent(componentId)
// - loadComponentLogs(componentId, experimentId)
// - refreshComponentLogs(experimentId)
// - resetDagState()
// - formatDuration(seconds)

function renderVocabRows(vocabStats) {
    const container = document.getElementById('expViewVocabRows');
    container.innerHTML = Object.entries(vocabStats).map(([name, size]) => `
        <div class="exp-view-row">
            <span class="exp-view-row-label">${name}</span>
            <span class="exp-view-row-value">${typeof size === 'number' ? size.toLocaleString() : size}</span>
        </div>
    `).join('');
}

// Lazy load error details
async function loadErrorDetails() {
    if (!viewModalExpId || viewModalDataCache.errorDetails) return;

    try {
        const response = await fetch(`/api/quick-tests/${viewModalExpId}/errors/`);
        const data = await response.json();

        if (data.success && data.error_details?.has_error) {
            viewModalDataCache.errorDetails = data.error_details;

            // Update error display
            const details = data.error_details;
            document.getElementById('expViewErrorTitle').textContent = details.title || 'Pipeline Failed';
            document.getElementById('expViewErrorSuggestion').textContent = details.suggestion || '';
            if (details.full_message) {
                document.getElementById('expViewErrorMessage').textContent = details.full_message;
            }
        }
    } catch (error) {
        console.error('Error loading error details:', error);
    }
}

// Preload data insights in background (no UI updates)
// Called when modal opens to warm up Cloud Run service and cache data
async function preloadDataInsights() {
    if (!viewModalExpId) return;

    // Skip if already cached or currently loading
    if (viewModalDataCache.statistics !== null || viewModalDataCache._loadingInsights) return;

    viewModalDataCache._loadingInsights = true;
    console.log('[DataInsights] Preload STARTED for experiment', viewModalExpId);
    const startTime = performance.now();

    try {
        const [statsRes, schemaRes] = await Promise.all([
            fetch(`/api/quick-tests/${viewModalExpId}/statistics/`),
            fetch(`/api/quick-tests/${viewModalExpId}/schema/`)
        ]);

        const statsData = await statsRes.json();
        const schemaData = await schemaRes.json();

        const elapsed = ((performance.now() - startTime) / 1000).toFixed(1);
        console.log(`[DataInsights] Preload COMPLETED in ${elapsed}s - data cached`);

        // Only cache if modal is still open for same experiment
        if (viewModalExpId) {
            viewModalDataCache.statistics = statsData.statistics;
            viewModalDataCache.schema = schemaData.schema;
            viewModalDataCache._statsData = statsData;
            viewModalDataCache._schemaData = schemaData;
        }
    } catch (error) {
        console.log('[DataInsights] Preload FAILED:', error.message);
    } finally {
        viewModalDataCache._loadingInsights = false;
    }
}

// Preload training history to show accurate recall metrics in Overview tab
async function preloadTrainingHistory() {
    if (!viewModalExpId || viewModalDataCache.trainingHistory) return;

    try {
        const response = await fetch(`/api/quick-tests/${viewModalExpId}/training-history/`);
        const data = await response.json();

        if (data.success && data.training_history?.available) {
            viewModalDataCache.trainingHistory = data.training_history;

            // Update Overview metrics with accurate test_recall values
            if (data.training_history.final_metrics) {
                renderMetricsSummary(data.training_history.final_metrics, true);
            }
        }
    } catch (error) {
        console.log('[TrainingHistory] Preload failed:', error.message);
    }
}

// Lazy load data insights (statistics + schema)
async function loadDataInsights() {
    if (!viewModalExpId) return;

    const loadingEl = document.getElementById('expViewDataLoading');
    const contentEl = document.getElementById('expViewDataContent');
    const errorEl = document.getElementById('expViewDataError');

    // Check if data was preloaded
    if (viewModalDataCache.statistics !== null && viewModalDataCache._statsData) {
        console.log('[DataInsights] Using CACHED data (instant load)');
        const statsData = viewModalDataCache._statsData;
        const schemaData = viewModalDataCache._schemaData;

        const statsAvailable = statsData.success && statsData.statistics?.available;
        const schemaAvailable = schemaData.success && schemaData.schema?.available;

        // Always hide loading when using cached data
        loadingEl.classList.add('hidden');

        if (!statsAvailable && !schemaAvailable) {
            contentEl.classList.add('hidden');
            errorEl.classList.remove('hidden');
            document.getElementById('expViewDataErrorMessage').textContent =
                statsData.statistics?.message || schemaData.schema?.message || 'Data insights not available';
            return;
        }

        if (statsAvailable) renderStatistics(statsData.statistics);
        else document.getElementById('expViewStatsContent').innerHTML = '<p class="text-sm text-gray-500">Statistics not available</p>';

        if (schemaAvailable) renderSchema(schemaData.schema);
        else document.getElementById('expViewSchemaContent').innerHTML = '<p class="text-sm text-gray-500">Schema not available</p>';

        errorEl.classList.add('hidden');
        contentEl.classList.remove('hidden');
        return;
    }

    // Wait if preload is in progress (with 90s timeout)
    if (viewModalDataCache._loadingInsights) {
        console.log('[DataInsights] Waiting for preload to complete...');
        loadingEl.classList.remove('hidden');
        contentEl.classList.add('hidden');
        errorEl.classList.add('hidden');

        let waitTime = 0;
        const maxWait = 90000; // 90 seconds max
        const checkPreload = setInterval(() => {
            waitTime += 100;
            if (!viewModalDataCache._loadingInsights) {
                clearInterval(checkPreload);
                console.log(`[DataInsights] Preload finished after ${(waitTime/1000).toFixed(1)}s wait`);
                loadDataInsights();
            } else if (waitTime >= maxWait) {
                clearInterval(checkPreload);
                console.log('[DataInsights] Preload timeout - falling back to direct fetch');
                viewModalDataCache._loadingInsights = false;
                loadDataInsights();
            }
        }, 100);
        return;
    }

    loadingEl.classList.remove('hidden');
    contentEl.classList.add('hidden');
    errorEl.classList.add('hidden');

    try {
        // Fetch both in parallel
        const [statsRes, schemaRes] = await Promise.all([
            fetch(`/api/quick-tests/${viewModalExpId}/statistics/`),
            fetch(`/api/quick-tests/${viewModalExpId}/schema/`)
        ]);

        const statsData = await statsRes.json();
        const schemaData = await schemaRes.json();

        viewModalDataCache.statistics = statsData.statistics;
        viewModalDataCache.schema = schemaData.schema;
        viewModalDataCache._statsData = statsData;
        viewModalDataCache._schemaData = schemaData;

        // Check if any data is available
        const statsAvailable = statsData.success && statsData.statistics?.available;
        const schemaAvailable = schemaData.success && schemaData.schema?.available;

        if (!statsAvailable && !schemaAvailable) {
            loadingEl.classList.add('hidden');
            errorEl.classList.remove('hidden');
            document.getElementById('expViewDataErrorMessage').textContent =
                statsData.statistics?.message || schemaData.schema?.message || 'Data insights not available';
            return;
        }

        // Render statistics
        if (statsAvailable) {
            renderStatistics(statsData.statistics);
        } else {
            document.getElementById('expViewStatsContent').innerHTML =
                '<p class="text-sm text-gray-500">Statistics not available</p>';
        }

        // Render schema
        if (schemaAvailable) {
            renderSchema(schemaData.schema);
        } else {
            document.getElementById('expViewSchemaContent').innerHTML =
                '<p class="text-sm text-gray-500">Schema not available</p>';
        }

        loadingEl.classList.add('hidden');
        contentEl.classList.remove('hidden');

    } catch (error) {
        console.error('Error loading data insights:', error);
        loadingEl.classList.add('hidden');
        errorEl.classList.remove('hidden');
        document.getElementById('expViewDataErrorMessage').textContent = 'Failed to load data insights';
    }
}

function renderStatistics(stats) {
    const container = document.getElementById('expViewStatsContent');
    const numericSection = document.getElementById('expViewNumericSection');
    const categoricalSection = document.getElementById('expViewCategoricalSection');
    const numericContent = document.getElementById('expViewNumericContent');
    const categoricalContent = document.getElementById('expViewCategoricalContent');
    const tfdvBtn = document.getElementById('expViewTfdvBtn');

    // Summary boxes with enhanced counts
    const numNumeric = stats.num_numeric_features || 0;
    const numCategorical = stats.num_categorical_features || 0;
    const avgMissing = stats.avg_missing_pct ?? stats.avg_missing_ratio ?? 0;

    let html = `
        <div class="exp-view-stats-summary">
            <div class="exp-view-stat-box">
                <div class="exp-view-stat-box-value">${stats.num_examples?.toLocaleString() || '-'}</div>
                <div class="exp-view-stat-box-label">Examples</div>
            </div>
            <div class="exp-view-stat-box">
                <div class="exp-view-stat-box-value">${stats.num_features || '-'}</div>
                <div class="exp-view-stat-box-label">Features</div>
            </div>
            <div class="exp-view-stat-box">
                <div class="exp-view-stat-box-value">${numNumeric} / ${numCategorical}</div>
                <div class="exp-view-stat-box-label">Numeric / Categorical</div>
            </div>
            <div class="exp-view-stat-box">
                <div class="exp-view-stat-box-value">${avgMissing?.toFixed(1) || '0'}%</div>
                <div class="exp-view-stat-box-label">Avg Missing</div>
            </div>
        </div>
    `;
    container.innerHTML = html;

    // Show TFDV link if stats available and set the href
    if (stats.available) {
        tfdvBtn.href = `/experiments/quick-tests/${viewModalExpId}/tfdv/`;
        tfdvBtn.classList.remove('hidden');
    }

    // Render Numeric Features Section
    if (stats.numeric_features?.length > 0) {
        numericSection.classList.remove('hidden');
        document.getElementById('expViewNumericCount').textContent = `(${stats.numeric_features.length})`;
        numericContent.innerHTML = renderNumericFeaturesTable(stats.numeric_features);
    } else {
        numericSection.classList.add('hidden');
    }

    // Render Categorical Features Section
    if (stats.categorical_features?.length > 0) {
        categoricalSection.classList.remove('hidden');
        document.getElementById('expViewCategoricalCount').textContent = `(${stats.categorical_features.length})`;
        categoricalContent.innerHTML = renderCategoricalFeaturesTable(stats.categorical_features);
    } else {
        categoricalSection.classList.add('hidden');
    }

    // Fallback: if we only have old-style features array
    if (!stats.numeric_features && !stats.categorical_features && stats.features?.length > 0) {
        numericSection.classList.remove('hidden');
        document.getElementById('expViewNumericCount').textContent = '';
        numericContent.innerHTML = renderLegacyFeaturesTable(stats.features, stats.truncated, stats.total_features);
        categoricalSection.classList.add('hidden');
    }
}

function renderNumericFeaturesTable(features) {
    return `
        <div class="tfdv-table-container">
            <table class="tfdv-features-table">
                <thead>
                    <tr>
                        <th>Feature</th>
                        <th>Count</th>
                        <th>Missing</th>
                        <th>Mean</th>
                        <th>Std Dev</th>
                        <th>Zeros</th>
                        <th>Min</th>
                        <th>Median</th>
                        <th>Max</th>
                        <th>Distribution</th>
                    </tr>
                </thead>
                <tbody>
                    ${features.slice(0, 30).map(f => {
                        const ns = f.numeric_stats || {};
                        return `
                        <tr>
                            <td class="feature-name">${f.name}</td>
                            <td>${ns.count?.toLocaleString() || '-'}</td>
                            <td>${formatPercent(ns.missing_pct)}</td>
                            <td>${formatNumber(ns.mean)}</td>
                            <td>${formatNumber(ns.std_dev)}</td>
                            <td>${formatPercent(ns.zeros_pct)}</td>
                            <td>${formatNumber(ns.min_val)}</td>
                            <td>${formatNumber(ns.median)}</td>
                            <td>${formatNumber(ns.max_val)}</td>
                            <td>${renderMiniHistogram(ns.histogram)}</td>
                        </tr>
                    `}).join('')}
                </tbody>
            </table>
        </div>
        ${features.length > 30 ? `<p class="text-xs text-gray-400 mt-2">Showing first 30 of ${features.length} numeric features</p>` : ''}
    `;
}

function renderCategoricalFeaturesTable(features) {
    return `
        <div class="tfdv-table-container">
            <table class="tfdv-features-table">
                <thead>
                    <tr>
                        <th>Feature</th>
                        <th>Count</th>
                        <th>Missing</th>
                        <th>Unique</th>
                        <th>Top Values</th>
                        <th>Distribution</th>
                    </tr>
                </thead>
                <tbody>
                    ${features.slice(0, 30).map(f => {
                        const cs = f.categorical_stats || {};
                        return `
                        <tr>
                            <td class="feature-name">${f.name}</td>
                            <td>${cs.count?.toLocaleString() || '-'}</td>
                            <td>${formatPercent(cs.missing_pct)}</td>
                            <td>${cs.unique?.toLocaleString() || '-'}</td>
                            <td class="top-values-cell">${renderTopValues(cs.top_values)}</td>
                            <td>${renderTopValuesChart(cs.top_values)}</td>
                        </tr>
                    `}).join('')}
                </tbody>
            </table>
        </div>
        ${features.length > 30 ? `<p class="text-xs text-gray-400 mt-2">Showing first 30 of ${features.length} categorical features</p>` : ''}
    `;
}

function renderLegacyFeaturesTable(features, truncated, total) {
    return `
        <div class="tfdv-table-container">
            <table class="tfdv-features-table">
                <thead>
                    <tr>
                        <th>Feature</th>
                        <th>Type</th>
                        <th>Unique</th>
                        <th>Missing</th>
                        <th>Min</th>
                        <th>Max</th>
                        <th>Mean</th>
                    </tr>
                </thead>
                <tbody>
                    ${features.slice(0, 30).map(f => `
                        <tr>
                            <td class="feature-name">${f.name}</td>
                            <td><span class="type-tag ${f.type?.toLowerCase() || 'unknown'}">${f.type || 'UNKNOWN'}</span></td>
                            <td>${f.num_unique?.toLocaleString() || '-'}</td>
                            <td>${formatPercent(f.missing_pct)}</td>
                            <td>${formatNumber(f.min)}</td>
                            <td>${formatNumber(f.max)}</td>
                            <td>${formatNumber(f.mean)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
        ${truncated ? `<p class="text-xs text-gray-400 mt-2">Showing first 30 of ${total} features</p>` : ''}
    `;
}

function formatNumber(val) {
    if (val === null || val === undefined) return '-';
    if (Math.abs(val) >= 1000000) return (val / 1000000).toFixed(2) + 'M';
    if (Math.abs(val) >= 1000) return (val / 1000).toFixed(2) + 'K';
    if (Number.isInteger(val)) return val.toLocaleString();
    return val.toFixed(2);
}

function formatPercent(val) {
    if (val === null || val === undefined) return '0%';
    return val.toFixed(1) + '%';
}

function renderMiniHistogram(histogram) {
    if (!histogram || histogram.length === 0) return '<span class="no-data">-</span>';

    const maxCount = Math.max(...histogram.map(b => b.count || 0));
    if (maxCount === 0) return '<span class="no-data">-</span>';

    const bars = histogram.slice(0, 10).map(b => {
        const height = Math.max(2, Math.round((b.count / maxCount) * 24));
        return `<div class="mini-bar" style="height: ${height}px;" title="${b.count?.toLocaleString() || 0}"></div>`;
    }).join('');

    return `<div class="mini-histogram">${bars}</div>`;
}

function renderTopValues(topValues) {
    if (!topValues || topValues.length === 0) return '<span class="no-data">-</span>';

    const top3 = topValues.slice(0, 3).map(tv => {
        const val = tv.value?.length > 15 ? tv.value.substring(0, 15) + '...' : tv.value;
        return `<span class="top-value" title="${tv.value}: ${tv.frequency_pct?.toFixed(1) || 0}%">${val}</span>`;
    }).join(', ');

    return top3;
}

function renderTopValuesChart(topValues) {
    if (!topValues || topValues.length === 0) return '<span class="no-data">-</span>';

    const maxPct = Math.max(...topValues.map(tv => tv.frequency_pct || 0));
    if (maxPct === 0) return '<span class="no-data">-</span>';

    const bars = topValues.slice(0, 5).map(tv => {
        const width = Math.max(2, Math.round((tv.frequency_pct / maxPct) * 60));
        return `<div class="mini-hbar" style="width: ${width}px;" title="${tv.value}: ${tv.frequency_pct?.toFixed(1)}%"></div>`;
    }).join('');

    return `<div class="mini-hbar-chart">${bars}</div>`;
}

function renderSchema(schema) {
    const container = document.getElementById('expViewSchemaContent');

    if (!schema.features?.length) {
        container.innerHTML = '<p class="text-sm text-gray-500">No schema information available</p>';
        return;
    }

    container.innerHTML = `
        <table class="exp-view-features-table">
            <thead>
                <tr>
                    <th>Feature</th>
                    <th>Type</th>
                    <th>Required</th>
                </tr>
            </thead>
            <tbody>
                ${schema.features.slice(0, 20).map(f => `
                    <tr>
                        <td>${f.name}</td>
                        <td>${f.feature_type || 'UNKNOWN'}</td>
                        <td>${f.presence === 'required' ? 'Yes' : 'No'}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
        ${schema.truncated ? `<p class="text-xs text-gray-400 mt-2">Showing first 20 of ${schema.total_features} features</p>` : ''}
    `;
}

// Training chart instances (for cleanup)
let trainingLossChart = null;
let trainingMetricsChart = null;
let trainingGradientChart = null;
let trainingWeightStatsChart = null;
let currentWeightStatsData = null;  // Store for tower switching
let currentWeightNormData = null;  // Store for weight norm tower switching
let currentWeightHistogramData = null;  // Store for 3D histogram tower switching

// Shared Chart.js configuration for consistent styling across all training charts
const trainingChartDefaults = {
    layout: {
        padding: { top: 0, right: 0, bottom: 0, left: 0 }
    },
    font: {
        axis: { size: 9 },
        axisTitle: { size: 10 },
        legend: { size: 10 }
    },
    ticks: {
        padding: 2
    },
    scales: {
        y: {
            grace: '2%',
            title: { font: { size: 10 } },
            ticks: { font: { size: 9 }, padding: 2 }
        },
        x: {
            ticks: { font: { size: 9 }, padding: 2, maxRotation: 0 }
        }
    },
    legend: {
        labels: {
            boxWidth: 8,
            boxHeight: 8,
            padding: 6,
            font: { size: 10 },
            usePointStyle: true
        }
    }
};

// Render training history from cache (when preload completed before tab switch)
function renderCachedTrainingHistory() {
    const loadingEl = document.getElementById('expViewTrainingLoading');
    const placeholderEl = document.getElementById('expViewTrainingPlaceholder');
    const chartsEl = document.getElementById('expViewTrainingCharts');
    const messageEl = document.getElementById('expViewTrainingMessage');

    const history = viewModalDataCache.trainingHistory;

    // Hide loading spinner
    loadingEl.classList.add('hidden');

    if (!history || !history.available) {
        messageEl.textContent = history?.message || 'Training data not available';
        placeholderEl.classList.remove('hidden');
        chartsEl.classList.add('hidden');
        return;
    }

    // Destroy existing charts before re-rendering
    if (trainingLossChart) { trainingLossChart.destroy(); trainingLossChart = null; }
    if (trainingMetricsChart) { trainingMetricsChart.destroy(); trainingMetricsChart = null; }
    if (trainingGradientChart) { trainingGradientChart.destroy(); trainingGradientChart = null; }
    if (trainingWeightStatsChart) { trainingWeightStatsChart.destroy(); trainingWeightStatsChart = null; }
    currentWeightStatsData = null;

    // Render charts from cached data
    renderTrainingCharts(history);
    placeholderEl.classList.add('hidden');
    chartsEl.classList.remove('hidden');

    console.log('[TrainingHistory] Rendered from cache (instant)');
}

// Lazy load training history and render charts
async function loadTrainingHistory() {
    if (!viewModalExpId) return;

    const loadingEl = document.getElementById('expViewTrainingLoading');
    const placeholderEl = document.getElementById('expViewTrainingPlaceholder');
    const chartsEl = document.getElementById('expViewTrainingCharts');
    const messageEl = document.getElementById('expViewTrainingMessage');

    loadingEl.classList.remove('hidden');
    placeholderEl.classList.add('hidden');
    chartsEl.classList.add('hidden');

    // Destroy existing charts
    if (trainingLossChart) {
        trainingLossChart.destroy();
        trainingLossChart = null;
    }
    if (trainingMetricsChart) {
        trainingMetricsChart.destroy();
        trainingMetricsChart = null;
    }
    if (trainingGradientChart) {
        trainingGradientChart.destroy();
        trainingGradientChart = null;
    }
    if (trainingWeightStatsChart) {
        trainingWeightStatsChart.destroy();
        trainingWeightStatsChart = null;
    }
    currentWeightStatsData = null;

    try {
        const response = await fetch(`/api/quick-tests/${viewModalExpId}/training-history/`);
        const data = await response.json();

        loadingEl.classList.add('hidden');

        if (!data.success) {
            messageEl.textContent = data.error || 'Error loading training data';
            placeholderEl.classList.remove('hidden');
            return;
        }

        const history = data.training_history;
        viewModalDataCache.trainingHistory = history;

        if (!history.available) {
            messageEl.textContent = history.message || 'Training data not available';
            placeholderEl.classList.remove('hidden');
            return;
        }

        // Render charts
        renderTrainingCharts(history);
        chartsEl.classList.remove('hidden');

        // Update Overview tab metrics with accurate test_recall values from final_metrics
        if (history.final_metrics) {
            renderMetricsSummary(history.final_metrics, true);
        }

    } catch (error) {
        console.error('Error loading training history:', error);
        loadingEl.classList.add('hidden');
        messageEl.textContent = 'Error loading training data';
        placeholderEl.classList.remove('hidden');
    }
}

// Render training charts with Chart.js and Plotly
function renderTrainingCharts(history) {
    renderLossChart(history);
    renderMetricsChart(history);

    // Get selected tower for weight analysis charts
    const tower = document.getElementById('weightAnalysisTower')?.value || 'query';
    renderGradientChart(history, tower);
    renderWeightStatsChart(history, tower);

    renderWeightHistogramChart(history);  // 3D histogram (Plotly)
    renderFinalMetricsTable(history);
}

// Render final metrics summary table from MLflow data
function renderFinalMetricsTable(history) {
    const container = document.getElementById('expViewMetricsRows');
    const section = document.getElementById('expViewFinalMetrics');
    if (!container || !section) return;

    const finalMetrics = history.final_metrics || {};

    // If no final metrics, hide the section
    if (Object.keys(finalMetrics).length === 0) {
        section.classList.add('hidden');
        return;
    }

    // Define table rows: Name, Train, Val, Test
    const tableRows = [
        {
            name: 'Loss',
            train: finalMetrics['final_loss'],
            val: finalMetrics['final_val_loss'],
            test: finalMetrics['test_loss']
        },
        {
            name: 'Reg. Loss',
            train: finalMetrics['final_regularization_loss'],
            val: finalMetrics['final_val_regularization_loss'],
            test: finalMetrics['test_regularization_loss']
        },
        {
            name: 'Total Loss',
            train: finalMetrics['final_total_loss'],
            val: finalMetrics['final_val_total_loss'],
            test: finalMetrics['test_total_loss']
        }
    ];

    // Helper to format loss values
    const formatValue = (value) => {
        if (value == null) return '';
        return value.toFixed(2);
    };

    // Build simple table HTML
    let html = `
        <table class="final-metrics-table">
            <thead>
                <tr>
                    <th>Metric</th>
                    <th>Train</th>
                    <th>Val</th>
                    <th>Test</th>
                </tr>
            </thead>
            <tbody>`;

    tableRows.forEach(row => {
        // Only show row if at least one value exists
        if (row.train != null || row.val != null || row.test != null) {
            html += `
                <tr>
                    <td>${row.name}</td>
                    <td class="val-train">${formatValue(row.train)}</td>
                    <td class="val-val">${formatValue(row.val)}</td>
                    <td class="val-test">${formatValue(row.test)}</td>
                </tr>`;
        }
    });

    html += '</tbody></table>';
    container.innerHTML = html;
    section.classList.remove('hidden');
}

function renderLossChart(history) {
    const ctx = document.getElementById('trainingLossChart');
    if (!ctx) return;

    const loss = history.loss || {};
    const epochs = history.epochs || [];

    // Check if we have any loss data
    const hasData = Object.values(loss).some(arr => arr && arr.length > 0);
    if (!hasData) {
        return;
    }

    const datasets = [];

    // Define loss types with their display config
    // Primary losses (solid lines, filled) - visible by default
    // Regularization losses (dashed lines, no fill) - hidden by default
    const lossConfig = [
        { key: 'train', label: 'Train Loss', color: '#3b82f6', dash: [], fill: true },
        { key: 'val', label: 'Val Loss', color: '#f59e0b', dash: [], fill: true },
        { key: 'regularization', label: 'Reg Loss', color: '#6b7280', dash: [2, 2], fill: false, hidden: true },
        { key: 'val_regularization', label: 'Val Reg Loss', color: '#9ca3af', dash: [2, 2], fill: false, hidden: true },
    ];

    lossConfig.forEach(config => {
        const data = loss[config.key] || [];
        if (data.length > 0) {
            datasets.push({
                label: config.label,
                data: data,
                borderColor: config.color,
                backgroundColor: config.fill ? `${config.color}1a` : 'transparent',
                fill: config.fill,
                tension: 0.3,
                pointRadius: 3,
                pointHoverRadius: 5,
                borderDash: config.dash,
                hidden: config.hidden || false
            });
        }
    });

    trainingLossChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: epochs.map(e => e + 1),
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: trainingChartDefaults.layout,
            plugins: {
                legend: {
                    position: 'top',
                    labels: trainingChartDefaults.legend.labels,
                    onClick: function(e, legendItem, legend) {
                        const index = legendItem.datasetIndex;
                        const ci = legend.chart;
                        const meta = ci.getDatasetMeta(index);
                        meta.hidden = meta.hidden === null ? !ci.data.datasets[index].hidden : null;
                        ci.update();
                    }
                },
                tooltip: { mode: 'index', intersect: false }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    grace: trainingChartDefaults.scales.y.grace,
                    title: { display: true, text: 'Loss', ...trainingChartDefaults.scales.y.title },
                    ticks: trainingChartDefaults.scales.y.ticks
                },
                x: {
                    ticks: { ...trainingChartDefaults.scales.x.ticks, maxRotation: 0 }
                }
            },
            interaction: { mode: 'nearest', axis: 'x', intersect: false }
        }
    });
}

function renderMetricsChart(history) {
    const ctx = document.getElementById('trainingMetricsChart');
    if (!ctx) return;

    const finalMetrics = history.final_metrics || {};

    // Extract recall metrics from final_metrics (test_recall_at_5, test_recall_at_10, test_recall_at_50, test_recall_at_100)
    const recallLabels = [];
    const recallValues = [];
    const colors = ['#06b6d4', '#10b981', '#8b5cf6', '#ec4899'];

    // Define the recall metrics we want to show (in order)
    const recallKeys = [
        { key: 'test_recall_at_5', label: 'Recall@5' },
        { key: 'test_recall_at_10', label: 'Recall@10' },
        { key: 'test_recall_at_50', label: 'Recall@50' },
        { key: 'test_recall_at_100', label: 'Recall@100' }
    ];

    recallKeys.forEach(({ key, label }) => {
        if (finalMetrics[key] !== undefined) {
            recallLabels.push(label);
            recallValues.push(finalMetrics[key]);
        }
    });

    // If no recall metrics found, show a placeholder message
    if (recallValues.length === 0) {
        // Check if there was an evaluation error
        const hasAnyFinalMetrics = Object.keys(finalMetrics).length > 0;
        if (hasAnyFinalMetrics) {
            // Training completed but recall evaluation failed
            ctx.parentElement.innerHTML = `
                <h5 class="training-chart-title">Recall Metrics</h5>
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 180px; color: #9ca3af; text-align: center;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 8px; color: #f59e0b;"></i>
                    <span style="font-size: 13px;">Recall evaluation failed</span>
                    <span style="font-size: 11px; margin-top: 4px;">Check logs for details</span>
                </div>
            `;
        }
        return;
    }

    trainingMetricsChart = new Chart(ctx, {
        type: 'bar',
        plugins: [ChartDataLabels],
        data: {
            labels: recallLabels,
            datasets: [{
                label: 'Test Recall',
                data: recallValues,
                backgroundColor: colors.slice(0, recallValues.length),
                borderColor: colors.slice(0, recallValues.length).map(c => c),
                borderWidth: 1,
                borderRadius: 4,
                barThickness: 40
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: trainingChartDefaults.layout,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${(context.parsed.y * 100).toFixed(2)}%`;
                        }
                    }
                },
                datalabels: {
                    anchor: 'end',
                    align: 'end',
                    offset: 4,
                    color: '#374151',
                    font: {
                        size: 12,
                        weight: '600'
                    },
                    formatter: function(value) {
                        return (value * 100).toFixed(2) + '%';
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 1,
                    title: { display: true, text: 'Recall Rate', ...trainingChartDefaults.scales.y.title },
                    ticks: {
                        ...trainingChartDefaults.scales.y.ticks,
                        callback: function(value) {
                            return (value * 100).toFixed(0) + '%';
                        }
                    }
                },
                x: {
                    ticks: trainingChartDefaults.scales.x.ticks
                }
            }
        }
    });
}

// Render weight norms chart for selected tower
function renderGradientChart(history, tower = 'query') {
    const ctx = document.getElementById('trainingGradientChart');
    if (!ctx) return;

    // Store data for tower switching
    currentWeightNormData = history;

    const weightNorms = history.gradient || {};
    const epochs = history.epochs || [];

    // Check if we have data for selected tower
    const towerData = weightNorms[tower];
    const hasData = towerData && towerData.length > 0;

    if (!hasData) {
        return;
    }

    // Destroy existing chart
    if (trainingGradientChart) {
        trainingGradientChart.destroy();
    }

    // Tower display config
    const towerConfig = {
        query: { label: 'Query Tower', color: '#3b82f6' },
        candidate: { label: 'Candidate Tower', color: '#10b981' }
    };

    const config = towerConfig[tower];

    trainingGradientChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: epochs.map(e => e + 1),
            datasets: [{
                label: config.label,
                data: towerData,
                borderColor: config.color,
                backgroundColor: `${config.color}1a`,
                fill: true,
                tension: 0.3,
                pointRadius: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: trainingChartDefaults.layout,
            plugins: {
                legend: { display: false },
                tooltip: { mode: 'index', intersect: false }
            },
            scales: {
                y: {
                    grace: trainingChartDefaults.scales.y.grace,
                    title: { display: true, text: 'L1/L2 Norm', ...trainingChartDefaults.scales.y.title },
                    ticks: trainingChartDefaults.scales.y.ticks
                },
                x: {
                    ticks: trainingChartDefaults.scales.x.ticks
                }
            }
        }
    });
}

// Render weight statistics chart
function renderWeightStatsChart(history, tower = 'query') {
    const ctx = document.getElementById('trainingWeightStatsChart');
    if (!ctx) return;

    // Store data for tower switching
    currentWeightStatsData = history;

    const weightStats = history.weight_stats || {};
    const epochs = history.epochs || [];
    const towerStats = weightStats[tower] || {};

    // Check if we have data
    const hasData = towerStats.mean && towerStats.mean.length > 0;

    if (!hasData) {
        // Show placeholder
        ctx.parentElement.querySelector('canvas').style.display = 'none';
        const placeholder = document.createElement('div');
        placeholder.style.cssText = 'display: flex; flex-direction: column; align-items: center; justify-content: center; height: 160px; color: #9ca3af; text-align: center;';
        placeholder.innerHTML = `
            <i class="fas fa-layer-group" style="font-size: 24px; margin-bottom: 8px; opacity: 0.5;"></i>
            <span style="font-size: 13px;">Weight data not available</span>
            <span style="font-size: 11px; margin-top: 4px;">Run a new experiment to collect weight stats</span>
        `;
        const existingPlaceholder = ctx.parentElement.querySelector('.weight-placeholder');
        if (existingPlaceholder) existingPlaceholder.remove();
        placeholder.className = 'weight-placeholder';
        ctx.parentElement.appendChild(placeholder);
        return;
    }

    // Remove placeholder if exists and show canvas
    const existingPlaceholder = ctx.parentElement.querySelector('.weight-placeholder');
    if (existingPlaceholder) existingPlaceholder.remove();
    ctx.style.display = 'block';

    // Destroy existing chart
    if (trainingWeightStatsChart) {
        trainingWeightStatsChart.destroy();
    }

    const datasets = [
        {
            label: 'Mean',
            data: towerStats.mean,
            borderColor: '#3b82f6',
            tension: 0.3,
            fill: false,
            pointRadius: 2
        },
        {
            label: 'Std Dev',
            data: towerStats.std,
            borderColor: '#f59e0b',
            tension: 0.3,
            fill: false,
            pointRadius: 2
        }
    ];

    // Add min/max as filled area if available
    if (towerStats.min && towerStats.max) {
        datasets.push({
            label: 'Min',
            data: towerStats.min,
            borderColor: '#10b981',
            borderDash: [2, 2],
            tension: 0.3,
            fill: false,
            pointRadius: 0
        });
        datasets.push({
            label: 'Max',
            data: towerStats.max,
            borderColor: '#ef4444',
            borderDash: [2, 2],
            tension: 0.3,
            fill: false,
            pointRadius: 0
        });
    }

    trainingWeightStatsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: epochs.map(e => e + 1),
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: trainingChartDefaults.layout,
            plugins: {
                legend: {
                    position: 'top',
                    labels: trainingChartDefaults.legend.labels
                },
                tooltip: { mode: 'index', intersect: false }
            },
            scales: {
                y: {
                    grace: trainingChartDefaults.scales.y.grace,
                    title: { display: true, text: 'Value', ...trainingChartDefaults.scales.y.title },
                    ticks: trainingChartDefaults.scales.y.ticks
                },
                x: {
                    ticks: trainingChartDefaults.scales.x.ticks
                }
            }
        }
    });
}

// Update weight stats chart when tower selection changes (legacy - kept for compatibility)
function updateWeightStatsChart() {
    if (!currentWeightStatsData) return;
    const tower = document.getElementById('weightAnalysisTower')?.value || 'query';
    renderWeightStatsChart(currentWeightStatsData, tower);
}

// Update both Weight Norm and Weight Distribution charts together
function updateWeightAnalysisCharts() {
    const tower = document.getElementById('weightAnalysisTower')?.value || 'query';

    if (currentWeightNormData) {
        renderGradientChart(currentWeightNormData, tower);
    }
    if (currentWeightStatsData) {
        renderWeightStatsChart(currentWeightStatsData, tower);
    }
}

// Fetch histogram data on-demand from MLflow (not cached due to size)
async function fetchHistogramData(history, tower, isGradients) {
    try {
        console.log('[Histogram] Fetching on-demand from MLflow...');
        const response = await fetch(`/api/quick-tests/${viewModalExpId}/histogram-data/`);
        const data = await response.json();

        // Mark fetch attempted to prevent infinite loops
        history._histogramFetchAttempted = true;

        if (data.success && data.histogram_data) {
            // Merge histogram data into history
            const histData = data.histogram_data;

            // Merge weight_stats histograms
            if (histData.weight_stats) {
                for (const t of ['query', 'candidate']) {
                    if (histData.weight_stats[t]?.histogram) {
                        if (!history.weight_stats) history.weight_stats = {};
                        if (!history.weight_stats[t]) history.weight_stats[t] = {};
                        history.weight_stats[t].histogram = histData.weight_stats[t].histogram;
                    }
                }
            }

            // Merge gradient_stats histograms
            if (histData.gradient_stats) {
                for (const t of ['query', 'candidate']) {
                    if (histData.gradient_stats[t]?.histogram) {
                        if (!history.gradient_stats) history.gradient_stats = {};
                        if (!history.gradient_stats[t]) history.gradient_stats[t] = {};
                        history.gradient_stats[t].histogram = histData.gradient_stats[t].histogram;
                    }
                }
            }

            console.log('[Histogram] Data fetched and merged successfully');

            // Update cache
            viewModalDataCache.trainingHistory = history;
            currentWeightHistogramData = history;

            // Re-render chart with new data
            renderWeightHistogramChart(history, tower);
        } else {
            console.log('[Histogram] No histogram data available from MLflow');
            // Re-render to show "not available" message
            renderWeightHistogramChart(history, tower);
        }
    } catch (error) {
        console.error('[Histogram] Failed to fetch:', error);
        history._histogramFetchAttempted = true;
        renderWeightHistogramChart(history, tower);
    }
}

// Render TensorBoard-style ridgeline plot using D3.js
// Supports both weight and gradient histograms
function renderWeightHistogramChart(history, tower = 'query') {
    const container = document.getElementById('trainingWeightHistogramChart');
    if (!container) return;

    // Store data for tower switching
    currentWeightHistogramData = history;

    // Get data type (weights or gradients)
    const dataType = document.getElementById('histogramDataType')?.value || 'weights';
    const isGradients = dataType === 'gradients';

    // Select appropriate data source
    const statsSource = isGradients ? (history.gradient_stats || {}) : (history.weight_stats || {});
    const towerStats = statsSource[tower] || {};
    const histogram = towerStats.histogram;

    // Update chart title
    const titleEl = document.getElementById('histogramChartTitle');
    if (titleEl) {
        titleEl.textContent = isGradients ? 'Gradient Distribution Histogram' : 'Weight Distribution Histogram';
    }

    // Check if histogram data is available
    if (!histogram || !histogram.bin_edges || !histogram.counts || histogram.counts.length === 0) {
        // Check if histogram data is available via on-demand fetch
        if (history.histogram_available && viewModalExpId && !history._histogramFetchAttempted) {
            // Show loading state
            container.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #9ca3af; text-align: center;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 32px; margin-bottom: 12px; opacity: 0.5;"></i>
                    <span style="font-size: 14px;">Loading histogram data from MLflow...</span>
                    <span style="font-size: 12px; margin-top: 6px;">This may take a moment</span>
                </div>
            `;
            // Fetch histogram data on-demand
            fetchHistogramData(history, tower, isGradients);
            return;
        }

        const dataTypeName = isGradients ? 'Gradient' : 'Weight';
        const featureNote = isGradients
            ? 'Run a new experiment to collect gradient distribution histograms.<br>This feature requires experiments run after the gradient logging update.'
            : 'Run a new experiment to collect weight distribution histograms.<br>This feature requires experiments run after the histogram logging update.';
        container.innerHTML = `
            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #9ca3af; text-align: center;">
                <i class="fas fa-chart-area" style="font-size: 32px; margin-bottom: 12px; opacity: 0.5;"></i>
                <span style="font-size: 14px;">${dataTypeName} histogram data not available for this experiment</span>
                <span style="font-size: 12px; margin-top: 6px; max-width: 400px;">
                    ${featureNote}
                </span>
            </div>
        `;
        return;
    }

    // Check if container is visible (has dimensions)
    const rect = container.getBoundingClientRect();
    if (rect.width === 0 || rect.height === 0) {
        requestAnimationFrame(() => renderWeightHistogramChart(history, tower));
        return;
    }

    // Clear container
    container.innerHTML = '';

    const { bin_edges, counts } = histogram;
    const epochs = history.epochs || [];
    const numEpochs = counts.length;
    const numBins = bin_edges.length - 1;

    // Dimensions - dynamic top margin to prevent clipping of ridges
    // Step 1: Calculate preliminary dimensions to determine bandwidth
    const baseMargin = { top: 10, right: 50, bottom: 40, left: 50 };
    const width = Math.floor(rect.width) - baseMargin.left - baseMargin.right;
    const prelimHeight = Math.floor(rect.height) - baseMargin.top - baseMargin.bottom;

    // Step 2: Calculate bandwidth from preliminary yEpoch scale
    const prelimYEpoch = d3.scaleBand()
        .domain(d3.range(numEpochs))
        .range([0, prelimHeight])
        .paddingInner(0);
    const bandWidth = prelimYEpoch.bandwidth();

    // Step 3: Calculate dynamic ridge height
    // Ridge height scales inversely with number of epochs
    // More epochs = shorter ridges to prevent excessive overlap
    const baseRidgeHeight = prelimHeight * 0.15;  // Original 15%
    const scaledRidgeHeight = bandWidth * 2.5;    // 2.5x band height
    const maxRidgeHeight = Math.min(baseRidgeHeight, scaledRidgeHeight);

    // Step 4: Calculate dynamic top margin to accommodate ridge overflow
    const dynamicTopMargin = maxRidgeHeight + 15;
    const margin = {
        top: dynamicTopMargin,
        right: baseMargin.right,
        bottom: baseMargin.bottom,
        left: baseMargin.left
    };

    // Step 5: Recalculate final height with dynamic margin
    const height = Math.floor(rect.height) - margin.top - margin.bottom;

    // Create SVG
    const svg = d3.select(container)
        .append('svg')
        .attr('width', width + margin.left + margin.right)
        .attr('height', height + margin.top + margin.bottom)
        .append('g')
        .attr('transform', `translate(${margin.left},${margin.top})`);

    // Data range
    const maxCount = Math.max(...counts.flat());
    const xMin = bin_edges[0];
    const xMax = bin_edges[bin_edges.length - 1];

    // X scale: weight values
    const xScale = d3.scaleLinear()
        .domain([xMin, xMax])
        .range([0, width]);

    // Y scale for density (height of each ridge) - uses dynamic maxRidgeHeight
    const yDensity = d3.scaleLinear()
        .domain([0, maxCount])
        .range([0, maxRidgeHeight]);

    // Y scale for epoch positioning (band scale)
    const yEpoch = d3.scaleBand()
        .domain(d3.range(numEpochs))
        .range([0, height])
        .paddingInner(0);

    // Color scale: light orange (old) to dark orange (new)
    const colorScale = d3.scaleLinear()
        .domain([0, numEpochs - 1])
        .range(['#fdd4b3', '#e25822']);

    // Prepare data for each epoch
    const ridgeData = counts.map((epochCounts, epochIdx) => {
        const points = epochCounts.map((count, binIdx) => ({
            x: (bin_edges[binIdx] + bin_edges[binIdx + 1]) / 2,
            y: count
        }));
        // Add endpoints at baseline
        return {
            epochIdx,
            points: [
                { x: bin_edges[0], y: 0 },
                ...points,
                { x: bin_edges[numBins], y: 0 }
            ]
        };
    });

    // Area generator
    const area = d3.area()
        .x(d => xScale(d.x))
        .y0(0)
        .y1(d => -yDensity(d.y))
        .curve(d3.curveBasis);  // Smooth curves

    // Draw ridges from back to front (oldest first)
    svg.selectAll('.ridge')
        .data(ridgeData)
        .join('path')
        .attr('class', 'ridge')
        .attr('transform', d => `translate(0, ${yEpoch(d.epochIdx) + yEpoch.bandwidth()})`)
        .attr('d', d => area(d.points))
        .attr('fill', d => colorScale(d.epochIdx))
        .attr('fill-opacity', d => 0.7 + (d.epochIdx / Math.max(numEpochs - 1, 1)) * 0.25)
        .attr('stroke', '#fff')
        .attr('stroke-width', 1);

    // X-axis
    const xAxis = d3.axisBottom(xScale)
        .ticks(8)
        .tickFormat(d => (xMax - xMin) > 1 ? d.toFixed(1) : d.toFixed(2));

    svg.append('g')
        .attr('transform', `translate(0, ${height})`)
        .call(xAxis)
        .selectAll('text')
        .style('font-size', '11px')
        .style('fill', '#6b7280');

    // X-axis label (dynamic based on data type)
    const xAxisLabel = isGradients ? 'Gradient Value' : 'Weight Value';
    svg.append('text')
        .attr('x', width / 2)
        .attr('y', height + 35)
        .attr('text-anchor', 'middle')
        .style('font-size', '12px')
        .style('fill', '#374151')
        .text(xAxisLabel);

    // Epoch labels on right side
    const epochStep = Math.max(1, Math.ceil(numEpochs / 15));
    const epochLabels = d3.range(0, numEpochs, epochStep);
    if ((numEpochs - 1) % epochStep !== 0) epochLabels.push(numEpochs - 1);

    // Horizontal grid lines for major epochs (barely visible)
    svg.selectAll('.epoch-grid-line')
        .data(epochLabels)
        .join('line')
        .attr('class', 'epoch-grid-line')
        .attr('x1', 0)
        .attr('x2', width)
        .attr('y1', d => yEpoch(d) + yEpoch.bandwidth())
        .attr('y2', d => yEpoch(d) + yEpoch.bandwidth())
        .attr('stroke', '#e5e7eb')
        .attr('stroke-width', 1)
        .attr('stroke-opacity', 0.4);

    svg.selectAll('.epoch-label')
        .data(epochLabels)
        .join('text')
        .attr('class', 'epoch-label')
        .attr('x', width + 8)
        .attr('y', d => yEpoch(d) + yEpoch.bandwidth())
        .attr('dy', '0.35em')
        .style('font-size', '10px')
        .style('fill', '#9ca3af')
        .text(d => epochs[d] !== undefined ? epochs[d] + 1 : d + 1);

}

// Update histogram chart when tower selection changes
function updateWeightHistogramChart() {
    if (!currentWeightHistogramData) return;
    const tower = document.getElementById('weightHistogramTower').value;
    renderWeightHistogramChart(currentWeightHistogramData, tower);
}

function toggleErrorDetails() {
    const content = document.getElementById('expViewErrorDetails');
    const icon = document.getElementById('expViewErrorToggleIcon');
    const text = document.getElementById('expViewErrorToggleText');

    content.classList.toggle('hidden');
    icon.classList.toggle('expanded');
    text.textContent = content.classList.contains('hidden') ? 'Show Error Details' : 'Hide Error Details';
}

function formatDateTime(isoStr) {
    if (!isoStr) return '-';
    const d = new Date(isoStr);
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) + ' ' +
           d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
}

// View Modal Polling
function startViewModalPolling(expId) {
    stopViewModalPolling();

    viewModalPollInterval = setInterval(async () => {
        try {
            const response = await fetch(`/api/quick-tests/${expId}/`);
            const data = await response.json();

            if (data.success) {
                const exp = data.quick_test;
                populateExpViewModal(exp);
                updateExpCard(exp);

                if (['completed', 'failed', 'cancelled'].includes(exp.status)) {
                    stopViewModalPolling();
                }
            }
        } catch (error) {
            console.error('View modal polling error:', error);
        }
    }, 10000);
}

function stopViewModalPolling() {
    if (viewModalPollInterval) {
        clearInterval(viewModalPollInterval);
        viewModalPollInterval = null;
    }
}

function getDefaultStages() {
    return [
        { name: 'Compile', status: 'pending', duration_seconds: null },
        { name: 'Examples', status: 'pending', duration_seconds: null },
        { name: 'Stats', status: 'pending', duration_seconds: null },
        { name: 'Schema', status: 'pending', duration_seconds: null },
        { name: 'Transform', status: 'pending', duration_seconds: null },
        { name: 'Train', status: 'pending', duration_seconds: null }
    ];
}

// =============================================================================
// BACKGROUND POLLING
// =============================================================================
function startBackgroundPolling() {
    // Poll for running experiments every 30 seconds
    setInterval(async () => {
        const hasRunning = experiments.some(e => e.status === 'running' || e.status === 'submitting');
        if (hasRunning) {
            await loadExperiments(pagination.page);
        }
    }, 30000);
}

function updateExpCard(exp) {
    // Find and update the card in the DOM
    const card = document.querySelector(`[data-exp-id="${exp.id}"]`);
    if (card) {
        card.outerHTML = renderExpCard(exp);
    }
}

// View from experiment card
function viewExpFromCard(event, expId) {
    event.stopPropagation(); // Prevent card click
    openExpDetails(expId);
}

// Cancel from experiment card
function cancelExpFromCard(event, expId) {
    event.stopPropagation(); // Prevent card click

    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;

    showConfirmModal({
        title: 'Cancel Experiment',
        message: 'Are you sure you want to cancel this experiment?<br><span class="text-sm text-gray-500 mt-2 block">This will stop the Vertex AI pipeline.</span>',
        confirmText: 'Yes, Cancel',
        cancelText: 'Keep Running',
        type: 'warning',
        onConfirm: async () => {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const response = await fetch(`/api/quick-tests/${expId}/cancel/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                });

                const data = await response.json();

                if (data.success) {
                    await loadExperiments(pagination.page);
                    showSuccess('Experiment cancelled');
                } else {
                    showError(data.error || 'Failed to cancel experiment');
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                }
            } catch (error) {
                showError('Failed to cancel: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        }
    });
}

function deleteExpFromCard(event, expId) {
    event.stopPropagation(); // Prevent card click

    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;

    showConfirmModal({
        title: 'Delete Experiment',
        message: 'Are you sure you want to delete this experiment?<br><span class="text-sm text-gray-500 mt-2 block">This will permanently delete the experiment and its artifacts. This action cannot be undone.</span>',
        confirmText: 'Ok',
        cancelText: 'Cancel',
        type: 'danger',
        confirmButtonClass: 'btn-neu-save',
        cancelButtonClass: 'btn-neu-cancel',
        onConfirm: async () => {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const response = await fetch(`/api/quick-tests/${expId}/delete/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                });

                const data = await response.json();

                if (data.success) {
                    await loadExperiments(pagination.page);
                } else {
                    showError(data.error || 'Failed to delete experiment');
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                }
            } catch (error) {
                showError('Failed to delete: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        }
    });
}

// =============================================================================
// COMPARE SELECTION MODAL (Select experiments to compare)
// =============================================================================
let compareSelectIds = new Set();
let selectableExperiments = [];
let compareSelectCurrentPage = 1;
const COMPARE_SELECT_PER_PAGE = 20;

async function openCompareSelectModal() {
    const modal = document.getElementById('compareSelectModal');
    const loadingEl = document.getElementById('compareSelectLoading');
    const emptyEl = document.getElementById('compareSelectEmpty');
    const listEl = document.getElementById('compareSelectList');
    const paginationEl = document.getElementById('compareSelectPagination');

    // Reset selection and pagination
    compareSelectIds.clear();
    compareSelectCurrentPage = 1;
    updateCompareSelectUI();

    // Show modal with loading state
    modal.classList.remove('hidden');
    loadingEl.classList.remove('hidden');
    emptyEl.classList.add('hidden');
    listEl.classList.add('hidden');

    try {
        const response = await fetch('/api/experiments/selectable/');
        const data = await response.json();

        loadingEl.classList.add('hidden');

        if (!data.success) {
            showError(data.error || 'Failed to load experiments');
            emptyEl.classList.remove('hidden');
            return;
        }

        selectableExperiments = data.experiments || [];

        if (selectableExperiments.length === 0) {
            emptyEl.classList.remove('hidden');
            paginationEl.classList.add('hidden');
            return;
        }

        // Render experiment list with pagination
        renderSelectableExperiments();
        listEl.classList.remove('hidden');

        // Show pagination if more than one page
        if (selectableExperiments.length > COMPARE_SELECT_PER_PAGE) {
            paginationEl.classList.remove('hidden');
            paginationEl.style.display = 'flex';
            renderCompareSelectPagination();
        } else {
            paginationEl.classList.add('hidden');
        }

    } catch (error) {
        console.error('Error loading selectable experiments:', error);
        loadingEl.classList.add('hidden');
        emptyEl.classList.remove('hidden');
        showError('Error loading experiments');
    }
}

function closeCompareSelectModal(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('compareSelectModal').classList.add('hidden');
}

function renderSelectableExperiments() {
    const listEl = document.getElementById('compareSelectList');
    listEl.innerHTML = '';

    // Calculate pagination
    const startIdx = (compareSelectCurrentPage - 1) * COMPARE_SELECT_PER_PAGE;
    const endIdx = Math.min(startIdx + COMPARE_SELECT_PER_PAGE, selectableExperiments.length);
    const pageExperiments = selectableExperiments.slice(startIdx, endIdx);

    pageExperiments.forEach(exp => {
        const row = document.createElement('div');
        row.className = `compare-select-row status-${exp.status || 'running'}`;
        row.dataset.expId = exp.id;
        row.dataset.status = exp.status || 'running';
        row.onclick = () => toggleCompareSelect(exp.id);

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'compare-select-checkbox';
        checkbox.checked = compareSelectIds.has(exp.id);
        checkbox.onclick = (e) => e.stopPropagation();
        checkbox.onchange = () => toggleCompareSelect(exp.id);

        const infoCol = document.createElement('div');
        infoCol.className = 'compare-select-info-col';

        const topLine = document.createElement('div');
        const expNum = document.createElement('span');
        expNum.className = 'compare-select-exp-num';
        expNum.textContent = exp.display_name || `Exp #${exp.experiment_number}`;
        topLine.appendChild(expNum);

        if (exp.experiment_name) {
            const expName = document.createElement('span');
            expName.className = 'compare-select-exp-name';
            expName.textContent = ' ' + exp.experiment_name;
            topLine.appendChild(expName);
        }

        infoCol.appendChild(topLine);

        if (exp.experiment_description_short) {
            const desc = document.createElement('div');
            desc.className = 'compare-select-desc';
            desc.textContent = exp.experiment_description_short;
            infoCol.appendChild(desc);
        }

        const status = document.createElement('span');
        status.className = `compare-select-status ${exp.status}`;
        status.textContent = exp.status;

        row.appendChild(checkbox);
        row.appendChild(infoCol);
        row.appendChild(status);

        listEl.appendChild(row);
    });
}

function toggleCompareSelect(expId) {
    if (compareSelectIds.has(expId)) {
        compareSelectIds.delete(expId);
    } else if (compareSelectIds.size < 4) {
        compareSelectIds.add(expId);
    } else {
        showError('Maximum 4 experiments can be compared');
        return;
    }
    updateCompareSelectUI();
}

function updateCompareSelectUI() {
    const count = compareSelectIds.size;

    // Update count display
    const countEl = document.getElementById('compareSelectCount');
    countEl.textContent = `${count} selected`;
    countEl.style.color = count >= 2 ? '#10b981' : '#f59e0b';

    // Update button state
    const btn = document.getElementById('compareSelectBtn');
    btn.disabled = count < 2;

    // Update row highlighting and checkboxes
    document.querySelectorAll('.compare-select-row').forEach(row => {
        const expId = parseInt(row.dataset.expId);
        const isSelected = compareSelectIds.has(expId);
        row.classList.toggle('selected', isSelected);
        const checkbox = row.querySelector('.compare-select-checkbox');
        if (checkbox) checkbox.checked = isSelected;

        // Disable row if at limit and not selected
        const atLimit = compareSelectIds.size >= 4 && !isSelected;
        row.classList.toggle('disabled', atLimit);
    });
}

function clearCompareSelection() {
    compareSelectIds.clear();
    updateCompareSelectUI();
}

function renderCompareSelectPagination() {
    const totalPages = Math.ceil(selectableExperiments.length / COMPARE_SELECT_PER_PAGE);
    const startIdx = (compareSelectCurrentPage - 1) * COMPARE_SELECT_PER_PAGE + 1;
    const endIdx = Math.min(compareSelectCurrentPage * COMPARE_SELECT_PER_PAGE, selectableExperiments.length);

    // Update page info text
    const pageInfoEl = document.getElementById('compareSelectPageInfo');
    pageInfoEl.innerHTML = `Showing <span class="font-semibold">${startIdx}</span>-<span class="font-semibold">${endIdx}</span> of <span class="font-semibold">${selectableExperiments.length}</span> experiments`;

    // Render pagination controls
    const controlsEl = document.getElementById('compareSelectPageControls');
    controlsEl.innerHTML = '';

    // Previous button
    const prevBtn = document.createElement('button');
    prevBtn.className = 'px-4 py-2 border border-gray-300 rounded-lg text-sm font-semibold bg-white hover:bg-gray-50';
    prevBtn.textContent = 'Previous';
    prevBtn.disabled = compareSelectCurrentPage === 1;
    if (compareSelectCurrentPage === 1) {
        prevBtn.className = 'px-4 py-2 border border-gray-300 rounded-lg text-sm font-semibold opacity-50 cursor-not-allowed bg-gray-100';
    }
    prevBtn.onclick = () => goToCompareSelectPage(compareSelectCurrentPage - 1);
    controlsEl.appendChild(prevBtn);

    // Page number buttons
    const maxVisiblePages = 5;
    let startPage = 1;
    let endPage = totalPages;

    if (totalPages > maxVisiblePages) {
        // Show first 5 pages, then ..., then last page
        startPage = 1;
        endPage = Math.min(5, totalPages);
    }

    for (let i = startPage; i <= endPage; i++) {
        const pageBtn = document.createElement('button');
        pageBtn.textContent = i;
        if (i === compareSelectCurrentPage) {
            pageBtn.className = 'w-10 h-10 flex items-center justify-center rounded-md text-sm font-semibold bg-blue-600 text-white';
        } else {
            pageBtn.className = 'w-10 h-10 flex items-center justify-center rounded-md text-sm font-semibold border border-gray-300 text-gray-700 hover:bg-blue-50 hover:border-blue-500';
        }
        pageBtn.onclick = () => goToCompareSelectPage(i);
        controlsEl.appendChild(pageBtn);
    }

    // Ellipsis and last page if needed
    if (totalPages > maxVisiblePages) {
        const ellipsis = document.createElement('span');
        ellipsis.className = 'px-2 text-gray-500';
        ellipsis.textContent = '...';
        controlsEl.appendChild(ellipsis);

        const lastPageBtn = document.createElement('button');
        lastPageBtn.textContent = totalPages;
        if (totalPages === compareSelectCurrentPage) {
            lastPageBtn.className = 'w-10 h-10 flex items-center justify-center rounded-md text-sm font-semibold bg-blue-600 text-white';
        } else {
            lastPageBtn.className = 'w-10 h-10 flex items-center justify-center rounded-md text-sm font-semibold border border-gray-300 text-gray-700 hover:bg-blue-50 hover:border-blue-500';
        }
        lastPageBtn.onclick = () => goToCompareSelectPage(totalPages);
        controlsEl.appendChild(lastPageBtn);
    }

    // Next button
    const nextBtn = document.createElement('button');
    nextBtn.className = 'px-4 py-2 border border-gray-300 rounded-lg text-sm font-semibold bg-white hover:bg-gray-50';
    nextBtn.textContent = 'Next';
    nextBtn.disabled = compareSelectCurrentPage === totalPages;
    if (compareSelectCurrentPage === totalPages) {
        nextBtn.className = 'px-4 py-2 border border-gray-300 rounded-lg text-sm font-semibold opacity-50 cursor-not-allowed bg-gray-100';
    }
    nextBtn.onclick = () => goToCompareSelectPage(compareSelectCurrentPage + 1);
    controlsEl.appendChild(nextBtn);
}

function goToCompareSelectPage(page) {
    const totalPages = Math.ceil(selectableExperiments.length / COMPARE_SELECT_PER_PAGE);
    if (page < 1 || page > totalPages) return;

    compareSelectCurrentPage = page;
    renderSelectableExperiments();
    renderCompareSelectPagination();
    updateCompareSelectUI();

    // Scroll to top of list
    const listEl = document.getElementById('compareSelectList');
    listEl.scrollTop = 0;
}

async function proceedToCompare() {
    if (compareSelectIds.size < 2) {
        showError('Select at least 2 experiments to compare');
        return;
    }

    // Close selection modal and open comparison modal
    closeCompareSelectModal();
    await openCompareModal();
}

// =============================================================================
// COMPARE MODAL (Experiment Comparison Results)
// =============================================================================

async function openCompareModal() {
    const modal = document.getElementById('compareModal');
    const loadingEl = document.getElementById('compareLoading');
    const emptyEl = document.getElementById('compareEmpty');
    const contentEl = document.getElementById('compareContent');
    const countEl = document.getElementById('compareSelectedCount');

    modal.classList.remove('hidden');
    countEl.textContent = `${compareSelectIds.size} experiments selected`;

    // Show loading
    emptyEl.classList.add('hidden');
    contentEl.classList.add('hidden');
    loadingEl.classList.remove('hidden');

    try {
        const response = await fetch('/api/experiments/compare/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                quick_test_ids: Array.from(compareSelectIds)
            })
        });

        const data = await response.json();
        loadingEl.classList.add('hidden');

        if (!data.success) {
            showError(data.error || 'Failed to load comparison data');
            emptyEl.classList.remove('hidden');
            return;
        }

        // Render comparison tables with new grouped structure
        renderComparisonTables(data.comparison);
        contentEl.classList.remove('hidden');

    } catch (error) {
        console.error('Error loading comparison:', error);
        loadingEl.classList.add('hidden');
        emptyEl.classList.remove('hidden');
        showError('Error loading comparison data');
    }
}

function closeCompareModal(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('compareModal').classList.add('hidden');
}

function renderComparisonTables(comparison) {
    const experiments = comparison.experiments || [];
    if (experiments.length === 0) return;

    // Render unified table
    renderUnifiedCompareTable(experiments);
}

function renderUnifiedCompareTable(experiments) {
    // Render header
    const headerRow = document.getElementById('compareUnifiedHeader');
    while (headerRow.children.length > 1) {
        headerRow.removeChild(headerRow.lastChild);
    }

    experiments.forEach(exp => {
        const th = document.createElement('th');
        th.className = 'compare-exp-header';
        th.innerHTML = `
            <div class="compare-exp-name">${exp.display_name}</div>
            <div class="compare-exp-subtext">${exp.feature_config?.name || ''}</div>
        `;
        headerRow.appendChild(th);
    });

    // Render body with all sections
    const tbody = document.getElementById('compareUnifiedBody');
    tbody.innerHTML = '';

    // METRICS COMPARISON section
    addSectionHeader(tbody, 'Metrics Comparison', experiments.length);

    // Results subsection
    addSectionHeader(tbody, 'Results', experiments.length);

    const resultRows = [
        { key: 'recall_at_100', label: 'Recall@100', getter: exp => exp.results?.recall_at_100, format: v => (v * 100).toFixed(2) + '%', higherBetter: true },
        { key: 'recall_at_50', label: 'Recall@50', getter: exp => exp.results?.recall_at_50, format: v => (v * 100).toFixed(2) + '%', higherBetter: true },
        { key: 'recall_at_10', label: 'Recall@10', getter: exp => exp.results?.recall_at_10, format: v => (v * 100).toFixed(2) + '%', higherBetter: true },
        { key: 'loss', label: 'Loss', getter: exp => exp.results?.loss, format: v => v.toFixed(4), higherBetter: false },
        { key: 'duration', label: 'Duration', getter: exp => exp.results?.duration_seconds, format: v => formatDuration(v), higherBetter: false },
    ];

    resultRows.forEach(rowDef => {
        const values = experiments.map(rowDef.getter);
        if (!values.some(v => v !== null && v !== undefined)) return;
        addCompareRow(tbody, rowDef.label, experiments, rowDef.getter, rowDef.format, rowDef.higherBetter);
    });

    // Status row
    addCompareRow(tbody, 'Status', experiments, exp => exp.status, v => v, null, true);

    // PARAMETERS COMPARISON section
    addSectionHeader(tbody, 'Parameters Comparison', experiments.length);

    // Training Parameters subsection
    addSectionHeader(tbody, 'Training Parameters', experiments.length);

    const trainingRows = [
        { label: 'Epochs', getter: exp => exp.training?.epochs },
        { label: 'Batch Size', getter: exp => exp.training?.batch_size },
        { label: 'Learning Rate', getter: exp => exp.training?.learning_rate, format: v => v?.toExponential ? v.toExponential(2) : v },
        { label: 'Machine Type', getter: exp => exp.training?.machine_type },
    ];

    trainingRows.forEach(rowDef => {
        addCompareRow(tbody, rowDef.label, experiments, rowDef.getter, rowDef.format);
    });

    // Sampling subsection
    addSectionHeader(tbody, 'Sampling', experiments.length);

    const samplingRows = [
        { label: 'Sample %', getter: exp => exp.sampling?.data_sample_percent, format: v => v + '%' },
        { label: 'Split Strategy', getter: exp => exp.sampling?.split_strategy, format: v => v?.replace('_', ' ') },
        { label: 'Holdout Days', getter: exp => exp.sampling?.holdout_days },
        { label: 'Date Column', getter: exp => exp.sampling?.date_column },
    ];

    samplingRows.forEach(rowDef => {
        addCompareRow(tbody, rowDef.label, experiments, rowDef.getter, rowDef.format);
    });

    // CONFIGURATION section
    addSectionHeader(tbody, 'Configuration', experiments.length);

    // Dataset subsection
    addSectionHeader(tbody, 'Dataset', experiments.length);

    const datasetRows = [
        { label: 'Name', getter: exp => exp.dataset?.name },
        { label: 'Rows', getter: exp => exp.dataset?.row_count, format: v => v?.toLocaleString() },
        { label: 'Unique Users', getter: exp => exp.dataset?.unique_users, format: v => v?.toLocaleString() },
        { label: 'Unique Products', getter: exp => exp.dataset?.unique_products, format: v => v?.toLocaleString() },
    ];

    datasetRows.forEach(rowDef => {
        addCompareRow(tbody, rowDef.label, experiments, rowDef.getter, rowDef.format);
    });

    // Feature Config subsection
    addSectionHeader(tbody, 'Feature Config', experiments.length);

    const featureRows = [
        { label: 'Name', getter: exp => exp.feature_config?.name },
        { label: 'Version', getter: exp => exp.feature_config?.version },
        { label: 'Buyer Features', getter: exp => exp.feature_config?.buyer_features || `${exp.feature_config?.buyer_features_count || 0} features` },
        { label: 'Buyer Tensor Dim', getter: exp => exp.feature_config?.buyer_tensor_dim },
        { label: 'Buyer Crosses', getter: exp => exp.feature_config?.buyer_crosses || '' },
        { label: 'Product Features', getter: exp => exp.feature_config?.product_features || `${exp.feature_config?.product_features_count || 0} features` },
        { label: 'Product Tensor Dim', getter: exp => exp.feature_config?.product_tensor_dim },
        { label: 'Product Crosses', getter: exp => exp.feature_config?.product_crosses || '' },
    ];

    featureRows.forEach(rowDef => {
        addCompareRow(tbody, rowDef.label, experiments, rowDef.getter, rowDef.format);
    });

    // Model Config subsection
    addSectionHeader(tbody, 'Model Config', experiments.length);

    const modelRows = [
        { label: 'Name', getter: exp => exp.model_config?.name },
        { label: 'Type', getter: exp => exp.model_config?.model_type },
        { label: 'Optimizer', getter: exp => exp.model_config?.optimizer },
        { label: 'Output Embedding', getter: exp => exp.model_config?.output_embedding_dim },
        { label: 'Tower Layers', getter: exp => exp.model_config?.tower_layers || '' },
    ];

    modelRows.forEach(rowDef => {
        addCompareRow(tbody, rowDef.label, experiments, rowDef.getter, rowDef.format);
    });
}

function addSectionHeader(tbody, title, colSpan, isMainSection = false) {
    // Main sections: Metrics Comparison, Parameters Comparison, Configuration
    const mainSections = ['Metrics Comparison', 'Parameters Comparison', 'Configuration'];
    const isMain = mainSections.includes(title);

    const row = document.createElement('tr');
    row.className = isMain ? 'compare-main-section-header' : 'compare-section-header';
    const cell = document.createElement('td');
    cell.colSpan = colSpan + 1;
    cell.textContent = title;
    row.appendChild(cell);
    tbody.appendChild(row);
}

function addCompareRow(tbody, label, experiments, getter, format, higherBetter = null, isStatus = false) {
    const row = document.createElement('tr');
    const values = experiments.map(getter);

    // Check if all values are identical
    const validValues = values.filter(v => v !== null && v !== undefined && v !== '' && v !== '');
    const allIdentical = validValues.length > 1 && validValues.every(v => String(v) === String(validValues[0]));
    const hasDifferences = validValues.length > 1 && !allIdentical;

    // Apply row class based on identical/different
    if (allIdentical) {
        row.className = 'compare-row-identical';
    } else if (hasDifferences) {
        row.className = 'compare-row-different';
    }

    // Label cell with indicator
    const nameCell = document.createElement('td');
    nameCell.textContent = label;
    if (allIdentical && validValues.length > 0) {
        const indicator = document.createElement('span');
        indicator.className = 'compare-indicator identical';
        indicator.textContent = ' ';
        indicator.title = 'Identical across all experiments';
        nameCell.appendChild(indicator);
    } else if (hasDifferences) {
        const indicator = document.createElement('span');
        indicator.className = 'compare-indicator different';
        indicator.textContent = ' ';
        indicator.title = 'Values differ between experiments';
        nameCell.appendChild(indicator);
    }
    row.appendChild(nameCell);

    // Find best value for metrics
    let bestValue = null;
    if (higherBetter !== null && validValues.length > 1) {
        const numericValues = validValues.filter(v => typeof v === 'number');
        if (numericValues.length > 1) {
            bestValue = higherBetter ? Math.max(...numericValues) : Math.min(...numericValues);
        }
    }

    // Value cells
    values.forEach(val => {
        const cell = document.createElement('td');
        cell.style.textAlign = 'center';

        if (val === null || val === undefined || val === '') {
            cell.textContent = '';
            cell.className = 'compare-value-na';
        } else {
            const formatted = format ? format(val) : val;
            cell.textContent = formatted;

            // Apply best value highlighting
            if (bestValue !== null && val === bestValue) {
                cell.className = 'compare-value-best';
            }

            // Status-specific coloring
            if (isStatus) {
                if (val === 'completed') {
                    cell.style.color = '#10b981';
                } else if (val === 'failed') {
                    cell.style.color = '#ef4444';
                } else if (val === 'cancelled') {
                    cell.style.color = '#6b7280';
                }
            }
        }

        row.appendChild(cell);
    });

    tbody.appendChild(row);
}

// Keep the old variable for backwards compatibility with card checkboxes
// (will be removed when we clean up the card checkboxes)
let selectedExperimentIds = new Set();

function toggleExperimentSelection(expId) {
    // Deprecated: kept for backwards compatibility
    if (selectedExperimentIds.has(expId)) {
        selectedExperimentIds.delete(expId);
    } else if (selectedExperimentIds.size < 4) {
        selectedExperimentIds.add(expId);
    }
}

function updateCompareButton() {
    // No-op: Compare button is now always visible
}

function clearExperimentSelection() {
    selectedExperimentIds.clear();
}

// =============================================================================
// UTILITIES
// =============================================================================
function formatDuration(seconds) {
    if (!seconds && seconds !== 0) return '0:00';
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

function formatTimeAgo(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'just now';
    if (diffMins < 60) return `${diffMins} min ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    return date.toLocaleDateString();
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showToast(type, title, message) {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;

    const icon = type === 'success' ? 'fa-check' : 'fa-exclamation-triangle';

    toast.innerHTML = `
        <div class="toast-icon">
            <i class="fas ${icon}"></i>
        </div>
        <div class="toast-content">
            <div class="toast-title">${title}</div>
            <div class="toast-message">${message}</div>
        </div>
        <button class="toast-close" onclick="closeToast(this)">
            <i class="fas fa-times"></i>
        </button>
    `;

    container.appendChild(toast);

    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (toast.parentNode) {
            toast.classList.add('hiding');
            setTimeout(() => toast.remove(), 200);
        }
    }, 5000);
}

function closeToast(btn) {
    const toast = btn.closest('.toast');
    toast.classList.add('hiding');
    setTimeout(() => toast.remove(), 200);
}

function showError(message) {
    showToast('error', 'Error', message);
}

function showSuccess(message) {
    showToast('success', 'Success', message);
}

// =============================================================================
// EXPERIMENTS DASHBOARD
// =============================================================================
let heatmapChart = null;

async function loadExperimentsDashboard() {
    const loadingEl = document.getElementById('dashboardLoading');
    const contentEl = document.getElementById('dashboardContent');
    const emptyEl = document.getElementById('dashboardEmpty');

    try {
        // Load dashboard stats first
        const statsResponse = await fetch('/api/experiments/dashboard-stats/');
        const statsData = await statsResponse.json();

        if (!statsData.success) {
            console.warn('Dashboard stats error:', statsData.error);
            loadingEl.classList.add('hidden');
            emptyEl.classList.remove('hidden');
            return;
        }

        const stats = statsData.stats;

        // Check if we have any experiments
        if (stats.total === 0) {
            loadingEl.classList.add('hidden');
            emptyEl.classList.remove('hidden');
            return;
        }

        // Render summary cards
        document.getElementById('dashboardTotalExp').textContent = stats.total;
        document.getElementById('dashboardCompleted').textContent = stats.completed;
        document.getElementById('dashboardBestRecall').textContent =
            stats.best_recall_100 !== null ? stats.best_recall_100.toFixed(3) : '-';
        document.getElementById('dashboardAvgRecall').textContent =
            stats.avg_recall_100 !== null ? stats.avg_recall_100.toFixed(3) : '-';

        // Show content, hide loading
        loadingEl.classList.add('hidden');
        contentEl.classList.remove('hidden');

        // Load leaderboard and heatmap
        await Promise.all([
            loadLeaderboard(),
            loadHeatmap()
        ]);

    } catch (error) {
        console.error('Failed to load dashboard:', error);
        loadingEl.classList.add('hidden');
        emptyEl.classList.remove('hidden');
    }
}

async function loadLeaderboard() {
    const metric = document.getElementById('leaderboardMetricSelect').value;
    const tbody = document.getElementById('leaderboardBody');

    try {
        const response = await fetch(`/api/experiments/leaderboard/?metric=${metric}&limit=10`);
        const data = await response.json();

        if (!data.success || !data.leaderboard || data.leaderboard.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="leaderboard-empty">
                        <i class="fas fa-trophy text-gray-300 text-2xl mb-2"></i>
                        <p>No completed experiments yet</p>
                    </td>
                </tr>
            `;
            return;
        }

        // Render leaderboard rows
        tbody.innerHTML = data.leaderboard.map((item, index) => {
            const rankClass = index < 3 ? `leaderboard-rank-${index + 1}` : '';
            const bestClass = index === 0 ? 'best' : '';

            return `
                <tr onclick="openExpViewModal(${item.quick_test_id})" title="Click to view details">
                    <td class="leaderboard-rank ${rankClass}">${item.rank}</td>
                    <td>
                        <div class="leaderboard-exp-name">${item.display_name || item.experiment_number}</div>
                    </td>
                    <td class="leaderboard-config">${item.feature_config || '-'}</td>
                    <td class="leaderboard-config">${item.model_config || '-'}</td>
                    <td style="text-align: right;" class="leaderboard-metric ${bestClass}">
                        ${item.metrics.recall_at_100 !== null ? item.metrics.recall_at_100.toFixed(3) : '-'}
                    </td>
                    <td style="text-align: right;" class="leaderboard-metric">
                        ${item.metrics.recall_at_50 !== null ? item.metrics.recall_at_50.toFixed(3) : '-'}
                    </td>
                    <td style="text-align: right;" class="leaderboard-metric">
                        ${item.metrics.loss !== null ? item.metrics.loss.toFixed(4) : '-'}
                    </td>
                </tr>
            `;
        }).join('');

    } catch (error) {
        console.error('Failed to load leaderboard:', error);
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="leaderboard-empty text-red-500">
                    Failed to load leaderboard
                </td>
            </tr>
        `;
    }
}

async function loadHeatmap() {
    const metric = document.getElementById('heatmapMetricSelect').value;
    const container = document.getElementById('heatmapContainer');
    const canvas = document.getElementById('heatmapCanvas');
    const legend = document.getElementById('heatmapLegend');

    try {
        const response = await fetch(`/api/experiments/heatmap/?metric=${metric}`);
        const data = await response.json();

        if (!data.success || !data.heatmap) {
            showHeatmapEmpty(container, canvas, legend, 'Failed to load heatmap data');
            return;
        }

        const heatmap = data.heatmap;

        // Check if we have enough data for a heatmap
        if (heatmap.feature_configs.length === 0 || heatmap.model_configs.length === 0) {
            showHeatmapEmpty(container, canvas, legend, 'Need experiments with different configs to show heatmap');
            return;
        }

        // Show canvas and legend
        canvas.style.display = 'block';
        legend.style.display = 'flex';

        // Destroy existing chart
        if (heatmapChart) {
            heatmapChart.destroy();
            heatmapChart = null;
        }

        // Render heatmap with Chart.js matrix
        renderHeatmapChart(canvas, heatmap);

    } catch (error) {
        console.error('Failed to load heatmap:', error);
        showHeatmapEmpty(container, canvas, legend, 'Error loading heatmap');
    }
}

function showHeatmapEmpty(container, canvas, legend, message) {
    canvas.style.display = 'none';
    legend.style.display = 'none';

    // Remove existing empty message if any
    const existingEmpty = container.querySelector('.heatmap-empty');
    if (existingEmpty) existingEmpty.remove();

    const emptyDiv = document.createElement('div');
    emptyDiv.className = 'heatmap-empty';
    emptyDiv.innerHTML = `
        <i class="fas fa-th"></i>
        <p>${message}</p>
    `;
    container.appendChild(emptyDiv);
}

function renderHeatmapChart(canvas, heatmap) {
    const ctx = canvas.getContext('2d');

    // Remove empty message if present
    const container = canvas.parentElement;
    const existingEmpty = container.querySelector('.heatmap-empty');
    if (existingEmpty) existingEmpty.remove();

    // Build data for matrix chart
    const matrixData = [];
    const featureConfigs = heatmap.feature_configs;
    const modelConfigs = heatmap.model_configs;

    // Create matrix data points
    for (let y = 0; y < featureConfigs.length; y++) {
        for (let x = 0; x < modelConfigs.length; x++) {
            // Find matching data point
            const point = heatmap.data.find(d => d.x === x && d.y === y);
            matrixData.push({
                x: modelConfigs[x],
                y: featureConfigs[y],
                v: point ? point.v : null,
                exp_id: point ? point.exp_id : null
            });
        }
    }

    // Color scale function
    const minVal = heatmap.min_value || 0;
    const maxVal = heatmap.max_value || 1;

    function getColor(value) {
        if (value === null) return 'rgba(229, 231, 235, 0.8)'; // Gray for no data

        // Normalize value between 0 and 1
        const normalized = (value - minVal) / (maxVal - minVal || 1);

        // Color gradient: red (0) -> yellow (0.5) -> green (1)
        if (normalized < 0.5) {
            // Red to yellow
            const r = 239;
            const g = Math.round(68 + (normalized * 2) * (187 - 68));
            const b = 68;
            return `rgba(${r}, ${g}, ${b}, 0.8)`;
        } else {
            // Yellow to green
            const t = (normalized - 0.5) * 2;
            const r = Math.round(251 - t * (251 - 16));
            const g = Math.round(191 + t * (185 - 191));
            const b = Math.round(36 + t * (129 - 36));
            return `rgba(${r}, ${g}, ${b}, 0.8)`;
        }
    }

    // Create the chart using native Chart.js bar chart as a workaround
    // (Matrix plugin requires separate import - using simple visualization)
    heatmapChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: modelConfigs,
            datasets: featureConfigs.map((fc, fcIndex) => ({
                label: fc,
                data: modelConfigs.map((mc, mcIndex) => {
                    const point = matrixData.find(d => d.x === mc && d.y === fc);
                    return point ? point.v : null;
                }),
                backgroundColor: modelConfigs.map((mc, mcIndex) => {
                    const point = matrixData.find(d => d.x === mc && d.y === fc);
                    return getColor(point ? point.v : null);
                }),
                borderColor: 'white',
                borderWidth: 2,
                barPercentage: 0.9,
                categoryPercentage: 0.9
            }))
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'x',
            plugins: {
                legend: {
                    display: true,
                    position: 'right',
                    labels: {
                        boxWidth: 12,
                        font: { size: 11 }
                    }
                },
                tooltip: {
                    callbacks: {
                        title: (items) => {
                            if (items.length === 0) return '';
                            const item = items[0];
                            return `${item.dataset.label}  ${item.label}`;
                        },
                        label: (item) => {
                            const value = item.raw;
                            if (value === null) return 'No data';
                            return `${heatmap.metric}: ${value.toFixed(4)}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Model Config',
                        font: { size: 12, weight: 'bold' }
                    },
                    grid: { display: false }
                },
                y: {
                    title: {
                        display: true,
                        text: heatmap.metric.replace(/_/g, '@').replace('recall@', 'Recall@'),
                        font: { size: 12, weight: 'bold' }
                    },
                    beginAtZero: false,
                    min: minVal > 0 ? minVal * 0.95 : 0,
                    max: maxVal * 1.02
                }
            }
        }
    });
}
</script>

<!-- Chart.js for training curves visualization -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- Chart.js datalabels plugin for showing values on bars -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

<!-- D3.js for ridgeline histogram -->
<script src="https://d3js.org/d3.v7.min.js"></script>

<!-- Pipeline DAG Visualization (extracted component) -->
<script src="{% static 'js/pipeline_dag.js' %}?v=1"></script>
{% endblock %}
