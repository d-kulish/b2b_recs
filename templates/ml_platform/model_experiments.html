{% extends 'base_model.html' %}
{% load humanize %}
{% load static %}

{% block title %}{{ model.name }} - Experiments{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/cards.css' %}?v=4">
<link rel="stylesheet" href="{% static 'css/modals.css' %}?v=2">
<style>
    /* =========================================================================
       Chapter Section Styles
       ========================================================================= */
    .chapter-section {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 20px;
    }
    .chapter-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
    }
    .chapter-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        color: white;
    }
    .chapter-icon.quick-test {
        background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
    }
    .chapter-title {
        font-size: 20px;
        font-weight: 700;
        color: #111827;
    }
    .chapter-empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 48px 24px;
        color: #9ca3af;
        text-align: center;
    }
    .chapter-empty-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
    }
    .chapter-empty-text {
        font-size: 14px;
        max-width: 300px;
    }

    /* =========================================================================
       Filter Bar Styles
       ========================================================================= */
    .exp-filter-bar {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 16px;
        flex-wrap: wrap;
    }
    .exp-filter-group {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .exp-filter-label {
        font-size: 13px;
        font-weight: 500;
        color: #6b7280;
    }
    .exp-filter-select {
        padding: 6px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        font-size: 13px;
        background: white;
        min-width: 140px;
    }
    .exp-filter-select:focus {
        outline: none;
        border-color: #f59e0b;
        box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.1);
    }
    .exp-search-input {
        flex: 1;
        min-width: 200px;
        padding: 6px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        font-size: 13px;
        background: white;
    }
    .exp-search-input:focus {
        outline: none;
        border-color: #f59e0b;
        box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.1);
    }
    .exp-search-input::placeholder {
        color: #9ca3af;
    }

    /* =========================================================================
       Experiment Card Styles
       ========================================================================= */
    .exp-cards-container {
        max-height: 360px;
        overflow-y: auto;
        margin-bottom: 16px;
    }
    .exp-card {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        margin-bottom: 10px;
        background: white;
        transition: all 0.2s ease;
        cursor: pointer;
    }
    .exp-card:hover {
        border-color: #d1d5db;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    .exp-card:last-child {
        margin-bottom: 0;
    }
    .exp-card-status {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        flex-shrink: 0;
    }
    .exp-card-status.running {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        color: #2563eb;
    }
    .exp-card-status.completed {
        background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
        color: #16a34a;
    }
    .exp-card-status.failed {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        color: #dc2626;
    }
    .exp-card-status.cancelled {
        background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        color: #6b7280;
    }
    .exp-card-status.submitting {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        color: #d97706;
    }
    .exp-card-info {
        flex: 1;
        min-width: 0;
    }
    .exp-card-name {
        font-weight: 600;
        font-size: 15px;
        color: #111827;
        margin-bottom: 4px;
    }
    .exp-card-configs {
        font-size: 13px;
        color: #4b5563;
        margin-bottom: 2px;
    }
    .exp-card-meta {
        font-size: 12px;
        color: #9ca3af;
    }
    .exp-card-metric {
        text-align: right;
        flex-shrink: 0;
    }
    .exp-card-metric-value {
        font-size: 18px;
        font-weight: 700;
        color: #111827;
    }
    .exp-card-metric-label {
        font-size: 11px;
        color: #6b7280;
        text-transform: uppercase;
    }
    .exp-card-progress {
        text-align: right;
        flex-shrink: 0;
        min-width: 80px;
    }
    .exp-card-progress-bar {
        height: 6px;
        width: 80px;
        background: #e5e7eb;
        border-radius: 3px;
        overflow: hidden;
        margin-bottom: 4px;
    }
    .exp-card-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #3b82f6, #60a5fa);
        border-radius: 3px;
        transition: width 0.3s ease;
    }
    .exp-card-progress-text {
        font-size: 12px;
        color: #6b7280;
    }

    /* =========================================================================
       Pagination Styles
       ========================================================================= */
    .exp-pagination {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding-top: 12px;
        border-top: 1px solid #e5e7eb;
    }
    .exp-pagination-info {
        font-size: 13px;
        color: #6b7280;
    }
    .exp-pagination-buttons {
        display: flex;
        gap: 4px;
    }
    .exp-pagination-btn {
        padding: 6px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        font-size: 13px;
        background: white;
        color: #374151;
        cursor: pointer;
        transition: all 0.15s ease;
    }
    .exp-pagination-btn:hover:not(:disabled) {
        border-color: #d1d5db;
        background: #f9fafb;
    }
    .exp-pagination-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .exp-pagination-btn.active {
        background: #f59e0b;
        border-color: #f59e0b;
        color: white;
    }

    /* =========================================================================
       Wizard Modal Styles (extending modals.css)
       ========================================================================= */

    /* Config Preview Panels */
    .config-preview-panel {
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 16px;
        margin-top: 12px;
        background: #f9fafb;
    }
    .config-preview-panel.feature {
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        border-color: #bae6fd;
    }
    .config-preview-panel.model {
        background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
        border-color: #e9d5ff;
    }
    .config-preview-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
    }
    .config-preview-name {
        font-weight: 600;
        font-size: 15px;
        color: #111827;
    }
    .config-preview-empty {
        text-align: center;
        padding: 24px;
        color: #9ca3af;
        font-size: 13px;
    }

    /* Tensor Preview in Wizard */
    .tensor-preview-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }
    .tensor-preview-item {
        padding: 12px;
        background: white;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
    }
    .tensor-preview-item.buyer {
        border-left: 3px solid #3b82f6;
    }
    .tensor-preview-item.product {
        border-left: 3px solid #10b981;
    }
    .tensor-preview-title {
        font-size: 12px;
        font-weight: 600;
        color: #6b7280;
        margin-bottom: 8px;
        text-transform: uppercase;
    }
    .tensor-preview-dim {
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 8px;
    }
    .tensor-preview-dim.buyer { color: #3b82f6; }
    .tensor-preview-dim.product { color: #10b981; }
    .tensor-preview-features {
        font-size: 12px;
        color: #6b7280;
        max-height: 80px;
        overflow-y: auto;
    }
    .tensor-preview-features div {
        padding: 2px 0;
    }

    /* Tensor Breakdown Bar */
    .tensor-breakdown-bar {
        display: flex;
        height: 24px;
        border-radius: 6px;
        overflow: hidden;
        background: #e5e7eb;
        margin-bottom: 8px;
    }
    .tensor-breakdown-segment {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: 500;
        color: white;
        transition: width 0.3s ease;
        overflow: hidden;
        white-space: nowrap;
    }

    /* Tower Preview in Wizard - Rich Visualization */
    .tower-visual {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }
    .tower-visual-aligned .tower-stack {
        display: flex;
        flex-direction: column;
    }
    .tower-visual-aligned .tower-column {
        display: flex;
        flex-direction: column;
    }
    .tower-visual-aligned .tower-stack {
        flex: 1;
    }
    .tower-column {
        min-width: 0;
    }
    .tower-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 6px;
    }
    .tower-label {
        font-size: 10px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #6b7280;
    }
    .tower-stack {
        display: flex;
        flex-direction: column;
        gap: 8px;
        border-radius: 10px;
        padding: 12px;
        border: 2px dashed;
    }
    .tower-stack.buyer {
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        border-color: #3b82f6;
    }
    .tower-stack.product {
        background: linear-gradient(135deg, #f0fdf4 0%, #d1fae5 100%);
        border-color: #10b981;
    }
    .tower-stack.ranking {
        background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
        border-color: #8b5cf6;
    }
    .card-layer-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 12px;
        background: white;
        border-radius: 8px;
        border: 1px solid rgba(0, 0, 0, 0.08);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
    }
    .tower-stack.buyer .card-layer-item {
        border-color: rgba(59, 130, 246, 0.2);
    }
    .tower-stack.product .card-layer-item {
        border-color: rgba(16, 185, 129, 0.2);
    }
    .tower-stack.ranking .card-layer-item {
        border-color: rgba(139, 92, 246, 0.2);
    }
    .card-layer-item.output-layer {
        border: 2px solid #f87171 !important;
    }
    .card-layer-item.empty-placeholder {
        background: transparent;
        border: 1px dashed rgba(0, 0, 0, 0.1);
        visibility: hidden;
    }
    .card-layer-item .card-drag-handle {
        color: #c4c4c4;
        font-size: 12px;
    }
    .card-layer-badge {
        display: inline-flex;
        align-items: center;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        flex-shrink: 0;
    }
    .card-layer-badge.dense {
        background: #e5e7eb;
        color: #374151;
    }
    .card-layer-badge.dropout {
        background: #fef3c7;
        color: #92400e;
    }
    .card-layer-badge.batch_norm {
        background: #d1fae5;
        color: #065f46;
    }
    .card-layer-badge.layer_norm {
        background: #e0e7ff;
        color: #3730a3;
    }
    .card-layer-params {
        flex: 1;
        font-size: 12px;
        color: #4b5563;
    }
    .tower-params-summary {
        margin: 8px 0 0 0;
        padding: 10px 12px;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 8px;
        border-top: 2px solid rgba(0, 0, 0, 0.1);
        font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
        font-size: 11px;
    }
    .tower-params-summary .params-row {
        display: flex;
        justify-content: space-between;
        color: #6b7280;
    }
    .tower-params-summary .params-row span:last-child {
        font-weight: 600;
        color: #374151;
    }

    /* Training Params Preview */
    .training-params-preview {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
    }
    .param-chip {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        background: #f3f4f6;
        border-radius: 6px;
        font-size: 12px;
    }
    .param-chip-label {
        color: #6b7280;
    }
    .param-chip-value {
        font-weight: 600;
        color: #374151;
    }
    .param-chip.retrieval-algo {
        background: #f5f3ff;
        border: 1px solid #e9d5ff;
    }
    .param-chip.retrieval-algo .param-chip-value {
        color: #7c3aed;
    }

    /* Sample Percent Buttons */
    .sample-btn {
        padding: 4px 10px;
        font-size: 12px;
        font-weight: 500;
        border: 1px solid #fcd34d;
        background: white;
        color: #92400e;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.15s ease;
    }
    .sample-btn:hover {
        background: #fef3c7;
        border-color: #f59e0b;
    }
    .sample-btn.active {
        background: #f59e0b;
        border-color: #d97706;
        color: white;
    }

    /* Training Params in Wizard Step 2 */
    .training-params-section {
        background: #fef3c7;
        border: 1px solid #fcd34d;
        border-radius: 10px;
        padding: 16px;
        margin-bottom: 16px;
    }
    .training-params-section h4 {
        font-size: 14px;
        font-weight: 600;
        color: #92400e;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .training-params-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }
    .training-param-group label {
        display: block;
        font-size: 12px;
        color: #92400e;
        margin-bottom: 4px;
    }
    .training-param-group select,
    .training-param-group input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #fcd34d;
        border-radius: 6px;
        font-size: 13px;
        background: white;
    }
    .training-param-group select:focus,
    .training-param-group input:focus {
        outline: none;
        border-color: #f59e0b;
        box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2);
    }

    /* Summary Section */
    .exp-summary-section {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 16px;
    }
    .exp-summary-row {
        display: flex;
        justify-content: space-between;
        padding: 6px 0;
        font-size: 13px;
    }
    .exp-summary-label {
        color: #6b7280;
    }
    .exp-summary-value {
        font-weight: 600;
        color: #374151;
    }

    /* =========================================================================
       Progress Modal Styles
       ========================================================================= */
    .quicktest-progress-bar {
        height: 24px;
        background: #e5e7eb;
        border-radius: 12px;
        overflow: hidden;
        position: relative;
    }
    .quicktest-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #3b82f6, #60a5fa);
        border-radius: 12px;
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .quicktest-progress-fill.animated {
        background: linear-gradient(90deg, #3b82f6, #60a5fa, #3b82f6);
        background-size: 200% 100%;
        animation: progress-shimmer 2s linear infinite;
    }
    @keyframes progress-shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
    .quicktest-progress-text {
        color: white;
        font-size: 12px;
        font-weight: 600;
    }
    .quicktest-stage {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        border-radius: 8px;
        margin-bottom: 8px;
        background: #f9fafb;
    }
    .quicktest-stage.completed { background: #ecfdf5; }
    .quicktest-stage.running { background: #eff6ff; }
    .quicktest-stage.failed { background: #fef2f2; }
    .quicktest-stage-icon {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
    }
    .quicktest-stage-icon.completed { color: #10b981; }
    .quicktest-stage-icon.running { color: #3b82f6; }
    .quicktest-stage-icon.failed { color: #ef4444; }
    .quicktest-stage-icon.pending { color: #9ca3af; }
    .quicktest-stage-name {
        flex: 1;
        font-weight: 500;
        color: #374151;
    }
    .quicktest-stage-duration {
        font-size: 12px;
        color: #6b7280;
    }

    /* Results Modal Metrics */
    .quicktest-metric {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #e5e7eb;
    }
    .quicktest-metric:last-child { border-bottom: none; }
    .quicktest-metric-label { color: #6b7280; }
    .quicktest-metric-value {
        font-weight: 600;
        color: #111827;
    }
</style>
{% endblock %}

{% block model_content %}
<div class="space-y-6">

    <!-- Quick Test Chapter -->
    <div class="chapter-section">
        <div class="chapter-header">
            <div class="chapter-icon quick-test">
                <i class="fas fa-bolt"></i>
            </div>
            <h2 class="chapter-title">Quick Test</h2>
            <div class="ml-auto flex gap-2">
                <button onclick="openCompareModal()" class="btn btn-secondary btn-sm" style="width: 120px;">
                    <i class="fas fa-columns mr-1"></i>Compare
                </button>
                <button onclick="openNewExpWizard()" class="btn btn-primary btn-sm" style="width: 120px;">
                    <i class="fas fa-plus mr-1"></i>New Exp
                </button>
            </div>
        </div>

        <!-- Filter Bar -->
        <div id="expFilterBar" class="exp-filter-bar hidden">
            <div class="exp-filter-group">
                <label class="exp-filter-label">Status:</label>
                <select id="expStatusFilter" class="exp-filter-select" onchange="filterExperiments()">
                    <option value="">All</option>
                    <option value="running">Running</option>
                    <option value="completed">Completed</option>
                    <option value="failed">Failed</option>
                    <option value="cancelled">Cancelled</option>
                </select>
            </div>
            <div class="exp-filter-group">
                <label class="exp-filter-label">Feature:</label>
                <select id="expFeatureFilter" class="exp-filter-select" onchange="filterExperiments()">
                    <option value="">All Features</option>
                </select>
            </div>
            <div class="exp-filter-group">
                <label class="exp-filter-label">Model:</label>
                <select id="expModelFilter" class="exp-filter-select" onchange="filterExperiments()">
                    <option value="">All Models</option>
                </select>
            </div>
            <input type="text" id="expSearchInput" class="exp-search-input"
                   placeholder="Search experiments..." onkeyup="debounceExpSearch()">
        </div>

        <!-- Content Area -->
        <div id="quickTestContent">
            <!-- Loading state -->
            <div id="expLoading" class="flex items-center justify-center py-8">
                <i class="fas fa-spinner fa-spin text-xl text-gray-400 mr-3"></i>
                <span class="text-gray-500">Loading experiments...</span>
            </div>

            <!-- Empty state (no experiments) -->
            <div id="expEmpty" class="chapter-empty-state hidden">
                <i class="fas fa-flask chapter-empty-icon"></i>
                <p class="chapter-empty-text">No experiments yet</p>
                <p class="text-sm text-gray-400 mt-2">Run your first experiment to test feature and model configurations</p>
                <button onclick="openNewExpWizard()" class="btn btn-primary btn-sm mt-4">
                    <i class="fas fa-plus mr-1"></i>New Experiment
                </button>
            </div>

            <!-- No configs state -->
            <div id="expNoConfigs" class="chapter-empty-state hidden">
                <i class="fas fa-exclamation-circle chapter-empty-icon"></i>
                <p class="chapter-empty-text">No configurations available</p>
                <p class="text-sm text-gray-400 mt-2">Create feature and model configs on the Configs page first</p>
                <a href="{% url 'model_configs' model.id %}" class="btn btn-primary btn-sm mt-4">
                    <i class="fas fa-arrow-left mr-1"></i>Go to Configs
                </a>
            </div>

            <!-- Experiments List -->
            <div id="expList" class="hidden">
                <div id="expCardsContainer" class="exp-cards-container">
                    <!-- Experiment cards rendered here by JavaScript -->
                </div>

                <!-- Pagination -->
                <div id="expPagination" class="exp-pagination hidden">
                    <div class="exp-pagination-info">
                        Showing <span id="expShowingStart">1</span>-<span id="expShowingEnd">10</span> of <span id="expTotalCount">0</span>
                    </div>
                    <div class="exp-pagination-buttons" id="expPaginationButtons">
                        <!-- Pagination buttons rendered by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- ============================================================================
     NEW EXPERIMENT WIZARD MODAL
     ============================================================================ -->
<div id="newExpWizardModal" class="modal-overlay hidden">
    <div class="modal-container modal-container-wizard" style="max-width: 800px;">
        <!-- Modal Header -->
        <div class="modal-header-wizard">
            <div class="modal-header-content">
                <div class="modal-header-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);">
                    <i class="fas fa-flask text-lg text-white"></i>
                </div>
                <div class="modal-header-info">
                    <h3 class="modal-header-title">New Experiment</h3>
                    <p class="modal-step-counter">Step <span id="wizardCurrentStep">1</span> of 2</p>
                </div>
            </div>
            <div class="progress-bar-pills">
                <div id="wizardProgress1" class="progress-step-pill current">Select Configs</div>
                <div id="wizardProgress2" class="progress-step-pill future">Training Params</div>
            </div>
        </div>

        <!-- Modal Body -->
        <div class="modal-body-wizard" style="max-height: calc(90vh - 200px); overflow-y: auto;">
            <!-- Step 1: Select Configurations -->
            <div id="wizardStep1" class="wizard-step active">
                <!-- Feature Config Selection -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Feature Config</label>
                    <select id="wizardFeatureSelect" class="w-64 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500" onchange="onWizardFeatureChange()">
                        <option value="">-- Select Feature Config --</option>
                    </select>
                </div>

                <!-- Feature Config Preview -->
                <div id="wizardFeaturePreview" class="config-preview-panel feature hidden">
                    <!-- Loading indicator -->
                    <div id="wizardFeatureLoading" class="text-center py-4 hidden">
                        <i class="fas fa-spinner fa-spin text-blue-500 text-xl"></i>
                        <p class="text-sm text-gray-500 mt-2">Loading feature config details...</p>
                    </div>
                    <!-- Content container -->
                    <div id="wizardFeatureContent">
                        <div class="mb-3">
                            <div class="text-sm text-gray-500">Dataset: <span class="font-medium text-gray-700" id="wizardFeatureDataset">-</span></div>
                        </div>
                        <!-- Dataset Source Info -->
                        <div id="wizardDatasetInfo"></div>
                        <!-- Tensor Breakdown Grid -->
                        <div class="grid grid-cols-2 gap-4">
                            <div class="p-4 bg-blue-50 rounded-lg">
                                <div class="flex items-center justify-between mb-3">
                                    <h4 class="font-semibold text-blue-800">Buyer Tensor</h4>
                                    <span class="font-semibold text-blue-600" id="wizardBuyerDim">0D</span>
                                </div>
                                <div id="wizardBuyerBar" class="tensor-breakdown-bar mb-3"></div>
                                <div id="wizardBuyerFeatures" class="space-y-1">
                                    <!-- Features listed here -->
                                </div>
                            </div>
                            <div class="p-4 bg-green-50 rounded-lg">
                                <div class="flex items-center justify-between mb-3">
                                    <h4 class="font-semibold text-green-800">Product Tensor</h4>
                                    <span class="font-semibold text-green-600" id="wizardProductDim">0D</span>
                                </div>
                                <div id="wizardProductBar" class="tensor-breakdown-bar mb-3"></div>
                                <div id="wizardProductFeatures" class="space-y-1">
                                    <!-- Features listed here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="wizardFeatureEmpty" class="config-preview-panel feature">
                    <div class="config-preview-empty">
                        <i class="fas fa-cube text-2xl mb-2"></i>
                        <p>Select a Feature Config to see details</p>
                    </div>
                </div>

                <!-- Model Config Selection -->
                <div class="mb-4 mt-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Model Config</label>
                    <select id="wizardModelSelect" class="w-64 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500" onchange="onWizardModelChange()">
                        <option value="">-- Select Model Config --</option>
                    </select>
                </div>

                <!-- Model Config Preview -->
                <div id="wizardModelPreview" class="config-preview-panel model hidden">
                    <!-- Loading indicator -->
                    <div id="wizardModelLoading" class="text-center py-4 hidden">
                        <i class="fas fa-spinner fa-spin text-purple-500 text-xl"></i>
                        <p class="text-sm text-gray-500 mt-2">Loading model config details...</p>
                    </div>
                    <!-- Content container -->
                    <div id="wizardModelContent">
                        <!-- Tower Architecture -->
                        <div class="mb-3">
                            <div class="tower-visual tower-visual-aligned">
                                <div class="tower-column">
                                    <div class="tower-header">
                                        <span class="tower-label">Buyer Tower</span>
                                    </div>
                                    <div id="wizardBuyerStack" class="tower-stack buyer">
                                        <!-- Layers will be inserted here -->
                                    </div>
                                    <div class="tower-params-summary" id="wizardBuyerParamsSummary">
                                        <div class="params-row"><span>Total params:</span><span id="wizardBuyerTotalParams">0</span></div>
                                        <div class="params-row"><span>Trainable params:</span><span id="wizardBuyerTrainableParams">0</span></div>
                                        <div class="params-row"><span>Non-trainable params:</span><span>0</span></div>
                                    </div>
                                </div>
                                <div class="tower-column">
                                    <div class="tower-header">
                                        <span class="tower-label">Product Tower</span>
                                    </div>
                                    <div id="wizardProductStack" class="tower-stack product">
                                        <!-- Layers will be inserted here -->
                                    </div>
                                    <div class="tower-params-summary" id="wizardProductParamsSummary">
                                        <div class="params-row"><span>Total params:</span><span id="wizardProductTotalParams">0</span></div>
                                        <div class="params-row"><span>Trainable params:</span><span id="wizardProductTrainableParams">0</span></div>
                                        <div class="params-row"><span>Non-trainable params:</span><span>0</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Training Parameters -->
                        <div class="mb-2">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Training Parameters</h4>
                            <div class="training-params-preview" id="wizardModelParams">
                                <!-- Will be populated dynamically -->
                            </div>
                        </div>

                        <!-- Retrieval Algorithm (for retrieval/multitask models) -->
                        <div id="wizardRetrievalSection" class="hidden">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Retrieval Algorithm</h4>
                            <div class="training-params-preview" id="wizardRetrievalParams">
                                <!-- Will be populated dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
                <div id="wizardModelEmpty" class="config-preview-panel model">
                    <div class="config-preview-empty">
                        <i class="fas fa-layer-group text-2xl mb-2"></i>
                        <p>Select a Model Config to see details</p>
                    </div>
                </div>
            </div>

            <!-- Step 2: Training Parameters -->
            <div id="wizardStep2" class="wizard-step">
                <!-- Data Sampling - Compact inline layout -->
                <div class="flex items-center gap-4 p-3 bg-amber-50 border border-amber-200 rounded-lg mb-4">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-database text-amber-600"></i>
                        <span class="text-sm font-medium text-amber-800">Sample:</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <button type="button" class="sample-btn" data-value="5" onclick="setSamplePercent(5)">5%</button>
                        <button type="button" class="sample-btn" data-value="10" onclick="setSamplePercent(10)">10%</button>
                        <button type="button" class="sample-btn" data-value="25" onclick="setSamplePercent(25)">25%</button>
                        <button type="button" class="sample-btn active" data-value="100" onclick="setSamplePercent(100)">100%</button>
                        <span class="text-gray-400 mx-1">or</span>
                        <input type="number" id="wizardSamplePercentInput" class="w-16 px-2 py-1 text-sm border border-amber-300 rounded text-center" value="100" min="1" max="100" onchange="onSampleInputChange()">
                        <span class="text-sm text-gray-500">%</span>
                    </div>
                    <div class="flex items-center gap-1 ml-auto">
                        <span class="text-amber-700 font-semibold" id="wizardExampleCountValue">--</span>
                        <span class="text-sm text-gray-500">examples</span>
                    </div>
                </div>

                <!-- Split Strategy -->
                <div class="training-params-section" style="background: #f5f3ff; border-color: #c4b5fd;">
                    <h4 style="color: #6d28d9;"><i class="fas fa-random"></i> Split Strategy</h4>
                    <!-- Main row: Strategy + conditional options -->
                    <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
                        <select id="wizardSplitStrategy" onchange="onWizardSplitChange()" style="border-color: #c4b5fd; padding: 8px 12px; border-radius: 6px; font-size: 13px; min-width: 160px;">
                            <option value="random">Random (fastest)</option>
                            <option value="time_holdout">Time Holdout</option>
                            <option value="strict_time">Strict Temporal</option>
                        </select>
                        <!-- Random split info -->
                        <div id="wizardRandomInfo" style="display: flex; align-items: center; gap: 6px;">
                            <span style="color: #7c3aed; font-size: 12px;"><i class="fas fa-info-circle mr-1"></i>Training 80% / Validation 20%</span>
                        </div>
                        <!-- Date column (inline, shown for time-based) -->
                        <div id="wizardDateColumnSection" style="display: none; align-items: center; gap: 8px;">
                            <span style="color: #6d28d9; font-size: 12px; white-space: nowrap;">on</span>
                            <select id="wizardDateColumn" style="border-color: #c4b5fd; padding: 8px 12px; border-radius: 6px; font-size: 13px; min-width: 200px;">
                                <option value="">Select date column...</option>
                            </select>
                        </div>
                        <!-- Holdout days (inline, shown for time_holdout) -->
                        <div id="wizardTimeOptions" style="display: none; align-items: center; gap: 6px;">
                            <span style="color: #6d28d9; font-size: 12px;">exclude last</span>
                            <input type="number" id="wizardHoldoutDays" value="1" min="1" max="30" style="border-color: #c4b5fd; width: 60px; padding: 6px 8px; border-radius: 6px; font-size: 13px; text-align: center;">
                            <span style="color: #6d28d9; font-size: 12px;">days</span>
                        </div>
                    </div>
                    <!-- Rolling window (second row, shown for strict_time) -->
                    <div id="wizardRollingWindowSection" style="display: none; margin-top: 10px; width: 100%;">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; width: 100%;">
                            <div style="background: white; padding: 8px 12px; border-radius: 6px; border: 1px solid #ede9fe; display: flex; align-items: center; justify-content: space-between;">
                                <span style="color: #9ca3af; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px;">Train</span>
                                <div style="display: flex; align-items: baseline; gap: 3px;">
                                    <input type="number" id="wizardTrainDays" value="60" min="7" max="365" style="border: none; width: 40px; font-size: 16px; background: transparent; font-weight: 600; color: #6d28d9; padding: 0; text-align: right;">
                                    <span style="color: #9ca3af; font-size: 11px;">days</span>
                                </div>
                            </div>
                            <div style="background: white; padding: 8px 12px; border-radius: 6px; border: 1px solid #ede9fe; display: flex; align-items: center; justify-content: space-between;">
                                <span style="color: #9ca3af; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px;">Validation</span>
                                <div style="display: flex; align-items: baseline; gap: 3px;">
                                    <input type="number" id="wizardValDays" value="7" min="1" max="30" style="border: none; width: 28px; font-size: 16px; background: transparent; font-weight: 600; color: #6d28d9; padding: 0; text-align: right;">
                                    <span style="color: #9ca3af; font-size: 11px;">days</span>
                                </div>
                            </div>
                            <div style="background: white; padding: 8px 12px; border-radius: 6px; border: 1px solid #ede9fe; display: flex; align-items: center; justify-content: space-between;">
                                <span style="color: #9ca3af; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px;">Test</span>
                                <div style="display: flex; align-items: baseline; gap: 3px;">
                                    <input type="number" id="wizardTestDays" value="7" min="1" max="30" style="border: none; width: 28px; font-size: 16px; background: transparent; font-weight: 600; color: #6d28d9; padding: 0; text-align: right;">
                                    <span style="color: #9ca3af; font-size: 11px;">days</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Training Parameters -->
                <div class="training-params-section" style="background: #eff6ff; border-color: #93c5fd;">
                    <h4 style="color: #1e40af;"><i class="fas fa-sliders-h"></i> Training Parameters</h4>
                    <div class="training-params-grid">
                        <div class="training-param-group">
                            <label style="color: #1e40af;">Epochs</label>
                            <select id="wizardEpochs" style="border-color: #93c5fd;">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="15">15</option>
                            </select>
                        </div>
                        <div class="training-param-group">
                            <label style="color: #1e40af;">Batch Size</label>
                            <select id="wizardBatchSize" style="border-color: #93c5fd;">
                                <option value="1024">1024</option>
                                <option value="2048">2048</option>
                                <option value="4096" selected>4096</option>
                                <option value="8192">8192</option>
                            </select>
                        </div>
                        <div class="training-param-group">
                            <label style="color: #1e40af;">Learning Rate</label>
                            <input type="number" id="wizardLearningRate" value="0.1" step="0.001" min="0.0001" max="1.0" style="border-color: #93c5fd;">
                        </div>
                    </div>
                </div>

                <!-- Rating Column (for Ranking models) -->
                <div id="wizardRatingSection" class="training-params-section hidden" style="background: #faf5ff; border-color: #d8b4fe;">
                    <h4 style="color: #7c3aed;"><i class="fas fa-star"></i> Rating Column</h4>
                    <p class="text-sm text-purple-600 mb-3">Ranking models require a numeric column containing ratings/scores.</p>
                    <div class="training-param-group">
                        <select id="wizardRatingColumn" style="border-color: #d8b4fe;">
                            <option value="">Select rating column...</option>
                        </select>
                    </div>
                </div>

                <!-- Summary -->
                <div class="exp-summary-section">
                    <h4 class="font-medium text-gray-700 mb-3">Summary</h4>
                    <div class="exp-summary-row">
                        <span class="exp-summary-label">Feature Config:</span>
                        <span class="exp-summary-value" id="wizardSummaryFeature">-</span>
                    </div>
                    <div class="exp-summary-row">
                        <span class="exp-summary-label">Model Config:</span>
                        <span class="exp-summary-value" id="wizardSummaryModel">-</span>
                    </div>
                    <div class="exp-summary-row">
                        <span class="exp-summary-label">Estimated duration:</span>
                        <span class="exp-summary-value">15-25 minutes</span>
                    </div>
                    <div class="exp-summary-row">
                        <span class="exp-summary-label">Machine type:</span>
                        <span class="exp-summary-value">n1-standard-4 (4 vCPU, 15GB RAM)</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="modal-footer-wizard-neu">
            <div class="footer-left">
                <button type="button" id="wizardBackBtn" class="btn-neu btn-neu-nav hidden" onclick="wizardBack()">
                    <span class="btn-neu-inner"><i class="fas fa-chevron-left"></i></span>
                </button>
                <button type="button" id="wizardNextBtn" class="btn-neu btn-neu-nav" onclick="wizardNext()">
                    <span class="btn-neu-inner"><i class="fas fa-chevron-right"></i></span>
                </button>
            </div>
            <div class="footer-right">
                <button type="button" id="wizardRunBtn" class="btn-neu btn-neu-action btn-neu-save hidden" onclick="submitExperiment()">
                    <span class="btn-neu-inner">Run</span>
                </button>
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeNewExpWizard()">
                    <span class="btn-neu-inner">Cancel</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ============================================================================
     PROGRESS MODAL
     ============================================================================ -->
<div id="expProgressModal" class="modal-overlay hidden">
    <div class="modal-container" style="max-width: 500px;">
        <div class="modal-header">
            <div class="modal-header-icon info">
                <i class="fas fa-cog fa-spin"></i>
            </div>
            <h3 class="modal-header-title">Experiment Running</h3>
        </div>
        <div class="modal-body">
            <p class="text-sm text-gray-600 mb-4">
                <span id="progressExpName" class="font-semibold"></span><br>
                <span class="text-gray-500" id="progressConfigs"></span>
            </p>

            <!-- Progress Bar -->
            <div class="quicktest-progress-bar mb-4">
                <div class="quicktest-progress-fill animated" id="progressBar" style="width: 0%">
                    <span class="quicktest-progress-text" id="progressText">0%</span>
                </div>
            </div>

            <!-- Pipeline Stages -->
            <h4 class="font-medium text-gray-900 mb-3">Pipeline Stages</h4>
            <div id="progressStages">
                <!-- Populated by JavaScript -->
            </div>

            <!-- Elapsed Time -->
            <div class="mt-4 text-sm text-gray-500">
                <span>Elapsed: </span>
                <span id="progressElapsed">0:00</span>
            </div>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-secondary" onclick="cancelExperiment()" id="progressCancelBtn">
                    <span class="btn-neu-inner"><i class="fas fa-stop mr-2"></i>Cancel</span>
                </button>
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeProgressModal()">
                    <span class="btn-neu-inner">Close</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ============================================================================
     RESULTS MODAL
     ============================================================================ -->
<div id="expResultsModal" class="modal-overlay hidden">
    <div class="modal-container" style="max-width: 600px;">
        <div class="modal-header">
            <div class="modal-header-icon" id="resultsStatusIcon">
                <i class="fas fa-check"></i>
            </div>
            <h3 class="modal-header-title">Experiment Results</h3>
            <button type="button" class="modal-close-btn" onclick="closeResultsModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p class="text-sm text-gray-600 mb-4">
                <span id="resultsExpName" class="font-semibold"></span><br>
                <span class="text-gray-500" id="resultsConfigs"></span>
            </p>

            <!-- Status Badge -->
            <div class="mb-4" id="resultsStatusBadge"></div>

            <!-- Metrics -->
            <h4 class="font-medium text-gray-900 mb-3">Training Metrics</h4>
            <div id="resultsMetrics" class="mb-4">
                <!-- Populated by JavaScript -->
            </div>

            <!-- Error Section (if failed) -->
            <div id="resultsErrorSection" class="hidden bg-red-50 rounded-lg p-4">
                <h4 class="font-medium text-red-900 mb-2">Error Details</h4>
                <p class="text-sm text-red-700" id="resultsErrorMessage"></p>
            </div>

            <!-- Duration -->
            <div class="mt-4 text-sm text-gray-500">
                Duration: <span id="resultsDuration">-</span>
            </div>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left">
                <a href="#" id="resultsVertexLink" target="_blank" class="text-sm text-blue-600 hover:text-blue-800">
                    <i class="fas fa-external-link-alt mr-1"></i>View in Vertex AI
                </a>
            </div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeResultsModal()">
                    <span class="btn-neu-inner">Close</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ============================================================================
     COMPARE MODAL (Placeholder)
     ============================================================================ -->
<div id="compareModal" class="modal-overlay hidden">
    <div class="modal-container" style="max-width: 500px;">
        <div class="modal-header">
            <div class="modal-header-icon info">
                <i class="fas fa-columns"></i>
            </div>
            <h3 class="modal-header-title">Compare Experiments</h3>
            <button type="button" class="modal-close-btn" onclick="closeCompareModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="chapter-empty-state">
                <i class="fas fa-chart-bar chapter-empty-icon"></i>
                <p class="chapter-empty-text">Comparison feature coming soon</p>
                <p class="text-sm text-gray-400 mt-2">Side-by-side experiment comparison will be available here</p>
            </div>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeCompareModal()">
                    <span class="btn-neu-inner">Close</span>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// =============================================================================
// STATE & CONSTANTS
// =============================================================================
const modelId = {{ model.id }};

// Data
let allFeatureConfigs = [];
let allModelConfigs = [];
let experiments = [];
let pagination = { page: 1, page_size: 10, total_count: 0, total_pages: 1 };

// Wizard state
let wizardStep = 1;
let selectedFeatureConfig = null;
let selectedModelConfig = null;
let datasetEstimatedRows = null;  // Estimated rows from selected feature config's dataset
let datasetDateDays = null;  // Number of days in dataset for split strategy calculations

// Polling
let currentExpId = null;
let pollInterval = null;
let searchDebounceTimer = null;

// Data type constants
const DATA_TYPES = {
    numeric: { label: 'Numeric', icon: 'hashtag' },
    text: { label: 'Text', icon: 'font' },
    temporal: { label: 'Temporal', icon: 'calendar' }
};

// =============================================================================
// FEATURE CONFIG HELPER FUNCTIONS
// =============================================================================

function getDataTypeLabel(dataType) {
    return DATA_TYPES[dataType]?.label || dataType;
}

function getDataTypeFromBqType(bqType) {
    const type = (bqType || 'STRING').toUpperCase();
    if (['INTEGER', 'INT64', 'FLOAT', 'FLOAT64', 'NUMERIC', 'BIGNUMERIC'].includes(type)) {
        return 'numeric';
    } else if (['TIMESTAMP', 'DATETIME', 'DATE', 'TIME'].includes(type)) {
        return 'temporal';
    } else {
        return 'text';
    }
}

function getFeatureDisplayInfo(feature) {
    const dataType = feature.data_type || getDataTypeFromBqType(feature.bq_type);
    const transforms = feature.transforms || {};
    let outputParts = [];
    let totalDim = 0;

    if (dataType === 'numeric') {
        if (transforms.normalize?.enabled) {
            outputParts.push('Norm: 1D');
            totalDim += 1;
        }
        if (transforms.bucketize?.enabled) {
            const dim = transforms.bucketize.embedding_dim || 32;
            outputParts.push(`Bucket: ${dim}D`);
            totalDim += dim;
        }
    } else if (dataType === 'text') {
        if (transforms.embedding?.enabled) {
            const dim = transforms.embedding.embedding_dim || 32;
            outputParts.push(`Embed: ${dim}D`);
            totalDim += dim;
        }
    } else if (dataType === 'temporal') {
        if (transforms.normalize?.enabled) {
            outputParts.push('Norm: 1D');
            totalDim += 1;
        }
        if (transforms.cyclical?.enabled) {
            const cyclical = transforms.cyclical;
            let cyclicalDim = 0;
            if (cyclical.yearly || cyclical.annual) cyclicalDim += 2;
            if (cyclical.quarterly) cyclicalDim += 2;
            if (cyclical.monthly) cyclicalDim += 2;
            if (cyclical.weekly) cyclicalDim += 2;
            if (cyclical.daily) cyclicalDim += 2;
            if (cyclicalDim > 0) {
                outputParts.push(`Cyclical: ${cyclicalDim}D`);
                totalDim += cyclicalDim;
            }
        }
        if (transforms.bucketize?.enabled) {
            const dim = transforms.bucketize.embedding_dim || 32;
            outputParts.push(`Bucket: ${dim}D`);
            totalDim += dim;
        }
    }

    return {
        dataTypeLabel: getDataTypeLabel(dataType),
        transformStr: outputParts.length > 0 ? outputParts.join(' + ') : 'No transform',
        totalDim,
        hasTransforms: outputParts.length > 0
    };
}

function getCrossFeatureNames(cross) {
    if (!cross.features || cross.features.length === 0) return [];
    if (typeof cross.features[0] === 'string') {
        return cross.features;
    }
    return cross.features.map(f => f.column);
}

function calculateTensorBreakdown(features, crosses) {
    const breakdown = [];
    let total = 0;

    (features || []).forEach(feature => {
        const info = getFeatureDisplayInfo(feature);
        if (info.totalDim > 0) {
            breakdown.push({ name: feature.column, dim: info.totalDim });
            total += info.totalDim;
        }
    });

    (crosses || []).forEach(cross => {
        const dim = cross.embedding_dim || 16;
        const featureNames = getCrossFeatureNames(cross);
        const name = featureNames.join('  ');
        breakdown.push({ name: name, dim: dim, is_cross: true });
        total += dim;
    });

    return { total, breakdown };
}

function buildDatasetInfoHtml(info, datasetName) {
    if (!info || !info.primary_table) {
        return '';
    }

    const tables = [info.primary_table + ' (primary)'];
    (info.secondary_tables || []).forEach(t => {
        if (t) tables.push(t);
    });
    const tablesLine = tables.join(' &bull; ');

    const filterBadges = [];
    if (info.filters?.dates) filterBadges.push(info.filters.dates);
    if (info.filters?.customers) filterBadges.push(info.filters.customers);
    if (info.filters?.products) filterBadges.push(info.filters.products);
    const filtersLine = filterBadges.length > 0
        ? filterBadges.join(' &bull; ')
        : '<span class="text-gray-400 italic">No filters</span>';

    const rowsBadge = info.estimated_rows
        ? `${info.estimated_rows.toLocaleString()} rows`
        : '';

    return `
        <div class="mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <div class="flex items-center justify-between mb-3">
                <h4 class="font-semibold text-gray-700">
                    <i class="fas fa-database mr-2 text-gray-400"></i>Dataset Source
                </h4>
                ${rowsBadge ? `<span class="text-sm font-medium text-gray-500 bg-white px-2 py-1 rounded border border-gray-200">${rowsBadge}</span>` : ''}
            </div>
            <div class="space-y-2 text-sm">
                <div class="flex">
                    <span class="text-gray-500 w-16 flex-shrink-0">Tables:</span>
                    <span class="text-gray-700">${tablesLine}</span>
                </div>
                <div class="flex">
                    <span class="text-gray-500 w-16 flex-shrink-0">Filters:</span>
                    <span class="text-gray-700">${filtersLine}</span>
                </div>
            </div>
        </div>
    `;
}

function renderWizardTensorPreview(model, total, breakdown, barContainer, maxTotal = null) {
    barContainer.innerHTML = '';
    if (!breakdown || breakdown.length === 0) return;

    if (maxTotal && maxTotal > 0) {
        const widthPercent = (total / maxTotal) * 100;
        barContainer.style.width = `${widthPercent}%`;
    } else {
        barContainer.style.width = '100%';
    }

    const colors = model === 'buyer'
        ? ['#3b82f6', '#60a5fa', '#93c5fd', '#bfdbfe', '#dbeafe']
        : ['#10b981', '#34d399', '#6ee7b7', '#a7f3d0', '#d1fae5'];

    breakdown.forEach((item, idx) => {
        const pct = (item.dim / total) * 100;
        const color = colors[idx % colors.length];

        const segment = document.createElement('div');
        segment.className = 'tensor-breakdown-segment';
        segment.style.width = `${pct}%`;
        segment.style.backgroundColor = color;
        segment.title = `${item.name}: ${item.dim}D`;
        if (pct > 10) {
            segment.textContent = item.dim;
        }
        barContainer.appendChild(segment);
    });
}

// =============================================================================
// MODEL CONFIG HELPER FUNCTIONS
// =============================================================================

function renderCardTowerLayers(buyerLayers, productLayers) {
    const maxLen = Math.max(buyerLayers.length, productLayers.length);
    if (maxLen === 0) {
        return {
            buyer: '<div class="text-xs text-gray-400 italic p-2">No layers</div>',
            product: '<div class="text-xs text-gray-400 italic p-2">No layers</div>'
        };
    }

    const renderLayer = (layer, isOutput) => {
        let badge = '';
        let params = '';

        if (layer.type === 'dense') {
            badge = '<span class="card-layer-badge dense">Dense</span>';
            params = `${layer.units} units`;
            if (layer.activation) params += `, ${layer.activation}`;
            if (layer.l2_regularization) params += `, L2=${layer.l2_regularization}`;
            else if (layer.l2_reg) params += `, L2=${layer.l2_reg}`;
        } else if (layer.type === 'dropout') {
            badge = '<span class="card-layer-badge dropout">Dropout</span>';
            params = `rate: ${layer.rate}`;
        } else if (layer.type === 'batch_norm') {
            badge = '<span class="card-layer-badge batch_norm">BatchNorm</span>';
            params = '';
        } else if (layer.type === 'layer_norm') {
            badge = '<span class="card-layer-badge layer_norm">LayerNorm</span>';
            params = layer.epsilon ? `: ${layer.epsilon}` : '';
        }

        return `
            <div class="card-layer-item${isOutput ? ' output-layer' : ''}">
                <span class="card-drag-handle"><i class="fas fa-grip-vertical"></i></span>
                ${badge}
                <span class="card-layer-params">${params}</span>
            </div>
        `;
    };

    const renderPlaceholder = () => '<div class="card-layer-item empty-placeholder">&nbsp;</div>';

    const buildTowerHtml = (layers, placeholderCount) => {
        if (layers.length === 0) return '';

        const result = [];
        for (let i = 0; i < layers.length - 1; i++) {
            result.push(renderLayer(layers[i], false));
        }
        for (let i = 0; i < placeholderCount; i++) {
            result.push(renderPlaceholder());
        }
        result.push(renderLayer(layers[layers.length - 1], true));

        return result.join('');
    };

    const buyerPlaceholders = maxLen - buyerLayers.length;
    const productPlaceholders = maxLen - productLayers.length;

    return {
        buyer: buildTowerHtml(buyerLayers, buyerPlaceholders),
        product: buildTowerHtml(productLayers, productPlaceholders)
    };
}

function calculateSingleTowerParams(layers, inputDim = 100) {
    let params = 0;
    let prevDim = inputDim;
    for (const layer of layers) {
        if (layer.type === 'dense') {
            params += prevDim * layer.units + layer.units;
            prevDim = layer.units;
        } else if (layer.type === 'batch_norm') {
            params += prevDim * 4;
        } else if (layer.type === 'layer_norm') {
            params += prevDim * 2;
        }
    }
    return params;
}

// =============================================================================
// INITIALIZATION
// =============================================================================
document.addEventListener('DOMContentLoaded', function() {
    loadInitialData();
});

async function loadInitialData() {
    try {
        // Load Feature Configs, Model Configs, and Experiments in parallel
        const [fcResponse, mcResponse, expResponse] = await Promise.all([
            fetch(`/api/models/${modelId}/feature-configs/`),
            fetch('/api/model-configs/'),
            fetch('/api/quick-tests/?page=1&page_size=10')
        ]);

        const fcData = await fcResponse.json();
        const mcData = await mcResponse.json();
        const expData = await expResponse.json();

        if (fcData.success) {
            allFeatureConfigs = fcData.data.filter(c => c.has_transform_code);
        }
        if (mcData.success) {
            allModelConfigs = mcData.data;
        }

        // Hide loading
        document.getElementById('expLoading').classList.add('hidden');

        // Check if we have configs
        if (allFeatureConfigs.length === 0 || allModelConfigs.length === 0) {
            document.getElementById('expNoConfigs').classList.remove('hidden');
            return;
        }

        // Populate filter dropdowns
        populateFilterDropdowns();

        // Show experiments or empty state
        if (expData.success) {
            experiments = expData.quick_tests;
            pagination = expData.pagination;

            if (experiments.length === 0) {
                document.getElementById('expEmpty').classList.remove('hidden');
            } else {
                document.getElementById('expFilterBar').classList.remove('hidden');
                document.getElementById('expList').classList.remove('hidden');
                renderExperiments();
                startBackgroundPolling();
            }
        } else {
            // API failed (e.g., no model endpoint) - show empty state
            console.warn('Experiments API error:', expData.error);
            document.getElementById('expEmpty').classList.remove('hidden');
        }

    } catch (error) {
        console.error('Failed to load initial data:', error);
        document.getElementById('expLoading').classList.add('hidden');
        showError('Failed to load data: ' + error.message);
    }
}

function populateFilterDropdowns() {
    // Feature Config filter
    const featureFilter = document.getElementById('expFeatureFilter');
    allFeatureConfigs.forEach(fc => {
        const option = document.createElement('option');
        option.value = fc.id;
        option.textContent = fc.name;
        featureFilter.appendChild(option);
    });

    // Model Config filter
    const modelFilter = document.getElementById('expModelFilter');
    allModelConfigs.forEach(mc => {
        const option = document.createElement('option');
        option.value = mc.id;
        option.textContent = mc.name;
        modelFilter.appendChild(option);
    });
}

// =============================================================================
// EXPERIMENTS LIST
// =============================================================================
function renderExperiments() {
    const container = document.getElementById('expCardsContainer');

    if (experiments.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <i class="fas fa-search text-2xl mb-2"></i>
                <p>No experiments match your filters</p>
            </div>
        `;
        document.getElementById('expPagination').classList.add('hidden');
        return;
    }

    container.innerHTML = experiments.map(exp => renderExpCard(exp)).join('');
    renderPagination();
}

function renderExpCard(exp) {
    const statusIcons = {
        'submitting': 'fa-clock',
        'running': 'fa-spinner fa-spin',
        'completed': 'fa-check',
        'failed': 'fa-times',
        'cancelled': 'fa-ban'
    };

    const statusClass = exp.status === 'submitting' ? 'submitting' : exp.status;
    const icon = statusIcons[exp.status] || 'fa-clock';

    // Format time
    const createdAt = new Date(exp.created_at);
    const timeAgo = formatTimeAgo(createdAt);

    // Build metric or progress display
    let metricHtml = '';
    if (exp.status === 'completed' && exp.recall_at_100 != null) {
        metricHtml = `
            <div class="exp-card-metric">
                <div class="exp-card-metric-value">${(exp.recall_at_100 * 100).toFixed(1)}%</div>
                <div class="exp-card-metric-label">Recall@100</div>
            </div>
        `;
    } else if (exp.status === 'running' || exp.status === 'submitting') {
        metricHtml = `
            <div class="exp-card-progress">
                <div class="exp-card-progress-bar">
                    <div class="exp-card-progress-fill" style="width: ${exp.progress_percent || 0}%"></div>
                </div>
                <div class="exp-card-progress-text">${exp.progress_percent || 0}%</div>
            </div>
        `;
    } else if (exp.status === 'failed') {
        metricHtml = `
            <div class="exp-card-metric">
                <div class="exp-card-metric-value text-red-600">Failed</div>
                <div class="exp-card-metric-label">${exp.current_stage || ''}</div>
            </div>
        `;
    } else {
        metricHtml = `
            <div class="exp-card-metric">
                <div class="exp-card-metric-value text-gray-400">-</div>
            </div>
        `;
    }

    // Duration or elapsed
    let durationText = timeAgo;
    if (exp.status === 'completed' && exp.duration_seconds) {
        durationText = `Completed ${timeAgo}  ${formatDuration(exp.duration_seconds)}`;
    } else if (exp.status === 'running' && exp.elapsed_seconds) {
        durationText = `Started ${timeAgo}  Running ${formatDuration(exp.elapsed_seconds)}`;
    } else if (exp.status === 'failed') {
        durationText = `Failed ${timeAgo}`;
    }

    return `
        <div class="exp-card" onclick="openExpDetails(${exp.id})" data-exp-id="${exp.id}">
            <div class="exp-card-status ${statusClass}">
                <i class="fas ${icon}"></i>
            </div>
            <div class="exp-card-info">
                <div class="exp-card-name">${exp.display_name}</div>
                <div class="exp-card-configs">${exp.feature_config_name} + ${exp.model_config_name}</div>
                <div class="exp-card-meta">${durationText}</div>
            </div>
            ${metricHtml}
        </div>
    `;
}

function renderPagination() {
    if (pagination.total_pages <= 1) {
        document.getElementById('expPagination').classList.add('hidden');
        return;
    }

    document.getElementById('expPagination').classList.remove('hidden');

    const start = (pagination.page - 1) * pagination.page_size + 1;
    const end = Math.min(pagination.page * pagination.page_size, pagination.total_count);

    document.getElementById('expShowingStart').textContent = start;
    document.getElementById('expShowingEnd').textContent = end;
    document.getElementById('expTotalCount').textContent = pagination.total_count;

    // Generate page buttons
    const buttonsContainer = document.getElementById('expPaginationButtons');
    let buttonsHtml = '';

    // Prev button
    buttonsHtml += `
        <button class="exp-pagination-btn" onclick="goToPage(${pagination.page - 1})" ${!pagination.has_prev ? 'disabled' : ''}>
            <i class="fas fa-chevron-left"></i>
        </button>
    `;

    // Page numbers (show max 5)
    const maxButtons = 5;
    let startPage = Math.max(1, pagination.page - Math.floor(maxButtons / 2));
    let endPage = Math.min(pagination.total_pages, startPage + maxButtons - 1);
    startPage = Math.max(1, endPage - maxButtons + 1);

    for (let i = startPage; i <= endPage; i++) {
        buttonsHtml += `
            <button class="exp-pagination-btn ${i === pagination.page ? 'active' : ''}" onclick="goToPage(${i})">
                ${i}
            </button>
        `;
    }

    // Next button
    buttonsHtml += `
        <button class="exp-pagination-btn" onclick="goToPage(${pagination.page + 1})" ${!pagination.has_next ? 'disabled' : ''}>
            <i class="fas fa-chevron-right"></i>
        </button>
    `;

    buttonsContainer.innerHTML = buttonsHtml;
}

async function goToPage(page) {
    if (page < 1 || page > pagination.total_pages) return;
    await loadExperiments(page);
}

async function loadExperiments(page = 1) {
    const status = document.getElementById('expStatusFilter').value;
    const featureConfigId = document.getElementById('expFeatureFilter').value;
    const modelConfigId = document.getElementById('expModelFilter').value;
    const search = document.getElementById('expSearchInput').value.trim();

    let url = `/api/quick-tests/?page=${page}&page_size=${pagination.page_size}`;
    if (status) url += `&status=${status}`;
    if (featureConfigId) url += `&feature_config_id=${featureConfigId}`;
    if (modelConfigId) url += `&model_config_id=${modelConfigId}`;
    if (search) url += `&search=${encodeURIComponent(search)}`;

    try {
        const response = await fetch(url);
        const data = await response.json();

        if (data.success) {
            experiments = data.quick_tests;
            pagination = data.pagination;
            renderExperiments();
        }
    } catch (error) {
        console.error('Error loading experiments:', error);
    }
}

function filterExperiments() {
    loadExperiments(1);
}

function debounceExpSearch() {
    clearTimeout(searchDebounceTimer);
    searchDebounceTimer = setTimeout(() => filterExperiments(), 300);
}

// =============================================================================
// WIZARD MODAL
// =============================================================================
function openNewExpWizard() {
    // Reset wizard state
    wizardStep = 1;
    selectedFeatureConfig = null;
    selectedModelConfig = null;

    // Populate dropdowns
    populateWizardDropdowns();

    // Reset UI
    updateWizardUI();
    document.getElementById('wizardFeatureSelect').value = '';
    document.getElementById('wizardModelSelect').value = '';
    document.getElementById('wizardFeaturePreview').classList.add('hidden');
    document.getElementById('wizardFeatureEmpty').classList.remove('hidden');
    document.getElementById('wizardModelPreview').classList.add('hidden');
    document.getElementById('wizardModelEmpty').classList.remove('hidden');

    // Reset training params
    document.getElementById('wizardSplitStrategy').value = 'random';
    document.getElementById('wizardSamplePercentInput').value = '100';
    document.querySelectorAll('.sample-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.value === '100');
    });
    document.getElementById('wizardEpochs').value = '10';
    document.getElementById('wizardBatchSize').value = '4096';
    document.getElementById('wizardLearningRate').value = '0.1';
    // Reset split strategy UI (use style.display for inline-styled elements)
    document.getElementById('wizardRandomInfo').style.display = 'flex';
    document.getElementById('wizardTimeOptions').style.display = 'none';
    document.getElementById('wizardDateColumnSection').style.display = 'none';
    document.getElementById('wizardRollingWindowSection').style.display = 'none';
    document.getElementById('wizardRatingSection').classList.add('hidden');
    // Reset rolling window values
    document.getElementById('wizardTrainDays').value = '60';
    document.getElementById('wizardValDays').value = '7';
    document.getElementById('wizardTestDays').value = '7';

    // Reset example count
    datasetEstimatedRows = null;
    document.getElementById('wizardExampleCountValue').textContent = '--';

    document.getElementById('newExpWizardModal').classList.remove('hidden');
}

function closeNewExpWizard() {
    document.getElementById('newExpWizardModal').classList.add('hidden');
}

function populateWizardDropdowns() {
    // Feature Config dropdown
    const fcSelect = document.getElementById('wizardFeatureSelect');
    fcSelect.innerHTML = '<option value="">-- Select Feature Config --</option>';

    // Group by dataset
    const byDataset = {};
    allFeatureConfigs.forEach(fc => {
        const dsName = fc.dataset_name || 'Unknown Dataset';
        if (!byDataset[dsName]) byDataset[dsName] = [];
        byDataset[dsName].push(fc);
    });

    Object.entries(byDataset).forEach(([dsName, configs]) => {
        const optgroup = document.createElement('optgroup');
        optgroup.label = dsName;
        configs.forEach(fc => {
            const option = document.createElement('option');
            option.value = fc.id;
            option.textContent = fc.name;
            optgroup.appendChild(option);
        });
        fcSelect.appendChild(optgroup);
    });

    // Model Config dropdown
    const mcSelect = document.getElementById('wizardModelSelect');
    mcSelect.innerHTML = '<option value="">-- Select Model Config --</option>';

    allModelConfigs.forEach(mc => {
        const option = document.createElement('option');
        option.value = mc.id;
        option.textContent = mc.name;
        mcSelect.appendChild(option);
    });
}

function onWizardFeatureChange() {
    const fcId = parseInt(document.getElementById('wizardFeatureSelect').value);
    selectedFeatureConfig = allFeatureConfigs.find(fc => fc.id === fcId) || null;

    if (selectedFeatureConfig) {
        // Show preview panel with loading state
        document.getElementById('wizardFeatureEmpty').classList.add('hidden');
        document.getElementById('wizardFeaturePreview').classList.remove('hidden');
        document.getElementById('wizardFeatureLoading').classList.remove('hidden');
        document.getElementById('wizardFeatureContent').classList.add('hidden');

        // Fetch full feature config details
        fetch(`/api/feature-configs/${fcId}/`)
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    renderWizardFeaturePreview(data.data);
                }
            })
            .catch(err => {
                console.error('Error loading feature config:', err);
            })
            .finally(() => {
                document.getElementById('wizardFeatureLoading').classList.add('hidden');
                document.getElementById('wizardFeatureContent').classList.remove('hidden');
            });

        // Load date columns for time-based split
        loadWizardDateColumns(selectedFeatureConfig.dataset_id);
    } else {
        document.getElementById('wizardFeaturePreview').classList.add('hidden');
        document.getElementById('wizardFeatureEmpty').classList.remove('hidden');
    }

    updateWizardSummary();
}

function renderWizardFeaturePreview(config) {
    // Update dataset name
    document.getElementById('wizardFeatureDataset').textContent = config.dataset_name || '-';

    // Build and insert dataset info HTML
    const datasetInfoHtml = buildDatasetInfoHtml(config.dataset_info, config.dataset_name);
    document.getElementById('wizardDatasetInfo').innerHTML = datasetInfoHtml;

    // Calculate tensor breakdowns
    const buyerResult = calculateTensorBreakdown(
        config.buyer_model_features || [],
        config.buyer_model_crosses || []
    );
    const productResult = calculateTensorBreakdown(
        config.product_model_features || [],
        config.product_model_crosses || []
    );

    // Update tensor dimensions
    document.getElementById('wizardBuyerDim').textContent = `${buyerResult.total}D`;
    document.getElementById('wizardProductDim').textContent = `${productResult.total}D`;

    // Render feature lists
    const buyerFeaturesHtml = buyerResult.breakdown.map(item => `
        <div class="flex items-center justify-between text-sm">
            <span class="${item.is_cross ? 'text-blue-600 italic' : 'text-blue-700'}">${item.name}</span>
            <span class="text-blue-500 font-medium">${item.dim}D</span>
        </div>
    `).join('');
    document.getElementById('wizardBuyerFeatures').innerHTML = buyerFeaturesHtml || '<div class="text-sm text-gray-400">No features</div>';

    const productFeaturesHtml = productResult.breakdown.map(item => `
        <div class="flex items-center justify-between text-sm">
            <span class="${item.is_cross ? 'text-green-600 italic' : 'text-green-700'}">${item.name}</span>
            <span class="text-green-500 font-medium">${item.dim}D</span>
        </div>
    `).join('');
    document.getElementById('wizardProductFeatures').innerHTML = productFeaturesHtml || '<div class="text-sm text-gray-400">No features</div>';

    // Render tensor bars with proportional widths
    const maxTotal = Math.max(buyerResult.total || 0, productResult.total || 0);

    setTimeout(() => {
        const buyerBar = document.getElementById('wizardBuyerBar');
        const productBar = document.getElementById('wizardProductBar');
        if (buyerBar && buyerResult.breakdown.length > 0) {
            renderWizardTensorPreview('buyer', buyerResult.total, buyerResult.breakdown, buyerBar, maxTotal);
        }
        if (productBar && productResult.breakdown.length > 0) {
            renderWizardTensorPreview('product', productResult.total, productResult.breakdown, productBar, maxTotal);
        }
    }, 0);

    // Store estimated rows for example count calculation
    datasetEstimatedRows = config.dataset_info?.estimated_rows || null;
    // Store date days for split strategy calculations
    datasetDateDays = config.dataset_info?.date_days || null;
    updateExampleCount();
}

function updateExampleCount() {
    const samplePercent = parseInt(document.getElementById('wizardSamplePercentInput').value) || 100;
    const countEl = document.getElementById('wizardExampleCountValue');

    if (datasetEstimatedRows && datasetEstimatedRows > 0) {
        const estimatedExamples = Math.round(datasetEstimatedRows * samplePercent / 100);
        countEl.textContent = `~${estimatedExamples.toLocaleString()}`;
    } else {
        countEl.textContent = '--';
    }
}

function setSamplePercent(value) {
    // Update input
    document.getElementById('wizardSamplePercentInput').value = value;

    // Update button states
    document.querySelectorAll('.sample-btn').forEach(btn => {
        btn.classList.toggle('active', parseInt(btn.dataset.value) === value);
    });

    updateExampleCount();
}

function onSampleInputChange() {
    let value = parseInt(document.getElementById('wizardSamplePercentInput').value) || 100;

    // Clamp to valid range
    value = Math.max(1, Math.min(100, value));
    document.getElementById('wizardSamplePercentInput').value = value;

    // Update button states (deactivate all if custom value)
    const presetValues = [5, 10, 25, 100];
    document.querySelectorAll('.sample-btn').forEach(btn => {
        btn.classList.toggle('active', parseInt(btn.dataset.value) === value && presetValues.includes(value));
    });

    updateExampleCount();
}

function onWizardModelChange() {
    const mcId = parseInt(document.getElementById('wizardModelSelect').value);
    selectedModelConfig = allModelConfigs.find(mc => mc.id === mcId) || null;

    if (selectedModelConfig) {
        // Show preview panel with loading state
        document.getElementById('wizardModelEmpty').classList.add('hidden');
        document.getElementById('wizardModelPreview').classList.remove('hidden');
        document.getElementById('wizardModelLoading').classList.remove('hidden');
        document.getElementById('wizardModelContent').classList.add('hidden');

        // Fetch full model config details
        fetch(`/api/model-configs/${mcId}/`)
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    renderWizardModelPreview(data.data);
                }
            })
            .catch(err => {
                console.error('Error loading model config:', err);
            })
            .finally(() => {
                document.getElementById('wizardModelLoading').classList.add('hidden');
                document.getElementById('wizardModelContent').classList.remove('hidden');
            });

        // Update training params from model config
        document.getElementById('wizardLearningRate').value = selectedModelConfig.learning_rate;
        document.getElementById('wizardBatchSize').value = selectedModelConfig.batch_size;

        // Show rating column section for ranking models
        if (selectedModelConfig.model_type === 'ranking' || selectedModelConfig.model_type === 'multitask') {
            document.getElementById('wizardRatingSection').classList.remove('hidden');
            if (selectedFeatureConfig) {
                loadWizardRatingColumns(selectedFeatureConfig.dataset_id);
            }
        } else {
            document.getElementById('wizardRatingSection').classList.add('hidden');
        }
    } else {
        document.getElementById('wizardModelPreview').classList.add('hidden');
        document.getElementById('wizardModelEmpty').classList.remove('hidden');
    }

    updateWizardSummary();
}

function renderWizardModelPreview(mc) {
    // Tower stacks - use detailed visualization with aligned layers
    const buyerLayers = mc.buyer_tower_layers || [];
    const productLayers = mc.product_tower_layers || [];
    const towerHtml = renderCardTowerLayers(buyerLayers, productLayers);

    document.getElementById('wizardBuyerStack').innerHTML = towerHtml.buyer;
    document.getElementById('wizardProductStack').innerHTML = towerHtml.product;

    // Per-tower parameter summaries
    const buyerParams = calculateSingleTowerParams(buyerLayers);
    const productParams = calculateSingleTowerParams(productLayers);
    document.getElementById('wizardBuyerTotalParams').textContent = buyerParams.toLocaleString();
    document.getElementById('wizardBuyerTrainableParams').textContent = buyerParams.toLocaleString();
    document.getElementById('wizardProductTotalParams').textContent = productParams.toLocaleString();
    document.getElementById('wizardProductTrainableParams').textContent = productParams.toLocaleString();

    // Training parameters
    document.getElementById('wizardModelParams').innerHTML = `
        <div class="param-chip">
            <span class="param-chip-label">Optimizer:</span>
            <span class="param-chip-value">${mc.optimizer_display || mc.optimizer}</span>
        </div>
        <div class="param-chip">
            <span class="param-chip-label">Learning Rate:</span>
            <span class="param-chip-value">${mc.learning_rate}</span>
        </div>
        <div class="param-chip">
            <span class="param-chip-label">Batch Size:</span>
            <span class="param-chip-value">${mc.batch_size}</span>
        </div>
        <div class="param-chip">
            <span class="param-chip-label">Output Dim:</span>
            <span class="param-chip-value">${mc.output_embedding_dim || 32}D</span>
        </div>
    `;

    // Retrieval algorithm section (for retrieval and multitask models)
    const retrievalSection = document.getElementById('wizardRetrievalSection');
    if (['retrieval', 'multitask'].includes(mc.model_type)) {
        retrievalSection.classList.remove('hidden');
        document.getElementById('wizardRetrievalParams').innerHTML = `
            <div class="param-chip retrieval-algo">
                <span class="param-chip-label">Algorithm:</span>
                <span class="param-chip-value">${mc.retrieval_algorithm_display || 'Brute Force'}</span>
            </div>
            <div class="param-chip">
                <span class="param-chip-label">Top-K:</span>
                <span class="param-chip-value">${mc.top_k || 100}</span>
            </div>
            ${mc.retrieval_algorithm === 'scann' ? `
            <div class="param-chip">
                <span class="param-chip-label">Num Leaves:</span>
                <span class="param-chip-value">${mc.scann_num_leaves || 100}</span>
            </div>
            <div class="param-chip">
                <span class="param-chip-label">Leaves to Search:</span>
                <span class="param-chip-value">${mc.scann_leaves_to_search || 10}</span>
            </div>
            ` : ''}
        `;
    } else {
        retrievalSection.classList.add('hidden');
    }
}

function onWizardSplitChange() {
    const strategy = document.getElementById('wizardSplitStrategy').value;
    const isTimeBased = strategy === 'time_holdout' || strategy === 'strict_time';
    const isStrictTime = strategy === 'strict_time';
    const isTimeHoldout = strategy === 'time_holdout';
    const isRandom = strategy === 'random';

    // Random info - only for random
    document.getElementById('wizardRandomInfo').style.display = isRandom ? 'flex' : 'none';

    // Date column - required for both time-based strategies
    document.getElementById('wizardDateColumnSection').style.display = isTimeBased ? 'flex' : 'none';

    // Holdout days - only for time_holdout
    document.getElementById('wizardTimeOptions').style.display = isTimeHoldout ? 'flex' : 'none';

    // Rolling window - only for strict_time
    document.getElementById('wizardRollingWindowSection').style.display = isStrictTime ? 'block' : 'none';

    // Set dynamic defaults for strict temporal split based on dataset date range
    if (isStrictTime && datasetDateDays && datasetDateDays > 0) {
        // Split ratios: Train 80%, Validation 15%, Test 5%
        const trainDays = Math.max(1, Math.floor(datasetDateDays * 0.80));
        const valDays = Math.max(1, Math.floor(datasetDateDays * 0.15));
        const testDays = Math.max(1, datasetDateDays - trainDays - valDays);

        document.getElementById('wizardTrainDays').value = trainDays;
        document.getElementById('wizardValDays').value = valDays;
        document.getElementById('wizardTestDays').value = testDays;
    }
}

async function loadWizardDateColumns(datasetId) {
    if (!datasetId) return;

    try {
        const response = await fetch(`/api/datasets/${datasetId}/date-columns/`);
        const data = await response.json();

        const select = document.getElementById('wizardDateColumn');
        select.innerHTML = '<option value="">Select date column...</option>';

        if (data.success && data.date_columns) {
            let primaryColumn = null;
            data.date_columns.forEach(col => {
                const option = document.createElement('option');
                option.value = col.name;
                // Show (recommended) for primary date column from dataset config
                const label = col.primary
                    ? `${col.name} (${col.type}) - recommended`
                    : `${col.name} (${col.type})`;
                option.textContent = label;
                select.appendChild(option);

                // Track primary for auto-selection
                if (col.primary) {
                    primaryColumn = col.name;
                }
            });

            // Auto-select the primary date column if available
            if (primaryColumn) {
                select.value = primaryColumn;
            }
        }
    } catch (error) {
        console.error('Error loading date columns:', error);
    }
}

async function loadWizardRatingColumns(datasetId) {
    if (!datasetId) return;

    try {
        const response = await fetch(`/api/datasets/${datasetId}/columns/`);
        const data = await response.json();

        const select = document.getElementById('wizardRatingColumn');
        select.innerHTML = '<option value="">Select rating column...</option>';

        if (data.success && data.data && data.data.columns) {
            const numericCols = data.data.columns.filter(col =>
                col.dtype.includes('int') || col.dtype.includes('float')
            );
            numericCols.forEach(col => {
                const option = document.createElement('option');
                option.value = col.name;
                option.textContent = `${col.name} (${col.dtype})`;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error loading rating columns:', error);
    }
}

function updateWizardUI() {
    // Update step indicators
    document.getElementById('wizardCurrentStep').textContent = wizardStep;

    // Update progress pills - matches model_configs.html pattern
    document.getElementById('wizardProgress1').className = 'progress-step-pill ' +
        (wizardStep === 1 ? 'current' : 'completed');
    document.getElementById('wizardProgress2').className = 'progress-step-pill ' +
        (wizardStep === 2 ? 'current' : 'future');

    // Show/hide steps
    document.getElementById('wizardStep1').classList.toggle('active', wizardStep === 1);
    document.getElementById('wizardStep2').classList.toggle('active', wizardStep === 2);

    // Show/hide navigation buttons
    document.getElementById('wizardBackBtn').classList.toggle('hidden', wizardStep === 1);
    document.getElementById('wizardNextBtn').classList.toggle('hidden', wizardStep === 2);

    // Show/hide action buttons
    document.getElementById('wizardRunBtn').classList.toggle('hidden', wizardStep !== 2);
}

function updateWizardSummary() {
    document.getElementById('wizardSummaryFeature').textContent =
        selectedFeatureConfig ? selectedFeatureConfig.name : '-';
    document.getElementById('wizardSummaryModel').textContent =
        selectedModelConfig ? selectedModelConfig.name : '-';
}

function wizardNext() {
    if (wizardStep === 1) {
        // Validate step 1
        if (!selectedFeatureConfig) {
            showError('Please select a Feature Config');
            return;
        }
        if (!selectedModelConfig) {
            showError('Please select a Model Config');
            return;
        }

        wizardStep = 2;
        updateWizardUI();
    }
}

function wizardBack() {
    if (wizardStep === 2) {
        wizardStep = 1;
        updateWizardUI();
    }
}

async function submitExperiment() {
    // Validate
    if (!selectedFeatureConfig || !selectedModelConfig) {
        showError('Please select both Feature Config and Model Config');
        return;
    }

    const splitStrategy = document.getElementById('wizardSplitStrategy').value;
    const dateColumn = document.getElementById('wizardDateColumn').value;

    if ((splitStrategy === 'time_holdout' || splitStrategy === 'strict_time') && !dateColumn) {
        showError('Please select a date column for time-based split');
        return;
    }

    // Build payload
    const payload = {
        model_config_id: selectedModelConfig.id,
        split_strategy: splitStrategy,
        data_sample_percent: parseInt(document.getElementById('wizardSamplePercentInput').value) || 100,
        holdout_days: parseInt(document.getElementById('wizardHoldoutDays').value) || 1,
        date_column: dateColumn,
        epochs: parseInt(document.getElementById('wizardEpochs').value),
        batch_size: parseInt(document.getElementById('wizardBatchSize').value),
        learning_rate: parseFloat(document.getElementById('wizardLearningRate').value),
        // Rolling window parameters for strict_time
        train_days: parseInt(document.getElementById('wizardTrainDays').value) || 60,
        val_days: parseInt(document.getElementById('wizardValDays').value) || 7,
        test_days: parseInt(document.getElementById('wizardTestDays').value) || 7
    };

    // Add rating column for ranking models
    if (selectedModelConfig.model_type === 'ranking' || selectedModelConfig.model_type === 'multitask') {
        payload.rating_column = document.getElementById('wizardRatingColumn').value;
    }

    // Disable run button
    const runBtn = document.getElementById('wizardRunBtn');
    runBtn.disabled = true;
    runBtn.querySelector('.btn-neu-inner').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Submitting...';

    try {
        const response = await fetch(`/api/feature-configs/${selectedFeatureConfig.id}/quick-test/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(payload)
        });

        const data = await response.json();

        if (data.success) {
            // Close wizard
            closeNewExpWizard();

            // Refresh experiments list
            await loadExperiments(1);

            // Show experiments list if it was hidden
            document.getElementById('expEmpty').classList.add('hidden');
            document.getElementById('expFilterBar').classList.remove('hidden');
            document.getElementById('expList').classList.remove('hidden');

            // Start polling
            startBackgroundPolling();

            showSuccess(`${data.quick_test.display_name} submitted successfully`);
        } else {
            showError(data.error || 'Failed to submit experiment');
        }
    } catch (error) {
        console.error('Error submitting experiment:', error);
        showError('Failed to submit experiment: ' + error.message);
    } finally {
        runBtn.disabled = false;
        runBtn.querySelector('.btn-neu-inner').innerHTML = '<i class="fas fa-play mr-2"></i>Run Experiment';
    }
}

// =============================================================================
// EXPERIMENT DETAILS & MODALS
// =============================================================================
async function openExpDetails(expId) {
    try {
        const response = await fetch(`/api/quick-tests/${expId}/`);
        const data = await response.json();

        if (!data.success) {
            showError(data.error || 'Failed to load experiment details');
            return;
        }

        const exp = data.quick_test;

        if (exp.status === 'running' || exp.status === 'submitting') {
            // Show progress modal
            openProgressModal(exp);
        } else {
            // Show results modal
            openResultsModal(exp);
        }
    } catch (error) {
        console.error('Error loading experiment details:', error);
        showError('Failed to load experiment details');
    }
}

function openProgressModal(exp) {
    currentExpId = exp.id;

    document.getElementById('progressExpName').textContent = exp.display_name;
    document.getElementById('progressConfigs').textContent = `${exp.feature_config_name} + ${exp.model_config_name}`;

    updateProgressUI(exp);
    document.getElementById('expProgressModal').classList.remove('hidden');

    // Start polling for this specific experiment
    startExpPolling(exp.id);
}

function closeProgressModal() {
    document.getElementById('expProgressModal').classList.add('hidden');
    stopExpPolling();
}

function updateProgressUI(exp) {
    // Update progress bar
    const percent = exp.progress_percent || 0;
    document.getElementById('progressBar').style.width = percent + '%';
    document.getElementById('progressText').textContent = percent + '%';

    // Update stages
    const stages = exp.stage_details || getDefaultStages();
    document.getElementById('progressStages').innerHTML = stages.map(stage => {
        let iconClass, statusClass;
        switch (stage.status) {
            case 'completed':
                iconClass = 'fa-check-circle';
                statusClass = 'completed';
                break;
            case 'running':
                iconClass = 'fa-spinner fa-spin';
                statusClass = 'running';
                break;
            case 'failed':
                iconClass = 'fa-times-circle';
                statusClass = 'failed';
                break;
            default:
                iconClass = 'fa-clock';
                statusClass = 'pending';
        }

        const duration = stage.duration_seconds ? formatDuration(stage.duration_seconds) : '';

        return `
            <div class="quicktest-stage ${statusClass}">
                <div class="quicktest-stage-icon ${statusClass}">
                    <i class="fas ${iconClass}"></i>
                </div>
                <span class="quicktest-stage-name">${stage.name}</span>
                <span class="quicktest-stage-duration">${duration}</span>
            </div>
        `;
    }).join('');

    // Update elapsed time
    if (exp.elapsed_seconds) {
        document.getElementById('progressElapsed').textContent = formatDuration(exp.elapsed_seconds);
    }
}

function getDefaultStages() {
    return [
        { name: 'ExampleGen', status: 'pending' },
        { name: 'StatisticsGen', status: 'pending' },
        { name: 'SchemaGen', status: 'pending' },
        { name: 'Transform', status: 'pending' },
        { name: 'Trainer', status: 'pending' }
    ];
}

function openResultsModal(exp) {
    document.getElementById('resultsExpName').textContent = exp.display_name;
    document.getElementById('resultsConfigs').textContent = `${exp.feature_config_name} + ${exp.model_config_name}`;

    // Status icon and badge
    const statusIcon = document.getElementById('resultsStatusIcon');
    const statusBadge = document.getElementById('resultsStatusBadge');

    if (exp.status === 'completed') {
        statusIcon.className = 'modal-header-icon success';
        statusIcon.innerHTML = '<i class="fas fa-check"></i>';
        statusBadge.innerHTML = '<span class="status-badge active"><i class="fas fa-check-circle"></i> Completed</span>';
    } else if (exp.status === 'failed') {
        statusIcon.className = 'modal-header-icon error';
        statusIcon.innerHTML = '<i class="fas fa-times"></i>';
        statusBadge.innerHTML = '<span class="status-badge" style="background: #fef2f2; color: #991b1b;"><i class="fas fa-times-circle"></i> Failed</span>';
    } else {
        statusIcon.className = 'modal-header-icon info';
        statusIcon.innerHTML = '<i class="fas fa-ban"></i>';
        statusBadge.innerHTML = '<span class="status-badge draft"><i class="fas fa-ban"></i> Cancelled</span>';
    }

    // Metrics
    const metrics = exp.metrics || {};
    document.getElementById('resultsMetrics').innerHTML = exp.status === 'completed' ? `
        <div class="quicktest-metric">
            <span class="quicktest-metric-label">Loss</span>
            <span class="quicktest-metric-value">${metrics.loss != null ? metrics.loss.toFixed(4) : 'N/A'}</span>
        </div>
        <div class="quicktest-metric">
            <span class="quicktest-metric-label">Recall@10</span>
            <span class="quicktest-metric-value">${metrics.recall_at_10 != null ? (metrics.recall_at_10 * 100).toFixed(2) + '%' : 'N/A'}</span>
        </div>
        <div class="quicktest-metric">
            <span class="quicktest-metric-label">Recall@50</span>
            <span class="quicktest-metric-value">${metrics.recall_at_50 != null ? (metrics.recall_at_50 * 100).toFixed(2) + '%' : 'N/A'}</span>
        </div>
        <div class="quicktest-metric">
            <span class="quicktest-metric-label">Recall@100</span>
            <span class="quicktest-metric-value">${metrics.recall_at_100 != null ? (metrics.recall_at_100 * 100).toFixed(2) + '%' : 'N/A'}</span>
        </div>
    ` : '<p class="text-gray-500">No metrics available</p>';

    // Error section
    const errorSection = document.getElementById('resultsErrorSection');
    if (exp.status === 'failed' && exp.error_message) {
        errorSection.classList.remove('hidden');
        document.getElementById('resultsErrorMessage').textContent = exp.error_message;
    } else {
        errorSection.classList.add('hidden');
    }

    // Duration
    document.getElementById('resultsDuration').textContent = exp.duration_seconds
        ? formatDuration(exp.duration_seconds)
        : '-';

    // Vertex AI link
    if (exp.vertex_pipeline_job_id) {
        const link = `https://console.cloud.google.com/vertex-ai/pipelines/runs/${exp.vertex_pipeline_job_id}?project=b2b-recs`;
        document.getElementById('resultsVertexLink').href = link;
        document.getElementById('resultsVertexLink').style.display = 'inline';
    } else {
        document.getElementById('resultsVertexLink').style.display = 'none';
    }

    document.getElementById('expResultsModal').classList.remove('hidden');
}

function closeResultsModal() {
    document.getElementById('expResultsModal').classList.add('hidden');
}

// =============================================================================
// POLLING
// =============================================================================
function startExpPolling(expId) {
    stopExpPolling();

    pollInterval = setInterval(async () => {
        try {
            const response = await fetch(`/api/quick-tests/${expId}/`);
            const data = await response.json();

            if (data.success) {
                const exp = data.quick_test;
                updateProgressUI(exp);

                // Also update the card in the list
                updateExpCard(exp);

                if (['completed', 'failed', 'cancelled'].includes(exp.status)) {
                    stopExpPolling();
                    closeProgressModal();
                    openResultsModal(exp);
                }
            }
        } catch (error) {
            console.error('Polling error:', error);
        }
    }, 10000);
}

function stopExpPolling() {
    if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
    }
}

function startBackgroundPolling() {
    // Poll for running experiments every 30 seconds
    setInterval(async () => {
        const hasRunning = experiments.some(e => e.status === 'running' || e.status === 'submitting');
        if (hasRunning) {
            await loadExperiments(pagination.page);
        }
    }, 30000);
}

function updateExpCard(exp) {
    // Find and update the card in the DOM
    const card = document.querySelector(`[data-exp-id="${exp.id}"]`);
    if (card) {
        card.outerHTML = renderExpCard(exp);
    }
}

// =============================================================================
// CANCEL
// =============================================================================
async function cancelExperiment() {
    if (!currentExpId) return;

    const btn = document.getElementById('progressCancelBtn');
    btn.disabled = true;
    btn.querySelector('.btn-neu-inner').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Cancelling...';

    try {
        const response = await fetch(`/api/quick-tests/${currentExpId}/cancel/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });

        const data = await response.json();

        if (data.success) {
            stopExpPolling();
            closeProgressModal();
            await loadExperiments(pagination.page);
            showSuccess('Experiment cancelled');
        } else {
            showError(data.error || 'Failed to cancel experiment');
        }
    } catch (error) {
        showError('Failed to cancel: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.querySelector('.btn-neu-inner').innerHTML = '<i class="fas fa-stop mr-2"></i>Cancel';
    }
}

// =============================================================================
// COMPARE MODAL (Placeholder)
// =============================================================================
function openCompareModal() {
    document.getElementById('compareModal').classList.remove('hidden');
}

function closeCompareModal() {
    document.getElementById('compareModal').classList.add('hidden');
}

// =============================================================================
// UTILITIES
// =============================================================================
function formatDuration(seconds) {
    if (!seconds && seconds !== 0) return '0:00';
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

function formatTimeAgo(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'just now';
    if (diffMins < 60) return `${diffMins} min ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    return date.toLocaleDateString();
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showError(message) {
    alert('Error: ' + message);
}

function showSuccess(message) {
    alert(message);
}
</script>
{% endblock %}
