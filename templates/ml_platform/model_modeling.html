{% extends 'base_model.html' %}
{% load humanize %}
{% load static %}

{% block title %}{{ model.name }} - Modeling{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/cards.css' %}?v=4">
<link rel="stylesheet" href="{% static 'css/modals.css' %}?v=2">
<style>
    /* Feature Config specific styles */
    .tensor-dim-bar {
        height: 8px;
        background: #e5e7eb;
        border-radius: 4px;
        overflow: hidden;
    }
    .tensor-dim-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.3s ease;
    }
    .tensor-dim-fill.buyer {
        background: linear-gradient(90deg, #3b82f6, #60a5fa);
    }
    .tensor-dim-fill.product {
        background: linear-gradient(90deg, #10b981, #34d399);
    }
    .tensor-breakdown {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-top: 8px;
    }
    .tensor-breakdown-item {
        font-size: 11px;
        padding: 2px 6px;
        background: #f3f4f6;
        border-radius: 4px;
        color: #6b7280;
    }
    .config-card {
        transition: all 0.2s ease;
    }
    .config-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 8px;
        border-radius: 9999px;
        font-size: 11px;
        font-weight: 500;
    }
    .status-badge.draft {
        background: #fef3c7;
        color: #92400e;
    }
    .status-badge.active {
        background: #d1fae5;
        color: #065f46;
    }
    .status-badge.archived {
        background: #e5e7eb;
        color: #6b7280;
    }
    .leakage-warning {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 6px;
        background: #fef3c7;
        border-radius: 4px;
        font-size: 11px;
        color: #92400e;
    }

    /* Drag and drop styles - Compact column cards */
    .column-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 6px 8px;
        cursor: grab;
        transition: all 0.15s ease;
        user-select: none;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .column-card:hover {
        border-color: #3b82f6;
        background: #f8fafc;
    }
    .column-card.dragging {
        opacity: 0.5;
        cursor: grabbing;
    }
    .column-card .drag-handle {
        color: #d1d5db;
        font-size: 10px;
        flex-shrink: 0;
    }
    .column-card .column-name {
        font-size: 12px;
        font-weight: 500;
        color: #374151;
        flex: 1;
        min-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .column-card .column-type {
        font-size: 10px;
        padding: 1px 4px;
        background: #f3f4f6;
        border-radius: 3px;
        color: #6b7280;
        text-transform: uppercase;
    }

    .drop-zone {
        min-height: 200px;
        border: 2px dashed #e5e7eb;
        border-radius: 12px;
        padding: 16px;
        transition: all 0.2s ease;
    }
    .drop-zone.drag-over {
        border-color: #3b82f6;
        background: #eff6ff;
    }
    .drop-zone-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 150px;
        color: #9ca3af;
    }

    .assigned-feature {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 8px;
    }
    .assigned-feature:hover {
        border-color: #d1d5db;
    }
    .feature-config-btn {
        width: 28px;
        height: 28px;
        border-radius: 6px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: none;
        cursor: pointer;
        transition: all 0.15s ease;
    }
    .feature-config-btn.settings {
        background: #f3f4f6;
        color: #6b7280;
    }
    .feature-config-btn.settings:hover {
        background: #e5e7eb;
        color: #374151;
    }
    .feature-config-btn.remove {
        background: #fef2f2;
        color: #dc2626;
    }
    .feature-config-btn.remove:hover {
        background: #fee2e2;
    }

    .cross-feature {
        background: #f0fdf4;
        border: 1px solid #bbf7d0;
        border-radius: 8px;
        padding: 10px 12px;
        margin-bottom: 8px;
    }

    /* Tensor preview */
    .tensor-preview-panel {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 16px;
    }
    .tensor-preview-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
    }
    .tensor-preview-title {
        font-weight: 600;
        color: #374151;
    }
    .tensor-preview-total {
        font-size: 24px;
        font-weight: 700;
    }
    .tensor-preview-total.buyer {
        color: #3b82f6;
    }
    .tensor-preview-total.product {
        color: #10b981;
    }
    .tensor-breakdown-bar {
        display: flex;
        height: 24px;
        border-radius: 6px;
        overflow: hidden;
        background: #e5e7eb;
        margin-bottom: 8px;
    }
    .tensor-breakdown-segment {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: 500;
        color: white;
        transition: width 0.3s ease;
        overflow: hidden;
        white-space: nowrap;
    }

    /* Modal form styles */
    .modal-form-group {
        margin-bottom: 16px;
    }
    .modal-form-label {
        display: block;
        font-size: 13px;
        font-weight: 500;
        color: #374151;
        margin-bottom: 6px;
    }
    .modal-form-hint {
        font-size: 12px;
        color: #6b7280;
        margin-top: 4px;
    }
    .transform-option {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        padding: 12px;
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        margin-bottom: 8px;
    }
    .transform-option input[type="checkbox"] {
        margin-top: 2px;
    }
    .transform-option-content {
        flex: 1;
    }
    .transform-option-title {
        font-weight: 500;
        color: #374151;
    }
    .transform-option-desc {
        font-size: 12px;
        color: #6b7280;
        margin-top: 2px;
    }
    .transform-option-dim {
        font-size: 12px;
        font-weight: 600;
        color: #3b82f6;
        white-space: nowrap;
    }

    /* Sample Table Styles */
    .sample-table-container {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        overflow: hidden;
    }
    .sample-table-wrapper {
        max-height: 240px;
        overflow: auto;
    }
    .sample-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
    }
    .sample-table th {
        position: sticky;
        top: 0;
        background: #f9fafb;
        padding: 8px 12px;
        text-align: left;
        font-weight: 600;
        color: #374151;
        border-bottom: 2px solid #e5e7eb;
        white-space: nowrap;
    }
    .sample-table td {
        padding: 6px 12px;
        border-bottom: 1px solid #f3f4f6;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .sample-table tr:hover td {
        background: #f9fafb;
    }

    /* Column assignment colors for sample table */
    .col-buyer {
        background-color: #eff6ff !important;
    }
    .col-product {
        background-color: #f0fdf4 !important;
    }
    .col-both {
        background-color: #fef2f2 !important;
    }
    .sample-table th.col-buyer {
        background-color: #dbeafe !important;
        border-bottom-color: #3b82f6;
    }
    .sample-table th.col-product {
        background-color: #dcfce7 !important;
        border-bottom-color: #10b981;
    }
    .sample-table th.col-both {
        background-color: #fee2e2 !important;
        border-bottom-color: #ef4444;
    }
    .null-value {
        color: #9ca3af;
        font-style: italic;
    }

    /* BQ type badge in column cards */
    .column-bq-type {
        font-size: 9px;
        padding: 1px 4px;
        background: #f3f4f6;
        border-radius: 3px;
        color: #6b7280;
        font-family: monospace;
        flex-shrink: 0;
        text-transform: uppercase;
    }

    /* Needs attention state for features without transforms */
    .feature-config-btn.needs-attention {
        background: #fef3c7;
        color: #d97706;
        animation: pulse-attention 2s infinite;
    }
    @keyframes pulse-attention {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }
    .assigned-feature.feature-needs-config {
        background: #fef3c7;
        border-color: #fcd34d;
    }

    /* Column card assignment states */
    .column-card.assigned-buyer {
        border-left: 2px solid #3b82f6;
        background: #eff6ff;
    }
    .column-card.assigned-product {
        border-left: 2px solid #10b981;
        background: #f0fdf4;
    }
    .column-card.assigned-both {
        border-left: 2px solid #ef4444;
        background: #fef2f2;
    }

    /* Primary ID Drop Zone Styles */
    .primary-id-zone {
        border: 2px dashed #f59e0b;
        border-radius: 10px;
        padding: 16px;
        margin-bottom: 12px;
        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        position: relative;
    }
    .primary-id-zone.buyer {
        border-color: #3b82f6;
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    }
    .primary-id-zone.product {
        border-color: #10b981;
        background: linear-gradient(135deg, #f0fdf4 0%, #d1fae5 100%);
    }
    .primary-id-zone.drag-over {
        border-style: solid;
        box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.3);
    }
    .primary-id-zone.buyer.drag-over {
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
    }
    .primary-id-zone.product.drag-over {
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3);
    }
    .primary-id-zone-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
    }
    .primary-id-zone-icon {
        width: 24px;
        height: 24px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
    }
    .primary-id-zone.buyer .primary-id-zone-icon {
        background: #3b82f6;
        color: white;
    }
    .primary-id-zone.product .primary-id-zone-icon {
        background: #10b981;
        color: white;
    }
    .primary-id-zone-title {
        font-weight: 600;
        font-size: 14px;
        color: #374151;
    }
    .primary-id-zone-required {
        font-size: 10px;
        font-weight: 500;
        padding: 2px 6px;
        border-radius: 4px;
        background: transparent;
        color: #6b7280;
        margin-left: auto;
    }
    .primary-id-zone-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        color: #6b7280;
        text-align: center;
    }
    .primary-id-zone-empty i {
        font-size: 24px;
        margin-bottom: 8px;
        opacity: 0.5;
    }
    .primary-id-zone-empty span {
        font-size: 13px;
    }

    /* Assigned Primary ID Feature */
    .primary-id-assigned {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 12px;
    }
    .primary-id-zone.buyer .primary-id-assigned {
        border-color: #93c5fd;
    }
    .primary-id-zone.product .primary-id-assigned {
        border-color: #6ee7b7;
    }

    /* Additional Features Section - Locked State */
    .additional-features-section {
        border: 2px dashed #e5e7eb;
        border-radius: 10px;
        padding: 16px;
        min-height: 120px;
        transition: all 0.3s ease;
    }
    .additional-features-section.buyer {
        border-color: #3b82f6;
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    }
    .additional-features-section.product {
        border-color: #10b981;
        background: linear-gradient(135deg, #f0fdf4 0%, #d1fae5 100%);
    }
    .additional-features-section.locked {
        opacity: 0.6;
        pointer-events: none;
    }
    .additional-features-section.locked::before {
        content: '';
        position: absolute;
        inset: 0;
        cursor: not-allowed;
    }
    .additional-features-section.drag-over {
        border-style: solid;
    }
    .additional-features-section.buyer.drag-over {
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
    }
    .additional-features-section.product.drag-over {
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3);
    }
    .additional-features-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
        color: #6b7280;
        font-size: 13px;
        font-weight: 500;
    }
    .additional-features-header i {
        font-size: 12px;
    }
    .locked-message {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        color: #9ca3af;
        text-align: center;
    }
    .locked-message i {
        font-size: 20px;
        margin-bottom: 8px;
    }
    .locked-message span {
        font-size: 12px;
    }

    /* Code Viewer Modal Styles */
    .code-viewer-tabs {
        display: flex;
        border-bottom: 1px solid #e5e7eb;
        margin-bottom: 16px;
    }
    .code-viewer-tab {
        padding: 10px 20px;
        font-size: 14px;
        font-weight: 500;
        color: #6b7280;
        background: transparent;
        border: none;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        margin-bottom: -1px;
        transition: all 0.15s ease;
    }
    .code-viewer-tab:hover {
        color: #374151;
        background: #f9fafb;
    }
    .code-viewer-tab.active {
        color: #3b82f6;
        border-bottom-color: #3b82f6;
    }
    .code-viewer-tab .tab-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 20px;
        height: 20px;
        padding: 0 6px;
        margin-left: 6px;
        font-size: 11px;
        font-weight: 600;
        border-radius: 10px;
        background: #e5e7eb;
        color: #6b7280;
    }
    .code-viewer-tab.active .tab-badge {
        background: #dbeafe;
        color: #3b82f6;
    }
    .code-viewer-content {
        display: none;
    }
    .code-viewer-content.active {
        display: block;
    }
    .code-container {
        position: relative;
        background: #1e293b;
        border-radius: 8px;
        overflow: hidden;
    }
    .code-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 14px;
        background: #334155;
        border-bottom: 1px solid #475569;
    }
    .code-filename {
        font-size: 12px;
        font-weight: 500;
        color: #94a3b8;
        font-family: 'SF Mono', Monaco, 'Courier New', monospace;
    }
    .code-actions {
        display: flex;
        gap: 8px;
    }
    .code-action-btn {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 5px 10px;
        font-size: 11px;
        font-weight: 500;
        color: #94a3b8;
        background: #475569;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.15s ease;
    }
    .code-action-btn:hover {
        background: #64748b;
        color: #e2e8f0;
    }
    .code-action-btn.copied {
        background: #10b981;
        color: white;
    }
    .code-block {
        max-height: 450px;
        overflow: auto;
        padding: 16px;
    }
    .code-block pre {
        margin: 0;
        padding: 0;
        font-family: 'SF Mono', Monaco, 'Courier New', monospace;
        font-size: 12px;
        line-height: 1.6;
        color: #e2e8f0;
        white-space: pre;
        tab-size: 4;
    }
    /* Simple syntax highlighting */
    .code-block .keyword {
        color: #c678dd;
    }
    .code-block .string {
        color: #98c379;
    }
    .code-block .comment {
        color: #7f848e;
        font-style: italic;
    }
    .code-block .function {
        color: #61afef;
    }
    .code-block .decorator {
        color: #e5c07b;
    }
    .code-block .number {
        color: #d19a66;
    }
    .code-block .class-name {
        color: #e5c07b;
    }
    .code-block .builtin {
        color: #56b6c2;
    }
    .code-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px;
        color: #9ca3af;
    }
    .code-empty i {
        font-size: 32px;
        margin-bottom: 12px;
        opacity: 0.5;
    }
    .code-empty span {
        font-size: 14px;
    }
    .code-meta {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 12px 16px;
        background: #f9fafb;
        border-radius: 8px;
        margin-bottom: 12px;
        font-size: 12px;
        color: #6b7280;
    }
    .code-meta-item {
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .code-meta-item i {
        color: #9ca3af;
    }
    /* Code validation status */
    .validation-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .validation-badge.valid {
        background: #dcfce7;
        color: #166534;
    }
    .validation-badge.invalid {
        background: #fee2e2;
        color: #991b1b;
    }
    .validation-badge.checking {
        background: #fef3c7;
        color: #92400e;
    }
    .validation-badge i {
        font-size: 10px;
    }
    .validation-error-banner {
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 6px;
        padding: 10px 14px;
        margin-bottom: 12px;
        display: flex;
        align-items: flex-start;
        gap: 10px;
    }
    .validation-error-banner i {
        color: #dc2626;
        margin-top: 2px;
    }
    .validation-error-banner .error-text {
        color: #991b1b;
        font-size: 13px;
        font-family: 'SF Mono', 'Monaco', 'Menlo', monospace;
    }
    .validation-error-banner .error-line {
        color: #dc2626;
        font-weight: 600;
    }

    /* Quick Test Styles */
    .quicktest-progress-bar {
        height: 24px;
        background: #e5e7eb;
        border-radius: 12px;
        overflow: hidden;
        position: relative;
    }
    .quicktest-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #3b82f6, #60a5fa);
        border-radius: 12px;
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .quicktest-progress-fill.animated {
        background: linear-gradient(90deg, #3b82f6, #60a5fa, #3b82f6);
        background-size: 200% 100%;
        animation: progress-shimmer 2s linear infinite;
    }
    @keyframes progress-shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
    .quicktest-progress-text {
        color: white;
        font-size: 12px;
        font-weight: 600;
    }
    .quicktest-stage {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        border-radius: 8px;
        margin-bottom: 8px;
        background: #f9fafb;
    }
    .quicktest-stage.completed {
        background: #ecfdf5;
    }
    .quicktest-stage.running {
        background: #eff6ff;
    }
    .quicktest-stage.failed {
        background: #fef2f2;
    }
    .quicktest-stage-icon {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
    }
    .quicktest-stage-icon.completed { color: #10b981; }
    .quicktest-stage-icon.running { color: #3b82f6; }
    .quicktest-stage-icon.failed { color: #ef4444; }
    .quicktest-stage-icon.pending { color: #9ca3af; }
    .quicktest-stage-name {
        flex: 1;
        font-weight: 500;
        color: #374151;
    }
    .quicktest-stage-duration {
        font-size: 12px;
        color: #6b7280;
    }
    .quicktest-metric {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #e5e7eb;
    }
    .quicktest-metric:last-child {
        border-bottom: none;
    }
    .quicktest-metric-label {
        color: #6b7280;
    }
    .quicktest-metric-value {
        font-weight: 600;
        color: #111827;
    }
    .quicktest-metric-value.improved {
        color: #10b981;
    }
    .quicktest-metric-value.declined {
        color: #ef4444;
    }

    /* Chapter Section Styles */
    .chapter-section {
        background: white;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        padding: 24px;
    }
    .chapter-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
    }
    .chapter-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
    }
    .chapter-icon.model-structure {
        background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
        color: white;
    }
    .chapter-icon.quick-test {
        background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
        color: white;
    }
    .chapter-icon.experiments {
        background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
        color: white;
    }
    .chapter-title {
        font-size: 20px;
        font-weight: 700;
        color: #111827;
    }
    .chapter-empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 48px 24px;
        color: #9ca3af;
        text-align: center;
    }
    .chapter-empty-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
    }
    .chapter-empty-text {
        font-size: 14px;
        max-width: 300px;
    }

    /* =========================================================================
       Model Config Card Styles
       ========================================================================= */
    .model-config-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 16px;
        transition: all 0.2s ease;
        cursor: pointer;
    }
    .model-config-card:hover {
        border-color: #8b5cf6;
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.1);
    }
    .model-config-card-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        margin-bottom: 12px;
    }
    .model-config-name {
        font-size: 16px;
        font-weight: 600;
        color: #111827;
        margin-bottom: 4px;
    }
    .model-config-desc {
        font-size: 12px;
        color: #6b7280;
        line-height: 1.4;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .model-type-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
    }
    .model-type-badge.retrieval {
        background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
        color: white;
    }
    .model-type-badge.ranking {
        background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
        color: white;
    }
    .model-type-badge.multitask {
        background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
        color: white;
    }

    /* Tower Architecture Visualization */
    .tower-visual {
        display: flex;
        gap: 12px;
        margin-bottom: 12px;
    }
    .tower-column {
        flex: 1;
        min-width: 0;
    }
    .tower-label {
        font-size: 10px;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        margin-bottom: 4px;
    }
    .tower-layers {
        background: #f9fafb;
        border-radius: 8px;
        padding: 8px;
        font-family: 'Monaco', 'Menlo', monospace;
        font-size: 13px;
        color: #374151;
        text-align: center;
    }
    .tower-layers.buyer {
        border-left: 3px solid #3b82f6;
    }
    .tower-layers.product {
        border-left: 3px solid #10b981;
    }

    /* Training Params Preview */
    .training-params-preview {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }
    .param-chip {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 8px;
        background: #f3f4f6;
        border-radius: 6px;
        font-size: 11px;
        color: #4b5563;
    }
    .param-chip-label {
        color: #9ca3af;
    }
    .param-chip-value {
        font-weight: 600;
    }

    /* Model Config Actions */
    .model-config-actions {
        display: flex;
        gap: 4px;
        opacity: 0;
        transition: opacity 0.2s ease;
    }
    .model-config-card:hover .model-config-actions {
        opacity: 1;
    }
    .model-config-action-btn {
        width: 28px;
        height: 28px;
        border-radius: 6px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: none;
        cursor: pointer;
        transition: all 0.15s ease;
        background: #f3f4f6;
        color: #6b7280;
    }
    .model-config-action-btn:hover {
        background: #e5e7eb;
        color: #374151;
    }
    .model-config-action-btn.delete:hover {
        background: #fee2e2;
        color: #dc2626;
    }

    /* Model Config Grid */
    .model-config-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 16px;
    }

    /* Model Config Wizard Styles */
    .wizard-model-type-selector {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin-bottom: 24px;
    }
    .wizard-model-type-option {
        padding: 16px;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
    }
    .wizard-model-type-option:hover:not(.disabled) {
        border-color: #8b5cf6;
        background: #faf5ff;
    }
    .wizard-model-type-option.selected {
        border-color: #8b5cf6;
        background: #f5f3ff;
    }
    .wizard-model-type-option.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .wizard-model-type-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 8px;
        font-size: 20px;
    }
    .wizard-model-type-icon.retrieval {
        background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
        color: white;
    }
    .wizard-model-type-icon.ranking {
        background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
        color: white;
    }
    .wizard-model-type-icon.multitask {
        background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
        color: white;
    }
    .wizard-model-type-name {
        font-weight: 600;
        color: #111827;
        margin-bottom: 4px;
    }
    .wizard-model-type-desc {
        font-size: 12px;
        color: #6b7280;
    }
    .wizard-model-type-phase {
        font-size: 10px;
        color: #9ca3af;
        margin-top: 4px;
    }

    /* Preset Selector */
    .preset-selector {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 8px;
        margin-bottom: 16px;
    }
    .preset-option {
        padding: 12px 8px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
    }
    .preset-option:hover {
        border-color: #8b5cf6;
    }
    .preset-option.selected {
        border-color: #8b5cf6;
        background: #f5f3ff;
    }
    .preset-option-name {
        font-size: 12px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 2px;
    }
    .preset-option-desc {
        font-size: 10px;
        color: #9ca3af;
    }

    /* Layer Builder */
    .layer-builder {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        overflow: hidden;
    }
    .layer-builder-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        background: #f9fafb;
        border-bottom: 1px solid #e5e7eb;
    }
    .layer-builder-title {
        font-weight: 600;
        color: #374151;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .layer-builder-title .tower-indicator {
        width: 12px;
        height: 12px;
        border-radius: 3px;
    }
    .layer-builder-title .tower-indicator.buyer {
        background: #3b82f6;
    }
    .layer-builder-title .tower-indicator.product {
        background: #10b981;
    }
    .layer-list {
        padding: 12px;
        min-height: 100px;
    }
    .layer-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 12px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        margin-bottom: 8px;
    }
    .layer-item:last-child {
        margin-bottom: 0;
    }
    .layer-item .drag-handle {
        color: #d1d5db;
        cursor: grab;
    }
    .layer-item .layer-type-badge {
        font-size: 10px;
        font-weight: 600;
        padding: 2px 6px;
        border-radius: 4px;
        text-transform: uppercase;
    }
    .layer-item .layer-type-badge.dense {
        background: #dbeafe;
        color: #1d4ed8;
    }
    .layer-item .layer-type-badge.dropout {
        background: #fef3c7;
        color: #92400e;
    }
    .layer-item .layer-type-badge.batch_norm {
        background: #d1fae5;
        color: #065f46;
    }
    .layer-item .layer-params {
        flex: 1;
        font-size: 12px;
        color: #4b5563;
    }
    .layer-item .layer-actions {
        display: flex;
        gap: 4px;
    }
    .add-layer-btn {
        width: 100%;
        padding: 10px;
        border: 2px dashed #e5e7eb;
        border-radius: 8px;
        background: transparent;
        color: #9ca3af;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }
    .add-layer-btn:hover {
        border-color: #8b5cf6;
        color: #8b5cf6;
        background: #faf5ff;
    }

    /* Training Params Form */
    .training-params-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }
    .training-param-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }
    .training-param-label {
        font-size: 12px;
        font-weight: 500;
        color: #374151;
    }
    .training-param-input {
        padding: 10px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
    }
    .training-param-input:focus {
        outline: none;
        border-color: #8b5cf6;
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }
</style>
{% endblock %}

{% block model_content %}
<div class="space-y-6">
    <!-- Modeling Container -->
    <div class="bg-white rounded-xl border border-black shadow-lg p-6">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-gray-900">Features</h2>
            <div class="btn-group">
                <button onclick="openCompareModal()" class="btn btn-secondary btn-sm" style="width: 150px;">
                    <i class="fas fa-columns"></i>Compare
                </button>
                <button onclick="openWizard()" class="btn btn-primary btn-sm" style="width: 150px;">
                    <i class="fas fa-plus"></i>New Feats Set
                </button>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="flex items-center gap-4 mb-4">
            <div class="flex items-center gap-2">
                <label class="text-sm font-medium text-gray-600">Dataset:</label>
                <select id="datasetFilter" onchange="filterConfigs()" class="form-select text-sm" style="min-width: 200px;">
                    <option value="">All Datasets</option>
                </select>
            </div>
            <div class="flex-1">
                <input type="text" id="searchInput" placeholder="Search feature configs..."
                       class="form-input w-full text-sm" onkeyup="debounceSearch()">
            </div>
        </div>

        <!-- Feature Configs List - scrollable, shows ~2 cards -->
        <div id="configsList" class="space-y-3" style="max-height: 420px; overflow-y: auto; min-height: 100px;">
            <!-- Loading state -->
            <div id="configsLoading" class="flex items-center justify-center py-12">
                <i class="fas fa-spinner fa-spin text-2xl text-gray-400 mr-3"></i>
                <span class="text-gray-500">Loading feature configs...</span>
            </div>
            <!-- Empty state (hidden by default) -->
            <div id="configsEmpty" class="card-empty-state hidden">
                <p class="card-empty-state-title">No feature configs yet</p>
                <p class="card-empty-state-text">Create your first feature config to define how columns are transformed for training</p>
            </div>
            <!-- Config cards will be inserted here -->
        </div>
    </div>

    <!-- Model Structure Chapter -->
    <div class="chapter-section">
        <div class="chapter-header">
            <div class="chapter-icon model-structure">
                <i class="fas fa-layer-group"></i>
            </div>
            <h2 class="chapter-title">Model Structure</h2>
            <div class="ml-auto flex gap-2">
                <button onclick="openTrainerCodeSelector()" class="btn btn-secondary btn-sm">
                    <i class="fas fa-brain mr-1"></i>Trainer Code
                </button>
                <button onclick="openModelConfigWizard()" class="btn btn-primary btn-sm">
                    <i class="fas fa-plus mr-1"></i>New Model Config
                </button>
            </div>
        </div>
        <div id="modelStructureContent">
            <!-- Loading state -->
            <div id="modelConfigsLoading" class="flex items-center justify-center py-8">
                <i class="fas fa-spinner fa-spin text-xl text-gray-400 mr-3"></i>
                <span class="text-gray-500">Loading model configs...</span>
            </div>
            <!-- Empty state (hidden by default) -->
            <div id="modelConfigsEmpty" class="chapter-empty-state hidden">
                <i class="fas fa-cubes chapter-empty-icon"></i>
                <p class="chapter-empty-text">No model configurations yet</p>
                <p class="text-sm text-gray-400 mt-2">Create your first model config to define neural network architecture</p>
                <button onclick="openModelConfigWizard()" class="btn btn-primary btn-sm mt-4">
                    <i class="fas fa-plus mr-1"></i>Create Model Config
                </button>
            </div>
            <!-- Model config cards container -->
            <div id="modelConfigsGrid" class="model-config-grid hidden"></div>
        </div>
    </div>

    <!-- Quick Test Chapter -->
    <div class="chapter-section">
        <div class="chapter-header">
            <div class="chapter-icon quick-test">
                <i class="fas fa-bolt"></i>
            </div>
            <h2 class="chapter-title">Quick Test</h2>
            <div class="ml-auto">
                <button onclick="openQuickTestSelector()" class="btn btn-primary btn-sm">
                    <i class="fas fa-play mr-1"></i>Run Quick Test
                </button>
            </div>
        </div>
        <div id="quickTestContent">
            <div class="chapter-empty-state">
                <i class="fas fa-vial chapter-empty-icon"></i>
                <p class="chapter-empty-text">Quick test functionality will be available here</p>
            </div>
        </div>
    </div>

    <!-- Experiments Chapter -->
    <div class="chapter-section">
        <div class="chapter-header">
            <div class="chapter-icon experiments">
                <i class="fas fa-flask"></i>
            </div>
            <h2 class="chapter-title">Experiments</h2>
        </div>
        <div id="experimentsContent">
            <div class="chapter-empty-state">
                <i class="fas fa-chart-line chapter-empty-icon"></i>
                <p class="chapter-empty-text">Experiment results and comparisons will be available here</p>
            </div>
        </div>
    </div>
</div>

<!-- Model Config Wizard Modal -->
<div id="modelConfigWizardModal" class="modal-overlay hidden">
    <div class="modal-container modal-container-wizard" style="max-width: 900px;">
        <!-- Modal Header -->
        <div class="modal-header-wizard">
            <div class="modal-header-content">
                <div class="modal-header-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);">
                    <i class="fas fa-layer-group text-lg text-white"></i>
                </div>
                <div class="modal-header-info">
                    <h3 class="modal-header-title" id="modelConfigWizardTitle">Create Model Config</h3>
                    <p class="modal-step-counter">Step <span id="mcCurrentStep">1</span> of 3</p>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress-bar-pills">
                <div id="mcProgress1" class="progress-step-pill current">Basic Info</div>
                <div id="mcProgress2" class="progress-step-pill future">Architecture</div>
                <div id="mcProgress3" class="progress-step-pill future">Training</div>
            </div>

            <!-- Close button -->
            <button class="modal-close-btn" onclick="closeModelConfigWizard()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Modal Body -->
        <div class="modal-body-wizard" style="max-height: calc(90vh - 200px); overflow-y: auto;">
            <!-- Step 1: Basic Info + Model Type -->
            <div id="mcStep1" class="wizard-step active">
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Model Type</label>
                    <div class="wizard-model-type-selector">
                        <div class="wizard-model-type-option selected" data-type="retrieval" onclick="selectModelType('retrieval')">
                            <div class="wizard-model-type-icon retrieval">
                                <i class="fas fa-search"></i>
                            </div>
                            <div class="wizard-model-type-name">Retrieval</div>
                            <div class="wizard-model-type-desc">Two-tower model for candidate retrieval</div>
                        </div>
                        <div class="wizard-model-type-option disabled" data-type="ranking">
                            <div class="wizard-model-type-icon ranking">
                                <i class="fas fa-sort-amount-down"></i>
                            </div>
                            <div class="wizard-model-type-name">Ranking</div>
                            <div class="wizard-model-type-desc">Score and rank retrieved candidates</div>
                            <div class="wizard-model-type-phase">(Phase 2)</div>
                        </div>
                        <div class="wizard-model-type-option disabled" data-type="multitask">
                            <div class="wizard-model-type-icon multitask">
                                <i class="fas fa-project-diagram"></i>
                            </div>
                            <div class="wizard-model-type-name">Multitask</div>
                            <div class="wizard-model-type-desc">Combined retrieval + ranking</div>
                            <div class="wizard-model-type-phase">(Phase 3)</div>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Configuration Name <span class="text-red-500">*</span></label>
                    <input type="text" id="mcName" class="training-param-input w-full" placeholder="e.g., Standard Retrieval v1" />
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                    <textarea id="mcDescription" class="training-param-input w-full" rows="2" placeholder="Optional description..."></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Start From Preset</label>
                    <div class="preset-selector">
                        <div class="preset-option" data-preset="minimal" onclick="selectPreset('minimal')">
                            <div class="preset-option-name">Minimal</div>
                            <div class="preset-option-desc">64→32, fast</div>
                        </div>
                        <div class="preset-option selected" data-preset="standard" onclick="selectPreset('standard')">
                            <div class="preset-option-name">Standard</div>
                            <div class="preset-option-desc">128→64→32</div>
                        </div>
                        <div class="preset-option" data-preset="deep" onclick="selectPreset('deep')">
                            <div class="preset-option-name">Deep</div>
                            <div class="preset-option-desc">256→128→64→32</div>
                        </div>
                        <div class="preset-option" data-preset="asymmetric" onclick="selectPreset('asymmetric')">
                            <div class="preset-option-name">Asymmetric</div>
                            <div class="preset-option-desc">Larger buyer</div>
                        </div>
                        <div class="preset-option" data-preset="regularized" onclick="selectPreset('regularized')">
                            <div class="preset-option-name">Regularized</div>
                            <div class="preset-option-desc">With dropout</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Tower Architecture -->
            <div id="mcStep2" class="wizard-step">
                <div class="grid grid-cols-2 gap-6">
                    <!-- Buyer Tower -->
                    <div class="layer-builder">
                        <div class="layer-builder-header">
                            <div class="layer-builder-title">
                                <span class="tower-indicator buyer"></span>
                                Buyer Tower (Query)
                            </div>
                            <span id="buyerTowerSummary" class="text-sm text-gray-500">128→64→32</span>
                        </div>
                        <div class="layer-list" id="buyerLayerList">
                            <!-- Layers will be rendered here -->
                        </div>
                        <div class="p-3 border-t border-gray-200">
                            <button class="add-layer-btn" onclick="addLayer('buyer')">
                                <i class="fas fa-plus"></i> Add Layer
                            </button>
                        </div>
                    </div>

                    <!-- Product Tower -->
                    <div class="layer-builder">
                        <div class="layer-builder-header">
                            <div class="layer-builder-title">
                                <span class="tower-indicator product"></span>
                                Product Tower (Candidate)
                            </div>
                            <span id="productTowerSummary" class="text-sm text-gray-500">128→64→32</span>
                        </div>
                        <div class="layer-list" id="productLayerList">
                            <!-- Layers will be rendered here -->
                        </div>
                        <div class="p-3 border-t border-gray-200">
                            <button class="add-layer-btn" onclick="addLayer('product')">
                                <i class="fas fa-plus"></i> Add Layer
                            </button>
                        </div>
                    </div>
                </div>

                <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Output Embedding Dimension</label>
                            <p class="text-xs text-gray-500">Final embedding size for both towers (must match)</p>
                        </div>
                        <input type="number" id="mcOutputEmbeddingDim" class="training-param-input" style="width: 100px;" value="32" min="8" max="512" step="8" />
                    </div>
                </div>
            </div>

            <!-- Step 3: Training Parameters -->
            <div id="mcStep3" class="wizard-step">
                <div class="training-params-grid">
                    <div class="training-param-group">
                        <label class="training-param-label">Optimizer</label>
                        <select id="mcOptimizer" class="training-param-input">
                            <option value="adagrad" selected>Adagrad (recommended)</option>
                            <option value="adam">Adam</option>
                            <option value="sgd">SGD</option>
                        </select>
                    </div>
                    <div class="training-param-group">
                        <label class="training-param-label">Learning Rate</label>
                        <input type="number" id="mcLearningRate" class="training-param-input" value="0.1" step="0.01" min="0.0001" max="1.0" />
                    </div>
                    <div class="training-param-group">
                        <label class="training-param-label">Batch Size</label>
                        <select id="mcBatchSize" class="training-param-input">
                            <option value="1024">1024</option>
                            <option value="2048">2048</option>
                            <option value="4096" selected>4096 (default)</option>
                            <option value="8192">8192</option>
                            <option value="16384">16384</option>
                        </select>
                    </div>
                    <div class="training-param-group">
                        <label class="training-param-label">Epochs</label>
                        <input type="number" id="mcEpochs" class="training-param-input" value="5" min="1" max="100" />
                    </div>
                </div>

                <!-- Summary Panel -->
                <div class="mt-6 p-4 bg-purple-50 rounded-lg border border-purple-200">
                    <h4 class="font-semibold text-purple-900 mb-3">Configuration Summary</h4>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-purple-700">Model Type:</span>
                            <span id="mcSummaryType" class="font-medium text-purple-900">Retrieval</span>
                        </div>
                        <div>
                            <span class="text-purple-700">Buyer Tower:</span>
                            <span id="mcSummaryBuyer" class="font-medium text-purple-900">128→64→32</span>
                        </div>
                        <div>
                            <span class="text-purple-700">Product Tower:</span>
                            <span id="mcSummaryProduct" class="font-medium text-purple-900">128→64→32</span>
                        </div>
                        <div>
                            <span class="text-purple-700">Output Dim:</span>
                            <span id="mcSummaryOutputDim" class="font-medium text-purple-900">32</span>
                        </div>
                        <div>
                            <span class="text-purple-700">Est. Parameters:</span>
                            <span id="mcSummaryParams" class="font-medium text-purple-900">~50K</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="modal-footer-wizard">
            <button id="mcBtnBack" class="btn btn-secondary" onclick="mcPrevStep()" style="display: none;">
                <i class="fas fa-arrow-left mr-1"></i> Back
            </button>
            <div class="flex-1"></div>
            <button class="btn btn-secondary" onclick="closeModelConfigWizard()">Cancel</button>
            <button id="mcBtnNext" class="btn btn-primary" onclick="mcNextStep()">
                Next <i class="fas fa-arrow-right ml-1"></i>
            </button>
            <button id="mcBtnCreate" class="btn btn-primary hidden" onclick="createModelConfig()">
                <i class="fas fa-check mr-1"></i> Create Config
            </button>
        </div>
    </div>
</div>

<!-- Add Layer Modal -->
<div id="addLayerModal" class="modal-overlay hidden" onclick="closeAddLayerModal(event)">
    <div class="modal-container" style="max-width: 400px;" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3 class="modal-title">Add Layer</h3>
            <button class="modal-close-btn" onclick="closeAddLayerModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="addLayerTower" />
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Layer Type</label>
                <select id="addLayerType" class="training-param-input w-full" onchange="updateLayerFields()">
                    <option value="dense">Dense</option>
                    <option value="dropout">Dropout</option>
                    <option value="batch_norm">Batch Normalization</option>
                </select>
            </div>
            <div id="denseFields">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Units</label>
                    <input type="number" id="addLayerUnits" class="training-param-input w-full" value="64" min="8" max="1024" step="8" />
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Activation</label>
                    <select id="addLayerActivation" class="training-param-input w-full">
                        <option value="relu" selected>ReLU</option>
                        <option value="tanh">Tanh</option>
                        <option value="sigmoid">Sigmoid</option>
                        <option value="linear">Linear (None)</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">L2 Regularization</label>
                    <input type="number" id="addLayerL2" class="training-param-input w-full" value="0" min="0" max="0.1" step="0.001" />
                </div>
            </div>
            <div id="dropoutFields" class="hidden">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Dropout Rate</label>
                    <input type="number" id="addLayerDropoutRate" class="training-param-input w-full" value="0.2" min="0" max="0.9" step="0.1" />
                </div>
            </div>
            <div id="batchNormFields" class="hidden">
                <p class="text-sm text-gray-500">Batch Normalization layer has no configurable parameters.</p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeAddLayerModal()">Cancel</button>
            <button class="btn btn-primary" onclick="confirmAddLayer()">Add Layer</button>
        </div>
    </div>
</div>

<!-- Model Config View Modal -->
<div id="modelConfigViewModal" class="modal-overlay hidden" onclick="closeModelConfigViewModal(event)">
    <div class="modal-container" style="max-width: 700px;" onclick="event.stopPropagation()">
        <div class="modal-header">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);">
                    <i class="fas fa-layer-group text-white"></i>
                </div>
                <div>
                    <h3 class="modal-title" id="viewMcName">Model Config Name</h3>
                    <p class="text-sm text-gray-500" id="viewMcDesc">Description</p>
                </div>
            </div>
            <button class="modal-close-btn" onclick="closeModelConfigViewModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="mb-4">
                <span id="viewMcTypeBadge" class="model-type-badge retrieval">Retrieval</span>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="p-4 bg-gray-50 rounded-lg">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="tower-indicator buyer" style="width: 8px; height: 8px; border-radius: 2px; background: #3b82f6;"></span>
                        <span class="text-sm font-medium text-gray-700">Buyer Tower</span>
                    </div>
                    <div id="viewMcBuyerLayers" class="font-mono text-lg text-gray-900">128→64→32</div>
                </div>
                <div class="p-4 bg-gray-50 rounded-lg">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="tower-indicator product" style="width: 8px; height: 8px; border-radius: 2px; background: #10b981;"></span>
                        <span class="text-sm font-medium text-gray-700">Product Tower</span>
                    </div>
                    <div id="viewMcProductLayers" class="font-mono text-lg text-gray-900">128→64→32</div>
                </div>
            </div>

            <div class="mb-6">
                <h4 class="text-sm font-medium text-gray-700 mb-3">Training Parameters</h4>
                <div class="training-params-preview" id="viewMcParams">
                    <!-- Will be populated dynamically -->
                </div>
            </div>

            <div class="text-sm text-gray-500">
                <span>Created <span id="viewMcCreatedAt"></span></span>
                <span class="mx-2">•</span>
                <span>by <span id="viewMcCreatedBy"></span></span>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModelConfigViewModal()">Close</button>
            <button class="btn btn-secondary" onclick="cloneModelConfig()">
                <i class="fas fa-copy mr-1"></i> Clone
            </button>
            <button class="btn btn-primary" onclick="editModelConfig()">
                <i class="fas fa-edit mr-1"></i> Edit
            </button>
        </div>
    </div>
</div>

<!-- Feature Config Wizard Modal -->
<div id="featureConfigWizardModal" class="modal-overlay hidden">
    <div class="modal-container modal-container-wizard" style="max-width: 1100px;">
        <!-- Modal Header -->
        <div class="modal-header-wizard">
            <div class="modal-header-content">
                <div class="modal-header-icon info">
                    <i class="fas fa-cogs text-lg"></i>
                </div>
                <div class="modal-header-info">
                    <h3 class="modal-header-title" id="wizardTitle">Create Feature Config</h3>
                    <p class="modal-step-counter">Step <span id="currentStep">1</span> of 2</p>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress-bar-pills">
                <div id="progress1" class="progress-step-pill current">Basic Info</div>
                <div id="progress2" class="progress-step-pill future">Features</div>
            </div>
        </div>

        <!-- Modal Body -->
        <div class="modal-body-wizard" style="max-height: calc(90vh - 200px); overflow-y: auto; position: relative;">
            <!-- Loading overlay for wizard (covers modal body) -->
            <div id="wizardLoadingOverlay" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.9); z-index: 100;">
                <div style="position: sticky; top: 50%; transform: translateY(-50%); display: flex; align-items: center; justify-content: center; gap: 12px;">
                    <i class="fas fa-spinner fa-spin text-2xl text-blue-500"></i>
                    <span class="text-gray-600" id="wizardLoadingText">Loading...</span>
                </div>
            </div>

            <!-- Step 1: Basic Info -->
            <div id="wizardStep1" class="wizard-step active">
                <h4 class="wizard-section-title">Basic Information</h4>

                <!-- Config Name -->
                <div class="wizard-field-group">
                    <label class="wizard-field-label">Config Name <span class="required">*</span></label>
                    <input type="text" id="configName" placeholder="e.g., Rich Features v1"
                           class="form-input w-full" oninput="validateConfigName()">
                    <p id="nameError" class="text-xs text-red-600 mt-1 hidden"></p>
                </div>

                <!-- Description -->
                <div class="wizard-field-group">
                    <label class="wizard-field-label">Description <span class="optional">(optional)</span></label>
                    <textarea id="configDescription" placeholder="Describe the purpose of this feature configuration..."
                              class="form-textarea w-full" rows="2"></textarea>
                </div>

                <!-- Dataset Selection -->
                <div class="wizard-field-group">
                    <label class="wizard-field-label">Base Dataset <span class="required">*</span></label>
                    <select id="configDataset" class="form-select w-full" onchange="onDatasetChange()">
                        <option value="">Select a dataset...</option>
                    </select>
                    <div id="datasetInfo" class="text-xs text-gray-500 mt-2 hidden">
                        <span id="datasetInfoText"></span>
                    </div>
                </div>

                <!-- Start From Options -->
                <div class="wizard-field-group">
                    <label class="wizard-field-label">Start From</label>
                    <div class="flex flex-wrap gap-3 mt-2">
                        <label class="flex items-center gap-2 p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition">
                            <input type="radio" name="startFrom" value="blank" checked onchange="onStartFromChange()">
                            <div>
                                <div class="font-medium text-sm">Blank</div>
                                <div class="text-xs text-gray-500">Start from scratch</div>
                            </div>
                        </label>
                        <label class="flex items-center gap-2 p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition">
                            <input type="radio" name="startFrom" value="clone" onchange="onStartFromChange()">
                            <div>
                                <div class="font-medium text-sm">Clone Existing</div>
                                <div class="text-xs text-gray-500">Copy from another config</div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Clone Selection (hidden by default) -->
                <div id="cloneSelection" class="wizard-field-group hidden">
                    <label class="wizard-field-label">Clone From</label>
                    <select id="cloneFromConfig" class="form-select w-full">
                        <option value="">Select a config to clone...</option>
                    </select>
                </div>

                <div class="wizard-info-box info">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>What is a Feature Config?</strong><br>
                        A feature config defines how dataset columns are transformed into tensors for the two-tower model (BuyerModel and ProductModel).
                    </div>
                </div>
            </div>

            <!-- Step 2: Feature Assignment -->
            <div id="wizardStep2" class="wizard-step hidden" style="position: relative;">
                <!-- Dataset Sample - Collapsible Tablet -->
                <div class="filter-subchapter" id="datasetSampleSubchapter">
                    <div class="subchapter-header-tablet" onclick="toggleModelingSubchapter('datasetSample')">
                        <span class="subchapter-title">Dataset Sample</span>
                        <span class="subchapter-filter-status" id="datasetSampleStatus"></span>
                        <i id="datasetSampleChevron" class="fas fa-chevron-right subchapter-chevron"></i>
                    </div>
                    <div id="datasetSampleContent" class="subchapter-content-outside hidden">
                        <div id="sampleDataTable" class="sample-table-container">
                            <!-- Table will be rendered here -->
                        </div>
                    </div>
                </div>

                <!-- Available Columns - Collapsible Tablet -->
                <div class="filter-subchapter" id="availableColumnsSubchapter">
                    <div class="subchapter-header-tablet" onclick="toggleModelingSubchapter('availableColumns')">
                        <span class="subchapter-title">Available Columns</span>
                        <span class="subchapter-filter-status" id="availableColumnsStatus"></span>
                        <i id="availableColumnsChevron" class="fas fa-chevron-down subchapter-chevron"></i>
                    </div>
                    <div id="availableColumnsContent" class="subchapter-content-outside">
                        <p class="text-xs text-gray-500 mb-2">Drag columns to BuyerModel or ProductModel</p>
                        <div id="availableColumns" class="grid grid-cols-4 gap-2" style="max-height: 180px; overflow-y: auto;">
                            <!-- Column cards will be inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Model Drop Zones -->
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <!-- Buyer Model -->
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                            <span class="w-3 h-3 rounded-full bg-blue-500"></span>
                            <h5 class="font-semibold text-gray-800">BuyerModel (Query Tower)</h5>
                        </div>

                        <!-- Primary ID Zone: Customer ID -->
                        <div id="customerIdZone" class="primary-id-zone buyer"
                             ondrop="dropPrimaryId(event, 'buyer')"
                             ondragover="allowDrop(event)"
                             ondragenter="dragEnterPrimaryId(event)"
                             ondragleave="dragLeavePrimaryId(event)">
                            <div class="primary-id-zone-header">
                                <div class="primary-id-zone-icon">
                                    <i class="fas fa-key"></i>
                                </div>
                                <span class="primary-id-zone-title">Customer ID</span>
                                <span class="primary-id-zone-required">Required</span>
                            </div>
                            <div id="customerIdContent">
                                <!-- Will be rendered by JS: empty state or assigned feature -->
                            </div>
                        </div>

                        <!-- Context Features Section -->
                        <div id="buyerAdditionalSection" class="additional-features-section buyer locked"
                             ondrop="dropFeature(event, 'buyer')"
                             ondragover="allowDropIfUnlocked(event, 'buyer')"
                             ondragenter="dragEnterIfUnlocked(event, 'buyer')"
                             ondragleave="dragLeave(event)">
                            <div class="additional-features-header">
                                <i class="fas fa-layer-group"></i>
                                <span>Context Features</span>
                            </div>
                            <div id="buyerLockedMessage" class="locked-message">
                                <i class="fas fa-lock"></i>
                                <span>Assign Customer ID first to add more features</span>
                            </div>
                            <div id="buyerModelFeatures"></div>
                            <div id="buyerModelCrosses" class="mt-3"></div>
                            <button type="button" class="btn btn-secondary btn-xs mt-2" onclick="openCrossModal('buyer')" id="addBuyerCrossBtn" style="display: none;">
                                <i class="fas fa-plus mr-1"></i>Add Cross Feature
                            </button>
                        </div>
                    </div>

                    <!-- Product Model -->
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                            <span class="w-3 h-3 rounded-full bg-green-500"></span>
                            <h5 class="font-semibold text-gray-800">ProductModel (Candidate Tower)</h5>
                        </div>

                        <!-- Primary ID Zone: Product ID -->
                        <div id="productIdZone" class="primary-id-zone product"
                             ondrop="dropPrimaryId(event, 'product')"
                             ondragover="allowDrop(event)"
                             ondragenter="dragEnterPrimaryId(event)"
                             ondragleave="dragLeavePrimaryId(event)">
                            <div class="primary-id-zone-header">
                                <div class="primary-id-zone-icon">
                                    <i class="fas fa-key"></i>
                                </div>
                                <span class="primary-id-zone-title">Product ID</span>
                                <span class="primary-id-zone-required">Required</span>
                            </div>
                            <div id="productIdContent">
                                <!-- Will be rendered by JS: empty state or assigned feature -->
                            </div>
                        </div>

                        <!-- Context Features Section -->
                        <div id="productAdditionalSection" class="additional-features-section product locked"
                             ondrop="dropFeature(event, 'product')"
                             ondragover="allowDropIfUnlocked(event, 'product')"
                             ondragenter="dragEnterIfUnlocked(event, 'product')"
                             ondragleave="dragLeave(event)">
                            <div class="additional-features-header">
                                <i class="fas fa-layer-group"></i>
                                <span>Context Features</span>
                            </div>
                            <div id="productLockedMessage" class="locked-message">
                                <i class="fas fa-lock"></i>
                                <span>Assign Product ID first to add more features</span>
                            </div>
                            <div id="productModelFeatures"></div>
                            <div id="productModelCrosses" class="mt-3"></div>
                            <button type="button" class="btn btn-secondary btn-xs mt-2" onclick="openCrossModal('product')" id="addProductCrossBtn" style="display: none;">
                                <i class="fas fa-plus mr-1"></i>Add Cross Feature
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tensor Preview -->
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <div class="tensor-preview-panel">
                        <div class="tensor-preview-header">
                            <span class="tensor-preview-title">Buyer Tensor</span>
                            <span id="buyerTensorTotal" class="tensor-preview-total buyer">0D</span>
                        </div>
                        <div id="buyerTensorBar" class="tensor-breakdown-bar"></div>
                        <div id="buyerTensorBreakdown" class="tensor-breakdown"></div>
                    </div>
                    <div class="tensor-preview-panel">
                        <div class="tensor-preview-header">
                            <span class="tensor-preview-title">Product Tensor</span>
                            <span id="productTensorTotal" class="tensor-preview-total product">0D</span>
                        </div>
                        <div id="productTensorBar" class="tensor-breakdown-bar"></div>
                        <div id="productTensorBreakdown" class="tensor-breakdown"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="modal-footer-wizard-neu">
            <div class="footer-left">
                <button type="button" id="backBtn" class="btn-neu btn-neu-nav hidden" onclick="prevStep()">
                    <span class="btn-neu-inner"><i class="fas fa-chevron-left"></i></span>
                </button>
                <button type="button" id="nextBtn" class="btn-neu btn-neu-nav" onclick="nextStep()">
                    <span class="btn-neu-inner"><i class="fas fa-chevron-right"></i></span>
                </button>
            </div>
            <div class="footer-right">
                <button type="button" id="saveBtn" class="btn-neu btn-neu-action btn-neu-save hidden" onclick="saveConfig()">
                    <span class="btn-neu-inner">Save</span>
                </button>
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeWizard()">
                    <span class="btn-neu-inner">Cancel</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Feature Configuration Modal -->
<div id="featureConfigModal" class="modal-overlay hidden">
    <div class="modal-container" style="max-width: 500px;">
        <div class="modal-header">
            <div class="modal-header-icon info">
                <i class="fas fa-cog"></i>
            </div>
            <h3 class="modal-header-title" id="featureModalTitle">Configure Feature</h3>
            <button type="button" class="modal-close-btn" onclick="closeFeatureModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" id="featureModalBody">
            <!-- Content will be dynamically generated -->
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-save" onclick="applyFeatureConfig()">
                    <span class="btn-neu-inner">Apply</span>
                </button>
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeFeatureModal()">
                    <span class="btn-neu-inner">Cancel</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Cross Feature Modal -->
<div id="crossFeatureModal" class="modal-overlay hidden">
    <div class="modal-container" style="max-width: 500px;">
        <div class="modal-header">
            <div class="modal-header-icon info">
                <i class="fas fa-times"></i>
            </div>
            <h3 class="modal-header-title">Add Cross Feature</h3>
            <button type="button" class="modal-close-btn" onclick="closeCrossModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="modal-form-group">
                <label class="modal-form-label">Select 2-3 features to cross</label>
                <div id="crossFeatureOptions" class="space-y-2">
                    <!-- Feature checkboxes will be inserted here -->
                </div>
            </div>
            <div id="crossPreview" class="text-sm text-gray-600 mt-3 hidden">
                Selected: <span id="crossPreviewText" class="font-medium"></span>
            </div>
            <!-- Bucketization options for numeric/temporal features -->
            <div id="crossBucketOptions" class="mt-4 hidden">
                <div class="text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-info-circle text-blue-500 mr-1"></i>
                    Numeric/temporal features need bucketization for crossing
                </div>
                <div id="crossBucketInputs" class="space-y-3">
                    <!-- Bucket inputs for each numeric/temporal feature will be inserted here -->
                </div>
            </div>
            <div class="modal-form-group mt-4">
                <label class="modal-form-label">Hash Bucket Size</label>
                <select id="crossHashBuckets" class="form-select w-full">
                    <option value="1000">1,000</option>
                    <option value="5000" selected>5,000</option>
                    <option value="10000">10,000</option>
                    <option value="50000">50,000</option>
                </select>
                <p class="modal-form-hint">Number of hash buckets for the crossed features</p>
            </div>
            <div class="modal-form-group">
                <label class="modal-form-label">Embedding Dimension</label>
                <select id="crossEmbedDim" class="form-select w-full">
                    <option value="8">8</option>
                    <option value="16" selected>16</option>
                    <option value="32">32</option>
                </select>
            </div>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-save" onclick="addCrossFeature()">
                    <span class="btn-neu-inner">Add Cross</span>
                </button>
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeCrossModal()">
                    <span class="btn-neu-inner">Cancel</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View Config Modal -->
<div id="viewConfigModal" class="modal-overlay hidden">
    <div class="modal-container" style="max-width: 880px;">
        <div class="modal-header">
            <div class="modal-header-icon info">
                <i class="fas fa-eye"></i>
            </div>
            <h3 class="modal-header-title" id="viewConfigTitle">Feature Config Details</h3>
        </div>
        <div class="modal-body" id="viewConfigBody" style="max-height: 70vh; overflow-y: auto;">
            <!-- Content will be dynamically generated -->
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeViewModal()">
                    <span class="btn-neu-inner">Close</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Clone Config Modal -->
<div id="cloneConfigModal" class="modal-overlay hidden">
    <div class="modal-container" style="max-width: 450px;">
        <div class="modal-header">
            <div class="modal-header-icon info">
                <i class="fas fa-copy"></i>
            </div>
            <h3 class="modal-header-title">Clone Feature Config</h3>
        </div>
        <div class="modal-body">
            <div class="mb-4">
                <label for="cloneConfigName" class="block text-sm font-medium text-gray-700 mb-2">
                    New config name
                </label>
                <input type="text" id="cloneConfigName"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                       placeholder="Enter name for cloned config">
            </div>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-save" onclick="submitClone()">
                    <span class="btn-neu-inner">Clone</span>
                </button>
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeCloneModal()">
                    <span class="btn-neu-inner">Cancel</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Compare Feature Sets Modal -->
<div id="compareModal" class="modal-overlay hidden">
    <div class="modal-container" style="max-width: 1000px;">
        <div class="modal-header">
            <div class="modal-header-icon info">
                <i class="fas fa-columns"></i>
            </div>
            <h3 class="modal-header-title">Compare Feature Sets</h3>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <!-- Dropdowns row -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Left Feature Set</label>
                    <select id="compareLeftSelect" onchange="onCompareSelectChange('left')"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select feature set...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Right Feature Set</label>
                    <select id="compareRightSelect" onchange="onCompareSelectChange('right')"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select feature set...</option>
                    </select>
                </div>
            </div>

            <!-- Comparison content - table layout for aligned rows -->
            <div class="border border-gray-200 rounded-lg overflow-hidden bg-white">
                <table class="w-full compare-table" id="compareTable">
                    <colgroup>
                        <col style="width: 50%">
                        <col style="width: 50%">
                    </colgroup>
                    <tbody id="compareTableBody">
                        <!-- Header row -->
                        <tr class="compare-row-header">
                            <td id="compareLeftHeader" class="p-4 align-top border-r border-gray-200 border-b">
                                <div class="flex items-center justify-center h-full text-gray-400 py-4">
                                    <span>Select a feature set</span>
                                </div>
                            </td>
                            <td id="compareRightHeader" class="p-4 align-top border-b">
                                <div class="flex items-center justify-center h-full text-gray-400 py-4">
                                    <span>Select a feature set</span>
                                </div>
                            </td>
                        </tr>
                        <!-- Source row -->
                        <tr class="compare-row-source hidden">
                            <td id="compareLeftSource" class="p-4 align-top border-r border-gray-200 border-b"></td>
                            <td id="compareRightSource" class="p-4 align-top border-b"></td>
                        </tr>
                        <!-- Buyer Tensor row -->
                        <tr class="compare-row-buyer hidden">
                            <td id="compareLeftBuyer" class="p-4 align-top border-r border-gray-200 border-b"></td>
                            <td id="compareRightBuyer" class="p-4 align-top border-b"></td>
                        </tr>
                        <!-- Product Tensor row -->
                        <tr class="compare-row-product hidden">
                            <td id="compareLeftProduct" class="p-4 align-top border-r border-gray-200"></td>
                            <td id="compareRightProduct" class="p-4 align-top"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeCompareModal()">
                    <span class="btn-neu-inner">Close</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Transform Code Viewer Modal -->
<div id="transformCodeViewerModal" class="modal-overlay hidden">
    <div class="modal-container" style="max-width: 900px;">
        <div class="modal-header">
            <div class="modal-header-icon info">
                <i class="fas fa-random"></i>
            </div>
            <h3 class="modal-header-title">Transform Code</h3>
            <button type="button" class="modal-close-btn" onclick="closeTransformCodeViewer()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" style="max-height: 75vh; overflow-y: auto;">
            <!-- Meta info -->
            <div class="code-meta">
                <div class="code-meta-item">
                    <i class="fas fa-clock"></i>
                    <span id="transformCodeGeneratedAt">-</span>
                </div>
                <div class="code-meta-item">
                    <i class="fas fa-sync-alt"></i>
                    <button onclick="regenerateTransformCode()" class="text-blue-600 hover:text-blue-800 font-medium">
                        Regenerate
                    </button>
                </div>
            </div>

            <!-- Transform Code Content -->
            <div id="transformValidationError" class="validation-error-banner" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                <div class="error-text">
                    <span id="transformErrorMsg"></span>
                    <span id="transformErrorLine" class="error-line"></span>
                </div>
            </div>
            <div class="code-container">
                <div class="code-header">
                    <span class="code-filename">preprocessing_fn.py</span>
                    <span id="transformValidationBadge" class="validation-badge checking">
                        <i class="fas fa-spinner fa-spin"></i> Checking
                    </span>
                    <span class="tab-badge" id="transformLineCount">-</span>
                    <div class="code-actions">
                        <button class="code-action-btn" onclick="copyCode('transform')" id="copyTransformBtn">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                        <button class="code-action-btn" onclick="downloadCode('transform')">
                            <i class="fas fa-download"></i> Download
                        </button>
                    </div>
                </div>
                <div class="code-block">
                    <pre id="transformCode"></pre>
                </div>
            </div>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left">
                <span class="text-sm text-gray-500" id="transformCodeConfigName"></span>
            </div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeTransformCodeViewer()">
                    <span class="btn-neu-inner">Close</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Trainer Code Viewer Modal -->
<div id="trainerCodeViewerModal" class="modal-overlay hidden">
    <div class="modal-container" style="max-width: 900px;">
        <div class="modal-header">
            <div class="modal-header-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);">
                <i class="fas fa-brain"></i>
            </div>
            <h3 class="modal-header-title">Trainer Code</h3>
            <button type="button" class="modal-close-btn" onclick="closeTrainerCodeViewer()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" style="max-height: 75vh; overflow-y: auto;">
            <!-- Meta info -->
            <div class="code-meta">
                <div class="code-meta-item">
                    <i class="fas fa-clock"></i>
                    <span id="trainerCodeGeneratedAt">-</span>
                </div>
                <div class="code-meta-item">
                    <i class="fas fa-sync-alt"></i>
                    <button onclick="regenerateTrainerCode()" class="text-blue-600 hover:text-blue-800 font-medium">
                        Regenerate
                    </button>
                </div>
            </div>

            <!-- Trainer Code Content -->
            <div id="trainerValidationError" class="validation-error-banner" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                <div class="error-text">
                    <span id="trainerErrorMsg"></span>
                    <span id="trainerErrorLine" class="error-line"></span>
                </div>
            </div>
            <div class="code-container">
                <div class="code-header">
                    <span class="code-filename">trainer_module.py</span>
                    <span id="trainerValidationBadge" class="validation-badge checking">
                        <i class="fas fa-spinner fa-spin"></i> Checking
                    </span>
                    <span class="tab-badge" id="trainerLineCount">-</span>
                    <div class="code-actions">
                        <button class="code-action-btn" onclick="copyCode('trainer')" id="copyTrainerBtn">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                        <button class="code-action-btn" onclick="downloadCode('trainer')">
                            <i class="fas fa-download"></i> Download
                        </button>
                    </div>
                </div>
                <div class="code-block">
                    <pre id="trainerCode"></pre>
                </div>
            </div>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left">
                <span class="text-sm text-gray-500" id="trainerCodeConfigName"></span>
            </div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeTrainerCodeViewer()">
                    <span class="btn-neu-inner">Close</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Quick Test Dialog Modal -->
<div id="quickTestDialog" class="modal-overlay hidden">
    <div class="modal-container" style="max-width: 500px;">
        <div class="modal-header">
            <div class="modal-header-icon info">
                <i class="fas fa-flask"></i>
            </div>
            <h3 class="modal-header-title">Quick Test</h3>
            <button type="button" class="modal-close-btn" onclick="closeQuickTestDialog()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p class="text-sm text-gray-600 mb-4">
                Config: <strong id="qtConfigName"></strong>
            </p>

            <h4 class="font-medium text-gray-900 mb-3">Training Parameters</h4>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Epochs</label>
                <select id="qtEpochs" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="5">5</option>
                    <option value="10" selected>10</option>
                    <option value="15">15</option>
                </select>
                <p class="text-xs text-gray-500 mt-1">Number of training epochs (1-15)</p>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Batch Size</label>
                <select id="qtBatchSize" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                    <option value="1024">1024</option>
                    <option value="2048">2048</option>
                    <option value="4096" selected>4096</option>
                    <option value="8192">8192</option>
                </select>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Learning Rate</label>
                <input type="number" id="qtLearningRate" class="w-full border border-gray-300 rounded-lg px-3 py-2"
                       value="0.001" step="0.0001" min="0.0001" max="0.1">
            </div>

            <div class="bg-gray-50 rounded-lg p-3 text-sm text-gray-600">
                <p><strong>Estimated duration:</strong> 15-25 minutes</p>
                <p><strong>Machine type:</strong> n1-standard-4 (4 vCPU, 15GB RAM)</p>
            </div>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-secondary" onclick="closeQuickTestDialog()">
                    <span class="btn-neu-inner">Cancel</span>
                </button>
                <button type="button" class="btn-neu btn-neu-action btn-neu-primary" onclick="startQuickTest()">
                    <span class="btn-neu-inner"><i class="fas fa-play mr-2"></i>Start Quick Test</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Quick Test Progress Modal -->
<div id="quickTestProgress" class="modal-overlay hidden">
    <div class="modal-container" style="max-width: 500px;">
        <div class="modal-header">
            <div class="modal-header-icon info">
                <i class="fas fa-cog fa-spin"></i>
            </div>
            <h3 class="modal-header-title">Quick Test Running</h3>
        </div>
        <div class="modal-body">
            <p class="text-sm text-gray-600 mb-4">
                Config: <strong id="qtProgressConfigName"></strong>
            </p>

            <!-- Progress Bar -->
            <div class="quicktest-progress-bar mb-4">
                <div class="quicktest-progress-fill animated" id="qtProgressBar" style="width: 0%">
                    <span class="quicktest-progress-text" id="qtProgressText">0%</span>
                </div>
            </div>

            <!-- Pipeline Stages -->
            <h4 class="font-medium text-gray-900 mb-3">Pipeline Stages</h4>
            <div id="qtStages">
                <!-- Populated by JavaScript -->
            </div>

            <!-- Elapsed Time -->
            <div class="mt-4 text-sm text-gray-500">
                <span>Elapsed: </span>
                <span id="qtElapsed">0:00</span>
            </div>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-secondary" onclick="cancelQuickTest()" id="qtCancelBtn">
                    <span class="btn-neu-inner"><i class="fas fa-stop mr-2"></i>Cancel Test</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Quick Test Results Modal -->
<div id="quickTestResults" class="modal-overlay hidden">
    <div class="modal-container" style="max-width: 600px;">
        <div class="modal-header">
            <div class="modal-header-icon" id="qtrStatusIcon">
                <i class="fas fa-check"></i>
            </div>
            <h3 class="modal-header-title">Quick Test Results</h3>
            <button type="button" class="modal-close-btn" onclick="closeQuickTestResults()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p class="text-sm text-gray-600 mb-4">
                Config: <strong id="qtrConfigName"></strong>
            </p>

            <!-- Status Badge -->
            <div class="mb-4" id="qtrStatusBadge"></div>

            <!-- Metrics -->
            <h4 class="font-medium text-gray-900 mb-3">Training Metrics</h4>
            <div id="qtrMetrics" class="mb-4">
                <!-- Populated by JavaScript -->
            </div>

            <!-- Vocabulary Stats (if available) -->
            <div id="qtrVocabSection" class="hidden">
                <h4 class="font-medium text-gray-900 mb-3">Vocabulary Statistics</h4>
                <div id="qtrVocabStats" class="text-sm">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Error Section (if failed) -->
            <div id="qtrErrorSection" class="hidden bg-red-50 rounded-lg p-4">
                <h4 class="font-medium text-red-900 mb-2">Error Details</h4>
                <p class="text-sm text-red-700" id="qtrErrorMessage"></p>
            </div>

            <!-- Duration -->
            <div class="mt-4 text-sm text-gray-500">
                Duration: <span id="qtrDuration">-</span>
            </div>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left">
                <a href="#" id="qtrVertexLink" target="_blank" class="text-sm text-blue-600 hover:text-blue-800">
                    <i class="fas fa-external-link-alt mr-1"></i>View in Vertex AI
                </a>
            </div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-secondary" onclick="closeQuickTestResults()">
                    <span class="btn-neu-inner">Close</span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
const modelId = {{ model.id }};
let allConfigs = [];
let allDatasets = [];
let currentStep = 1;
let editingConfigId = null;
let searchTimeout = null;
let isLoadingConfigForEdit = false;

// Current feature config state
let configState = {
    name: '',
    description: '',
    datasetId: null,
    startFrom: 'blank',
    cloneFromId: null,
    // Primary ID features (required before adding other features)
    customerIdFeature: null,  // Primary ID for BuyerModel
    productIdFeature: null,   // Primary ID for ProductModel
    // Additional features (unlocked after primary ID is set)
    buyerFeatures: [],
    productFeatures: [],
    buyerCrosses: [],
    productCrosses: [],
    availableColumns: [],
    sampleRows: [],
    columnOrder: []
};

// Currently editing feature
let editingFeature = null;
let editingFeatureModel = null;
let crossFeatureModel = null;

// =============================================================================
// CSRF TOKEN HELPER
// =============================================================================

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// =============================================================================
// INITIALIZATION
// =============================================================================

document.addEventListener('DOMContentLoaded', function() {
    loadDatasets();
    loadConfigs();
    loadModelConfigs();
});

function loadDatasets() {
    fetch(`/api/models/${modelId}/modeling/datasets/`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                allDatasets = data.data;
                populateDatasetFilters();
            }
        })
        .catch(err => console.error('Error loading datasets:', err));
}

function loadConfigs() {
    document.getElementById('configsLoading').classList.remove('hidden');
    document.getElementById('configsEmpty').classList.add('hidden');

    const datasetId = document.getElementById('datasetFilter').value;

    let url = `/api/models/${modelId}/feature-configs/?`;
    if (datasetId) url += `dataset_id=${datasetId}&`;

    fetch(url)
        .then(r => r.json())
        .then(data => {
            document.getElementById('configsLoading').classList.add('hidden');
            if (data.success) {
                allConfigs = data.data;
                renderConfigs();
            } else {
                showError(data.error || 'Failed to load configs');
            }
        })
        .catch(err => {
            document.getElementById('configsLoading').classList.add('hidden');
            console.error('Error loading configs:', err);
            showError('Failed to load feature configs');
        });
}

function populateDatasetFilters() {
    const filterSelect = document.getElementById('datasetFilter');
    const wizardSelect = document.getElementById('configDataset');

    // Clear existing options (except first)
    filterSelect.innerHTML = '<option value="">All Datasets</option>';
    wizardSelect.innerHTML = '<option value="">Select a dataset...</option>';

    allDatasets.forEach(ds => {
        const opt1 = document.createElement('option');
        opt1.value = ds.id;
        opt1.textContent = ds.name;
        filterSelect.appendChild(opt1);

        const opt2 = document.createElement('option');
        opt2.value = ds.id;
        opt2.textContent = ds.name;
        wizardSelect.appendChild(opt2);
    });
}

// =============================================================================
// RENDER CONFIGS LIST
// =============================================================================

function renderConfigs() {
    const container = document.getElementById('configsList');
    const emptyState = document.getElementById('configsEmpty');
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();

    // Filter by search
    let filtered = allConfigs;
    if (searchTerm) {
        filtered = allConfigs.filter(c =>
            c.name.toLowerCase().includes(searchTerm) ||
            (c.description && c.description.toLowerCase().includes(searchTerm))
        );
    }

    // Remove old cards
    container.querySelectorAll('.config-card').forEach(el => el.remove());

    if (filtered.length === 0) {
        emptyState.classList.remove('hidden');
        return;
    }

    emptyState.classList.add('hidden');

    filtered.forEach(config => {
        const card = createConfigCard(config);
        container.appendChild(card);
    });
}

function createConfigCard(config) {
    const card = document.createElement('div');
    card.className = 'config-card bg-white border border-gray-200 rounded-lg p-4 hover:border-gray-300';

    // Calculate tensor breakdowns from feature arrays
    const buyerResult = calculateTensorBreakdown(
        config.buyer_model_features || [],
        config.buyer_model_crosses || []
    );
    const productResult = calculateTensorBreakdown(
        config.product_model_features || [],
        config.product_model_crosses || []
    );

    const buyerDim = buyerResult.total || config.buyer_tensor_dim || 0;
    const productDim = productResult.total || config.product_tensor_dim || 0;

    const leakageWarning = config.columns_in_both_models && config.columns_in_both_models.length > 0
        ? `<span class="leakage-warning"><i class="fas fa-exclamation-triangle"></i>${config.columns_in_both_models.length} shared</span>`
        : '';

    const cardId = `config-${config.id}`;

    card.innerHTML = `
        <div class="flex items-start justify-between mb-2">
            <div class="flex items-center gap-2">
                <h3 class="font-semibold text-gray-900">${escapeHtml(config.name)}</h3>
                ${leakageWarning}
            </div>
            <div class="flex items-center gap-2">
                <button onclick="viewConfig(${config.id})" class="card-action-btn view" title="View feature set">
                    View
                </button>
                <button onclick="editConfig(${config.id})" class="card-action-btn edit" title="Edit feature set">
                    <i class="fas fa-external-link-alt"></i>
                </button>
                <button onclick="deleteConfig(${config.id}, '${escapeHtml(config.name)}')" class="card-action-btn delete" title="Delete feature set">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        <div class="flex items-center gap-3 text-xs text-gray-500 mb-2">
            <span>Dataset: ${escapeHtml(config.dataset_name)}</span>
            <span>Set version: ${config.version}</span>
            <span>Updated ${formatTimeAgo(config.updated_at)}${config.created_by ? ` by ${config.created_by}` : ''}</span>
        </div>
        ${config.description ? `<p class="text-sm text-gray-600 mb-3">${escapeHtml(config.description.length > 80 ? config.description.substring(0, 80) + '...' : config.description)}</p>` : ''}

        <div class="grid grid-cols-2 gap-4 mb-3">
            <div>
                <div class="flex items-center justify-between text-xs mb-1">
                    <span class="text-gray-500">Buyer Tensor</span>
                    <span class="font-semibold text-blue-600">${buyerDim}D</span>
                </div>
                <div id="${cardId}-buyer-bar" class="tensor-breakdown-bar"></div>
                <div class="text-xs text-gray-400 mt-1">${config.buyer_features_count || 0} features, ${config.buyer_crosses_count || 0} crosses</div>
            </div>
            <div>
                <div class="flex items-center justify-between text-xs mb-1">
                    <span class="text-gray-500">Product Tensor</span>
                    <span class="font-semibold text-green-600">${productDim}D</span>
                </div>
                <div id="${cardId}-product-bar" class="tensor-breakdown-bar"></div>
                <div class="text-xs text-gray-400 mt-1">${config.product_features_count || 0} features, ${config.product_crosses_count || 0} crosses</div>
            </div>
        </div>

        <div class="flex items-center gap-2 mt-3 pt-3 border-t border-gray-100">
            <button onclick="cloneConfig(${config.id})" class="btn btn-secondary btn-sm" style="width: 150px;">
                <i class="fas fa-copy"></i>Clone
            </button>
            <button onclick="viewTransformCode(${config.id}, '${escapeHtml(config.name)}')" class="btn btn-secondary btn-sm" style="width: 150px;" title="View generated TFX code">
                <i class="fas fa-code"></i>Code
            </button>
        </div>
    `;

    // Render tensor visualizations after card is in DOM (bars only, no breakdown tags)
    setTimeout(() => {
        const buyerBar = document.getElementById(`${cardId}-buyer-bar`);
        const productBar = document.getElementById(`${cardId}-product-bar`);

        if (buyerBar && buyerResult.breakdown.length > 0) {
            renderTensorPreview('buyer', buyerResult.total, buyerResult.breakdown, buyerBar, null);
        }
        if (productBar && productResult.breakdown.length > 0) {
            renderTensorPreview('product', productResult.total, productResult.breakdown, productBar, null);
        }
    }, 0);

    return card;
}

// =============================================================================
// WIZARD FUNCTIONS
// =============================================================================

function openWizard(configId = null) {
    editingConfigId = configId;
    currentStep = 1;

    // Reset state
    configState = {
        name: '',
        description: '',
        datasetId: null,
        startFrom: 'blank',
        cloneFromId: null,
        customerIdFeature: null,
        productIdFeature: null,
        buyerFeatures: [],
        productFeatures: [],
        buyerCrosses: [],
        productCrosses: [],
        availableColumns: [],
        sampleRows: [],
        columnOrder: []
    };

    // Reset form
    document.getElementById('configName').value = '';
    document.getElementById('configDescription').value = '';
    document.getElementById('configDataset').value = '';
    document.getElementById('datasetInfo').classList.add('hidden');
    document.querySelector('input[name="startFrom"][value="blank"]').checked = true;
    document.getElementById('cloneSelection').classList.add('hidden');

    // Update UI
    document.getElementById('wizardTitle').textContent = configId ? 'Edit Feature Config' : 'Create Feature Config';
    updateWizardStep();

    // Show modal
    document.getElementById('featureConfigWizardModal').classList.remove('hidden');

    // If editing, load config data
    if (configId) {
        loadConfigForEdit(configId);
    }
}

function closeWizard() {
    document.getElementById('featureConfigWizardModal').classList.add('hidden');
    editingConfigId = null;
}

function loadConfigForEdit(configId) {
    isLoadingConfigForEdit = true;
    updateEditLoadingState();

    fetch(`/api/feature-configs/${configId}/`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const config = data.data;
                document.getElementById('configName').value = config.name;
                document.getElementById('configDescription').value = config.description || '';
                document.getElementById('configDataset').value = config.dataset_id;

                configState.name = config.name;
                configState.description = config.description || '';
                configState.datasetId = config.dataset_id;

                // Extract primary ID features from the features arrays
                // Assume first feature with is_primary_id flag is the primary ID
                const buyerFeatures = config.buyer_model_features || [];
                const productFeatures = config.product_model_features || [];

                // Find and extract primary ID features
                const buyerPrimaryIdx = buyerFeatures.findIndex(f => f.is_primary_id);
                if (buyerPrimaryIdx !== -1) {
                    configState.customerIdFeature = buyerFeatures[buyerPrimaryIdx];
                    configState.buyerFeatures = buyerFeatures.filter((_, idx) => idx !== buyerPrimaryIdx);
                } else {
                    configState.buyerFeatures = buyerFeatures;
                }

                const productPrimaryIdx = productFeatures.findIndex(f => f.is_primary_id);
                if (productPrimaryIdx !== -1) {
                    configState.productIdFeature = productFeatures[productPrimaryIdx];
                    configState.productFeatures = productFeatures.filter((_, idx) => idx !== productPrimaryIdx);
                } else {
                    configState.productFeatures = productFeatures;
                }

                configState.buyerCrosses = config.buyer_model_crosses || [];
                configState.productCrosses = config.product_model_crosses || [];

                onDatasetChange();
            }
        })
        .finally(() => {
            isLoadingConfigForEdit = false;
            updateEditLoadingState();
        });
}

function showWizardLoading(show, text = 'Loading...') {
    const loadingOverlay = document.getElementById('wizardLoadingOverlay');
    const loadingText = document.getElementById('wizardLoadingText');
    const nextBtn = document.getElementById('nextBtn');
    const saveBtn = document.getElementById('saveBtn');

    if (loadingOverlay) {
        loadingOverlay.style.display = show ? 'block' : 'none';
    }
    if (loadingText) {
        loadingText.textContent = text;
    }
    if (nextBtn) {
        nextBtn.disabled = show;
        nextBtn.style.opacity = show ? '0.5' : '1';
    }
    if (saveBtn) {
        saveBtn.disabled = show;
        saveBtn.style.opacity = show ? '0.5' : '1';
    }
}

function updateEditLoadingState() {
    showWizardLoading(isLoadingConfigForEdit, 'Loading config data...');
}

function updateWizardStep() {
    // Update step visibility
    document.getElementById('wizardStep1').classList.toggle('hidden', currentStep !== 1);
    document.getElementById('wizardStep1').classList.toggle('active', currentStep === 1);
    document.getElementById('wizardStep2').classList.toggle('hidden', currentStep !== 2);
    document.getElementById('wizardStep2').classList.toggle('active', currentStep === 2);

    // Update progress pills - use completed/current/future classes
    for (let i = 1; i <= 2; i++) {
        const pill = document.getElementById(`progress${i}`);
        pill.classList.remove('current', 'completed', 'future');
        if (i < currentStep) {
            pill.classList.add('completed');
        } else if (i === currentStep) {
            pill.classList.add('current');
        } else {
            pill.classList.add('future');
        }
    }

    // Update buttons
    document.getElementById('backBtn').classList.toggle('hidden', currentStep === 1);
    document.getElementById('nextBtn').classList.toggle('hidden', currentStep === 2);
    document.getElementById('saveBtn').classList.toggle('hidden', currentStep !== 2);

    // Update step counter
    document.getElementById('currentStep').textContent = currentStep;
}

function nextStep() {
    // Block navigation while loading config data
    if (isLoadingConfigForEdit) {
        return;
    }

    if (currentStep === 1) {
        // Validate step 1
        const name = document.getElementById('configName').value.trim();
        const datasetId = document.getElementById('configDataset').value;

        if (!name) {
            document.getElementById('nameError').textContent = 'Name is required';
            document.getElementById('nameError').classList.remove('hidden');
            return;
        }
        if (!datasetId) {
            showError('Please select a dataset');
            return;
        }

        configState.name = name;
        configState.description = document.getElementById('configDescription').value.trim();
        configState.datasetId = parseInt(datasetId);
        configState.startFrom = document.querySelector('input[name="startFrom"]:checked').value;

        // Load columns and initialize step 2
        loadColumnsForStep2();

        currentStep = 2;
        updateWizardStep();
    }
}

function prevStep() {
    if (currentStep > 1) {
        currentStep--;
        updateWizardStep();
    }
}

function validateConfigName() {
    document.getElementById('nameError').classList.add('hidden');
}

function onDatasetChange() {
    const datasetId = document.getElementById('configDataset').value;
    const datasetInfo = document.getElementById('datasetInfo');

    if (datasetId) {
        const dataset = allDatasets.find(d => d.id == datasetId);
        if (dataset) {
            const rowsText = dataset.total_rows != null
                ? dataset.total_rows.toLocaleString() + ' rows'
                : 'Unknown rows';
            const colsText = dataset.column_count != null
                ? dataset.column_count + ' columns'
                : '? columns';
            document.getElementById('datasetInfoText').textContent = `${rowsText} | ${colsText}`;
            datasetInfo.classList.remove('hidden');
        }
        loadCloneOptions(datasetId);
    } else {
        datasetInfo.classList.add('hidden');
    }
}

function onStartFromChange() {
    const startFrom = document.querySelector('input[name="startFrom"]:checked').value;
    document.getElementById('cloneSelection').classList.toggle('hidden', startFrom !== 'clone');
}

function loadCloneOptions(datasetId) {
    const select = document.getElementById('cloneFromConfig');
    select.innerHTML = '<option value="">Select a config to clone...</option>';

    allConfigs.filter(c => c.dataset_id == datasetId).forEach(config => {
        const opt = document.createElement('option');
        opt.value = config.id;
        opt.textContent = `${config.name} (${config.buyer_tensor_dim || 0}D + ${config.product_tensor_dim || 0}D)`;
        select.appendChild(opt);
    });
}

// =============================================================================
// STEP 2: FEATURE ASSIGNMENT
// =============================================================================

function showStep2Loading(show) {
    showWizardLoading(show, 'Loading feature data...');
}

function loadColumnsForStep2() {
    const datasetId = configState.datasetId;
    const startFrom = configState.startFrom;

    // Show loading spinner
    showStep2Loading(true);

    // Use new schema-with-sample endpoint for accurate types and sample data
    fetch(`/api/datasets/${datasetId}/schema-with-sample/`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                configState.availableColumns = data.data.columns;
                configState.sampleRows = data.data.sample_rows || [];
                configState.columnOrder = data.data.column_order || [];

                // Handle start from options
                if (startFrom === 'clone') {
                    const cloneFromId = document.getElementById('cloneFromConfig').value;
                    if (cloneFromId) {
                        loadCloneData(cloneFromId);
                    } else {
                        renderStep2();
                        showStep2Loading(false);
                    }
                } else {
                    renderStep2();
                    showStep2Loading(false);
                }
            } else {
                console.error('Failed to load schema:', data.error);
                showError('Failed to load column schema');
                showStep2Loading(false);
            }
        })
        .catch(err => {
            console.error('Error loading schema:', err);
            showError('Error loading column schema');
            showStep2Loading(false);
        });
}

function loadCloneData(configId) {
    fetch(`/api/feature-configs/${configId}/`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const buyerFeatures = data.data.buyer_model_features || [];
                const productFeatures = data.data.product_model_features || [];

                // Find and extract primary ID features
                const buyerPrimaryIdx = buyerFeatures.findIndex(f => f.is_primary_id);
                if (buyerPrimaryIdx !== -1) {
                    configState.customerIdFeature = buyerFeatures[buyerPrimaryIdx];
                    configState.buyerFeatures = buyerFeatures.filter((_, idx) => idx !== buyerPrimaryIdx);
                } else {
                    configState.buyerFeatures = buyerFeatures;
                }

                const productPrimaryIdx = productFeatures.findIndex(f => f.is_primary_id);
                if (productPrimaryIdx !== -1) {
                    configState.productIdFeature = productFeatures[productPrimaryIdx];
                    configState.productFeatures = productFeatures.filter((_, idx) => idx !== productPrimaryIdx);
                } else {
                    configState.productFeatures = productFeatures;
                }

                configState.buyerCrosses = data.data.buyer_model_crosses || [];
                configState.productCrosses = data.data.product_model_crosses || [];
                renderStep2();
                showStep2Loading(false);
            } else {
                showStep2Loading(false);
            }
        })
        .catch(err => {
            console.error('Error loading clone data:', err);
            showStep2Loading(false);
        });
}

function renderStep2() {
    renderAvailableColumns();
    renderSampleTable();
    renderPrimaryIdZone('buyer');
    renderPrimaryIdZone('product');
    renderAssignedFeatures('buyer');
    renderAssignedFeatures('product');
    updateAdditionalFeaturesLockState();
    updateTensorPreview();
    updateSubchapterStatuses();
}

// Render the primary ID zone (Customer ID or Product ID)
function renderPrimaryIdZone(model) {
    const idFeature = model === 'buyer' ? configState.customerIdFeature : configState.productIdFeature;
    const contentContainer = document.getElementById(model === 'buyer' ? 'customerIdContent' : 'productIdContent');
    const idLabel = model === 'buyer' ? 'Customer ID' : 'Product ID';

    if (!idFeature) {
        // Empty state - show drop prompt
        contentContainer.innerHTML = `
            <div class="primary-id-zone-empty">
                <i class="fas fa-arrow-down"></i>
                <span>Drag a column here to set as ${idLabel}</span>
            </div>
        `;
    } else {
        // Assigned state - show the feature card
        const embedDim = idFeature.transforms?.embedding?.embedding_dim || 32;
        contentContainer.innerHTML = `
            <div class="primary-id-assigned">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <div class="font-medium text-sm">${escapeHtml(idFeature.column)}</div>
                        <div class="text-xs text-gray-500">
                            ${idFeature.bq_type || 'STRING'} → Text • Embed: ${embedDim}D
                        </div>
                    </div>
                    <div class="flex flex-col gap-1 ml-2">
                        <button type="button" class="feature-config-btn settings" onclick="openPrimaryIdConfig('${model}')" title="Configure embedding">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button type="button" class="feature-config-btn remove" onclick="removePrimaryId('${model}')" title="Remove">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
}

// Update lock state of additional features sections
function updateAdditionalFeaturesLockState() {
    const buyerSection = document.getElementById('buyerAdditionalSection');
    const productSection = document.getElementById('productAdditionalSection');
    const buyerLockedMsg = document.getElementById('buyerLockedMessage');
    const productLockedMsg = document.getElementById('productLockedMessage');

    // Buyer model: unlocked if customerIdFeature is set
    if (configState.customerIdFeature) {
        buyerSection.classList.remove('locked');
        buyerLockedMsg.style.display = 'none';
    } else {
        buyerSection.classList.add('locked');
        buyerLockedMsg.style.display = 'flex';
    }

    // Product model: unlocked if productIdFeature is set
    if (configState.productIdFeature) {
        productSection.classList.remove('locked');
        productLockedMsg.style.display = 'none';
    } else {
        productSection.classList.add('locked');
        productLockedMsg.style.display = 'flex';
    }
}

function toggleModelingSubchapter(name) {
    const content = document.getElementById(`${name}Content`);
    const chevron = document.getElementById(`${name}Chevron`);

    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        chevron.classList.remove('fa-chevron-right');
        chevron.classList.add('fa-chevron-down');
    } else {
        content.classList.add('hidden');
        chevron.classList.remove('fa-chevron-down');
        chevron.classList.add('fa-chevron-right');
    }
}

function updateSubchapterStatuses() {
    // Update Dataset Sample status
    const sampleStatus = document.getElementById('datasetSampleStatus');
    const sampleRows = configState.sampleRows || [];
    if (sampleStatus) {
        sampleStatus.textContent = sampleRows.length > 0 ? `${sampleRows.length} rows` : '';
    }

    // Update Available Columns status
    const columnsStatus = document.getElementById('availableColumnsStatus');
    const totalCols = configState.availableColumns.length;
    const buyerCount = configState.buyerFeatures.length;
    const productCount = configState.productFeatures.length;

    if (columnsStatus) {
        if (buyerCount > 0 || productCount > 0) {
            columnsStatus.textContent = `${buyerCount} buyer, ${productCount} product`;
        } else {
            columnsStatus.textContent = totalCols > 0 ? `${totalCols} columns` : '';
        }
    }
}

function renderAvailableColumns() {
    const container = document.getElementById('availableColumns');
    container.innerHTML = '';

    // Get assigned column names by model (including primary IDs)
    const buyerCols = new Set(configState.buyerFeatures.map(f => f.column));
    const productCols = new Set(configState.productFeatures.map(f => f.column));

    // Add primary ID columns to the sets
    if (configState.customerIdFeature) {
        buyerCols.add(configState.customerIdFeature.column);
    }
    if (configState.productIdFeature) {
        productCols.add(configState.productIdFeature.column);
    }

    configState.availableColumns.forEach(col => {
        const inBuyer = buyerCols.has(col.name);
        const inProduct = productCols.has(col.name);

        const card = document.createElement('div');
        card.className = 'column-card';

        // Add assignment state classes
        if (inBuyer && inProduct) {
            card.classList.add('assigned-both');
        } else if (inBuyer) {
            card.classList.add('assigned-buyer');
        } else if (inProduct) {
            card.classList.add('assigned-product');
        }

        // Only allow dragging if not assigned to both models
        const canDrag = !(inBuyer && inProduct);
        card.draggable = canDrag;
        card.dataset.column = JSON.stringify(col);
        if (canDrag) {
            card.ondragstart = (e) => dragStart(e, col);
            card.ondragend = dragEnd;
        }

        // Simple layout: drag handle | name | BQ type badge
        card.innerHTML = `
            <i class="fas fa-grip-vertical drag-handle"></i>
            <span class="column-name" title="${escapeHtml(col.name)}">${escapeHtml(col.name)}</span>
            <span class="column-bq-type">${formatBqType(col.bq_type || 'STRING')}</span>
        `;

        container.appendChild(card);
    });
}

function formatBqType(bqType) {
    // Format BigQuery types to shorter display names
    const typeMap = {
        'STRING': 'STR',
        'INTEGER': 'INT',
        'INT64': 'INT',
        'FLOAT': 'FLOAT',
        'FLOAT64': 'FLOAT',
        'NUMERIC': 'NUM',
        'BIGNUMERIC': 'NUM',
        'BOOLEAN': 'BOOL',
        'BOOL': 'BOOL',
        'TIMESTAMP': 'TIME',
        'DATETIME': 'TIME',
        'DATE': 'DATE',
        'TIME': 'TIME',
        'BYTES': 'BYTES',
    };
    return typeMap[bqType?.toUpperCase()] || bqType || 'STR';
}

// Data Type System
// Three main data types: numeric, text, temporal
const DATA_TYPES = {
    numeric: { label: 'Numeric', icon: 'hashtag' },
    text: { label: 'Text', icon: 'font' },
    temporal: { label: 'Temporal', icon: 'calendar' }
};

function getDataTypeLabel(dataType) {
    return DATA_TYPES[dataType]?.label || dataType;
}

function getDataTypeFromBqType(bqType) {
    // Map BigQuery type to our data type system
    const type = (bqType || 'STRING').toUpperCase();

    if (['INTEGER', 'INT64', 'FLOAT', 'FLOAT64', 'NUMERIC', 'BIGNUMERIC'].includes(type)) {
        return 'numeric';
    } else if (['TIMESTAMP', 'DATETIME', 'DATE', 'TIME'].includes(type)) {
        return 'temporal';
    } else {
        // STRING, BYTES, etc.
        return 'text';
    }
}

function getTransformOptionsForDataType(dataType) {
    // Return available transforms based on data type
    switch (dataType) {
        case 'numeric':
            return [
                { key: 'normalize', label: 'Normalize', desc: 'Scale to [-1, 1] range', outputDim: 1 },
                { key: 'bucketize', label: 'Bucketize', desc: 'Discretize into buckets + embed', outputDim: 'configurable' }
            ];
        case 'text':
            return [
                { key: 'embedding', label: 'Embedding', desc: 'Learn vector representation', outputDim: 'configurable' }
            ];
        case 'temporal':
            return [
                { key: 'normalize', label: 'Normalize', desc: 'Scale timestamp to [-1, 1]', outputDim: 1 },
                { key: 'cyclical', label: 'Cyclical', desc: 'Extract periodic patterns (month, week, etc.)', outputDim: 'varies' },
                { key: 'bucketize', label: 'Bucketize', desc: 'Discretize into time buckets + embed', outputDim: 'configurable' }
            ];
        default:
            return [];
    }
}

function updateFeatureDataType(model, idx, newDataType) {
    const features = model === 'buyer' ? configState.buyerFeatures : configState.productFeatures;
    if (features[idx]) {
        features[idx].data_type = newDataType;
        // Clear transforms when data type changes - user must reconfigure
        features[idx].transforms = {};
    }
    renderStep2();
}

function getFeatureDisplayInfo(feature) {
    // Returns display string showing data type and transform output
    const dataType = feature.data_type || getDataTypeFromBqType(feature.bq_type);
    const dataTypeLabel = getDataTypeLabel(dataType);
    const transforms = feature.transforms || {};

    // Calculate total output dimension
    let outputParts = [];
    let totalDim = 0;

    if (dataType === 'numeric') {
        if (transforms.normalize?.enabled) {
            outputParts.push('Norm: 1D');
            totalDim += 1;
        }
        if (transforms.bucketize?.enabled) {
            const dim = transforms.bucketize.embedding_dim || 32;
            outputParts.push(`Bucket: ${dim}D`);
            totalDim += dim;
        }
    } else if (dataType === 'text') {
        if (transforms.embedding?.enabled) {
            const dim = transforms.embedding.embedding_dim || 32;
            outputParts.push(`Embed: ${dim}D`);
            totalDim += dim;
        }
    } else if (dataType === 'temporal') {
        if (transforms.normalize?.enabled) {
            outputParts.push('Norm: 1D');
            totalDim += 1;
        }
        if (transforms.cyclical?.enabled) {
            const cyclical = transforms.cyclical;
            let cyclicalDim = 0;
            if (cyclical.yearly || cyclical.annual) cyclicalDim += 2;
            if (cyclical.quarterly) cyclicalDim += 2;
            if (cyclical.monthly) cyclicalDim += 2;
            if (cyclical.weekly) cyclicalDim += 2;
            if (cyclical.daily) cyclicalDim += 2;
            if (cyclicalDim > 0) {
                outputParts.push(`Cyclical: ${cyclicalDim}D`);
                totalDim += cyclicalDim;
            }
        }
        if (transforms.bucketize?.enabled) {
            const dim = transforms.bucketize.embedding_dim || 32;
            outputParts.push(`Bucket: ${dim}D`);
            totalDim += dim;
        }
    }

    const transformStr = outputParts.length > 0
        ? outputParts.join(' + ')
        : 'No transform selected';

    return {
        dataTypeLabel,
        transformStr,
        totalDim,
        hasTransforms: outputParts.length > 0
    };
}

function renderSampleTable() {
    const container = document.getElementById('sampleDataTable');
    const rows = configState.sampleRows || [];
    const columns = configState.columnOrder || [];

    if (rows.length === 0 || columns.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-sm p-4">No sample data available</p>';
        return;
    }

    // Get assignment status for each column (including primary IDs)
    const buyerCols = new Set(configState.buyerFeatures.map(f => f.column));
    const productCols = new Set(configState.productFeatures.map(f => f.column));

    // Add primary ID columns
    if (configState.customerIdFeature) {
        buyerCols.add(configState.customerIdFeature.column);
    }
    if (configState.productIdFeature) {
        productCols.add(configState.productIdFeature.column);
    }

    let html = `
        <div class="sample-table-wrapper">
            <table class="sample-table">
                <thead>
                    <tr>
                        ${columns.map(col => {
                            let headerClass = '';
                            const inBuyer = buyerCols.has(col);
                            const inProduct = productCols.has(col);

                            if (inBuyer && inProduct) {
                                headerClass = 'col-both';
                            } else if (inBuyer) {
                                headerClass = 'col-buyer';
                            } else if (inProduct) {
                                headerClass = 'col-product';
                            }

                            return `<th class="${headerClass}">${escapeHtml(col)}</th>`;
                        }).join('')}
                    </tr>
                </thead>
                <tbody>
                    ${rows.slice(0, 10).map(row => `
                        <tr>
                            ${columns.map(col => {
                                let cellClass = '';
                                const inBuyer = buyerCols.has(col);
                                const inProduct = productCols.has(col);

                                if (inBuyer && inProduct) {
                                    cellClass = 'col-both';
                                } else if (inBuyer) {
                                    cellClass = 'col-buyer';
                                } else if (inProduct) {
                                    cellClass = 'col-product';
                                }

                                const val = row[col];
                                const displayVal = val === null || val === undefined
                                    ? '<span class="null-value">NULL</span>'
                                    : escapeHtml(String(val));
                                return `<td class="${cellClass}">${displayVal}</td>`;
                            }).join('')}
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;

    container.innerHTML = html;
}

function renderAssignedFeatures(model) {
    const features = model === 'buyer' ? configState.buyerFeatures : configState.productFeatures;
    const crosses = model === 'buyer' ? configState.buyerCrosses : configState.productCrosses;
    const container = document.getElementById(`${model}ModelFeatures`);
    const crossContainer = document.getElementById(`${model}ModelCrosses`);
    const addCrossBtn = document.getElementById(`add${model.charAt(0).toUpperCase() + model.slice(1)}CrossBtn`);

    container.innerHTML = '';
    crossContainer.innerHTML = '';

    // Show/hide cross feature button based on whether there are features
    // (including primary ID feature)
    const hasPrimaryId = model === 'buyer' ? configState.customerIdFeature : configState.productIdFeature;
    const hasFeatures = features.length > 0 || hasPrimaryId;

    if (hasFeatures) {
        addCrossBtn.style.display = 'inline-flex';

        features.forEach((feature, idx) => {
            const el = createAssignedFeatureElement(feature, model, idx);
            container.appendChild(el);
        });
    } else {
        addCrossBtn.style.display = 'none';
    }

    crosses.forEach((cross, idx) => {
        const el = createCrossFeatureElement(cross, model, idx);
        crossContainer.appendChild(el);
    });
}

function createAssignedFeatureElement(feature, model, idx) {
    const div = document.createElement('div');

    // Get display info
    const displayInfo = getFeatureDisplayInfo(feature);
    const bqType = feature.bq_type || 'STRING';

    // Apply warning class to the outer div if no transforms selected
    div.className = displayInfo.hasTransforms ? 'assigned-feature' : 'assigned-feature feature-needs-config';

    div.innerHTML = `
        <div class="flex items-center justify-between">
            <div class="flex-1">
                <div class="font-medium text-sm">${escapeHtml(feature.column)}</div>
                <div class="text-xs ${displayInfo.hasTransforms ? 'text-gray-500' : 'text-amber-600'}">
                    ${bqType} → ${displayInfo.dataTypeLabel} • ${displayInfo.transformStr}
                </div>
            </div>
            <div class="flex flex-col gap-1 ml-2">
                <button type="button" class="feature-config-btn settings ${displayInfo.hasTransforms ? '' : 'needs-attention'}" onclick="openFeatureConfig('${model}', ${idx})" title="Configure transforms">
                    <i class="fas fa-cog"></i>
                </button>
                <button type="button" class="feature-config-btn remove" onclick="removeFeature('${model}', ${idx})" title="Remove">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
        </div>
    `;

    return div;
}

function getCrossFeatureNames(cross) {
    // Handle both old format (array of strings) and new format (array of objects)
    if (!cross.features || cross.features.length === 0) return [];
    if (typeof cross.features[0] === 'string') {
        return cross.features;
    }
    return cross.features.map(f => f.column);
}

function getCrossFeatureDetails(cross) {
    // Build detailed description including bucket info for numeric/temporal
    if (!cross.features || cross.features.length === 0) return '';
    if (typeof cross.features[0] === 'string') {
        return ''; // Old format, no bucket details
    }

    const details = cross.features
        .filter(f => f.crossing_buckets)
        .map(f => `${f.column}: ${f.crossing_buckets} buckets`);

    return details.length > 0 ? details.join(', ') : '';
}

function createCrossFeatureElement(cross, model, idx) {
    const div = document.createElement('div');
    div.className = 'cross-feature';

    const featureNames = getCrossFeatureNames(cross);
    const bucketDetails = getCrossFeatureDetails(cross);

    div.innerHTML = `
        <div class="flex items-center justify-between">
            <div>
                <div class="font-medium text-sm">${featureNames.join(' × ')}</div>
                <div class="text-xs text-gray-500">
                    Hash: ${cross.hash_bucket_size.toLocaleString()} → ${cross.embedding_dim}D
                    ${bucketDetails ? `<br><span class="text-blue-600">${bucketDetails}</span>` : ''}
                </div>
            </div>
            <button type="button" class="feature-config-btn remove" onclick="removeCross('${model}', ${idx})">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;

    return div;
}

function getFeatureDimString(feature) {
    const parts = [];
    if (feature.type === 'string_embedding') {
        parts.push(`Embedding: ${feature.embedding_dim || 32}D`);
    } else if (feature.type === 'numeric') {
        const t = feature.transforms || {};
        if (t.normalize?.enabled) parts.push('Norm: 1D');
        if (t.bucketize?.enabled) parts.push(`Bucket: ${t.bucketize.embedding_dim || 32}D`);
    } else if (feature.type === 'timestamp') {
        const t = feature.transforms || {};
        if (t.normalize?.enabled) parts.push('Norm: 1D');
        const cyclical = t.cyclical || {};
        const cycles = ['yearly', 'annual', 'quarterly', 'monthly', 'weekly', 'daily'].filter(c => cyclical[c]).length;
        if (cycles > 0) parts.push(`Cyclical: ${cycles * 2}D`);
    }
    return parts.join(' + ') || 'Not configured';
}

// =============================================================================
// DRAG AND DROP
// =============================================================================

function dragStart(e, col) {
    e.target.classList.add('dragging');
    e.dataTransfer.setData('text/plain', JSON.stringify(col));
    e.dataTransfer.effectAllowed = 'move';
}

function dragEnd(e) {
    e.target.classList.remove('dragging');
}

function allowDrop(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
}

function dragEnter(e) {
    e.preventDefault();
    e.currentTarget.classList.add('drag-over');
}

function dragLeave(e) {
    e.currentTarget.classList.remove('drag-over');
}

function dropFeature(e, model) {
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');

    // Check if the model is unlocked (primary ID must be set first)
    const isUnlocked = model === 'buyer' ? configState.customerIdFeature : configState.productIdFeature;
    if (!isUnlocked) {
        return; // Can't drop if locked
    }

    const colData = JSON.parse(e.dataTransfer.getData('text/plain'));
    const feature = createDefaultFeature(colData);

    if (model === 'buyer') {
        configState.buyerFeatures.push(feature);
    } else {
        configState.productFeatures.push(feature);
    }

    renderStep2();
}

// =============================================================================
// PRIMARY ID DROP HANDLING
// =============================================================================

function dragEnterPrimaryId(e) {
    e.preventDefault();
    e.currentTarget.classList.add('drag-over');
}

function dragLeavePrimaryId(e) {
    e.currentTarget.classList.remove('drag-over');
}

function allowDropIfUnlocked(e, model) {
    const isUnlocked = model === 'buyer' ? configState.customerIdFeature : configState.productIdFeature;
    if (isUnlocked) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
    }
}

function dragEnterIfUnlocked(e, model) {
    const isUnlocked = model === 'buyer' ? configState.customerIdFeature : configState.productIdFeature;
    if (isUnlocked) {
        e.preventDefault();
        e.currentTarget.classList.add('drag-over');
    }
}

function dropPrimaryId(e, model) {
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');

    const colData = JSON.parse(e.dataTransfer.getData('text/plain'));

    // Create primary ID feature with forced text type and embedding transform
    const primaryIdFeature = {
        column: colData.name,
        bq_type: colData.bq_type || colData.type || 'STRING',
        data_type: 'text',  // Force to text regardless of original type
        is_primary_id: true,
        stats: colData.stats || {},
        transforms: {
            embedding: {
                enabled: true,
                embedding_dim: 32,  // Default 32D
                vocab_size: 100000
            }
        }
    };

    if (model === 'buyer') {
        configState.customerIdFeature = primaryIdFeature;
    } else {
        configState.productIdFeature = primaryIdFeature;
    }

    renderStep2();
}

function removePrimaryId(model) {
    if (model === 'buyer') {
        configState.customerIdFeature = null;
        // Also clear additional features since the model is now locked
        configState.buyerFeatures = [];
        configState.buyerCrosses = [];
    } else {
        configState.productIdFeature = null;
        // Also clear additional features since the model is now locked
        configState.productFeatures = [];
        configState.productCrosses = [];
    }
    renderStep2();
}

function openPrimaryIdConfig(model) {
    const feature = model === 'buyer' ? configState.customerIdFeature : configState.productIdFeature;
    if (!feature) return;

    editingFeature = {...feature, _model: model, _isPrimaryId: true};
    editingFeatureModel = model;

    const idLabel = model === 'buyer' ? 'Customer ID' : 'Product ID';
    document.getElementById('featureModalTitle').textContent = `Configure: ${idLabel}`;
    renderPrimaryIdConfigForm();
    document.getElementById('featureConfigModal').classList.remove('hidden');
}

function renderPrimaryIdConfigForm() {
    const body = document.getElementById('featureModalBody');
    const embedDim = editingFeature.transforms?.embedding?.embedding_dim || 32;
    const presetDims = [8, 16, 32, 64, 128, 256];
    const isCustom = !presetDims.includes(embedDim);

    body.innerHTML = `
        <div class="mb-4">
            <div class="text-sm text-gray-600 mb-2">
                <strong>Column:</strong> ${escapeHtml(editingFeature.column)}
            </div>
            <div class="text-sm text-gray-500">
                Original type: ${editingFeature.bq_type || 'STRING'} → <span class="text-blue-600 font-medium">Text (forced)</span>
            </div>
        </div>

        <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg mb-4">
            <div class="text-sm text-blue-800">
                <i class="fas fa-info-circle mr-2"></i>
                Primary ID columns use text embedding. Other transforms are not available.
            </div>
        </div>

        <div class="modal-form-group">
            <label class="modal-form-label">Embedding Dimension</label>
            <div class="flex gap-2 flex-wrap items-center justify-center">
                ${presetDims.map(dim => `
                    <button type="button"
                            class="primary-id-dim-btn px-3 py-2 rounded-lg border transition-all ${embedDim === dim && !isCustom
                                ? 'bg-blue-500 text-white border-blue-500'
                                : 'bg-white text-gray-700 border-gray-300 hover:border-blue-400'}"
                            onclick="selectPrimaryIdDim(${dim})">
                        ${dim}D
                    </button>
                `).join('')}
            </div>
            <div class="flex items-center gap-3 mt-3">
                <span class="text-sm text-gray-600">Custom:</span>
                <input type="number"
                       id="customEmbedDimInput"
                       class="form-input text-sm"
                       style="width: 100px;"
                       min="4"
                       max="1024"
                       step="1"
                       value="${isCustom ? embedDim : ''}"
                       placeholder="e.g. 512"
                       onchange="onCustomDimChange(this.value)"
                       oninput="onCustomDimInput(this.value)">
                <span class="text-xs text-gray-500">Range: 4 - 1024</span>
            </div>
            <p class="modal-form-hint mt-2">
                <i class="fas fa-lightbulb text-amber-500 mr-1"></i>
                Tip: Use larger dimensions (256-512) for millions of unique IDs, smaller (8-32) for few unique values
            </p>
        </div>

        <input type="hidden" id="primaryIdEmbedDim" value="${embedDim}">
    `;
}

function selectPrimaryIdDim(dim) {
    document.getElementById('primaryIdEmbedDim').value = dim;

    // Clear custom input when preset is selected
    const customInput = document.getElementById('customEmbedDimInput');
    if (customInput) {
        customInput.value = '';
    }

    // Update button styles
    const buttons = document.querySelectorAll('.primary-id-dim-btn');
    buttons.forEach(btn => {
        const btnDim = parseInt(btn.textContent);
        if (btnDim === dim) {
            btn.className = 'primary-id-dim-btn px-3 py-2 rounded-lg border transition-all bg-blue-500 text-white border-blue-500';
        } else {
            btn.className = 'primary-id-dim-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400';
        }
    });
}

function onCustomDimInput(value) {
    // Live update as user types - deselect preset buttons
    if (value) {
        const buttons = document.querySelectorAll('.primary-id-dim-btn');
        buttons.forEach(btn => {
            btn.className = 'primary-id-dim-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400';
        });
    }
}

function onCustomDimChange(value) {
    // Validate and set the custom dimension
    let dim = parseInt(value);
    if (isNaN(dim) || dim < 4) {
        dim = 4;
        document.getElementById('customEmbedDimInput').value = 4;
    } else if (dim > 1024) {
        dim = 1024;
        document.getElementById('customEmbedDimInput').value = 1024;
    }

    document.getElementById('primaryIdEmbedDim').value = dim;

    // Deselect all preset buttons
    const buttons = document.querySelectorAll('.primary-id-dim-btn');
    buttons.forEach(btn => {
        btn.className = 'primary-id-dim-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400';
    });
}

function applyPrimaryIdConfig() {
    const model = editingFeature._model;
    const newDim = parseInt(document.getElementById('primaryIdEmbedDim').value) || 32;

    if (model === 'buyer' && configState.customerIdFeature) {
        configState.customerIdFeature.transforms.embedding.embedding_dim = newDim;
    } else if (model === 'product' && configState.productIdFeature) {
        configState.productIdFeature.transforms.embedding.embedding_dim = newDim;
    }

    closeFeatureModal();
    renderStep2();
}

// =============================================================================
// TEXT EMBEDDING DIMENSION SELECTION (for context features)
// =============================================================================

function selectTextEmbedDim(dim) {
    document.getElementById('featureEmbedDim').value = dim;

    // Clear custom input when preset is selected
    const customInput = document.getElementById('customTextEmbedDimInput');
    if (customInput) {
        customInput.value = '';
    }

    // Update dimension label
    const dimLabel = document.getElementById('embeddingDimLabel');
    if (dimLabel) {
        dimLabel.textContent = `+${dim}D`;
    }

    // Update button styles
    const buttons = document.querySelectorAll('.text-embed-dim-btn');
    buttons.forEach(btn => {
        const btnDim = parseInt(btn.textContent);
        if (btnDim === dim) {
            btn.className = 'text-embed-dim-btn px-3 py-2 rounded-lg border transition-all bg-blue-500 text-white border-blue-500';
        } else {
            btn.className = 'text-embed-dim-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400';
        }
    });
}

function onCustomTextEmbedDimInput(value) {
    // Live update as user types - deselect preset buttons
    if (value) {
        const buttons = document.querySelectorAll('.text-embed-dim-btn');
        buttons.forEach(btn => {
            btn.className = 'text-embed-dim-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400';
        });
    }
}

function onCustomTextEmbedDimChange(value) {
    // Validate and set the custom dimension
    let dim = parseInt(value);
    if (isNaN(dim) || dim < 4) {
        dim = 4;
        document.getElementById('customTextEmbedDimInput').value = 4;
    } else if (dim > 1024) {
        dim = 1024;
        document.getElementById('customTextEmbedDimInput').value = 1024;
    }

    document.getElementById('featureEmbedDim').value = dim;

    // Update dimension label
    const dimLabel = document.getElementById('embeddingDimLabel');
    if (dimLabel) {
        dimLabel.textContent = `+${dim}D`;
    }

    // Deselect all preset buttons
    const buttons = document.querySelectorAll('.text-embed-dim-btn');
    buttons.forEach(btn => {
        btn.className = 'text-embed-dim-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400';
    });
}

function createDefaultFeature(col) {
    // Create feature with BQ type, but NO transforms applied
    // User must configure transforms via the settings modal
    const bqType = col.bq_type || col.type || 'STRING';
    const dataType = getDataTypeFromBqType(bqType);

    return {
        column: col.name,
        bq_type: bqType,
        data_type: dataType,  // Numeric, Text, or Temporal
        stats: col.stats || {},
        transforms: {}  // Empty - user must configure
    };
}

function detectCyclicalPeriod(col) {
    const colName = (col.name || '').toLowerCase();
    const min = col.stats?.min;
    const max = col.stats?.max;

    // Try to detect from column name
    if (colName.includes('hour')) return 24;
    if (colName.includes('day_of_week') || colName.includes('weekday')) return 7;
    if (colName.includes('month')) return 12;
    if (colName.includes('day_of_month') || colName.includes('day')) return 31;
    if (colName.includes('quarter')) return 4;

    // Try to detect from value range
    if (min !== undefined && max !== undefined) {
        if (min >= 0 && max <= 23) return 24;
        if (min >= 0 && max <= 6) return 7;
        if (min >= 1 && max <= 12) return 12;
        if (min >= 1 && max <= 31) return 31;
        if (min >= 1 && max <= 4) return 4;
    }

    return 12; // Default to monthly
}

function getRecommendedEmbedDim(cardinality) {
    if (cardinality < 50) return 8;
    if (cardinality < 500) return 16;
    if (cardinality < 5000) return 32;
    if (cardinality < 50000) return 64;
    if (cardinality < 500000) return 96;
    return 128;
}

function removeFeature(model, idx) {
    if (model === 'buyer') {
        configState.buyerFeatures.splice(idx, 1);
    } else {
        configState.productFeatures.splice(idx, 1);
    }
    renderStep2();
}

function removeCross(model, idx) {
    if (model === 'buyer') {
        configState.buyerCrosses.splice(idx, 1);
    } else {
        configState.productCrosses.splice(idx, 1);
    }
    renderStep2();
}

// =============================================================================
// TENSOR PREVIEW
// =============================================================================

/**
 * Calculate tensor breakdown from feature arrays
 * @param {Array} features - Array of feature objects
 * @param {Array} crosses - Array of cross feature objects
 * @returns {Object} { total: number, breakdown: Array<{name, dim, is_cross?}> }
 */
function calculateTensorBreakdown(features, crosses) {
    const breakdown = [];
    let total = 0;

    // Process features
    (features || []).forEach(feature => {
        const info = getFeatureDisplayInfo(feature);
        if (info.totalDim > 0) {
            breakdown.push({ name: feature.column, dim: info.totalDim });
            total += info.totalDim;
        }
    });

    // Process cross features
    (crosses || []).forEach(cross => {
        const dim = cross.embedding_dim || 16;
        const featureNames = getCrossFeatureNames(cross);
        const name = featureNames.join(' × ');
        breakdown.push({ name: name, dim: dim, is_cross: true });
        total += dim;
    });

    return { total, breakdown };
}

function updateTensorPreview() {
    // Calculate buyer tensor dimensions
    const buyerFeatures = [];
    if (configState.customerIdFeature) {
        buyerFeatures.push(configState.customerIdFeature);
    }
    buyerFeatures.push(...configState.buyerFeatures);
    const buyerResult = calculateTensorBreakdown(buyerFeatures, configState.buyerCrosses);

    // Calculate product tensor dimensions
    const productFeatures = [];
    if (configState.productIdFeature) {
        productFeatures.push(configState.productIdFeature);
    }
    productFeatures.push(...configState.productFeatures);
    const productResult = calculateTensorBreakdown(productFeatures, configState.productCrosses);

    // Render both previews
    renderTensorPreview('buyer', buyerResult.total, buyerResult.breakdown);
    renderTensorPreview('product', productResult.total, productResult.breakdown);
}

/**
 * Render tensor visualization bar and breakdown tags
 * Can be called with either:
 *   - model name (for wizard): renderTensorPreview('buyer', total, breakdown)
 *   - DOM elements directly (for cards): renderTensorPreview('buyer', total, breakdown, barEl, breakdownEl)
 */
function renderTensorPreview(model, total, breakdown, barContainer = null, breakdownContainer = null) {
    // Get containers - either from params or by ID (wizard mode)
    if (!barContainer) {
        document.getElementById(`${model}TensorTotal`).textContent = `${total}D`;
        barContainer = document.getElementById(`${model}TensorBar`);
        breakdownContainer = document.getElementById(`${model}TensorBreakdown`);
    }

    barContainer.innerHTML = '';
    if (breakdownContainer) breakdownContainer.innerHTML = '';

    if (!breakdown || breakdown.length === 0) return;

    const colors = model === 'buyer'
        ? ['#3b82f6', '#60a5fa', '#93c5fd', '#bfdbfe', '#dbeafe']
        : ['#10b981', '#34d399', '#6ee7b7', '#a7f3d0', '#d1fae5'];

    breakdown.forEach((item, idx) => {
        const pct = (item.dim / total) * 100;
        const color = colors[idx % colors.length];

        const segment = document.createElement('div');
        segment.className = 'tensor-breakdown-segment';
        segment.style.width = `${pct}%`;
        segment.style.backgroundColor = color;
        segment.title = `${item.name}: ${item.dim}D`;
        if (pct > 10) {
            segment.textContent = item.dim;
        }
        barContainer.appendChild(segment);

        if (breakdownContainer) {
            const tag = document.createElement('span');
            tag.className = 'tensor-breakdown-item';
            tag.textContent = `${item.name}: ${item.dim}D`;
            breakdownContainer.appendChild(tag);
        }
    });
}

// =============================================================================
// FEATURE CONFIGURATION MODAL
// =============================================================================

function openFeatureConfig(model, idx) {
    editingFeatureModel = model;
    const features = model === 'buyer' ? configState.buyerFeatures : configState.productFeatures;
    editingFeature = {...features[idx], _idx: idx};

    document.getElementById('featureModalTitle').textContent = `Configure: ${editingFeature.column}`;
    renderFeatureConfigForm();
    document.getElementById('featureConfigModal').classList.remove('hidden');
}

function closeFeatureModal() {
    document.getElementById('featureConfigModal').classList.add('hidden');
    editingFeature = null;
    editingFeatureModel = null;
}

function renderFeatureConfigForm() {
    const body = document.getElementById('featureModalBody');
    const dataType = editingFeature.data_type || getDataTypeFromBqType(editingFeature.bq_type);
    const t = editingFeature.transforms || {};

    // Build data type selector
    const dataTypeOptions = ['numeric', 'text', 'temporal'].map(dt =>
        `<option value="${dt}" ${dataType === dt ? 'selected' : ''}>${getDataTypeLabel(dt)}</option>`
    ).join('');

    let transformsHtml = '';

    if (dataType === 'numeric') {
        transformsHtml = `
            <div class="transform-option">
                <input type="checkbox" id="featureNormalize" ${t.normalize?.enabled ? 'checked' : ''}>
                <div class="transform-option-content">
                    <div class="transform-option-title">Normalize</div>
                    <div class="transform-option-desc">Scale values to [-1, 1] range</div>
                </div>
                <span class="transform-option-dim">+1D</span>
            </div>
            <div class="transform-option">
                <input type="checkbox" id="featureBucketize" ${t.bucketize?.enabled ? 'checked' : ''}>
                <div class="transform-option-content">
                    <div class="transform-option-title">Bucketize + Embed</div>
                    <div class="transform-option-desc">Discretize into buckets with learned embedding</div>
                    <div class="mt-2">
                        <label class="text-xs text-gray-500">Buckets:</label>
                        <select id="featureBuckets" class="form-select form-select-sm ml-2" style="width: 80px;">
                            ${[10, 50, 100, 200].map(b =>
                                `<option value="${b}" ${(t.bucketize?.buckets || 100) == b ? 'selected' : ''}>${b}</option>`
                            ).join('')}
                        </select>
                        <label class="text-xs text-gray-500 ml-3">Dim:</label>
                        <select id="featureBucketDim" class="form-select form-select-sm ml-2" style="width: 80px;">
                            ${[8, 16, 32, 64].map(d =>
                                `<option value="${d}" ${(t.bucketize?.embedding_dim || 32) == d ? 'selected' : ''}>${d}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
                <span class="transform-option-dim" id="bucketizeDimLabel">+${t.bucketize?.embedding_dim || 32}D</span>
            </div>
        `;
    } else if (dataType === 'text') {
        const embedDim = t.embedding?.embedding_dim || 32;
        const presetDims = [8, 16, 32, 64, 128, 256];
        const isCustomDim = !presetDims.includes(embedDim);

        transformsHtml = `
            <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg">
                <div class="flex items-center justify-between mb-3">
                    <div>
                        <div class="font-medium text-gray-800">Embedding</div>
                        <div class="text-xs text-gray-500">Learn vector representation for categorical values</div>
                    </div>
                    <span class="text-blue-600 font-medium" id="embeddingDimLabel">+${embedDim}D</span>
                </div>

                <div class="mb-3">
                    <label class="text-xs text-gray-600 font-medium mb-2 block">Embedding Dimension</label>
                    <div class="flex gap-2 flex-wrap items-center justify-center">
                        ${presetDims.map(dim => `
                            <button type="button"
                                    class="text-embed-dim-btn px-3 py-2 rounded-lg border transition-all ${embedDim === dim && !isCustomDim
                                        ? 'bg-blue-500 text-white border-blue-500'
                                        : 'bg-white text-gray-700 border-gray-300 hover:border-blue-400'}"
                                    onclick="selectTextEmbedDim(${dim})">
                                ${dim}D
                            </button>
                        `).join('')}
                    </div>
                    <div class="flex items-center gap-3 mt-3 justify-center">
                        <span class="text-xs text-gray-600">Custom:</span>
                        <input type="number"
                               id="customTextEmbedDimInput"
                               class="form-input text-sm"
                               style="width: 80px;"
                               min="4"
                               max="1024"
                               step="1"
                               value="${isCustomDim ? embedDim : ''}"
                               placeholder="e.g. 512"
                               onchange="onCustomTextEmbedDimChange(this.value)"
                               oninput="onCustomTextEmbedDimInput(this.value)">
                        <span class="text-xs text-gray-400">4 - 1024</span>
                    </div>
                </div>

                <div class="border-t border-gray-200 pt-3 mt-3 space-y-2">
                    <div class="flex items-start gap-2 text-xs text-gray-600">
                        <i class="fas fa-database text-blue-500 mt-0.5"></i>
                        <span><strong>Vocabulary:</strong> Auto-detected from training data (no manual limit needed)</span>
                    </div>
                    <div class="flex items-start gap-2 text-xs text-gray-600">
                        <i class="fas fa-plus-circle text-green-500 mt-0.5"></i>
                        <span><strong>+1 OOV:</strong> One extra dimension is automatically reserved for new/unknown values</span>
                    </div>
                </div>
            </div>
            <input type="hidden" id="featureEmbedDim" value="${embedDim}">
        `;
    } else if (dataType === 'temporal') {
        const c = t.cyclical || {};
        transformsHtml = `
            <div class="transform-option">
                <input type="checkbox" id="featureNormalize" ${t.normalize?.enabled ? 'checked' : ''}>
                <div class="transform-option-content">
                    <div class="transform-option-title">Normalize</div>
                    <div class="transform-option-desc">Scale timestamp to [-1, 1] range</div>
                </div>
                <span class="transform-option-dim">+1D</span>
            </div>
            <div class="transform-option" style="flex-direction: column; align-items: stretch;">
                <div class="flex items-start gap-2 w-full">
                    <div class="transform-option-content flex-1">
                        <div class="transform-option-title">Cyclical Features</div>
                        <div class="transform-option-desc">Extract periodic patterns using sin/cos encoding</div>
                    </div>
                    <span class="transform-option-dim">varies</span>
                </div>
                <div class="space-y-1 mt-3">
                    <label class="flex items-center gap-2 text-xs">
                        <input type="checkbox" id="cyclicalYearly" ${c.yearly ? 'checked' : ''}>
                        <span>Yearly (month of year)</span>
                        <span class="text-blue-600 ml-auto">+2D</span>
                    </label>
                    <label class="flex items-center gap-2 text-xs">
                        <input type="checkbox" id="cyclicalQuarterly" ${c.quarterly ? 'checked' : ''}>
                        <span>Quarterly (month of quarter)</span>
                        <span class="text-blue-600 ml-auto">+2D</span>
                    </label>
                    <label class="flex items-center gap-2 text-xs">
                        <input type="checkbox" id="cyclicalMonthly" ${c.monthly ? 'checked' : ''}>
                        <span>Monthly (day of month)</span>
                        <span class="text-blue-600 ml-auto">+2D</span>
                    </label>
                    <label class="flex items-center gap-2 text-xs">
                        <input type="checkbox" id="cyclicalWeekly" ${c.weekly ? 'checked' : ''}>
                        <span>Weekly (day of week)</span>
                        <span class="text-blue-600 ml-auto">+2D</span>
                    </label>
                    <label class="flex items-center gap-2 text-xs">
                        <input type="checkbox" id="cyclicalDaily" ${c.daily ? 'checked' : ''}>
                        <span>Daily (hour of day)</span>
                        <span class="text-blue-600 ml-auto">+2D</span>
                    </label>
                </div>
            </div>
            <div class="transform-option">
                <input type="checkbox" id="featureBucketize" ${t.bucketize?.enabled ? 'checked' : ''}>
                <div class="transform-option-content">
                    <div class="transform-option-title">Bucketize + Embed</div>
                    <div class="transform-option-desc">Discretize into time buckets with learned embedding</div>
                    <div class="mt-2">
                        <label class="text-xs text-gray-500">Buckets:</label>
                        <select id="featureBuckets" class="form-select form-select-sm ml-2" style="width: 80px;">
                            ${[10, 50, 100, 200].map(b =>
                                `<option value="${b}" ${(t.bucketize?.buckets || 100) == b ? 'selected' : ''}>${b}</option>`
                            ).join('')}
                        </select>
                        <label class="text-xs text-gray-500 ml-3">Dim:</label>
                        <select id="featureBucketDim" class="form-select form-select-sm ml-2" style="width: 80px;">
                            ${[8, 16, 32, 64].map(d =>
                                `<option value="${d}" ${(t.bucketize?.embedding_dim || 32) == d ? 'selected' : ''}>${d}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
                <span class="transform-option-dim">+${t.bucketize?.embedding_dim || 32}D</span>
            </div>
        `;
    }

    body.innerHTML = `
        <div class="modal-form-group">
            <label class="modal-form-label">Data Type</label>
            <select id="modalDataType" class="form-select w-full" onchange="onModalDataTypeChange(this.value)">
                ${dataTypeOptions}
            </select>
            <p class="modal-form-hint">Original BQ type: ${editingFeature.bq_type || 'STRING'}</p>
        </div>
        <div class="modal-form-group">
            <label class="modal-form-label">Transformations</label>
            <p class="text-xs text-gray-500 mb-2">Select at least one transformation to include this feature in the model</p>
            <div id="transformOptions">
                ${transformsHtml}
            </div>
        </div>
    `;
}

function onModalDataTypeChange(newDataType) {
    // Update the editing feature's data type and re-render the form
    editingFeature.data_type = newDataType;
    editingFeature.transforms = {};  // Clear transforms when type changes
    renderFeatureConfigForm();
}

function applyFeatureConfig() {
    // Check if we're editing a primary ID feature
    if (editingFeature._isPrimaryId) {
        applyPrimaryIdConfig();
        return;
    }

    const features = editingFeatureModel === 'buyer' ? configState.buyerFeatures : configState.productFeatures;
    const idx = editingFeature._idx;
    const dataType = editingFeature.data_type || getDataTypeFromBqType(editingFeature.bq_type);

    // Update the data type
    features[idx].data_type = dataType;

    // Build transforms based on data type
    const transforms = {};

    if (dataType === 'numeric') {
        const normalizeEl = document.getElementById('featureNormalize');
        const bucketizeEl = document.getElementById('featureBucketize');

        if (normalizeEl?.checked) {
            transforms.normalize = { enabled: true, range: [-1, 1] };
        }
        if (bucketizeEl?.checked) {
            transforms.bucketize = {
                enabled: true,
                buckets: parseInt(document.getElementById('featureBuckets').value) || 100,
                embedding_dim: parseInt(document.getElementById('featureBucketDim').value) || 32
            };
        }
    } else if (dataType === 'text') {
        // Text features always use embedding (no checkbox needed)
        // Vocab size is auto-detected from training data, so we don't store it
        transforms.embedding = {
            enabled: true,
            embedding_dim: parseInt(document.getElementById('featureEmbedDim').value) || 32
        };
    } else if (dataType === 'temporal') {
        const normalizeEl = document.getElementById('featureNormalize');
        const bucketizeEl = document.getElementById('featureBucketize');

        if (normalizeEl?.checked) {
            transforms.normalize = { enabled: true, range: [-1, 1] };
        }

        // Check if any cyclical option is selected
        const yearly = document.getElementById('cyclicalYearly')?.checked || false;
        const quarterly = document.getElementById('cyclicalQuarterly')?.checked || false;
        const monthly = document.getElementById('cyclicalMonthly')?.checked || false;
        const weekly = document.getElementById('cyclicalWeekly')?.checked || false;
        const daily = document.getElementById('cyclicalDaily')?.checked || false;

        if (yearly || quarterly || monthly || weekly || daily) {
            transforms.cyclical = {
                enabled: true,
                yearly: yearly,
                quarterly: quarterly,
                monthly: monthly,
                weekly: weekly,
                daily: daily
            };
        }

        if (bucketizeEl?.checked) {
            transforms.bucketize = {
                enabled: true,
                buckets: parseInt(document.getElementById('featureBuckets').value) || 100,
                embedding_dim: parseInt(document.getElementById('featureBucketDim').value) || 32
            };
        }
    }

    features[idx].transforms = transforms;

    closeFeatureModal();
    renderStep2();
}

// =============================================================================
// CROSS FEATURE MODAL
// =============================================================================

function openCrossModal(model) {
    crossFeatureModel = model;

    // Get all features for this model, including the primary ID
    const primaryId = model === 'buyer' ? configState.customerIdFeature : configState.productIdFeature;
    const additionalFeatures = model === 'buyer' ? configState.buyerFeatures : configState.productFeatures;

    // Combine: primary ID first, then additional features
    const allFeatures = primaryId ? [primaryId, ...additionalFeatures] : additionalFeatures;

    const container = document.getElementById('crossFeatureOptions');
    container.innerHTML = '';

    allFeatures.forEach(f => {
        const label = document.createElement('label');
        const isPrimaryId = f.is_primary_id;
        const dataType = f.data_type || getDataTypeFromBqType(f.bq_type);
        const dataTypeLabel = getDataTypeLabel(dataType);

        // Determine badge color based on data type
        let typeBadge = '';
        if (isPrimaryId) {
            typeBadge = '<span class="text-xs bg-amber-100 text-amber-700 px-1 rounded">ID</span>';
        } else if (dataType === 'numeric') {
            typeBadge = '<span class="text-xs bg-blue-100 text-blue-700 px-1 rounded">Numeric</span>';
        } else if (dataType === 'temporal') {
            typeBadge = '<span class="text-xs bg-purple-100 text-purple-700 px-1 rounded">Temporal</span>';
        } else {
            typeBadge = '<span class="text-xs bg-gray-100 text-gray-600 px-1 rounded">Text</span>';
        }

        label.className = 'flex items-center gap-2 p-2 border rounded cursor-pointer hover:bg-gray-50';
        label.innerHTML = `
            <input type="checkbox" class="cross-feature-checkbox" value="${f.column}"
                   data-type="${dataType}" onchange="updateCrossPreview()">
            <span class="text-sm flex-1">${f.column}</span>
            ${typeBadge}
        `;
        container.appendChild(label);
    });

    // Reset bucket options
    document.getElementById('crossBucketOptions').classList.add('hidden');
    document.getElementById('crossBucketInputs').innerHTML = '';
    document.getElementById('crossPreview').classList.add('hidden');
    document.getElementById('crossFeatureModal').classList.remove('hidden');
}

function closeCrossModal() {
    document.getElementById('crossFeatureModal').classList.add('hidden');
    crossFeatureModel = null;
}

function updateCrossPreview() {
    const checkedInputs = Array.from(document.querySelectorAll('.cross-feature-checkbox:checked'));
    const checked = checkedInputs.map(cb => cb.value);

    if (checked.length >= 2) {
        document.getElementById('crossPreviewText').textContent = checked.join(' × ');
        document.getElementById('crossPreview').classList.remove('hidden');
    } else {
        document.getElementById('crossPreview').classList.add('hidden');
    }

    // Check for numeric/temporal features that need bucketization
    const numericTemporalFeatures = checkedInputs.filter(cb => {
        const dataType = cb.dataset.type;
        return dataType === 'numeric' || dataType === 'temporal';
    });

    const bucketOptionsContainer = document.getElementById('crossBucketOptions');
    const bucketInputsContainer = document.getElementById('crossBucketInputs');

    if (numericTemporalFeatures.length > 0) {
        bucketInputsContainer.innerHTML = '';

        numericTemporalFeatures.forEach(cb => {
            const column = cb.value;
            const dataType = cb.dataset.type;
            const typeLabel = dataType === 'numeric' ? 'Numeric' : 'Temporal';
            const typeColor = dataType === 'numeric' ? 'blue' : 'purple';

            const div = document.createElement('div');
            div.className = 'flex items-center gap-3 p-3 bg-gray-50 rounded-lg border';
            div.innerHTML = `
                <div class="flex-1">
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-medium">${column}</span>
                        <span class="text-xs bg-${typeColor}-100 text-${typeColor}-700 px-1 rounded">${typeLabel}</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">Buckets for crossing (coarse granularity recommended)</div>
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-xs text-gray-600">Buckets:</label>
                    <select class="cross-bucket-select form-select text-sm" data-column="${column}" style="width: 80px;">
                        <option value="5">5</option>
                        <option value="10" selected>10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
            `;
            bucketInputsContainer.appendChild(div);
        });

        bucketOptionsContainer.classList.remove('hidden');
    } else {
        bucketOptionsContainer.classList.add('hidden');
        bucketInputsContainer.innerHTML = '';
    }
}

function addCrossFeature() {
    const checkedInputs = Array.from(document.querySelectorAll('.cross-feature-checkbox:checked'));

    if (checkedInputs.length < 2) {
        showError('Please select at least 2 features');
        return;
    }
    if (checkedInputs.length > 3) {
        showError('Please select at most 3 features');
        return;
    }

    // Build features array with type and bucket info
    const features = checkedInputs.map(cb => {
        const column = cb.value;
        const dataType = cb.dataset.type;

        const featureConfig = {
            column: column,
            type: dataType
        };

        // Add crossing_buckets for numeric/temporal features
        if (dataType === 'numeric' || dataType === 'temporal') {
            const bucketSelect = document.querySelector(`.cross-bucket-select[data-column="${column}"]`);
            if (bucketSelect) {
                featureConfig.crossing_buckets = parseInt(bucketSelect.value);
            }
        }

        return featureConfig;
    });

    const cross = {
        features: features,
        hash_bucket_size: parseInt(document.getElementById('crossHashBuckets').value),
        embedding_dim: parseInt(document.getElementById('crossEmbedDim').value)
    };

    if (crossFeatureModel === 'buyer') {
        configState.buyerCrosses.push(cross);
    } else {
        configState.productCrosses.push(cross);
    }

    closeCrossModal();
    renderStep2();
}

// =============================================================================
// SAVE CONFIG
// =============================================================================

function saveConfig() {
    // Validate: require primary ID features
    if (!configState.customerIdFeature) {
        showError('Customer ID is required. Please drag a column to the Customer ID zone.');
        return;
    }
    if (!configState.productIdFeature) {
        showError('Product ID is required. Please drag a column to the Product ID zone.');
        return;
    }

    // Build feature arrays with primary IDs at the front
    const buyerFeatures = [configState.customerIdFeature, ...configState.buyerFeatures];
    const productFeatures = [configState.productIdFeature, ...configState.productFeatures];

    const payload = {
        name: configState.name,
        description: configState.description,
        dataset_id: configState.datasetId,
        buyer_model_features: buyerFeatures,
        product_model_features: productFeatures,
        buyer_model_crosses: configState.buyerCrosses,
        product_model_crosses: configState.productCrosses
    };

    const url = editingConfigId
        ? `/api/feature-configs/${editingConfigId}/update/`
        : `/api/models/${modelId}/feature-configs/create/`;
    const method = editingConfigId ? 'PUT' : 'POST';

    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            closeWizard();
            loadConfigs();
            showSuccess(editingConfigId ? 'Feature config updated' : 'Feature config created');
        } else {
            showError(data.error || data.errors?.name || 'Failed to save');
        }
    })
    .catch(err => {
        console.error('Error saving:', err);
        showError('Failed to save feature config');
    });
}

// =============================================================================
// CONFIG ACTIONS
// =============================================================================

function viewConfig(configId) {
    fetch(`/api/feature-configs/${configId}/`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                renderViewModal(data.data);
                document.getElementById('viewConfigModal').classList.remove('hidden');
            }
        });
}

function renderViewModal(config) {
    document.getElementById('viewConfigTitle').textContent = config.name;

    // Calculate tensor breakdowns for detailed view
    const buyerResult = calculateTensorBreakdown(
        config.buyer_model_features || [],
        config.buyer_model_crosses || []
    );
    const productResult = calculateTensorBreakdown(
        config.product_model_features || [],
        config.product_model_crosses || []
    );

    // Build dataset info section
    const datasetInfoHtml = buildDatasetInfoHtml(config.dataset_info, config.dataset_name);

    const body = document.getElementById('viewConfigBody');
    body.innerHTML = `
        <div class="mb-3">
            <div class="text-sm text-gray-500">Dataset: <span class="font-medium text-gray-700">${config.dataset_name}</span></div>
        </div>

        ${datasetInfoHtml}

        <div class="grid grid-cols-2 gap-4">
            <div class="p-4 bg-blue-50 rounded-lg">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="font-semibold text-blue-800">Buyer Tensor</h4>
                    <span class="font-semibold text-blue-600">${buyerResult.total}D</span>
                </div>
                <div id="viewModal-buyer-bar" class="tensor-breakdown-bar mb-3"></div>
                <div class="space-y-1">
                    ${buyerResult.breakdown.map(item => `
                        <div class="flex items-center justify-between text-sm">
                            <span class="${item.is_cross ? 'text-blue-600 italic' : 'text-blue-700'}">${item.name}</span>
                            <span class="text-blue-500 font-medium">${item.dim}D</span>
                        </div>
                    `).join('')}
                </div>
            </div>
            <div class="p-4 bg-green-50 rounded-lg">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="font-semibold text-green-800">Product Tensor</h4>
                    <span class="font-semibold text-green-600">${productResult.total}D</span>
                </div>
                <div id="viewModal-product-bar" class="tensor-breakdown-bar mb-3"></div>
                <div class="space-y-1">
                    ${productResult.breakdown.map(item => `
                        <div class="flex items-center justify-between text-sm">
                            <span class="${item.is_cross ? 'text-green-600 italic' : 'text-green-700'}">${item.name}</span>
                            <span class="text-green-500 font-medium">${item.dim}D</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;

    // Render tensor bars in view modal
    setTimeout(() => {
        const buyerBar = document.getElementById('viewModal-buyer-bar');
        const productBar = document.getElementById('viewModal-product-bar');
        if (buyerBar && buyerResult.breakdown.length > 0) {
            renderTensorPreview('buyer', buyerResult.total, buyerResult.breakdown, buyerBar, null);
        }
        if (productBar && productResult.breakdown.length > 0) {
            renderTensorPreview('product', productResult.total, productResult.breakdown, productBar, null);
        }
    }, 0);
}

/**
 * Build HTML for dataset information section in View modal.
 * @param {Object} info - Dataset info from API (dataset_info field)
 * @param {string} datasetName - Name of the dataset
 * @returns {string} HTML string for dataset info section
 */
function buildDatasetInfoHtml(info, datasetName) {
    if (!info || !info.primary_table) {
        return ''; // No dataset info available
    }

    // Build tables line
    const tables = [info.primary_table + ' (primary)'];
    (info.secondary_tables || []).forEach(t => {
        if (t) tables.push(t);
    });
    const tablesLine = tables.join(' &bull; ');

    // Build joins lines
    const joins = info.joins || [];
    const joinsHtml = joins.length > 0
        ? joins.map(j => `<div class="text-gray-700">${j}</div>`).join('')
        : '<span class="text-gray-400 italic">No joins</span>';

    // Build filters badges
    const filterBadges = [];
    if (info.filters?.dates) filterBadges.push(info.filters.dates);
    if (info.filters?.customers) filterBadges.push(info.filters.customers);
    if (info.filters?.products) filterBadges.push(info.filters.products);
    const filtersLine = filterBadges.length > 0
        ? filterBadges.join(' &bull; ')
        : '<span class="text-gray-400 italic">No filters</span>';

    // Row count badge
    const rowsBadge = info.estimated_rows
        ? `${info.estimated_rows.toLocaleString()} rows`
        : '';

    return `
        <div class="mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <div class="flex items-center justify-between mb-3">
                <h4 class="font-semibold text-gray-700">
                    <i class="fas fa-database mr-2 text-gray-400"></i>Dataset Source
                </h4>
                ${rowsBadge ? `<span class="text-sm font-medium text-gray-500 bg-white px-2 py-1 rounded border border-gray-200">${rowsBadge}</span>` : ''}
            </div>
            <div class="space-y-2 text-sm">
                <div class="flex">
                    <span class="text-gray-500 w-16 flex-shrink-0">Tables:</span>
                    <span class="text-gray-700">${tablesLine}</span>
                </div>
                ${joins.length > 0 ? `
                <div class="flex">
                    <span class="text-gray-500 w-16 flex-shrink-0">Joins:</span>
                    <div class="text-gray-700">${joinsHtml}</div>
                </div>
                ` : ''}
                <div class="flex">
                    <span class="text-gray-500 w-16 flex-shrink-0">Filters:</span>
                    <span class="text-gray-700">${filtersLine}</span>
                </div>
            </div>
        </div>
    `;
}

function closeViewModal() {
    document.getElementById('viewConfigModal').classList.add('hidden');
}

// =============================================================================
// COMPARE FEATURE SETS FUNCTIONS
// =============================================================================

let compareLeftConfig = null;
let compareRightConfig = null;

function openCompareModal() {
    // Populate dropdowns with all feature sets
    const leftSelect = document.getElementById('compareLeftSelect');
    const rightSelect = document.getElementById('compareRightSelect');

    // Clear existing options except the placeholder
    leftSelect.innerHTML = '<option value="">Select feature set...</option>';
    rightSelect.innerHTML = '<option value="">Select feature set...</option>';

    // Add all configs to both dropdowns
    allConfigs.forEach(config => {
        const optionLeft = document.createElement('option');
        optionLeft.value = config.id;
        optionLeft.textContent = config.name;
        leftSelect.appendChild(optionLeft);

        const optionRight = document.createElement('option');
        optionRight.value = config.id;
        optionRight.textContent = config.name;
        rightSelect.appendChild(optionRight);
    });

    // Reset to placeholder state
    resetCompareColumn('left');
    resetCompareColumn('right');

    // Hide data rows
    document.querySelector('.compare-row-source').classList.add('hidden');
    document.querySelector('.compare-row-buyer').classList.add('hidden');
    document.querySelector('.compare-row-product').classList.add('hidden');

    // Reset state
    compareLeftConfig = null;
    compareRightConfig = null;

    // Show modal
    document.getElementById('compareModal').classList.remove('hidden');
}

function closeCompareModal() {
    document.getElementById('compareModal').classList.add('hidden');
    compareLeftConfig = null;
    compareRightConfig = null;
}

function resetCompareColumn(side) {
    const prefix = side === 'left' ? 'compareLeft' : 'compareRight';

    document.getElementById(`${prefix}Header`).innerHTML = `
        <div class="flex items-center justify-center h-full text-gray-400 py-4">
            <span>Select a feature set</span>
        </div>
    `;
    document.getElementById(`${prefix}Source`).innerHTML = '';
    document.getElementById(`${prefix}Buyer`).innerHTML = '';
    document.getElementById(`${prefix}Product`).innerHTML = '';
}

function onCompareSelectChange(side) {
    const selectId = side === 'left' ? 'compareLeftSelect' : 'compareRightSelect';
    const configId = document.getElementById(selectId).value;

    if (!configId) {
        // Reset this side
        resetCompareColumn(side);
        if (side === 'left') compareLeftConfig = null;
        else compareRightConfig = null;
        updateCompareRowVisibility();
        return;
    }

    // Show loading state in header
    const prefix = side === 'left' ? 'compareLeft' : 'compareRight';
    document.getElementById(`${prefix}Header`).innerHTML = `
        <div class="flex items-center justify-center h-full text-gray-400 py-4">
            <i class="fas fa-spinner fa-spin mr-2"></i>Loading...
        </div>
    `;

    // Fetch config data
    fetch(`/api/feature-configs/${configId}/`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                if (side === 'left') compareLeftConfig = data.data;
                else compareRightConfig = data.data;
                renderCompareColumn(data.data, side);
                updateCompareRowVisibility();
            } else {
                document.getElementById(`${prefix}Header`).innerHTML = `
                    <div class="flex items-center justify-center h-full text-red-400 py-4">
                        <span>Failed to load</span>
                    </div>
                `;
            }
        })
        .catch(err => {
            console.error('Error loading config for compare:', err);
            document.getElementById(`${prefix}Header`).innerHTML = `
                <div class="flex items-center justify-center h-full text-red-400 py-4">
                    <span>Error loading</span>
                </div>
            `;
        });
}

function updateCompareRowVisibility() {
    // Show rows only if at least one side has data
    const hasData = compareLeftConfig || compareRightConfig;
    document.querySelector('.compare-row-source').classList.toggle('hidden', !hasData);
    document.querySelector('.compare-row-buyer').classList.toggle('hidden', !hasData);
    document.querySelector('.compare-row-product').classList.toggle('hidden', !hasData);
}

function renderCompareColumn(config, side) {
    const prefix = side === 'left' ? 'compareLeft' : 'compareRight';

    // Calculate tensor breakdowns
    const buyerResult = calculateTensorBreakdown(
        config.buyer_model_features || [],
        config.buyer_model_crosses || []
    );
    const productResult = calculateTensorBreakdown(
        config.product_model_features || [],
        config.product_model_crosses || []
    );

    // Build dataset info
    const datasetInfo = config.dataset_info || {};

    // Render Header
    document.getElementById(`${prefix}Header`).innerHTML = `
        <h4 class="font-semibold text-gray-900">${escapeHtml(config.name)}</h4>
        <div class="text-sm text-gray-500">Dataset: ${escapeHtml(config.dataset_name)}</div>
    `;

    // Render Source
    document.getElementById(`${prefix}Source`).innerHTML = buildCompareSourceHtml(datasetInfo);

    // Render Buyer Tensor
    document.getElementById(`${prefix}Buyer`).innerHTML = `
        <div class="p-3 bg-blue-50 rounded-lg">
            <div class="flex items-center justify-between mb-2">
                <h5 class="font-semibold text-blue-800 text-sm">Buyer Tensor</h5>
                <span class="font-semibold text-blue-600 text-sm">${buyerResult.total}D</span>
            </div>
            <div id="compare-${side}-buyer-bar" class="tensor-breakdown-bar mb-2"></div>
            <div class="space-y-1">
                ${buyerResult.breakdown.map(item => `
                    <div class="flex items-center justify-between text-xs">
                        <span class="${item.is_cross ? 'text-blue-600 italic' : 'text-blue-700'}">${item.name}</span>
                        <span class="text-blue-500 font-medium">${item.dim}D</span>
                    </div>
                `).join('')}
            </div>
        </div>
    `;

    // Render Product Tensor
    document.getElementById(`${prefix}Product`).innerHTML = `
        <div class="p-3 bg-green-50 rounded-lg">
            <div class="flex items-center justify-between mb-2">
                <h5 class="font-semibold text-green-800 text-sm">Product Tensor</h5>
                <span class="font-semibold text-green-600 text-sm">${productResult.total}D</span>
            </div>
            <div id="compare-${side}-product-bar" class="tensor-breakdown-bar mb-2"></div>
            <div class="space-y-1">
                ${productResult.breakdown.map(item => `
                    <div class="flex items-center justify-between text-xs">
                        <span class="${item.is_cross ? 'text-green-600 italic' : 'text-green-700'}">${item.name}</span>
                        <span class="text-green-500 font-medium">${item.dim}D</span>
                    </div>
                `).join('')}
            </div>
        </div>
    `;

    // Render tensor bars
    setTimeout(() => {
        const buyerBar = document.getElementById(`compare-${side}-buyer-bar`);
        const productBar = document.getElementById(`compare-${side}-product-bar`);
        if (buyerBar && buyerResult.breakdown.length > 0) {
            renderTensorPreview('buyer', buyerResult.total, buyerResult.breakdown, buyerBar, null);
        }
        if (productBar && productResult.breakdown.length > 0) {
            renderTensorPreview('product', productResult.total, productResult.breakdown, productBar, null);
        }
    }, 0);
}

/**
 * Build compact source info HTML for Compare modal
 */
function buildCompareSourceHtml(info) {
    if (!info || !info.primary_table) {
        return '<div class="p-3 bg-gray-100 rounded-lg text-sm text-gray-400 italic">No dataset info</div>';
    }

    // Build tables line
    const tables = [info.primary_table];
    (info.secondary_tables || []).forEach(t => {
        if (t) tables.push(t);
    });
    const tablesLine = tables.join(', ');

    // Build filters
    const filterBadges = [];
    if (info.filters?.dates) filterBadges.push(info.filters.dates);
    if (info.filters?.customers) filterBadges.push(info.filters.customers);
    if (info.filters?.products) filterBadges.push(info.filters.products);
    const filtersLine = filterBadges.length > 0
        ? filterBadges.join(' &bull; ')
        : '<span class="text-gray-400 italic">None</span>';

    // Row count
    const rowsBadge = info.estimated_rows
        ? `${info.estimated_rows.toLocaleString()} rows`
        : '';

    return `
        <div class="p-3 bg-gray-100 rounded-lg">
            <div class="flex items-center justify-between mb-2">
                <span class="font-medium text-gray-700 text-sm">
                    <i class="fas fa-database mr-1 text-gray-400"></i>Source
                </span>
                ${rowsBadge ? `<span class="text-xs font-medium text-gray-500">${rowsBadge}</span>` : ''}
            </div>
            <div class="space-y-1 text-xs">
                <div><span class="text-gray-500">Tables:</span> <span class="text-gray-700">${tablesLine}</span></div>
                <div><span class="text-gray-500">Filters:</span> <span class="text-gray-700">${filtersLine}</span></div>
            </div>
        </div>
    `;
}

/**
 * Build compact dataset info HTML for Compare modal columns (legacy - kept for compatibility)
 */
function buildCompareDatasetHtml(info) {
    if (!info || !info.primary_table) {
        return '<div class="mb-4 p-3 bg-gray-100 rounded-lg text-sm text-gray-400 italic">No dataset info</div>';
    }

    // Build tables line
    const tables = [info.primary_table];
    (info.secondary_tables || []).forEach(t => {
        if (t) tables.push(t);
    });
    const tablesLine = tables.join(', ');

    // Build filters
    const filterBadges = [];
    if (info.filters?.dates) filterBadges.push(info.filters.dates);
    if (info.filters?.customers) filterBadges.push(info.filters.customers);
    if (info.filters?.products) filterBadges.push(info.filters.products);
    const filtersLine = filterBadges.length > 0
        ? filterBadges.join(' &bull; ')
        : '<span class="text-gray-400 italic">None</span>';

    // Row count
    const rowsBadge = info.estimated_rows
        ? `${info.estimated_rows.toLocaleString()} rows`
        : '';

    return `
        <div class="mb-4 p-3 bg-gray-100 rounded-lg">
            <div class="flex items-center justify-between mb-2">
                <span class="font-medium text-gray-700 text-sm">
                    <i class="fas fa-database mr-1 text-gray-400"></i>Source
                </span>
                ${rowsBadge ? `<span class="text-xs font-medium text-gray-500">${rowsBadge}</span>` : ''}
            </div>
            <div class="space-y-1 text-xs">
                <div><span class="text-gray-500">Tables:</span> <span class="text-gray-700">${tablesLine}</span></div>
                <div><span class="text-gray-500">Filters:</span> <span class="text-gray-700">${filtersLine}</span></div>
            </div>
        </div>
    `;
}

// =============================================================================
// CODE VIEWER FUNCTIONS
// =============================================================================

let currentCodeViewerConfigId = null;
let currentCodeData = { transform: '', trainer: '' };

// Transform Code Viewer
function viewTransformCode(configId, configName) {
    currentCodeViewerConfigId = configId;
    document.getElementById('transformCodeConfigName').textContent = configName;

    // Clear previous content
    document.getElementById('transformCode').textContent = 'Loading...';
    document.getElementById('transformLineCount').textContent = '-';
    document.getElementById('transformCodeGeneratedAt').textContent = 'Loading...';

    // Reset validation badge
    updateValidationBadge('transform', 'checking');

    // Show modal
    document.getElementById('transformCodeViewerModal').classList.remove('hidden');

    // Fetch transform code
    fetch(`/api/feature-configs/${configId}/generated-code/?type=transform`)
        .then(r => r.json())
        .then(data => {
            if (data.success && data.data.code) {
                currentCodeData.transform = data.data.code;
                const highlighted = highlightPython(data.data.code);
                document.getElementById('transformCode').innerHTML = highlighted;
                const lineCount = data.data.code.split('\n').length;
                document.getElementById('transformLineCount').textContent = `${lineCount} lines`;
                updateValidationBadge('transform', data.data.is_valid ? 'valid' : 'invalid',
                                      data.data.validation_error, data.data.error_line);
            } else {
                currentCodeData.transform = '';
                document.getElementById('transformCode').innerHTML = '<span class="comment"># No transform code generated yet</span>';
                document.getElementById('transformLineCount').textContent = '0';
                updateValidationBadge('transform', 'valid');
            }

            if (data.data?.generated_at) {
                document.getElementById('transformCodeGeneratedAt').textContent = `Generated ${formatTimeAgo(data.data.generated_at)}`;
            } else {
                document.getElementById('transformCodeGeneratedAt').textContent = 'Not generated';
            }
        })
        .catch(err => {
            console.error('Error fetching transform code:', err);
            document.getElementById('transformCode').innerHTML = '<span class="comment"># Error loading code</span>';
            updateValidationBadge('transform', 'invalid', 'Failed to load code');
        });
}

function closeTransformCodeViewer() {
    document.getElementById('transformCodeViewerModal').classList.add('hidden');
}

function regenerateTransformCode() {
    if (!currentCodeViewerConfigId) return;

    const configName = document.getElementById('transformCodeConfigName').textContent;

    // Show loading state
    document.getElementById('transformCode').textContent = 'Regenerating...';
    updateValidationBadge('transform', 'checking');

    fetch(`/api/feature-configs/${currentCodeViewerConfigId}/regenerate-code/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ type: 'transform' })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            viewTransformCode(currentCodeViewerConfigId, configName);
            showSuccess('Transform code regenerated');
        } else {
            showError(data.error || 'Failed to regenerate code');
        }
    })
    .catch(err => {
        console.error('Error regenerating code:', err);
        showError('Failed to regenerate code');
    });
}

// Trainer Code Viewer
function viewTrainerCode(configId, configName) {
    currentCodeViewerConfigId = configId;
    document.getElementById('trainerCodeConfigName').textContent = configName;

    // Clear previous content
    document.getElementById('trainerCode').textContent = 'Loading...';
    document.getElementById('trainerLineCount').textContent = '-';
    document.getElementById('trainerCodeGeneratedAt').textContent = 'Loading...';

    // Reset validation badge
    updateValidationBadge('trainer', 'checking');

    // Show modal
    document.getElementById('trainerCodeViewerModal').classList.remove('hidden');

    // Fetch trainer code
    fetch(`/api/feature-configs/${configId}/generated-code/?type=trainer`)
        .then(r => r.json())
        .then(data => {
            if (data.success && data.data.code) {
                currentCodeData.trainer = data.data.code;
                const highlighted = highlightPython(data.data.code);
                document.getElementById('trainerCode').innerHTML = highlighted;
                const lineCount = data.data.code.split('\n').length;
                document.getElementById('trainerLineCount').textContent = `${lineCount} lines`;
                updateValidationBadge('trainer', data.data.is_valid ? 'valid' : 'invalid',
                                      data.data.validation_error, data.data.error_line);
            } else {
                currentCodeData.trainer = '';
                document.getElementById('trainerCode').innerHTML = '<span class="comment"># No trainer code generated yet</span>';
                document.getElementById('trainerLineCount').textContent = '0';
                updateValidationBadge('trainer', 'valid');
            }

            if (data.data?.generated_at) {
                document.getElementById('trainerCodeGeneratedAt').textContent = `Generated ${formatTimeAgo(data.data.generated_at)}`;
            } else {
                document.getElementById('trainerCodeGeneratedAt').textContent = 'Not generated';
            }
        })
        .catch(err => {
            console.error('Error fetching trainer code:', err);
            document.getElementById('trainerCode').innerHTML = '<span class="comment"># Error loading code</span>';
            updateValidationBadge('trainer', 'invalid', 'Failed to load code');
        });
}

function closeTrainerCodeViewer() {
    document.getElementById('trainerCodeViewerModal').classList.add('hidden');
}

function regenerateTrainerCode() {
    if (!currentCodeViewerConfigId) return;

    const configName = document.getElementById('trainerCodeConfigName').textContent;

    // Show loading state
    document.getElementById('trainerCode').textContent = 'Regenerating...';
    updateValidationBadge('trainer', 'checking');

    fetch(`/api/feature-configs/${currentCodeViewerConfigId}/regenerate-code/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ type: 'trainer' })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            viewTrainerCode(currentCodeViewerConfigId, configName);
            showSuccess('Trainer code regenerated');
        } else {
            showError(data.error || 'Failed to regenerate code');
        }
    })
    .catch(err => {
        console.error('Error regenerating code:', err);
        showError('Failed to regenerate code');
    });
}

// Trainer Code Selector (for Model Structure chapter)
function openTrainerCodeSelector() {
    // If no configs exist, show message
    if (!allConfigs || allConfigs.length === 0) {
        showError('No feature configs available. Create a feature config first.');
        return;
    }

    // If only one config, open it directly
    if (allConfigs.length === 1) {
        viewTrainerCode(allConfigs[0].id, allConfigs[0].name);
        return;
    }

    // Multiple configs - show selection dropdown
    const configOptions = allConfigs.map(c => `${c.name}`).join('\n');
    const selectedName = prompt(`Select a Feature Config to view Trainer code:\n\n${allConfigs.map((c, i) => `${i + 1}. ${c.name}`).join('\n')}\n\nEnter number:`);

    if (selectedName) {
        const index = parseInt(selectedName) - 1;
        if (index >= 0 && index < allConfigs.length) {
            viewTrainerCode(allConfigs[index].id, allConfigs[index].name);
        } else {
            showError('Invalid selection');
        }
    }
}

function updateValidationBadge(codeType, status, errorMsg = null, errorLine = null) {
    const badge = document.getElementById(`${codeType}ValidationBadge`);
    const errorBanner = document.getElementById(`${codeType}ValidationError`);
    const errorMsgEl = document.getElementById(`${codeType}ErrorMsg`);
    const errorLineEl = document.getElementById(`${codeType}ErrorLine`);

    // Update badge
    badge.classList.remove('valid', 'invalid', 'checking');
    badge.classList.add(status);

    if (status === 'valid') {
        badge.innerHTML = '<i class="fas fa-check-circle"></i> Valid';
        errorBanner.style.display = 'none';
    } else if (status === 'invalid') {
        badge.innerHTML = '<i class="fas fa-exclamation-circle"></i> Error';
        if (errorMsg) {
            errorMsgEl.textContent = errorMsg;
            errorLineEl.textContent = errorLine ? ` (line ${errorLine})` : '';
            errorBanner.style.display = 'flex';
        } else {
            errorBanner.style.display = 'none';
        }
    } else if (status === 'checking') {
        badge.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking';
        errorBanner.style.display = 'none';
    }
}

function highlightPython(code) {
    // Tokenization-based syntax highlighting to avoid regex conflicts
    // First, find all tokens and their positions, then build result

    const tokens = [];

    // Define token patterns (order matters for priority)
    const patterns = [
        // Triple-quoted strings (must come before single-line strings)
        { regex: /"""[\s\S]*?"""|'''[\s\S]*?'''/g, type: 'string' },
        // Comments
        { regex: /#[^\n]*/g, type: 'comment' },
        // Single and double quoted strings
        { regex: /'(?:[^'\\]|\\.)*'|"(?:[^"\\]|\\.)*"/g, type: 'string' },
        // Decorators
        { regex: /@\w+/g, type: 'decorator' },
        // Keywords (word boundaries)
        { regex: /\b(?:def|class|import|from|return|if|else|elif|for|while|try|except|finally|with|as|in|not|and|or|is|None|True|False|lambda|yield|raise|pass|break|continue|global|nonlocal|assert)\b/g, type: 'keyword' },
        // Builtins
        { regex: /\b(?:self|print|len|range|str|int|float|list|dict|tuple|set|type|isinstance|hasattr|getattr|setattr|super|property|staticmethod|classmethod|tf|tft|tfrs|logging|math)\b/g, type: 'builtin' },
        // Function calls and definitions
        { regex: /\b([a-zA-Z_]\w*)\s*(?=\()/g, type: 'function' },
        // Numbers
        { regex: /\b\d+\.?\d*\b/g, type: 'number' },
    ];

    // Find all tokens
    patterns.forEach(p => {
        let match;
        const regex = new RegExp(p.regex.source, 'g');
        while ((match = regex.exec(code)) !== null) {
            tokens.push({
                start: match.index,
                end: match.index + match[0].length,
                text: match[0],
                type: p.type
            });
        }
    });

    // Sort by start position
    tokens.sort((a, b) => a.start - b.start);

    // Remove overlapping tokens (keep first/higher priority)
    const filteredTokens = [];
    let lastEnd = 0;
    for (const token of tokens) {
        if (token.start >= lastEnd) {
            filteredTokens.push(token);
            lastEnd = token.end;
        }
    }

    // Build result
    let result = '';
    let pos = 0;

    for (const token of filteredTokens) {
        // Add unhighlighted text before this token
        if (token.start > pos) {
            result += escapeHtml(code.slice(pos, token.start));
        }
        // Add highlighted token
        result += `<span class="${token.type}">${escapeHtml(token.text)}</span>`;
        pos = token.end;
    }

    // Add remaining text
    if (pos < code.length) {
        result += escapeHtml(code.slice(pos));
    }

    return result;
}

function copyCode(type) {
    const code = currentCodeData[type];
    if (!code) {
        showError('No code to copy');
        return;
    }

    navigator.clipboard.writeText(code).then(() => {
        const btn = document.getElementById(type === 'transform' ? 'copyTransformBtn' : 'copyTrainerBtn');
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
        btn.classList.add('copied');

        setTimeout(() => {
            btn.innerHTML = originalHtml;
            btn.classList.remove('copied');
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy:', err);
        showError('Failed to copy code');
    });
}

function downloadCode(type) {
    const code = currentCodeData[type];
    if (!code) {
        showError('No code to download');
        return;
    }

    const filename = type === 'transform' ? 'preprocessing_fn.py' : 'trainer_module.py';
    const blob = new Blob([code], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function editConfig(configId) {
    openWizard(configId);
}

// Clone modal state
let cloneConfigId = null;

function cloneConfig(configId) {
    const config = allConfigs.find(c => c.id === configId);
    cloneConfigId = configId;

    // Pre-fill with suggested name
    const input = document.getElementById('cloneConfigName');
    input.value = `${config.name} (Copy)`;

    // Show modal
    document.getElementById('cloneConfigModal').classList.remove('hidden');

    // Focus input and select text
    setTimeout(() => {
        input.focus();
        input.select();
    }, 100);
}

function closeCloneModal() {
    document.getElementById('cloneConfigModal').classList.add('hidden');
    cloneConfigId = null;
}

function submitClone() {
    const newName = document.getElementById('cloneConfigName').value.trim();

    if (!newName) {
        showError('Please enter a name for the cloned config');
        return;
    }

    if (!cloneConfigId) {
        showError('No config selected for cloning');
        return;
    }

    fetch(`/api/feature-configs/${cloneConfigId}/clone/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({name: newName})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            closeCloneModal();
            loadConfigs();
            showSuccess('Config cloned successfully');
        } else {
            showError(data.error || 'Failed to clone');
        }
    });
}

function deleteConfig(configId, configName) {
    if (confirm(`Are you sure you want to delete "${configName}"?`)) {
        fetch(`/api/feature-configs/${configId}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrftoken
            }
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                loadConfigs();
                showSuccess('Config deleted');
            } else {
                showError(data.error || 'Failed to delete');
            }
        });
    }
}

// =============================================================================
// UTILITIES
// =============================================================================

function filterConfigs() {
    loadConfigs();
}

function debounceSearch() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        renderConfigs();
    }, 300);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatTimeAgo(isoString) {
    if (!isoString) return 'Unknown';
    const date = new Date(isoString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'just now';
    if (diffMins < 60) return `${diffMins} min ago`;
    if (diffHours < 24) return `${diffHours} hours ago`;
    if (diffDays < 7) return `${diffDays} days ago`;
    return date.toLocaleDateString();
}

function showError(message) {
    alert('Error: ' + message);
}

function showSuccess(message) {
    // Could use a toast notification here
    console.log('Success:', message);
}

// =============================================================================
// QUICK TEST FUNCTIONS
// =============================================================================

let currentQuickTestId = null;
let currentQuickTestConfigId = null;
let currentQuickTestConfigName = '';
let quickTestPollInterval = null;

// Quick Test Selector (for Quick Test chapter)
function openQuickTestSelector() {
    // If no configs exist, show message
    if (!allConfigs || allConfigs.length === 0) {
        showError('No feature configs available. Create a feature config first.');
        return;
    }

    // Filter configs that have generated transform code
    const readyConfigs = allConfigs.filter(c => c.generated_transform_code);

    if (readyConfigs.length === 0) {
        showError('No feature configs with generated code. Generate Transform code first.');
        return;
    }

    // If only one ready config, open it directly
    if (readyConfigs.length === 1) {
        openQuickTestDialog(readyConfigs[0].id, readyConfigs[0].name);
        return;
    }

    // Multiple configs - show selection
    const selectedName = prompt(`Select a Feature Config for Quick Test:\n\n${readyConfigs.map((c, i) => `${i + 1}. ${c.name}`).join('\n')}\n\nEnter number:`);

    if (selectedName) {
        const index = parseInt(selectedName) - 1;
        if (index >= 0 && index < readyConfigs.length) {
            openQuickTestDialog(readyConfigs[index].id, readyConfigs[index].name);
        } else {
            showError('Invalid selection');
        }
    }
}

function openQuickTestDialog(configId, configName) {
    currentQuickTestConfigId = configId;
    currentQuickTestConfigName = configName;
    document.getElementById('qtConfigName').textContent = configName;

    // Reset form
    document.getElementById('qtEpochs').value = '10';
    document.getElementById('qtBatchSize').value = '4096';
    document.getElementById('qtLearningRate').value = '0.001';

    document.getElementById('quickTestDialog').classList.remove('hidden');
}

function closeQuickTestDialog() {
    document.getElementById('quickTestDialog').classList.add('hidden');
}

async function startQuickTest() {
    const epochs = parseInt(document.getElementById('qtEpochs').value);
    const batchSize = parseInt(document.getElementById('qtBatchSize').value);
    const learningRate = parseFloat(document.getElementById('qtLearningRate').value);

    // Close dialog
    closeQuickTestDialog();

    // Show progress modal
    document.getElementById('qtProgressConfigName').textContent = currentQuickTestConfigName;
    document.getElementById('qtProgressBar').style.width = '0%';
    document.getElementById('qtProgressText').textContent = '0%';
    document.getElementById('qtElapsed').textContent = '0:00';
    document.getElementById('qtStages').innerHTML = renderInitialStages();
    document.getElementById('quickTestProgress').classList.remove('hidden');

    try {
        const response = await fetch(`/api/feature-configs/${currentQuickTestConfigId}/quick-test/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                epochs: epochs,
                batch_size: batchSize,
                learning_rate: learningRate
            })
        });

        const data = await response.json();

        if (data.success) {
            currentQuickTestId = data.data.id;
            updateProgressUI(data.data);
            startPolling();
        } else {
            document.getElementById('quickTestProgress').classList.add('hidden');
            showError(data.error || 'Failed to start Quick Test');
        }
    } catch (error) {
        document.getElementById('quickTestProgress').classList.add('hidden');
        showError('Failed to start Quick Test: ' + error.message);
    }
}

function renderInitialStages() {
    const stages = ['ExampleGen', 'StatisticsGen', 'SchemaGen', 'Transform', 'Trainer'];
    return stages.map(name => `
        <div class="quicktest-stage" data-stage="${name}">
            <div class="quicktest-stage-icon pending">
                <i class="fas fa-clock"></i>
            </div>
            <span class="quicktest-stage-name">${name}</span>
            <span class="quicktest-stage-duration"></span>
        </div>
    `).join('');
}

function startPolling() {
    quickTestPollInterval = setInterval(async () => {
        try {
            const response = await fetch(`/api/quick-tests/${currentQuickTestId}/`);
            const data = await response.json();

            if (data.success) {
                updateProgressUI(data.data);

                if (['completed', 'failed', 'cancelled'].includes(data.data.status)) {
                    stopPolling();
                    showResults(data.data);
                }
            }
        } catch (error) {
            console.error('Polling error:', error);
        }
    }, 10000); // Poll every 10 seconds
}

function stopPolling() {
    if (quickTestPollInterval) {
        clearInterval(quickTestPollInterval);
        quickTestPollInterval = null;
    }
}

function updateProgressUI(quickTest) {
    // Update progress bar
    const progressPercent = quickTest.progress_percent || 0;
    document.getElementById('qtProgressBar').style.width = progressPercent + '%';
    document.getElementById('qtProgressText').textContent = progressPercent + '%';

    // Update stages
    if (quickTest.stage_details && quickTest.stage_details.length) {
        const stagesHtml = quickTest.stage_details.map(stage => {
            let iconClass, statusClass;
            switch (stage.status) {
                case 'completed':
                    iconClass = 'fa-check-circle';
                    statusClass = 'completed';
                    break;
                case 'running':
                    iconClass = 'fa-spinner fa-spin';
                    statusClass = 'running';
                    break;
                case 'failed':
                    iconClass = 'fa-times-circle';
                    statusClass = 'failed';
                    break;
                default:
                    iconClass = 'fa-clock';
                    statusClass = 'pending';
            }

            const duration = stage.duration_seconds
                ? formatDuration(stage.duration_seconds)
                : '';

            return `
                <div class="quicktest-stage ${statusClass}">
                    <div class="quicktest-stage-icon ${statusClass}">
                        <i class="fas ${iconClass}"></i>
                    </div>
                    <span class="quicktest-stage-name">${stage.name}</span>
                    <span class="quicktest-stage-duration">${duration}</span>
                </div>
            `;
        }).join('');

        document.getElementById('qtStages').innerHTML = stagesHtml;
    }

    // Update elapsed time
    if (quickTest.elapsed_seconds) {
        document.getElementById('qtElapsed').textContent = formatDuration(quickTest.elapsed_seconds);
    }
}

function showResults(quickTest) {
    // Hide progress modal
    document.getElementById('quickTestProgress').classList.add('hidden');

    // Update results modal
    document.getElementById('qtrConfigName').textContent = currentQuickTestConfigName;

    // Status icon and badge
    const statusIcon = document.getElementById('qtrStatusIcon');
    const statusBadge = document.getElementById('qtrStatusBadge');

    if (quickTest.status === 'completed') {
        statusIcon.className = 'modal-header-icon success';
        statusIcon.innerHTML = '<i class="fas fa-check"></i>';
        statusBadge.innerHTML = '<span class="status-badge active"><i class="fas fa-check-circle"></i> Completed</span>';
    } else if (quickTest.status === 'failed') {
        statusIcon.className = 'modal-header-icon error';
        statusIcon.innerHTML = '<i class="fas fa-times"></i>';
        statusBadge.innerHTML = '<span class="status-badge" style="background: #fef2f2; color: #991b1b;"><i class="fas fa-times-circle"></i> Failed</span>';
    } else {
        statusIcon.className = 'modal-header-icon info';
        statusIcon.innerHTML = '<i class="fas fa-ban"></i>';
        statusBadge.innerHTML = '<span class="status-badge draft"><i class="fas fa-ban"></i> Cancelled</span>';
    }

    // Metrics
    const metricsHtml = quickTest.status === 'completed' ? `
        <div class="quicktest-metric">
            <span class="quicktest-metric-label">Loss</span>
            <span class="quicktest-metric-value">${quickTest.loss?.toFixed(4) || 'N/A'}</span>
        </div>
        <div class="quicktest-metric">
            <span class="quicktest-metric-label">Recall@10</span>
            <span class="quicktest-metric-value">${quickTest.recall_at_10 ? (quickTest.recall_at_10 * 100).toFixed(2) + '%' : 'N/A'}</span>
        </div>
        <div class="quicktest-metric">
            <span class="quicktest-metric-label">Recall@50</span>
            <span class="quicktest-metric-value">${quickTest.recall_at_50 ? (quickTest.recall_at_50 * 100).toFixed(2) + '%' : 'N/A'}</span>
        </div>
        <div class="quicktest-metric">
            <span class="quicktest-metric-label">Recall@100</span>
            <span class="quicktest-metric-value">${quickTest.recall_at_100 ? (quickTest.recall_at_100 * 100).toFixed(2) + '%' : 'N/A'}</span>
        </div>
    ` : '<p class="text-gray-500">No metrics available</p>';

    document.getElementById('qtrMetrics').innerHTML = metricsHtml;

    // Vocabulary stats
    const vocabSection = document.getElementById('qtrVocabSection');
    if (quickTest.vocabulary_stats && Object.keys(quickTest.vocabulary_stats).length > 0) {
        vocabSection.classList.remove('hidden');
        const vocabHtml = Object.entries(quickTest.vocabulary_stats).map(([feature, stats]) => `
            <div class="quicktest-metric">
                <span class="quicktest-metric-label">${feature}</span>
                <span class="quicktest-metric-value">
                    ${stats.vocab_size?.toLocaleString() || 'N/A'} vocab
                    ${stats.oov_rate !== undefined ? ` (${(stats.oov_rate * 100).toFixed(2)}% OOV)` : ''}
                </span>
            </div>
        `).join('');
        document.getElementById('qtrVocabStats').innerHTML = vocabHtml;
    } else {
        vocabSection.classList.add('hidden');
    }

    // Error section
    const errorSection = document.getElementById('qtrErrorSection');
    if (quickTest.status === 'failed' && quickTest.error_message) {
        errorSection.classList.remove('hidden');
        document.getElementById('qtrErrorMessage').textContent = quickTest.error_message;
    } else {
        errorSection.classList.add('hidden');
    }

    // Duration
    document.getElementById('qtrDuration').textContent = quickTest.duration_seconds
        ? formatDuration(quickTest.duration_seconds)
        : '-';

    // Vertex AI link
    if (quickTest.vertex_pipeline_job_id) {
        const link = `https://console.cloud.google.com/vertex-ai/pipelines/runs/${quickTest.vertex_pipeline_job_id}?project=b2b-recs`;
        document.getElementById('qtrVertexLink').href = link;
        document.getElementById('qtrVertexLink').style.display = 'inline';
    } else {
        document.getElementById('qtrVertexLink').style.display = 'none';
    }

    // Show results modal
    document.getElementById('quickTestResults').classList.remove('hidden');
}

function closeQuickTestResults() {
    document.getElementById('quickTestResults').classList.add('hidden');
}

async function cancelQuickTest() {
    if (!currentQuickTestId) return;

    const btn = document.getElementById('qtCancelBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="btn-neu-inner"><i class="fas fa-spinner fa-spin mr-2"></i>Cancelling...</span>';

    try {
        const response = await fetch(`/api/quick-tests/${currentQuickTestId}/cancel/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });

        const data = await response.json();

        if (data.success) {
            stopPolling();
            document.getElementById('quickTestProgress').classList.add('hidden');
            showSuccess('Quick Test cancelled');
        } else {
            showError(data.error || 'Failed to cancel Quick Test');
        }
    } catch (error) {
        showError('Failed to cancel: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<span class="btn-neu-inner"><i class="fas fa-stop mr-2"></i>Cancel Test</span>';
    }
}

function formatDuration(seconds) {
    if (!seconds && seconds !== 0) return '0:00';
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// =============================================================================
// MODEL CONFIG FUNCTIONALITY
// =============================================================================

let allModelConfigs = [];
let mcCurrentStep = 1;
let editingModelConfigId = null;
let viewingModelConfig = null;
let presetsData = {};

// Model Config State
let mcState = {
    modelType: 'retrieval',
    name: '',
    description: '',
    selectedPreset: 'standard',
    buyerTowerLayers: [],
    productTowerLayers: [],
    outputEmbeddingDim: 32,
    optimizer: 'adagrad',
    learningRate: 0.1,
    batchSize: 4096,
    epochs: 5
};

// Load Model Configs
function loadModelConfigs() {
    document.getElementById('modelConfigsLoading').classList.remove('hidden');
    document.getElementById('modelConfigsEmpty').classList.add('hidden');
    document.getElementById('modelConfigsGrid').classList.add('hidden');

    fetch('/api/model-configs/')
        .then(r => r.json())
        .then(data => {
            document.getElementById('modelConfigsLoading').classList.add('hidden');
            if (data.success) {
                allModelConfigs = data.data;
                renderModelConfigs();
            } else {
                console.error('Error loading model configs:', data.error);
            }
        })
        .catch(err => {
            document.getElementById('modelConfigsLoading').classList.add('hidden');
            console.error('Error loading model configs:', err);
        });
}

// Render Model Config Cards
function renderModelConfigs() {
    const grid = document.getElementById('modelConfigsGrid');
    const empty = document.getElementById('modelConfigsEmpty');

    if (allModelConfigs.length === 0) {
        empty.classList.remove('hidden');
        grid.classList.add('hidden');
        return;
    }

    empty.classList.add('hidden');
    grid.classList.remove('hidden');

    grid.innerHTML = allModelConfigs.map(mc => `
        <div class="model-config-card" onclick="viewModelConfig(${mc.id})">
            <div class="model-config-card-header">
                <div>
                    <div class="model-config-name">${escapeHtml(mc.name)}</div>
                    ${mc.description ? `<div class="model-config-desc">${escapeHtml(mc.description)}</div>` : ''}
                </div>
                <div class="flex items-center gap-2">
                    <span class="model-type-badge ${mc.model_type}">${mc.model_type_display}</span>
                    <div class="model-config-actions" onclick="event.stopPropagation()">
                        <button class="model-config-action-btn" onclick="cloneModelConfigById(${mc.id})" title="Clone">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button class="model-config-action-btn delete" onclick="deleteModelConfig(${mc.id})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="tower-visual">
                <div class="tower-column">
                    <div class="tower-label">Buyer</div>
                    <div class="tower-layers buyer">${mc.buyer_tower_summary}</div>
                </div>
                <div class="tower-column">
                    <div class="tower-label">Product</div>
                    <div class="tower-layers product">${mc.product_tower_summary}</div>
                </div>
            </div>
            <div class="training-params-preview">
                <div class="param-chip">
                    <span class="param-chip-label">Opt:</span>
                    <span class="param-chip-value">${mc.optimizer_display}</span>
                </div>
                <div class="param-chip">
                    <span class="param-chip-label">LR:</span>
                    <span class="param-chip-value">${mc.learning_rate}</span>
                </div>
                <div class="param-chip">
                    <span class="param-chip-label">Batch:</span>
                    <span class="param-chip-value">${mc.batch_size}</span>
                </div>
                <div class="param-chip">
                    <span class="param-chip-label">Epochs:</span>
                    <span class="param-chip-value">${mc.epochs}</span>
                </div>
            </div>
        </div>
    `).join('');
}

// Open Model Config Wizard
function openModelConfigWizard() {
    editingModelConfigId = null;
    mcCurrentStep = 1;
    resetMcState();
    loadPresets();
    document.getElementById('modelConfigWizardTitle').textContent = 'Create Model Config';
    document.getElementById('modelConfigWizardModal').classList.remove('hidden');
    updateMcStep();
}

// Close Model Config Wizard
function closeModelConfigWizard() {
    document.getElementById('modelConfigWizardModal').classList.add('hidden');
}

// Reset Model Config State
function resetMcState() {
    mcState = {
        modelType: 'retrieval',
        name: '',
        description: '',
        selectedPreset: 'standard',
        buyerTowerLayers: [],
        productTowerLayers: [],
        outputEmbeddingDim: 32,
        optimizer: 'adagrad',
        learningRate: 0.1,
        batchSize: 4096,
        epochs: 5
    };
    document.getElementById('mcName').value = '';
    document.getElementById('mcDescription').value = '';
    selectModelType('retrieval');
    selectPreset('standard');
}

// Load Presets from API
function loadPresets() {
    fetch('/api/model-configs/presets/')
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                presetsData = data.data;
                applyPreset('standard');
            }
        })
        .catch(err => console.error('Error loading presets:', err));
}

// Select Model Type
function selectModelType(type) {
    if (type !== 'retrieval') return; // Only retrieval enabled for Phase 1

    mcState.modelType = type;
    document.querySelectorAll('.wizard-model-type-option').forEach(opt => {
        opt.classList.toggle('selected', opt.dataset.type === type);
    });
}

// Select Preset
function selectPreset(preset) {
    mcState.selectedPreset = preset;
    document.querySelectorAll('.preset-option').forEach(opt => {
        opt.classList.toggle('selected', opt.dataset.preset === preset);
    });
    applyPreset(preset);
}

// Apply Preset Configuration
function applyPreset(presetName) {
    const preset = presetsData[presetName];
    if (!preset) return;

    mcState.buyerTowerLayers = JSON.parse(JSON.stringify(preset.buyer_tower_layers || []));
    mcState.productTowerLayers = JSON.parse(JSON.stringify(preset.product_tower_layers || []));
    mcState.outputEmbeddingDim = preset.output_embedding_dim || 32;

    renderTowerLayers();
    updateTowerSummaries();
}

// Render Tower Layers
function renderTowerLayers() {
    renderLayerList('buyer', mcState.buyerTowerLayers);
    renderLayerList('product', mcState.productTowerLayers);
}

function renderLayerList(tower, layers) {
    const list = document.getElementById(`${tower}LayerList`);
    if (!list) return;

    list.innerHTML = layers.map((layer, idx) => {
        let badge = '';
        let params = '';

        if (layer.type === 'dense') {
            badge = '<span class="layer-type-badge dense">Dense</span>';
            params = `${layer.units} units, ${layer.activation || 'relu'}${layer.l2_reg ? `, L2=${layer.l2_reg}` : ''}`;
        } else if (layer.type === 'dropout') {
            badge = '<span class="layer-type-badge dropout">Dropout</span>';
            params = `rate: ${layer.rate}`;
        } else if (layer.type === 'batch_norm') {
            badge = '<span class="layer-type-badge batch_norm">BatchNorm</span>';
            params = '';
        }

        return `
            <div class="layer-item" data-index="${idx}">
                <span class="drag-handle"><i class="fas fa-grip-vertical"></i></span>
                ${badge}
                <span class="layer-params">${params}</span>
                <div class="layer-actions">
                    <button class="model-config-action-btn" onclick="removeLayer('${tower}', ${idx})" title="Remove">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

// Update Tower Summaries
function updateTowerSummaries() {
    const buyerSummary = getTowerSummary(mcState.buyerTowerLayers);
    const productSummary = getTowerSummary(mcState.productTowerLayers);

    const buyerEl = document.getElementById('buyerTowerSummary');
    const productEl = document.getElementById('productTowerSummary');

    if (buyerEl) buyerEl.textContent = buyerSummary;
    if (productEl) productEl.textContent = productSummary;
}

function getTowerSummary(layers) {
    const units = layers.filter(l => l.type === 'dense').map(l => l.units);
    return units.length > 0 ? units.join('→') : 'Empty';
}

// Add Layer
function addLayer(tower) {
    document.getElementById('addLayerTower').value = tower;
    document.getElementById('addLayerType').value = 'dense';
    document.getElementById('addLayerUnits').value = '64';
    document.getElementById('addLayerActivation').value = 'relu';
    document.getElementById('addLayerL2').value = '0';
    document.getElementById('addLayerDropoutRate').value = '0.2';
    updateLayerFields();
    document.getElementById('addLayerModal').classList.remove('hidden');
}

function updateLayerFields() {
    const type = document.getElementById('addLayerType').value;
    document.getElementById('denseFields').classList.toggle('hidden', type !== 'dense');
    document.getElementById('dropoutFields').classList.toggle('hidden', type !== 'dropout');
    document.getElementById('batchNormFields').classList.toggle('hidden', type !== 'batch_norm');
}

function closeAddLayerModal(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('addLayerModal').classList.add('hidden');
}

function confirmAddLayer() {
    const tower = document.getElementById('addLayerTower').value;
    const type = document.getElementById('addLayerType').value;

    let layer = { type };

    if (type === 'dense') {
        layer.units = parseInt(document.getElementById('addLayerUnits').value);
        layer.activation = document.getElementById('addLayerActivation').value;
        if (layer.activation === 'linear') layer.activation = null;
        const l2 = parseFloat(document.getElementById('addLayerL2').value);
        if (l2 > 0) layer.l2_reg = l2;
    } else if (type === 'dropout') {
        layer.rate = parseFloat(document.getElementById('addLayerDropoutRate').value);
    }

    if (tower === 'buyer') {
        mcState.buyerTowerLayers.push(layer);
    } else {
        mcState.productTowerLayers.push(layer);
    }

    renderTowerLayers();
    updateTowerSummaries();
    closeAddLayerModal();
}

function removeLayer(tower, index) {
    if (tower === 'buyer') {
        mcState.buyerTowerLayers.splice(index, 1);
    } else {
        mcState.productTowerLayers.splice(index, 1);
    }
    renderTowerLayers();
    updateTowerSummaries();
}

// Navigation
function mcNextStep() {
    if (mcCurrentStep === 1) {
        const name = document.getElementById('mcName').value.trim();
        if (!name) {
            alert('Please enter a configuration name');
            return;
        }
        mcState.name = name;
        mcState.description = document.getElementById('mcDescription').value.trim();
    }

    if (mcCurrentStep < 3) {
        mcCurrentStep++;
        updateMcStep();
    }
}

function mcPrevStep() {
    if (mcCurrentStep > 1) {
        mcCurrentStep--;
        updateMcStep();
    }
}

function updateMcStep() {
    // Update step content visibility (use 'active' class, not 'hidden')
    document.getElementById('mcStep1').classList.toggle('active', mcCurrentStep === 1);
    document.getElementById('mcStep2').classList.toggle('active', mcCurrentStep === 2);
    document.getElementById('mcStep3').classList.toggle('active', mcCurrentStep === 3);

    // Update progress pills
    for (let i = 1; i <= 3; i++) {
        const pill = document.getElementById(`mcProgress${i}`);
        pill.classList.remove('current', 'completed', 'future');
        if (i < mcCurrentStep) {
            pill.classList.add('completed');
        } else if (i === mcCurrentStep) {
            pill.classList.add('current');
        } else {
            pill.classList.add('future');
        }
    }

    // Update step counter
    document.getElementById('mcCurrentStep').textContent = mcCurrentStep;

    // Update buttons
    document.getElementById('mcBtnBack').style.display = mcCurrentStep > 1 ? 'inline-flex' : 'none';
    document.getElementById('mcBtnNext').classList.toggle('hidden', mcCurrentStep === 3);
    document.getElementById('mcBtnCreate').classList.toggle('hidden', mcCurrentStep !== 3);

    // Update summary on step 3
    if (mcCurrentStep === 3) {
        updateMcSummary();
    }

    // Render layers when entering step 2
    if (mcCurrentStep === 2) {
        renderTowerLayers();
        updateTowerSummaries();
    }
}

function updateMcSummary() {
    document.getElementById('mcSummaryType').textContent = 'Retrieval';
    document.getElementById('mcSummaryBuyer').textContent = getTowerSummary(mcState.buyerTowerLayers);
    document.getElementById('mcSummaryProduct').textContent = getTowerSummary(mcState.productTowerLayers);
    document.getElementById('mcSummaryOutputDim').textContent = document.getElementById('mcOutputEmbeddingDim').value;

    // Estimate params (rough calculation)
    const buyerParams = estimateTowerParams(mcState.buyerTowerLayers);
    const productParams = estimateTowerParams(mcState.productTowerLayers);
    const totalParams = buyerParams + productParams;
    document.getElementById('mcSummaryParams').textContent = formatParams(totalParams);
}

function estimateTowerParams(layers) {
    let params = 0;
    let prevDim = 100; // Assume input dim
    for (const layer of layers) {
        if (layer.type === 'dense') {
            params += prevDim * layer.units + layer.units;
            prevDim = layer.units;
        }
    }
    return params;
}

function formatParams(num) {
    if (num >= 1000000) return `~${(num / 1000000).toFixed(1)}M`;
    if (num >= 1000) return `~${(num / 1000).toFixed(0)}K`;
    return `~${num}`;
}

// Create Model Config
function createModelConfig() {
    const payload = {
        name: mcState.name,
        description: mcState.description,
        model_type: mcState.modelType,
        buyer_tower_layers: mcState.buyerTowerLayers,
        product_tower_layers: mcState.productTowerLayers,
        output_embedding_dim: parseInt(document.getElementById('mcOutputEmbeddingDim').value),
        optimizer: document.getElementById('mcOptimizer').value,
        learning_rate: parseFloat(document.getElementById('mcLearningRate').value),
        batch_size: parseInt(document.getElementById('mcBatchSize').value),
        epochs: parseInt(document.getElementById('mcEpochs').value)
    };

    fetch('/api/model-configs/create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            closeModelConfigWizard();
            loadModelConfigs();
            showToast('Model config created successfully', 'success');
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(err => {
        console.error('Error creating model config:', err);
        alert('Error creating model config');
    });
}

// View Model Config
function viewModelConfig(id) {
    const mc = allModelConfigs.find(c => c.id === id);
    if (!mc) return;

    viewingModelConfig = mc;

    document.getElementById('viewMcName').textContent = mc.name;
    document.getElementById('viewMcDesc').textContent = mc.description || 'No description';

    const badge = document.getElementById('viewMcTypeBadge');
    badge.className = `model-type-badge ${mc.model_type}`;
    badge.textContent = mc.model_type_display;

    document.getElementById('viewMcBuyerLayers').textContent = mc.buyer_tower_summary;
    document.getElementById('viewMcProductLayers').textContent = mc.product_tower_summary;

    document.getElementById('viewMcParams').innerHTML = `
        <div class="param-chip">
            <span class="param-chip-label">Optimizer:</span>
            <span class="param-chip-value">${mc.optimizer_display}</span>
        </div>
        <div class="param-chip">
            <span class="param-chip-label">Learning Rate:</span>
            <span class="param-chip-value">${mc.learning_rate}</span>
        </div>
        <div class="param-chip">
            <span class="param-chip-label">Batch Size:</span>
            <span class="param-chip-value">${mc.batch_size}</span>
        </div>
        <div class="param-chip">
            <span class="param-chip-label">Epochs:</span>
            <span class="param-chip-value">${mc.epochs}</span>
        </div>
        <div class="param-chip">
            <span class="param-chip-label">Output Dim:</span>
            <span class="param-chip-value">${mc.output_embedding_dim}</span>
        </div>
    `;

    document.getElementById('viewMcCreatedAt').textContent = new Date(mc.created_at).toLocaleDateString();
    document.getElementById('viewMcCreatedBy').textContent = mc.created_by || 'Unknown';

    document.getElementById('modelConfigViewModal').classList.remove('hidden');
}

function closeModelConfigViewModal(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('modelConfigViewModal').classList.add('hidden');
    viewingModelConfig = null;
}

// Clone Model Config
function cloneModelConfig() {
    if (!viewingModelConfig) return;
    cloneModelConfigById(viewingModelConfig.id);
    closeModelConfigViewModal();
}

function cloneModelConfigById(id) {
    if (!confirm('Clone this model config?')) return;

    fetch(`/api/model-configs/${id}/clone/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            loadModelConfigs();
            showToast('Model config cloned successfully', 'success');
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(err => {
        console.error('Error cloning model config:', err);
        alert('Error cloning model config');
    });
}

// Delete Model Config
function deleteModelConfig(id) {
    if (!confirm('Are you sure you want to delete this model config?')) return;

    fetch(`/api/model-configs/${id}/delete/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            loadModelConfigs();
            showToast('Model config deleted', 'success');
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(err => {
        console.error('Error deleting model config:', err);
        alert('Error deleting model config');
    });
}

// Edit Model Config (opens wizard in edit mode)
function editModelConfig() {
    if (!viewingModelConfig) return;

    // Fetch full config details
    fetch(`/api/model-configs/${viewingModelConfig.id}/`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const mc = data.data;
                editingModelConfigId = mc.id;

                mcState.name = mc.name;
                mcState.description = mc.description;
                mcState.modelType = mc.model_type;
                mcState.buyerTowerLayers = mc.buyer_tower_layers || [];
                mcState.productTowerLayers = mc.product_tower_layers || [];
                mcState.outputEmbeddingDim = mc.output_embedding_dim;

                document.getElementById('mcName').value = mc.name;
                document.getElementById('mcDescription').value = mc.description || '';
                document.getElementById('mcOutputEmbeddingDim').value = mc.output_embedding_dim;
                document.getElementById('mcOptimizer').value = mc.optimizer;
                document.getElementById('mcLearningRate').value = mc.learning_rate;
                document.getElementById('mcBatchSize').value = mc.batch_size;
                document.getElementById('mcEpochs').value = mc.epochs;

                selectModelType(mc.model_type);

                mcCurrentStep = 1;
                document.getElementById('modelConfigWizardTitle').textContent = 'Edit Model Config';
                document.getElementById('mcBtnCreate').innerHTML = '<i class="fas fa-check mr-1"></i> Save Changes';
                closeModelConfigViewModal();
                document.getElementById('modelConfigWizardModal').classList.remove('hidden');
                updateMcStep();
            }
        })
        .catch(err => console.error('Error loading model config:', err));
}

// Helper: Escape HTML
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Helper: Show Toast (if not already defined)
if (typeof showToast !== 'function') {
    function showToast(message, type) {
        console.log(`[${type}] ${message}`);
    }
}
</script>
{% endblock %}
