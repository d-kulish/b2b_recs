{% extends 'base_model.html' %}
{% load humanize %}
{% load static %}

{% block title %}{{ model.name }} - Modeling{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/cards.css' %}?v=4">
<link rel="stylesheet" href="{% static 'css/modals.css' %}?v=2">
<style>
    /* Feature Config specific styles */
    .tensor-dim-bar {
        height: 8px;
        background: #e5e7eb;
        border-radius: 4px;
        overflow: hidden;
    }
    .tensor-dim-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.3s ease;
    }
    .tensor-dim-fill.buyer {
        background: linear-gradient(90deg, #3b82f6, #60a5fa);
    }
    .tensor-dim-fill.product {
        background: linear-gradient(90deg, #10b981, #34d399);
    }
    .tensor-breakdown {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-top: 8px;
    }
    .tensor-breakdown-item {
        font-size: 11px;
        padding: 2px 6px;
        background: #f3f4f6;
        border-radius: 4px;
        color: #6b7280;
    }
    .config-card {
        transition: all 0.2s ease;
    }
    .config-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 8px;
        border-radius: 9999px;
        font-size: 11px;
        font-weight: 500;
    }
    .status-badge.draft {
        background: #fef3c7;
        color: #92400e;
    }
    .status-badge.active {
        background: #d1fae5;
        color: #065f46;
    }
    .status-badge.archived {
        background: #e5e7eb;
        color: #6b7280;
    }
    .leakage-warning {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 6px;
        background: #fef3c7;
        border-radius: 4px;
        font-size: 11px;
        color: #92400e;
    }

    /* Drag and drop styles - Compact column cards */
    .column-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 6px 8px;
        cursor: grab;
        transition: all 0.15s ease;
        user-select: none;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .column-card:hover {
        border-color: #3b82f6;
        background: #f8fafc;
    }
    .column-card.dragging {
        opacity: 0.5;
        cursor: grabbing;
    }
    .column-card .drag-handle {
        color: #d1d5db;
        font-size: 10px;
        flex-shrink: 0;
    }
    .column-card .column-name {
        font-size: 12px;
        font-weight: 500;
        color: #374151;
        flex: 1;
        min-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .column-card .column-type {
        font-size: 10px;
        padding: 1px 4px;
        background: #f3f4f6;
        border-radius: 3px;
        color: #6b7280;
        text-transform: uppercase;
    }

    .drop-zone {
        min-height: 200px;
        border: 2px dashed #e5e7eb;
        border-radius: 12px;
        padding: 16px;
        transition: all 0.2s ease;
    }
    .drop-zone.drag-over {
        border-color: #3b82f6;
        background: #eff6ff;
    }
    .drop-zone-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 150px;
        color: #9ca3af;
    }

    .assigned-feature {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 8px;
    }
    .assigned-feature:hover {
        border-color: #d1d5db;
    }
    .feature-config-btn {
        width: 28px;
        height: 28px;
        border-radius: 6px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: none;
        cursor: pointer;
        transition: all 0.15s ease;
    }
    .feature-config-btn.settings {
        background: #f3f4f6;
        color: #6b7280;
    }
    .feature-config-btn.settings:hover {
        background: #e5e7eb;
        color: #374151;
    }
    .feature-config-btn.remove {
        background: #fef2f2;
        color: #dc2626;
    }
    .feature-config-btn.remove:hover {
        background: #fee2e2;
    }

    .cross-feature {
        background: #f0fdf4;
        border: 1px solid #bbf7d0;
        border-radius: 8px;
        padding: 10px 12px;
        margin-bottom: 8px;
    }

    /* Tensor preview */
    .tensor-preview-panel {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 16px;
    }
    .tensor-preview-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
    }
    .tensor-preview-title {
        font-weight: 600;
        color: #374151;
    }
    .tensor-preview-total {
        font-size: 24px;
        font-weight: 700;
    }
    .tensor-preview-total.buyer {
        color: #3b82f6;
    }
    .tensor-preview-total.product {
        color: #10b981;
    }
    .tensor-breakdown-bar {
        display: flex;
        height: 24px;
        border-radius: 6px;
        overflow: hidden;
        background: #e5e7eb;
        margin-bottom: 8px;
    }
    .tensor-breakdown-segment {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: 500;
        color: white;
        transition: width 0.3s ease;
        overflow: hidden;
        white-space: nowrap;
    }

    /* Modal form styles */
    .modal-form-group {
        margin-bottom: 16px;
    }
    .modal-form-label {
        display: block;
        font-size: 13px;
        font-weight: 500;
        color: #374151;
        margin-bottom: 6px;
    }
    .modal-form-hint {
        font-size: 12px;
        color: #6b7280;
        margin-top: 4px;
    }
    .transform-option {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        padding: 12px;
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        margin-bottom: 8px;
    }
    .transform-option input[type="checkbox"] {
        margin-top: 2px;
    }
    .transform-option-content {
        flex: 1;
    }
    .transform-option-title {
        font-weight: 500;
        color: #374151;
    }
    .transform-option-desc {
        font-size: 12px;
        color: #6b7280;
        margin-top: 2px;
    }
    .transform-option-dim {
        font-size: 12px;
        font-weight: 600;
        color: #3b82f6;
        white-space: nowrap;
    }

    /* Sample Table Styles */
    .sample-table-container {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        overflow: hidden;
    }
    .sample-table-wrapper {
        max-height: 240px;
        overflow: auto;
    }
    .sample-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
    }
    .sample-table th {
        position: sticky;
        top: 0;
        background: #f9fafb;
        padding: 8px 12px;
        text-align: left;
        font-weight: 600;
        color: #374151;
        border-bottom: 2px solid #e5e7eb;
        white-space: nowrap;
    }
    .sample-table td {
        padding: 6px 12px;
        border-bottom: 1px solid #f3f4f6;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .sample-table tr:hover td {
        background: #f9fafb;
    }

    /* Column assignment colors for sample table */
    .col-buyer {
        background-color: #eff6ff !important;
    }
    .col-product {
        background-color: #f0fdf4 !important;
    }
    .col-both {
        background-color: #fef2f2 !important;
    }
    .sample-table th.col-buyer {
        background-color: #dbeafe !important;
        border-bottom-color: #3b82f6;
    }
    .sample-table th.col-product {
        background-color: #dcfce7 !important;
        border-bottom-color: #10b981;
    }
    .sample-table th.col-both {
        background-color: #fee2e2 !important;
        border-bottom-color: #ef4444;
    }
    .null-value {
        color: #9ca3af;
        font-style: italic;
    }

    /* BQ type badge in column cards */
    .column-bq-type {
        font-size: 9px;
        padding: 1px 4px;
        background: #f3f4f6;
        border-radius: 3px;
        color: #6b7280;
        font-family: monospace;
        flex-shrink: 0;
        text-transform: uppercase;
    }

    /* Needs attention state for features without transforms */
    .feature-config-btn.needs-attention {
        background: #fef3c7;
        color: #d97706;
        animation: pulse-attention 2s infinite;
    }
    @keyframes pulse-attention {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }
    .assigned-feature.feature-needs-config {
        background: #fef3c7;
        border-color: #fcd34d;
    }

    /* Column card assignment states */
    .column-card.assigned-buyer {
        border-left: 2px solid #3b82f6;
        background: #eff6ff;
    }
    .column-card.assigned-product {
        border-left: 2px solid #10b981;
        background: #f0fdf4;
    }
    .column-card.assigned-both {
        border-left: 2px solid #ef4444;
        background: #fef2f2;
    }

    /* Primary ID Drop Zone Styles */
    .primary-id-zone {
        border: 2px dashed #f59e0b;
        border-radius: 10px;
        padding: 16px;
        margin-bottom: 12px;
        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        position: relative;
    }
    .primary-id-zone.buyer {
        border-color: #3b82f6;
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    }
    .primary-id-zone.product {
        border-color: #10b981;
        background: linear-gradient(135deg, #f0fdf4 0%, #d1fae5 100%);
    }
    .primary-id-zone.drag-over {
        border-style: solid;
        box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.3);
    }
    .primary-id-zone.buyer.drag-over {
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
    }
    .primary-id-zone.product.drag-over {
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3);
    }
    .primary-id-zone-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
    }
    .primary-id-zone-icon {
        width: 24px;
        height: 24px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
    }
    .primary-id-zone.buyer .primary-id-zone-icon {
        background: #3b82f6;
        color: white;
    }
    .primary-id-zone.product .primary-id-zone-icon {
        background: #10b981;
        color: white;
    }
    .primary-id-zone-title {
        font-weight: 600;
        font-size: 14px;
        color: #374151;
    }
    .primary-id-zone-required {
        font-size: 10px;
        font-weight: 500;
        padding: 2px 6px;
        border-radius: 4px;
        background: transparent;
        color: #6b7280;
        margin-left: auto;
    }
    .primary-id-zone-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        color: #6b7280;
        text-align: center;
    }
    .primary-id-zone-empty i {
        font-size: 24px;
        margin-bottom: 8px;
        opacity: 0.5;
    }
    .primary-id-zone-empty span {
        font-size: 13px;
    }

    /* Assigned Primary ID Feature */
    .primary-id-assigned {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 12px;
    }
    .primary-id-zone.buyer .primary-id-assigned {
        border-color: #93c5fd;
    }
    .primary-id-zone.product .primary-id-assigned {
        border-color: #6ee7b7;
    }

    /* Additional Features Section - Locked State */
    .additional-features-section {
        border: 2px dashed #e5e7eb;
        border-radius: 10px;
        padding: 16px;
        min-height: 120px;
        transition: all 0.3s ease;
    }
    .additional-features-section.buyer {
        border-color: #3b82f6;
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    }
    .additional-features-section.product {
        border-color: #10b981;
        background: linear-gradient(135deg, #f0fdf4 0%, #d1fae5 100%);
    }
    .additional-features-section.locked {
        opacity: 0.6;
        pointer-events: none;
    }
    .additional-features-section.locked::before {
        content: '';
        position: absolute;
        inset: 0;
        cursor: not-allowed;
    }
    .additional-features-section.drag-over {
        border-style: solid;
    }
    .additional-features-section.buyer.drag-over {
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
    }
    .additional-features-section.product.drag-over {
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3);
    }
    .additional-features-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
        color: #6b7280;
        font-size: 13px;
        font-weight: 500;
    }
    .additional-features-header i {
        font-size: 12px;
    }
    .locked-message {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        color: #9ca3af;
        text-align: center;
    }
    .locked-message i {
        font-size: 20px;
        margin-bottom: 8px;
    }
    .locked-message span {
        font-size: 12px;
    }
</style>
{% endblock %}

{% block model_content %}
<div class="space-y-6">
    <!-- Modeling Container -->
    <div class="bg-white rounded-xl border border-black shadow-lg p-6">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-gray-900">Features</h2>
            <div class="btn-group">
                <button onclick="refreshConfigs()" class="btn btn-secondary btn-sm" style="width: 150px;">
                    <i class="fas fa-sync-alt"></i>Refresh
                </button>
                <button onclick="openWizard()" class="btn btn-primary btn-sm" style="width: 150px;">
                    <i class="fas fa-plus"></i>New Feats Set
                </button>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="flex items-center gap-4 mb-4">
            <div class="flex items-center gap-2">
                <label class="text-sm font-medium text-gray-600">Dataset:</label>
                <select id="datasetFilter" onchange="filterConfigs()" class="form-select text-sm" style="min-width: 200px;">
                    <option value="">All Datasets</option>
                </select>
            </div>
            <div class="flex items-center gap-2">
                <label class="text-sm font-medium text-gray-600">Status:</label>
                <select id="statusFilter" onchange="filterConfigs()" class="form-select text-sm" style="width: 120px;">
                    <option value="">All</option>
                    <option value="draft">Draft</option>
                    <option value="active">Active</option>
                    <option value="archived">Archived</option>
                </select>
            </div>
            <div class="flex-1">
                <input type="text" id="searchInput" placeholder="Search feature configs..."
                       class="form-input w-full text-sm" onkeyup="debounceSearch()">
            </div>
        </div>

        <!-- Feature Configs List -->
        <div id="configsList" class="space-y-3" style="min-height: 200px;">
            <!-- Loading state -->
            <div id="configsLoading" class="flex items-center justify-center py-12">
                <i class="fas fa-spinner fa-spin text-2xl text-gray-400 mr-3"></i>
                <span class="text-gray-500">Loading feature configs...</span>
            </div>
            <!-- Empty state (hidden by default) -->
            <div id="configsEmpty" class="card-empty-state hidden">
                <p class="card-empty-state-title">No feature configs yet</p>
                <p class="card-empty-state-text">Create your first feature config to define how columns are transformed for training</p>
            </div>
            <!-- Config cards will be inserted here -->
        </div>
    </div>
</div>

<!-- Feature Config Wizard Modal -->
<div id="featureConfigWizardModal" class="modal-overlay hidden">
    <div class="modal-container modal-container-wizard" style="max-width: 1100px;">
        <!-- Modal Header -->
        <div class="modal-header-wizard">
            <div class="modal-header-content">
                <div class="modal-header-icon info">
                    <i class="fas fa-cogs text-lg"></i>
                </div>
                <div class="modal-header-info">
                    <h3 class="modal-header-title" id="wizardTitle">Create Feature Config</h3>
                    <p class="modal-step-counter">Step <span id="currentStep">1</span> of 2</p>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress-bar-pills">
                <div id="progress1" class="progress-step-pill current">Basic Info</div>
                <div id="progress2" class="progress-step-pill future">Features</div>
            </div>
        </div>

        <!-- Modal Body -->
        <div class="modal-body-wizard" style="max-height: calc(90vh - 200px); overflow-y: auto;">
            <!-- Step 1: Basic Info -->
            <div id="wizardStep1" class="wizard-step active">
                <h4 class="wizard-section-title">Basic Information</h4>

                <!-- Config Name -->
                <div class="wizard-field-group">
                    <label class="wizard-field-label">Config Name <span class="required">*</span></label>
                    <input type="text" id="configName" placeholder="e.g., Rich Features v1"
                           class="form-input w-full" oninput="validateConfigName()">
                    <p id="nameError" class="text-xs text-red-600 mt-1 hidden"></p>
                </div>

                <!-- Description -->
                <div class="wizard-field-group">
                    <label class="wizard-field-label">Description <span class="optional">(optional)</span></label>
                    <textarea id="configDescription" placeholder="Describe the purpose of this feature configuration..."
                              class="form-textarea w-full" rows="2"></textarea>
                </div>

                <!-- Dataset Selection -->
                <div class="wizard-field-group">
                    <label class="wizard-field-label">Base Dataset <span class="required">*</span></label>
                    <select id="configDataset" class="form-select w-full" onchange="onDatasetChange()">
                        <option value="">Select a dataset...</option>
                    </select>
                    <div id="datasetInfo" class="text-xs text-gray-500 mt-2 hidden">
                        <span id="datasetInfoText"></span>
                    </div>
                </div>

                <!-- Start From Options -->
                <div class="wizard-field-group">
                    <label class="wizard-field-label">Start From</label>
                    <div class="flex flex-wrap gap-3 mt-2">
                        <label class="flex items-center gap-2 p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition">
                            <input type="radio" name="startFrom" value="blank" checked onchange="onStartFromChange()">
                            <div>
                                <div class="font-medium text-sm">Blank</div>
                                <div class="text-xs text-gray-500">Start from scratch</div>
                            </div>
                        </label>
                        <label class="flex items-center gap-2 p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition">
                            <input type="radio" name="startFrom" value="clone" onchange="onStartFromChange()">
                            <div>
                                <div class="font-medium text-sm">Clone Existing</div>
                                <div class="text-xs text-gray-500">Copy from another config</div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Clone Selection (hidden by default) -->
                <div id="cloneSelection" class="wizard-field-group hidden">
                    <label class="wizard-field-label">Clone From</label>
                    <select id="cloneFromConfig" class="form-select w-full">
                        <option value="">Select a config to clone...</option>
                    </select>
                </div>

                <div class="wizard-info-box info">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>What is a Feature Config?</strong><br>
                        A feature config defines how dataset columns are transformed into tensors for the two-tower model (BuyerModel and ProductModel).
                    </div>
                </div>
            </div>

            <!-- Step 2: Feature Assignment -->
            <div id="wizardStep2" class="wizard-step hidden">
                <!-- Dataset Sample - Collapsible Tablet -->
                <div class="filter-subchapter" id="datasetSampleSubchapter">
                    <div class="subchapter-header-tablet" onclick="toggleModelingSubchapter('datasetSample')">
                        <span class="subchapter-title">Dataset Sample</span>
                        <span class="subchapter-filter-status" id="datasetSampleStatus"></span>
                        <i id="datasetSampleChevron" class="fas fa-chevron-right subchapter-chevron"></i>
                    </div>
                    <div id="datasetSampleContent" class="subchapter-content-outside hidden">
                        <div id="sampleDataTable" class="sample-table-container">
                            <!-- Table will be rendered here -->
                        </div>
                    </div>
                </div>

                <!-- Available Columns - Collapsible Tablet -->
                <div class="filter-subchapter" id="availableColumnsSubchapter">
                    <div class="subchapter-header-tablet" onclick="toggleModelingSubchapter('availableColumns')">
                        <span class="subchapter-title">Available Columns</span>
                        <span class="subchapter-filter-status" id="availableColumnsStatus"></span>
                        <i id="availableColumnsChevron" class="fas fa-chevron-down subchapter-chevron"></i>
                    </div>
                    <div id="availableColumnsContent" class="subchapter-content-outside">
                        <p class="text-xs text-gray-500 mb-2">Drag columns to BuyerModel or ProductModel</p>
                        <div id="availableColumns" class="grid grid-cols-4 gap-2" style="max-height: 180px; overflow-y: auto;">
                            <!-- Column cards will be inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Model Drop Zones -->
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <!-- Buyer Model -->
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                            <span class="w-3 h-3 rounded-full bg-blue-500"></span>
                            <h5 class="font-semibold text-gray-800">BuyerModel (Query Tower)</h5>
                        </div>

                        <!-- Primary ID Zone: Customer ID -->
                        <div id="customerIdZone" class="primary-id-zone buyer"
                             ondrop="dropPrimaryId(event, 'buyer')"
                             ondragover="allowDrop(event)"
                             ondragenter="dragEnterPrimaryId(event)"
                             ondragleave="dragLeavePrimaryId(event)">
                            <div class="primary-id-zone-header">
                                <div class="primary-id-zone-icon">
                                    <i class="fas fa-key"></i>
                                </div>
                                <span class="primary-id-zone-title">Customer ID</span>
                                <span class="primary-id-zone-required">Required</span>
                            </div>
                            <div id="customerIdContent">
                                <!-- Will be rendered by JS: empty state or assigned feature -->
                            </div>
                        </div>

                        <!-- Context Features Section -->
                        <div id="buyerAdditionalSection" class="additional-features-section buyer locked"
                             ondrop="dropFeature(event, 'buyer')"
                             ondragover="allowDropIfUnlocked(event, 'buyer')"
                             ondragenter="dragEnterIfUnlocked(event, 'buyer')"
                             ondragleave="dragLeave(event)">
                            <div class="additional-features-header">
                                <i class="fas fa-layer-group"></i>
                                <span>Context Features</span>
                            </div>
                            <div id="buyerLockedMessage" class="locked-message">
                                <i class="fas fa-lock"></i>
                                <span>Assign Customer ID first to add more features</span>
                            </div>
                            <div id="buyerModelFeatures"></div>
                            <div id="buyerModelCrosses" class="mt-3"></div>
                            <button type="button" class="btn btn-secondary btn-xs mt-2" onclick="openCrossModal('buyer')" id="addBuyerCrossBtn" style="display: none;">
                                <i class="fas fa-plus mr-1"></i>Add Cross Feature
                            </button>
                        </div>
                    </div>

                    <!-- Product Model -->
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                            <span class="w-3 h-3 rounded-full bg-green-500"></span>
                            <h5 class="font-semibold text-gray-800">ProductModel (Candidate Tower)</h5>
                        </div>

                        <!-- Primary ID Zone: Product ID -->
                        <div id="productIdZone" class="primary-id-zone product"
                             ondrop="dropPrimaryId(event, 'product')"
                             ondragover="allowDrop(event)"
                             ondragenter="dragEnterPrimaryId(event)"
                             ondragleave="dragLeavePrimaryId(event)">
                            <div class="primary-id-zone-header">
                                <div class="primary-id-zone-icon">
                                    <i class="fas fa-key"></i>
                                </div>
                                <span class="primary-id-zone-title">Product ID</span>
                                <span class="primary-id-zone-required">Required</span>
                            </div>
                            <div id="productIdContent">
                                <!-- Will be rendered by JS: empty state or assigned feature -->
                            </div>
                        </div>

                        <!-- Context Features Section -->
                        <div id="productAdditionalSection" class="additional-features-section product locked"
                             ondrop="dropFeature(event, 'product')"
                             ondragover="allowDropIfUnlocked(event, 'product')"
                             ondragenter="dragEnterIfUnlocked(event, 'product')"
                             ondragleave="dragLeave(event)">
                            <div class="additional-features-header">
                                <i class="fas fa-layer-group"></i>
                                <span>Context Features</span>
                            </div>
                            <div id="productLockedMessage" class="locked-message">
                                <i class="fas fa-lock"></i>
                                <span>Assign Product ID first to add more features</span>
                            </div>
                            <div id="productModelFeatures"></div>
                            <div id="productModelCrosses" class="mt-3"></div>
                            <button type="button" class="btn btn-secondary btn-xs mt-2" onclick="openCrossModal('product')" id="addProductCrossBtn" style="display: none;">
                                <i class="fas fa-plus mr-1"></i>Add Cross Feature
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tensor Preview -->
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <div class="tensor-preview-panel">
                        <div class="tensor-preview-header">
                            <span class="tensor-preview-title">Buyer Tensor</span>
                            <span id="buyerTensorTotal" class="tensor-preview-total buyer">0D</span>
                        </div>
                        <div id="buyerTensorBar" class="tensor-breakdown-bar"></div>
                        <div id="buyerTensorBreakdown" class="tensor-breakdown"></div>
                    </div>
                    <div class="tensor-preview-panel">
                        <div class="tensor-preview-header">
                            <span class="tensor-preview-title">Product Tensor</span>
                            <span id="productTensorTotal" class="tensor-preview-total product">0D</span>
                        </div>
                        <div id="productTensorBar" class="tensor-breakdown-bar"></div>
                        <div id="productTensorBreakdown" class="tensor-breakdown"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="modal-footer-wizard-neu">
            <div class="footer-left">
                <button type="button" id="backBtn" class="btn-neu btn-neu-nav hidden" onclick="prevStep()">
                    <span class="btn-neu-inner"><i class="fas fa-chevron-left"></i></span>
                </button>
                <button type="button" id="nextBtn" class="btn-neu btn-neu-nav" onclick="nextStep()">
                    <span class="btn-neu-inner"><i class="fas fa-chevron-right"></i></span>
                </button>
            </div>
            <div class="footer-right">
                <button type="button" id="saveBtn" class="btn-neu btn-neu-action btn-neu-save hidden" onclick="saveConfig()">
                    <span class="btn-neu-inner">Save</span>
                </button>
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeWizard()">
                    <span class="btn-neu-inner">Cancel</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Feature Configuration Modal -->
<div id="featureConfigModal" class="modal-overlay hidden">
    <div class="modal-container" style="max-width: 500px;">
        <div class="modal-header">
            <div class="modal-header-icon info">
                <i class="fas fa-cog"></i>
            </div>
            <h3 class="modal-header-title" id="featureModalTitle">Configure Feature</h3>
            <button type="button" class="modal-close-btn" onclick="closeFeatureModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" id="featureModalBody">
            <!-- Content will be dynamically generated -->
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-save" onclick="applyFeatureConfig()">
                    <span class="btn-neu-inner">Apply</span>
                </button>
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeFeatureModal()">
                    <span class="btn-neu-inner">Cancel</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Cross Feature Modal -->
<div id="crossFeatureModal" class="modal-overlay hidden">
    <div class="modal-container" style="max-width: 500px;">
        <div class="modal-header">
            <div class="modal-header-icon info">
                <i class="fas fa-times"></i>
            </div>
            <h3 class="modal-header-title">Add Cross Feature</h3>
            <button type="button" class="modal-close-btn" onclick="closeCrossModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="modal-form-group">
                <label class="modal-form-label">Select 2-3 features to cross</label>
                <div id="crossFeatureOptions" class="space-y-2">
                    <!-- Feature checkboxes will be inserted here -->
                </div>
            </div>
            <div id="crossPreview" class="text-sm text-gray-600 mt-3 hidden">
                Selected: <span id="crossPreviewText" class="font-medium"></span>
            </div>
            <!-- Bucketization options for numeric/temporal features -->
            <div id="crossBucketOptions" class="mt-4 hidden">
                <div class="text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-info-circle text-blue-500 mr-1"></i>
                    Numeric/temporal features need bucketization for crossing
                </div>
                <div id="crossBucketInputs" class="space-y-3">
                    <!-- Bucket inputs for each numeric/temporal feature will be inserted here -->
                </div>
            </div>
            <div class="modal-form-group mt-4">
                <label class="modal-form-label">Hash Bucket Size</label>
                <select id="crossHashBuckets" class="form-select w-full">
                    <option value="1000">1,000</option>
                    <option value="5000" selected>5,000</option>
                    <option value="10000">10,000</option>
                    <option value="50000">50,000</option>
                </select>
                <p class="modal-form-hint">Number of hash buckets for the crossed features</p>
            </div>
            <div class="modal-form-group">
                <label class="modal-form-label">Embedding Dimension</label>
                <select id="crossEmbedDim" class="form-select w-full">
                    <option value="8">8</option>
                    <option value="16" selected>16</option>
                    <option value="32">32</option>
                </select>
            </div>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-save" onclick="addCrossFeature()">
                    <span class="btn-neu-inner">Add Cross</span>
                </button>
                <button type="button" class="btn-neu btn-neu-action btn-neu-cancel" onclick="closeCrossModal()">
                    <span class="btn-neu-inner">Cancel</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View Config Modal -->
<div id="viewConfigModal" class="modal-overlay hidden">
    <div class="modal-container" style="max-width: 700px;">
        <div class="modal-header">
            <div class="modal-header-icon info">
                <i class="fas fa-eye"></i>
            </div>
            <h3 class="modal-header-title" id="viewConfigTitle">Feature Config Details</h3>
            <button type="button" class="modal-close-btn" onclick="closeViewModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" id="viewConfigBody" style="max-height: 70vh; overflow-y: auto;">
            <!-- Content will be dynamically generated -->
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button type="button" class="btn-neu btn-neu-action btn-neu-secondary" onclick="closeViewModal()">
                    <span class="btn-neu-inner">Close</span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
const modelId = {{ model.id }};
let allConfigs = [];
let allDatasets = [];
let currentStep = 1;
let editingConfigId = null;
let searchTimeout = null;

// Current feature config state
let configState = {
    name: '',
    description: '',
    datasetId: null,
    startFrom: 'blank',
    cloneFromId: null,
    // Primary ID features (required before adding other features)
    customerIdFeature: null,  // Primary ID for BuyerModel
    productIdFeature: null,   // Primary ID for ProductModel
    // Additional features (unlocked after primary ID is set)
    buyerFeatures: [],
    productFeatures: [],
    buyerCrosses: [],
    productCrosses: [],
    availableColumns: [],
    sampleRows: [],
    columnOrder: []
};

// Currently editing feature
let editingFeature = null;
let editingFeatureModel = null;
let crossFeatureModel = null;

// =============================================================================
// CSRF TOKEN HELPER
// =============================================================================

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// =============================================================================
// INITIALIZATION
// =============================================================================

document.addEventListener('DOMContentLoaded', function() {
    loadDatasets();
    loadConfigs();
});

function loadDatasets() {
    fetch(`/api/models/${modelId}/modeling/datasets/`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                allDatasets = data.data;
                populateDatasetFilters();
            }
        })
        .catch(err => console.error('Error loading datasets:', err));
}

function loadConfigs() {
    document.getElementById('configsLoading').classList.remove('hidden');
    document.getElementById('configsEmpty').classList.add('hidden');

    const datasetId = document.getElementById('datasetFilter').value;
    const status = document.getElementById('statusFilter').value;

    let url = `/api/models/${modelId}/feature-configs/?`;
    if (datasetId) url += `dataset_id=${datasetId}&`;
    if (status) url += `status=${status}&`;

    fetch(url)
        .then(r => r.json())
        .then(data => {
            document.getElementById('configsLoading').classList.add('hidden');
            if (data.success) {
                allConfigs = data.data;
                renderConfigs();
            } else {
                showError(data.error || 'Failed to load configs');
            }
        })
        .catch(err => {
            document.getElementById('configsLoading').classList.add('hidden');
            console.error('Error loading configs:', err);
            showError('Failed to load feature configs');
        });
}

function refreshConfigs() {
    loadConfigs();
}

function populateDatasetFilters() {
    const filterSelect = document.getElementById('datasetFilter');
    const wizardSelect = document.getElementById('configDataset');

    // Clear existing options (except first)
    filterSelect.innerHTML = '<option value="">All Datasets</option>';
    wizardSelect.innerHTML = '<option value="">Select a dataset...</option>';

    allDatasets.forEach(ds => {
        const opt1 = document.createElement('option');
        opt1.value = ds.id;
        opt1.textContent = ds.name;
        filterSelect.appendChild(opt1);

        const opt2 = document.createElement('option');
        opt2.value = ds.id;
        opt2.textContent = ds.name;
        wizardSelect.appendChild(opt2);
    });
}

// =============================================================================
// RENDER CONFIGS LIST
// =============================================================================

function renderConfigs() {
    const container = document.getElementById('configsList');
    const emptyState = document.getElementById('configsEmpty');
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();

    // Filter by search
    let filtered = allConfigs;
    if (searchTerm) {
        filtered = allConfigs.filter(c =>
            c.name.toLowerCase().includes(searchTerm) ||
            (c.description && c.description.toLowerCase().includes(searchTerm))
        );
    }

    // Remove old cards
    container.querySelectorAll('.config-card').forEach(el => el.remove());

    if (filtered.length === 0) {
        emptyState.classList.remove('hidden');
        return;
    }

    emptyState.classList.add('hidden');

    filtered.forEach(config => {
        const card = createConfigCard(config);
        container.appendChild(card);
    });
}

function createConfigCard(config) {
    const card = document.createElement('div');
    card.className = 'config-card bg-white border border-gray-200 rounded-lg p-4 hover:border-gray-300';

    const buyerDim = config.buyer_tensor_dim || 0;
    const productDim = config.product_tensor_dim || 0;
    const totalDim = buyerDim + productDim;
    const maxDim = 300; // For bar width calculation

    const leakageWarning = config.columns_in_both_models && config.columns_in_both_models.length > 0
        ? `<span class="leakage-warning"><i class="fas fa-exclamation-triangle"></i>${config.columns_in_both_models.length} shared</span>`
        : '';

    card.innerHTML = `
        <div class="flex items-start justify-between">
            <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                    <h3 class="font-semibold text-gray-900">${escapeHtml(config.name)}</h3>
                    <span class="text-xs text-gray-400">v${config.version}</span>
                    <span class="status-badge ${config.status}">${config.status}</span>
                    ${leakageWarning}
                </div>
                <p class="text-sm text-gray-500 mb-2">Dataset: ${escapeHtml(config.dataset_name)}</p>
                ${config.description ? `<p class="text-sm text-gray-600 mb-3">${escapeHtml(config.description)}</p>` : ''}

                <div class="grid grid-cols-2 gap-4 mb-3">
                    <div>
                        <div class="flex items-center justify-between text-xs mb-1">
                            <span class="text-gray-500">BuyerModel</span>
                            <span class="font-semibold text-blue-600">${buyerDim}D</span>
                        </div>
                        <div class="tensor-dim-bar">
                            <div class="tensor-dim-fill buyer" style="width: ${Math.min(buyerDim / maxDim * 100, 100)}%"></div>
                        </div>
                        <div class="text-xs text-gray-400 mt-1">${config.buyer_features_count} features, ${config.buyer_crosses_count} crosses</div>
                    </div>
                    <div>
                        <div class="flex items-center justify-between text-xs mb-1">
                            <span class="text-gray-500">ProductModel</span>
                            <span class="font-semibold text-green-600">${productDim}D</span>
                        </div>
                        <div class="tensor-dim-bar">
                            <div class="tensor-dim-fill product" style="width: ${Math.min(productDim / maxDim * 100, 100)}%"></div>
                        </div>
                        <div class="text-xs text-gray-400 mt-1">${config.product_features_count} features, ${config.product_crosses_count} crosses</div>
                    </div>
                </div>

                <div class="text-xs text-gray-400">
                    Updated ${formatTimeAgo(config.updated_at)}
                    ${config.created_by ? ` by ${config.created_by}` : ''}
                </div>
            </div>
        </div>

        <div class="flex items-center gap-2 mt-3 pt-3 border-t border-gray-100">
            <button onclick="viewConfig(${config.id})" class="btn btn-secondary btn-xs">
                <i class="fas fa-eye mr-1"></i>View
            </button>
            <button onclick="editConfig(${config.id})" class="btn btn-secondary btn-xs">
                <i class="fas fa-edit mr-1"></i>Edit
            </button>
            <button onclick="cloneConfig(${config.id})" class="btn btn-secondary btn-xs">
                <i class="fas fa-copy mr-1"></i>Clone
            </button>
            <button onclick="deleteConfig(${config.id}, '${escapeHtml(config.name)}')" class="btn btn-secondary btn-xs text-red-600 hover:bg-red-50">
                <i class="fas fa-trash mr-1"></i>Delete
            </button>
        </div>
    `;

    return card;
}

// =============================================================================
// WIZARD FUNCTIONS
// =============================================================================

function openWizard(configId = null) {
    editingConfigId = configId;
    currentStep = 1;

    // Reset state
    configState = {
        name: '',
        description: '',
        datasetId: null,
        startFrom: 'blank',
        cloneFromId: null,
        customerIdFeature: null,
        productIdFeature: null,
        buyerFeatures: [],
        productFeatures: [],
        buyerCrosses: [],
        productCrosses: [],
        availableColumns: [],
        sampleRows: [],
        columnOrder: []
    };

    // Reset form
    document.getElementById('configName').value = '';
    document.getElementById('configDescription').value = '';
    document.getElementById('configDataset').value = '';
    document.getElementById('datasetInfo').classList.add('hidden');
    document.querySelector('input[name="startFrom"][value="blank"]').checked = true;
    document.getElementById('cloneSelection').classList.add('hidden');

    // Update UI
    document.getElementById('wizardTitle').textContent = configId ? 'Edit Feature Config' : 'Create Feature Config';
    updateWizardStep();

    // Show modal
    document.getElementById('featureConfigWizardModal').classList.remove('hidden');

    // If editing, load config data
    if (configId) {
        loadConfigForEdit(configId);
    }
}

function closeWizard() {
    document.getElementById('featureConfigWizardModal').classList.add('hidden');
    editingConfigId = null;
}

function loadConfigForEdit(configId) {
    fetch(`/api/feature-configs/${configId}/`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const config = data.data;
                document.getElementById('configName').value = config.name;
                document.getElementById('configDescription').value = config.description || '';
                document.getElementById('configDataset').value = config.dataset_id;

                configState.name = config.name;
                configState.description = config.description || '';
                configState.datasetId = config.dataset_id;

                // Extract primary ID features from the features arrays
                // Assume first feature with is_primary_id flag is the primary ID
                const buyerFeatures = config.buyer_model_features || [];
                const productFeatures = config.product_model_features || [];

                // Find and extract primary ID features
                const buyerPrimaryIdx = buyerFeatures.findIndex(f => f.is_primary_id);
                if (buyerPrimaryIdx !== -1) {
                    configState.customerIdFeature = buyerFeatures[buyerPrimaryIdx];
                    configState.buyerFeatures = buyerFeatures.filter((_, idx) => idx !== buyerPrimaryIdx);
                } else {
                    configState.buyerFeatures = buyerFeatures;
                }

                const productPrimaryIdx = productFeatures.findIndex(f => f.is_primary_id);
                if (productPrimaryIdx !== -1) {
                    configState.productIdFeature = productFeatures[productPrimaryIdx];
                    configState.productFeatures = productFeatures.filter((_, idx) => idx !== productPrimaryIdx);
                } else {
                    configState.productFeatures = productFeatures;
                }

                configState.buyerCrosses = config.buyer_model_crosses || [];
                configState.productCrosses = config.product_model_crosses || [];

                onDatasetChange();
            }
        });
}

function updateWizardStep() {
    // Update step visibility
    document.getElementById('wizardStep1').classList.toggle('hidden', currentStep !== 1);
    document.getElementById('wizardStep1').classList.toggle('active', currentStep === 1);
    document.getElementById('wizardStep2').classList.toggle('hidden', currentStep !== 2);
    document.getElementById('wizardStep2').classList.toggle('active', currentStep === 2);

    // Update progress pills - use completed/current/future classes
    for (let i = 1; i <= 2; i++) {
        const pill = document.getElementById(`progress${i}`);
        pill.classList.remove('current', 'completed', 'future');
        if (i < currentStep) {
            pill.classList.add('completed');
        } else if (i === currentStep) {
            pill.classList.add('current');
        } else {
            pill.classList.add('future');
        }
    }

    // Update buttons
    document.getElementById('backBtn').classList.toggle('hidden', currentStep === 1);
    document.getElementById('nextBtn').classList.toggle('hidden', currentStep === 2);
    document.getElementById('saveBtn').classList.toggle('hidden', currentStep !== 2);

    // Update step counter
    document.getElementById('currentStep').textContent = currentStep;
}

function nextStep() {
    if (currentStep === 1) {
        // Validate step 1
        const name = document.getElementById('configName').value.trim();
        const datasetId = document.getElementById('configDataset').value;

        if (!name) {
            document.getElementById('nameError').textContent = 'Name is required';
            document.getElementById('nameError').classList.remove('hidden');
            return;
        }
        if (!datasetId) {
            showError('Please select a dataset');
            return;
        }

        configState.name = name;
        configState.description = document.getElementById('configDescription').value.trim();
        configState.datasetId = parseInt(datasetId);
        configState.startFrom = document.querySelector('input[name="startFrom"]:checked').value;

        // Load columns and initialize step 2
        loadColumnsForStep2();

        currentStep = 2;
        updateWizardStep();
    }
}

function prevStep() {
    if (currentStep > 1) {
        currentStep--;
        updateWizardStep();
    }
}

function validateConfigName() {
    document.getElementById('nameError').classList.add('hidden');
}

function onDatasetChange() {
    const datasetId = document.getElementById('configDataset').value;
    const datasetInfo = document.getElementById('datasetInfo');

    if (datasetId) {
        const dataset = allDatasets.find(d => d.id == datasetId);
        if (dataset) {
            const rowsText = dataset.total_rows != null
                ? dataset.total_rows.toLocaleString() + ' rows'
                : 'Unknown rows';
            const colsText = dataset.column_count != null
                ? dataset.column_count + ' columns'
                : '? columns';
            document.getElementById('datasetInfoText').textContent = `${rowsText} | ${colsText}`;
            datasetInfo.classList.remove('hidden');
        }
        loadCloneOptions(datasetId);
    } else {
        datasetInfo.classList.add('hidden');
    }
}

function onStartFromChange() {
    const startFrom = document.querySelector('input[name="startFrom"]:checked').value;
    document.getElementById('cloneSelection').classList.toggle('hidden', startFrom !== 'clone');
}

function loadCloneOptions(datasetId) {
    const select = document.getElementById('cloneFromConfig');
    select.innerHTML = '<option value="">Select a config to clone...</option>';

    allConfigs.filter(c => c.dataset_id == datasetId).forEach(config => {
        const opt = document.createElement('option');
        opt.value = config.id;
        opt.textContent = `${config.name} (${config.buyer_tensor_dim || 0}D + ${config.product_tensor_dim || 0}D)`;
        select.appendChild(opt);
    });
}

// =============================================================================
// STEP 2: FEATURE ASSIGNMENT
// =============================================================================

function loadColumnsForStep2() {
    const datasetId = configState.datasetId;
    const startFrom = configState.startFrom;

    // Use new schema-with-sample endpoint for accurate types and sample data
    fetch(`/api/datasets/${datasetId}/schema-with-sample/`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                configState.availableColumns = data.data.columns;
                configState.sampleRows = data.data.sample_rows || [];
                configState.columnOrder = data.data.column_order || [];

                // Handle start from options
                if (startFrom === 'clone') {
                    const cloneFromId = document.getElementById('cloneFromConfig').value;
                    if (cloneFromId) {
                        loadCloneData(cloneFromId);
                    } else {
                        renderStep2();
                    }
                } else {
                    renderStep2();
                }
            } else {
                console.error('Failed to load schema:', data.error);
                showToast('Failed to load column schema', 'error');
            }
        })
        .catch(err => {
            console.error('Error loading schema:', err);
            showToast('Error loading column schema', 'error');
        });
}

function loadCloneData(configId) {
    fetch(`/api/feature-configs/${configId}/`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const buyerFeatures = data.data.buyer_model_features || [];
                const productFeatures = data.data.product_model_features || [];

                // Find and extract primary ID features
                const buyerPrimaryIdx = buyerFeatures.findIndex(f => f.is_primary_id);
                if (buyerPrimaryIdx !== -1) {
                    configState.customerIdFeature = buyerFeatures[buyerPrimaryIdx];
                    configState.buyerFeatures = buyerFeatures.filter((_, idx) => idx !== buyerPrimaryIdx);
                } else {
                    configState.buyerFeatures = buyerFeatures;
                }

                const productPrimaryIdx = productFeatures.findIndex(f => f.is_primary_id);
                if (productPrimaryIdx !== -1) {
                    configState.productIdFeature = productFeatures[productPrimaryIdx];
                    configState.productFeatures = productFeatures.filter((_, idx) => idx !== productPrimaryIdx);
                } else {
                    configState.productFeatures = productFeatures;
                }

                configState.buyerCrosses = data.data.buyer_model_crosses || [];
                configState.productCrosses = data.data.product_model_crosses || [];
                renderStep2();
            }
        });
}

function renderStep2() {
    renderAvailableColumns();
    renderSampleTable();
    renderPrimaryIdZone('buyer');
    renderPrimaryIdZone('product');
    renderAssignedFeatures('buyer');
    renderAssignedFeatures('product');
    updateAdditionalFeaturesLockState();
    updateTensorPreview();
    updateSubchapterStatuses();
}

// Render the primary ID zone (Customer ID or Product ID)
function renderPrimaryIdZone(model) {
    const idFeature = model === 'buyer' ? configState.customerIdFeature : configState.productIdFeature;
    const contentContainer = document.getElementById(model === 'buyer' ? 'customerIdContent' : 'productIdContent');
    const idLabel = model === 'buyer' ? 'Customer ID' : 'Product ID';

    if (!idFeature) {
        // Empty state - show drop prompt
        contentContainer.innerHTML = `
            <div class="primary-id-zone-empty">
                <i class="fas fa-arrow-down"></i>
                <span>Drag a column here to set as ${idLabel}</span>
            </div>
        `;
    } else {
        // Assigned state - show the feature card
        const embedDim = idFeature.transforms?.embedding?.embedding_dim || 32;
        contentContainer.innerHTML = `
            <div class="primary-id-assigned">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <div class="font-medium text-sm">${escapeHtml(idFeature.column)}</div>
                        <div class="text-xs text-gray-500">
                            ${idFeature.bq_type || 'STRING'}  Text  Embed: ${embedDim}D
                        </div>
                    </div>
                    <div class="flex flex-col gap-1 ml-2">
                        <button type="button" class="feature-config-btn settings" onclick="openPrimaryIdConfig('${model}')" title="Configure embedding">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button type="button" class="feature-config-btn remove" onclick="removePrimaryId('${model}')" title="Remove">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
}

// Update lock state of additional features sections
function updateAdditionalFeaturesLockState() {
    const buyerSection = document.getElementById('buyerAdditionalSection');
    const productSection = document.getElementById('productAdditionalSection');
    const buyerLockedMsg = document.getElementById('buyerLockedMessage');
    const productLockedMsg = document.getElementById('productLockedMessage');

    // Buyer model: unlocked if customerIdFeature is set
    if (configState.customerIdFeature) {
        buyerSection.classList.remove('locked');
        buyerLockedMsg.style.display = 'none';
    } else {
        buyerSection.classList.add('locked');
        buyerLockedMsg.style.display = 'flex';
    }

    // Product model: unlocked if productIdFeature is set
    if (configState.productIdFeature) {
        productSection.classList.remove('locked');
        productLockedMsg.style.display = 'none';
    } else {
        productSection.classList.add('locked');
        productLockedMsg.style.display = 'flex';
    }
}

function toggleModelingSubchapter(name) {
    const content = document.getElementById(`${name}Content`);
    const chevron = document.getElementById(`${name}Chevron`);

    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        chevron.classList.remove('fa-chevron-right');
        chevron.classList.add('fa-chevron-down');
    } else {
        content.classList.add('hidden');
        chevron.classList.remove('fa-chevron-down');
        chevron.classList.add('fa-chevron-right');
    }
}

function updateSubchapterStatuses() {
    // Update Dataset Sample status
    const sampleStatus = document.getElementById('datasetSampleStatus');
    const sampleRows = configState.sampleRows || [];
    if (sampleStatus) {
        sampleStatus.textContent = sampleRows.length > 0 ? `${sampleRows.length} rows` : '';
    }

    // Update Available Columns status
    const columnsStatus = document.getElementById('availableColumnsStatus');
    const totalCols = configState.availableColumns.length;
    const buyerCount = configState.buyerFeatures.length;
    const productCount = configState.productFeatures.length;

    if (columnsStatus) {
        if (buyerCount > 0 || productCount > 0) {
            columnsStatus.textContent = `${buyerCount} buyer, ${productCount} product`;
        } else {
            columnsStatus.textContent = totalCols > 0 ? `${totalCols} columns` : '';
        }
    }
}

function renderAvailableColumns() {
    const container = document.getElementById('availableColumns');
    container.innerHTML = '';

    // Get assigned column names by model (including primary IDs)
    const buyerCols = new Set(configState.buyerFeatures.map(f => f.column));
    const productCols = new Set(configState.productFeatures.map(f => f.column));

    // Add primary ID columns to the sets
    if (configState.customerIdFeature) {
        buyerCols.add(configState.customerIdFeature.column);
    }
    if (configState.productIdFeature) {
        productCols.add(configState.productIdFeature.column);
    }

    configState.availableColumns.forEach(col => {
        const inBuyer = buyerCols.has(col.name);
        const inProduct = productCols.has(col.name);

        const card = document.createElement('div');
        card.className = 'column-card';

        // Add assignment state classes
        if (inBuyer && inProduct) {
            card.classList.add('assigned-both');
        } else if (inBuyer) {
            card.classList.add('assigned-buyer');
        } else if (inProduct) {
            card.classList.add('assigned-product');
        }

        // Only allow dragging if not assigned to both models
        const canDrag = !(inBuyer && inProduct);
        card.draggable = canDrag;
        card.dataset.column = JSON.stringify(col);
        if (canDrag) {
            card.ondragstart = (e) => dragStart(e, col);
            card.ondragend = dragEnd;
        }

        // Simple layout: drag handle | name | BQ type badge
        card.innerHTML = `
            <i class="fas fa-grip-vertical drag-handle"></i>
            <span class="column-name" title="${escapeHtml(col.name)}">${escapeHtml(col.name)}</span>
            <span class="column-bq-type">${formatBqType(col.bq_type || 'STRING')}</span>
        `;

        container.appendChild(card);
    });
}

function formatBqType(bqType) {
    // Format BigQuery types to shorter display names
    const typeMap = {
        'STRING': 'STR',
        'INTEGER': 'INT',
        'INT64': 'INT',
        'FLOAT': 'FLOAT',
        'FLOAT64': 'FLOAT',
        'NUMERIC': 'NUM',
        'BIGNUMERIC': 'NUM',
        'BOOLEAN': 'BOOL',
        'BOOL': 'BOOL',
        'TIMESTAMP': 'TIME',
        'DATETIME': 'TIME',
        'DATE': 'DATE',
        'TIME': 'TIME',
        'BYTES': 'BYTES',
    };
    return typeMap[bqType?.toUpperCase()] || bqType || 'STR';
}

// Data Type System
// Three main data types: numeric, text, temporal
const DATA_TYPES = {
    numeric: { label: 'Numeric', icon: 'hashtag' },
    text: { label: 'Text', icon: 'font' },
    temporal: { label: 'Temporal', icon: 'calendar' }
};

function getDataTypeLabel(dataType) {
    return DATA_TYPES[dataType]?.label || dataType;
}

function getDataTypeFromBqType(bqType) {
    // Map BigQuery type to our data type system
    const type = (bqType || 'STRING').toUpperCase();

    if (['INTEGER', 'INT64', 'FLOAT', 'FLOAT64', 'NUMERIC', 'BIGNUMERIC'].includes(type)) {
        return 'numeric';
    } else if (['TIMESTAMP', 'DATETIME', 'DATE', 'TIME'].includes(type)) {
        return 'temporal';
    } else {
        // STRING, BYTES, etc.
        return 'text';
    }
}

function getTransformOptionsForDataType(dataType) {
    // Return available transforms based on data type
    switch (dataType) {
        case 'numeric':
            return [
                { key: 'normalize', label: 'Normalize', desc: 'Scale to [-1, 1] range', outputDim: 1 },
                { key: 'bucketize', label: 'Bucketize', desc: 'Discretize into buckets + embed', outputDim: 'configurable' }
            ];
        case 'text':
            return [
                { key: 'embedding', label: 'Embedding', desc: 'Learn vector representation', outputDim: 'configurable' }
            ];
        case 'temporal':
            return [
                { key: 'normalize', label: 'Normalize', desc: 'Scale timestamp to [-1, 1]', outputDim: 1 },
                { key: 'cyclical', label: 'Cyclical', desc: 'Extract periodic patterns (month, week, etc.)', outputDim: 'varies' },
                { key: 'bucketize', label: 'Bucketize', desc: 'Discretize into time buckets + embed', outputDim: 'configurable' }
            ];
        default:
            return [];
    }
}

function updateFeatureDataType(model, idx, newDataType) {
    const features = model === 'buyer' ? configState.buyerFeatures : configState.productFeatures;
    if (features[idx]) {
        features[idx].data_type = newDataType;
        // Clear transforms when data type changes - user must reconfigure
        features[idx].transforms = {};
    }
    renderStep2();
}

function getFeatureDisplayInfo(feature) {
    // Returns display string showing data type and transform output
    const dataType = feature.data_type || getDataTypeFromBqType(feature.bq_type);
    const dataTypeLabel = getDataTypeLabel(dataType);
    const transforms = feature.transforms || {};

    // Calculate total output dimension
    let outputParts = [];
    let totalDim = 0;

    if (dataType === 'numeric') {
        if (transforms.normalize?.enabled) {
            outputParts.push('Norm: 1D');
            totalDim += 1;
        }
        if (transforms.bucketize?.enabled) {
            const dim = transforms.bucketize.embedding_dim || 32;
            outputParts.push(`Bucket: ${dim}D`);
            totalDim += dim;
        }
    } else if (dataType === 'text') {
        if (transforms.embedding?.enabled) {
            const dim = transforms.embedding.embedding_dim || 32;
            outputParts.push(`Embed: ${dim}D`);
            totalDim += dim;
        }
    } else if (dataType === 'temporal') {
        if (transforms.normalize?.enabled) {
            outputParts.push('Norm: 1D');
            totalDim += 1;
        }
        if (transforms.cyclical?.enabled) {
            const cyclical = transforms.cyclical;
            let cyclicalDim = 0;
            if (cyclical.yearly || cyclical.annual) cyclicalDim += 2;
            if (cyclical.quarterly) cyclicalDim += 2;
            if (cyclical.monthly) cyclicalDim += 2;
            if (cyclical.weekly) cyclicalDim += 2;
            if (cyclical.daily) cyclicalDim += 2;
            if (cyclicalDim > 0) {
                outputParts.push(`Cyclical: ${cyclicalDim}D`);
                totalDim += cyclicalDim;
            }
        }
        if (transforms.bucketize?.enabled) {
            const dim = transforms.bucketize.embedding_dim || 32;
            outputParts.push(`Bucket: ${dim}D`);
            totalDim += dim;
        }
    }

    const transformStr = outputParts.length > 0
        ? outputParts.join(' + ')
        : 'No transform selected';

    return {
        dataTypeLabel,
        transformStr,
        totalDim,
        hasTransforms: outputParts.length > 0
    };
}

function renderSampleTable() {
    const container = document.getElementById('sampleDataTable');
    const rows = configState.sampleRows || [];
    const columns = configState.columnOrder || [];

    if (rows.length === 0 || columns.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-sm p-4">No sample data available</p>';
        return;
    }

    // Get assignment status for each column (including primary IDs)
    const buyerCols = new Set(configState.buyerFeatures.map(f => f.column));
    const productCols = new Set(configState.productFeatures.map(f => f.column));

    // Add primary ID columns
    if (configState.customerIdFeature) {
        buyerCols.add(configState.customerIdFeature.column);
    }
    if (configState.productIdFeature) {
        productCols.add(configState.productIdFeature.column);
    }

    let html = `
        <div class="sample-table-wrapper">
            <table class="sample-table">
                <thead>
                    <tr>
                        ${columns.map(col => {
                            let headerClass = '';
                            const inBuyer = buyerCols.has(col);
                            const inProduct = productCols.has(col);

                            if (inBuyer && inProduct) {
                                headerClass = 'col-both';
                            } else if (inBuyer) {
                                headerClass = 'col-buyer';
                            } else if (inProduct) {
                                headerClass = 'col-product';
                            }

                            return `<th class="${headerClass}">${escapeHtml(col)}</th>`;
                        }).join('')}
                    </tr>
                </thead>
                <tbody>
                    ${rows.slice(0, 10).map(row => `
                        <tr>
                            ${columns.map(col => {
                                let cellClass = '';
                                const inBuyer = buyerCols.has(col);
                                const inProduct = productCols.has(col);

                                if (inBuyer && inProduct) {
                                    cellClass = 'col-both';
                                } else if (inBuyer) {
                                    cellClass = 'col-buyer';
                                } else if (inProduct) {
                                    cellClass = 'col-product';
                                }

                                const val = row[col];
                                const displayVal = val === null || val === undefined
                                    ? '<span class="null-value">NULL</span>'
                                    : escapeHtml(String(val));
                                return `<td class="${cellClass}">${displayVal}</td>`;
                            }).join('')}
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;

    container.innerHTML = html;
}

function renderAssignedFeatures(model) {
    const features = model === 'buyer' ? configState.buyerFeatures : configState.productFeatures;
    const crosses = model === 'buyer' ? configState.buyerCrosses : configState.productCrosses;
    const container = document.getElementById(`${model}ModelFeatures`);
    const crossContainer = document.getElementById(`${model}ModelCrosses`);
    const addCrossBtn = document.getElementById(`add${model.charAt(0).toUpperCase() + model.slice(1)}CrossBtn`);

    container.innerHTML = '';
    crossContainer.innerHTML = '';

    // Show/hide cross feature button based on whether there are features
    // (including primary ID feature)
    const hasPrimaryId = model === 'buyer' ? configState.customerIdFeature : configState.productIdFeature;
    const hasFeatures = features.length > 0 || hasPrimaryId;

    if (hasFeatures) {
        addCrossBtn.style.display = 'inline-flex';

        features.forEach((feature, idx) => {
            const el = createAssignedFeatureElement(feature, model, idx);
            container.appendChild(el);
        });
    } else {
        addCrossBtn.style.display = 'none';
    }

    crosses.forEach((cross, idx) => {
        const el = createCrossFeatureElement(cross, model, idx);
        crossContainer.appendChild(el);
    });
}

function createAssignedFeatureElement(feature, model, idx) {
    const div = document.createElement('div');

    // Get display info
    const displayInfo = getFeatureDisplayInfo(feature);
    const bqType = feature.bq_type || 'STRING';

    // Apply warning class to the outer div if no transforms selected
    div.className = displayInfo.hasTransforms ? 'assigned-feature' : 'assigned-feature feature-needs-config';

    div.innerHTML = `
        <div class="flex items-center justify-between">
            <div class="flex-1">
                <div class="font-medium text-sm">${escapeHtml(feature.column)}</div>
                <div class="text-xs ${displayInfo.hasTransforms ? 'text-gray-500' : 'text-amber-600'}">
                    ${bqType}  ${displayInfo.dataTypeLabel}  ${displayInfo.transformStr}
                </div>
            </div>
            <div class="flex flex-col gap-1 ml-2">
                <button type="button" class="feature-config-btn settings ${displayInfo.hasTransforms ? '' : 'needs-attention'}" onclick="openFeatureConfig('${model}', ${idx})" title="Configure transforms">
                    <i class="fas fa-cog"></i>
                </button>
                <button type="button" class="feature-config-btn remove" onclick="removeFeature('${model}', ${idx})" title="Remove">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
        </div>
    `;

    return div;
}

function getCrossFeatureNames(cross) {
    // Handle both old format (array of strings) and new format (array of objects)
    if (!cross.features || cross.features.length === 0) return [];
    if (typeof cross.features[0] === 'string') {
        return cross.features;
    }
    return cross.features.map(f => f.column);
}

function getCrossFeatureDetails(cross) {
    // Build detailed description including bucket info for numeric/temporal
    if (!cross.features || cross.features.length === 0) return '';
    if (typeof cross.features[0] === 'string') {
        return ''; // Old format, no bucket details
    }

    const details = cross.features
        .filter(f => f.crossing_buckets)
        .map(f => `${f.column}: ${f.crossing_buckets} buckets`);

    return details.length > 0 ? details.join(', ') : '';
}

function createCrossFeatureElement(cross, model, idx) {
    const div = document.createElement('div');
    div.className = 'cross-feature';

    const featureNames = getCrossFeatureNames(cross);
    const bucketDetails = getCrossFeatureDetails(cross);

    div.innerHTML = `
        <div class="flex items-center justify-between">
            <div>
                <div class="font-medium text-sm">${featureNames.join('  ')}</div>
                <div class="text-xs text-gray-500">
                    Hash: ${cross.hash_bucket_size.toLocaleString()}  ${cross.embedding_dim}D
                    ${bucketDetails ? `<br><span class="text-blue-600">${bucketDetails}</span>` : ''}
                </div>
            </div>
            <button type="button" class="feature-config-btn remove" onclick="removeCross('${model}', ${idx})">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;

    return div;
}

function getFeatureDimString(feature) {
    const parts = [];
    if (feature.type === 'string_embedding') {
        parts.push(`Embedding: ${feature.embedding_dim || 32}D`);
    } else if (feature.type === 'numeric') {
        const t = feature.transforms || {};
        if (t.normalize?.enabled) parts.push('Norm: 1D');
        if (t.bucketize?.enabled) parts.push(`Bucket: ${t.bucketize.embedding_dim || 32}D`);
    } else if (feature.type === 'timestamp') {
        const t = feature.transforms || {};
        if (t.normalize?.enabled) parts.push('Norm: 1D');
        const cyclical = t.cyclical || {};
        const cycles = ['yearly', 'annual', 'quarterly', 'monthly', 'weekly', 'daily'].filter(c => cyclical[c]).length;
        if (cycles > 0) parts.push(`Cyclical: ${cycles * 2}D`);
    }
    return parts.join(' + ') || 'Not configured';
}

// =============================================================================
// DRAG AND DROP
// =============================================================================

function dragStart(e, col) {
    e.target.classList.add('dragging');
    e.dataTransfer.setData('text/plain', JSON.stringify(col));
    e.dataTransfer.effectAllowed = 'move';
}

function dragEnd(e) {
    e.target.classList.remove('dragging');
}

function allowDrop(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
}

function dragEnter(e) {
    e.preventDefault();
    e.currentTarget.classList.add('drag-over');
}

function dragLeave(e) {
    e.currentTarget.classList.remove('drag-over');
}

function dropFeature(e, model) {
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');

    // Check if the model is unlocked (primary ID must be set first)
    const isUnlocked = model === 'buyer' ? configState.customerIdFeature : configState.productIdFeature;
    if (!isUnlocked) {
        return; // Can't drop if locked
    }

    const colData = JSON.parse(e.dataTransfer.getData('text/plain'));
    const feature = createDefaultFeature(colData);

    if (model === 'buyer') {
        configState.buyerFeatures.push(feature);
    } else {
        configState.productFeatures.push(feature);
    }

    renderStep2();
}

// =============================================================================
// PRIMARY ID DROP HANDLING
// =============================================================================

function dragEnterPrimaryId(e) {
    e.preventDefault();
    e.currentTarget.classList.add('drag-over');
}

function dragLeavePrimaryId(e) {
    e.currentTarget.classList.remove('drag-over');
}

function allowDropIfUnlocked(e, model) {
    const isUnlocked = model === 'buyer' ? configState.customerIdFeature : configState.productIdFeature;
    if (isUnlocked) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
    }
}

function dragEnterIfUnlocked(e, model) {
    const isUnlocked = model === 'buyer' ? configState.customerIdFeature : configState.productIdFeature;
    if (isUnlocked) {
        e.preventDefault();
        e.currentTarget.classList.add('drag-over');
    }
}

function dropPrimaryId(e, model) {
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');

    const colData = JSON.parse(e.dataTransfer.getData('text/plain'));

    // Create primary ID feature with forced text type and embedding transform
    const primaryIdFeature = {
        column: colData.name,
        bq_type: colData.bq_type || colData.type || 'STRING',
        data_type: 'text',  // Force to text regardless of original type
        is_primary_id: true,
        stats: colData.stats || {},
        transforms: {
            embedding: {
                enabled: true,
                embedding_dim: 32,  // Default 32D
                vocab_size: 100000
            }
        }
    };

    if (model === 'buyer') {
        configState.customerIdFeature = primaryIdFeature;
    } else {
        configState.productIdFeature = primaryIdFeature;
    }

    renderStep2();
}

function removePrimaryId(model) {
    if (model === 'buyer') {
        configState.customerIdFeature = null;
        // Also clear additional features since the model is now locked
        configState.buyerFeatures = [];
        configState.buyerCrosses = [];
    } else {
        configState.productIdFeature = null;
        // Also clear additional features since the model is now locked
        configState.productFeatures = [];
        configState.productCrosses = [];
    }
    renderStep2();
}

function openPrimaryIdConfig(model) {
    const feature = model === 'buyer' ? configState.customerIdFeature : configState.productIdFeature;
    if (!feature) return;

    editingFeature = {...feature, _model: model, _isPrimaryId: true};
    editingFeatureModel = model;

    const idLabel = model === 'buyer' ? 'Customer ID' : 'Product ID';
    document.getElementById('featureModalTitle').textContent = `Configure: ${idLabel}`;
    renderPrimaryIdConfigForm();
    document.getElementById('featureConfigModal').classList.remove('hidden');
}

function renderPrimaryIdConfigForm() {
    const body = document.getElementById('featureModalBody');
    const embedDim = editingFeature.transforms?.embedding?.embedding_dim || 32;
    const presetDims = [8, 16, 32, 64, 128, 256];
    const isCustom = !presetDims.includes(embedDim);

    body.innerHTML = `
        <div class="mb-4">
            <div class="text-sm text-gray-600 mb-2">
                <strong>Column:</strong> ${escapeHtml(editingFeature.column)}
            </div>
            <div class="text-sm text-gray-500">
                Original type: ${editingFeature.bq_type || 'STRING'}  <span class="text-blue-600 font-medium">Text (forced)</span>
            </div>
        </div>

        <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg mb-4">
            <div class="text-sm text-blue-800">
                <i class="fas fa-info-circle mr-2"></i>
                Primary ID columns use text embedding. Other transforms are not available.
            </div>
        </div>

        <div class="modal-form-group">
            <label class="modal-form-label">Embedding Dimension</label>
            <div class="flex gap-2 flex-wrap items-center justify-center">
                ${presetDims.map(dim => `
                    <button type="button"
                            class="primary-id-dim-btn px-3 py-2 rounded-lg border transition-all ${embedDim === dim && !isCustom
                                ? 'bg-blue-500 text-white border-blue-500'
                                : 'bg-white text-gray-700 border-gray-300 hover:border-blue-400'}"
                            onclick="selectPrimaryIdDim(${dim})">
                        ${dim}D
                    </button>
                `).join('')}
            </div>
            <div class="flex items-center gap-3 mt-3">
                <span class="text-sm text-gray-600">Custom:</span>
                <input type="number"
                       id="customEmbedDimInput"
                       class="form-input text-sm"
                       style="width: 100px;"
                       min="4"
                       max="1024"
                       step="1"
                       value="${isCustom ? embedDim : ''}"
                       placeholder="e.g. 512"
                       onchange="onCustomDimChange(this.value)"
                       oninput="onCustomDimInput(this.value)">
                <span class="text-xs text-gray-500">Range: 4 - 1024</span>
            </div>
            <p class="modal-form-hint mt-2">
                <i class="fas fa-lightbulb text-amber-500 mr-1"></i>
                Tip: Use larger dimensions (256-512) for millions of unique IDs, smaller (8-32) for few unique values
            </p>
        </div>

        <input type="hidden" id="primaryIdEmbedDim" value="${embedDim}">
    `;
}

function selectPrimaryIdDim(dim) {
    document.getElementById('primaryIdEmbedDim').value = dim;

    // Clear custom input when preset is selected
    const customInput = document.getElementById('customEmbedDimInput');
    if (customInput) {
        customInput.value = '';
    }

    // Update button styles
    const buttons = document.querySelectorAll('.primary-id-dim-btn');
    buttons.forEach(btn => {
        const btnDim = parseInt(btn.textContent);
        if (btnDim === dim) {
            btn.className = 'primary-id-dim-btn px-3 py-2 rounded-lg border transition-all bg-blue-500 text-white border-blue-500';
        } else {
            btn.className = 'primary-id-dim-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400';
        }
    });
}

function onCustomDimInput(value) {
    // Live update as user types - deselect preset buttons
    if (value) {
        const buttons = document.querySelectorAll('.primary-id-dim-btn');
        buttons.forEach(btn => {
            btn.className = 'primary-id-dim-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400';
        });
    }
}

function onCustomDimChange(value) {
    // Validate and set the custom dimension
    let dim = parseInt(value);
    if (isNaN(dim) || dim < 4) {
        dim = 4;
        document.getElementById('customEmbedDimInput').value = 4;
    } else if (dim > 1024) {
        dim = 1024;
        document.getElementById('customEmbedDimInput').value = 1024;
    }

    document.getElementById('primaryIdEmbedDim').value = dim;

    // Deselect all preset buttons
    const buttons = document.querySelectorAll('.primary-id-dim-btn');
    buttons.forEach(btn => {
        btn.className = 'primary-id-dim-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400';
    });
}

function applyPrimaryIdConfig() {
    const model = editingFeature._model;
    const newDim = parseInt(document.getElementById('primaryIdEmbedDim').value) || 32;

    if (model === 'buyer' && configState.customerIdFeature) {
        configState.customerIdFeature.transforms.embedding.embedding_dim = newDim;
    } else if (model === 'product' && configState.productIdFeature) {
        configState.productIdFeature.transforms.embedding.embedding_dim = newDim;
    }

    closeFeatureModal();
    renderStep2();
}

// =============================================================================
// TEXT EMBEDDING DIMENSION SELECTION (for context features)
// =============================================================================

function selectTextEmbedDim(dim) {
    document.getElementById('featureEmbedDim').value = dim;

    // Clear custom input when preset is selected
    const customInput = document.getElementById('customTextEmbedDimInput');
    if (customInput) {
        customInput.value = '';
    }

    // Update dimension label
    const dimLabel = document.getElementById('embeddingDimLabel');
    if (dimLabel) {
        dimLabel.textContent = `+${dim}D`;
    }

    // Update button styles
    const buttons = document.querySelectorAll('.text-embed-dim-btn');
    buttons.forEach(btn => {
        const btnDim = parseInt(btn.textContent);
        if (btnDim === dim) {
            btn.className = 'text-embed-dim-btn px-3 py-2 rounded-lg border transition-all bg-blue-500 text-white border-blue-500';
        } else {
            btn.className = 'text-embed-dim-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400';
        }
    });
}

function onCustomTextEmbedDimInput(value) {
    // Live update as user types - deselect preset buttons
    if (value) {
        const buttons = document.querySelectorAll('.text-embed-dim-btn');
        buttons.forEach(btn => {
            btn.className = 'text-embed-dim-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400';
        });
    }
}

function onCustomTextEmbedDimChange(value) {
    // Validate and set the custom dimension
    let dim = parseInt(value);
    if (isNaN(dim) || dim < 4) {
        dim = 4;
        document.getElementById('customTextEmbedDimInput').value = 4;
    } else if (dim > 1024) {
        dim = 1024;
        document.getElementById('customTextEmbedDimInput').value = 1024;
    }

    document.getElementById('featureEmbedDim').value = dim;

    // Update dimension label
    const dimLabel = document.getElementById('embeddingDimLabel');
    if (dimLabel) {
        dimLabel.textContent = `+${dim}D`;
    }

    // Deselect all preset buttons
    const buttons = document.querySelectorAll('.text-embed-dim-btn');
    buttons.forEach(btn => {
        btn.className = 'text-embed-dim-btn px-3 py-2 rounded-lg border transition-all bg-white text-gray-700 border-gray-300 hover:border-blue-400';
    });
}

function createDefaultFeature(col) {
    // Create feature with BQ type, but NO transforms applied
    // User must configure transforms via the settings modal
    const bqType = col.bq_type || col.type || 'STRING';
    const dataType = getDataTypeFromBqType(bqType);

    return {
        column: col.name,
        bq_type: bqType,
        data_type: dataType,  // Numeric, Text, or Temporal
        stats: col.stats || {},
        transforms: {}  // Empty - user must configure
    };
}

function detectCyclicalPeriod(col) {
    const colName = (col.name || '').toLowerCase();
    const min = col.stats?.min;
    const max = col.stats?.max;

    // Try to detect from column name
    if (colName.includes('hour')) return 24;
    if (colName.includes('day_of_week') || colName.includes('weekday')) return 7;
    if (colName.includes('month')) return 12;
    if (colName.includes('day_of_month') || colName.includes('day')) return 31;
    if (colName.includes('quarter')) return 4;

    // Try to detect from value range
    if (min !== undefined && max !== undefined) {
        if (min >= 0 && max <= 23) return 24;
        if (min >= 0 && max <= 6) return 7;
        if (min >= 1 && max <= 12) return 12;
        if (min >= 1 && max <= 31) return 31;
        if (min >= 1 && max <= 4) return 4;
    }

    return 12; // Default to monthly
}

function getRecommendedEmbedDim(cardinality) {
    if (cardinality < 50) return 8;
    if (cardinality < 500) return 16;
    if (cardinality < 5000) return 32;
    if (cardinality < 50000) return 64;
    if (cardinality < 500000) return 96;
    return 128;
}

function removeFeature(model, idx) {
    if (model === 'buyer') {
        configState.buyerFeatures.splice(idx, 1);
    } else {
        configState.productFeatures.splice(idx, 1);
    }
    renderStep2();
}

function removeCross(model, idx) {
    if (model === 'buyer') {
        configState.buyerCrosses.splice(idx, 1);
    } else {
        configState.productCrosses.splice(idx, 1);
    }
    renderStep2();
}

// =============================================================================
// TENSOR PREVIEW
// =============================================================================

function updateTensorPreview() {
    // Calculate buyer tensor dimensions
    const buyerBreakdown = [];
    let buyerTotal = 0;

    // Primary ID (Customer ID)
    if (configState.customerIdFeature) {
        const info = getFeatureDisplayInfo(configState.customerIdFeature);
        if (info.totalDim > 0) {
            buyerBreakdown.push({ name: configState.customerIdFeature.column, dim: info.totalDim });
            buyerTotal += info.totalDim;
        }
    }

    // Buyer context features
    configState.buyerFeatures.forEach(feature => {
        const info = getFeatureDisplayInfo(feature);
        if (info.totalDim > 0) {
            buyerBreakdown.push({ name: feature.column, dim: info.totalDim });
            buyerTotal += info.totalDim;
        }
    });

    // Buyer cross features
    configState.buyerCrosses.forEach(cross => {
        const dim = cross.embedding_dim || 16;
        const featureNames = getCrossFeatureNames(cross);
        const name = featureNames.join('  ');
        buyerBreakdown.push({ name: name, dim: dim, is_cross: true });
        buyerTotal += dim;
    });

    // Calculate product tensor dimensions
    const productBreakdown = [];
    let productTotal = 0;

    // Primary ID (Product ID)
    if (configState.productIdFeature) {
        const info = getFeatureDisplayInfo(configState.productIdFeature);
        if (info.totalDim > 0) {
            productBreakdown.push({ name: configState.productIdFeature.column, dim: info.totalDim });
            productTotal += info.totalDim;
        }
    }

    // Product context features
    configState.productFeatures.forEach(feature => {
        const info = getFeatureDisplayInfo(feature);
        if (info.totalDim > 0) {
            productBreakdown.push({ name: feature.column, dim: info.totalDim });
            productTotal += info.totalDim;
        }
    });

    // Product cross features
    configState.productCrosses.forEach(cross => {
        const dim = cross.embedding_dim || 16;
        const featureNames = getCrossFeatureNames(cross);
        const name = featureNames.join('  ');
        productBreakdown.push({ name: name, dim: dim, is_cross: true });
        productTotal += dim;
    });

    // Render both previews
    renderTensorPreview('buyer', buyerTotal, buyerBreakdown);
    renderTensorPreview('product', productTotal, productBreakdown);
}

function renderTensorPreview(model, total, breakdown) {
    document.getElementById(`${model}TensorTotal`).textContent = `${total}D`;

    const barContainer = document.getElementById(`${model}TensorBar`);
    const breakdownContainer = document.getElementById(`${model}TensorBreakdown`);

    barContainer.innerHTML = '';
    breakdownContainer.innerHTML = '';

    if (!breakdown || breakdown.length === 0) return;

    const colors = model === 'buyer'
        ? ['#3b82f6', '#60a5fa', '#93c5fd', '#bfdbfe', '#dbeafe']
        : ['#10b981', '#34d399', '#6ee7b7', '#a7f3d0', '#d1fae5'];

    breakdown.forEach((item, idx) => {
        const pct = (item.dim / total) * 100;
        const color = colors[idx % colors.length];

        const segment = document.createElement('div');
        segment.className = 'tensor-breakdown-segment';
        segment.style.width = `${pct}%`;
        segment.style.backgroundColor = color;
        segment.title = `${item.name}: ${item.dim}D`;
        if (pct > 10) {
            segment.textContent = item.dim;
        }
        barContainer.appendChild(segment);

        const tag = document.createElement('span');
        tag.className = 'tensor-breakdown-item';
        tag.textContent = `${item.name}: ${item.dim}D`;
        breakdownContainer.appendChild(tag);
    });
}

// =============================================================================
// FEATURE CONFIGURATION MODAL
// =============================================================================

function openFeatureConfig(model, idx) {
    editingFeatureModel = model;
    const features = model === 'buyer' ? configState.buyerFeatures : configState.productFeatures;
    editingFeature = {...features[idx], _idx: idx};

    document.getElementById('featureModalTitle').textContent = `Configure: ${editingFeature.column}`;
    renderFeatureConfigForm();
    document.getElementById('featureConfigModal').classList.remove('hidden');
}

function closeFeatureModal() {
    document.getElementById('featureConfigModal').classList.add('hidden');
    editingFeature = null;
    editingFeatureModel = null;
}

function renderFeatureConfigForm() {
    const body = document.getElementById('featureModalBody');
    const dataType = editingFeature.data_type || getDataTypeFromBqType(editingFeature.bq_type);
    const t = editingFeature.transforms || {};

    // Build data type selector
    const dataTypeOptions = ['numeric', 'text', 'temporal'].map(dt =>
        `<option value="${dt}" ${dataType === dt ? 'selected' : ''}>${getDataTypeLabel(dt)}</option>`
    ).join('');

    let transformsHtml = '';

    if (dataType === 'numeric') {
        transformsHtml = `
            <div class="transform-option">
                <input type="checkbox" id="featureNormalize" ${t.normalize?.enabled ? 'checked' : ''}>
                <div class="transform-option-content">
                    <div class="transform-option-title">Normalize</div>
                    <div class="transform-option-desc">Scale values to [-1, 1] range</div>
                </div>
                <span class="transform-option-dim">+1D</span>
            </div>
            <div class="transform-option">
                <input type="checkbox" id="featureBucketize" ${t.bucketize?.enabled ? 'checked' : ''}>
                <div class="transform-option-content">
                    <div class="transform-option-title">Bucketize + Embed</div>
                    <div class="transform-option-desc">Discretize into buckets with learned embedding</div>
                    <div class="mt-2">
                        <label class="text-xs text-gray-500">Buckets:</label>
                        <select id="featureBuckets" class="form-select form-select-sm ml-2" style="width: 80px;">
                            ${[10, 50, 100, 200].map(b =>
                                `<option value="${b}" ${(t.bucketize?.buckets || 100) == b ? 'selected' : ''}>${b}</option>`
                            ).join('')}
                        </select>
                        <label class="text-xs text-gray-500 ml-3">Dim:</label>
                        <select id="featureBucketDim" class="form-select form-select-sm ml-2" style="width: 80px;">
                            ${[8, 16, 32, 64].map(d =>
                                `<option value="${d}" ${(t.bucketize?.embedding_dim || 32) == d ? 'selected' : ''}>${d}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
                <span class="transform-option-dim" id="bucketizeDimLabel">+${t.bucketize?.embedding_dim || 32}D</span>
            </div>
        `;
    } else if (dataType === 'text') {
        const embedDim = t.embedding?.embedding_dim || 32;
        const presetDims = [8, 16, 32, 64, 128, 256];
        const isCustomDim = !presetDims.includes(embedDim);

        transformsHtml = `
            <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg">
                <div class="flex items-center justify-between mb-3">
                    <div>
                        <div class="font-medium text-gray-800">Embedding</div>
                        <div class="text-xs text-gray-500">Learn vector representation for categorical values</div>
                    </div>
                    <span class="text-blue-600 font-medium" id="embeddingDimLabel">+${embedDim}D</span>
                </div>

                <div class="mb-3">
                    <label class="text-xs text-gray-600 font-medium mb-2 block">Embedding Dimension</label>
                    <div class="flex gap-2 flex-wrap items-center justify-center">
                        ${presetDims.map(dim => `
                            <button type="button"
                                    class="text-embed-dim-btn px-3 py-2 rounded-lg border transition-all ${embedDim === dim && !isCustomDim
                                        ? 'bg-blue-500 text-white border-blue-500'
                                        : 'bg-white text-gray-700 border-gray-300 hover:border-blue-400'}"
                                    onclick="selectTextEmbedDim(${dim})">
                                ${dim}D
                            </button>
                        `).join('')}
                    </div>
                    <div class="flex items-center gap-3 mt-3 justify-center">
                        <span class="text-xs text-gray-600">Custom:</span>
                        <input type="number"
                               id="customTextEmbedDimInput"
                               class="form-input text-sm"
                               style="width: 80px;"
                               min="4"
                               max="1024"
                               step="1"
                               value="${isCustomDim ? embedDim : ''}"
                               placeholder="e.g. 512"
                               onchange="onCustomTextEmbedDimChange(this.value)"
                               oninput="onCustomTextEmbedDimInput(this.value)">
                        <span class="text-xs text-gray-400">4 - 1024</span>
                    </div>
                </div>

                <div class="border-t border-gray-200 pt-3 mt-3 space-y-2">
                    <div class="flex items-start gap-2 text-xs text-gray-600">
                        <i class="fas fa-database text-blue-500 mt-0.5"></i>
                        <span><strong>Vocabulary:</strong> Auto-detected from training data (no manual limit needed)</span>
                    </div>
                    <div class="flex items-start gap-2 text-xs text-gray-600">
                        <i class="fas fa-plus-circle text-green-500 mt-0.5"></i>
                        <span><strong>+1 OOV:</strong> One extra dimension is automatically reserved for new/unknown values</span>
                    </div>
                </div>
            </div>
            <input type="hidden" id="featureEmbedDim" value="${embedDim}">
        `;
    } else if (dataType === 'temporal') {
        const c = t.cyclical || {};
        transformsHtml = `
            <div class="transform-option">
                <input type="checkbox" id="featureNormalize" ${t.normalize?.enabled ? 'checked' : ''}>
                <div class="transform-option-content">
                    <div class="transform-option-title">Normalize</div>
                    <div class="transform-option-desc">Scale timestamp to [-1, 1] range</div>
                </div>
                <span class="transform-option-dim">+1D</span>
            </div>
            <div class="transform-option" style="flex-direction: column; align-items: stretch;">
                <div class="flex items-start gap-2 w-full">
                    <div class="transform-option-content flex-1">
                        <div class="transform-option-title">Cyclical Features</div>
                        <div class="transform-option-desc">Extract periodic patterns using sin/cos encoding</div>
                    </div>
                    <span class="transform-option-dim">varies</span>
                </div>
                <div class="space-y-1 mt-3">
                    <label class="flex items-center gap-2 text-xs">
                        <input type="checkbox" id="cyclicalYearly" ${c.yearly ? 'checked' : ''}>
                        <span>Yearly (month of year)</span>
                        <span class="text-blue-600 ml-auto">+2D</span>
                    </label>
                    <label class="flex items-center gap-2 text-xs">
                        <input type="checkbox" id="cyclicalQuarterly" ${c.quarterly ? 'checked' : ''}>
                        <span>Quarterly (month of quarter)</span>
                        <span class="text-blue-600 ml-auto">+2D</span>
                    </label>
                    <label class="flex items-center gap-2 text-xs">
                        <input type="checkbox" id="cyclicalMonthly" ${c.monthly ? 'checked' : ''}>
                        <span>Monthly (day of month)</span>
                        <span class="text-blue-600 ml-auto">+2D</span>
                    </label>
                    <label class="flex items-center gap-2 text-xs">
                        <input type="checkbox" id="cyclicalWeekly" ${c.weekly ? 'checked' : ''}>
                        <span>Weekly (day of week)</span>
                        <span class="text-blue-600 ml-auto">+2D</span>
                    </label>
                    <label class="flex items-center gap-2 text-xs">
                        <input type="checkbox" id="cyclicalDaily" ${c.daily ? 'checked' : ''}>
                        <span>Daily (hour of day)</span>
                        <span class="text-blue-600 ml-auto">+2D</span>
                    </label>
                </div>
            </div>
            <div class="transform-option">
                <input type="checkbox" id="featureBucketize" ${t.bucketize?.enabled ? 'checked' : ''}>
                <div class="transform-option-content">
                    <div class="transform-option-title">Bucketize + Embed</div>
                    <div class="transform-option-desc">Discretize into time buckets with learned embedding</div>
                    <div class="mt-2">
                        <label class="text-xs text-gray-500">Buckets:</label>
                        <select id="featureBuckets" class="form-select form-select-sm ml-2" style="width: 80px;">
                            ${[10, 50, 100, 200].map(b =>
                                `<option value="${b}" ${(t.bucketize?.buckets || 100) == b ? 'selected' : ''}>${b}</option>`
                            ).join('')}
                        </select>
                        <label class="text-xs text-gray-500 ml-3">Dim:</label>
                        <select id="featureBucketDim" class="form-select form-select-sm ml-2" style="width: 80px;">
                            ${[8, 16, 32, 64].map(d =>
                                `<option value="${d}" ${(t.bucketize?.embedding_dim || 32) == d ? 'selected' : ''}>${d}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
                <span class="transform-option-dim">+${t.bucketize?.embedding_dim || 32}D</span>
            </div>
        `;
    }

    body.innerHTML = `
        <div class="modal-form-group">
            <label class="modal-form-label">Data Type</label>
            <select id="modalDataType" class="form-select w-full" onchange="onModalDataTypeChange(this.value)">
                ${dataTypeOptions}
            </select>
            <p class="modal-form-hint">Original BQ type: ${editingFeature.bq_type || 'STRING'}</p>
        </div>
        <div class="modal-form-group">
            <label class="modal-form-label">Transformations</label>
            <p class="text-xs text-gray-500 mb-2">Select at least one transformation to include this feature in the model</p>
            <div id="transformOptions">
                ${transformsHtml}
            </div>
        </div>
    `;
}

function onModalDataTypeChange(newDataType) {
    // Update the editing feature's data type and re-render the form
    editingFeature.data_type = newDataType;
    editingFeature.transforms = {};  // Clear transforms when type changes
    renderFeatureConfigForm();
}

function applyFeatureConfig() {
    // Check if we're editing a primary ID feature
    if (editingFeature._isPrimaryId) {
        applyPrimaryIdConfig();
        return;
    }

    const features = editingFeatureModel === 'buyer' ? configState.buyerFeatures : configState.productFeatures;
    const idx = editingFeature._idx;
    const dataType = editingFeature.data_type || getDataTypeFromBqType(editingFeature.bq_type);

    // Update the data type
    features[idx].data_type = dataType;

    // Build transforms based on data type
    const transforms = {};

    if (dataType === 'numeric') {
        const normalizeEl = document.getElementById('featureNormalize');
        const bucketizeEl = document.getElementById('featureBucketize');

        if (normalizeEl?.checked) {
            transforms.normalize = { enabled: true, range: [-1, 1] };
        }
        if (bucketizeEl?.checked) {
            transforms.bucketize = {
                enabled: true,
                buckets: parseInt(document.getElementById('featureBuckets').value) || 100,
                embedding_dim: parseInt(document.getElementById('featureBucketDim').value) || 32
            };
        }
    } else if (dataType === 'text') {
        // Text features always use embedding (no checkbox needed)
        // Vocab size is auto-detected from training data, so we don't store it
        transforms.embedding = {
            enabled: true,
            embedding_dim: parseInt(document.getElementById('featureEmbedDim').value) || 32
        };
    } else if (dataType === 'temporal') {
        const normalizeEl = document.getElementById('featureNormalize');
        const bucketizeEl = document.getElementById('featureBucketize');

        if (normalizeEl?.checked) {
            transforms.normalize = { enabled: true, range: [-1, 1] };
        }

        // Check if any cyclical option is selected
        const yearly = document.getElementById('cyclicalYearly')?.checked || false;
        const quarterly = document.getElementById('cyclicalQuarterly')?.checked || false;
        const monthly = document.getElementById('cyclicalMonthly')?.checked || false;
        const weekly = document.getElementById('cyclicalWeekly')?.checked || false;
        const daily = document.getElementById('cyclicalDaily')?.checked || false;

        if (yearly || quarterly || monthly || weekly || daily) {
            transforms.cyclical = {
                enabled: true,
                yearly: yearly,
                quarterly: quarterly,
                monthly: monthly,
                weekly: weekly,
                daily: daily
            };
        }

        if (bucketizeEl?.checked) {
            transforms.bucketize = {
                enabled: true,
                buckets: parseInt(document.getElementById('featureBuckets').value) || 100,
                embedding_dim: parseInt(document.getElementById('featureBucketDim').value) || 32
            };
        }
    }

    features[idx].transforms = transforms;

    closeFeatureModal();
    renderStep2();
}

// =============================================================================
// CROSS FEATURE MODAL
// =============================================================================

function openCrossModal(model) {
    crossFeatureModel = model;

    // Get all features for this model, including the primary ID
    const primaryId = model === 'buyer' ? configState.customerIdFeature : configState.productIdFeature;
    const additionalFeatures = model === 'buyer' ? configState.buyerFeatures : configState.productFeatures;

    // Combine: primary ID first, then additional features
    const allFeatures = primaryId ? [primaryId, ...additionalFeatures] : additionalFeatures;

    const container = document.getElementById('crossFeatureOptions');
    container.innerHTML = '';

    allFeatures.forEach(f => {
        const label = document.createElement('label');
        const isPrimaryId = f.is_primary_id;
        const dataType = f.data_type || getDataTypeFromBqType(f.bq_type);
        const dataTypeLabel = getDataTypeLabel(dataType);

        // Determine badge color based on data type
        let typeBadge = '';
        if (isPrimaryId) {
            typeBadge = '<span class="text-xs bg-amber-100 text-amber-700 px-1 rounded">ID</span>';
        } else if (dataType === 'numeric') {
            typeBadge = '<span class="text-xs bg-blue-100 text-blue-700 px-1 rounded">Numeric</span>';
        } else if (dataType === 'temporal') {
            typeBadge = '<span class="text-xs bg-purple-100 text-purple-700 px-1 rounded">Temporal</span>';
        } else {
            typeBadge = '<span class="text-xs bg-gray-100 text-gray-600 px-1 rounded">Text</span>';
        }

        label.className = 'flex items-center gap-2 p-2 border rounded cursor-pointer hover:bg-gray-50';
        label.innerHTML = `
            <input type="checkbox" class="cross-feature-checkbox" value="${f.column}"
                   data-type="${dataType}" onchange="updateCrossPreview()">
            <span class="text-sm flex-1">${f.column}</span>
            ${typeBadge}
        `;
        container.appendChild(label);
    });

    // Reset bucket options
    document.getElementById('crossBucketOptions').classList.add('hidden');
    document.getElementById('crossBucketInputs').innerHTML = '';
    document.getElementById('crossPreview').classList.add('hidden');
    document.getElementById('crossFeatureModal').classList.remove('hidden');
}

function closeCrossModal() {
    document.getElementById('crossFeatureModal').classList.add('hidden');
    crossFeatureModel = null;
}

function updateCrossPreview() {
    const checkedInputs = Array.from(document.querySelectorAll('.cross-feature-checkbox:checked'));
    const checked = checkedInputs.map(cb => cb.value);

    if (checked.length >= 2) {
        document.getElementById('crossPreviewText').textContent = checked.join('  ');
        document.getElementById('crossPreview').classList.remove('hidden');
    } else {
        document.getElementById('crossPreview').classList.add('hidden');
    }

    // Check for numeric/temporal features that need bucketization
    const numericTemporalFeatures = checkedInputs.filter(cb => {
        const dataType = cb.dataset.type;
        return dataType === 'numeric' || dataType === 'temporal';
    });

    const bucketOptionsContainer = document.getElementById('crossBucketOptions');
    const bucketInputsContainer = document.getElementById('crossBucketInputs');

    if (numericTemporalFeatures.length > 0) {
        bucketInputsContainer.innerHTML = '';

        numericTemporalFeatures.forEach(cb => {
            const column = cb.value;
            const dataType = cb.dataset.type;
            const typeLabel = dataType === 'numeric' ? 'Numeric' : 'Temporal';
            const typeColor = dataType === 'numeric' ? 'blue' : 'purple';

            const div = document.createElement('div');
            div.className = 'flex items-center gap-3 p-3 bg-gray-50 rounded-lg border';
            div.innerHTML = `
                <div class="flex-1">
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-medium">${column}</span>
                        <span class="text-xs bg-${typeColor}-100 text-${typeColor}-700 px-1 rounded">${typeLabel}</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">Buckets for crossing (coarse granularity recommended)</div>
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-xs text-gray-600">Buckets:</label>
                    <select class="cross-bucket-select form-select text-sm" data-column="${column}" style="width: 80px;">
                        <option value="5">5</option>
                        <option value="10" selected>10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
            `;
            bucketInputsContainer.appendChild(div);
        });

        bucketOptionsContainer.classList.remove('hidden');
    } else {
        bucketOptionsContainer.classList.add('hidden');
        bucketInputsContainer.innerHTML = '';
    }
}

function addCrossFeature() {
    const checkedInputs = Array.from(document.querySelectorAll('.cross-feature-checkbox:checked'));

    if (checkedInputs.length < 2) {
        showError('Please select at least 2 features');
        return;
    }
    if (checkedInputs.length > 3) {
        showError('Please select at most 3 features');
        return;
    }

    // Build features array with type and bucket info
    const features = checkedInputs.map(cb => {
        const column = cb.value;
        const dataType = cb.dataset.type;

        const featureConfig = {
            column: column,
            type: dataType
        };

        // Add crossing_buckets for numeric/temporal features
        if (dataType === 'numeric' || dataType === 'temporal') {
            const bucketSelect = document.querySelector(`.cross-bucket-select[data-column="${column}"]`);
            if (bucketSelect) {
                featureConfig.crossing_buckets = parseInt(bucketSelect.value);
            }
        }

        return featureConfig;
    });

    const cross = {
        features: features,
        hash_bucket_size: parseInt(document.getElementById('crossHashBuckets').value),
        embedding_dim: parseInt(document.getElementById('crossEmbedDim').value)
    };

    if (crossFeatureModel === 'buyer') {
        configState.buyerCrosses.push(cross);
    } else {
        configState.productCrosses.push(cross);
    }

    closeCrossModal();
    renderStep2();
}

// =============================================================================
// SAVE CONFIG
// =============================================================================

function saveConfig() {
    // Validate: require primary ID features
    if (!configState.customerIdFeature) {
        showError('Customer ID is required. Please drag a column to the Customer ID zone.');
        return;
    }
    if (!configState.productIdFeature) {
        showError('Product ID is required. Please drag a column to the Product ID zone.');
        return;
    }

    // Build feature arrays with primary IDs at the front
    const buyerFeatures = [configState.customerIdFeature, ...configState.buyerFeatures];
    const productFeatures = [configState.productIdFeature, ...configState.productFeatures];

    const payload = {
        name: configState.name,
        description: configState.description,
        dataset_id: configState.datasetId,
        buyer_model_features: buyerFeatures,
        product_model_features: productFeatures,
        buyer_model_crosses: configState.buyerCrosses,
        product_model_crosses: configState.productCrosses
    };

    const url = editingConfigId
        ? `/api/feature-configs/${editingConfigId}/update/`
        : `/api/models/${modelId}/feature-configs/create/`;
    const method = editingConfigId ? 'PUT' : 'POST';

    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            closeWizard();
            loadConfigs();
            showSuccess(editingConfigId ? 'Feature config updated' : 'Feature config created');
        } else {
            showError(data.error || data.errors?.name || 'Failed to save');
        }
    })
    .catch(err => {
        console.error('Error saving:', err);
        showError('Failed to save feature config');
    });
}

// =============================================================================
// CONFIG ACTIONS
// =============================================================================

function viewConfig(configId) {
    fetch(`/api/feature-configs/${configId}/`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                renderViewModal(data.data);
                document.getElementById('viewConfigModal').classList.remove('hidden');
            }
        });
}

function renderViewModal(config) {
    document.getElementById('viewConfigTitle').textContent = config.name;

    const body = document.getElementById('viewConfigBody');
    body.innerHTML = `
        <div class="mb-4">
            <div class="flex items-center gap-2 mb-2">
                <span class="status-badge ${config.status}">${config.status}</span>
                <span class="text-sm text-gray-500">v${config.version}</span>
            </div>
            <p class="text-sm text-gray-600">${config.description || 'No description'}</p>
            <p class="text-xs text-gray-400 mt-2">Dataset: ${config.dataset_name}</p>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-4">
            <div class="p-4 bg-blue-50 rounded-lg">
                <h4 class="font-semibold text-blue-800 mb-2">BuyerModel: ${config.buyer_tensor_dim || 0}D</h4>
                <div class="space-y-1">
                    ${(config.buyer_model_features || []).map(f => `
                        <div class="text-sm text-blue-700">${f.column} (${f.type})</div>
                    `).join('')}
                    ${(config.buyer_model_crosses || []).map(c => `
                        <div class="text-sm text-blue-600 italic">${c.features.join('  ')}</div>
                    `).join('')}
                </div>
            </div>
            <div class="p-4 bg-green-50 rounded-lg">
                <h4 class="font-semibold text-green-800 mb-2">ProductModel: ${config.product_tensor_dim || 0}D</h4>
                <div class="space-y-1">
                    ${(config.product_model_features || []).map(f => `
                        <div class="text-sm text-green-700">${f.column} (${f.type})</div>
                    `).join('')}
                    ${(config.product_model_crosses || []).map(c => `
                        <div class="text-sm text-green-600 italic">${c.features.join('  ')}</div>
                    `).join('')}
                </div>
            </div>
        </div>

        <div class="text-xs text-gray-400">
            Created ${formatTimeAgo(config.created_at)} by ${config.created_by || 'Unknown'}
        </div>
    `;
}

function closeViewModal() {
    document.getElementById('viewConfigModal').classList.add('hidden');
}

function editConfig(configId) {
    openWizard(configId);
}

function cloneConfig(configId) {
    const config = allConfigs.find(c => c.id === configId);
    const newName = prompt('Enter name for cloned config:', `${config.name} (Copy)`);

    if (newName) {
        fetch(`/api/feature-configs/${configId}/clone/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({name: newName})
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                loadConfigs();
                showSuccess('Config cloned successfully');
            } else {
                showError(data.error || 'Failed to clone');
            }
        });
    }
}

function deleteConfig(configId, configName) {
    if (confirm(`Are you sure you want to delete "${configName}"?`)) {
        fetch(`/api/feature-configs/${configId}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrftoken
            }
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                loadConfigs();
                showSuccess('Config deleted');
            } else {
                showError(data.error || 'Failed to delete');
            }
        });
    }
}

// =============================================================================
// UTILITIES
// =============================================================================

function filterConfigs() {
    loadConfigs();
}

function debounceSearch() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        renderConfigs();
    }, 300);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatTimeAgo(isoString) {
    if (!isoString) return 'Unknown';
    const date = new Date(isoString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'just now';
    if (diffMins < 60) return `${diffMins} min ago`;
    if (diffHours < 24) return `${diffHours} hours ago`;
    if (diffDays < 7) return `${diffDays} days ago`;
    return date.toLocaleDateString();
}

function showError(message) {
    alert('Error: ' + message);
}

function showSuccess(message) {
    // Could use a toast notification here
    console.log('Success:', message);
}
</script>
{% endblock %}
