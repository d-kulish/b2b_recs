{% extends 'base_model.html' %}
{% load humanize %}
{% load static %}

{% block title %}{{ model.name }} - Training{% endblock %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/modals.css' %}?v=4">
<link rel="stylesheet" href="{% static 'css/pipeline_dag.css' %}?v=1">
<link rel="stylesheet" href="{% static 'css/exp_view_modal.css' %}?v=12">
<link rel="stylesheet" href="{% static 'css/training_wizard.css' %}?v=2">
<link rel="stylesheet" href="{% static 'css/cards.css' %}?v=6">
<link rel="stylesheet" href="{% static 'css/training_cards.css' %}?v=3">
<link rel="stylesheet" href="{% static 'css/model_dashboard.css' %}?v=17">
<link rel="stylesheet" href="{% static 'css/models_registry.css' %}?v=3">
<link rel="stylesheet" href="{% static 'css/schedule_calendar.css' %}?v=1">
<link rel="stylesheet" href="{% static 'css/schedule_modal.css' %}?v=1">
<link rel="stylesheet" href="{% static 'css/deploy_wizard.css' %}?v=1">
<!-- Flatpickr for datetime pickers -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
    /* =========================================================================
       Best Experiments Container Styles
       ========================================================================= */

    /* KPI Rows Container - 3 rows stacked vertically */
    .best-exp-kpi-rows {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 18px;
    }

    /* Each Model Type Row - Full width, single horizontal line */
    .best-exp-model-row {
        width: 100%;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 10px 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 10px;
    }

    .best-exp-model-row:hover:not(.selected) {
        border-color: #d1d5db;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    /* Row Header - Icon + Title (fixed width) */
    .best-exp-row-header {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-shrink: 0;
        min-width: 120px;
    }

    .best-exp-model-icon {
        width: 22px;
        height: 22px;
        border-radius: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        color: white;
        flex-shrink: 0;
    }

    .best-exp-model-icon.retrieval {
        background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
    }

    .best-exp-model-icon.ranking {
        background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
    }

    .best-exp-model-icon.hybrid {
        background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
    }

    .best-exp-model-title {
        font-size: 12px;
        font-weight: 700;
        color: #111827;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    /* KPI Boxes Container - Fills remaining space */
    .best-exp-kpi-boxes {
        display: flex;
        flex-direction: row;
        gap: 8px;
        flex: 1;
    }

    /* Individual KPI Box - Equal width, fills row */
    .best-exp-kpi-box {
        flex: 1;
        text-align: center;
        padding: 6px 5px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        min-width: 0;
    }

    .best-exp-kpi-box .best-exp-kpi-label {
        font-size: 8px;
        margin-bottom: 1px;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .best-exp-kpi-box .best-exp-kpi-value {
        font-size: 13px;
        font-weight: 700;
        color: #374151;
    }

    /* Model type color themes for metric values */
    .best-exp-model-row.retrieval .best-exp-kpi-value.highlight {
        color: #8b5cf6;
    }

    .best-exp-model-row.ranking .best-exp-kpi-value.highlight {
        color: #f59e0b;
    }

    .best-exp-model-row.hybrid .best-exp-kpi-value.highlight {
        color: #ec4899;
    }

    /* Row selection states */
    .best-exp-model-row.retrieval.selected {
        border-color: #8b5cf6;
        border-width: 2px;
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.15), 0 4px 12px rgba(139, 92, 246, 0.1);
    }

    .best-exp-model-row.ranking.selected {
        border-color: #f59e0b;
        border-width: 2px;
        box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.15), 0 4px 12px rgba(245, 158, 11, 0.1);
    }

    .best-exp-model-row.hybrid.selected {
        border-color: #ec4899;
        border-width: 2px;
        box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.15), 0 4px 12px rgba(236, 72, 153, 0.1);
    }

    /* Best Experiments Section */
    .best-exp-section {
        margin-bottom: 0;
    }

    .best-exp-section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 1px solid #e5e7eb;
    }

    .best-exp-section-title {
        font-size: 14px;
        font-weight: 600;
        color: #374151;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Best Experiments Table Container - Scrollable */
    .best-exp-table-container {
        max-height: 220px;
        overflow-y: auto;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
    }

    /* Best Experiments Table Styles */
    .best-exp-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
    }

    .best-exp-table th {
        text-align: left;
        padding: 10px 12px;
        font-weight: 600;
        color: #374151;
        background: #f9fafb;
        border-bottom: 2px solid #e5e7eb;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        position: sticky;
        top: 0;
        z-index: 1;
    }

    .best-exp-table td {
        padding: 10px 12px;
        border-bottom: 1px solid #f3f4f6;
        color: #4b5563;
    }

    .best-exp-table tr:hover {
        background: #f9fafb;
    }

    .best-exp-table tr:last-child td {
        border-bottom: none;
    }

    .best-exp-table .rank-cell {
        font-weight: 700;
        color: #6b7280;
    }

    .best-exp-table .rank-1 {
        color: #f59e0b;
    }

    .best-exp-table .rank-2 {
        color: #9ca3af;
    }

    .best-exp-table .rank-3 {
        color: #b45309;
    }

    .best-exp-table .metric-best {
        color: #10b981;
        font-weight: 600;
    }

    /* Empty Section */
    .best-exp-empty-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 32px;
        color: #9ca3af;
        text-align: center;
    }

    .best-exp-empty-section i {
        font-size: 32px;
        margin-bottom: 12px;
        opacity: 0.5;
    }

    .best-exp-empty-section p {
        font-size: 13px;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .best-exp-kpi-boxes {
            flex-wrap: wrap;
        }
        .best-exp-kpi-box {
            flex: 1 1 calc(50% - 4px);
            min-width: calc(50% - 4px);
        }
    }

    /* =========================================================================
       Chapter Section Styles
       ========================================================================= */
    .chapter-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
    }

    .chapter-icon.training {
        background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
    }

    /* Chapter Subtitle */
    .chapter-subtitle {
        font-size: 13px;
        color: #6b7280;
        margin-top: 2px;
    }

    /* Training Empty State */
    .training-empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 60px 40px;
        text-align: center;
        background: white;
        border: 2px dashed #e5e7eb;
        border-radius: 12px;
    }

    .training-empty-state .empty-icon {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 20px;
    }

    .training-empty-state .empty-icon i {
        font-size: 32px;
        color: #9ca3af;
    }

    .training-empty-state h3 {
        font-size: 18px;
        font-weight: 600;
        color: #374151;
        margin: 0 0 8px;
    }

    .training-empty-state p {
        font-size: 14px;
        color: #9ca3af;
        margin: 0 0 24px;
        max-width: 300px;
    }

    .training-empty-state .btn-primary {
        padding: 10px 20px;
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s ease;
    }

    .training-empty-state .btn-primary:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .training-empty-state .btn-primary:disabled {
        background: #d1d5db;
        cursor: not-allowed;
    }

    /* Coming Soon Placeholder */
    .coming-soon {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 80px 40px;
        text-align: center;
        background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
        border: 2px dashed #e5e7eb;
        border-radius: 12px;
        font-size: 18px;
        font-weight: 500;
        color: #9ca3af;
    }

    .coming-soon i {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
    }
</style>
{% endblock %}

{% block model_content %}
<!-- CHAPTER 1: MODELS REGISTRY -->
<div id="modelsRegistryChapter" class="chapter-container" data-chapter="models-registry">
    <div class="chapter-header" onclick="toggleChapter(this)">
        <div class="chapter-header-top">
            <div class="chapter-title-wrapper">
                <div class="chapter-icon models">
                    <i class="fas fa-cube"></i>
                </div>
                <div class="chapter-title-text">
                    <span class="chapter-title">Models Registry</span>
                    <span class="chapter-subtitle">View and deploy registered models</span>
                </div>
            </div>
            <div class="chapter-toggle">
                <i class="fas fa-chevron-right"></i>
            </div>
        </div>
        <div class="chapter-divider"></div>
        <!-- KPI Summary Row — always visible -->
        <div id="modelsKpiSummary" class="models-kpi-row">
            <!-- Populated by JavaScript -->
            <div class="models-loading">
                <i class="fas fa-spinner fa-spin"></i>
                <span class="models-loading-text">Loading...</span>
            </div>
        </div>
    </div>
    <div class="chapter-content">
        <div class="chapter-content-inner">
            <div class="chapter-divider" style="margin-top: 0;"></div>
            <!-- Training Activity Calendar -->
            <div class="models-calendar-wrapper">
                <h4 class="models-calendar-title">
                    <i class="fas fa-calendar-alt"></i>
                    Training Activity
                </h4>
                <div id="modelsScheduleGrid">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
            <!-- Filter Bar -->
            <div id="modelsFilterBar" class="models-filter-bar">
                <!-- Populated by JavaScript -->
            </div>
            <!-- Models Table -->
            <div id="modelsTable">
                <!-- Populated by JavaScript -->
            </div>
            <!-- Empty State (hidden by default) -->
            <div id="modelsEmptyState" class="models-empty-state" style="display: none;">
                <div class="empty-icon"><i class="fas fa-cube"></i></div>
                <h3>No Registered Models</h3>
                <p>Complete training runs with the Pusher component to register models in Vertex AI Model Registry.</p>
            </div>
            <!-- Schedules Section -->
            <div id="trainingSchedulesSection" class="training-schedules-section hidden">
                <div class="schedules-section-header">
                    <h3 class="schedules-section-title">
                        <i class="fas fa-clock"></i> Schedules
                    </h3>
                </div>
                <div id="schedulesList" class="schedules-list">
                    <!-- Schedule cards will be populated here by TrainingSchedules -->
                </div>
            </div>
        </div>
    </div>
</div>
<!-- End Chapter 1: Models Registry -->

<!-- CHAPTER 2: BEST EXPERIMENTS -->
<div class="chapter-container" data-chapter="best-experiments">
    <div class="chapter-header" onclick="toggleChapter(this)">
        <div class="chapter-header-top">
            <div class="chapter-title-wrapper">
                <div class="chapter-icon experiments">
                    <i class="fas fa-trophy"></i>
                </div>
                <div class="chapter-title-text">
                    <span class="chapter-title">Best Experiments</span>
                    <span class="chapter-subtitle">Top performing experiment configurations</span>
                </div>
            </div>
            <div class="chapter-toggle">
                <i class="fas fa-chevron-right"></i>
            </div>
        </div>
    </div>
    <div class="chapter-content">
        <div class="chapter-content-inner">
            <div class="chapter-divider" style="margin-top: 0;"></div>
            <!-- Loading State -->
            <div id="bestExpLoading" class="flex items-center justify-center py-12">
                <i class="fas fa-spinner fa-spin text-2xl text-gray-400 mr-3"></i>
                <span class="text-gray-500">Loading experiments...</span>
            </div>
            <!-- Empty State -->
            <div id="bestExpEmpty" class="hidden">
                <div class="best-exp-empty-section">
                    <i class="fas fa-flask"></i>
                    <p>No completed experiments yet.<br>Run some experiments to see results here.</p>
                </div>
            </div>
            <!-- Content -->
            <div id="bestExpContent" class="hidden">
                <!-- KPI Rows: 3 Full-Width Rows Stacked Vertically -->
                <div class="best-exp-kpi-rows">
                    <!-- Row 1: Retrieval -->
                    <div id="bestExpRetrievalRow" class="best-exp-model-row retrieval selected" onclick="selectBestExpModelType('retrieval')">
                        <div class="best-exp-row-header">
                            <div class="best-exp-model-icon retrieval">
                                <i class="fas fa-search"></i>
                            </div>
                            <span class="best-exp-model-title">Retrieval</span>
                        </div>
                        <div class="best-exp-kpi-boxes">
                            <div class="best-exp-kpi-box">
                                <div class="best-exp-kpi-label">Experiments</div>
                                <div class="best-exp-kpi-value" id="bestExpRetrievalCount">0</div>
                            </div>
                            <div class="best-exp-kpi-box">
                                <div class="best-exp-kpi-label">R@5</div>
                                <div class="best-exp-kpi-value highlight" id="bestExpRetrievalR5">-</div>
                            </div>
                            <div class="best-exp-kpi-box">
                                <div class="best-exp-kpi-label">R@10</div>
                                <div class="best-exp-kpi-value highlight" id="bestExpRetrievalR10">-</div>
                            </div>
                            <div class="best-exp-kpi-box">
                                <div class="best-exp-kpi-label">R@50</div>
                                <div class="best-exp-kpi-value highlight" id="bestExpRetrievalR50">-</div>
                            </div>
                            <div class="best-exp-kpi-box">
                                <div class="best-exp-kpi-label">R@100</div>
                                <div class="best-exp-kpi-value highlight" id="bestExpRetrievalR100">-</div>
                            </div>
                        </div>
                    </div>

                    <!-- Row 2: Ranking -->
                    <div id="bestExpRankingRow" class="best-exp-model-row ranking" onclick="selectBestExpModelType('ranking')">
                        <div class="best-exp-row-header">
                            <div class="best-exp-model-icon ranking">
                                <i class="fas fa-sort-amount-down"></i>
                            </div>
                            <span class="best-exp-model-title">Ranking</span>
                        </div>
                        <div class="best-exp-kpi-boxes">
                            <div class="best-exp-kpi-box">
                                <div class="best-exp-kpi-label">Experiments</div>
                                <div class="best-exp-kpi-value" id="bestExpRankingCount">0</div>
                            </div>
                            <div class="best-exp-kpi-box">
                                <div class="best-exp-kpi-label">RMSE</div>
                                <div class="best-exp-kpi-value highlight" id="bestExpRankingRMSE">-</div>
                            </div>
                            <div class="best-exp-kpi-box">
                                <div class="best-exp-kpi-label">Test RMSE</div>
                                <div class="best-exp-kpi-value highlight" id="bestExpRankingTestRMSE">-</div>
                            </div>
                            <div class="best-exp-kpi-box">
                                <div class="best-exp-kpi-label">MAE</div>
                                <div class="best-exp-kpi-value highlight" id="bestExpRankingMAE">-</div>
                            </div>
                            <div class="best-exp-kpi-box">
                                <div class="best-exp-kpi-label">Test MAE</div>
                                <div class="best-exp-kpi-value highlight" id="bestExpRankingTestMAE">-</div>
                            </div>
                        </div>
                    </div>

                    <!-- Row 3: Hybrid -->
                    <div id="bestExpHybridRow" class="best-exp-model-row hybrid" onclick="selectBestExpModelType('hybrid')">
                        <div class="best-exp-row-header">
                            <div class="best-exp-model-icon hybrid">
                                <i class="fas fa-layer-group"></i>
                            </div>
                            <span class="best-exp-model-title">Hybrid</span>
                        </div>
                        <div class="best-exp-kpi-boxes">
                            <div class="best-exp-kpi-box">
                                <div class="best-exp-kpi-label">Experiments</div>
                                <div class="best-exp-kpi-value" id="bestExpHybridCount">0</div>
                            </div>
                            <div class="best-exp-kpi-box">
                                <div class="best-exp-kpi-label">R@50</div>
                                <div class="best-exp-kpi-value highlight" id="bestExpHybridR50">-</div>
                            </div>
                            <div class="best-exp-kpi-box">
                                <div class="best-exp-kpi-label">R@100</div>
                                <div class="best-exp-kpi-value highlight" id="bestExpHybridR100">-</div>
                            </div>
                            <div class="best-exp-kpi-box">
                                <div class="best-exp-kpi-label">RMSE</div>
                                <div class="best-exp-kpi-value highlight" id="bestExpHybridRMSE">-</div>
                            </div>
                            <div class="best-exp-kpi-box">
                                <div class="best-exp-kpi-label">Test RMSE</div>
                                <div class="best-exp-kpi-value highlight" id="bestExpHybridTestRMSE">-</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Top Configurations Table -->
                <div class="best-exp-section">
                    <div class="best-exp-section-header">
                        <span class="best-exp-section-title" id="bestExpTableTitle">Top Configurations</span>
                        <span class="text-xs text-gray-400" id="bestExpTableSubtitle">Best performing experiment configurations</span>
                    </div>
                    <div id="bestExpTableContainer" class="best-exp-table-container">
                        <table class="best-exp-table">
                            <thead id="bestExpTableHead">
                                <tr>
                                    <th style="width: 40px;">#</th>
                                    <th style="text-align: center;">Experiment</th>
                                    <th>Dataset</th>
                                    <th>Feature</th>
                                    <th>Model</th>
                                    <th style="text-align: center;">LR</th>
                                    <th style="text-align: center;">Batch</th>
                                    <th style="text-align: center;">Epochs</th>
                                    <th style="text-align: center;">R@100</th>
                                    <th style="text-align: center;">Loss</th>
                                </tr>
                            </thead>
                            <tbody id="bestExpTableBody">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Experiment View Modal (Reusable Component) -->
{% include 'includes/_exp_view_modal.html' %}

<!-- Schedule Modal (Reusable Component) -->
{% include 'includes/_schedule_modal.html' %}

<!-- Deploy Wizard Modal (Cloud Run Deployment) -->
{% include 'includes/_deploy_wizard.html' %}

<!-- Training Wizard Modal -->
<div id="trainingWizardModal" class="modal-overlay hidden" onclick="if(event.target === this) TrainingWizard.close()">
    <div class="modal-container modal-container-wizard" style="max-width: 1000px;">
        <!-- Modal Header — gradient -->
        <div class="modal-header-soft soft-training">
            <div class="modal-header-icon-badge">
                <i class="fas fa-rocket"></i>
            </div>
            <div>
                <h3 class="modal-header-title">New Training Run</h3>
                <div class="modal-header-subtitle">Step 1 of 3</div>
            </div>
        </div>

        <!-- Step Navigation — overlapping nav bar -->
        <div class="wizard-nav-bar pill-training">
            <div class="wizard-nav-pills">
                <span class="wizard-step-pill current">Select Experiment</span>
                <span class="wizard-step-pill future">Configuration</span>
                <span class="wizard-step-pill future">GPU & Deploy</span>
            </div>
        </div>

        <!-- Body with 3 wizard steps -->
        <div class="modal-body-wizard">
            <!-- Step 1: Select Base Experiment -->
            <div id="wizardStep1" class="wizard-step active">
                <!-- Run Name -->
                <div class="wizard-field-group">
                    <label class="wizard-field-label">
                        Model Name <span class="required">*</span>
                    </label>
                    <input type="text" id="wizardRunName" class="form-input" style="width: 100%;"
                           placeholder="e.g., product_recommender_v3"
                           oninput="this.value = this.value.toLowerCase().replace(/[^a-z0-9_-]/g, ''); TrainingWizard.checkNameAvailability(this.value)">
                    <div id="wizardRunNameError" class="wizard-field-error"></div>
                    <div class="wizard-field-hint">Lowercase letters, numbers, hyphens, and underscores (3-63 chars)</div>
                </div>

                <!-- Model Type Selection -->
                <div class="wizard-field-group">
                    <label class="wizard-field-label">Model Type</label>
                    <div class="model-type-cards">
                        <div class="model-type-card retrieval selected" data-type="retrieval"
                             onclick="TrainingWizard.selectModelType('retrieval')">
                            <input type="radio" name="wizardModelType" value="retrieval" checked>
                            <div class="model-type-icon"><i class="fas fa-search"></i></div>
                            <div class="model-type-content">
                                <div class="model-type-name">Retrieval</div>
                                <div class="model-type-desc">Two-tower for candidate retrieval</div>
                            </div>
                        </div>
                        <div class="model-type-card ranking" data-type="ranking"
                             onclick="TrainingWizard.selectModelType('ranking')">
                            <input type="radio" name="wizardModelType" value="ranking">
                            <div class="model-type-icon"><i class="fas fa-sort-amount-down"></i></div>
                            <div class="model-type-content">
                                <div class="model-type-name">Ranking</div>
                                <div class="model-type-desc">Score and rank candidates</div>
                            </div>
                        </div>
                        <div class="model-type-card hybrid" data-type="hybrid"
                             onclick="TrainingWizard.selectModelType('hybrid')">
                            <input type="radio" name="wizardModelType" value="hybrid">
                            <div class="model-type-icon"><i class="fas fa-layer-group"></i></div>
                            <div class="model-type-content">
                                <div class="model-type-name">Hybrid</div>
                                <div class="model-type-desc">Combined retrieval + ranking</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Experiment Search -->
                <div class="wizard-field-group">
                    <label class="wizard-field-label">
                        Select Base Experiment <span class="required">*</span>
                    </label>
                    <div class="wizard-search-input">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search experiments..."
                               oninput="TrainingWizard.searchExperiments(this.value)">
                    </div>
                </div>

                <!-- Experiment List -->
                <div id="wizardExperimentList" class="wizard-selection-grid cols-1" style="max-height: 200px;">
                    <div class="wizard-loading"><i class="fas fa-spinner fa-spin"></i> Loading experiments...</div>
                </div>

                <!-- Selected Experiment Summary -->
                <div id="wizardSelectedExpSummary" class="selected-experiment-summary"></div>
            </div>

            <!-- Step 2: Configuration & Parameters -->
            <div id="wizardStep2" class="wizard-step">
                <!-- Inherited Config Cards (Read-only) -->
                <div class="wizard-section-title">Inherited Configuration</div>
                <div class="config-cards-row">
                    <div id="wizardDatasetCard" class="config-card">
                        <div class="config-card-header">
                            <span class="config-card-title">Dataset</span>
                        </div>
                        <div class="config-card-body">
                            <div class="config-card-icon dataset"><i class="fas fa-database"></i></div>
                            <div class="config-card-content">
                                <div class="config-card-name">-</div>
                                <div class="config-card-meta">From experiment</div>
                            </div>
                        </div>
                    </div>
                    <div id="wizardFeatureCard" class="config-card">
                        <div class="config-card-header">
                            <span class="config-card-title">Feature Config</span>
                        </div>
                        <div class="config-card-body">
                            <div class="config-card-icon feature"><i class="fas fa-layer-group"></i></div>
                            <div class="config-card-content">
                                <div class="config-card-name">-</div>
                                <div class="config-card-meta">From experiment</div>
                            </div>
                        </div>
                    </div>
                    <div id="wizardModelCard" class="config-card">
                        <div class="config-card-header">
                            <span class="config-card-title">Model Config</span>
                        </div>
                        <div class="config-card-body">
                            <div class="config-card-icon model"><i class="fas fa-project-diagram"></i></div>
                            <div class="config-card-content">
                                <div class="config-card-name">-</div>
                                <div class="config-card-meta">From experiment</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Experiment Settings (Read-only chips) -->
                <div class="wizard-section-title" style="margin-top: 16px;">Experiment Settings</div>
                <div id="wizardExpSettings" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 16px;">
                    <div style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 14px; background: #ffffff; border-radius: 8px; border: 1px solid #e5e7eb;">
                        <span style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">Split Strategy</span>
                        <span style="font-size: 13px; font-weight: 600; color: #374151;" id="wizardSplitStrategyDisplay">-</span>
                    </div>
                    <div style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 14px; background: #ffffff; border-radius: 8px; border: 1px solid #e5e7eb;">
                        <span style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">Optimizer</span>
                        <span style="font-size: 13px; font-weight: 600; color: #374151;" id="wizardOptimizerDisplay">AdaGrad</span>
                    </div>
                    <div style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 14px; background: #ffffff; border-radius: 8px; border: 1px solid #e5e7eb;">
                        <span style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">Algorithm</span>
                        <span style="font-size: 13px; font-weight: 600; color: #374151;" id="wizardAlgorithmDisplay">-</span>
                    </div>
                    <div style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 14px; background: #ffffff; border-radius: 8px; border: 1px solid #e5e7eb;">
                        <span style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">Top-K</span>
                        <span style="font-size: 13px; font-weight: 600; color: #374151;" id="wizardTopKDisplay">100</span>
                    </div>
                </div>

                <!-- Training Parameters (Editable) -->
                <div class="training-params-section">
                    <div class="training-params-section-title">
                        <i class="fas fa-sliders-h"></i> Training Parameters
                    </div>
                    <div class="training-params-grid" style="grid-template-columns: repeat(3, 1fr);">
                        <div class="training-param-field">
                            <label class="training-param-label">Epochs</label>
                            <select id="wizardEpochs" class="training-param-select"
                                    onchange="TrainingWizard.updateTrainingParam('epochs', this.value)">
                                <option value="50">50</option>
                                <option value="100">100</option>
                                <option value="150" selected>150</option>
                                <option value="200">200</option>
                                <option value="300">300</option>
                            </select>
                        </div>
                        <div class="training-param-field">
                            <label class="training-param-label">Batch Size <span id="wizardBatchSizeRef" class="param-exp-ref" style="display: none;"></span></label>
                            <select id="wizardBatchSize" class="training-param-select"
                                    onchange="TrainingWizard.updateTrainingParam('batchSize', this.value)">
                                <option value="4096">4,096</option>
                                <option value="8192" selected>8,192</option>
                                <option value="16384">16,384</option>
                                <option value="32768">32,768</option>
                            </select>
                        </div>
                        <div class="training-param-field">
                            <label class="training-param-label">Learning Rate</label>
                            <input type="text" id="wizardLearningRate" class="training-param-select"
                                   value="0.1" placeholder="e.g., 0.001"
                                   onchange="TrainingWizard.updateTrainingParam('learningRate', this.value)">
                        </div>
                    </div>
                </div>

                <!-- Advanced Parameters (collapsed, contains Early Stopping) -->
                <div class="filter-subchapter" style="margin-top: 16px;">
                    <div class="subchapter-header-tablet" id="wizardAdvancedToggle" onclick="TrainingWizard.toggleAdvanced()">
                        <i class="fas fa-cog" style="color: #8b5cf6; margin-right: 10px;"></i>
                        <span class="subchapter-title" style="flex-grow: 1; text-align: left;">Advanced Parameters</span>
                        <i id="wizardAdvancedChevron" class="fas fa-chevron-right subchapter-chevron"></i>
                    </div>
                    <div id="wizardAdvancedContent" class="subchapter-content-outside hidden">
                        <!-- Early Stopping -->
                        <div class="toggle-row" style="margin-bottom: 12px;">
                            <label class="toggle-switch">
                                <input type="checkbox" id="wizardEarlyStopping"
                                       onchange="TrainingWizard.updateTrainingParam('earlyStoppingEnabled', this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                            <div class="toggle-label">
                                Early Stopping
                                <span class="toggle-hint">Stop training when validation metric stops improving</span>
                            </div>
                            <select id="wizardPatience" class="training-param-select" style="width: 80px; margin-left: auto;"
                                    onchange="TrainingWizard.updateTrainingParam('earlyStoppingPatience', this.value)">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="15">15</option>
                                <option value="20">20</option>
                            </select>
                            <span style="font-size: 11px; color: #6b7280;">patience</span>
                        </div>

                        <!-- Learning Rate Schedule (disabled - auto-configured) -->
                        <div class="toggle-row" style="margin-bottom: 12px; opacity: 0.5; pointer-events: none;">
                            <label class="toggle-switch">
                                <input type="checkbox" disabled>
                                <span class="toggle-slider"></span>
                            </label>
                            <div class="toggle-label">
                                Learning Rate Schedule
                                <span class="toggle-hint">Configured automatically for production training</span>
                            </div>
                        </div>

                        <!-- Mixed Precision (disabled - auto-configured) -->
                        <div class="toggle-row" style="margin-bottom: 12px; opacity: 0.5; pointer-events: none;">
                            <label class="toggle-switch">
                                <input type="checkbox" disabled>
                                <span class="toggle-slider"></span>
                            </label>
                            <div class="toggle-label">
                                Mixed Precision
                                <span class="toggle-hint">Configured automatically for production training</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: GPU & Deployment -->
            <div id="wizardStep3" class="wizard-step">
                <!-- GPU Selection -->
                <div class="wizard-section-title">GPU Configuration</div>
                <div class="gpu-selection-grid">
                    <div class="gpu-card selected" data-gpu="NVIDIA_T4" onclick="TrainingWizard.selectGPU('NVIDIA_T4')">
                        <input type="radio" name="wizardGpu" value="NVIDIA_T4" checked>
                        <div class="gpu-card-name">T4</div>
                        <div class="gpu-card-specs">16GB VRAM</div>
                    </div>
                    <div class="gpu-card disabled" data-gpu="NVIDIA_L4">
                        <input type="radio" name="wizardGpu" value="NVIDIA_L4" disabled>
                        <span class="badge-recommended"><i class="fas fa-star"></i> Recommended</span>
                        <div class="gpu-card-name">L4</div>
                        <div class="gpu-card-specs">24GB VRAM</div>
                    </div>
                    <div class="gpu-card disabled" data-gpu="NVIDIA_V100">
                        <input type="radio" name="wizardGpu" value="NVIDIA_V100" disabled>
                        <div class="gpu-card-name">V100</div>
                        <div class="gpu-card-specs">16GB HBM2</div>
                    </div>
                    <div class="gpu-card disabled" data-gpu="NVIDIA_A100">
                        <input type="radio" name="wizardGpu" value="NVIDIA_A100" disabled>
                        <div class="gpu-card-name">A100</div>
                        <div class="gpu-card-specs">40GB HBM2e</div>
                    </div>
                </div>

                <div class="training-params-grid" style="grid-template-columns: 1fr;">
                    <div class="training-param-field">
                        <label class="training-param-label">GPU Count</label>
                        <select id="wizardGpuCount" class="training-param-select"
                                onchange="TrainingWizard.updateGPUCount(this.value)">
                            <option value="1">1 GPU</option>
                            <option value="2" selected>2 GPUs</option>
                            <option value="4">4 GPUs</option>
                            <option value="8">8 GPUs</option>
                        </select>
                    </div>
                </div>

                <!-- Advanced Section (collapsed by default) -->
                <div class="filter-subchapter" style="margin-top: 20px;">
                    <div class="subchapter-header-tablet" id="wizardStep3AdvancedToggle" onclick="TrainingWizard.toggleStep3Advanced()">
                        <i class="fas fa-cog" style="color: #8b5cf6; margin-right: 10px;"></i>
                        <span class="subchapter-title" style="flex-grow: 1; text-align: left;">Advanced</span>
                        <i id="wizardStep3AdvancedChevron" class="fas fa-chevron-right subchapter-chevron"></i>
                    </div>
                    <div id="wizardStep3AdvancedContent" class="subchapter-content-outside hidden">
                        <!-- Preemptible VMs (disabled - not yet tested) -->
                        <div class="toggle-row" style="margin-bottom: 16px; opacity: 0.5; pointer-events: none;">
                            <label class="toggle-switch">
                                <input type="checkbox" id="wizardPreemptible" disabled>
                                <span class="toggle-slider"></span>
                            </label>
                            <div class="toggle-label">
                                Use Preemptible VMs
                                <span class="toggle-hint">70% cost reduction, may be interrupted</span>
                            </div>
                        </div>

                        <!-- Evaluator Settings (disabled - not yet tested) -->
                        <div class="toggle-row" style="margin-bottom: 12px; opacity: 0.5; pointer-events: none;">
                            <label class="toggle-switch">
                                <input type="checkbox" id="wizardEvaluatorEnabled" disabled>
                                <span class="toggle-slider"></span>
                            </label>
                            <div class="toggle-label">
                                Enable Model Evaluator
                                <span class="toggle-hint">Automatically evaluate model after training</span>
                            </div>
                        </div>
                        <div class="training-params-grid" style="grid-template-columns: 1fr; opacity: 0.5; pointer-events: none;">
                            <div class="training-param-field">
                                <label class="training-param-label">Blessing Threshold</label>
                                <input type="number" id="wizardBlessingThreshold" class="training-param-input"
                                       value="0.40" step="0.01" min="0" max="1" disabled>
                                <div class="wizard-field-hint">Minimum metric value to bless model for deployment</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Deploy Section -->
                <div class="filter-subchapter" style="margin-top: 16px;">
                    <div class="subchapter-header-tablet" id="wizardDeployToggle" onclick="TrainingWizard.toggleDeploy()">
                        <i class="fas fa-rocket" style="color: #f97316; margin-right: 10px;"></i>
                        <span class="subchapter-title" style="flex-grow: 1; text-align: left;">Deploy</span>
                        <i id="wizardDeployChevron" class="fas fa-chevron-right subchapter-chevron"></i>
                    </div>
                    <div id="wizardDeployContent" class="subchapter-content-outside hidden">
                        <!-- Deploy Toggle -->
                        <div class="deploy-toggle-row">
                            <label class="toggle-switch">
                                <input type="checkbox" id="wizardDeployEnabled" onchange="TrainingWizard.toggleDeployEnabled(this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                            <span class="deploy-toggle-label">Enable Auto-Deployment to Cloud Run</span>
                        </div>

                        <!-- Deploy Config (shown when enabled) -->
                        <div id="wizardDeployConfig" class="hidden">
                            <!-- Endpoint Name Section -->
                            <div class="deploy-section">
                                <div class="deploy-section-label">ENDPOINT NAME</div>
                                <div class="endpoint-name-box">
                                    <div class="endpoint-name-radio selected">
                                        <span class="radio-dot"></span>
                                        <span>Create New Endpoint</span>
                                    </div>
                                    <div class="endpoint-name-display">
                                        <i class="fas fa-tag"></i>
                                        <span id="wizardEndpointName">model-name-serving</span>
                                    </div>
                                    <label class="custom-name-checkbox">
                                        <input type="checkbox" id="wizardUseCustomName" onchange="TrainingWizard.toggleCustomName(this.checked)">
                                        <span>Use custom name</span>
                                    </label>
                                    <input type="text" id="wizardCustomEndpointName" class="hidden"
                                           placeholder="custom-endpoint-name"
                                           oninput="TrainingWizard.updateCustomEndpointName(this.value)">
                                    <div id="wizardEndpointNameError" class="deploy-field-error hidden"></div>
                                </div>
                            </div>

                            <!-- Preset Cards -->
                            <div class="deploy-section">
                                <div class="deploy-section-label">DEPLOYMENT PRESET</div>
                                <div class="preset-cards-grid">
                                    <div class="preset-card" data-preset="development" onclick="TrainingWizard.selectDeployPreset('development')">
                                        <div class="preset-name">Development</div>
                                        <div class="preset-specs">0-2 instances</div>
                                        <div class="preset-specs">2Gi / 1 CPU</div>
                                        <div class="preset-desc">Testing, low traffic</div>
                                    </div>
                                    <div class="preset-card selected" data-preset="production" onclick="TrainingWizard.selectDeployPreset('production')">
                                        <span class="preset-recommended">RECOMMENDED</span>
                                        <div class="preset-name">Production</div>
                                        <div class="preset-specs">1-10 instances</div>
                                        <div class="preset-specs">4Gi / 2 CPU</div>
                                        <div class="preset-desc">Standard workload</div>
                                    </div>
                                    <div class="preset-card" data-preset="high_traffic" onclick="TrainingWizard.selectDeployPreset('high_traffic')">
                                        <div class="preset-name">High Traffic</div>
                                        <div class="preset-specs">2-50 instances</div>
                                        <div class="preset-specs">8Gi / 4 CPU</div>
                                        <div class="preset-desc">High concurrency</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Manual Parameters -->
                            <div class="deploy-params-row">
                                <div class="deploy-param">
                                    <label>MIN INSTANCES</label>
                                    <input type="number" id="wizardDeployMinInstances" value="1" min="0" max="100"
                                           onchange="TrainingWizard.updateDeployParam('minInstances', this.value)">
                                </div>
                                <div class="deploy-param">
                                    <label>MAX INSTANCES</label>
                                    <input type="number" id="wizardDeployMaxInstances" value="10" min="1" max="100"
                                           onchange="TrainingWizard.updateDeployParam('maxInstances', this.value)">
                                </div>
                                <div class="deploy-param">
                                    <label>MEMORY</label>
                                    <select id="wizardDeployMemory" onchange="TrainingWizard.updateDeployParam('memory', this.value)">
                                        <option value="2Gi">2 Gi</option>
                                        <option value="4Gi" selected>4 Gi</option>
                                        <option value="8Gi">8 Gi</option>
                                        <option value="16Gi">16 Gi</option>
                                    </select>
                                </div>
                                <div class="deploy-param">
                                    <label>CPU</label>
                                    <select id="wizardDeployCPU" onchange="TrainingWizard.updateDeployParam('cpu', this.value)">
                                        <option value="1">1 vCPU</option>
                                        <option value="2" selected>2 vCPU</option>
                                        <option value="4">4 vCPU</option>
                                        <option value="8">8 vCPU</option>
                                    </select>
                                </div>
                                <div class="deploy-param">
                                    <label>TIMEOUT</label>
                                    <select id="wizardDeployTimeout" onchange="TrainingWizard.updateDeployParam('timeout', this.value)">
                                        <option value="60">60 s</option>
                                        <option value="300" selected>300 s</option>
                                        <option value="600">600 s</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Summary Panel -->
                <div class="wizard-summary-panel">
                    <div class="wizard-summary-title">
                        <i class="fas fa-clipboard-list" style="color: #f97316;"></i> Training Summary
                    </div>
                    <div id="wizardSummaryGrid" class="wizard-summary-grid">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Neumorphic footer (layout matches Experiments wizard) -->
        <div class="modal-footer-wizard-neu">
            <div class="footer-left">
                <button id="wizardPrevBtn" class="btn-neu btn-neu-nav hidden" onclick="TrainingWizard.prevStep()">
                    <span class="btn-neu-inner"><i class="fas fa-chevron-left"></i></span>
                </button>
                <button id="wizardNextBtn" class="btn-neu btn-neu-nav" onclick="TrainingWizard.nextStep()">
                    <span class="btn-neu-inner"><i class="fas fa-chevron-right"></i></span>
                </button>
            </div>
            <div class="footer-right">
                <button id="wizardScheduleBtn" class="btn-neu btn-neu-action btn-neu-schedule hidden" onclick="TrainingWizard.openScheduleModal()">
                    <span class="btn-neu-inner">Schedule</span>
                </button>
                <button id="wizardRunNowBtn" class="btn-neu btn-neu-action btn-neu-save hidden" onclick="TrainingWizard.submit()">
                    <span class="btn-neu-inner">Run</span>
                </button>
                <button id="wizardSubmitBtn" class="btn-neu btn-neu-action btn-neu-save hidden" onclick="TrainingWizard.submit()">
                    <span class="btn-neu-inner">Update</span>
                </button>
                <button class="btn-neu btn-neu-action btn-neu-cancel" onclick="TrainingWizard.close()">
                    <span class="btn-neu-inner">Cancel</span>
                </button>
            </div>
        </div>
    </div>
</div>
<!-- End Training Wizard Modal -->
<!-- End Chapter 2: Best Experiments -->

<!-- CHAPTER 3: TRAINING -->
<div class="chapter-container" data-chapter="training-runs">
    <div class="chapter-header" onclick="toggleChapter(this)">
        <div class="chapter-header-top">
            <div class="chapter-title-wrapper">
                <div class="chapter-icon training">
                    <i class="fas fa-cogs"></i>
                </div>
                <div class="chapter-title-text">
                    <span class="chapter-title">Training Runs</span>
                    <span class="chapter-subtitle">Launch and monitor model training jobs</span>
                </div>
            </div>
            <div class="chapter-header-actions">
                <button onclick="event.stopPropagation(); TrainingWizard.open()" class="btn btn-primary btn-sm" style="width: 140px;">
                    <i class="fas fa-plus"></i> New Model
                </button>
                <div class="chapter-toggle">
                    <i class="fas fa-chevron-right"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="chapter-content">
        <div class="chapter-content-inner">
            <div class="chapter-divider" style="margin-top: 0;"></div>

            <!-- Filter Bar (below header) -->
            <div id="trainingFilterBar">
                <!-- Filter bar rendered by TrainingCards.init() -->
            </div>

            <!-- Loading State -->
            <div id="trainingLoading" class="training-loading hidden">
                <i class="fas fa-spinner fa-spin"></i>
                <span class="training-loading-text">Loading training runs...</span>
            </div>

            <!-- Training Runs List -->
            <div id="trainingRunsContainer">
                <div id="trainingCardsList">
                    <!-- Training run cards populated by TrainingCards -->
                </div>
            </div>

            <!-- Pagination -->
            <div id="trainingPagination">
                <!-- Pagination controls -->
            </div>

            <!-- Empty State -->
            <div id="trainingEmptyState" class="training-empty-state hidden">
                <div class="empty-icon">
                    <i class="fas fa-rocket"></i>
                </div>
                <h3>No training runs yet</h3>
                <p>Run experiments first, then promote the best configurations to full-scale training</p>
                <button class="btn-primary" onclick="TrainingWizard.open()">
                    <i class="fas fa-plus"></i>
                    New Training Run
                </button>
            </div>
        </div>
    </div>
</div>
<!-- End Chapter 3: Training -->

<!-- =============================================================================
     CONFIRMATION MODAL (Reusable styled confirmation dialog)
     ============================================================================ -->
<div id="confirmModal" class="modal-overlay hidden">
    <div class="modal-container" style="max-width: 28rem;">
        <div class="modal-header">
            <div id="confirmModalIcon" class="modal-header-icon warning">
                <i class="fas fa-exclamation-triangle text-xl"></i>
            </div>
            <h3 id="confirmModalTitle" class="modal-header-title">Confirm Action</h3>
        </div>
        <div class="modal-body">
            <p id="confirmModalMessage">Are you sure you want to proceed?</p>
        </div>
        <div class="modal-footer-wizard-neu">
            <div class="footer-left"></div>
            <div class="footer-right">
                <button id="confirmModalConfirmBtn" class="btn-neu btn-neu-action btn-neu-save">
                    <span class="btn-neu-inner">Ok</span>
                </button>
                <button id="confirmModalCancelBtn" class="btn-neu btn-neu-action btn-neu-cancel">
                    <span class="btn-neu-inner">Cancel</span>
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="{% static 'js/pipeline_dag.js' %}?v=2"></script>
<script src="{% static 'js/exp_view_modal.js' %}?v=13"></script>
<script src="{% static 'js/schedule_modal.js' %}?v=1"></script>
<script src="{% static 'js/deploy_wizard.js' %}?v=1"></script>
<script src="{% static 'js/training_wizard.js' %}?v=3"></script>
<script src="{% static 'js/training_cards.js' %}?v=9"></script>
<script src="{% static 'js/schedule_calendar.js' %}?v=2"></script>
<script src="{% static 'js/models_registry.js' %}?v=3"></script>
<script>
// =============================================================================
// CROSS-TAB DATA ISOLATION HELPER
// =============================================================================
const modelEndpointId = {{ model.id }};
function appendModelEndpointId(url) {
    if (!modelEndpointId) return url;
    const sep = url.includes('?') ? '&' : '?';
    return `${url}${sep}model_endpoint_id=${modelEndpointId}`;
}

// Set model endpoint ID for pipeline DAG module
if (typeof setPipelineDagModelEndpointId === 'function') {
    setPipelineDagModelEndpointId({{ model.id }});
}

// =============================================================================
// CHAPTER TOGGLE (collapsible chapter pattern)
// =============================================================================
function toggleChapter(header) {
    const container = header.closest('.chapter-container');
    container.classList.toggle('open');
}

// =============================================================================
// BEST EXPERIMENTS - STATE & INITIALIZATION
// =============================================================================

let selectedBestExpModelType = 'retrieval';

// =============================================================================
// TRAINING RUNS (Chapter 3)
// =============================================================================

let trainingCardsInitialized = false;

async function loadTrainingRuns() {
    if (!trainingCardsInitialized) {
        // Configure TrainingCards with ExpViewModal integration
        TrainingCards.configure({
            modelId: {{ model.id }},
            onViewRun: function(runId) {
                ExpViewModal.open(runId, { mode: 'training_run' });
            }
        });
        TrainingCards.init();
        TrainingSchedules.configure({
            modelId: {{ model.id }}
        });
        TrainingSchedules.init();
        trainingCardsInitialized = true;
    } else {
        // Subsequent calls - just refresh
        TrainingCards.refresh();
        TrainingSchedules.loadSchedules();
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load Best Experiments
    loadBestExperiments();

    // Configure ExpViewModal with endpoints and callbacks
    ExpViewModal.configure({
        modelId: {{ model.id }},
        showTabs: ['overview', 'pipeline', 'data', 'training'],
        showVersionDeployButtons: true,  // Enable Deploy/Undeploy in Versions tab
        onClose: function() {
            // Refresh training cards when modal closes in case status changed
            if (trainingCardsInitialized) {
                TrainingCards.refresh();
            }
        },
        onUpdate: function(data) {
            // Refresh the table if experiment status changes
            loadBestExpConfigurations();
            // Refresh training cards when run status updates
            if (trainingCardsInitialized) {
                TrainingCards.refresh();
            }
        }
    });

    // Configure TrainingWizard
    TrainingWizard.configure({
        modelId: {{ model.id }},
        onComplete: function() {
            TrainingCards.refresh();
            // Also refresh Models Registry when training completes
            ModelsRegistry.refresh();
        }
    });

    // Configure DeployWizard
    const projectSlug = '{{ model.name|lower }}'.replace(/_/g, '-').replace(/ /g, '-').replace(/[^a-z0-9-]/g, '').replace(/--+/g, '-').replace(/^-|-$/g, '').substring(0, 20);
    DeployWizard.configure({
        modelId: {{ model.id }},
        projectSlug: projectSlug,
        onSuccess: function(result) {
            // Refresh training cards to show updated deployment status
            TrainingCards.refresh();
            // Also refresh Models Registry
            ModelsRegistry.refresh();
        }
    });

    // Load Training Runs immediately (all chapters visible)
    loadTrainingRuns();

    // Initialize Models Registry (Chapter 1)
    ModelsRegistry.init({
        containerId: '#modelsRegistryChapter',
        kpiContainerId: '#modelsKpiSummary',
        calendarContainerId: '#modelsScheduleGrid',
        filterBarId: '#modelsFilterBar',
        tableContainerId: '#modelsTable',
        emptyStateId: '#modelsEmptyState',
        modelId: {{ model.id }},
        onViewDetails: function(modelId, tab) {
            ExpViewModal.openForModel(modelId, { tab: tab || 'overview' });
        }
    });
    ModelsRegistry.load();
});

// =============================================================================
// LOAD BEST EXPERIMENTS DATA
// =============================================================================

async function loadBestExperiments() {
    const loadingEl = document.getElementById('bestExpLoading');
    const contentEl = document.getElementById('bestExpContent');
    const emptyEl = document.getElementById('bestExpEmpty');

    try {
        // Load dashboard stats
        const statsResponse = await fetch(appendModelEndpointId('/api/experiments/dashboard-stats/'));
        const statsData = await statsResponse.json();

        if (!statsData.success) {
            console.warn('Dashboard stats error:', statsData.error);
            loadingEl.classList.add('hidden');
            emptyEl.classList.remove('hidden');
            return;
        }

        const stats = statsData.stats;

        // Check if we have any experiments
        if (stats.total === 0) {
            loadingEl.classList.add('hidden');
            emptyEl.classList.remove('hidden');
            return;
        }

        // Render Model Type KPI Sections
        renderBestExpKPIs(stats);

        // Show content, hide loading
        loadingEl.classList.add('hidden');
        contentEl.classList.remove('hidden');

        // Load top configurations for default model type
        await loadBestExpConfigurations();

    } catch (error) {
        console.error('Failed to load best experiments:', error);
        loadingEl.classList.add('hidden');
        emptyEl.classList.remove('hidden');
    }
}

function renderBestExpKPIs(stats) {
    const formatRecall = (v) => v !== null && v !== undefined ? (v * 100).toFixed(1) + '%' : '-';
    const formatAccuracy = (v) => v !== null && v !== undefined ? v.toFixed(2) : '-';

    // Retrieval Section
    const retrieval = stats.retrieval || {};
    document.getElementById('bestExpRetrievalCount').textContent = retrieval.count || 0;
    document.getElementById('bestExpRetrievalR5').textContent = formatRecall(retrieval.best_r5);
    document.getElementById('bestExpRetrievalR10').textContent = formatRecall(retrieval.best_r10);
    document.getElementById('bestExpRetrievalR50').textContent = formatRecall(retrieval.best_r50);
    document.getElementById('bestExpRetrievalR100').textContent = formatRecall(retrieval.best_r100);

    // Ranking Section
    const ranking = stats.ranking || {};
    document.getElementById('bestExpRankingCount').textContent = ranking.count || 0;
    document.getElementById('bestExpRankingRMSE').textContent = formatAccuracy(ranking.best_rmse);
    document.getElementById('bestExpRankingTestRMSE').textContent = formatAccuracy(ranking.best_test_rmse);
    document.getElementById('bestExpRankingMAE').textContent = formatAccuracy(ranking.best_mae);
    document.getElementById('bestExpRankingTestMAE').textContent = formatAccuracy(ranking.best_test_mae);

    // Hybrid Section
    const hybrid = stats.hybrid || {};
    document.getElementById('bestExpHybridCount').textContent = hybrid.count || 0;
    document.getElementById('bestExpHybridR50').textContent = formatRecall(hybrid.best_r50);
    document.getElementById('bestExpHybridR100').textContent = formatRecall(hybrid.best_r100);
    document.getElementById('bestExpHybridRMSE').textContent = formatAccuracy(hybrid.best_rmse);
    document.getElementById('bestExpHybridTestRMSE').textContent = formatAccuracy(hybrid.best_test_rmse);
}

// =============================================================================
// MODEL TYPE SELECTION
// =============================================================================

function selectBestExpModelType(modelType) {
    if (selectedBestExpModelType === modelType) return;

    selectedBestExpModelType = modelType;

    // Update visual selection
    const rows = document.querySelectorAll('.best-exp-model-row');
    rows.forEach(row => row.classList.remove('selected'));

    const rowId = {
        'retrieval': 'bestExpRetrievalRow',
        'ranking': 'bestExpRankingRow',
        'hybrid': 'bestExpHybridRow'
    }[modelType];

    const selectedRow = document.getElementById(rowId);
    if (selectedRow) {
        selectedRow.classList.add('selected');
    }

    // Reload configurations table for the selected model type
    loadBestExpConfigurations(modelType);
}

// =============================================================================
// TOP CONFIGURATIONS TABLE
// =============================================================================

async function loadBestExpConfigurations(modelType = null) {
    const thead = document.getElementById('bestExpTableHead');
    const tbody = document.getElementById('bestExpTableBody');
    const titleEl = document.getElementById('bestExpTableTitle');
    const subtitleEl = document.getElementById('bestExpTableSubtitle');

    const activeModelType = modelType || selectedBestExpModelType;

    // Update header based on model type
    const headerConfig = {
        'retrieval': {
            title: 'Top Configurations',
            subtitle: 'Best performing retrieval experiments (by R@100)'
        },
        'ranking': {
            title: 'Top Configurations',
            subtitle: 'Best performing ranking experiments (by Test RMSE, lower is better)'
        },
        'hybrid': {
            title: 'Top Configurations',
            subtitle: 'Best performing hybrid experiments'
        }
    };
    const config = headerConfig[activeModelType] || headerConfig['retrieval'];
    if (titleEl) titleEl.textContent = config.title;
    if (subtitleEl) subtitleEl.textContent = config.subtitle;

    // Update table header based on model type
    if (activeModelType === 'ranking') {
        thead.innerHTML = `
            <tr>
                <th style="width: 40px;">#</th>
                <th style="text-align: center;">Experiment</th>
                <th>Dataset</th>
                <th>Feature</th>
                <th>Model</th>
                <th style="text-align: center;">LR</th>
                <th style="text-align: center;">Batch</th>
                <th style="text-align: center;">Epochs</th>
                <th style="text-align: center;">Test RMSE</th>
                <th style="text-align: center;">Test MAE</th>
            </tr>
        `;
    } else if (activeModelType === 'hybrid') {
        thead.innerHTML = `
            <tr>
                <th style="width: 40px;">#</th>
                <th style="text-align: center;">Experiment</th>
                <th>Dataset</th>
                <th>Feature</th>
                <th>Model</th>
                <th style="text-align: center;">LR</th>
                <th style="text-align: center;">R@100</th>
                <th style="text-align: center;">R@50</th>
                <th style="text-align: center;">Test RMSE</th>
                <th style="text-align: center;">Test MAE</th>
            </tr>
        `;
    } else {
        thead.innerHTML = `
            <tr>
                <th style="width: 40px;">#</th>
                <th style="text-align: center;">Experiment</th>
                <th>Dataset</th>
                <th>Feature</th>
                <th>Model</th>
                <th style="text-align: center;">LR</th>
                <th style="text-align: center;">Batch</th>
                <th style="text-align: center;">Epochs</th>
                <th style="text-align: center;">R@100</th>
                <th style="text-align: center;">Loss</th>
            </tr>
        `;
    }

    try {
        const response = await fetch(appendModelEndpointId(`/api/experiments/top-configurations/?limit=10&model_type=${activeModelType}`));
        const data = await response.json();

        if (!data.success || !data.configurations || data.configurations.length === 0) {
            const modelLabel = activeModelType === 'hybrid' ? 'hybrid' : (activeModelType === 'ranking' ? 'ranking' : 'retrieval');
            tbody.innerHTML = `
                <tr>
                    <td colspan="10" class="text-center text-gray-400 py-4">
                        No completed ${modelLabel} experiments yet
                    </td>
                </tr>
            `;
            return;
        }

        if (activeModelType === 'ranking') {
            const bestMetric = data.configurations[0]?.test_rmse;

            tbody.innerHTML = data.configurations.map((cfg, index) => {
                const rankClass = index < 3 ? `rank-${index + 1}` : '';
                const isBest = cfg.test_rmse === bestMetric;

                return `
                    <tr onclick="openExpDetails(${cfg.experiment_id})" style="cursor: pointer;" title="Click to view details">
                        <td class="rank-cell ${rankClass}">${cfg.rank}</td>
                        <td style="text-align: center;">${cfg.display_name || 'Exp #' + cfg.experiment_number}</td>
                        <td>${cfg.dataset || '-'}</td>
                        <td>${cfg.feature_config || '-'}</td>
                        <td>${cfg.model_config || '-'}</td>
                        <td style="text-align: center;">${cfg.learning_rate}</td>
                        <td style="text-align: center;">${cfg.batch_size}</td>
                        <td style="text-align: center;">${cfg.epochs}</td>
                        <td style="text-align: center;" class="${isBest ? 'metric-best' : ''}">
                            ${cfg.test_rmse !== null ? cfg.test_rmse.toFixed(2) : '-'}
                        </td>
                        <td style="text-align: center;">
                            ${cfg.test_mae !== null ? cfg.test_mae.toFixed(2) : '-'}
                        </td>
                    </tr>
                `;
            }).join('');
        } else if (activeModelType === 'hybrid') {
            const bestRecall = data.configurations[0]?.recall_at_100;

            tbody.innerHTML = data.configurations.map((cfg, index) => {
                const rankClass = index < 3 ? `rank-${index + 1}` : '';
                const isBest = cfg.recall_at_100 === bestRecall;

                return `
                    <tr onclick="openExpDetails(${cfg.experiment_id})" style="cursor: pointer;" title="Click to view details">
                        <td class="rank-cell ${rankClass}">${cfg.rank}</td>
                        <td style="text-align: center;">${cfg.display_name || 'Exp #' + cfg.experiment_number}</td>
                        <td>${cfg.dataset || '-'}</td>
                        <td>${cfg.feature_config || '-'}</td>
                        <td>${cfg.model_config || '-'}</td>
                        <td style="text-align: center;">${cfg.learning_rate}</td>
                        <td style="text-align: center;" class="${isBest ? 'metric-best' : ''}">
                            ${cfg.recall_at_100 != null ? (cfg.recall_at_100 * 100).toFixed(1) + '%' : '-'}
                        </td>
                        <td style="text-align: center;">
                            ${cfg.recall_at_50 != null ? (cfg.recall_at_50 * 100).toFixed(1) + '%' : '-'}
                        </td>
                        <td style="text-align: center;">
                            ${cfg.test_rmse != null ? cfg.test_rmse.toFixed(2) : '-'}
                        </td>
                        <td style="text-align: center;">
                            ${cfg.test_mae != null ? cfg.test_mae.toFixed(2) : '-'}
                        </td>
                    </tr>
                `;
            }).join('');
        } else {
            const bestRecall = data.configurations[0]?.recall_at_100;

            tbody.innerHTML = data.configurations.map((cfg, index) => {
                const rankClass = index < 3 ? `rank-${index + 1}` : '';
                const isBest = cfg.recall_at_100 === bestRecall;

                return `
                    <tr onclick="openExpDetails(${cfg.experiment_id})" style="cursor: pointer;" title="Click to view details">
                        <td class="rank-cell ${rankClass}">${cfg.rank}</td>
                        <td style="text-align: center;">${cfg.display_name || 'Exp #' + cfg.experiment_number}</td>
                        <td>${cfg.dataset || '-'}</td>
                        <td>${cfg.feature_config || '-'}</td>
                        <td>${cfg.model_config || '-'}</td>
                        <td style="text-align: center;">${cfg.learning_rate}</td>
                        <td style="text-align: center;">${cfg.batch_size}</td>
                        <td style="text-align: center;">${cfg.epochs}</td>
                        <td style="text-align: center;" class="${isBest ? 'metric-best' : ''}">
                            ${cfg.recall_at_100 !== null ? (cfg.recall_at_100 * 100).toFixed(1) + '%' : '-'}
                        </td>
                        <td style="text-align: center;">
                            ${cfg.loss !== null ? cfg.loss.toFixed(1) : '-'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

    } catch (error) {
        console.error('Failed to load top configurations:', error);
        tbody.innerHTML = `
            <tr>
                <td colspan="10" class="text-center text-red-400 py-4">
                    Failed to load configurations
                </td>
            </tr>
        `;
    }
}

// =============================================================================
// VIEW MODAL
// =============================================================================

async function openExpDetails(expId) {
    // Use the reusable ExpViewModal module
    ExpViewModal.open(expId);
}

// =============================================================================
// UTILITIES
// =============================================================================

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showError(message) {
    // Simple alert for now - can be enhanced with toast notifications
    alert(message);
}

function showSuccess(message) {
    console.log('Success:', message);
}
</script>
{% endblock %}
